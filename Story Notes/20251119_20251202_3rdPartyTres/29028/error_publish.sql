/*
Deployment script for VeoSolutions

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar Environment "Dev"
:setvar gpc "gpc"
:setvar VEO "VEO"
:setvar VeoScheduling "VeoScheduling"
:setvar VeoSolutionsArchive "VeoSolutionsArchive"
:setvar VeoSolutionsSecurity "VeoSolutionsSecurity"
:setvar EchelonServicePassword "Ech3lonsrv!"
:setvar VdsPassword "d3vonly!"
:setvar VEOSolutions "VEOSolutions"
:setvar DatabaseName "VeoSolutions"
:setvar DefaultFilePrefix "VeoSolutions"
:setvar DefaultDataPath "E:\SQL\Data\"
:setvar DefaultLogPath "F:\SQL\Logs\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [master];


GO

IF (DB_ID(N'$(DatabaseName)') IS NOT NULL) 
BEGIN
    ALTER DATABASE [$(DatabaseName)]
    SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
    DROP DATABASE [$(DatabaseName)];
END

GO
PRINT N'Creating database $(DatabaseName)...'
GO
CREATE DATABASE [$(DatabaseName)]
    ON 
    PRIMARY(NAME = [$(DatabaseName)], FILENAME = N'$(DefaultDataPath)$(DefaultFilePrefix)_Primary.mdf')
    LOG ON (NAME = [$(DatabaseName)_log], FILENAME = N'$(DefaultLogPath)$(DefaultFilePrefix)_Primary.ldf') COLLATE SQL_Latin1_General_CP1_CI_AS
GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET AUTO_CLOSE OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
USE [$(DatabaseName)];


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ANSI_NULLS ON,
                ANSI_PADDING OFF,
                ANSI_WARNINGS OFF,
                ARITHABORT OFF,
                CONCAT_NULL_YIELDS_NULL OFF,
                NUMERIC_ROUNDABORT OFF,
                QUOTED_IDENTIFIER ON,
                ANSI_NULL_DEFAULT ON,
                CURSOR_DEFAULT GLOBAL,
                RECOVERY FULL,
                CURSOR_CLOSE_ON_COMMIT OFF,
                AUTO_CREATE_STATISTICS ON,
                AUTO_SHRINK OFF,
                AUTO_UPDATE_STATISTICS ON,
                RECURSIVE_TRIGGERS OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ALLOW_SNAPSHOT_ISOLATION OFF;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET READ_COMMITTED_SNAPSHOT OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET AUTO_UPDATE_STATISTICS_ASYNC ON,
                PAGE_VERIFY CHECKSUM,
                DATE_CORRELATION_OPTIMIZATION OFF,
                DISABLE_BROKER,
                PARAMETERIZATION SIMPLE,
                SUPPLEMENTAL_LOGGING OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF IS_SRVROLEMEMBER(N'sysadmin') = 1
    BEGIN
        IF EXISTS (SELECT 1
                   FROM   [master].[dbo].[sysdatabases]
                   WHERE  [name] = N'$(DatabaseName)')
            BEGIN
                EXECUTE sp_executesql N'ALTER DATABASE [$(DatabaseName)]
    SET TRUSTWORTHY OFF,
        DB_CHAINING OFF 
    WITH ROLLBACK IMMEDIATE';
            END
    END
ELSE
    BEGIN
        PRINT N'The database settings cannot be modified. You must be a SysAdmin to apply these settings.';
    END


GO
IF IS_SRVROLEMEMBER(N'sysadmin') = 1
    BEGIN
        IF EXISTS (SELECT 1
                   FROM   [master].[dbo].[sysdatabases]
                   WHERE  [name] = N'$(DatabaseName)')
            BEGIN
                EXECUTE sp_executesql N'ALTER DATABASE [$(DatabaseName)]
    SET HONOR_BROKER_PRIORITY OFF 
    WITH ROLLBACK IMMEDIATE';
            END
    END
ELSE
    BEGIN
        PRINT N'The database settings cannot be modified. You must be a SysAdmin to apply these settings.';
    END


GO
ALTER DATABASE [$(DatabaseName)]
    SET TARGET_RECOVERY_TIME = 0 SECONDS 
    WITH ROLLBACK IMMEDIATE;


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET FILESTREAM(NON_TRANSACTED_ACCESS = OFF),
                CONTAINMENT = NONE 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET AUTO_CREATE_STATISTICS ON(INCREMENTAL = OFF),
                MEMORY_OPTIMIZED_ELEVATE_TO_SNAPSHOT = OFF,
                DELAYED_DURABILITY = DISABLED 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE (QUERY_CAPTURE_MODE = ALL, DATA_FLUSH_INTERVAL_SECONDS = 900, INTERVAL_LENGTH_MINUTES = 60, MAX_PLANS_PER_QUERY = 200, CLEANUP_POLICY = (STALE_QUERY_THRESHOLD_DAYS = 367), MAX_STORAGE_SIZE_MB = 100) 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE = OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE SCOPED CONFIGURATION SET MAXDOP = 0;
        ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET MAXDOP = PRIMARY;
        ALTER DATABASE SCOPED CONFIGURATION SET LEGACY_CARDINALITY_ESTIMATION = OFF;
        ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET LEGACY_CARDINALITY_ESTIMATION = PRIMARY;
        ALTER DATABASE SCOPED CONFIGURATION SET PARAMETER_SNIFFING = ON;
        ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET PARAMETER_SNIFFING = PRIMARY;
        ALTER DATABASE SCOPED CONFIGURATION SET QUERY_OPTIMIZER_HOTFIXES = OFF;
        ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET QUERY_OPTIMIZER_HOTFIXES = PRIMARY;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET TEMPORAL_HISTORY_RETENTION ON 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF fulltextserviceproperty(N'IsFulltextInstalled') = 1
    EXECUTE sp_fulltext_database 'enable';


GO
PRINT N'Creating User [EchelonService]...';


GO
CREATE USER [EchelonService] FOR LOGIN [EchelonService];


GO
PRINT N'Creating User [vds]...';


GO
CREATE USER [vds] FOR LOGIN [vds];


GO
PRINT N'Creating Role Membership [db_owner] for [vds]...';


GO
EXECUTE sp_addrolemember @rolename = N'db_owner', @membername = N'vds';


GO
PRINT N'Creating Role Membership [db_owner] for [EchelonService]...';


GO
EXECUTE sp_addrolemember @rolename = N'db_owner', @membername = N'EchelonService';


GO
PRINT N'Creating Schema [integrations]...';


GO
CREATE SCHEMA [integrations]
    AUTHORIZATION [dbo];


GO
PRINT N'Creating Assembly [concat]...';


GO
CREATE ASSEMBLY [concat]
    AUTHORIZATION [dbo]
    FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300E3EE2A540000000000000000E00002210B010B00000C00000006000000000000AE2B0000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000602B00004B000000004000009003000000000000000000000000000000000000006000000C000000282A00001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000B40B000000200000000C000000020000000000000000000000000000200000602E72737263000000900300000040000000040000000E0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001200000000000000000000000000004000004200000000000000000000000000000000902B0000000000004800000002000500B421000074080000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000013300100110000000100001100027B010000046F0E00000A0A2B00062A360002730F00000A7D010000042A00133002002500000002000011000F01281000000A16FE010A062D022B13027B010000040F01281100000A6F1200000A262A000000133002002100000002000011001403FE0116FE010A062D022B12027B01000004037B010000046F1300000A262A000000133004004D00000003000011007E1400000A0A027B010000042C13027B010000046F1500000A16FE0216FE012B0117000C082D1A027B0100000416027B010000046F1500000A17596F1600000A0A06731700000A0B2B00072A000000133002002900000002000011000314FE0116FE010A062D0B7201000070731800000A7A02036F1900000A731A00000A7D010000042A000000133002002A00000002000011000314FE0116FE010A062D0B720F000070731800000A7A03027B010000046F0E00000A6F1B00000A002A1E02281C00000A2A000042534A4201000100000000000C00000076322E302E35303732370000000005006C000000D8020000237E0000440300007803000023537472696E677300000000BC0600002000000023555300DC060000100000002347554944000000EC0600008801000023426C6F6200000000000000020000015717A2010900000000FA253300160000010000001700000002000000010000000800000004000000010000001C0000000B00000003000000010000000100000001000000010000000200000000000A00010000000000060031002A000A005F00440006007C0070000A00CF00BA000600FE00F40006001001F40006006801560106007F01560106009C0156010600B50156010600CE0156010600E901560106000202560106001F025601060051023E023F00650200000600940274020600B40274020600D9022A000A00EF0244000A001003440006003C032A00060054032A000000000001000000000001000100012010001500000005000100010001008A000A0050200000000083089E000E0001006D20000000008600B500120001007C20000000008600D90016000100B020000000008600E4001C000200E020000000008600EA00220003003C2100000000E6010B0127000300742100000000E6011D012D000400AA21000000008618230112000500000001003C01000001004201000001004801000001004F0102000900390023013700410023013700490023013700510023013700590023013700610023013700690023013700710023013700790023013C00890023014200910023011200990023011200A10023014700090017030E0019002301120021002003C60021002B030E0019003503CA0019003503D400B1004303DA0019004903DD0019001703E100210023013700B9002301370029006A030E0019002301370031001D0137000900230112002E002B002D012E005B0066012E001300FA002E001B002D012E002300EE002E000B00EE002E003B003C012E00430049012E004B0054012E0053005D0143006B004D00C200D000E70002000100000029013300020001000300048000000100000000000000000000000000D20200000200000000000000000000000100210000000000020000000000000000000000010038000000000000000000003C4D6F64756C653E00636F6E6361742E646C6C00436F6E636174656E617465006D73636F726C69620053797374656D004F626A6563740053797374656D2E44617461004D6963726F736F66742E53716C5365727665722E536572766572004942696E61727953657269616C697A650053797374656D2E5465787400537472696E674275696C646572005F696E7465726D656469617465526573756C74006765745F496E7465726D656469617465526573756C7400496E69740053797374656D2E446174612E53716C54797065730053716C537472696E6700416363756D756C617465004D65726765005465726D696E6174650053797374656D2E494F0042696E61727952656164657200526561640042696E617279577269746572005772697465002E63746F7200496E7465726D656469617465526573756C740076616C7565006F7468657200726561646572007772697465720053797374656D2E5265666C656374696F6E00417373656D626C795469746C6541747472696275746500417373656D626C794465736372697074696F6E41747472696275746500417373656D626C79436F6D70616E7941747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C7956657273696F6E41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E4174747269627574650053797374656D2E446961676E6F73746963730044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C69747941747472696275746500636F6E6361740053657269616C697A61626C654174747269627574650053716C55736572446566696E656441676772656761746541747472696275746500466F726D617400546F537472696E67006765745F49734E756C6C006765745F56616C756500417070656E6400537472696E6700456D707479006765745F4C656E67746800417267756D656E744E756C6C457863657074696F6E0052656164537472696E6700000000000D720065006100640065007200000D7700720069007400650072000000000049F527D6E78DF44B9985349EF50A43450008B77A5C561934E0890306120D0320000E0320000105200101111105200101120804200011110520010112150520010112190328000E042001010E05200101114104200101080520010111557401000200000005005402124973496E76617269616E74546F4E756C6C73015402174973496E76617269616E74546F4475706C696361746573005402124973496E76617269616E74546F4F726465720054080B4D61784279746553697A65401F0000540E044E616D650B436F6E636174656E6174650307010E03200002052001120D0E03070102052001120D1C02060E032000080520020E08080607030E1111020B010006636F6E63617400003201002D412053514C205365727665722041676772656761746520746F20636F6E636174656E61746520737472696E677300000E010009466F78547269636B7300000C010007312E302E302E3000000A010005446562756700000801000701000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730100000000000000E3EE2A5400000000020000001C010000442A0000440C00005253445349772B2144A9E0409A276A1BD7102D4202000000633A5C55736572735C66696C69702E6465766F735C446F63756D656E74735C436F64655C74726173685C636F6E6361745C636F6E6361745C6F626A5C44656275675C636F6E6361742E70646200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000882B000000000000000000009E2B0000002000000000000000000000000000000000000000000000902B00000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000380300000000000000000000380334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00498020000010053007400720069006E006700460069006C00650049006E0066006F00000074020000010030003000300030003000340062003000000074002E00010043006F006D006D0065006E0074007300000041002000530051004C0020005300650072007600650072002000410067006700720065006700610074006500200074006F00200063006F006E0063006100740065006E00610074006500200073007400720069006E0067007300000034000A00010043006F006D00700061006E0079004E0061006D0065000000000046006F00780054007200690063006B0073000000380007000100460069006C0065004400650073006300720069007000740069006F006E000000000063006F006E0063006100740000000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E003000000038000B00010049006E007400650072006E0061006C004E0061006D006500000063006F006E006300610074002E0064006C006C000000000038000A0001004C006500670061006C0043006F007000790072006900670068007400000046006F00780054007200690063006B007300000040000B0001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000063006F006E006300610074002E0064006C006C0000000000300007000100500072006F0064007500630074004E0061006D0065000000000063006F006E0063006100740000000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000B03B00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;


GO
PRINT N'Creating Assembly [EchelonSQL]...';


GO
CREATE ASSEMBLY [EchelonSQL]
    AUTHORIZATION [dbo]
    FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010400D90A454B0000000000000000E00002210B01080000080000000E000000000000CE26000000200000004000000000400000200000000200000400000000000000040000000000000000A000000004000000000000020040850000100000100000000010000010000000000000100000000000000000000000802600004B000000006000004008000000000000000000000000000000000000008000000C000000004000001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000D4060000002000000008000000040000000000000000000000000000200000602E736461746100006C0000000040000000020000000C0000000000000000000000000000400000C02E727372630000004008000000600000000A0000000E0000000000000000000000000000400000402E72656C6F6300000C000000008000000002000000180000000000000000000000000000400000420000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B0260000000000004800000002000500802000000006000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002602280100000A00002A000013300200180000000100001100027E0200000A3304140A2B0902280300000A0A2B00062A42534A4201000100000000000C00000076322E302E35303732370000000005006C00000004020000237E000070020000A802000023537472696E6773000000001805000008000000235553002005000010000000234755494400000030050000D000000023426C6F620000000000000002000001471502000900000000FA0133001600000100000012000000020000000200000001000000110000000E0000000100000001000000030000000000980201000000000006005000490006008000490006008D0049000E00CD00B2000600F500E20006001201E2001B00260100000600550135010600750135010600B20193010600C00193010600D40149000600FC01EA0106001702EA0106003202EA0106004B02EA0106006402EA0106008102EA0100000000010000000000010001000100000029003E0005000100010050200000000006185700130001005C200000000016005D0017000100000001007300090057001300110087001D00190095001700210057001300290057001300310057002B00410057003100490057001300510057003600590057003B00610057003B0069005700360071005700360079005700360081005700360089005700360091005700360020002B0026002E0053009B002E00330040002E003B0049002E00430052002E004B0071002E006B00A7002E005B00A1002E0063009B002E007B009B002E008B00BF002E007300BF002E0083009B00400023002600210004800000010000004A0ECF6D0000000000003E00000002000000000000000000000001000A00000000000800000000000000000000000A001300000000000200000000000000000000000100A600000000000000003C4D6F64756C653E006D73636F726C6962004D6963726F736F66742E56697375616C42617369630055736572446566696E656446756E6374696F6E7300456368656C6F6E53514C0053797374656D004F626A656374002E63746F7200436F6E76657274426173653634546F42696E61727900626173653634737472696E670044424E756C6C0056616C756500436F6E766572740046726F6D426173653634537472696E670053797374656D2E44617461004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E4174747269627574650053797374656D2E446961676E6F73746963730044656275676765724E6F6E55736572436F64654174747269627574650044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650053797374656D2E52756E74696D652E496E7465726F705365727669636573004775696441747472696275746500436F6D56697369626C6541747472696275746500434C53436F6D706C69616E744174747269627574650053797374656D2E5265666C656374696F6E00417373656D626C7954726164656D61726B41747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F6D70616E7941747472696275746500417373656D626C794465736372697074696F6E41747472696275746500417373656D626C795469746C6541747472696275746500456368656C6F6E53514C2E646C6C000000032000000000005A49F7EF2413304CB028EED5115088C00008B77A5C561934E08908B03F5F7F11D50A3A032000010500011D050E030612090407011D05040100000005200101111D0420010108042001010E04200101020801000301000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773012901002466623062393066362D336238622D346536322D396637342D623333336435653861613231000005010000000005010001000017010012436F7079726967687420C2A920203230313000000F01000A456368656C6F6E53514C000000A82600000000000000000000BE260000002000000000000000000000000000000000000000000000B02600000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000D90A454B0000000002000000500000001C4000001C0C0000525344538F3373F1BDBEC947BD9AC6964DC9ED8C01000000443A5C50726F6A656374735C456368656C6F6E5C456368656C6F6E53514C5C6F626A5C44656275675C456368656C6F6E53514C2E7064620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030003000000280000800E000000480000801000000060000080000000000000000000000000000002000200000078000080030000009000008000000000000000000000000000000100007F0000A80000800000000000000000000000000000010001000000C00000800000000000000000000000000000010000000000D80000000000000000000000000000000000010000000000E80000000000000000000000000000000000010000000000F800000000000000000000000000000000000100000000000801000008640000E80200000000000000000000F06600002801000000000000000000001868000022000000000000000000000018610000F00200000000000000000000F00234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE0000010000000100CF6D4A0E00000100CF6D4A0E3F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00450020000010053007400720069006E006700460069006C00650049006E0066006F0000002C020000010030003000300030003000340062003000000040000B000100460069006C0065004400650073006300720069007000740069006F006E000000000045006300680065006C006F006E00530051004C000000000040000F000100460069006C006500560065007200730069006F006E000000000031002E0030002E0033003600350038002E00320038003100310031000000000040000F00010049006E007400650072006E0061006C004E0061006D006500000045006300680065006C006F006E00530051004C002E0064006C006C00000000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A900200020003200300031003000000048000F0001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000045006300680065006C006F006E00530051004C002E0064006C006C000000000038000B000100500072006F0064007500630074004E0061006D0065000000000045006300680065006C006F006E00530051004C000000000044000F000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0033003600350038002E00320038003100310031000000000048000F00010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0033003600350038002E003200380031003100310000000000280000002000000040000000010004000000000080020000000000000000000000000000000000000000000000008000008000000080800080000000800080008080000080808000C0C0C0000000FF0000FF000000FFFF00FF000000FF00FF00FFFF0000FFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777777777777777777700444444444444444444444444444447004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF4700488888888888888888888888888847004444444444444444444444444444470044C4C4C4C4C4C4C4C4C4ECECE49747004CCCCCCCCCCCCCCCCCCCCCCCCCCC40000444444444444444444444444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC00000018000000180000001800000018000000180000001800000018000000180000001800000018000000180000001800000018000000180000001800000018000000180000001800000018000000180000001800000018000000180000003C0000007FFFFFFFFFFFFFFFFFFFFFFFF2800000010000000200000000100040000000000C0000000000000000000000000000000000000000000000000008000008000000080800080000000800080008080000080808000C0C0C0000000FF0000FF000000FFFF00FF000000FF00FF00FFFF0000FFFFFF000000000000000000077777777777777744444444444444474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF84748888888888888474CCCCCCCCCCCCC47C4444444444444C000000000000000000000000000000000FFFF000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000FFFF0000FFFF00000000010002002020100001000400E80200000200101010000100040028010000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000D03600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;


GO
PRINT N'Creating Aggregate [dbo].[Concatenate]...';


GO
CREATE AGGREGATE [dbo].[Concatenate](@value NVARCHAR (MAX) NULL)
    RETURNS NVARCHAR (MAX)
    EXTERNAL NAME [concat].[Concatenate];


GO
PRINT N'Creating Table [dbo].[account_organization_addresses]...';


GO
CREATE TABLE [dbo].[account_organization_addresses] (
    [account_org_id] UNIQUEIDENTIFIER NOT NULL,
    [address_id]     UNIQUEIDENTIFIER NOT NULL,
    [address_name]   NVARCHAR (100)   NULL,
    [author]         VARCHAR (50)     NOT NULL,
    [create_date]    DATETIME         NOT NULL,
    [modifier]       VARCHAR (50)     NOT NULL,
    [modified_date]  DATETIME         NOT NULL,
    [stamp]          ROWVERSION       NOT NULL,
    CONSTRAINT [PK_account_organization_addresses] PRIMARY KEY CLUSTERED ([account_org_id] ASC, [address_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[account_organization_application_product_sort_order]...';


GO
CREATE TABLE [dbo].[account_organization_application_product_sort_order] (
    [account_id]      UNIQUEIDENTIFIER NOT NULL,
    [organization_id] UNIQUEIDENTIFIER NOT NULL,
    [application]     VARCHAR (100)    NOT NULL,
    [product]         VARCHAR (100)    NOT NULL,
    [sort_order]      INT              NOT NULL,
    [author]          VARCHAR (50)     NOT NULL,
    [create_date]     DATETIME         NOT NULL,
    [modifier]        VARCHAR (50)     NOT NULL,
    [modified_date]   DATETIME         NOT NULL,
    [stamp]           ROWVERSION       NOT NULL,
    CONSTRAINT [PK_account_organization_application_product_sort_order] PRIMARY KEY CLUSTERED ([account_id] ASC, [organization_id] ASC, [application] ASC, [product] ASC)
);


GO
PRINT N'Creating Index [dbo].[account_organization_application_product_sort_order].[IX_account_organization_application_product_sort_order]...';


GO
CREATE NONCLUSTERED INDEX [IX_account_organization_application_product_sort_order]
    ON [dbo].[account_organization_application_product_sort_order]([account_id] ASC);


GO
PRINT N'Creating Table [dbo].[account_organization_documents]...';


GO
CREATE TABLE [dbo].[account_organization_documents] (
    [account_id]                   UNIQUEIDENTIFIER NOT NULL,
    [organization_id]              UNIQUEIDENTIFIER NOT NULL,
    [doc_id]                       UNIQUEIDENTIFIER NOT NULL,
    [application]                  VARCHAR (100)    NOT NULL,
    [product]                      VARCHAR (100)    NOT NULL,
    [description]                  VARCHAR (255)    NOT NULL,
    [notes]                        VARCHAR (255)    NOT NULL,
    [allow_inclusion_buyer_packet] BIT              NOT NULL,
    [doc_data]                     VARBINARY (MAX)  NOT NULL,
    [size]                         INT              NOT NULL,
    [type]                         VARCHAR (10)     NOT NULL,
    [url]                          VARCHAR (MAX)    NOT NULL,
    [author]                       VARCHAR (50)     NOT NULL,
    [create_date]                  DATETIME         NOT NULL,
    [modifier]                     VARCHAR (50)     NOT NULL,
    [modified_date]                DATETIME         NOT NULL,
    [stamp]                        ROWVERSION       NOT NULL,
    CONSTRAINT [PK_account_orgainzation_documents] PRIMARY KEY CLUSTERED ([account_id] ASC, [organization_id] ASC, [doc_id] ASC),
    CONSTRAINT [UX_account_orgainzation_documents_doc_id] UNIQUE NONCLUSTERED ([doc_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[account_organization_support_emails]...';


GO
CREATE TABLE [dbo].[account_organization_support_emails] (
    [account_org_id]            UNIQUEIDENTIFIER NOT NULL,
    [problem_type_id]           INT              NOT NULL,
    [email]                     NVARCHAR (100)   NULL,
    [should_send_notifications] BIT              NOT NULL,
    [author]                    VARCHAR (50)     NOT NULL,
    [create_date]               DATETIME         NOT NULL,
    [modifier]                  VARCHAR (50)     NOT NULL,
    [modified_date]             DATETIME         NOT NULL,
    [stamp]                     ROWVERSION       NOT NULL,
    CONSTRAINT [PK_account_organization_support_emails] PRIMARY KEY CLUSTERED ([account_org_id] ASC, [problem_type_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[account_organization_user_profile]...';


GO
CREATE TABLE [dbo].[account_organization_user_profile] (
    [account_id]              UNIQUEIDENTIFIER NOT NULL,
    [organization_id]         UNIQUEIDENTIFIER NOT NULL,
    [user_id]                 UNIQUEIDENTIFIER NOT NULL,
    [profile_id]              UNIQUEIDENTIFIER NULL,
    [interest_rate]           DECIMAL (18, 6)  NOT NULL,
    [loan_term]               DECIMAL (18, 6)  NOT NULL,
    [completed_steps]         INT              NOT NULL,
    [enable_homebuyer_access] BIT              NOT NULL,
    [author]                  VARCHAR (50)     NOT NULL,
    [create_date]             DATETIME         NOT NULL,
    [modifier]                VARCHAR (50)     NOT NULL,
    [modified_date]           DATETIME         NOT NULL,
    [stamp]                   ROWVERSION       NOT NULL,
    CONSTRAINT [PK_account_organization_user_profile] PRIMARY KEY CLUSTERED ([account_id] ASC, [organization_id] ASC, [user_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[account_organization_user_profile].[account_organization_user_profile_profile_id]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [account_organization_user_profile_profile_id]
    ON [dbo].[account_organization_user_profile]([profile_id] ASC);


GO
PRINT N'Creating Table [dbo].[account_organization_user_profile_plan]...';


GO
CREATE TABLE [dbo].[account_organization_user_profile_plan] (
    [account_id]                 UNIQUEIDENTIFIER NOT NULL,
    [organization_id]            UNIQUEIDENTIFIER NOT NULL,
    [user_id]                    UNIQUEIDENTIFIER NOT NULL,
    [profile_id]                 UNIQUEIDENTIFIER NOT NULL,
    [community_name]             VARCHAR (50)     NOT NULL,
    [series]                     VARCHAR (50)     NOT NULL,
    [plan_name]                  VARCHAR (50)     NOT NULL,
    [base_plan_name]             VARCHAR (50)     NOT NULL,
    [spec_id]                    INT              NOT NULL,
    [sales_price]                DECIMAL (18, 2)  NOT NULL,
    [sales_options]              DECIMAL (18, 2)  NOT NULL,
    [upgrades_incentive]         DECIMAL (18, 2)  NOT NULL,
    [additional_design_deposit]  DECIMAL (18, 2)  NOT NULL,
    [deposit_notes]              VARCHAR (255)    NOT NULL,
    [home_down_payment]          DECIMAL (18, 2)  NOT NULL,
    [home_allowance]             DECIMAL (18, 2)  NOT NULL,
    [catalog_session_id]         UNIQUEIDENTIFIER NULL,
    [catalog_session_date]       DATETIME         NULL,
    [catalog_total]              DECIMAL (18, 2)  NOT NULL,
    [job_no]                     VARCHAR (20)     NOT NULL,
    [address]                    VARCHAR (50)     NOT NULL,
    [address_lot_block]          VARCHAR (50)     NOT NULL,
    [property_desc_1]            VARCHAR (50)     NOT NULL,
    [property_desc_2]            VARCHAR (50)     NOT NULL,
    [block]                      VARCHAR (10)     NOT NULL,
    [lot]                        VARCHAR (10)     NOT NULL,
    [city]                       VARCHAR (50)     NOT NULL,
    [state]                      VARCHAR (25)     NOT NULL,
    [zip_code]                   VARCHAR (25)     NOT NULL,
    [sales_counselor]            VARCHAR (50)     NOT NULL,
    [contract_date]              DATETIME         NULL,
    [receipt_date]               DATETIME         NULL,
    [country_home_phone]         VARCHAR (25)     NOT NULL,
    [home_phone]                 VARCHAR (20)     NOT NULL,
    [country_work_phone]         VARCHAR (25)     NOT NULL,
    [work_phone]                 VARCHAR (20)     NULL,
    [spouse_first_name]          VARCHAR (50)     NOT NULL,
    [spouse_last_name]           VARCHAR (50)     NOT NULL,
    [country_spouse_phone]       VARCHAR (25)     NOT NULL,
    [spouse_phone]               VARCHAR (20)     NOT NULL,
    [dc_job_id]                  INT              NOT NULL,
    [dc_contact_list]            VARCHAR (MAX)    NULL,
    [status]                     VARCHAR (15)     NOT NULL,
    [previous_status]            VARCHAR (15)     NULL,
    [echelon_exported]           BIT              NOT NULL,
    [spec_home]                  BIT              NOT NULL,
    [job_type]                   INT              NOT NULL,
    [elevation]                  VARCHAR (50)     NOT NULL,
    [stage]                      VARCHAR (10)     NOT NULL,
    [superintendent]             VARCHAR (50)     NOT NULL,
    [author]                     VARCHAR (50)     NOT NULL,
    [create_date]                DATETIME         NOT NULL,
    [modifier]                   VARCHAR (50)     NOT NULL,
    [modified_date]              DATETIME         NOT NULL,
    [stamp]                      ROWVERSION       NOT NULL,
    [expiration_date]            DATETIME         NULL,
    [upgrade_deposit_percentage] DECIMAL (18, 2)  NULL,
    CONSTRAINT [PK_account_organization_user_plan_profile] PRIMARY KEY CLUSTERED ([account_id] ASC, [organization_id] ASC, [user_id] ASC, [community_name] ASC, [series] ASC, [plan_name] ASC)
);


GO
PRINT N'Creating Index [dbo].[account_organization_user_profile_plan].[IX_account_organization_user_profile_plan_address_lot_block]...';


GO
CREATE NONCLUSTERED INDEX [IX_account_organization_user_profile_plan_address_lot_block]
    ON [dbo].[account_organization_user_profile_plan]([address_lot_block] ASC);


GO
PRINT N'Creating Index [dbo].[account_organization_user_profile_plan].[IX_account_organization_user_profile_plan_address]...';


GO
CREATE NONCLUSTERED INDEX [IX_account_organization_user_profile_plan_address]
    ON [dbo].[account_organization_user_profile_plan]([address] ASC);


GO
PRINT N'Creating Index [dbo].[account_organization_user_profile_plan].[IX_account_organization_user_profile_plan_community_name]...';


GO
CREATE NONCLUSTERED INDEX [IX_account_organization_user_profile_plan_community_name]
    ON [dbo].[account_organization_user_profile_plan]([community_name] ASC);


GO
PRINT N'Creating Index [dbo].[account_organization_user_profile_plan].[NonClusteredIndex-20130424-085825]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [NonClusteredIndex-20130424-085825]
    ON [dbo].[account_organization_user_profile_plan]([profile_id] ASC);


GO
PRINT N'Creating Table [dbo].[account_organization_user_profile_plan_catalog_sessions]...';


GO
CREATE TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions] (
    [account_id]                UNIQUEIDENTIFIER NOT NULL,
    [organization_id]           UNIQUEIDENTIFIER NOT NULL,
    [user_id]                   UNIQUEIDENTIFIER NOT NULL,
    [community_id]              INT              NOT NULL,
    [community_name]            VARCHAR (50)     NOT NULL,
    [series]                    VARCHAR (50)     NOT NULL,
    [plan_name]                 VARCHAR (50)     NOT NULL,
    [plan_version]              VARCHAR (50)     NOT NULL,
    [session_id]                UNIQUEIDENTIFIER NOT NULL,
    [status]                    INT              NOT NULL,
    [status_change_reason]      VARCHAR (MAX)    NULL,
    [session_notes]             VARCHAR (MAX)    NOT NULL,
    [deposit]                   DECIMAL (18, 2)  NOT NULL,
    [deposit_notes]             VARCHAR (255)    NOT NULL,
    [designer]                  VARCHAR (50)     NOT NULL,
    [show_report]               BIT              NULL,
    [spec_id]                   INT              NOT NULL,
    [effective_date]            DATETIME         NOT NULL,
    [completed_date]            DATETIME         NOT NULL,
    [first_completed_date]      DATETIME         NOT NULL,
    [export_date]               DATETIME         NOT NULL,
    [address_id]                INT              NOT NULL,
    [rounding_type]             INT              NOT NULL,
    [rounding_places]           INT              NOT NULL,
    [builder_markup_hb_pricing] BIT              NOT NULL,
    [buyer_signature]           VARBINARY (MAX)  NULL,
    [buyer_signature_date]      DATETIME         NULL,
    [pricing_generated]         DATETIME         NOT NULL,
    [pricing_published]         DATETIME         NOT NULL,
    [report_id]                 UNIQUEIDENTIFIER NULL,
    [author]                    VARCHAR (50)     NOT NULL,
    [create_date]               DATETIME         NOT NULL,
    [modifier]                  VARCHAR (50)     NOT NULL,
    [modified_date]             DATETIME         NOT NULL,
    [stamp]                     ROWVERSION       NOT NULL,
    [catalog_source]            VARCHAR (100)    NULL,
    [designer_id]               UNIQUEIDENTIFIER NULL,
    [precon_notes]              VARCHAR (250)    NOT NULL,
    CONSTRAINT [PK_account_organization_user_profile_plan_catalog_sessions] PRIMARY KEY CLUSTERED ([session_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[account_organization_user_profile_plan_catalog_sessions].[IX_aouppcs_account_organization_user]...';


GO
CREATE NONCLUSTERED INDEX [IX_aouppcs_account_organization_user]
    ON [dbo].[account_organization_user_profile_plan_catalog_sessions]([account_id] ASC, [organization_id] ASC, [user_id] ASC);


GO
PRINT N'Creating Index [dbo].[account_organization_user_profile_plan_catalog_sessions].[IX_aouppcs_first_completed_date]...';


GO
CREATE NONCLUSTERED INDEX [IX_aouppcs_first_completed_date]
    ON [dbo].[account_organization_user_profile_plan_catalog_sessions]([first_completed_date] ASC)
    INCLUDE([account_id], [community_name], [organization_id], [plan_name], [series], [user_id]);


GO
PRINT N'Creating Index [dbo].[account_organization_user_profile_plan_catalog_sessions].[IX_account_organization_user_profile_plan_catalog_sessions_status_includes]...';


GO
CREATE NONCLUSTERED INDEX [IX_account_organization_user_profile_plan_catalog_sessions_status_includes]
    ON [dbo].[account_organization_user_profile_plan_catalog_sessions]([status] ASC)
    INCLUDE([account_id], [organization_id], [user_id], [community_name], [series], [plan_name], [session_id]);


GO
PRINT N'Creating Table [dbo].[account_organization_user_profile_plan_catalog_sessions_documents]...';


GO
CREATE TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions_documents] (
    [document_id]    UNIQUEIDENTIFIER NOT NULL,
    [session_id]     UNIQUEIDENTIFIER NOT NULL,
    [application_id] VARCHAR (10)     NOT NULL,
    [product_id]     VARCHAR (10)     NOT NULL,
    [area_id]        VARCHAR (20)     NOT NULL,
    [sub_area_id]    VARCHAR (20)     NOT NULL,
    [location_id]    INT              NOT NULL,
    [document_type]  VARCHAR (50)     NOT NULL,
    [document_data]  VARBINARY (MAX)  NOT NULL,
    [author]         VARCHAR (50)     NOT NULL,
    [create_date]    DATETIME         NOT NULL,
    [modifier]       VARCHAR (50)     NOT NULL,
    [modified_date]  DATETIME         NOT NULL,
    [stamp]          ROWVERSION       NOT NULL,
    CONSTRAINT [PK_account_organization_user_profile_plan_catalog_sessions_documents_1] PRIMARY KEY CLUSTERED ([document_id] ASC, [session_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[account_organization_user_profile_plan_catalog_sessions_documents].[IX_account_organization_user_profile_plan_catalog_sessions_documents_session_id]...';


GO
CREATE NONCLUSTERED INDEX [IX_account_organization_user_profile_plan_catalog_sessions_documents_session_id]
    ON [dbo].[account_organization_user_profile_plan_catalog_sessions_documents]([session_id] ASC);


GO
PRINT N'Creating Table [dbo].[account_organization_user_profile_plan_documents]...';


GO
CREATE TABLE [dbo].[account_organization_user_profile_plan_documents] (
    [account_id]      UNIQUEIDENTIFIER NOT NULL,
    [organization_id] UNIQUEIDENTIFIER NOT NULL,
    [user_id]         UNIQUEIDENTIFIER NOT NULL,
    [community_name]  VARCHAR (50)     NOT NULL,
    [community_id]    INT              NOT NULL,
    [series]          VARCHAR (50)     NOT NULL,
    [plan_name]       VARCHAR (50)     NOT NULL,
    [doc_id]          UNIQUEIDENTIFIER NOT NULL,
    [doc_name]        VARCHAR (50)     NOT NULL,
    [doc_type]        VARCHAR (50)     NOT NULL,
    [doc_data]        VARBINARY (MAX)  NOT NULL,
    [doc_notes]       VARCHAR (255)    NOT NULL,
    [author]          VARCHAR (50)     NOT NULL,
    [create_date]     DATETIME         NOT NULL,
    [modifier]        VARCHAR (50)     NOT NULL,
    [modified_date]   DATETIME         NOT NULL,
    CONSTRAINT [PK_account_organization_user_profile_plan_documents] PRIMARY KEY CLUSTERED ([account_id] ASC, [organization_id] ASC, [user_id] ASC, [community_id] ASC, [series] ASC, [plan_name] ASC, [doc_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[account_organization_user_profile_plan_documents].[IX_account_organization_user_profile_plan_documents]...';


GO
CREATE NONCLUSTERED INDEX [IX_account_organization_user_profile_plan_documents]
    ON [dbo].[account_organization_user_profile_plan_documents]([doc_id] ASC);


GO
PRINT N'Creating Table [dbo].[account_organization_user_profile_plan_exterior_selections]...';


GO
CREATE TABLE [dbo].[account_organization_user_profile_plan_exterior_selections] (
    [account_id]        UNIQUEIDENTIFIER NOT NULL,
    [organization_id]   UNIQUEIDENTIFIER NOT NULL,
    [user_id]           UNIQUEIDENTIFIER NOT NULL,
    [community_name]    VARCHAR (50)     NOT NULL,
    [series]            VARCHAR (50)     NOT NULL,
    [plan_name]         VARCHAR (50)     NOT NULL,
    [selection_line_no] INT              IDENTITY (1, 1) NOT NULL,
    [selection_type]    VARCHAR (20)     NOT NULL,
    [manufacturer_id]   UNIQUEIDENTIFIER NULL,
    [part_id]           VARCHAR (50)     NULL,
    [part_description]  VARCHAR (50)     NOT NULL,
    [notes]             VARCHAR (MAX)    NOT NULL,
    [author]            VARCHAR (50)     NOT NULL,
    [create_date]       DATETIME         NOT NULL,
    [modifier]          VARCHAR (50)     NOT NULL,
    [modified_date]     DATETIME         NOT NULL,
    [stamp]             VARCHAR (50)     NOT NULL,
    CONSTRAINT [PK_account_organization_user_profile_plan_exterior_selections] PRIMARY KEY CLUSTERED ([account_id] ASC, [organization_id] ASC, [user_id] ASC, [community_name] ASC, [series] ASC, [plan_name] ASC, [selection_line_no] ASC)
);


GO
PRINT N'Creating Table [dbo].[account_organization_user_profile_plan_options_budget_items]...';


GO
CREATE TABLE [dbo].[account_organization_user_profile_plan_options_budget_items] (
    [id]               UNIQUEIDENTIFIER NOT NULL,
    [account_id]       UNIQUEIDENTIFIER NOT NULL,
    [organization_id]  UNIQUEIDENTIFIER NOT NULL,
    [user_id]          UNIQUEIDENTIFIER NOT NULL,
    [community]        VARCHAR (50)     NOT NULL,
    [series]           VARCHAR (50)     NOT NULL,
    [plan_name]        VARCHAR (50)     NOT NULL,
    [application_name] VARCHAR (50)     NOT NULL,
    [product_name]     VARCHAR (50)     NOT NULL,
    [area]             VARCHAR (100)    NOT NULL,
    [sub_area]         VARCHAR (50)     NOT NULL,
    [item_no]          VARCHAR (100)    NOT NULL,
    [item_name]        VARCHAR (1200)   NOT NULL,
    [qty]              INT              NOT NULL,
    [price]            DECIMAL (18, 2)  NOT NULL,
    [spec_id]          INT              NULL,
    [effective_date]   DATETIME         NULL,
    [plan_version]     VARCHAR (50)     NULL,
    [source]           VARCHAR (50)     NOT NULL,
    [author]           VARCHAR (50)     NOT NULL,
    [create_date]      DATETIME         NOT NULL,
    [modifier]         VARCHAR (50)     NOT NULL,
    [modified_date]    DATETIME         NOT NULL,
    [stamp]            ROWVERSION       NOT NULL,
    CONSTRAINT [PK_account_organization_user_profile_plan_options_budget_items] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Index [dbo].[account_organization_user_profile_plan_options_budget_items].[UX_account_organization_user_profile_plan_options_budget_items_primary]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [UX_account_organization_user_profile_plan_options_budget_items_primary]
    ON [dbo].[account_organization_user_profile_plan_options_budget_items]([account_id] ASC, [organization_id] ASC, [user_id] ASC, [community] ASC, [series] ASC, [plan_name] ASC, [application_name] ASC, [product_name] ASC, [area] ASC, [sub_area] ASC, [item_no] ASC, [item_name] ASC);


GO
PRINT N'Creating Table [dbo].[account_organization_user_profile_plan_original_status]...';


GO
CREATE TABLE [dbo].[account_organization_user_profile_plan_original_status] (
    [account_id]      UNIQUEIDENTIFIER NOT NULL,
    [organization_id] UNIQUEIDENTIFIER NOT NULL,
    [user_id]         UNIQUEIDENTIFIER NOT NULL,
    [community_name]  VARCHAR (50)     NOT NULL,
    [series]          VARCHAR (50)     NOT NULL,
    [plan_name]       VARCHAR (50)     NOT NULL,
    [original_status] VARCHAR (15)     NOT NULL,
    [new_status]      VARCHAR (15)     NOT NULL,
    [create_date]     DATETIME         NOT NULL,
    [modifier]        VARCHAR (50)     NOT NULL,
    [modified_date]   DATETIME         NOT NULL,
    [stamp]           ROWVERSION       NOT NULL,
    CONSTRAINT [PK_account_organization_user_profile_plan_original_status] PRIMARY KEY CLUSTERED ([account_id] ASC, [organization_id] ASC, [user_id] ASC, [community_name] ASC, [series] ASC, [plan_name] ASC)
);


GO
PRINT N'Creating Table [dbo].[account_organization_user_wishlist_items]...';


GO
CREATE TABLE [dbo].[account_organization_user_wishlist_items] (
    [account_id]       UNIQUEIDENTIFIER NOT NULL,
    [organization_id]  UNIQUEIDENTIFIER NOT NULL,
    [user_id]          UNIQUEIDENTIFIER NOT NULL,
    [wishlist_item_id] UNIQUEIDENTIFIER NOT NULL,
    [item_type]        VARCHAR (50)     NOT NULL,
    [item_no]          VARCHAR (81)     NOT NULL,
    [description]      VARCHAR (100)    NOT NULL,
    [image_data]       VARBINARY (MAX)  NULL,
    [notes]            VARCHAR (MAX)    NOT NULL,
    [author]           VARCHAR (50)     NOT NULL,
    [create_date]      DATETIME         NOT NULL,
    [modifier]         VARCHAR (50)     NOT NULL,
    [modified_date]    DATETIME         NOT NULL,
    [stamp]            ROWVERSION       NOT NULL,
    [gpc_id]           VARCHAR (50)     NOT NULL,
    CONSTRAINT [PK_account_organization_user_wishlist_items] PRIMARY KEY CLUSTERED ([account_id] ASC, [organization_id] ASC, [user_id] ASC, [wishlist_item_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[account_product_guide_pages]...';


GO
CREATE TABLE [dbo].[account_product_guide_pages] (
    [page_id]            UNIQUEIDENTIFIER ROWGUIDCOL NOT NULL,
    [account_id]         UNIQUEIDENTIFIER NOT NULL,
    [category]           VARCHAR (50)     NOT NULL,
    [product]            VARCHAR (50)     NOT NULL,
    [page_title]         VARCHAR (50)     NOT NULL,
    [page_text]          VARCHAR (2000)   NULL,
    [image_url]          VARCHAR (100)    NOT NULL,
    [category_image_url] VARCHAR (200)    NULL,
    [product_image_url]  VARCHAR (200)    NULL,
    [active]             BIT              NOT NULL,
    [display_sequence]   INT              NULL,
    [application_id]     VARCHAR (50)     NULL,
    [product_id]         VARCHAR (50)     NULL,
    [author]             VARCHAR (50)     NOT NULL,
    [create_date]        DATETIME         NOT NULL,
    [modifier]           VARCHAR (50)     NOT NULL,
    [modified_date]      DATETIME         NOT NULL,
    [stamp]              ROWVERSION       NOT NULL,
    CONSTRAINT [PK_product_guide_pages] PRIMARY KEY CLUSTERED ([page_id] ASC, [account_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[account_product_guide_pages_links]...';


GO
CREATE TABLE [dbo].[account_product_guide_pages_links] (
    [link_id]          UNIQUEIDENTIFIER ROWGUIDCOL NOT NULL,
    [page_id]          UNIQUEIDENTIFIER NOT NULL,
    [link_url]         VARCHAR (200)    NOT NULL,
    [link_display]     VARCHAR (100)    NOT NULL,
    [display_sequence] INT              NULL,
    [author]           VARCHAR (50)     NOT NULL,
    [create_date]      DATETIME         NOT NULL,
    [modifier]         VARCHAR (50)     NOT NULL,
    [modified_date]    DATETIME         NOT NULL,
    [stamp]            ROWVERSION       NOT NULL,
    CONSTRAINT [PK_account_product_guide_pages_links] PRIMARY KEY CLUSTERED ([link_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[address_types]...';


GO
CREATE TABLE [dbo].[address_types] (
    [address_type]  NVARCHAR (50) NOT NULL,
    [author]        VARCHAR (50)  NOT NULL,
    [create_date]   DATETIME      NOT NULL,
    [modifier]      VARCHAR (50)  NOT NULL,
    [modified_date] DATETIME      NOT NULL,
    [stamp]         ROWVERSION    NOT NULL,
    CONSTRAINT [PK_address_types] PRIMARY KEY CLUSTERED ([address_type] ASC)
);


GO
PRINT N'Creating Table [dbo].[addresses]...';


GO
CREATE TABLE [dbo].[addresses] (
    [address_id]    UNIQUEIDENTIFIER NOT NULL,
    [address_type]  NVARCHAR (20)    NULL,
    [address]       NVARCHAR (50)    NULL,
    [city]          NVARCHAR (50)    NULL,
    [state]         NVARCHAR (50)    NULL,
    [postal_code]   NVARCHAR (10)    NULL,
    [country_code]  NVARCHAR (5)     NULL,
    [phone1]        NVARCHAR (20)    NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_addresses] PRIMARY KEY CLUSTERED ([address_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[application_icon]...';


GO
CREATE TABLE [dbo].[application_icon] (
    [application]   NVARCHAR (100)   NOT NULL,
    [icon_id]       UNIQUEIDENTIFIER NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_application_icon] PRIMARY KEY CLUSTERED ([application] ASC)
);


GO
PRINT N'Creating Table [dbo].[builder_bom_modification_types]...';


GO
CREATE TABLE [dbo].[builder_bom_modification_types] (
    [id]            INT          NOT NULL,
    [name]          VARCHAR (25) NOT NULL,
    [author]        VARCHAR (50) NOT NULL,
    [create_date]   DATETIME     NOT NULL,
    [modifier]      VARCHAR (50) NOT NULL,
    [modified_date] DATETIME     NOT NULL,
    [stamp]         ROWVERSION   NOT NULL,
    CONSTRAINT [PK_builder_bom_modification_types] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Table [dbo].[builder_bom_modifications]...';


GO
CREATE TABLE [dbo].[builder_bom_modifications] (
    [id]                     UNIQUEIDENTIFIER NOT NULL,
    [account_id]             UNIQUEIDENTIFIER NOT NULL,
    [organization_id]        UNIQUEIDENTIFIER NOT NULL,
    [community]              VARCHAR (100)    NULL,
    [series]                 VARCHAR (100)    NULL,
    [plan]                   VARCHAR (100)    NULL,
    [elevation]              VARCHAR (50)     NULL,
    [application_id]         VARCHAR (10)     NULL,
    [application]            VARCHAR (100)    NULL,
    [product_id]             VARCHAR (10)     NULL,
    [product]                VARCHAR (100)    NULL,
    [area_id]                VARCHAR (10)     NULL,
    [area]                   VARCHAR (100)    NULL,
    [sub_area_id]            VARCHAR (10)     NULL,
    [sub_area]               VARCHAR (100)    NULL,
    [item_code]              VARCHAR (100)    NULL,
    [item]                   VARCHAR (MAX)    NOT NULL,
    [vendor]                 VARCHAR (100)    NULL,
    [modification_type]      INT              NOT NULL,
    [quantity]               DECIMAL (18, 4)  NOT NULL,
    [price]                  DECIMAL (18, 2)  NULL,
    [cost]                   DECIMAL (18, 2)  NULL,
    [notes]                  VARCHAR (MAX)    NULL,
    [gpc]                    UNIQUEIDENTIFIER NULL,
    [option_pricing_display] BIT              NOT NULL,
    [author]                 VARCHAR (50)     NOT NULL,
    [create_date]            DATETIME         NOT NULL,
    [modifier]               VARCHAR (50)     NOT NULL,
    [modified_date]          DATETIME         NOT NULL,
    [stamp]                  ROWVERSION       NOT NULL,
    CONSTRAINT [PK_builder_bom_modifications] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Index [dbo].[builder_bom_modifications].[IX_account_org]...';


GO
CREATE NONCLUSTERED INDEX [IX_account_org]
    ON [dbo].[builder_bom_modifications]([account_id] ASC, [organization_id] ASC);


GO
PRINT N'Creating Table [dbo].[builder_features]...';


GO
CREATE TABLE [dbo].[builder_features] (
    [organization_id] UNIQUEIDENTIFIER NOT NULL,
    [feature_id]      INT              NOT NULL,
    [value]           BIT              NOT NULL,
    [author]          VARCHAR (100)    NOT NULL,
    [create_date]     DATETIME         NOT NULL,
    [modifier]        VARCHAR (100)    NOT NULL,
    [modified_date]   DATETIME         NOT NULL,
    [stamp]           ROWVERSION       NOT NULL,
    CONSTRAINT [PK_builder_features] PRIMARY KEY CLUSTERED ([organization_id] ASC, [feature_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[builder_features].[IX_feature_organization]...';


GO
CREATE NONCLUSTERED INDEX [IX_feature_organization]
    ON [dbo].[builder_features]([feature_id] ASC, [organization_id] ASC);


GO
PRINT N'Creating Table [dbo].[builder_plan_budget_values_community_defaults]...';


GO
CREATE TABLE [dbo].[builder_plan_budget_values_community_defaults] (
    [builder_id]    UNIQUEIDENTIFIER NOT NULL,
    [community_id]  UNIQUEIDENTIFIER NOT NULL,
    [name_id]       INT              NOT NULL,
    [value]         DECIMAL (18, 3)  NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_builder_plan_budget_values_community_defaults] PRIMARY KEY CLUSTERED ([builder_id] ASC, [community_id] ASC, [name_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[builder_plan_budget_values_settings]...';


GO
CREATE TABLE [dbo].[builder_plan_budget_values_settings] (
    [builder_id]    UNIQUEIDENTIFIER NOT NULL,
    [name_id]       INT              NOT NULL,
    [enabled]       BIT              NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_builder_plan_budget_values_settings] PRIMARY KEY CLUSTERED ([builder_id] ASC, [name_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[calendar]...';


GO
CREATE TABLE [dbo].[calendar] (
    [dt]        DATE NOT NULL,
    [IsWorkDay] BIT  NULL,
    CONSTRAINT [PK__calendar__32136E5F3AD639F9] PRIMARY KEY CLUSTERED ([dt] ASC)
);


GO
PRINT N'Creating Table [dbo].[catalog_items]...';


GO
CREATE TABLE [dbo].[catalog_items] (
    [row_id]                 UNIQUEIDENTIFIER NOT NULL,
    [account_id]             UNIQUEIDENTIFIER NOT NULL,
    [organization_id]        UNIQUEIDENTIFIER NOT NULL,
    [community]              VARCHAR (100)    NOT NULL,
    [series]                 VARCHAR (100)    NOT NULL,
    [plan]                   VARCHAR (100)    NOT NULL,
    [application]            VARCHAR (100)    NOT NULL,
    [product]                VARCHAR (100)    NOT NULL,
    [area]                   VARCHAR (100)    NOT NULL,
    [sub_area]               VARCHAR (100)    NOT NULL,
    [item_no]                VARCHAR (100)    NOT NULL,
    [item]                   VARCHAR (MAX)    NOT NULL,
    [vendor]                 VARCHAR (100)    NOT NULL,
    [standard]               VARCHAR (200)    NOT NULL,
    [qty]                    DECIMAL (18, 4)  NOT NULL,
    [cost]                   DECIMAL (18, 2)  NOT NULL,
    [price]                  DECIMAL (18, 2)  NULL,
    [selected]               BIT              NULL,
    [notes]                  VARCHAR (MAX)    NOT NULL,
    [option_pricing_display] BIT              NOT NULL,
    [mutually_exclusive]     BIT              NOT NULL,
    [gpc]                    VARCHAR (MAX)    NULL,
    [model]                  VARCHAR (100)    NOT NULL,
    [elevation]              VARCHAR (50)     NOT NULL,
    [option_id]              VARCHAR (100)    NULL,
    [stage]                  VARCHAR (100)    NULL,
    [author]                 VARCHAR (50)     NOT NULL,
    [create_date]            DATETIME         NOT NULL,
    [modifier]               VARCHAR (50)     NOT NULL,
    [modified_date]          DATETIME         NOT NULL,
    [stamp]                  ROWVERSION       NOT NULL,
    [is_package]             BIT              NOT NULL,
    CONSTRAINT [PK_catalog_items] PRIMARY KEY CLUSTERED ([row_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[catalog_items].[IX_catalog_items_accountid_organizationid_optionid]...';


GO
CREATE NONCLUSTERED INDEX [IX_catalog_items_accountid_organizationid_optionid]
    ON [dbo].[catalog_items]([account_id] ASC, [organization_id] ASC, [option_id] ASC);


GO
PRINT N'Creating Index [dbo].[catalog_items].[IX_catalog_items_acct_org_comm_series_plan]...';


GO
CREATE NONCLUSTERED INDEX [IX_catalog_items_acct_org_comm_series_plan]
    ON [dbo].[catalog_items]([account_id] ASC, [organization_id] ASC, [community] ASC, [series] ASC, [plan] ASC);


GO
PRINT N'Creating Table [dbo].[catalog_prices_published]...';


GO
CREATE TABLE [dbo].[catalog_prices_published] (
    [id]                     INT              IDENTITY (1, 1) NOT NULL,
    [session_id]             UNIQUEIDENTIFIER NOT NULL,
    [spec_id]                INT              NOT NULL,
    [effective_date]         DATETIME         NOT NULL,
    [published]              DATE             NOT NULL,
    [table_name]             VARCHAR (50)     NOT NULL,
    [customer_id]            VARCHAR (10)     NOT NULL,
    [region_id]              VARCHAR (2)      NOT NULL,
    [custclas]               VARCHAR (25)     NOT NULL,
    [application_id]         VARCHAR (10)     NOT NULL,
    [product_id]             VARCHAR (10)     NOT NULL,
    [area_id]                VARCHAR (10)     NOT NULL,
    [sub_area_id]            VARCHAR (10)     NOT NULL,
    [plan_id]                VARCHAR (20)     NOT NULL,
    [build_id]               VARCHAR (50)     NOT NULL,
    [item_type]              VARCHAR (10)     NOT NULL,
    [item]                   VARCHAR (81)     NOT NULL,
    [price_type]             VARCHAR (10)     NOT NULL,
    [price]                  DECIMAL (18, 2)  NOT NULL,
    [uom]                    VARCHAR (9)      NOT NULL,
    [retail_percentage_type] VARCHAR (20)     NOT NULL,
    [retail_percentage]      DECIMAL (18, 4)  NULL,
    [retail_unit_price]      DECIMAL (18, 4)  NULL,
    [author]                 VARCHAR (50)     NOT NULL,
    [create_date]            DATETIME         NOT NULL,
    [modifier]               VARCHAR (50)     NOT NULL,
    [modified_date]          DATETIME         NOT NULL,
    [stamp]                  ROWVERSION       NOT NULL,
    CONSTRAINT [PK_prices_published] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Table [dbo].[catalog_prices_published_groups_detail]...';


GO
CREATE TABLE [dbo].[catalog_prices_published_groups_detail] (
    [id]             INT              IDENTITY (1, 1) NOT NULL,
    [session_id]     UNIQUEIDENTIFIER NOT NULL,
    [published]      DATE             NOT NULL,
    [group_id]       INT              NOT NULL,
    [customer_id]    VARCHAR (15)     NOT NULL,
    [effective_date] DATETIME         NOT NULL,
    [item_type]      VARCHAR (10)     NOT NULL,
    [item]           VARCHAR (81)     NOT NULL,
    [end_date]       DATETIME         NULL,
    [author]         VARCHAR (50)     NOT NULL,
    [create_date]    DATETIME         NOT NULL,
    [modifier]       VARCHAR (50)     NOT NULL,
    [modified_date]  DATETIME         NOT NULL,
    [stamp]          ROWVERSION       NOT NULL,
    CONSTRAINT [PK_catalog_prices_published_groups_detail] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Table [dbo].[catalog_selections]...';


GO
CREATE TABLE [dbo].[catalog_selections] (
    [session_id]             UNIQUEIDENTIFIER NOT NULL,
    [row_id]                 UNIQUEIDENTIFIER NOT NULL,
    [account_id]             UNIQUEIDENTIFIER NULL,
    [organization_id]        UNIQUEIDENTIFIER NOT NULL,
    [community]              VARCHAR (100)    NOT NULL,
    [series]                 VARCHAR (100)    NOT NULL,
    [plan]                   VARCHAR (100)    NOT NULL,
    [application]            VARCHAR (100)    NOT NULL,
    [product]                VARCHAR (100)    NOT NULL,
    [area]                   VARCHAR (100)    NOT NULL,
    [area_id]                VARCHAR (20)     NOT NULL,
    [sub_area]               VARCHAR (100)    NOT NULL,
    [sub_area_id]            VARCHAR (20)     NOT NULL,
    [item_type]              VARCHAR (50)     NOT NULL,
    [item_no]                VARCHAR (100)    NOT NULL,
    [item]                   VARCHAR (MAX)    NOT NULL,
    [vendor]                 VARCHAR (100)    NOT NULL,
    [standard]               VARCHAR (200)    NOT NULL,
    [qty]                    DECIMAL (18, 4)  NOT NULL,
    [cost]                   DECIMAL (18, 2)  NOT NULL,
    [price]                  DECIMAL (18, 2)  NULL,
    [selected]               BIT              NULL,
    [notes]                  VARCHAR (MAX)    NOT NULL,
    [option_pricing_display] BIT              NOT NULL,
    [mutually_exclusive]     BIT              NOT NULL,
    [build_data]             VARBINARY (MAX)  NULL,
    [original_build_data]    VARBINARY (MAX)  NULL,
    [source]                 VARCHAR (20)     NOT NULL,
    [build_id]               INT              NOT NULL,
    [gpc]                    VARCHAR (MAX)    NULL,
    [model]                  VARCHAR (100)    NOT NULL,
    [make_std]               BIT              NOT NULL,
    [is_credit]              BIT              NOT NULL,
    [option_id]              VARCHAR (100)    NULL,
    [stage]                  VARCHAR (100)    NULL,
    [author]                 VARCHAR (50)     NOT NULL,
    [create_date]            DATETIME         NOT NULL,
    [modifier]               VARCHAR (50)     NOT NULL,
    [modified_date]          DATETIME         NOT NULL,
    [stamp]                  ROWVERSION       NOT NULL,
    [is_package]             BIT              NOT NULL,
    CONSTRAINT [PK_catalog_selection] PRIMARY KEY CLUSTERED ([session_id] ASC, [row_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[catalog_selections].[session_id_selected]...';


GO
CREATE NONCLUSTERED INDEX [session_id_selected]
    ON [dbo].[catalog_selections]([session_id] ASC, [selected] ASC);


GO
PRINT N'Creating Table [dbo].[catalog_selections_area_bom_modifications]...';


GO
CREATE TABLE [dbo].[catalog_selections_area_bom_modifications] (
    [session_id]                  UNIQUEIDENTIFIER NOT NULL,
    [build_id]                    BIGINT           NOT NULL,
    [session_bom_modification_id] UNIQUEIDENTIFIER NOT NULL,
    [quantity]                    DECIMAL (18, 4)  NOT NULL,
    [price]                       DECIMAL (18, 2)  NOT NULL,
    [notes]                       VARCHAR (MAX)    NULL,
    [author]                      VARCHAR (50)     NOT NULL,
    [create_date]                 DATETIME         NOT NULL,
    [modifier]                    VARCHAR (50)     NOT NULL,
    [modified_date]               DATETIME         NOT NULL,
    [stamp]                       ROWVERSION       NOT NULL,
    CONSTRAINT [PK_catalog_selections_area_bom_modifications_1] PRIMARY KEY CLUSTERED ([session_id] ASC, [build_id] ASC, [session_bom_modification_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[catalog_selections_area_detail_options]...';


GO
CREATE TABLE [dbo].[catalog_selections_area_detail_options] (
    [session_id]             UNIQUEIDENTIFIER NOT NULL,
    [application]            VARCHAR (100)    NOT NULL,
    [product]                VARCHAR (100)    NOT NULL,
    [area]                   VARCHAR (100)    NOT NULL,
    [sub_area]               VARCHAR (100)    NOT NULL,
    [item_type]              VARCHAR (20)     NOT NULL,
    [item_id]                VARCHAR (50)     NOT NULL,
    [option_id]              VARCHAR (50)     NOT NULL,
    [option_value]           VARCHAR (50)     NOT NULL,
    [option_source]          VARCHAR (50)     NOT NULL,
    [included]               BIT              NOT NULL,
    [qty]                    INT              NULL,
    [price]                  DECIMAL (18, 2)  NULL,
    [price_retail]           DECIMAL (18, 2)  NULL,
    [retail_percentage]      DECIMAL (18, 2)  NULL,
    [retail_percentage_type] VARCHAR (10)     NULL,
    [price_type]             VARCHAR (10)     NULL,
    [pricing_source]         VARCHAR (50)     NULL,
    [error_message]          VARCHAR (MAX)    NULL,
    [author]                 VARCHAR (50)     NOT NULL,
    [create_date]            DATETIME         NOT NULL,
    [modifier]               VARCHAR (50)     NOT NULL,
    [modified_date]          DATETIME         NOT NULL,
    [stamp]                  ROWVERSION       NOT NULL,
    [alloc_qty]              INT              NULL,
    CONSTRAINT [PK_catalog_selections_area_detail_options] PRIMARY KEY CLUSTERED ([session_id] ASC, [application] ASC, [product] ASC, [area] ASC, [sub_area] ASC, [item_type] ASC, [item_id] ASC, [option_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[catalog_selections_area_details]...';


GO
CREATE TABLE [dbo].[catalog_selections_area_details] (
    [session_id]             UNIQUEIDENTIFIER NOT NULL,
    [application]            VARCHAR (100)    NOT NULL,
    [product]                VARCHAR (100)    NOT NULL,
    [area]                   VARCHAR (100)    NOT NULL,
    [sub_area]               VARCHAR (100)    NOT NULL,
    [item_type]              VARCHAR (20)     NOT NULL,
    [item_id]                VARCHAR (50)     NOT NULL,
    [selectable]             BIT              NOT NULL,
    [bom_real_item_id]       VARCHAR (50)     NOT NULL,
    [real_item_id]           VARCHAR (50)     NOT NULL,
    [bom_bill_qty]           DECIMAL (18, 4)  NOT NULL,
    [bill_qty]               DECIMAL (18, 4)  NOT NULL,
    [alloc_qty]              DECIMAL (18, 4)  NOT NULL,
    [credit_qty]             DECIMAL (18, 4)  NOT NULL,
    [bom_uom_id]             VARCHAR (9)      NOT NULL,
    [uom_id]                 VARCHAR (9)      NOT NULL,
    [builder_price]          DECIMAL (18, 2)  NOT NULL,
    [homeowner_price]        DECIMAL (18, 2)  NOT NULL,
    [pattern_id]             INT              NOT NULL,
    [is_pattern_item]        BIT              NOT NULL,
    [pattern_percentage]     DECIMAL (18, 4)  NOT NULL,
    [force_reprice]          BIT              NOT NULL,
    [price_type]             VARCHAR (25)     NOT NULL,
    [price_source]           VARCHAR (25)     NOT NULL,
    [retail_percentage]      DECIMAL (18, 4)  NOT NULL,
    [retail_percentage_type] VARCHAR (10)     NOT NULL,
    [accent_prompt]          VARCHAR (20)     NOT NULL,
    [priced]                 BIT              NOT NULL,
    [bom_item_id]            VARCHAR (50)     NOT NULL,
    [author]                 VARCHAR (50)     NOT NULL,
    [create_date]            DATETIME         NOT NULL,
    [modifier]               VARCHAR (50)     NOT NULL,
    [modified_date]          DATETIME         NOT NULL,
    [stamp]                  ROWVERSION       NOT NULL,
    CONSTRAINT [PK_catalog_selections_area_details] PRIMARY KEY CLUSTERED ([session_id] ASC, [application] ASC, [product] ASC, [area] ASC, [sub_area] ASC, [item_type] ASC, [item_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[catalog_selections_area_details].[IX_catalog_selections_area_details]...';


GO
CREATE NONCLUSTERED INDEX [IX_catalog_selections_area_details]
    ON [dbo].[catalog_selections_area_details]([create_date] ASC);


GO
PRINT N'Creating Table [dbo].[catalog_selections_area_details_change_log]...';


GO
CREATE TABLE [dbo].[catalog_selections_area_details_change_log] (
    [session_id]        UNIQUEIDENTIFIER NOT NULL,
    [modification_date] DATETIME         NOT NULL,
    CONSTRAINT [PK_catalog_selections_area_details_change_log] PRIMARY KEY CLUSTERED ([session_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[catalog_selections_area_details_change_log].[IX_catalog_selections_area_details_change_log_modification_date]...';


GO
CREATE NONCLUSTERED INDEX [IX_catalog_selections_area_details_change_log_modification_date]
    ON [dbo].[catalog_selections_area_details_change_log]([modification_date] ASC);


GO
PRINT N'Creating Table [dbo].[catalog_selections_area_details_lay_directions]...';


GO
CREATE TABLE [dbo].[catalog_selections_area_details_lay_directions] (
    [session_id]    UNIQUEIDENTIFIER NOT NULL,
    [application]   VARCHAR (100)    NOT NULL,
    [product]       VARCHAR (100)    NOT NULL,
    [area]          VARCHAR (100)    NOT NULL,
    [sub_area]      VARCHAR (100)    NOT NULL,
    [item_type]     VARCHAR (20)     NOT NULL,
    [item_id]       VARCHAR (50)     NOT NULL,
    [rotate_degree] INT              NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_catalog_selections_area_details_lay_directions] PRIMARY KEY CLUSTERED ([session_id] ASC, [application] ASC, [product] ASC, [area] ASC, [sub_area] ASC, [item_type] ASC, [item_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[catalog_selections_area_properties]...';


GO
CREATE TABLE [dbo].[catalog_selections_area_properties] (
    [id]            UNIQUEIDENTIFIER NOT NULL,
    [session_id]    UNIQUEIDENTIFIER NOT NULL,
    [build_id]      INT              NOT NULL,
    [key]           VARCHAR (50)     NOT NULL,
    [value]         VARCHAR (MAX)    NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_catalog_selections_area_properties] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Index [dbo].[catalog_selections_area_properties].[IX_catalog_selections_area_properties_UNIQUE]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_catalog_selections_area_properties_UNIQUE]
    ON [dbo].[catalog_selections_area_properties]([session_id] ASC, [build_id] ASC, [key] ASC);


GO
PRINT N'Creating Table [dbo].[catalog_selections_area_slabs]...';


GO
CREATE TABLE [dbo].[catalog_selections_area_slabs] (
    [row_id]        UNIQUEIDENTIFIER NOT NULL,
    [session_id]    UNIQUEIDENTIFIER NOT NULL,
    [build_id]      INT              NOT NULL,
    [slab_id]       VARCHAR (100)    NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         TIMESTAMP        NOT NULL,
    CONSTRAINT [PK_catalog_selections_area_slabs] PRIMARY KEY CLUSTERED ([row_id] ASC) ON [PRIMARY]
) ON [PRIMARY];


GO
PRINT N'Creating Index [dbo].[catalog_selections_area_slabs].[IX_session_build_slab]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_session_build_slab]
    ON [dbo].[catalog_selections_area_slabs]([session_id] ASC, [build_id] ASC, [slab_id] ASC)
    ON [PRIMARY];


GO
PRINT N'Creating Table [dbo].[catalog_selections_areas]...';


GO
CREATE TABLE [dbo].[catalog_selections_areas] (
    [session_id]           UNIQUEIDENTIFIER NOT NULL,
    [application]          VARCHAR (100)    NOT NULL,
    [product]              VARCHAR (100)    NOT NULL,
    [area]                 VARCHAR (100)    NOT NULL,
    [sub_area]             VARCHAR (100)    NOT NULL,
    [area_id]              VARCHAR (25)     NOT NULL,
    [sub_area_id]          VARCHAR (25)     NOT NULL,
    [selected]             INT              NOT NULL,
    [notes]                VARCHAR (MAX)    NOT NULL,
    [original_build_data]  VARBINARY (MAX)  NULL,
    [selection_total]      DECIMAL (18, 2)  NOT NULL,
    [selected_field_group] UNIQUEIDENTIFIER NULL,
    [pattern_id]           INT              NOT NULL,
    [area_selected]        BIT              NOT NULL,
    [build_id]             INT              NOT NULL,
    [author]               VARCHAR (50)     NOT NULL,
    [create_date]          DATETIME         NOT NULL,
    [modifier]             VARCHAR (50)     NOT NULL,
    [modified_date]        DATETIME         NOT NULL,
    [stamp]                ROWVERSION       NOT NULL,
    [location_id]          INT              NULL,
    [location]             VARCHAR (50)     NULL,
    CONSTRAINT [PK_catalog_selection_areas] PRIMARY KEY CLUSTERED ([session_id] ASC, [application] ASC, [product] ASC, [area] ASC, [sub_area] ASC)
);


GO
PRINT N'Creating Index [dbo].[catalog_selections_areas].[IX_build_id]...';


GO
CREATE NONCLUSTERED INDEX [IX_build_id]
    ON [dbo].[catalog_selections_areas]([build_id] ASC);


GO
PRINT N'Creating Index [dbo].[catalog_selections_areas].[IX_catalog_selections_areas_session_build]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_catalog_selections_areas_session_build]
    ON [dbo].[catalog_selections_areas]([session_id] ASC, [build_id] ASC);


GO
PRINT N'Creating Table [dbo].[catalog_selections_bom_modifications]...';


GO
CREATE TABLE [dbo].[catalog_selections_bom_modifications] (
    [id]                     UNIQUEIDENTIFIER NOT NULL,
    [session_id]             UNIQUEIDENTIFIER NOT NULL,
    [application_id]         VARCHAR (10)     NULL,
    [product_id]             VARCHAR (10)     NULL,
    [area_id]                VARCHAR (10)     NULL,
    [sub_area_id]            VARCHAR (10)     NULL,
    [item_code]              VARCHAR (100)    NULL,
    [item]                   VARCHAR (MAX)    NOT NULL,
    [vendor]                 VARCHAR (100)    NULL,
    [modification_type]      INT              NOT NULL,
    [quantity]               DECIMAL (18, 4)  NOT NULL,
    [price]                  DECIMAL (18, 2)  NOT NULL,
    [cost]                   DECIMAL (18, 2)  NULL,
    [notes]                  VARCHAR (MAX)    NULL,
    [gpc]                    UNIQUEIDENTIFIER NULL,
    [option_pricing_display] BIT              NOT NULL,
    [author]                 VARCHAR (50)     NOT NULL,
    [create_date]            DATETIME         NOT NULL,
    [modifier]               VARCHAR (50)     NOT NULL,
    [modified_date]          DATETIME         NOT NULL,
    [stamp]                  ROWVERSION       NOT NULL,
    CONSTRAINT [PK_catalog_selections_bom_modifications] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Table [dbo].[catalog_selections_designer_images]...';


GO
CREATE TABLE [dbo].[catalog_selections_designer_images] (
    [session_id]    UNIQUEIDENTIFIER NOT NULL,
    [row_id]        UNIQUEIDENTIFIER NOT NULL,
    [file_name]     VARCHAR (255)    NOT NULL,
    [mime_type]     VARCHAR (255)    NOT NULL,
    [image_data]    VARBINARY (MAX)  NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_catalog_selections_images] PRIMARY KEY CLUSTERED ([row_id] ASC, [session_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[catalog_selections_error_log]...';


GO
CREATE TABLE [dbo].[catalog_selections_error_log] (
    [session_id]     UNIQUEIDENTIFIER NOT NULL,
    [auto_number]    INT              IDENTITY (1, 1) NOT NULL,
    [error_date]     DATETIME         NOT NULL,
    [application]    VARCHAR (100)    NULL,
    [product]        VARCHAR (100)    NULL,
    [area]           VARCHAR (100)    NULL,
    [sub_area]       VARCHAR (100)    NULL,
    [item_type]      VARCHAR (20)     NULL,
    [item_id]        VARCHAR (50)     NULL,
    [real_item_id]   VARCHAR (50)     NULL,
    [real_item_name] VARCHAR (100)    NULL,
    [uom_id]         VARCHAR (20)     NULL,
    [review_date]    DATETIME         NULL,
    [error]          VARCHAR (MAX)    NULL,
    [source]         VARCHAR (MAX)    NULL,
    CONSTRAINT [PK_catalog_selections_error_log] PRIMARY KEY CLUSTERED ([session_id] ASC, [auto_number] ASC)
);


GO
PRINT N'Creating Index [dbo].[catalog_selections_error_log].[IX_catalog_selections_error_log_review_date]...';


GO
CREATE NONCLUSTERED INDEX [IX_catalog_selections_error_log_review_date]
    ON [dbo].[catalog_selections_error_log]([review_date] ASC);


GO
PRINT N'Creating Table [dbo].[catalog_selections_group_detail]...';


GO
CREATE TABLE [dbo].[catalog_selections_group_detail] (
    [session_id]    UNIQUEIDENTIFIER NOT NULL,
    [group_id]      INT              NOT NULL,
    [item_type]     VARCHAR (10)     NOT NULL,
    [item]          VARCHAR (81)     NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    [area_id]       VARCHAR (10)     NULL,
    [sub_area_id]   VARCHAR (10)     NULL,
    CONSTRAINT [PK_catalog_selections_group_detail] PRIMARY KEY CLUSTERED ([session_id] ASC, [group_id] ASC, [item_type] ASC, [item] ASC)
);


GO
PRINT N'Creating Table [dbo].[catalog_selections_price_level_boms]...';


GO
CREATE TABLE [dbo].[catalog_selections_price_level_boms] (
    [session_id]                UNIQUEIDENTIFIER NOT NULL,
    [catalog_selections_row_id] UNIQUEIDENTIFIER NOT NULL,
    [serialized_bom_data]       VARBINARY (MAX)  NOT NULL,
    [author]                    VARCHAR (50)     NOT NULL,
    [create_date]               DATETIME         NOT NULL,
    [modifier]                  VARCHAR (50)     NOT NULL,
    [modified_date]             DATETIME         NOT NULL,
    [stamp]                     ROWVERSION       NOT NULL,
    CONSTRAINT [PK_catalog_selections_price_level_boms] PRIMARY KEY CLUSTERED ([session_id] ASC, [catalog_selections_row_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[catalog_selections_price_overrides]...';


GO
CREATE TABLE [dbo].[catalog_selections_price_overrides] (
    [session_id] UNIQUEIDENTIFIER NOT NULL,
    [row_id]     UNIQUEIDENTIFIER NOT NULL,
    [orig_price] DECIMAL (18, 2)  NULL,
    CONSTRAINT [PK_catalog_selections_price_overrides] PRIMARY KEY CLUSTERED ([session_id] ASC, [row_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[commission_rates]...';


GO
CREATE TABLE [dbo].[commission_rates] (
    [designer]      UNIQUEIDENTIFIER NOT NULL,
    [start_date]    DATE             NOT NULL,
    [rate]          DECIMAL (18, 4)  NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_commission_rates] PRIMARY KEY CLUSTERED ([designer] ASC, [start_date] ASC)
);


GO
PRINT N'Creating Table [dbo].[default_support_emails]...';


GO
CREATE TABLE [dbo].[default_support_emails] (
    [email_key]     VARCHAR (50)  NOT NULL,
    [email]         VARCHAR (200) NOT NULL,
    [author]        VARCHAR (50)  NOT NULL,
    [create_date]   DATETIME      NOT NULL,
    [modifier]      VARCHAR (50)  NOT NULL,
    [modified_date] DATETIME      NOT NULL,
    [stamp]         ROWVERSION    NOT NULL,
    CONSTRAINT [PK_default_support_emails] PRIMARY KEY CLUSTERED ([email_key] ASC)
);


GO
PRINT N'Creating Table [dbo].[designer_assigned_applications]...';


GO
CREATE TABLE [dbo].[designer_assigned_applications] (
    [id]            INT              IDENTITY (1, 1) NOT NULL,
    [user_id]       UNIQUEIDENTIFIER NOT NULL,
    [application]   VARCHAR (100)    NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_designer_assigned_applications] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Index [dbo].[designer_assigned_applications].[IX_designer_assigned_applications_user_id_application]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_designer_assigned_applications_user_id_application]
    ON [dbo].[designer_assigned_applications]([user_id] ASC, [application] ASC);


GO
PRINT N'Creating Table [dbo].[email_events]...';


GO
CREATE TABLE [dbo].[email_events] (
    [id]         UNIQUEIDENTIFIER NOT NULL,
    [email]      VARCHAR (MAX)    NULL,
    [timestamp]  INT              NULL,
    [event]      VARCHAR (50)     NULL,
    [smtp_id]    VARCHAR (50)     NULL,
    [useragent]  VARCHAR (MAX)    NULL,
    [ip]         CHAR (15)        NULL,
    [event_id]   VARCHAR (MAX)    NULL,
    [message_id] VARCHAR (MAX)    NULL,
    [reason]     VARCHAR (MAX)    NULL,
    [status]     CHAR (5)         NULL,
    [response]   VARCHAR (MAX)    NULL,
    [url]        VARCHAR (MAX)    NULL,
    [category]   VARCHAR (MAX)    NULL,
    [attempt]    INT              NULL,
    [type]       VARCHAR (50)     NULL,
    CONSTRAINT [PK_email_events] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Table [dbo].[event_log]...';


GO
CREATE TABLE [dbo].[event_log] (
    [event_log_id]         UNIQUEIDENTIFIER NOT NULL,
    [user_id]              UNIQUEIDENTIFIER NULL,
    [event_log_date]       DATETIME         NULL,
    [category]             NVARCHAR (50)    NULL,
    [action]               NVARCHAR (50)    NULL,
    [data_serializer_type] NVARCHAR (50)    NULL,
    [data]                 NVARCHAR (MAX)   NULL,
    [organization_id]      UNIQUEIDENTIFIER NULL,
    CONSTRAINT [PK_log] PRIMARY KEY CLUSTERED ([event_log_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[features]...';


GO
CREATE TABLE [dbo].[features] (
    [id]            INT            NOT NULL,
    [lookup_key]    VARCHAR (50)   NOT NULL,
    [description]   VARCHAR (3000) NOT NULL,
    [author]        VARCHAR (50)   NOT NULL,
    [create_date]   DATETIME       NOT NULL,
    [modifier]      VARCHAR (50)   NOT NULL,
    [modified_date] DATETIME       NOT NULL,
    [stamp]         ROWVERSION     NOT NULL,
    [name]          VARCHAR (200)  NOT NULL,
    [group_name]    VARCHAR (50)   NULL,
    CONSTRAINT [PK_features] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Table [dbo].[floorplans]...';


GO
CREATE TABLE [dbo].[floorplans] (
    [id]               UNIQUEIDENTIFIER NOT NULL,
    [name]             VARCHAR (100)    NOT NULL,
    [background_image] VARBINARY (MAX)  NOT NULL,
    [report_image]     VARBINARY (MAX)  NULL,
    [serialized_data]  VARCHAR (MAX)    NULL,
    [account_id]       UNIQUEIDENTIFIER NOT NULL,
    [organization_id]  UNIQUEIDENTIFIER NOT NULL,
    [user_id]          UNIQUEIDENTIFIER NOT NULL,
    [community]        VARCHAR (50)     NOT NULL,
    [series]           VARCHAR (50)     NOT NULL,
    [plan]             VARCHAR (50)     NOT NULL,
    [author]           VARCHAR (50)     NOT NULL,
    [create_date]      DATETIME         NOT NULL,
    [modifier]         VARCHAR (50)     NOT NULL,
    [modified_date]    DATETIME         NOT NULL,
    [stamp]            ROWVERSION       NOT NULL,
    CONSTRAINT [PK_floorplans] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Index [dbo].[floorplans].[IX_floorplans_account_organization_user_community_series_plan]...';


GO
CREATE NONCLUSTERED INDEX [IX_floorplans_account_organization_user_community_series_plan]
    ON [dbo].[floorplans]([account_id] ASC, [organization_id] ASC, [user_id] ASC, [community] ASC, [series] ASC, [plan] ASC);


GO
PRINT N'Creating Table [dbo].[floorplans_sequence]...';


GO
CREATE TABLE [dbo].[floorplans_sequence] (
    [profile_plan_id] UNIQUEIDENTIFIER NOT NULL,
    [sequence]        NVARCHAR (MAX)   NULL,
    [author]          VARCHAR (50)     NOT NULL,
    [create_date]     DATETIME         NOT NULL,
    [modifier]        VARCHAR (50)     NOT NULL,
    [modified_date]   DATETIME         NOT NULL,
    [stamp]           ROWVERSION       NOT NULL,
    CONSTRAINT [PK_floorplans_sequence] PRIMARY KEY CLUSTERED ([profile_plan_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[homebuyer_catalog_estimated_selections]...';


GO
CREATE TABLE [dbo].[homebuyer_catalog_estimated_selections] (
    [id]                 BIGINT           IDENTITY (1, 1) NOT NULL,
    [session_id]         UNIQUEIDENTIFIER NOT NULL,
    [application_id]     VARCHAR (10)     NOT NULL,
    [product_id]         VARCHAR (5)      NOT NULL,
    [area_id]            VARCHAR (25)     NOT NULL,
    [sub_area_id]        VARCHAR (25)     NOT NULL,
    [build_id]           INT              NOT NULL,
    [price_level_type]   VARCHAR (50)     NOT NULL,
    [price_level_id]     VARCHAR (100)    NOT NULL,
    [selected_option_id] VARCHAR (50)     NOT NULL,
    [author]             VARCHAR (50)     NOT NULL,
    [create_date]        DATETIME         NOT NULL,
    [modifier]           VARCHAR (50)     NOT NULL,
    [modified_date]      DATETIME         NOT NULL,
    [stamp]              ROWVERSION       NOT NULL,
    CONSTRAINT [PK_homebuyer_catalog_estimated_selections] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Index [dbo].[homebuyer_catalog_estimated_selections].[IX_homebuyer_catalog_estimated_selections_session_id]...';


GO
CREATE NONCLUSTERED INDEX [IX_homebuyer_catalog_estimated_selections_session_id]
    ON [dbo].[homebuyer_catalog_estimated_selections]([session_id] ASC);


GO
PRINT N'Creating Table [dbo].[homebuyer_catalog_nonestimated_selections]...';


GO
CREATE TABLE [dbo].[homebuyer_catalog_nonestimated_selections] (
    [id]            BIGINT           IDENTITY (1, 1) NOT NULL,
    [session_id]    UNIQUEIDENTIFIER NOT NULL,
    [row_id]        UNIQUEIDENTIFIER NOT NULL,
    [quantity]      INT              NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_homebuyer_catalog_nonestimated_selections] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Index [dbo].[homebuyer_catalog_nonestimated_selections].[IX_homebuyer_catalog_nonestimated_selections_session_id]...';


GO
CREATE NONCLUSTERED INDEX [IX_homebuyer_catalog_nonestimated_selections_session_id]
    ON [dbo].[homebuyer_catalog_nonestimated_selections]([session_id] ASC);


GO
PRINT N'Creating Index [dbo].[homebuyer_catalog_nonestimated_selections].[UX_homebuyer_catalog_nonestimated_selections_session_id_row_id]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [UX_homebuyer_catalog_nonestimated_selections_session_id_row_id]
    ON [dbo].[homebuyer_catalog_nonestimated_selections]([session_id] ASC, [row_id] ASC);


GO
PRINT N'Creating Table [dbo].[homebuyer_catalog_price_level_filters]...';


GO
CREATE TABLE [dbo].[homebuyer_catalog_price_level_filters] (
    [id]             UNIQUEIDENTIFIER NOT NULL,
    [session_id]     UNIQUEIDENTIFIER NOT NULL,
    [room_id]        UNIQUEIDENTIFIER NOT NULL,
    [application_id] VARCHAR (10)     NOT NULL,
    [product_id]     VARCHAR (5)      NOT NULL,
    [item_no]        VARCHAR (50)     NOT NULL,
    [author]         VARCHAR (50)     NOT NULL,
    [create_date]    DATETIME         NOT NULL,
    [modifier]       VARCHAR (50)     NOT NULL,
    [modified_date]  DATETIME         NOT NULL,
    [stamp]          ROWVERSION       NOT NULL,
    CONSTRAINT [PK_homebuyer_catalog_price_level_filters] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Table [dbo].[homebuyer_orientation]...';


GO
CREATE TABLE [dbo].[homebuyer_orientation] (
    [row_id]         UNIQUEIDENTIFIER NOT NULL,
    [user_id]        UNIQUEIDENTIFIER NOT NULL,
    [object_type]    NVARCHAR (100)   NOT NULL,
    [schema_version] NVARCHAR (10)    NOT NULL,
    [object_data]    NVARCHAR (MAX)   NOT NULL,
    [author]         VARCHAR (50)     NOT NULL,
    [create_date]    DATETIME         NOT NULL,
    [modifier]       VARCHAR (50)     NOT NULL,
    [modified_date]  DATETIME         NOT NULL,
    [stamp]          ROWVERSION       NOT NULL,
    CONSTRAINT [PK_homebuyer_orientation] PRIMARY KEY CLUSTERED ([row_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[homebuyer_orientation].[NonClusteredIndex_homebuyer_orientation]...';


GO
CREATE NONCLUSTERED INDEX [NonClusteredIndex_homebuyer_orientation]
    ON [dbo].[homebuyer_orientation]([user_id] ASC, [object_type] ASC)
    INCLUDE([row_id]);


GO
PRINT N'Creating Table [dbo].[icon]...';


GO
CREATE TABLE [dbo].[icon] (
    [id]            UNIQUEIDENTIFIER NOT NULL,
    [name]          NVARCHAR (50)    NOT NULL,
    [image]         VARBINARY (MAX)  NOT NULL,
    [mime_type]     VARCHAR (255)    NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_icon] PRIMARY KEY CLUSTERED ([id] ASC),
    CONSTRAINT [UQ_icon_name] UNIQUE NONCLUSTERED ([name] ASC)
);


GO
PRINT N'Creating Table [dbo].[icon_tags]...';


GO
CREATE TABLE [dbo].[icon_tags] (
    [icon_id]       UNIQUEIDENTIFIER NOT NULL,
    [tag]           NVARCHAR (25)    NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_icon_tags] PRIMARY KEY CLUSTERED ([icon_id] ASC, [tag] ASC)
);


GO
PRINT N'Creating Table [dbo].[invoice_lines]...';


GO
CREATE TABLE [dbo].[invoice_lines] (
    [invoice_id]       INT             NOT NULL,
    [line_no]          INT             NOT NULL,
    [application]      VARCHAR (50)    NOT NULL,
    [product]          VARCHAR (50)    NOT NULL,
    [area]             VARCHAR (255)   NOT NULL,
    [item]             VARCHAR (255)   NOT NULL,
    [vendor]           VARCHAR (50)    NOT NULL,
    [line_amount]      DECIMAL (18, 2) NOT NULL,
    [orig_line_amount] DECIMAL (18, 2) NOT NULL,
    [invoice]          BIT             NOT NULL,
    [invoice_amount]   DECIMAL (18, 2) NOT NULL,
    [notes]            VARCHAR (MAX)   NOT NULL,
    [author]           VARCHAR (50)    NULL,
    [create_date]      DATETIME        NULL,
    [modifier]         VARCHAR (50)    NULL,
    [modified_date]    DATETIME        NULL,
    [stamp]            ROWVERSION      NULL,
    CONSTRAINT [PK_catalog_selections_invoice_lines_1] PRIMARY KEY CLUSTERED ([invoice_id] ASC, [line_no] ASC)
);


GO
PRINT N'Creating Table [dbo].[invoices]...';


GO
CREATE TABLE [dbo].[invoices] (
    [invoice_id]                 INT              IDENTITY (1, 1) NOT NULL,
    [reference_id]               UNIQUEIDENTIFIER NOT NULL,
    [reference_type]             VARCHAR (50)     NOT NULL,
    [invoice_no]                 VARCHAR (100)    NULL,
    [invoice_date]               DATETIME         NULL,
    [invoice_template]           VARCHAR (50)     NULL,
    [invoice_customer_id]        VARCHAR (50)     NULL,
    [invoice_customer_desc]      VARCHAR (100)    NULL,
    [invoice_po]                 VARCHAR (100)    NULL,
    [invoice_status]             VARCHAR (10)     NULL,
    [invoice_ratio]              DECIMAL (18, 4)  NULL,
    [amount]                     DECIMAL (18, 2)  NULL,
    [external_invoice_reference] VARCHAR (50)     NULL,
    [last_print_date]            DATETIME         NULL,
    [invoice_module]             VARCHAR (20)     NULL,
    [invoice_module_data]        VARCHAR (300)    NULL,
    [invoice_notes]              VARCHAR (MAX)    NULL,
    [author]                     VARCHAR (50)     NOT NULL,
    [create_date]                DATETIME         NOT NULL,
    [modifier]                   VARCHAR (50)     NOT NULL,
    [modified_date]              DATETIME         NOT NULL,
    [stamp]                      ROWVERSION       NOT NULL,
    CONSTRAINT [PK_catalog_selections_invoices_1] PRIMARY KEY CLUSTERED ([invoice_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[invoices].[IX_invoices_invoice_date]...';


GO
CREATE NONCLUSTERED INDEX [IX_invoices_invoice_date]
    ON [dbo].[invoices]([invoice_date] ASC);


GO
PRINT N'Creating Table [dbo].[jobs_stages]...';


GO
CREATE TABLE [dbo].[jobs_stages] (
    [id]                         UNIQUEIDENTIFIER NOT NULL,
    [account_org_id]             UNIQUEIDENTIFIER NOT NULL,
    [job_no]                     VARCHAR (20)     NOT NULL,
    [stage_id]                   VARCHAR (10)     NULL,
    [stage_name]                 VARCHAR (100)    NOT NULL,
    [stage_date]                 DATETIME         NOT NULL,
    [stage_date_override]        DATETIME         NULL,
    [stage_date_override_author] VARCHAR (50)     NULL,
    [author]                     VARCHAR (50)     NOT NULL,
    [create_date]                DATETIME         NOT NULL,
    [modifier]                   VARCHAR (50)     NOT NULL,
    [modified_date]              DATETIME         NOT NULL,
    [stamp]                      ROWVERSION       NOT NULL,
    CONSTRAINT [PK_jobs_stages] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Table [dbo].[plan_budget]...';


GO
CREATE TABLE [dbo].[plan_budget] (
    [id]                       UNIQUEIDENTIFIER NOT NULL,
    [user_id]                  UNIQUEIDENTIFIER NOT NULL,
    [plan_id]                  UNIQUEIDENTIFIER NOT NULL,
    [upgrade_budget]           DECIMAL (18, 2)  NOT NULL,
    [monthly_payment_home]     DECIMAL (18, 2)  NOT NULL,
    [monthly_payment_upgrades] DECIMAL (18, 2)  NOT NULL,
    [monthly_payment_total]    DECIMAL (18, 2)  NOT NULL,
    [author]                   VARCHAR (50)     NOT NULL,
    [create_date]              DATETIME         NOT NULL,
    [modifier]                 VARCHAR (50)     NOT NULL,
    [modified_date]            DATETIME         NOT NULL,
    [stamp]                    ROWVERSION       NOT NULL,
    CONSTRAINT [PK_plan_budget] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Index [dbo].[plan_budget].[IX_plan_budget_user_id_plan_id]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_plan_budget_user_id_plan_id]
    ON [dbo].[plan_budget]([user_id] ASC, [plan_id] ASC);


GO
PRINT N'Creating Table [dbo].[plan_budget_values]...';


GO
CREATE TABLE [dbo].[plan_budget_values] (
    [id]             UNIQUEIDENTIFIER NOT NULL,
    [plan_budget_id] UNIQUEIDENTIFIER NOT NULL,
    [name_id]        INT              NOT NULL,
    [value]          DECIMAL (18, 3)  NOT NULL,
    [author]         VARCHAR (50)     NOT NULL,
    [create_date]    DATETIME         NOT NULL,
    [modifier]       VARCHAR (50)     NOT NULL,
    [modified_date]  DATETIME         NOT NULL,
    [stamp]          ROWVERSION       NOT NULL,
    CONSTRAINT [PK_plan_budget_values] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Index [dbo].[plan_budget_values].[IX_plan_budget_values_plan_budget_id_name_id]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_plan_budget_values_plan_budget_id_name_id]
    ON [dbo].[plan_budget_values]([plan_budget_id] ASC, [name_id] ASC);


GO
PRINT N'Creating Table [dbo].[plan_budget_values_names]...';


GO
CREATE TABLE [dbo].[plan_budget_values_names] (
    [id]                 INT           NOT NULL,
    [name]               VARCHAR (100) NOT NULL,
    [data_type]          VARCHAR (20)  NOT NULL,
    [required]           BIT           NOT NULL,
    [enabled_by_default] BIT           NOT NULL,
    [community_default]  BIT           NOT NULL,
    [author]             VARCHAR (50)  NOT NULL,
    [create_date]        DATETIME      NOT NULL,
    [modifier]           VARCHAR (50)  NOT NULL,
    [modified_date]      DATETIME      NOT NULL,
    [stamp]              ROWVERSION    NOT NULL,
    CONSTRAINT [PK_plan_budget_values_names] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Table [dbo].[plan_document_types]...';


GO
CREATE TABLE [dbo].[plan_document_types] (
    [doc_type]      NVARCHAR (25)  NOT NULL,
    [description]   NVARCHAR (500) NOT NULL,
    [author]        VARCHAR (50)   NOT NULL,
    [create_date]   DATETIME       NOT NULL,
    [modifier]      VARCHAR (50)   NOT NULL,
    [modified_date] DATETIME       NOT NULL,
    [stamp]         TIMESTAMP      NOT NULL,
    CONSTRAINT [PK_plan_document_types] PRIMARY KEY CLUSTERED ([doc_type] ASC) ON [PRIMARY]
) ON [PRIMARY];


GO
PRINT N'Creating Table [dbo].[plan_documents]...';


GO
CREATE TABLE [dbo].[plan_documents] (
    [id]              UNIQUEIDENTIFIER NOT NULL,
    [profile_plan_id] UNIQUEIDENTIFIER NOT NULL,
    [doc_type]        NVARCHAR (25)    NOT NULL,
    [mime_type]       NVARCHAR (50)    NOT NULL,
    [session_id]      UNIQUEIDENTIFIER NULL,
    [doc_data]        VARBINARY (MAX)  NOT NULL,
    [author]          VARCHAR (50)     NOT NULL,
    [create_date]     DATETIME         NOT NULL,
    [modifier]        VARCHAR (50)     NOT NULL,
    [modified_date]   DATETIME         NOT NULL,
    [stamp]           TIMESTAMP        NOT NULL,
    CONSTRAINT [PK_plan_documents] PRIMARY KEY CLUSTERED ([id] ASC) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];


GO
PRINT N'Creating Table [dbo].[primary_plan_catalogs]...';


GO
CREATE TABLE [dbo].[primary_plan_catalogs] (
    [session_id]         UNIQUEIDENTIFIER NOT NULL,
    [profile_plan_id]    UNIQUEIDENTIFIER NOT NULL,
    [author]             VARCHAR (50)     NOT NULL,
    [create_date]        DATETIME         NOT NULL,
    [modifier]           VARCHAR (50)     NOT NULL,
    [modified_date]      DATETIME         NOT NULL,
    [stamp]              ROWVERSION       NOT NULL,
    [first_visit_to_dmh] BIT              NULL,
    CONSTRAINT [PK_primary_plan_catalogs] PRIMARY KEY CLUSTERED ([session_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[primary_plan_catalogs].[UX_primary_plan_catalogs_profile_plan_id]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [UX_primary_plan_catalogs_profile_plan_id]
    ON [dbo].[primary_plan_catalogs]([profile_plan_id] ASC);


GO
PRINT N'Creating Table [dbo].[problem_types]...';


GO
CREATE TABLE [dbo].[problem_types] (
    [type_id]       INT            IDENTITY (1, 1) NOT NULL,
    [name]          VARCHAR (8000) NOT NULL,
    [author]        VARCHAR (50)   NOT NULL,
    [create_date]   DATETIME       NOT NULL,
    [modifier]      VARCHAR (50)   NOT NULL,
    [modified_date] DATETIME       NOT NULL,
    [stamp]         ROWVERSION     NOT NULL,
    CONSTRAINT [PK_problem_types] PRIMARY KEY CLUSTERED ([type_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[report_storage]...';


GO
CREATE TABLE [dbo].[report_storage] (
    [storage_id]         UNIQUEIDENTIFIER NOT NULL,
    [report_id]          VARCHAR (50)     NOT NULL,
    [report_output_type] VARCHAR (50)     NOT NULL,
    [binary_data]        VARBINARY (MAX)  NOT NULL,
    [author]             VARCHAR (50)     NOT NULL,
    [create_date]        DATETIME         NOT NULL,
    [modifier]           VARCHAR (50)     NOT NULL,
    [modified_date]      DATETIME         NOT NULL,
    [stamp]              ROWVERSION       NOT NULL,
    CONSTRAINT [PK_report_storage] PRIMARY KEY CLUSTERED ([storage_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[restricted_application_product]...';


GO
CREATE TABLE [dbo].[restricted_application_product] (
    [id]              UNIQUEIDENTIFIER NOT NULL,
    [organization_id] UNIQUEIDENTIFIER NOT NULL,
    [application_id]  NVARCHAR (10)    NOT NULL,
    [product_id]      NVARCHAR (5)     NOT NULL,
    [author]          NVARCHAR (50)    NOT NULL,
    [create_date]     DATETIME         NOT NULL,
    [modifier]        NVARCHAR (50)    NOT NULL,
    [modified_date]   DATETIME         NOT NULL,
    [stamp]           ROWVERSION       NOT NULL,
    CONSTRAINT [PK_restricted_application_product] PRIMARY KEY CLUSTERED ([id] ASC),
    CONSTRAINT [IX_restricted_application_product] UNIQUE NONCLUSTERED ([organization_id] ASC, [application_id] ASC, [product_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[room_sections]...';


GO
CREATE TABLE [dbo].[room_sections] (
    [id]            UNIQUEIDENTIFIER NOT NULL,
    [room_id]       UNIQUEIDENTIFIER NOT NULL,
    [area_id]       VARCHAR (10)     NOT NULL,
    [sub_area_id]   VARCHAR (10)     NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    PRIMARY KEY CLUSTERED ([id] ASC),
    CONSTRAINT [UQ_room_sections_area_subarea] UNIQUE NONCLUSTERED ([area_id] ASC, [sub_area_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[rooms]...';


GO
CREATE TABLE [dbo].[rooms] (
    [id]            UNIQUEIDENTIFIER NOT NULL,
    [name]          VARCHAR (50)     NOT NULL,
    [icon_id]       UNIQUEIDENTIFIER NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_rooms] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Index [dbo].[rooms].[IX_room_name]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_room_name]
    ON [dbo].[rooms]([name] ASC);


GO
PRINT N'Creating Table [dbo].[scheduling_appointment_confirmation_log]...';


GO
CREATE TABLE [dbo].[scheduling_appointment_confirmation_log] (
    [id]       UNIQUEIDENTIFIER NOT NULL,
    [user_id]  UNIQUEIDENTIFIER NOT NULL,
    [log_date] DATE             NOT NULL,
    [duration] INT              NOT NULL,
    CONSTRAINT [PK_scheduling_appointment_confirmation_log] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Index [dbo].[scheduling_appointment_confirmation_log].[UX_scheduling_appointment_confirmation_log_user_id_log_date]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [UX_scheduling_appointment_confirmation_log_user_id_log_date]
    ON [dbo].[scheduling_appointment_confirmation_log]([user_id] ASC, [log_date] ASC);


GO
PRINT N'Creating Table [dbo].[scheduling_appointment_templates]...';


GO
CREATE TABLE [dbo].[scheduling_appointment_templates] (
    [account_org_id] UNIQUEIDENTIFIER NOT NULL,
    [template_id]    UNIQUEIDENTIFIER NOT NULL,
    [template_name]  VARCHAR (100)    NOT NULL,
    [author]         VARCHAR (50)     NOT NULL,
    [create_date]    DATETIME         NOT NULL,
    [modifier]       VARCHAR (50)     NOT NULL,
    [modified_date]  DATETIME         NOT NULL,
    [stamp]          ROWVERSION       NOT NULL,
    CONSTRAINT [PK_scheduling_templates] PRIMARY KEY CLUSTERED ([account_org_id] ASC, [template_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[scheduling_appointment_templates_detail]...';


GO
CREATE TABLE [dbo].[scheduling_appointment_templates_detail] (
    [template_id]             UNIQUEIDENTIFIER NOT NULL,
    [template_appointment_id] UNIQUEIDENTIFIER NOT NULL,
    [appointment_type]        INT              NOT NULL,
    [duration]                INT              NOT NULL,
    [author]                  VARCHAR (50)     NOT NULL,
    [create_date]             DATETIME         NOT NULL,
    [modifier]                VARCHAR (50)     NOT NULL,
    [modified_date]           DATETIME         NOT NULL,
    [stamp]                   ROWVERSION       NOT NULL,
    CONSTRAINT [PK_scheduling_appointment_templates_appointments] PRIMARY KEY CLUSTERED ([template_appointment_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[scheduling_appointment_types]...';


GO
CREATE TABLE [dbo].[scheduling_appointment_types] (
    [appointment_type] INT           NOT NULL,
    [name]             VARCHAR (100) NOT NULL,
    [abbrev]           VARCHAR (10)  NULL,
    [sort_order]       INT           NULL,
    [author]           VARCHAR (50)  NOT NULL,
    [create_date]      DATETIME      NOT NULL,
    [modifier]         VARCHAR (50)  NOT NULL,
    [modified_date]    DATETIME      NOT NULL,
    [stamp]            ROWVERSION    NOT NULL,
    CONSTRAINT [PK_scheduling_appointment_types] PRIMARY KEY CLUSTERED ([appointment_type] ASC)
);


GO
PRINT N'Creating Table [dbo].[scheduling_appointments]...';


GO
CREATE TABLE [dbo].[scheduling_appointments] (
    [appointment_id]                UNIQUEIDENTIFIER NOT NULL,
    [buyer_profile_id]              UNIQUEIDENTIFIER NULL,
    [account_org_id]                UNIQUEIDENTIFIER NULL,
    [appointment_template_id]       UNIQUEIDENTIFIER NULL,
    [appointment_type]              INT              NOT NULL,
    [appointment_duration]          INT              NOT NULL,
    [is_scheduled]                  BIT              NULL,
    [is_conflict]                   BIT              NULL,
    [schedule_user_id]              UNIQUEIDENTIFIER NULL,
    [appointment_date]              DATETIME         NULL,
    [start_time]                    TIME (7)         NULL,
    [end_time]                      TIME (7)         NULL,
    [location_id]                   UNIQUEIDENTIFIER NULL,
    [appointment_label]             VARCHAR (200)    NOT NULL,
    [appointment_note]              VARCHAR (200)    NOT NULL,
    [start_time_actual]             TIME (7)         NULL,
    [end_time_actual]               TIME (7)         NULL,
    [is_virtual]                    BIT              NULL,
    [in_design]                     BIT              NULL,
    [design_type]                   UNIQUEIDENTIFIER NULL,
    [author]                        VARCHAR (50)     NOT NULL,
    [create_date]                   DATETIME         NOT NULL,
    [modifier]                      VARCHAR (50)     NOT NULL,
    [modified_date]                 DATETIME         NOT NULL,
    [stamp]                         ROWVERSION       NOT NULL,
    [confirmation_status]           INT              NULL,
    [is_provisional]                BIT              NULL,
    [provisional_scheduler_user_id] UNIQUEIDENTIFIER NULL,
    CONSTRAINT [PK_scheduling_appointments] PRIMARY KEY CLUSTERED ([appointment_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[scheduling_appointments].[IX_scheduling_appointments_appointment_date]...';


GO
CREATE NONCLUSTERED INDEX [IX_scheduling_appointments_appointment_date]
    ON [dbo].[scheduling_appointments]([appointment_date] ASC);


GO
PRINT N'Creating Index [dbo].[scheduling_appointments].[IX_scheduling_appointments_buyer_profile_id]...';


GO
CREATE NONCLUSTERED INDEX [IX_scheduling_appointments_buyer_profile_id]
    ON [dbo].[scheduling_appointments]([buyer_profile_id] ASC);


GO
PRINT N'Creating Index [dbo].[scheduling_appointments].[IX_scheduling_appointments_account_org_id_appointment_date]...';


GO
CREATE NONCLUSTERED INDEX [IX_scheduling_appointments_account_org_id_appointment_date]
    ON [dbo].[scheduling_appointments]([account_org_id] ASC, [appointment_date] ASC)
    INCLUDE([buyer_profile_id], [schedule_user_id]);


GO
PRINT N'Creating Table [dbo].[scheduling_buyers]...';


GO
CREATE TABLE [dbo].[scheduling_buyers] (
    [profile_id]      UNIQUEIDENTIFIER NOT NULL,
    [schedule_status] INT              NULL,
    [buyer_name]      VARCHAR (200)    NOT NULL,
    [received_date]   DATETIME         NULL,
    [is_active]       INT              NULL,
    [author]          VARCHAR (50)     NOT NULL,
    [create_date]     DATETIME         NOT NULL,
    [modifier]        VARCHAR (50)     NOT NULL,
    [modified_date]   DATETIME         NOT NULL,
    [stamp]           ROWVERSION       NOT NULL,
    CONSTRAINT [PK_scheduling_buyers] PRIMARY KEY CLUSTERED ([profile_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[scheduling_buyers].[NonClusteredIndex_scheduling_buyers_buyer_name]...';


GO
CREATE NONCLUSTERED INDEX [NonClusteredIndex_scheduling_buyers_buyer_name]
    ON [dbo].[scheduling_buyers]([buyer_name] ASC)
    INCLUDE([create_date], [is_active], [profile_id], [received_date], [schedule_status]);


GO
PRINT N'Creating Index [dbo].[scheduling_buyers].[NonClusteredIndex-20130418-134624]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [NonClusteredIndex-20130418-134624]
    ON [dbo].[scheduling_buyers]([profile_id] ASC, [is_active] ASC, [create_date] ASC);


GO
PRINT N'Creating Table [dbo].[scheduling_buyers_contacts]...';


GO
CREATE TABLE [dbo].[scheduling_buyers_contacts] (
    [contact_id]                UNIQUEIDENTIFIER NOT NULL,
    [profile_id]                UNIQUEIDENTIFIER NOT NULL,
    [contact_label]             VARCHAR (200)    NOT NULL,
    [is_buyer]                  BIT              NOT NULL,
    [contact_role]              VARCHAR (50)     NULL,
    [email]                     VARCHAR (300)    NULL,
    [mobile_phone]              VARCHAR (20)     NULL,
    [work_phone]                VARCHAR (20)     NULL,
    [home_phone]                VARCHAR (20)     NULL,
    [mobile_phone_send_message] BIT              NOT NULL,
    [work_phone_send_message]   BIT              NOT NULL,
    [home_phone_send_message]   BIT              NOT NULL,
    [fax]                       VARCHAR (20)     NULL,
    [alt1]                      VARCHAR (200)    NULL,
    [alt2]                      VARCHAR (200)    NULL,
    [primary_phone]             VARCHAR (20)     NULL,
    [note]                      VARCHAR (500)    NULL,
    [active]                    BIT              NOT NULL,
    [author]                    VARCHAR (50)     NOT NULL,
    [create_date]               DATETIME         NOT NULL,
    [modifier]                  VARCHAR (50)     NOT NULL,
    [modified_date]             DATETIME         NOT NULL,
    [stamp]                     ROWVERSION       NOT NULL,
    CONSTRAINT [PK_scheduling_buyer_contacts] PRIMARY KEY CLUSTERED ([contact_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[scheduling_buyers_contacts].[IX_scheduling_buyers_contacts_contact_id_profile_id_is_buyer]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_scheduling_buyers_contacts_contact_id_profile_id_is_buyer]
    ON [dbo].[scheduling_buyers_contacts]([contact_id] ASC, [profile_id] ASC, [is_buyer] ASC);


GO
PRINT N'Creating Index [dbo].[scheduling_buyers_contacts].[IX_scheduling_buyers_contacts_profile_id_contact_role]...';


GO
CREATE NONCLUSTERED INDEX [IX_scheduling_buyers_contacts_profile_id_contact_role]
    ON [dbo].[scheduling_buyers_contacts]([profile_id] ASC, [contact_role] ASC);


GO
PRINT N'Creating Table [dbo].[scheduling_message_types]...';


GO
CREATE TABLE [dbo].[scheduling_message_types] (
    [message_type]      INT          NOT NULL,
    [message_type_name] VARCHAR (50) NOT NULL,
    [author]            VARCHAR (50) NOT NULL,
    [create_date]       DATETIME     NOT NULL,
    [modifier]          VARCHAR (50) NOT NULL,
    [modified_date]     DATETIME     NOT NULL,
    [stamp]             ROWVERSION   NOT NULL,
    CONSTRAINT [PK_scheduling_message_types] PRIMARY KEY CLUSTERED ([message_type] ASC)
);


GO
PRINT N'Creating Table [dbo].[scheduling_messages]...';


GO
CREATE TABLE [dbo].[scheduling_messages] (
    [message_id]       UNIQUEIDENTIFIER NOT NULL,
    [message_type]     INT              NOT NULL,
    [message_status]   INT              NOT NULL,
    [is_read]          BIT              NOT NULL,
    [message_title]    VARCHAR (100)    NOT NULL,
    [message_priority] INT              NOT NULL,
    [user_id]          UNIQUEIDENTIFIER NULL,
    [buyer_profile_id] UNIQUEIDENTIFIER NULL,
    [appointment_id]   UNIQUEIDENTIFIER NULL,
    [sender_id]        UNIQUEIDENTIFIER NULL,
    [message_body]     VARCHAR (1000)   NULL,
    [completion_date]  DATETIME         NULL,
    [dismissed]        BIT              NOT NULL,
    [tags]             VARCHAR (100)    NULL,
    [author]           VARCHAR (50)     NOT NULL,
    [create_date]      DATETIME         NOT NULL,
    [modifier]         VARCHAR (50)     NOT NULL,
    [modified_date]    DATETIME         NOT NULL,
    [stamp]            ROWVERSION       NOT NULL,
    CONSTRAINT [PK_scheduling_messages] PRIMARY KEY CLUSTERED ([message_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[scheduling_messages].[IX_scheduling_messages_buyer_profile_id]...';


GO
CREATE NONCLUSTERED INDEX [IX_scheduling_messages_buyer_profile_id]
    ON [dbo].[scheduling_messages]([buyer_profile_id] ASC)
    INCLUDE([message_type]);


GO
PRINT N'Creating Index [dbo].[scheduling_messages].[IX_scheduling_messages_appointment_id_message_title_completion_date]...';


GO
CREATE NONCLUSTERED INDEX [IX_scheduling_messages_appointment_id_message_title_completion_date]
    ON [dbo].[scheduling_messages]([appointment_id] ASC, [message_title] ASC, [completion_date] DESC);


GO
PRINT N'Creating Table [dbo].[scheduling_organizations]...';


GO
CREATE TABLE [dbo].[scheduling_organizations] (
    [account_org_id]      UNIQUEIDENTIFIER NOT NULL,
    [display_name]        VARCHAR (50)     NULL,
    [display_hours_start] DATETIME         NULL,
    [display_hours_end]   DATETIME         NULL,
    [excluded_designers]  NVARCHAR (500)   NULL,
    [email_cc]            VARCHAR (500)    NULL,
    [author]              VARCHAR (50)     NOT NULL,
    [create_date]         DATETIME         NOT NULL,
    [modifier]            VARCHAR (50)     NOT NULL,
    [modified_date]       DATETIME         NOT NULL,
    [stamp]               ROWVERSION       NOT NULL,
    CONSTRAINT [PK_scheduling_organizations] PRIMARY KEY CLUSTERED ([account_org_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[scheduling_roles]...';


GO
CREATE TABLE [dbo].[scheduling_roles] (
    [role_id]       UNIQUEIDENTIFIER NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_scheduling_roles] PRIMARY KEY CLUSTERED ([role_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[scheduling_settings]...';


GO
CREATE TABLE [dbo].[scheduling_settings] (
    [id]                  UNIQUEIDENTIFIER NOT NULL,
    [setting_key]         NVARCHAR (50)    NOT NULL,
    [setting_name]        NVARCHAR (100)   NOT NULL,
    [setting_description] NVARCHAR (300)   NOT NULL,
    [data_type]           NVARCHAR (50)    NOT NULL,
    CONSTRAINT [PK_scheduling_settings] PRIMARY KEY CLUSTERED ([id] ASC),
    CONSTRAINT [UX_scheduling_settings_setting_key] UNIQUE NONCLUSTERED ([setting_key] ASC)
);


GO
PRINT N'Creating Table [dbo].[scheduling_sms_opt_in]...';


GO
CREATE TABLE [dbo].[scheduling_sms_opt_in] (
    [id]                      UNIQUEIDENTIFIER NOT NULL,
    [phone_number]            VARCHAR (25)     NOT NULL,
    [invite_message]          NVARCHAR (MAX)   NOT NULL,
    [invite_date]             DATETIME2 (7)    NOT NULL,
    [is_pending_confirmation] BIT              NOT NULL,
    [is_opted_in]             BIT              NOT NULL,
    [confirm_date]            DATETIME2 (7)    NULL,
    [reply_message]           NVARCHAR (50)    NOT NULL,
    CONSTRAINT [PK_scheduling_sms_opt_in] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Table [dbo].[scheduling_status]...';


GO
CREATE TABLE [dbo].[scheduling_status] (
    [status_id]     INT           NOT NULL,
    [status]        VARCHAR (100) NULL,
    [author]        VARCHAR (50)  NOT NULL,
    [create_date]   DATETIME      NOT NULL,
    [modifier]      VARCHAR (50)  NOT NULL,
    [modified_date] DATETIME      NOT NULL,
    [stamp]         ROWVERSION    NOT NULL,
    CONSTRAINT [PK_scheduling_status] PRIMARY KEY CLUSTERED ([status_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[scheduling_user_locations]...';


GO
CREATE TABLE [dbo].[scheduling_user_locations] (
    [user_id]       UNIQUEIDENTIFIER NOT NULL,
    [location_id]   UNIQUEIDENTIFIER NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_scheduling_user_locations] PRIMARY KEY CLUSTERED ([user_id] ASC, [location_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[scheduling_user_organizations]...';


GO
CREATE TABLE [dbo].[scheduling_user_organizations] (
    [user_id]        UNIQUEIDENTIFIER NOT NULL,
    [account_org_id] UNIQUEIDENTIFIER NOT NULL,
    [author]         VARCHAR (50)     NOT NULL,
    [create_date]    DATETIME         NOT NULL,
    [modifier]       VARCHAR (50)     NOT NULL,
    [modified_date]  DATETIME         NOT NULL,
    [stamp]          ROWVERSION       NOT NULL,
    CONSTRAINT [PK_scheduling_user_organizations] PRIMARY KEY CLUSTERED ([user_id] ASC, [account_org_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[scheduling_user_preferences]...';


GO
CREATE TABLE [dbo].[scheduling_user_preferences] (
    [user_id]       UNIQUEIDENTIFIER NOT NULL,
    [pref_key]      VARCHAR (50)     NOT NULL,
    [pref_value]    VARCHAR (300)    NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_scheduling_user_options] PRIMARY KEY CLUSTERED ([user_id] ASC, [pref_key] ASC)
);


GO
PRINT N'Creating Table [dbo].[scheduling_user_roles]...';


GO
CREATE TABLE [dbo].[scheduling_user_roles] (
    [user_id]       UNIQUEIDENTIFIER NOT NULL,
    [role_id]       UNIQUEIDENTIFIER NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_scheduling_user_roles] PRIMARY KEY CLUSTERED ([user_id] ASC, [role_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[scheduling_user_settings]...';


GO
CREATE TABLE [dbo].[scheduling_user_settings] (
    [id]            UNIQUEIDENTIFIER NOT NULL,
    [user_id]       UNIQUEIDENTIFIER NOT NULL,
    [setting_id]    UNIQUEIDENTIFIER NOT NULL,
    [setting_value] NVARCHAR (200)   NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_scheduling_user_settings] PRIMARY KEY CLUSTERED ([id] ASC),
    CONSTRAINT [UX_scheduling_user_settings_user_id_setting_id] UNIQUE NONCLUSTERED ([user_id] ASC, [setting_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[scheduling_user_work_schedules]...';


GO
CREATE TABLE [dbo].[scheduling_user_work_schedules] (
    [user_id]       UNIQUEIDENTIFIER NOT NULL,
    [day]           INT              NOT NULL,
    [location_id]   UNIQUEIDENTIFIER NULL,
    [work_type]     INT              NULL,
    [start_time]    TIME (7)         NULL,
    [end_time]      TIME (7)         NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_scheduling_user_work_schedules] PRIMARY KEY CLUSTERED ([user_id] ASC, [day] ASC)
);


GO
PRINT N'Creating Table [dbo].[scheduling_users]...';


GO
CREATE TABLE [dbo].[scheduling_users] (
    [user_id]            UNIQUEIDENTIFIER NOT NULL,
    [scheduling_enabled] BIT              NULL,
    [first_name]         VARCHAR (100)    NULL,
    [last_name]          VARCHAR (100)    NULL,
    [email]              VARCHAR (300)    NULL,
    [phone]              VARCHAR (20)     NULL,
    [author]             VARCHAR (50)     NOT NULL,
    [create_date]        DATETIME         NOT NULL,
    [modifier]           VARCHAR (50)     NOT NULL,
    [modified_date]      DATETIME         NOT NULL,
    [stamp]              ROWVERSION       NOT NULL,
    CONSTRAINT [PK_scheduling_users] PRIMARY KEY CLUSTERED ([user_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[session_changes]...';


GO
CREATE TABLE [dbo].[session_changes] (
    [change_id]      UNIQUEIDENTIFIER NOT NULL,
    [session_id]     UNIQUEIDENTIFIER NOT NULL,
    [change_version] NVARCHAR (10)    NOT NULL,
    [change_data]    NVARCHAR (MAX)   NOT NULL,
    [author]         VARCHAR (50)     NOT NULL,
    [create_date]    DATETIME         NOT NULL,
    [modifier]       VARCHAR (50)     NOT NULL,
    [modified_date]  DATETIME         NOT NULL,
    [stamp]          TIMESTAMP        NOT NULL,
    CONSTRAINT [PK_session_changes] PRIMARY KEY CLUSTERED ([change_id] ASC) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];


GO
PRINT N'Creating Table [dbo].[session_changes_applied]...';


GO
CREATE TABLE [dbo].[session_changes_applied] (
    [change_id]      UNIQUEIDENTIFIER NOT NULL,
    [session_id]     UNIQUEIDENTIFIER NOT NULL,
    [change_version] NVARCHAR (10)    NOT NULL,
    [change_data]    NVARCHAR (MAX)   NOT NULL,
    [author]         VARCHAR (50)     NOT NULL,
    [create_date]    DATETIME         NOT NULL,
    [modifier]       VARCHAR (50)     NOT NULL,
    [modified_date]  DATETIME         NOT NULL,
    [stamp]          TIMESTAMP        NOT NULL,
    CONSTRAINT [PK_session_changes_applied] PRIMARY KEY CLUSTERED ([change_id] ASC) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];


GO
PRINT N'Creating Table [dbo].[session_designer_documents]...';


GO
CREATE TABLE [dbo].[session_designer_documents] (
    [id]            UNIQUEIDENTIFIER NOT NULL,
    [session_id]    UNIQUEIDENTIFIER NOT NULL,
    [doc_id]        UNIQUEIDENTIFIER NOT NULL,
    [is_checked]    BIT              NULL,
    [author]        VARCHAR (50)     NULL,
    [create_date]   DATETIME         NULL,
    [modifier]      VARCHAR (50)     NULL,
    [modified_date] DATETIME         NULL,
    CONSTRAINT [PK_session_designer_documents] PRIMARY KEY CLUSTERED ([id] ASC),
    CONSTRAINT [UX_session_designer_documents_session_id_doc_id] UNIQUE NONCLUSTERED ([session_id] ASC, [doc_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[session_statuses]...';


GO
CREATE TABLE [dbo].[session_statuses] (
    [status_id]     INT          NOT NULL,
    [status]        VARCHAR (50) NOT NULL,
    [author]        VARCHAR (50) NOT NULL,
    [create_date]   DATETIME     NOT NULL,
    [modifier]      VARCHAR (50) NOT NULL,
    [modified_date] DATETIME     NOT NULL,
    [stamp]         ROWVERSION   NOT NULL,
    CONSTRAINT [PK_session_statuses] PRIMARY KEY CLUSTERED ([status_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[sessions_converted]...';


GO
CREATE TABLE [dbo].[sessions_converted] (
    [session_id]          UNIQUEIDENTIFIER NOT NULL,
    [bom_count]           INT              NOT NULL,
    [missing_count]       INT              NOT NULL,
    [convert_date]        DATETIME         NULL,
    [session_create_date] DATETIME         NULL,
    CONSTRAINT [PK_sessions_converted] PRIMARY KEY CLUSTERED ([session_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[sms_default_templates]...';


GO
CREATE TABLE [dbo].[sms_default_templates] (
    [id]            UNIQUEIDENTIFIER NOT NULL,
    [template_key]  VARCHAR (50)     NOT NULL,
    [template]      NVARCHAR (MAX)   NOT NULL,
    [author]        VARCHAR (100)    NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (100)    NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    CONSTRAINT [PK_sms_default_templates] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Index [dbo].[sms_default_templates].[UX_sms_default_templates_template_key]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [UX_sms_default_templates_template_key]
    ON [dbo].[sms_default_templates]([template_key] ASC);


GO
PRINT N'Creating Table [dbo].[support_links]...';


GO
CREATE TABLE [dbo].[support_links] (
    [row_id]        UNIQUEIDENTIFIER NOT NULL,
    [link_id]       VARCHAR (50)     NOT NULL,
    [account_org]   VARCHAR (36)     NOT NULL,
    [role_id]       VARCHAR (36)     NOT NULL,
    [url]           VARCHAR (500)    NOT NULL,
    [url_label]     VARCHAR (500)    NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_support_links] PRIMARY KEY CLUSTERED ([row_id] ASC)
);


GO
PRINT N'Creating Index [dbo].[support_links].[IX_support_links]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [IX_support_links]
    ON [dbo].[support_links]([link_id] ASC, [account_org] ASC, [role_id] ASC);


GO
PRINT N'Creating Table [dbo].[support_log]...';


GO
CREATE TABLE [dbo].[support_log] (
    [entry_id]           INT              IDENTITY (1, 1) NOT NULL,
    [organization_id]    UNIQUEIDENTIFIER NULL,
    [session_id]         UNIQUEIDENTIFIER NULL,
    [entry_date]         DATETIME         NOT NULL,
    [cc_list]            VARCHAR (MAX)    NOT NULL,
    [problem_type]       VARCHAR (MAX)    NOT NULL,
    [body_message]       VARCHAR (MAX)    NOT NULL,
    [application]        VARCHAR (100)    NOT NULL,
    [product]            VARCHAR (100)    NOT NULL,
    [problem_source]     INT              NOT NULL,
    [problem_status]     BIT              NOT NULL,
    [problem_resolution] INT              NOT NULL,
    [resolution_date]    DATETIME         NULL,
    [resolved_by]        VARCHAR (50)     NULL,
    [notes]              VARCHAR (MAX)    NOT NULL,
    [author]             VARCHAR (50)     NOT NULL,
    [create_date]        DATETIME         NOT NULL,
    [modifier]           VARCHAR (50)     NOT NULL,
    [modified_date]      DATETIME         NOT NULL,
    [stamp]              ROWVERSION       NOT NULL,
    CONSTRAINT [PK_support_log] PRIMARY KEY CLUSTERED ([entry_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[support_problem_resolutions]...';


GO
CREATE TABLE [dbo].[support_problem_resolutions] (
    [resolution_id] INT           IDENTITY (1, 1) NOT NULL,
    [name]          VARCHAR (MAX) NOT NULL,
    [author]        VARCHAR (50)  NOT NULL,
    [create_date]   DATETIME      NOT NULL,
    [modifier]      VARCHAR (50)  NOT NULL,
    [modified_date] DATETIME      NOT NULL,
    [stamp]         ROWVERSION    NOT NULL,
    CONSTRAINT [PK_support_problem_resolutions] PRIMARY KEY CLUSTERED ([resolution_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[support_problem_sources]...';


GO
CREATE TABLE [dbo].[support_problem_sources] (
    [source_id]     INT           IDENTITY (1, 1) NOT NULL,
    [name]          VARCHAR (MAX) NOT NULL,
    [author]        VARCHAR (50)  NOT NULL,
    [create_date]   DATETIME      NOT NULL,
    [modifier]      VARCHAR (50)  NOT NULL,
    [modified_date] DATETIME      NOT NULL,
    [stamp]         ROWVERSION    NOT NULL,
    CONSTRAINT [PK_support_problem_sources] PRIMARY KEY CLUSTERED ([source_id] ASC)
);


GO
PRINT N'Creating Table [dbo].[system_messages]...';


GO
CREATE TABLE [dbo].[system_messages] (
    [start_date_time] DATETIME      NOT NULL,
    [end_date_time]   DATETIME      NOT NULL,
    [message]         VARCHAR (MAX) NOT NULL,
    CONSTRAINT [PK_system_messages] PRIMARY KEY CLUSTERED ([start_date_time] ASC, [end_date_time] ASC)
);


GO
PRINT N'Creating Table [dbo].[user_completed_orientation_steps]...';


GO
CREATE TABLE [dbo].[user_completed_orientation_steps] (
    [id]            UNIQUEIDENTIFIER NOT NULL,
    [user_id]       UNIQUEIDENTIFIER NOT NULL,
    [step]          VARCHAR (50)     NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    CONSTRAINT [PK_user_completed_orientation_steps] PRIMARY KEY CLUSTERED ([id] ASC)
);


GO
PRINT N'Creating Table [dbo].[user_impersonations]...';


GO
CREATE TABLE [dbo].[user_impersonations] (
    [user_id]                      UNIQUEIDENTIFIER NOT NULL,
    [impersonation_date]           DATETIME         NOT NULL,
    [impersonated_account_id]      UNIQUEIDENTIFIER NOT NULL,
    [impersonated_organization_id] UNIQUEIDENTIFIER NOT NULL,
    [impersonated_user_id]         UNIQUEIDENTIFIER NOT NULL,
    CONSTRAINT [PK_user_impersonations] PRIMARY KEY CLUSTERED ([user_id] ASC, [impersonation_date] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_account_organization_addresses]...';


GO
CREATE TABLE [dbo].[z_account_organization_addresses] (
    [z_user_name]    VARCHAR (50)     NOT NULL,
    [z_action]       VARCHAR (10)     NOT NULL,
    [z_time]         DATETIME         NOT NULL,
    [account_org_id] UNIQUEIDENTIFIER NOT NULL,
    [address_id]     UNIQUEIDENTIFIER NOT NULL,
    [address_name]   [sysname]        NOT NULL,
    [auto_number]    INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_account_organization_addresses] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_account_organization_application_product_sort_order]...';


GO
CREATE TABLE [dbo].[z_account_organization_application_product_sort_order] (
    [z_user_name]     VARCHAR (50)     NOT NULL,
    [z_action]        VARCHAR (10)     NOT NULL,
    [z_time]          DATETIME         NOT NULL,
    [account_id]      UNIQUEIDENTIFIER NOT NULL,
    [organization_id] UNIQUEIDENTIFIER NOT NULL,
    [application]     VARCHAR (100)    NOT NULL,
    [product]         VARCHAR (100)    NOT NULL,
    [sort_order]      INT              NOT NULL,
    [author]          VARCHAR (50)     NOT NULL,
    [create_date]     DATETIME         NOT NULL,
    [modifier]        VARCHAR (50)     NOT NULL,
    [modified_date]   DATETIME         NOT NULL,
    [stamp]           VARCHAR (50)     NOT NULL,
    [auto_number]     INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_account_organization_application_product_sort_order] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_account_organization_support_emails]...';


GO
CREATE TABLE [dbo].[z_account_organization_support_emails] (
    [z_user_name]               VARCHAR (50)     NOT NULL,
    [z_action]                  VARCHAR (10)     NOT NULL,
    [z_time]                    DATETIME         NOT NULL,
    [account_org_id]            UNIQUEIDENTIFIER NOT NULL,
    [problem_type]              VARCHAR (8000)   NOT NULL,
    [email]                     NVARCHAR (100)   NULL,
    [should_send_notifications] BIT              NULL,
    [author]                    VARCHAR (50)     NOT NULL,
    [create_date]               DATETIME         NOT NULL,
    [modifier]                  VARCHAR (50)     NOT NULL,
    [modified_date]             DATETIME         NOT NULL,
    [stamp]                     VARCHAR (50)     NOT NULL,
    [auto_number]               INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_account_organization_support_emails] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_account_organization_user_profile]...';


GO
CREATE TABLE [dbo].[z_account_organization_user_profile] (
    [z_user_name]             VARCHAR (50)     NOT NULL,
    [z_action]                VARCHAR (10)     NOT NULL,
    [z_time]                  DATETIME         NOT NULL,
    [account_id]              UNIQUEIDENTIFIER NOT NULL,
    [organization_id]         UNIQUEIDENTIFIER NOT NULL,
    [user_id]                 UNIQUEIDENTIFIER NOT NULL,
    [profile_id]              UNIQUEIDENTIFIER NULL,
    [interest_rate]           DECIMAL (18, 6)  NOT NULL,
    [loan_term]               DECIMAL (18, 6)  NOT NULL,
    [completed_steps]         INT              NOT NULL,
    [enable_homebuyer_access] BIT              NOT NULL,
    [author]                  VARCHAR (50)     NOT NULL,
    [create_date]             DATETIME         NOT NULL,
    [modifier]                VARCHAR (50)     NOT NULL,
    [modified_date]           DATETIME         NOT NULL,
    [stamp]                   VARCHAR (50)     NOT NULL,
    [auto_number]             INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_account_organization_user_profile] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_account_organization_user_profile_plan]...';


GO
CREATE TABLE [dbo].[z_account_organization_user_profile_plan] (
    [z_user_name]                VARCHAR (50)     NOT NULL,
    [z_action]                   VARCHAR (10)     NOT NULL,
    [z_time]                     DATETIME         NOT NULL,
    [account_id]                 UNIQUEIDENTIFIER NOT NULL,
    [organization_id]            UNIQUEIDENTIFIER NOT NULL,
    [user_id]                    UNIQUEIDENTIFIER NOT NULL,
    [profile_id]                 UNIQUEIDENTIFIER NOT NULL,
    [community_name]             VARCHAR (50)     NOT NULL,
    [series]                     VARCHAR (50)     NOT NULL,
    [plan_name]                  VARCHAR (50)     NOT NULL,
    [base_plan_name]             VARCHAR (50)     NOT NULL,
    [spec_id]                    INT              NOT NULL,
    [sales_price]                DECIMAL (18, 2)  NOT NULL,
    [sales_options]              DECIMAL (18, 2)  NOT NULL,
    [upgrades_incentive]         DECIMAL (18, 2)  NOT NULL,
    [additional_design_deposit]  DECIMAL (18, 2)  NOT NULL,
    [deposit_notes]              VARCHAR (255)    NOT NULL,
    [home_down_payment]          DECIMAL (18, 2)  NOT NULL,
    [home_allowance]             DECIMAL (18, 2)  NOT NULL,
    [catalog_session_id]         UNIQUEIDENTIFIER NULL,
    [catalog_session_date]       DATETIME         NULL,
    [catalog_total]              DECIMAL (18, 2)  NOT NULL,
    [job_no]                     VARCHAR (20)     NOT NULL,
    [address]                    VARCHAR (50)     NOT NULL,
    [address_lot_block]          VARCHAR (50)     NOT NULL,
    [property_desc_1]            VARCHAR (50)     NOT NULL,
    [property_desc_2]            VARCHAR (50)     NOT NULL,
    [block]                      VARCHAR (10)     NOT NULL,
    [lot]                        VARCHAR (10)     NOT NULL,
    [city]                       VARCHAR (50)     NOT NULL,
    [state]                      VARCHAR (25)     NOT NULL,
    [zip_code]                   VARCHAR (25)     NOT NULL,
    [sales_counselor]            VARCHAR (50)     NOT NULL,
    [contract_date]              DATETIME         NULL,
    [receipt_date]               DATETIME         NULL,
    [country_home_phone]         VARCHAR (25)     NOT NULL,
    [home_phone]                 VARCHAR (20)     NOT NULL,
    [country_work_phone]         VARCHAR (25)     NOT NULL,
    [work_phone]                 VARCHAR (20)     NULL,
    [spouse_first_name]          VARCHAR (50)     NOT NULL,
    [spouse_last_name]           VARCHAR (50)     NOT NULL,
    [country_spouse_phone]       VARCHAR (25)     NOT NULL,
    [spouse_phone]               VARCHAR (20)     NOT NULL,
    [dc_job_id]                  INT              NOT NULL,
    [dc_contact_list]            VARCHAR (MAX)    NULL,
    [status]                     VARCHAR (15)     NOT NULL,
    [previous_status]            VARCHAR (15)     NULL,
    [echelon_exported]           BIT              NOT NULL,
    [spec_home]                  BIT              NOT NULL,
    [job_type]                   INT              NOT NULL,
    [elevation]                  VARCHAR (50)     NOT NULL,
    [stage]                      VARCHAR (10)     NOT NULL,
    [superintendent]             VARCHAR (50)     NOT NULL,
    [author]                     VARCHAR (50)     NOT NULL,
    [create_date]                DATETIME         NOT NULL,
    [modifier]                   VARCHAR (50)     NOT NULL,
    [modified_date]              DATETIME         NOT NULL,
    [stamp]                      VARCHAR (50)     NOT NULL,
    [auto_number]                INT              IDENTITY (1, 1) NOT NULL,
    [expiration_date]            DATETIME         NULL,
    [upgrade_deposit_percentage] DECIMAL (18, 2)  NULL,
    CONSTRAINT [PK_z_account_organization_user_profile_plan] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_account_organization_user_profile_plan_catalog_sessions]...';


GO
CREATE TABLE [dbo].[z_account_organization_user_profile_plan_catalog_sessions] (
    [z_user_name]               VARCHAR (50)     NOT NULL,
    [z_action]                  VARCHAR (10)     NOT NULL,
    [z_time]                    DATETIME         NOT NULL,
    [account_id]                UNIQUEIDENTIFIER NOT NULL,
    [organization_id]           UNIQUEIDENTIFIER NOT NULL,
    [user_id]                   UNIQUEIDENTIFIER NOT NULL,
    [community_id]              INT              NOT NULL,
    [community_name]            VARCHAR (50)     NOT NULL,
    [series]                    VARCHAR (50)     NOT NULL,
    [plan_name]                 VARCHAR (50)     NOT NULL,
    [plan_version]              VARCHAR (50)     NOT NULL,
    [session_id]                UNIQUEIDENTIFIER NOT NULL,
    [status]                    INT              NOT NULL,
    [status_change_reason]      VARCHAR (MAX)    NULL,
    [session_notes]             VARCHAR (MAX)    NOT NULL,
    [deposit]                   DECIMAL (18, 2)  NOT NULL,
    [deposit_notes]             VARCHAR (255)    NOT NULL,
    [designer]                  VARCHAR (50)     NOT NULL,
    [show_report]               BIT              NULL,
    [spec_id]                   INT              NOT NULL,
    [effective_date]            DATETIME         NOT NULL,
    [completed_date]            DATETIME         NULL,
    [first_completed_date]      DATETIME         NULL,
    [export_date]               DATE             NULL,
    [address_id]                INT              NOT NULL,
    [rounding_type]             INT              NOT NULL,
    [rounding_places]           INT              NOT NULL,
    [builder_markup_hb_pricing] BIT              NOT NULL,
    [buyer_signature]           VARBINARY (MAX)  NULL,
    [buyer_signature_date]      DATETIME         NULL,
    [pricing_generated]         DATETIME         NULL,
    [pricing_published]         DATETIME         NULL,
    [report_id]                 UNIQUEIDENTIFIER NULL,
    [author]                    VARCHAR (50)     NOT NULL,
    [create_date]               DATETIME         NOT NULL,
    [modifier]                  VARCHAR (50)     NOT NULL,
    [modified_date]             DATETIME         NOT NULL,
    [stamp]                     VARCHAR (50)     NOT NULL,
    [auto_number]               INT              IDENTITY (1, 1) NOT NULL,
    [catalog_source]            VARCHAR (100)    NULL,
    [designer_id]               UNIQUEIDENTIFIER NULL,
    [precon_notes]              VARCHAR (250)    NOT NULL,
    CONSTRAINT [PK_z_account_organization_user_profile_plan_catalog_sessions] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Index [dbo].[z_account_organization_user_profile_plan_catalog_sessions].[IX_z_account_organization_user_profile_plan_catalog_sessions_session_id]...';


GO
CREATE NONCLUSTERED INDEX [IX_z_account_organization_user_profile_plan_catalog_sessions_session_id]
    ON [dbo].[z_account_organization_user_profile_plan_catalog_sessions]([session_id] ASC);


GO
PRINT N'Creating Index [dbo].[z_account_organization_user_profile_plan_catalog_sessions].[IX_z_account_organization_user_profile_plan_catalog_sessions_profile_plan]...';


GO
CREATE NONCLUSTERED INDEX [IX_z_account_organization_user_profile_plan_catalog_sessions_profile_plan]
    ON [dbo].[z_account_organization_user_profile_plan_catalog_sessions]([account_id] ASC, [organization_id] ASC, [user_id] ASC, [community_name] ASC, [series] ASC, [plan_name] ASC);


GO
PRINT N'Creating Table [dbo].[z_account_organization_user_profile_plan_exterior_selections]...';


GO
CREATE TABLE [dbo].[z_account_organization_user_profile_plan_exterior_selections] (
    [z_user_name]       VARCHAR (50)     NOT NULL,
    [z_action]          VARCHAR (10)     NOT NULL,
    [z_time]            DATETIME         NOT NULL,
    [account_id]        UNIQUEIDENTIFIER NOT NULL,
    [organization_id]   UNIQUEIDENTIFIER NOT NULL,
    [user_id]           UNIQUEIDENTIFIER NOT NULL,
    [community_name]    VARCHAR (50)     NOT NULL,
    [series]            VARCHAR (50)     NOT NULL,
    [plan_name]         VARCHAR (50)     NOT NULL,
    [selection_line_no] INT              NOT NULL,
    [selection_type]    VARCHAR (20)     NOT NULL,
    [manufacturer_id]   UNIQUEIDENTIFIER NULL,
    [part_id]           VARCHAR (50)     NULL,
    [part_description]  VARCHAR (50)     NOT NULL,
    [notes]             VARCHAR (MAX)    NOT NULL,
    [author]            VARCHAR (50)     NOT NULL,
    [create_date]       DATETIME         NOT NULL,
    [modifier]          VARCHAR (50)     NOT NULL,
    [modified_date]     DATETIME         NOT NULL,
    [stamp]             VARCHAR (50)     NOT NULL,
    [auto_number]       INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_account_organization_user_profile_plan_exterior_selections] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_account_organization_user_profile_plan_options_budget_areas]...';


GO
CREATE TABLE [dbo].[z_account_organization_user_profile_plan_options_budget_areas] (
    [z_user_name]      VARCHAR (50)     NOT NULL,
    [z_action]         VARCHAR (10)     NOT NULL,
    [z_time]           DATETIME         NOT NULL,
    [account_id]       UNIQUEIDENTIFIER NOT NULL,
    [organization_id]  UNIQUEIDENTIFIER NOT NULL,
    [user_id]          UNIQUEIDENTIFIER NOT NULL,
    [community_id]     VARCHAR (50)     NOT NULL,
    [series]           VARCHAR (50)     NOT NULL,
    [plan_name]        VARCHAR (50)     NOT NULL,
    [application_name] VARCHAR (50)     NOT NULL,
    [product_name]     VARCHAR (50)     NOT NULL,
    [area]             VARCHAR (50)     NOT NULL,
    [sub_area]         VARCHAR (50)     NOT NULL,
    [item_name]        VARCHAR (100)    NOT NULL,
    [item_type]        VARCHAR (50)     NOT NULL,
    [item_id]          VARCHAR (50)     NOT NULL,
    [price]            DECIMAL (18, 3)  NOT NULL,
    [author]           VARCHAR (50)     NOT NULL,
    [create_date]      DATETIME         NOT NULL,
    [modifier]         VARCHAR (50)     NOT NULL,
    [modified_date]    DATETIME         NOT NULL,
    [stamp]            VARCHAR (50)     NOT NULL,
    [auto_number]      INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_account_organization_user_profile_plan_options_budget_areas] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_account_organization_user_profile_plan_options_budget_items]...';


GO
CREATE TABLE [dbo].[z_account_organization_user_profile_plan_options_budget_items] (
    [z_user_name]      VARCHAR (50)     NOT NULL,
    [z_action]         VARCHAR (10)     NOT NULL,
    [z_time]           DATETIME         NOT NULL,
    [id]               UNIQUEIDENTIFIER NULL,
    [account_id]       UNIQUEIDENTIFIER NOT NULL,
    [organization_id]  UNIQUEIDENTIFIER NOT NULL,
    [user_id]          UNIQUEIDENTIFIER NOT NULL,
    [community]        VARCHAR (50)     NOT NULL,
    [series]           VARCHAR (50)     NOT NULL,
    [plan_name]        VARCHAR (50)     NOT NULL,
    [application_name] VARCHAR (50)     NOT NULL,
    [product_name]     VARCHAR (50)     NOT NULL,
    [area]             VARCHAR (100)    NOT NULL,
    [sub_area]         VARCHAR (50)     NOT NULL,
    [item_no]          VARCHAR (100)    NOT NULL,
    [item_name]        VARCHAR (1200)   NOT NULL,
    [qty]              INT              NOT NULL,
    [price]            DECIMAL (18, 2)  NOT NULL,
    [spec_id]          INT              NULL,
    [effective_date]   DATETIME         NULL,
    [plan_version]     VARCHAR (50)     NULL,
    [source]           VARCHAR (50)     NOT NULL,
    [author]           VARCHAR (50)     NOT NULL,
    [create_date]      DATETIME         NOT NULL,
    [modifier]         VARCHAR (50)     NOT NULL,
    [modified_date]    DATETIME         NOT NULL,
    [stamp]            VARCHAR (50)     NOT NULL,
    [auto_number]      INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_account_organization_user_profile_plan_options_budget_items] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_account_product_guide_pages]...';


GO
CREATE TABLE [dbo].[z_account_product_guide_pages] (
    [z_user_name]        VARCHAR (50)     NOT NULL,
    [z_action]           VARCHAR (10)     NOT NULL,
    [z_time]             DATETIME         NOT NULL,
    [page_id]            UNIQUEIDENTIFIER NOT NULL,
    [account_id]         UNIQUEIDENTIFIER NOT NULL,
    [category]           VARCHAR (50)     NOT NULL,
    [product]            VARCHAR (50)     NOT NULL,
    [page_title]         VARCHAR (50)     NOT NULL,
    [page_text]          VARCHAR (2000)   NULL,
    [image_url]          VARCHAR (100)    NOT NULL,
    [category_image_url] VARCHAR (200)    NULL,
    [product_image_url]  VARCHAR (200)    NULL,
    [active]             BIT              NOT NULL,
    [display_sequence]   INT              NULL,
    [application_id]     VARCHAR (50)     NULL,
    [product_id]         VARCHAR (50)     NULL,
    [author]             VARCHAR (50)     NOT NULL,
    [create_date]        DATETIME         NOT NULL,
    [modifier]           VARCHAR (50)     NOT NULL,
    [modified_date]      DATETIME         NOT NULL,
    [stamp]              VARCHAR (50)     NOT NULL,
    [auto_number]        INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_account_product_guide_pages] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_account_product_guide_pages_links]...';


GO
CREATE TABLE [dbo].[z_account_product_guide_pages_links] (
    [z_user_name]      VARCHAR (50)     NOT NULL,
    [z_action]         VARCHAR (10)     NOT NULL,
    [z_time]           DATETIME         NOT NULL,
    [link_id]          UNIQUEIDENTIFIER NOT NULL,
    [page_id]          UNIQUEIDENTIFIER NOT NULL,
    [link_url]         VARCHAR (200)    NOT NULL,
    [link_display]     VARCHAR (100)    NOT NULL,
    [display_sequence] INT              NULL,
    [author]           VARCHAR (50)     NOT NULL,
    [create_date]      DATETIME         NOT NULL,
    [modifier]         VARCHAR (50)     NOT NULL,
    [modified_date]    DATETIME         NOT NULL,
    [stamp]            VARCHAR (50)     NOT NULL,
    [auto_number]      INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_account_product_guide_pages_links] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_account_users_addresses]...';


GO
CREATE TABLE [dbo].[z_account_users_addresses] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [account_id]    UNIQUEIDENTIFIER NOT NULL,
    [user_id]       UNIQUEIDENTIFIER NOT NULL,
    [builder_id]    UNIQUEIDENTIFIER NOT NULL,
    [address]       VARCHAR (50)     NOT NULL,
    [city]          VARCHAR (50)     NOT NULL,
    [state]         VARCHAR (50)     NOT NULL,
    [zip]           VARCHAR (50)     NOT NULL,
    [active]        BIT              NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_account_users_addresses] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_account_users_addresses_wishlist_items]...';


GO
CREATE TABLE [dbo].[z_account_users_addresses_wishlist_items] (
    [z_user_name]      VARCHAR (50)     NOT NULL,
    [z_action]         VARCHAR (10)     NOT NULL,
    [z_time]           DATETIME         NOT NULL,
    [account_id]       UNIQUEIDENTIFIER NOT NULL,
    [user_id]          UNIQUEIDENTIFIER NOT NULL,
    [builder_id]       UNIQUEIDENTIFIER NOT NULL,
    [address]          VARCHAR (50)     NOT NULL,
    [wishlist_item_id] UNIQUEIDENTIFIER NOT NULL,
    [item_type]        VARCHAR (50)     NOT NULL,
    [item_no]          VARCHAR (81)     NOT NULL,
    [notes]            VARCHAR (MAX)    NOT NULL,
    [author]           VARCHAR (50)     NOT NULL,
    [create_date]      DATETIME         NOT NULL,
    [modifier]         VARCHAR (50)     NOT NULL,
    [modified_date]    DATETIME         NOT NULL,
    [stamp]            VARCHAR (50)     NOT NULL,
    [gpc_id]           VARCHAR (50)     NOT NULL,
    [auto_number]      INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_account_users_addresses_wishlist_items] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_address_types]...';


GO
CREATE TABLE [dbo].[z_address_types] (
    [z_user_name]   VARCHAR (50)  NOT NULL,
    [z_action]      VARCHAR (10)  NOT NULL,
    [z_time]        DATETIME      NOT NULL,
    [address_type]  NVARCHAR (50) NOT NULL,
    [author]        VARCHAR (50)  NOT NULL,
    [create_date]   DATETIME      NOT NULL,
    [modifier]      VARCHAR (50)  NOT NULL,
    [modified_date] DATETIME      NOT NULL,
    [stamp]         VARCHAR (50)  NOT NULL,
    [auto_number]   INT           IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_address_types] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_addresses]...';


GO
CREATE TABLE [dbo].[z_addresses] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [address_id]    UNIQUEIDENTIFIER NOT NULL,
    [address_type]  NVARCHAR (20)    NULL,
    [address]       NVARCHAR (50)    NULL,
    [city]          NVARCHAR (50)    NULL,
    [state]         NVARCHAR (50)    NULL,
    [postal_code]   NVARCHAR (10)    NULL,
    [country_code]  NVARCHAR (5)     NULL,
    [phone1]        NVARCHAR (20)    NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_addresses] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_builder_bom_modification_types]...';


GO
CREATE TABLE [dbo].[z_builder_bom_modification_types] (
    [z_user_name]   VARCHAR (50) NOT NULL,
    [z_action]      VARCHAR (10) NOT NULL,
    [z_time]        DATETIME     NOT NULL,
    [id]            INT          NOT NULL,
    [name]          VARCHAR (25) NOT NULL,
    [author]        VARCHAR (50) NOT NULL,
    [create_date]   DATETIME     NOT NULL,
    [modifier]      VARCHAR (50) NOT NULL,
    [modified_date] DATETIME     NOT NULL,
    [stamp]         VARCHAR (50) NOT NULL,
    [auto_number]   INT          IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_builder_bom_modification_types] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_builder_features]...';


GO
CREATE TABLE [dbo].[z_builder_features] (
    [z_user_name]     VARCHAR (100)    NOT NULL,
    [z_action]        VARCHAR (10)     NOT NULL,
    [z_time]          DATETIME         NOT NULL,
    [organization_id] UNIQUEIDENTIFIER NOT NULL,
    [feature_id]      INT              NOT NULL,
    [value]           BIT              NOT NULL,
    [author]          VARCHAR (100)    NOT NULL,
    [create_date]     DATETIME         NOT NULL,
    [modifier]        VARCHAR (100)    NOT NULL,
    [modified_date]   DATETIME         NOT NULL,
    [stamp]           VARCHAR (50)     NOT NULL,
    [auto_number]     INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_builder_features] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_builder_plan_budget_values_community_defaults]...';


GO
CREATE TABLE [dbo].[z_builder_plan_budget_values_community_defaults] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [builder_id]    UNIQUEIDENTIFIER NOT NULL,
    [community_id]  UNIQUEIDENTIFIER NOT NULL,
    [name_id]       INT              NOT NULL,
    [value]         DECIMAL (18, 2)  NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_builder_plan_budget_values_community_defaults] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_builder_plan_budget_values_settings]...';


GO
CREATE TABLE [dbo].[z_builder_plan_budget_values_settings] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [builder_id]    UNIQUEIDENTIFIER NOT NULL,
    [name_id]       INT              NOT NULL,
    [enabled]       BIT              NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_builder_plan_budget_values_settings] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_catalog_selections]...';


GO
CREATE TABLE [dbo].[z_catalog_selections] (
    [z_user_name]            VARCHAR (50)     NOT NULL,
    [z_action]               VARCHAR (10)     NOT NULL,
    [z_time]                 DATETIME         NOT NULL,
    [session_id]             UNIQUEIDENTIFIER NOT NULL,
    [row_id]                 UNIQUEIDENTIFIER NOT NULL,
    [account_id]             UNIQUEIDENTIFIER NULL,
    [organization_id]        UNIQUEIDENTIFIER NOT NULL,
    [community]              VARCHAR (100)    NOT NULL,
    [series]                 VARCHAR (100)    NOT NULL,
    [plan]                   VARCHAR (100)    NOT NULL,
    [application]            VARCHAR (100)    NOT NULL,
    [product]                VARCHAR (100)    NOT NULL,
    [area]                   VARCHAR (100)    NOT NULL,
    [area_id]                VARCHAR (20)     NOT NULL,
    [sub_area]               VARCHAR (100)    NOT NULL,
    [sub_area_id]            VARCHAR (20)     NOT NULL,
    [item_type]              VARCHAR (50)     NOT NULL,
    [item_no]                VARCHAR (100)    NOT NULL,
    [item]                   VARCHAR (MAX)    NOT NULL,
    [vendor]                 VARCHAR (100)    NOT NULL,
    [standard]               VARCHAR (200)    NOT NULL,
    [qty]                    DECIMAL (18, 4)  NOT NULL,
    [cost]                   DECIMAL (18, 2)  NOT NULL,
    [price]                  DECIMAL (18, 2)  NULL,
    [selected]               BIT              NULL,
    [notes]                  VARCHAR (MAX)    NOT NULL,
    [option_pricing_display] BIT              NOT NULL,
    [mutually_exclusive]     BIT              NOT NULL,
    [build_data]             VARBINARY (MAX)  NULL,
    [original_build_data]    VARBINARY (MAX)  NULL,
    [source]                 VARCHAR (20)     NOT NULL,
    [build_id]               INT              NOT NULL,
    [gpc]                    VARCHAR (MAX)    NULL,
    [model]                  VARCHAR (100)    NULL,
    [make_std]               BIT              NOT NULL,
    [is_credit]              BIT              NOT NULL,
    [option_id]              VARCHAR (100)    NULL,
    [stage]                  VARCHAR (100)    NULL,
    [author]                 VARCHAR (50)     NOT NULL,
    [create_date]            DATETIME         NOT NULL,
    [modifier]               VARCHAR (50)     NOT NULL,
    [modified_date]          DATETIME         NOT NULL,
    [stamp]                  VARCHAR (50)     NOT NULL,
    [auto_number]            INT              IDENTITY (1, 1) NOT NULL,
    [is_package]             BIT              NULL,
    CONSTRAINT [PK_z_catalog_selections] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_catalog_selections_area_bom_modifications]...';


GO
CREATE TABLE [dbo].[z_catalog_selections_area_bom_modifications] (
    [z_user_name]                 VARCHAR (50)     NOT NULL,
    [z_action]                    VARCHAR (10)     NOT NULL,
    [z_time]                      DATETIME         NOT NULL,
    [session_id]                  UNIQUEIDENTIFIER NOT NULL,
    [build_id]                    BIGINT           NOT NULL,
    [session_bom_modification_id] UNIQUEIDENTIFIER NOT NULL,
    [quantity]                    DECIMAL (18, 4)  NOT NULL,
    [price]                       DECIMAL (18, 2)  NOT NULL,
    [notes]                       VARCHAR (MAX)    NULL,
    [author]                      VARCHAR (50)     NOT NULL,
    [create_date]                 DATETIME         NOT NULL,
    [modifier]                    VARCHAR (50)     NOT NULL,
    [modified_date]               DATETIME         NOT NULL,
    [stamp]                       VARCHAR (50)     NOT NULL,
    [auto_number]                 INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_catalog_selections_area_bom_modifications] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_catalog_selections_area_detail_options]...';


GO
CREATE TABLE [dbo].[z_catalog_selections_area_detail_options] (
    [z_user_name]            VARCHAR (50)     NOT NULL,
    [z_action]               VARCHAR (10)     NOT NULL,
    [z_time]                 DATETIME         NOT NULL,
    [session_id]             UNIQUEIDENTIFIER NOT NULL,
    [application]            VARCHAR (100)    NOT NULL,
    [product]                VARCHAR (100)    NOT NULL,
    [area]                   VARCHAR (100)    NOT NULL,
    [sub_area]               VARCHAR (100)    NOT NULL,
    [item_type]              VARCHAR (20)     NOT NULL,
    [item_id]                VARCHAR (50)     NOT NULL,
    [option_id]              VARCHAR (50)     NOT NULL,
    [option_value]           VARCHAR (50)     NOT NULL,
    [option_source]          VARCHAR (50)     NOT NULL,
    [included]               BIT              NOT NULL,
    [qty]                    INT              NULL,
    [price]                  DECIMAL (18, 2)  NULL,
    [price_retail]           DECIMAL (18, 2)  NULL,
    [retail_percentage]      DECIMAL (18, 2)  NULL,
    [retail_percentage_type] VARCHAR (10)     NULL,
    [price_type]             VARCHAR (10)     NULL,
    [pricing_source]         VARCHAR (50)     NULL,
    [error_message]          VARCHAR (MAX)    NULL,
    [author]                 VARCHAR (50)     NOT NULL,
    [create_date]            DATETIME         NOT NULL,
    [modifier]               VARCHAR (50)     NOT NULL,
    [modified_date]          DATETIME         NOT NULL,
    [stamp]                  VARCHAR (50)     NOT NULL,
    [auto_number]            INT              IDENTITY (1, 1) NOT NULL,
    [alloc_qty]              INT              NULL,
    CONSTRAINT [PK_z_catalog_selections_area_detail_options] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_catalog_selections_area_details]...';


GO
CREATE TABLE [dbo].[z_catalog_selections_area_details] (
    [z_user_name]            VARCHAR (50)     NOT NULL,
    [z_action]               VARCHAR (10)     NOT NULL,
    [z_time]                 DATETIME         NOT NULL,
    [session_id]             UNIQUEIDENTIFIER NOT NULL,
    [application]            VARCHAR (100)    NOT NULL,
    [product]                VARCHAR (100)    NOT NULL,
    [area]                   VARCHAR (100)    NOT NULL,
    [sub_area]               VARCHAR (100)    NOT NULL,
    [item_type]              VARCHAR (20)     NOT NULL,
    [item_id]                VARCHAR (50)     NOT NULL,
    [selectable]             BIT              NOT NULL,
    [bom_real_item_id]       VARCHAR (50)     NOT NULL,
    [real_item_id]           VARCHAR (50)     NOT NULL,
    [bom_bill_qty]           DECIMAL (18, 4)  NOT NULL,
    [bill_qty]               DECIMAL (18, 4)  NOT NULL,
    [alloc_qty]              DECIMAL (18, 4)  NOT NULL,
    [credit_qty]             DECIMAL (18, 4)  NOT NULL,
    [bom_uom_id]             VARCHAR (9)      NOT NULL,
    [uom_id]                 VARCHAR (9)      NOT NULL,
    [builder_price]          DECIMAL (18, 2)  NOT NULL,
    [homeowner_price]        DECIMAL (18, 2)  NOT NULL,
    [pattern_id]             INT              NOT NULL,
    [is_pattern_item]        BIT              NOT NULL,
    [pattern_percentage]     DECIMAL (18, 4)  NOT NULL,
    [force_reprice]          BIT              NOT NULL,
    [price_type]             VARCHAR (25)     NOT NULL,
    [price_source]           VARCHAR (25)     NOT NULL,
    [retail_percentage]      DECIMAL (18, 4)  NOT NULL,
    [retail_percentage_type] VARCHAR (10)     NOT NULL,
    [accent_prompt]          VARCHAR (20)     NOT NULL,
    [priced]                 BIT              NOT NULL,
    [bom_item_id]            VARCHAR (50)     NOT NULL,
    [author]                 VARCHAR (50)     NOT NULL,
    [create_date]            DATETIME         NOT NULL,
    [modifier]               VARCHAR (50)     NOT NULL,
    [modified_date]          DATETIME         NOT NULL,
    [stamp]                  VARCHAR (50)     NOT NULL,
    [auto_number]            INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_catalog_selections_area_details] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_catalog_selections_area_details_lay_directions]...';


GO
CREATE TABLE [dbo].[z_catalog_selections_area_details_lay_directions] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [session_id]    UNIQUEIDENTIFIER NOT NULL,
    [application]   VARCHAR (100)    NOT NULL,
    [product]       VARCHAR (100)    NOT NULL,
    [area]          VARCHAR (100)    NOT NULL,
    [sub_area]      VARCHAR (100)    NOT NULL,
    [item_type]     VARCHAR (20)     NOT NULL,
    [item_id]       VARCHAR (50)     NOT NULL,
    [rotate_degree] INT              NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_catalog_selections_area_details_lay_directions] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_catalog_selections_area_properties]...';


GO
CREATE TABLE [dbo].[z_catalog_selections_area_properties] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [id]            UNIQUEIDENTIFIER NOT NULL,
    [session_id]    UNIQUEIDENTIFIER NOT NULL,
    [build_id]      INT              NOT NULL,
    [key]           VARCHAR (50)     NOT NULL,
    [value]         VARCHAR (MAX)    NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_catalog_selections_area_properties] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_catalog_selections_area_slabs]...';


GO
CREATE TABLE [dbo].[z_catalog_selections_area_slabs] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [row_id]        UNIQUEIDENTIFIER NOT NULL,
    [session_id]    UNIQUEIDENTIFIER NOT NULL,
    [build_id]      INT              NOT NULL,
    [slab_id]       VARCHAR (100)    NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_catalog_selections_area_slabs] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_catalog_selections_areas]...';


GO
CREATE TABLE [dbo].[z_catalog_selections_areas] (
    [z_user_name]          VARCHAR (50)     NOT NULL,
    [z_action]             VARCHAR (10)     NOT NULL,
    [z_time]               DATETIME         NOT NULL,
    [session_id]           UNIQUEIDENTIFIER NOT NULL,
    [application]          VARCHAR (100)    NOT NULL,
    [product]              VARCHAR (100)    NOT NULL,
    [area]                 VARCHAR (100)    NOT NULL,
    [sub_area]             VARCHAR (100)    NOT NULL,
    [area_id]              VARCHAR (25)     NOT NULL,
    [sub_area_id]          VARCHAR (25)     NOT NULL,
    [selected]             INT              NOT NULL,
    [notes]                VARCHAR (MAX)    NOT NULL,
    [original_build_data]  VARBINARY (MAX)  NULL,
    [selection_total]      DECIMAL (18, 2)  NOT NULL,
    [selected_field_group] UNIQUEIDENTIFIER NULL,
    [pattern_id]           INT              NOT NULL,
    [area_selected]        BIT              NOT NULL,
    [build_id]             INT              NOT NULL,
    [author]               VARCHAR (50)     NOT NULL,
    [create_date]          DATETIME         NOT NULL,
    [modifier]             VARCHAR (50)     NOT NULL,
    [modified_date]        DATETIME         NOT NULL,
    [stamp]                VARCHAR (50)     NOT NULL,
    [auto_number]          INT              IDENTITY (1, 1) NOT NULL,
    [location_id]          INT              NULL,
    [location]             VARCHAR (50)     NULL,
    CONSTRAINT [PK_z_catalog_selections_areas] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_catalog_selections_bom_modifications]...';


GO
CREATE TABLE [dbo].[z_catalog_selections_bom_modifications] (
    [z_user_name]            VARCHAR (50)     NOT NULL,
    [z_action]               VARCHAR (10)     NOT NULL,
    [z_time]                 DATETIME         NOT NULL,
    [id]                     UNIQUEIDENTIFIER NOT NULL,
    [session_id]             UNIQUEIDENTIFIER NOT NULL,
    [application_id]         VARCHAR (10)     NULL,
    [product_id]             VARCHAR (10)     NULL,
    [area_id]                VARCHAR (10)     NULL,
    [sub_area_id]            VARCHAR (10)     NULL,
    [item_code]              VARCHAR (100)    NULL,
    [item]                   VARCHAR (MAX)    NOT NULL,
    [vendor]                 VARCHAR (100)    NULL,
    [modification_type]      INT              NOT NULL,
    [quantity]               DECIMAL (18, 4)  NOT NULL,
    [price]                  DECIMAL (18, 2)  NOT NULL,
    [cost]                   DECIMAL (18, 2)  NULL,
    [notes]                  VARCHAR (MAX)    NULL,
    [gpc]                    UNIQUEIDENTIFIER NULL,
    [option_pricing_display] BIT              NOT NULL,
    [author]                 VARCHAR (50)     NOT NULL,
    [create_date]            DATETIME         NOT NULL,
    [modifier]               VARCHAR (50)     NOT NULL,
    [modified_date]          DATETIME         NOT NULL,
    [stamp]                  VARCHAR (50)     NOT NULL,
    [auto_number]            INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_catalog_selections_bom_modifications] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_catalog_selections_group_detail]...';


GO
CREATE TABLE [dbo].[z_catalog_selections_group_detail] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [session_id]    UNIQUEIDENTIFIER NOT NULL,
    [group_id]      INT              NOT NULL,
    [item_type]     VARCHAR (10)     NOT NULL,
    [item]          VARCHAR (81)     NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    [area_id]       VARCHAR (10)     NULL,
    [sub_area_id]   VARCHAR (10)     NULL,
    CONSTRAINT [PK_z_catalog_selections_group_detail] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_commission_rates]...';


GO
CREATE TABLE [dbo].[z_commission_rates] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [designer]      UNIQUEIDENTIFIER NOT NULL,
    [start_date]    DATE             NOT NULL,
    [rate]          DECIMAL (18, 4)  NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         ROWVERSION       NOT NULL,
    [auto_number]   INT              NOT NULL,
    CONSTRAINT [PK_z_commission_rates] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_default_support_emails]...';


GO
CREATE TABLE [dbo].[z_default_support_emails] (
    [z_user_name]   VARCHAR (50)  NOT NULL,
    [z_action]      VARCHAR (10)  NOT NULL,
    [z_time]        DATETIME      NOT NULL,
    [email_key]     VARCHAR (50)  NOT NULL,
    [email]         VARCHAR (200) NOT NULL,
    [author]        VARCHAR (50)  NOT NULL,
    [create_date]   DATETIME      NOT NULL,
    [modifier]      VARCHAR (50)  NOT NULL,
    [modified_date] DATETIME      NOT NULL,
    [stamp]         VARCHAR (50)  NOT NULL,
    [auto_number]   INT           IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_default_support_emails] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_designer_assigned_applications]...';


GO
CREATE TABLE [dbo].[z_designer_assigned_applications] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [id]            INT              NOT NULL,
    [user_id]       UNIQUEIDENTIFIER NOT NULL,
    [application]   VARCHAR (100)    NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_designer_assigned_applications] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_features]...';


GO
CREATE TABLE [dbo].[z_features] (
    [z_user_name]   VARCHAR (50)   NOT NULL,
    [z_action]      VARCHAR (10)   NOT NULL,
    [z_time]        DATETIME       NOT NULL,
    [id]            INT            NOT NULL,
    [lookup_key]    VARCHAR (50)   NOT NULL,
    [description]   VARCHAR (3000) NOT NULL,
    [author]        VARCHAR (50)   NOT NULL,
    [create_date]   DATETIME       NOT NULL,
    [modifier]      VARCHAR (50)   NOT NULL,
    [modified_date] DATETIME       NOT NULL,
    [stamp]         VARCHAR (50)   NOT NULL,
    [auto_number]   INT            IDENTITY (1, 1) NOT NULL,
    [name]          VARCHAR (200)  NOT NULL,
    [group_name]    VARCHAR (50)   NULL,
    CONSTRAINT [PK_z_features] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_floorplans_sequence]...';


GO
CREATE TABLE [dbo].[z_floorplans_sequence] (
    [z_user_name]     VARCHAR (50)     NOT NULL,
    [z_action]        VARCHAR (10)     NOT NULL,
    [z_time]          DATETIME         NOT NULL,
    [profile_plan_id] UNIQUEIDENTIFIER NOT NULL,
    [sequence]        NVARCHAR (MAX)   NULL,
    [author]          VARCHAR (50)     NOT NULL,
    [create_date]     DATETIME         NOT NULL,
    [modifier]        VARCHAR (50)     NOT NULL,
    [modified_date]   DATETIME         NOT NULL,
    [stamp]           VARCHAR (50)     NOT NULL,
    [auto_number]     INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_floorplans_sequence] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_homebuyer_catalog_estimated_selections]...';


GO
CREATE TABLE [dbo].[z_homebuyer_catalog_estimated_selections] (
    [z_user_name]        VARCHAR (50)     NOT NULL,
    [z_action]           VARCHAR (10)     NOT NULL,
    [z_time]             DATETIME         NOT NULL,
    [id]                 BIGINT           NOT NULL,
    [session_id]         UNIQUEIDENTIFIER NOT NULL,
    [application_id]     VARCHAR (10)     NOT NULL,
    [product_id]         VARCHAR (5)      NOT NULL,
    [area_id]            VARCHAR (25)     NOT NULL,
    [sub_area_id]        VARCHAR (25)     NOT NULL,
    [build_id]           INT              NOT NULL,
    [price_level_type]   VARCHAR (50)     NOT NULL,
    [price_level_id]     VARCHAR (100)    NOT NULL,
    [selected_option_id] VARCHAR (50)     NOT NULL,
    [author]             VARCHAR (50)     NOT NULL,
    [create_date]        DATETIME         NOT NULL,
    [modifier]           VARCHAR (50)     NOT NULL,
    [modified_date]      DATETIME         NOT NULL,
    [stamp]              VARCHAR (50)     NOT NULL,
    [auto_number]        INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_homebuyer_catalog_estimated_selections] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_homebuyer_catalog_nonestimated_selections]...';


GO
CREATE TABLE [dbo].[z_homebuyer_catalog_nonestimated_selections] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [id]            BIGINT           NOT NULL,
    [session_id]    UNIQUEIDENTIFIER NOT NULL,
    [row_id]        UNIQUEIDENTIFIER NOT NULL,
    [quantity]      INT              NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_homebuyer_catalog_nonestimated_selections] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_homebuyer_catalog_price_level_filters]...';


GO
CREATE TABLE [dbo].[z_homebuyer_catalog_price_level_filters] (
    [z_user_name]    VARCHAR (50)     NOT NULL,
    [z_action]       VARCHAR (10)     NOT NULL,
    [z_time]         DATETIME         NOT NULL,
    [id]             UNIQUEIDENTIFIER NOT NULL,
    [session_id]     UNIQUEIDENTIFIER NOT NULL,
    [room_id]        UNIQUEIDENTIFIER NOT NULL,
    [application_id] VARCHAR (10)     NOT NULL,
    [product_id]     VARCHAR (5)      NOT NULL,
    [item_no]        VARCHAR (50)     NOT NULL,
    [author]         VARCHAR (50)     NOT NULL,
    [create_date]    DATETIME         NOT NULL,
    [modifier]       VARCHAR (50)     NOT NULL,
    [modified_date]  DATETIME         NOT NULL,
    [stamp]          VARCHAR (50)     NOT NULL,
    [auto_number]    INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_homebuyer_catalog_price_level_filters] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_homebuyer_orientation]...';


GO
CREATE TABLE [dbo].[z_homebuyer_orientation] (
    [z_user_name]    VARCHAR (50)     NOT NULL,
    [z_action]       VARCHAR (10)     NOT NULL,
    [z_time]         DATETIME         NOT NULL,
    [row_id]         UNIQUEIDENTIFIER NOT NULL,
    [user_id]        UNIQUEIDENTIFIER NOT NULL,
    [object_type]    NVARCHAR (100)   NOT NULL,
    [schema_version] NVARCHAR (10)    NOT NULL,
    [object_data]    NVARCHAR (MAX)   NOT NULL,
    [author]         VARCHAR (50)     NOT NULL,
    [create_date]    DATETIME         NOT NULL,
    [modifier]       VARCHAR (50)     NOT NULL,
    [modified_date]  DATETIME         NOT NULL,
    [stamp]          VARCHAR (50)     NOT NULL,
    [auto_number]    INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_homebuyer_orientation] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_invoice_lines]...';


GO
CREATE TABLE [dbo].[z_invoice_lines] (
    [z_user_name]      VARCHAR (50)    NOT NULL,
    [z_action]         VARCHAR (10)    NOT NULL,
    [z_time]           DATETIME        NOT NULL,
    [invoice_id]       INT             NOT NULL,
    [line_no]          INT             NOT NULL,
    [application]      VARCHAR (50)    NOT NULL,
    [product]          VARCHAR (50)    NOT NULL,
    [area]             VARCHAR (255)   NOT NULL,
    [item]             VARCHAR (255)   NOT NULL,
    [vendor]           VARCHAR (50)    NOT NULL,
    [line_amount]      DECIMAL (18, 2) NOT NULL,
    [orig_line_amount] DECIMAL (18, 2) NOT NULL,
    [invoice]          BIT             NOT NULL,
    [invoice_amount]   DECIMAL (18, 2) NOT NULL,
    [notes]            VARCHAR (MAX)   NOT NULL,
    [author]           VARCHAR (50)    NULL,
    [create_date]      DATETIME        NULL,
    [modifier]         VARCHAR (50)    NULL,
    [modified_date]    DATETIME        NULL,
    [stamp]            VARCHAR (50)    NULL,
    [auto_number]      INT             IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_invoice_lines] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_invoices]...';


GO
CREATE TABLE [dbo].[z_invoices] (
    [z_user_name]                VARCHAR (50)     NOT NULL,
    [z_action]                   VARCHAR (10)     NOT NULL,
    [z_time]                     DATETIME         NOT NULL,
    [invoice_id]                 INT              NOT NULL,
    [reference_id]               UNIQUEIDENTIFIER NOT NULL,
    [reference_type]             VARCHAR (50)     NOT NULL,
    [invoice_no]                 VARCHAR (100)    NULL,
    [invoice_date]               DATETIME         NULL,
    [invoice_template]           VARCHAR (50)     NULL,
    [invoice_customer_id]        VARCHAR (50)     NULL,
    [invoice_customer_desc]      VARCHAR (100)    NULL,
    [invoice_po]                 VARCHAR (100)    NULL,
    [invoice_status]             VARCHAR (10)     NULL,
    [invoice_ratio]              DECIMAL (18, 4)  NULL,
    [amount]                     DECIMAL (18, 2)  NULL,
    [external_invoice_reference] VARCHAR (50)     NULL,
    [last_print_date]            DATETIME         NULL,
    [invoice_module]             VARCHAR (20)     NULL,
    [invoice_module_data]        VARCHAR (300)    NULL,
    [invoice_notes]              TEXT             NULL,
    [author]                     VARCHAR (50)     NOT NULL,
    [create_date]                DATETIME         NOT NULL,
    [modifier]                   VARCHAR (50)     NOT NULL,
    [modified_date]              DATETIME         NOT NULL,
    [stamp]                      VARCHAR (50)     NOT NULL,
    [auto_number]                INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_invoices] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_jobs_stages]...';


GO
CREATE TABLE [dbo].[z_jobs_stages] (
    [z_user_name]                VARCHAR (50)     NOT NULL,
    [z_action]                   VARCHAR (10)     NOT NULL,
    [z_time]                     DATETIME         NOT NULL,
    [id]                         UNIQUEIDENTIFIER NOT NULL,
    [account_org_id]             UNIQUEIDENTIFIER NOT NULL,
    [job_no]                     VARCHAR (20)     NOT NULL,
    [stage_id]                   VARCHAR (10)     NULL,
    [stage_name]                 VARCHAR (100)    NOT NULL,
    [stage_date]                 DATETIME         NOT NULL,
    [stage_date_override]        DATETIME         NULL,
    [stage_date_override_author] VARCHAR (50)     NULL,
    [author]                     VARCHAR (50)     NOT NULL,
    [create_date]                DATETIME         NOT NULL,
    [modifier]                   VARCHAR (50)     NOT NULL,
    [modified_date]              DATETIME         NOT NULL,
    [stamp]                      VARCHAR (50)     NOT NULL,
    [auto_number]                INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_jobs_stages] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_plan_budget]...';


GO
CREATE TABLE [dbo].[z_plan_budget] (
    [z_user_name]             VARCHAR (50)     NOT NULL,
    [z_action]                VARCHAR (10)     NOT NULL,
    [z_time]                  DATETIME         NOT NULL,
    [id]                      UNIQUEIDENTIFIER NOT NULL,
    [user_id]                 UNIQUEIDENTIFIER NOT NULL,
    [plan_id]                 UNIQUEIDENTIFIER NOT NULL,
    [upgrade_budget]          DECIMAL (18, 2)  NOT NULL,
    [monthly_payment_home]    DECIMAL (18, 2)  NOT NULL,
    [monthly_payment_upgrade] DECIMAL (18, 2)  NOT NULL,
    [monthly_payment_total]   DECIMAL (18, 2)  NOT NULL,
    [author]                  VARCHAR (50)     NOT NULL,
    [create_date]             DATETIME         NOT NULL,
    [modifier]                VARCHAR (50)     NOT NULL,
    [modified_date]           DATETIME         NOT NULL,
    [stamp]                   BINARY (8)       NOT NULL,
    [auto_number]             INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_plan_budget] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_plan_budget_values]...';


GO
CREATE TABLE [dbo].[z_plan_budget_values] (
    [z_user_name]    VARCHAR (50)     NOT NULL,
    [z_action]       VARCHAR (10)     NOT NULL,
    [z_time]         DATETIME         NOT NULL,
    [id]             UNIQUEIDENTIFIER NOT NULL,
    [plan_budget_id] UNIQUEIDENTIFIER NOT NULL,
    [name_id]        INT              NOT NULL,
    [value]          DECIMAL (18, 2)  NOT NULL,
    [author]         VARCHAR (50)     NOT NULL,
    [create_date]    DATETIME         NOT NULL,
    [modifier]       VARCHAR (50)     NOT NULL,
    [modified_date]  DATETIME         NOT NULL,
    [stamp]          BINARY (8)       NOT NULL,
    [auto_number]    INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_plan_budget_values] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_plan_budget_values_names]...';


GO
CREATE TABLE [dbo].[z_plan_budget_values_names] (
    [z_user_name]        VARCHAR (50)  NOT NULL,
    [z_action]           VARCHAR (10)  NOT NULL,
    [z_time]             DATETIME      NOT NULL,
    [id]                 INT           NOT NULL,
    [name]               VARCHAR (100) NOT NULL,
    [data_type]          VARCHAR (20)  NOT NULL,
    [required]           BIT           NOT NULL,
    [enabled_by_default] BIT           NOT NULL,
    [community_default]  BIT           NOT NULL,
    [author]             VARCHAR (50)  NOT NULL,
    [create_date]        DATETIME      NOT NULL,
    [modifier]           VARCHAR (50)  NOT NULL,
    [modified_date]      DATETIME      NOT NULL,
    [stamp]              BINARY (8)    NOT NULL,
    [auto_number]        INT           IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_plan_budget_values_names] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_plan_document_types]...';


GO
CREATE TABLE [dbo].[z_plan_document_types] (
    [z_user_name]   VARCHAR (50)   NOT NULL,
    [z_action]      VARCHAR (10)   NOT NULL,
    [z_time]        DATETIME       NOT NULL,
    [doc_type]      NVARCHAR (25)  NOT NULL,
    [description]   NVARCHAR (500) NOT NULL,
    [author]        VARCHAR (50)   NOT NULL,
    [create_date]   DATETIME       NOT NULL,
    [modifier]      VARCHAR (50)   NOT NULL,
    [modified_date] DATETIME       NOT NULL,
    [stamp]         VARCHAR (50)   NOT NULL,
    [auto_number]   INT            IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_plan_document_types] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_primary_plan_catalogs]...';


GO
CREATE TABLE [dbo].[z_primary_plan_catalogs] (
    [z_user_name]        VARCHAR (50)     NOT NULL,
    [z_action]           VARCHAR (10)     NOT NULL,
    [z_time]             DATETIME         NOT NULL,
    [session_id]         UNIQUEIDENTIFIER NOT NULL,
    [profile_plan_id]    UNIQUEIDENTIFIER NOT NULL,
    [author]             VARCHAR (50)     NOT NULL,
    [create_date]        DATETIME         NOT NULL,
    [modifier]           VARCHAR (50)     NOT NULL,
    [modified_date]      DATETIME         NOT NULL,
    [stamp]              VARCHAR (50)     NOT NULL,
    [auto_number]        INT              IDENTITY (1, 1) NOT NULL,
    [first_visit_to_dmh] BIT              NULL,
    CONSTRAINT [PK_z_primary_plan_catalogs] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_problem_types]...';


GO
CREATE TABLE [dbo].[z_problem_types] (
    [z_user_name]   VARCHAR (50)   NOT NULL,
    [z_action]      VARCHAR (10)   NOT NULL,
    [z_time]        DATETIME       NOT NULL,
    [type_id]       INT            NOT NULL,
    [name]          VARCHAR (8000) NOT NULL,
    [author]        VARCHAR (50)   NOT NULL,
    [create_date]   DATETIME       NOT NULL,
    [modifier]      VARCHAR (50)   NOT NULL,
    [modified_date] DATETIME       NOT NULL,
    [stamp]         VARCHAR (50)   NOT NULL,
    [auto_number]   INT            IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_problem_types] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_report_storage]...';


GO
CREATE TABLE [dbo].[z_report_storage] (
    [z_user_name]        VARCHAR (50)     NOT NULL,
    [z_action]           VARCHAR (10)     NOT NULL,
    [z_time]             DATETIME         NOT NULL,
    [storage_id]         UNIQUEIDENTIFIER NOT NULL,
    [report_id]          VARCHAR (50)     NOT NULL,
    [report_output_type] VARCHAR (50)     NOT NULL,
    [binary_data]        VARBINARY (MAX)  NOT NULL,
    [author]             VARCHAR (50)     NOT NULL,
    [create_date]        DATETIME         NOT NULL,
    [modifier]           VARCHAR (50)     NOT NULL,
    [modified_date]      DATETIME         NOT NULL,
    [stamp]              VARCHAR (50)     NOT NULL,
    [auto_number]        INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_report_storage] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_restricted_application_product]...';


GO
CREATE TABLE [dbo].[z_restricted_application_product] (
    [z_user_name]     VARCHAR (50)     NOT NULL,
    [z_action]        VARCHAR (10)     NOT NULL,
    [z_time]          DATETIME         NOT NULL,
    [id]              UNIQUEIDENTIFIER NOT NULL,
    [organization_id] UNIQUEIDENTIFIER NOT NULL,
    [application_id]  VARCHAR (10)     NOT NULL,
    [product_id]      VARCHAR (5)      NOT NULL,
    [author]          VARCHAR (50)     NOT NULL,
    [create_date]     DATETIME         NOT NULL,
    [modifier]        VARCHAR (50)     NOT NULL,
    [modified_date]   DATETIME         NOT NULL,
    [stamp]           BINARY (8)       NOT NULL,
    [auto_number]     INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_restricted_application_product] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_room_sections]...';


GO
CREATE TABLE [dbo].[z_room_sections] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [id]            UNIQUEIDENTIFIER NOT NULL,
    [room_id]       UNIQUEIDENTIFIER NOT NULL,
    [area_id]       VARCHAR (10)     NOT NULL,
    [sub_area_id]   VARCHAR (10)     NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         BINARY (8)       NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_room_sections] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_rooms]...';


GO
CREATE TABLE [dbo].[z_rooms] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [id]            UNIQUEIDENTIFIER NOT NULL,
    [name]          VARCHAR (50)     NOT NULL,
    [icon_id]       UNIQUEIDENTIFIER NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         BINARY (8)       NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_rooms] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_appointment_templates]...';


GO
CREATE TABLE [dbo].[z_scheduling_appointment_templates] (
    [z_user_name]    VARCHAR (50)     NOT NULL,
    [z_action]       VARCHAR (10)     NOT NULL,
    [z_time]         DATETIME         NOT NULL,
    [account_org_id] UNIQUEIDENTIFIER NOT NULL,
    [template_id]    UNIQUEIDENTIFIER NOT NULL,
    [template_name]  VARCHAR (100)    NOT NULL,
    [author]         VARCHAR (50)     NOT NULL,
    [create_date]    DATETIME         NOT NULL,
    [modifier]       VARCHAR (50)     NOT NULL,
    [modified_date]  DATETIME         NOT NULL,
    [stamp]          VARCHAR (50)     NOT NULL,
    [auto_number]    INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_appointment_templates] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_appointment_templates_detail]...';


GO
CREATE TABLE [dbo].[z_scheduling_appointment_templates_detail] (
    [z_user_name]             VARCHAR (50)     NOT NULL,
    [z_action]                VARCHAR (10)     NOT NULL,
    [z_time]                  DATETIME         NOT NULL,
    [template_id]             UNIQUEIDENTIFIER NOT NULL,
    [template_appointment_id] UNIQUEIDENTIFIER NOT NULL,
    [appointment_type]        INT              NOT NULL,
    [duration]                INT              NOT NULL,
    [author]                  VARCHAR (50)     NOT NULL,
    [create_date]             DATETIME         NOT NULL,
    [modifier]                VARCHAR (50)     NOT NULL,
    [modified_date]           DATETIME         NOT NULL,
    [stamp]                   VARCHAR (50)     NOT NULL,
    [auto_number]             INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_appointment_templates_detail] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_appointment_types]...';


GO
CREATE TABLE [dbo].[z_scheduling_appointment_types] (
    [z_user_name]      VARCHAR (50)  NOT NULL,
    [z_action]         VARCHAR (10)  NOT NULL,
    [z_time]           DATETIME      NOT NULL,
    [appointment_type] INT           NOT NULL,
    [name]             VARCHAR (100) NOT NULL,
    [abbrev]           VARCHAR (10)  NULL,
    [sort_order]       INT           NULL,
    [author]           VARCHAR (50)  NOT NULL,
    [create_date]      DATETIME      NOT NULL,
    [modifier]         VARCHAR (50)  NOT NULL,
    [modified_date]    DATETIME      NOT NULL,
    [stamp]            VARCHAR (50)  NOT NULL,
    [auto_number]      INT           IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_appointment_types] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_appointments]...';


GO
CREATE TABLE [dbo].[z_scheduling_appointments] (
    [z_user_name]                   VARCHAR (50)     NOT NULL,
    [z_action]                      VARCHAR (10)     NOT NULL,
    [z_time]                        DATETIME         NOT NULL,
    [appointment_id]                UNIQUEIDENTIFIER NOT NULL,
    [buyer_profile_id]              UNIQUEIDENTIFIER NULL,
    [account_org_id]                UNIQUEIDENTIFIER NULL,
    [appointment_template_id]       UNIQUEIDENTIFIER NULL,
    [appointment_type]              INT              NOT NULL,
    [appointment_duration]          INT              NOT NULL,
    [is_scheduled]                  BIT              NULL,
    [is_conflict]                   BIT              NULL,
    [schedule_user_id]              UNIQUEIDENTIFIER NULL,
    [appointment_date]              DATETIME         NULL,
    [start_time]                    TIME (7)         NULL,
    [end_time]                      TIME (7)         NULL,
    [location_id]                   UNIQUEIDENTIFIER NULL,
    [appointment_label]             VARCHAR (200)    NOT NULL,
    [appointment_note]              VARCHAR (200)    NOT NULL,
    [start_time_actual]             TIME (7)         NULL,
    [end_time_actual]               TIME (7)         NULL,
    [is_virtual]                    BIT              NULL,
    [in_design]                     BIT              NULL,
    [design_type]                   UNIQUEIDENTIFIER NULL,
    [author]                        VARCHAR (50)     NOT NULL,
    [create_date]                   DATETIME         NOT NULL,
    [modifier]                      VARCHAR (50)     NOT NULL,
    [modified_date]                 DATETIME         NOT NULL,
    [stamp]                         VARCHAR (50)     NOT NULL,
    [auto_number]                   INT              IDENTITY (1, 1) NOT NULL,
    [confirmation_status]           INT              NULL,
    [is_provisional]                BIT              NULL,
    [provisional_scheduler_user_id] UNIQUEIDENTIFIER NULL,
    CONSTRAINT [PK_z_scheduling_appointments] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_buyers]...';


GO
CREATE TABLE [dbo].[z_scheduling_buyers] (
    [z_user_name]     VARCHAR (50)     NOT NULL,
    [z_action]        VARCHAR (10)     NOT NULL,
    [z_time]          DATETIME         NOT NULL,
    [profile_id]      UNIQUEIDENTIFIER NOT NULL,
    [schedule_status] INT              NULL,
    [buyer_name]      VARCHAR (200)    NULL,
    [received_date]   DATETIME         NULL,
    [is_active]       INT              NULL,
    [author]          VARCHAR (50)     NOT NULL,
    [create_date]     DATETIME         NOT NULL,
    [modifier]        VARCHAR (50)     NOT NULL,
    [modified_date]   DATETIME         NOT NULL,
    [stamp]           VARCHAR (50)     NOT NULL,
    [auto_number]     INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_buyers] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_buyers_contacts]...';


GO
CREATE TABLE [dbo].[z_scheduling_buyers_contacts] (
    [z_user_name]               VARCHAR (50)     NOT NULL,
    [z_action]                  VARCHAR (10)     NOT NULL,
    [z_time]                    DATETIME         NOT NULL,
    [contact_id]                UNIQUEIDENTIFIER NULL,
    [profile_id]                UNIQUEIDENTIFIER NOT NULL,
    [contact_label]             VARCHAR (200)    NOT NULL,
    [is_buyer]                  BIT              NOT NULL,
    [contact_role]              VARCHAR (50)     NULL,
    [email]                     VARCHAR (300)    NULL,
    [mobile_phone]              VARCHAR (20)     NULL,
    [work_phone]                VARCHAR (20)     NULL,
    [home_phone]                VARCHAR (20)     NULL,
    [mobile_phone_send_message] BIT              NULL,
    [work_phone_send_message]   BIT              NULL,
    [home_phone_send_message]   BIT              NULL,
    [fax]                       VARCHAR (20)     NULL,
    [alt1]                      VARCHAR (200)    NULL,
    [alt2]                      VARCHAR (200)    NULL,
    [primary_phone]             VARCHAR (20)     NULL,
    [note]                      VARCHAR (500)    NULL,
    [active]                    BIT              NOT NULL,
    [author]                    VARCHAR (50)     NOT NULL,
    [create_date]               DATETIME         NOT NULL,
    [modifier]                  VARCHAR (50)     NOT NULL,
    [modified_date]             DATETIME         NOT NULL,
    [stamp]                     VARCHAR (50)     NOT NULL,
    [auto_number]               INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_buyers_contacts] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_message_types]...';


GO
CREATE TABLE [dbo].[z_scheduling_message_types] (
    [z_user_name]       VARCHAR (50) NOT NULL,
    [z_action]          VARCHAR (10) NOT NULL,
    [z_time]            DATETIME     NOT NULL,
    [message_type]      INT          NOT NULL,
    [message_type_name] VARCHAR (50) NOT NULL,
    [author]            VARCHAR (50) NOT NULL,
    [create_date]       DATETIME     NOT NULL,
    [modifier]          VARCHAR (50) NOT NULL,
    [modified_date]     DATETIME     NOT NULL,
    [stamp]             VARCHAR (50) NOT NULL,
    [auto_number]       INT          IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_message_types] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_messages]...';


GO
CREATE TABLE [dbo].[z_scheduling_messages] (
    [z_user_name]      VARCHAR (50)     NOT NULL,
    [z_action]         VARCHAR (10)     NOT NULL,
    [z_time]           DATETIME         NOT NULL,
    [message_id]       UNIQUEIDENTIFIER NOT NULL,
    [message_type]     INT              NOT NULL,
    [message_status]   INT              NOT NULL,
    [is_read]          BIT              NOT NULL,
    [message_title]    VARCHAR (100)    NOT NULL,
    [message_priority] INT              NOT NULL,
    [user_id]          UNIQUEIDENTIFIER NULL,
    [buyer_profile_id] UNIQUEIDENTIFIER NULL,
    [appointment_id]   UNIQUEIDENTIFIER NULL,
    [sender_id]        UNIQUEIDENTIFIER NULL,
    [message_body]     VARCHAR (1000)   NULL,
    [completion_date]  DATETIME         NULL,
    [dismissed]        BIT              NOT NULL,
    [tags]             VARCHAR (100)    NULL,
    [author]           VARCHAR (50)     NOT NULL,
    [create_date]      DATETIME         NOT NULL,
    [modifier]         VARCHAR (50)     NOT NULL,
    [modified_date]    DATETIME         NOT NULL,
    [stamp]            VARCHAR (50)     NOT NULL,
    [auto_number]      INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_messages] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_organization_appointment_templates]...';


GO
CREATE TABLE [dbo].[z_scheduling_organization_appointment_templates] (
    [z_user_name]             VARCHAR (50)     NOT NULL,
    [z_action]                VARCHAR (10)     NOT NULL,
    [z_time]                  DATETIME         NOT NULL,
    [account_org_id]          UNIQUEIDENTIFIER NOT NULL,
    [template_id]             UNIQUEIDENTIFIER NOT NULL,
    [template_appointment_id] UNIQUEIDENTIFIER NOT NULL,
    [appointment_type]        INT              NOT NULL,
    [duration]                INT              NOT NULL,
    [author]                  VARCHAR (50)     NOT NULL,
    [create_date]             DATETIME         NOT NULL,
    [modifier]                VARCHAR (50)     NOT NULL,
    [modified_date]           DATETIME         NOT NULL,
    [stamp]                   VARCHAR (50)     NOT NULL,
    [auto_number]             INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_organization_appointment_templates] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_organizations]...';


GO
CREATE TABLE [dbo].[z_scheduling_organizations] (
    [z_user_name]         VARCHAR (50)     NOT NULL,
    [z_action]            VARCHAR (10)     NOT NULL,
    [z_time]              DATETIME         NOT NULL,
    [account_org_id]      UNIQUEIDENTIFIER NOT NULL,
    [display_name]        VARCHAR (50)     NULL,
    [display_hours_start] DATETIME         NULL,
    [display_hours_end]   DATETIME         NULL,
    [excluded_designers]  NVARCHAR (500)   NULL,
    [email_cc]            VARCHAR (500)    NULL,
    [author]              VARCHAR (50)     NOT NULL,
    [create_date]         DATETIME         NOT NULL,
    [modifier]            VARCHAR (50)     NOT NULL,
    [modified_date]       DATETIME         NOT NULL,
    [stamp]               VARCHAR (50)     NOT NULL,
    [auto_number]         INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_organizations] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_roles]...';


GO
CREATE TABLE [dbo].[z_scheduling_roles] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [role_id]       UNIQUEIDENTIFIER NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_roles] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_status]...';


GO
CREATE TABLE [dbo].[z_scheduling_status] (
    [z_user_name]   VARCHAR (50)  NOT NULL,
    [z_action]      VARCHAR (10)  NOT NULL,
    [z_time]        DATETIME      NOT NULL,
    [status_id]     INT           NOT NULL,
    [status]        VARCHAR (100) NULL,
    [author]        VARCHAR (50)  NOT NULL,
    [create_date]   DATETIME      NOT NULL,
    [modifier]      VARCHAR (50)  NOT NULL,
    [modified_date] DATETIME      NOT NULL,
    [stamp]         VARCHAR (50)  NOT NULL,
    [auto_number]   INT           IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_status] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_user_locations]...';


GO
CREATE TABLE [dbo].[z_scheduling_user_locations] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [user_id]       UNIQUEIDENTIFIER NOT NULL,
    [location_id]   UNIQUEIDENTIFIER NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_user_locations] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_user_organizations]...';


GO
CREATE TABLE [dbo].[z_scheduling_user_organizations] (
    [z_user_name]    VARCHAR (50)     NOT NULL,
    [z_action]       VARCHAR (10)     NOT NULL,
    [z_time]         DATETIME         NOT NULL,
    [user_id]        UNIQUEIDENTIFIER NOT NULL,
    [account_org_id] UNIQUEIDENTIFIER NOT NULL,
    [author]         VARCHAR (50)     NOT NULL,
    [create_date]    DATETIME         NOT NULL,
    [modifier]       VARCHAR (50)     NOT NULL,
    [modified_date]  DATETIME         NOT NULL,
    [stamp]          VARCHAR (50)     NOT NULL,
    [auto_number]    INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_user_organizations] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_user_preferences]...';


GO
CREATE TABLE [dbo].[z_scheduling_user_preferences] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [user_id]       UNIQUEIDENTIFIER NOT NULL,
    [pref_key]      VARCHAR (50)     NOT NULL,
    [pref_value]    VARCHAR (300)    NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_user_preferences] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_user_roles]...';


GO
CREATE TABLE [dbo].[z_scheduling_user_roles] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [user_id]       UNIQUEIDENTIFIER NOT NULL,
    [role_id]       UNIQUEIDENTIFIER NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_user_roles] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_user_settings]...';


GO
CREATE TABLE [dbo].[z_scheduling_user_settings] (
    [z_user_name]   NVARCHAR (50)    NOT NULL,
    [z_action]      NVARCHAR (10)    NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [id]            UNIQUEIDENTIFIER NOT NULL,
    [user_id]       UNIQUEIDENTIFIER NOT NULL,
    [setting_id]    UNIQUEIDENTIFIER NOT NULL,
    [setting_value] NVARCHAR (200)   NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_user_settings] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_user_work_schedules]...';


GO
CREATE TABLE [dbo].[z_scheduling_user_work_schedules] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [user_id]       UNIQUEIDENTIFIER NOT NULL,
    [day]           INT              NOT NULL,
    [location_id]   UNIQUEIDENTIFIER NULL,
    [work_type]     INT              NULL,
    [start_time]    TIME (7)         NULL,
    [end_time]      TIME (7)         NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_user_work_schedules] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_scheduling_users]...';


GO
CREATE TABLE [dbo].[z_scheduling_users] (
    [z_user_name]        VARCHAR (50)     NOT NULL,
    [z_action]           VARCHAR (10)     NOT NULL,
    [z_time]             DATETIME         NOT NULL,
    [user_id]            UNIQUEIDENTIFIER NOT NULL,
    [scheduling_enabled] BIT              NULL,
    [first_name]         VARCHAR (100)    NULL,
    [last_name]          VARCHAR (100)    NULL,
    [email]              VARCHAR (300)    NULL,
    [phone]              VARCHAR (20)     NULL,
    [author]             VARCHAR (50)     NOT NULL,
    [create_date]        DATETIME         NOT NULL,
    [modifier]           VARCHAR (50)     NOT NULL,
    [modified_date]      DATETIME         NOT NULL,
    [stamp]              VARCHAR (50)     NOT NULL,
    [auto_number]        INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_scheduling_users] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_session_designer_documents]...';


GO
CREATE TABLE [dbo].[z_session_designer_documents] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [id]            UNIQUEIDENTIFIER NOT NULL,
    [session_id]    UNIQUEIDENTIFIER NOT NULL,
    [doc_id]        UNIQUEIDENTIFIER NOT NULL,
    [is_checked]    BIT              NULL,
    [author]        VARCHAR (50)     NULL,
    [create_date]   DATETIME         NULL,
    [modifier]      VARCHAR (50)     NULL,
    [modified_date] DATETIME         NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_session_designer_documents] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_session_statuses]...';


GO
CREATE TABLE [dbo].[z_session_statuses] (
    [z_user_name]   VARCHAR (50) NOT NULL,
    [z_action]      VARCHAR (10) NOT NULL,
    [z_time]        DATETIME     NOT NULL,
    [status_id]     INT          NOT NULL,
    [status]        VARCHAR (50) NOT NULL,
    [author]        VARCHAR (50) NOT NULL,
    [create_date]   DATETIME     NOT NULL,
    [modifier]      VARCHAR (50) NOT NULL,
    [modified_date] DATETIME     NOT NULL,
    [stamp]         VARCHAR (50) NOT NULL,
    [auto_number]   INT          IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_session_statuses] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_support_links]...';


GO
CREATE TABLE [dbo].[z_support_links] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [row_id]        UNIQUEIDENTIFIER NOT NULL,
    [link_id]       VARCHAR (50)     NOT NULL,
    [account_org]   VARCHAR (36)     NOT NULL,
    [role_id]       VARCHAR (36)     NOT NULL,
    [url]           VARCHAR (500)    NOT NULL,
    [url_label]     VARCHAR (500)    NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_support_links] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_support_problem_resolutions]...';


GO
CREATE TABLE [dbo].[z_support_problem_resolutions] (
    [z_user_name]   VARCHAR (50)  NOT NULL,
    [z_action]      VARCHAR (10)  NOT NULL,
    [z_time]        DATETIME      NOT NULL,
    [resolution_id] INT           NOT NULL,
    [name]          VARCHAR (MAX) NOT NULL,
    [author]        VARCHAR (50)  NOT NULL,
    [create_date]   DATETIME      NOT NULL,
    [modifier]      VARCHAR (50)  NOT NULL,
    [modified_date] DATETIME      NOT NULL,
    [stamp]         VARCHAR (50)  NOT NULL,
    [auto_number]   INT           IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_support_problem_resolutions] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_support_problem_sources]...';


GO
CREATE TABLE [dbo].[z_support_problem_sources] (
    [z_user_name]   VARCHAR (50)  NOT NULL,
    [z_action]      VARCHAR (10)  NOT NULL,
    [z_time]        DATETIME      NOT NULL,
    [source_id]     INT           NOT NULL,
    [name]          VARCHAR (MAX) NOT NULL,
    [author]        VARCHAR (50)  NOT NULL,
    [create_date]   DATETIME      NOT NULL,
    [modifier]      VARCHAR (50)  NOT NULL,
    [modified_date] DATETIME      NOT NULL,
    [stamp]         VARCHAR (50)  NOT NULL,
    [auto_number]   INT           IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_support_problem_sources] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Table [dbo].[z_user_completed_orientation_steps]...';


GO
CREATE TABLE [dbo].[z_user_completed_orientation_steps] (
    [z_user_name]   VARCHAR (50)     NOT NULL,
    [z_action]      VARCHAR (10)     NOT NULL,
    [z_time]        DATETIME         NOT NULL,
    [id]            UNIQUEIDENTIFIER NOT NULL,
    [user_id]       UNIQUEIDENTIFIER NOT NULL,
    [step]          VARCHAR (50)     NOT NULL,
    [author]        VARCHAR (50)     NOT NULL,
    [create_date]   DATETIME         NOT NULL,
    [modifier]      VARCHAR (50)     NOT NULL,
    [modified_date] DATETIME         NOT NULL,
    [stamp]         VARCHAR (50)     NOT NULL,
    [auto_number]   INT              IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_z_user_completed_orientation_steps] PRIMARY KEY CLUSTERED ([auto_number] ASC)
);


GO
PRINT N'Creating Synonym [dbo].[gpc_products]...';


GO
CREATE SYNONYM [dbo].[gpc_products] FOR [$(gpc)].[dbo].[products];


GO
PRINT N'Creating Synonym [dbo].[gpc_products_documents]...';


GO
CREATE SYNONYM [dbo].[gpc_products_documents] FOR [$(gpc)].[dbo].[products_documents];


GO
PRINT N'Creating Synonym [dbo].[vdsf_isValidSecurityToken]...';


GO
CREATE SYNONYM [dbo].[vdsf_isValidSecurityToken] FOR [$(VeoSolutionsSecurity)].[dbo].[vdsf_isValidSecurityToken];


GO
PRINT N'Creating Synonym [dbo].[Veo_accent_sqft_conversions]...';


GO
CREATE SYNONYM [dbo].[Veo_accent_sqft_conversions] FOR [$(VEO)].[dbo].[accent_sqft_conversions];


GO
PRINT N'Creating Synonym [dbo].[Veo_application_products]...';


GO
CREATE SYNONYM [dbo].[Veo_application_products] FOR [$(VEO)].[dbo].[application_products];


GO
PRINT N'Creating Synonym [dbo].[Veo_applications]...';


GO
CREATE SYNONYM [dbo].[Veo_applications] FOR [$(VEO)].[dbo].[applications];


GO
PRINT N'Creating Synonym [dbo].[Veo_areas]...';


GO
CREATE SYNONYM [dbo].[Veo_areas] FOR [$(VEO)].[dbo].[areas];


GO
PRINT N'Creating Synonym [dbo].[Veo_areas_sub_areas]...';


GO
CREATE SYNONYM [dbo].[Veo_areas_sub_areas] FOR [$(VEO)].[dbo].[areas_sub_areas];


GO
PRINT N'Creating Synonym [dbo].[Veo_builder_styles]...';


GO
CREATE SYNONYM [dbo].[Veo_builder_styles] FOR [$(VEO)].[dbo].[builder_styles];


GO
PRINT N'Creating Synonym [dbo].[Veo_cabinet_colors]...';


GO
CREATE SYNONYM [dbo].[Veo_cabinet_colors] FOR [$(VEO)].[dbo].[cabinet_colors];


GO
PRINT N'Creating Synonym [dbo].[Veo_cabinet_door_panels]...';


GO
CREATE SYNONYM [dbo].[Veo_cabinet_door_panels] FOR [$(VEO)].[dbo].[cabinet_door_panels];


GO
PRINT N'Creating Synonym [dbo].[Veo_cabinet_door_styles]...';


GO
CREATE SYNONYM [dbo].[Veo_cabinet_door_styles] FOR [$(VEO)].[dbo].[cabinet_door_styles];


GO
PRINT N'Creating Synonym [dbo].[Veo_cabinet_species]...';


GO
CREATE SYNONYM [dbo].[Veo_cabinet_species] FOR [$(VEO)].[dbo].[cabinet_species];


GO
PRINT N'Creating Synonym [dbo].[veo_colors]...';


GO
CREATE SYNONYM [dbo].[veo_colors] FOR [$(VEO)].[dbo].[colors];


GO
PRINT N'Creating Synonym [dbo].[Veo_colors_attributes]...';


GO
CREATE SYNONYM [dbo].[Veo_colors_attributes] FOR [$(VEO)].[dbo].[colors_attributes];


GO
PRINT N'Creating Synonym [dbo].[Veo_colors_customer_overrides]...';


GO
CREATE SYNONYM [dbo].[Veo_colors_customer_overrides] FOR [$(VEO)].[dbo].[colors_customer_overrides];


GO
PRINT N'Creating Synonym [dbo].[veo_communities]...';


GO
CREATE SYNONYM [dbo].[veo_communities] FOR [$(VEO)].[dbo].[communities];


GO
PRINT N'Creating Synonym [dbo].[Veo_customers]...';


GO
CREATE SYNONYM [dbo].[Veo_customers] FOR [$(VEO)].[dbo].[customers];


GO
PRINT N'Creating Synonym [dbo].[Veo_customers_items_applications]...';


GO
CREATE SYNONYM [dbo].[Veo_customers_items_applications] FOR [$(VEO)].[dbo].[customers_items_applications];


GO
PRINT N'Creating Synonym [dbo].[Veo_customers_items_products]...';


GO
CREATE SYNONYM [dbo].[Veo_customers_items_products] FOR [$(VEO)].[dbo].[customers_items_products];


GO
PRINT N'Creating Synonym [dbo].[Veo_customers_plans]...';


GO
CREATE SYNONYM [dbo].[Veo_customers_plans] FOR [$(VEO)].[dbo].[customers_plans];


GO
PRINT N'Creating Synonym [dbo].[Veo_ef_selStyleColorNameWithAttributes]...';


GO
CREATE SYNONYM [dbo].[Veo_ef_selStyleColorNameWithAttributes] FOR [$(VEO)].[dbo].[ef_selStyleColorNameWithAttributes];


GO
PRINT N'Creating Synonym [dbo].[Veo_esp_selColor]...';


GO
CREATE SYNONYM [dbo].[Veo_esp_selColor] FOR [$(VEO)].[dbo].[esp_selColor];


GO
PRINT N'Creating Synonym [dbo].[Veo_esp_selColorsFromAttributes]...';


GO
CREATE SYNONYM [dbo].[Veo_esp_selColorsFromAttributes] FOR [$(VEO)].[dbo].[esp_selColorsFromAttributes];


GO
PRINT N'Creating Synonym [dbo].[Veo_esp_selItemPrice]...';


GO
CREATE SYNONYM [dbo].[Veo_esp_selItemPrice] FOR [$(VEO)].[dbo].[esp_selItemPrice];


GO
PRINT N'Creating Synonym [dbo].[veo_getUomQty]...';


GO
CREATE SYNONYM [dbo].[veo_getUomQty] FOR [$(VEO)].[dbo].[of_getUomQty];


GO
PRINT N'Creating Synonym [dbo].[Veo_labor_codes]...';


GO
CREATE SYNONYM [dbo].[Veo_labor_codes] FOR [$(VEO)].[dbo].[labor_codes];


GO
PRINT N'Creating Synonym [dbo].[Veo_of_getProductFromItemNumber]...';


GO
CREATE SYNONYM [dbo].[Veo_of_getProductFromItemNumber] FOR [$(VEO)].[dbo].[of_getProductFromItemNumber];


GO
PRINT N'Creating Synonym [dbo].[Veo_of_selCustomerItemProductName]...';


GO
CREATE SYNONYM [dbo].[Veo_of_selCustomerItemProductName] FOR [$(VEO)].[dbo].[of_selCustomerItemProductName];


GO
PRINT N'Creating Synonym [dbo].[Veo_of_selPartName]...';


GO
CREATE SYNONYM [dbo].[Veo_of_selPartName] FOR [$(VEO)].[dbo].[of_selPartName];


GO
PRINT N'Creating Synonym [dbo].[Veo_of_selProductName]...';


GO
CREATE SYNONYM [dbo].[Veo_of_selProductName] FOR [$(VEO)].[dbo].[of_selProductName];


GO
PRINT N'Creating Synonym [dbo].[Veo_photo_attributes]...';


GO
CREATE SYNONYM [dbo].[Veo_photo_attributes] FOR [$(VEO)].[dbo].[photo_attributes];


GO
PRINT N'Creating Synonym [dbo].[Veo_photo_attributes_values]...';


GO
CREATE SYNONYM [dbo].[Veo_photo_attributes_values] FOR [$(VEO)].[dbo].[photo_attributes_values];


GO
PRINT N'Creating Synonym [dbo].[Veo_photos]...';


GO
CREATE SYNONYM [dbo].[Veo_photos] FOR [$(VEO)].[dbo].[photos];


GO
PRINT N'Creating Synonym [dbo].[Veo_plan_areas]...';


GO
CREATE SYNONYM [dbo].[Veo_plan_areas] FOR [$(VEO)].[dbo].[plan_areas];


GO
PRINT N'Creating Synonym [dbo].[Veo_plan_builds]...';


GO
CREATE SYNONYM [dbo].[Veo_plan_builds] FOR [$(VEO)].[dbo].[plan_builds];


GO
PRINT N'Creating Synonym [dbo].[Veo_plan_items]...';


GO
CREATE SYNONYM [dbo].[Veo_plan_items] FOR [$(VEO)].[dbo].[plan_items];


GO
PRINT N'Creating Synonym [dbo].[Veo_plan_items_alias]...';


GO
CREATE SYNONYM [dbo].[Veo_plan_items_alias] FOR [$(VEO)].[dbo].[plan_items_alias];


GO
PRINT N'Creating Synonym [dbo].[Veo_plan_items_sort]...';


GO
CREATE SYNONYM [dbo].[Veo_plan_items_sort] FOR [$(VEO)].[dbo].[plan_items_sort];


GO
PRINT N'Creating Synonym [dbo].[Veo_plan_material]...';


GO
CREATE SYNONYM [dbo].[Veo_plan_material] FOR [$(VEO)].[dbo].[plan_material];


GO
PRINT N'Creating Synonym [dbo].[Veo_plan_mstr]...';


GO
CREATE SYNONYM [dbo].[Veo_plan_mstr] FOR [$(VEO)].[dbo].[plan_mstr];


GO
PRINT N'Creating Synonym [dbo].[veo_prices_default_labor]...';


GO
CREATE SYNONYM [dbo].[veo_prices_default_labor] FOR [$(VEO)].[dbo].[prices_default_labor];


GO
PRINT N'Creating Synonym [dbo].[veo_prices_extended_labor]...';


GO
CREATE SYNONYM [dbo].[veo_prices_extended_labor] FOR [$(VEO)].[dbo].[prices_extended_labor];


GO
PRINT N'Creating Synonym [dbo].[veo_prices_global_labor]...';


GO
CREATE SYNONYM [dbo].[veo_prices_global_labor] FOR [$(VEO)].[dbo].[prices_global_labor];


GO
PRINT N'Creating Synonym [dbo].[veo_prices_public_labor]...';


GO
CREATE SYNONYM [dbo].[veo_prices_public_labor] FOR [$(VEO)].[dbo].[prices_public_labor];


GO
PRINT N'Creating Synonym [dbo].[veo_prices_published]...';


GO
CREATE SYNONYM [dbo].[veo_prices_published] FOR [$(VEO)].[dbo].[prices_published];


GO
PRINT N'Creating Synonym [dbo].[veo_prices_published_groups_detail]...';


GO
CREATE SYNONYM [dbo].[veo_prices_published_groups_detail] FOR [$(VEO)].[dbo].[prices_published_groups_detail];


GO
PRINT N'Creating Synonym [dbo].[Veo_pricesets]...';


GO
CREATE SYNONYM [dbo].[Veo_pricesets] FOR [$(VEO)].[dbo].[pricesets];


GO
PRINT N'Creating Synonym [dbo].[Veo_product_patterns]...';


GO
CREATE SYNONYM [dbo].[Veo_product_patterns] FOR [$(VEO)].[dbo].[product_patterns];


GO
PRINT N'Creating Synonym [dbo].[Veo_product_patterns_areas]...';


GO
CREATE SYNONYM [dbo].[Veo_product_patterns_areas] FOR [$(VEO)].[dbo].[product_patterns_areas];


GO
PRINT N'Creating Synonym [dbo].[Veo_product_patterns_customers]...';


GO
CREATE SYNONYM [dbo].[Veo_product_patterns_customers] FOR [$(VEO)].[dbo].[product_patterns_customers];


GO
PRINT N'Creating Synonym [dbo].[Veo_product_patterns_labor]...';


GO
CREATE SYNONYM [dbo].[Veo_product_patterns_labor] FOR [$(VEO)].[dbo].[product_patterns_labor];


GO
PRINT N'Creating Synonym [dbo].[Veo_product_patterns_material]...';


GO
CREATE SYNONYM [dbo].[Veo_product_patterns_material] FOR [$(VEO)].[dbo].[product_patterns_material];


GO
PRINT N'Creating Synonym [dbo].[Veo_products]...';


GO
CREATE SYNONYM [dbo].[Veo_products] FOR [$(VEO)].[dbo].[products];


GO
PRINT N'Creating Synonym [dbo].[Veo_products_attributes]...';


GO
CREATE SYNONYM [dbo].[Veo_products_attributes] FOR [$(VEO)].[dbo].[products_attributes];


GO
PRINT N'Creating Synonym [dbo].[Veo_products_attributes_values]...';


GO
CREATE SYNONYM [dbo].[Veo_products_attributes_values] FOR [$(VEO)].[dbo].[products_attributes_values];


GO
PRINT N'Creating Synonym [dbo].[Veo_products_options]...';


GO
CREATE SYNONYM [dbo].[Veo_products_options] FOR [$(VEO)].[dbo].[products_options];


GO
PRINT N'Creating Synonym [dbo].[veo_products_options_materials]...';


GO
CREATE SYNONYM [dbo].[veo_products_options_materials] FOR [$(VEO)].[dbo].[products_options_materials];


GO
PRINT N'Creating Synonym [dbo].[veo_products_options_values]...';


GO
CREATE SYNONYM [dbo].[veo_products_options_values] FOR [$(VEO)].[dbo].[products_options_values];


GO
PRINT N'Creating Synonym [dbo].[veo_regions]...';


GO
CREATE SYNONYM [dbo].[veo_regions] FOR [$(VEO)].[dbo].[regions];


GO
PRINT N'Creating Synonym [dbo].[veo_room_groups]...';


GO
CREATE SYNONYM [dbo].[veo_room_groups] FOR [$(VEO)].[dbo].[room_groups];


GO
PRINT N'Creating Synonym [dbo].[veo_spec_areas_items]...';


GO
CREATE SYNONYM [dbo].[veo_spec_areas_items] FOR [$(VEO)].[dbo].[spec_areas_items];


GO
PRINT N'Creating Synonym [dbo].[Veo_spec_communities]...';


GO
CREATE SYNONYM [dbo].[Veo_spec_communities] FOR [$(VEO)].[dbo].[spec_communities];


GO
PRINT N'Creating Synonym [dbo].[veo_spec_items]...';


GO
CREATE SYNONYM [dbo].[veo_spec_items] FOR [$(VEO)].[dbo].[spec_items];


GO
PRINT N'Creating Synonym [dbo].[veo_spec_mstr]...';


GO
CREATE SYNONYM [dbo].[veo_spec_mstr] FOR [$(VEO)].[dbo].[spec_mstr];


GO
PRINT N'Creating Synonym [dbo].[Veo_spec_plans]...';


GO
CREATE SYNONYM [dbo].[Veo_spec_plans] FOR [$(VEO)].[dbo].[spec_plans];


GO
PRINT N'Creating Synonym [dbo].[veo_spec_series]...';


GO
CREATE SYNONYM [dbo].[veo_spec_series] FOR [$(VEO)].[dbo].[spec_series];


GO
PRINT N'Creating Synonym [dbo].[Veo_stocking_codes]...';


GO
CREATE SYNONYM [dbo].[Veo_stocking_codes] FOR [$(VEO)].[dbo].[stocking_codes];


GO
PRINT N'Creating Synonym [dbo].[Veo_styles]...';


GO
CREATE SYNONYM [dbo].[Veo_styles] FOR [$(VEO)].[dbo].[styles];


GO
PRINT N'Creating Synonym [dbo].[Veo_styles_attributes]...';


GO
CREATE SYNONYM [dbo].[Veo_styles_attributes] FOR [$(VEO)].[dbo].[styles_attributes];


GO
PRINT N'Creating Synonym [dbo].[Veo_styles_groups]...';


GO
CREATE SYNONYM [dbo].[Veo_styles_groups] FOR [$(VEO)].[dbo].[styles_groups];


GO
PRINT N'Creating Synonym [dbo].[Veo_styles_groups_detail]...';


GO
CREATE SYNONYM [dbo].[Veo_styles_groups_detail] FOR [$(VEO)].[dbo].[styles_groups_detail];


GO
PRINT N'Creating Synonym [dbo].[Veo_styles_related_items]...';


GO
CREATE SYNONYM [dbo].[Veo_styles_related_items] FOR [$(VEO)].[dbo].[styles_related_items];


GO
PRINT N'Creating Synonym [dbo].[Veo_sub_areas]...';


GO
CREATE SYNONYM [dbo].[Veo_sub_areas] FOR [$(VEO)].[dbo].[sub_areas];


GO
PRINT N'Creating Synonym [dbo].[veo_uomMultiplier]...';


GO
CREATE SYNONYM [dbo].[veo_uomMultiplier] FOR [$(VEO)].[dbo].[of_uomMultiplier];


GO
PRINT N'Creating Synonym [dbo].[Veo_vs_searchPart]...';


GO
CREATE SYNONYM [dbo].[Veo_vs_searchPart] FOR [$(VEO)].[dbo].[vs_searchPart];


GO
PRINT N'Creating Synonym [dbo].[Veo_vs_selItemPrice]...';


GO
CREATE SYNONYM [dbo].[Veo_vs_selItemPrice] FOR [$(VEO)].[dbo].[vs_selItemPrice];


GO
PRINT N'Creating Synonym [dbo].[Veo_vsp_selSpecColorsFromAttributes]...';


GO
CREATE SYNONYM [dbo].[Veo_vsp_selSpecColorsFromAttributes] FOR [$(VEO)].[dbo].[vsp_selSpecColorsFromAttributes];


GO
PRINT N'Creating Synonym [dbo].[VeoScheduling_organization_appointment_types]...';


GO
CREATE SYNONYM [dbo].[VeoScheduling_organization_appointment_types] FOR [$(VeoScheduling)].[dbo].[organization_appointment_types];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsArchive_catalog_selections_area_details_update_backup]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsArchive_catalog_selections_area_details_update_backup] FOR [$(VeoSolutionsArchive)].[dbo].[catalog_selections_area_details_update_backup];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsArchive_catalog_selections_price_level_boms_update_backup]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsArchive_catalog_selections_price_level_boms_update_backup] FOR [$(VeoSolutionsArchive)].[dbo].[catalog_selections_price_level_boms_update_backup];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity__organization_plan_items]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity__organization_plan_items] FOR [$(VeoSolutionsSecurity)].[dbo].[organization_plan_items];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_account_org_community_series_plan]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_account_org_community_series_plan] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organization_community_series_plan];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_account_organization_apps]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_account_organization_apps] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organization_apps];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_account_organization_communities]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_account_organization_communities] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organization_communities];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_account_organization_communities_mappings]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_account_organization_communities_mappings] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organization_communities_mappings];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_account_organization_community_series]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_account_organization_community_series] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organization_community_series];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_account_organization_documents]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_account_organization_documents] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organization_documents];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_account_organization_locations]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_account_organization_locations] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organization_locations];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_account_organization_plans]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_account_organization_plans] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organization_plans];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_account_organization_plans_mappings]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_account_organization_plans_mappings] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organization_plans_mappings];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_account_organization_series]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_account_organization_series] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organization_series];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_account_organization_series_mappings]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_account_organization_series_mappings] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organization_series_mappings];


GO
PRINT N'Creating Synonym [dbo].[VEOSolutionsSecurity_account_organization_user_contacts]...';


GO
CREATE SYNONYM [dbo].[VEOSolutionsSecurity_account_organization_user_contacts] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organization_user_contacts];


GO
PRINT N'Creating Synonym [dbo].[VEOSolutionsSecurity_account_organization_user_override_permissions]...';


GO
CREATE SYNONYM [dbo].[VEOSolutionsSecurity_account_organization_user_override_permissions] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organization_user_override_permissions];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_account_organization_users]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_account_organization_users] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organization_users];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_account_organization_users_roles_legacy]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_account_organization_users_roles_legacy] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organization_users_roles_legacy];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_account_organizations]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_account_organizations] FOR [$(VeoSolutionsSecurity)].[dbo].[account_organizations];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_accounts]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_accounts] FOR [$(VeoSolutionsSecurity)].[dbo].[accounts];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_app_roles_legacy]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_app_roles_legacy] FOR [$(VeoSolutionsSecurity)].[dbo].[app_roles_legacy];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_integration_clients]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_integration_clients] FOR [$(VeoSolutionsSecurity)].[dbo].[integration_clients];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_integration_clients_roles]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_integration_clients_roles] FOR [$(VeoSolutionsSecurity)].[dbo].[integration_clients_roles];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_integration_clients_tenants]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_integration_clients_tenants] FOR [$(VeoSolutionsSecurity)].[dbo].[integration_clients_tenants];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_languages]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_languages] FOR [$(VeoSolutionsSecurity)].[dbo].[languages];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_location_types]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_location_types] FOR [$(VeoSolutionsSecurity)].[dbo].[location_types];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_locations]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_locations] FOR [$(VeoSolutionsSecurity)].[dbo].[locations];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_organization_elevations]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_organization_elevations] FOR [$(VeoSolutionsSecurity)].[dbo].[organization_elevations];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_organization_images]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_organization_images] FOR [$(VeoSolutionsSecurity)].[dbo].[organization_images];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_organization_images_categories]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_organization_images_categories] FOR [$(VeoSolutionsSecurity)].[dbo].[organization_images_categories];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_organization_plan_items]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_organization_plan_items] FOR [$(VeoSolutionsSecurity)].[dbo].[organization_plan_items];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_organizations]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_organizations] FOR [$(VeoSolutionsSecurity)].[dbo].[organizations];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_roles_legacy]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_roles_legacy] FOR [$(VeoSolutionsSecurity)].[dbo].[roles_legacy];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_users]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_users] FOR [$(VeoSolutionsSecurity)].[dbo].[users];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_users_languages]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_users_languages] FOR [$(VeoSolutionsSecurity)].[dbo].[users_languages];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_users_login_sessions]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_users_login_sessions] FOR [$(VeoSolutionsSecurity)].[dbo].[users_login_sessions];


GO
PRINT N'Creating Synonym [dbo].[VeoSolutionsSecurity_users_terms_of_service]...';


GO
CREATE SYNONYM [dbo].[VeoSolutionsSecurity_users_terms_of_service] FOR [$(VeoSolutionsSecurity)].[dbo].[users_terms_of_service];


GO
PRINT N'Creating Synonym [dbo].[vss_organizations]...';


GO
CREATE SYNONYM [dbo].[vss_organizations] FOR [$(VeoSolutionsSecurity)].[dbo].[organizations];


GO
PRINT N'Creating Synonym [dbo].[vss_users]...';


GO
CREATE SYNONYM [dbo].[vss_users] FOR [$(VeoSolutionsSecurity)].[dbo].[users];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_addresses_author]...';


GO
ALTER TABLE [dbo].[account_organization_addresses]
    ADD CONSTRAINT [DF_account_organization_addresses_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_addresses_create_date]...';


GO
ALTER TABLE [dbo].[account_organization_addresses]
    ADD CONSTRAINT [DF_account_organization_addresses_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_addresses_modifier]...';


GO
ALTER TABLE [dbo].[account_organization_addresses]
    ADD CONSTRAINT [DF_account_organization_addresses_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_addresses_modified_date]...';


GO
ALTER TABLE [dbo].[account_organization_addresses]
    ADD CONSTRAINT [DF_account_organization_addresses_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_application_product_sort_order_sort_order]...';


GO
ALTER TABLE [dbo].[account_organization_application_product_sort_order]
    ADD CONSTRAINT [DF_account_organization_application_product_sort_order_sort_order] DEFAULT ((9999999)) FOR [sort_order];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_application_product_sort_order_author]...';


GO
ALTER TABLE [dbo].[account_organization_application_product_sort_order]
    ADD CONSTRAINT [DF_account_organization_application_product_sort_order_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_application_product_sort_order_create_date]...';


GO
ALTER TABLE [dbo].[account_organization_application_product_sort_order]
    ADD CONSTRAINT [DF_account_organization_application_product_sort_order_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_application_product_sort_order_modifier]...';


GO
ALTER TABLE [dbo].[account_organization_application_product_sort_order]
    ADD CONSTRAINT [DF_account_organization_application_product_sort_order_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_application_product_sort_order_modified_date]...';


GO
ALTER TABLE [dbo].[account_organization_application_product_sort_order]
    ADD CONSTRAINT [DF_account_organization_application_product_sort_order_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_documents_notes]...';


GO
ALTER TABLE [dbo].[account_organization_documents]
    ADD CONSTRAINT [DF_account_organization_documents_notes] DEFAULT ('') FOR [notes];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_documents_allow_inclusion_buyer_packet]...';


GO
ALTER TABLE [dbo].[account_organization_documents]
    ADD CONSTRAINT [DF_account_organization_documents_allow_inclusion_buyer_packet] DEFAULT ((0)) FOR [allow_inclusion_buyer_packet];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_documents_type]...';


GO
ALTER TABLE [dbo].[account_organization_documents]
    ADD CONSTRAINT [DF_account_organization_documents_type] DEFAULT ('') FOR [type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_documents_url_1]...';


GO
ALTER TABLE [dbo].[account_organization_documents]
    ADD CONSTRAINT [DF_account_organization_documents_url_1] DEFAULT ('') FOR [url];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_orgainzation_documents_author]...';


GO
ALTER TABLE [dbo].[account_organization_documents]
    ADD CONSTRAINT [DF_account_orgainzation_documents_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_orgainzation_documents_create_date]...';


GO
ALTER TABLE [dbo].[account_organization_documents]
    ADD CONSTRAINT [DF_account_orgainzation_documents_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_orgainzation_documents_modifier]...';


GO
ALTER TABLE [dbo].[account_organization_documents]
    ADD CONSTRAINT [DF_account_orgainzation_documents_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_orgainzation_documents_modified_date]...';


GO
ALTER TABLE [dbo].[account_organization_documents]
    ADD CONSTRAINT [DF_account_orgainzation_documents_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_support_emails_should_send_notifications]...';


GO
ALTER TABLE [dbo].[account_organization_support_emails]
    ADD CONSTRAINT [DF_account_organization_support_emails_should_send_notifications] DEFAULT (1) FOR [should_send_notifications];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_support_emails_author]...';


GO
ALTER TABLE [dbo].[account_organization_support_emails]
    ADD CONSTRAINT [DF_account_organization_support_emails_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_support_emails_create_date]...';


GO
ALTER TABLE [dbo].[account_organization_support_emails]
    ADD CONSTRAINT [DF_account_organization_support_emails_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_support_emails_modifier]...';


GO
ALTER TABLE [dbo].[account_organization_support_emails]
    ADD CONSTRAINT [DF_account_organization_support_emails_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_support_emails_modified_date]...';


GO
ALTER TABLE [dbo].[account_organization_support_emails]
    ADD CONSTRAINT [DF_account_organization_support_emails_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_profile_id]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile]
    ADD CONSTRAINT [DF_account_organization_user_profile_profile_id] DEFAULT (newid()) FOR [profile_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_interest_rate]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile]
    ADD CONSTRAINT [DF_account_organization_user_profile_interest_rate] DEFAULT ((0)) FOR [interest_rate];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_loan_term]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile]
    ADD CONSTRAINT [DF_account_organization_user_profile_loan_term] DEFAULT ((0)) FOR [loan_term];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_completed_steps]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile]
    ADD CONSTRAINT [DF_account_organization_user_profile_completed_steps] DEFAULT ((0)) FOR [completed_steps];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_enable_homebuyer_access]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile]
    ADD CONSTRAINT [DF_account_organization_user_profile_enable_homebuyer_access] DEFAULT ((0)) FOR [enable_homebuyer_access];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_author]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile]
    ADD CONSTRAINT [DF_account_organization_user_profile_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_create_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile]
    ADD CONSTRAINT [DF_account_organization_user_profile_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_modifier]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile]
    ADD CONSTRAINT [DF_account_organization_user_profile_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_modified_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile]
    ADD CONSTRAINT [DF_account_organization_user_profile_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_profile_id]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_profile_id] DEFAULT (newid()) FOR [profile_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_master_plan_name]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_master_plan_name] DEFAULT ('') FOR [base_plan_name];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_sales_price]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_sales_price] DEFAULT ((0)) FOR [sales_price];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_sales_options]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_sales_options] DEFAULT ((0)) FOR [sales_options];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_upgrades_incentive]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_upgrades_incentive] DEFAULT ((0)) FOR [upgrades_incentive];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_additional_design_deposit]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_additional_design_deposit] DEFAULT ((0)) FOR [additional_design_deposit];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_deposit_notes]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_deposit_notes] DEFAULT ('') FOR [deposit_notes];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_home_down_payment]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_home_down_payment] DEFAULT ((0)) FOR [home_down_payment];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_home_allowance]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_home_allowance] DEFAULT ((0)) FOR [home_allowance];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_session_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_session_date] DEFAULT (getdate()) FOR [catalog_session_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_total]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_total] DEFAULT ((0)) FOR [catalog_total];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_job_no]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_job_no] DEFAULT ('') FOR [job_no];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_address_1]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_address_1] DEFAULT ('') FOR [address];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_address_lot_block]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_address_lot_block] DEFAULT ('') FOR [address_lot_block];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_property_desc_1]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_property_desc_1] DEFAULT ('') FOR [property_desc_1];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_property_desc_2]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_property_desc_2] DEFAULT ('') FOR [property_desc_2];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_block_1]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_block_1] DEFAULT ('') FOR [block];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_lot_1]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_lot_1] DEFAULT ('') FOR [lot];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_city]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_city] DEFAULT ('') FOR [city];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_state]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_state] DEFAULT ('') FOR [state];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_zip_code]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_zip_code] DEFAULT ('') FOR [zip_code];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_sales_counselor_name]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_sales_counselor_name] DEFAULT ('') FOR [sales_counselor];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_country_home_phone]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_country_home_phone] DEFAULT ('North America') FOR [country_home_phone];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_home_phone]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_home_phone] DEFAULT ('') FOR [home_phone];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_country_code_work_phone]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_country_code_work_phone] DEFAULT ('North America') FOR [country_work_phone];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_work_phone]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_work_phone] DEFAULT ('') FOR [work_phone];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_spouse_first_name]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_spouse_first_name] DEFAULT ('') FOR [spouse_first_name];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_spouse_last_name]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_spouse_last_name] DEFAULT ('') FOR [spouse_last_name];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_country_code_spouse_phone]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_country_code_spouse_phone] DEFAULT ('North America') FOR [country_spouse_phone];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_spouse_contact_phone]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_spouse_contact_phone] DEFAULT ('') FOR [spouse_phone];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_dc_job_id]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_dc_job_id] DEFAULT ((0)) FOR [dc_job_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_dc_contact_list]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_dc_contact_list] DEFAULT ('') FOR [dc_contact_list];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_status]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_status] DEFAULT ('') FOR [status];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_echelon_exported]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_echelon_exported] DEFAULT ((0)) FOR [echelon_exported];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_spec_home]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_spec_home] DEFAULT ((0)) FOR [spec_home];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_job_type]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_job_type] DEFAULT ((0)) FOR [job_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_elevation]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_elevation] DEFAULT ('') FOR [elevation];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_stage]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_stage] DEFAULT ('') FOR [stage];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_superintendent]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_superintendent] DEFAULT ('') FOR [superintendent];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_plan_profile_author]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_plan_profile_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_plan_profile_create_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_plan_profile_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_plan_profile_modifier]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_plan_profile_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_plan_profile_modified_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_account_organization_user_plan_profile_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_community_id]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_community_id] DEFAULT ((0)) FOR [community_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_plan_version]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_plan_version] DEFAULT ('') FOR [plan_version];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_session_notes]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_session_notes] DEFAULT ('') FOR [session_notes];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_deposit]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_deposit] DEFAULT ((0)) FOR [deposit];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_deposit_notes]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_deposit_notes] DEFAULT ('') FOR [deposit_notes];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_desginer]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_desginer] DEFAULT ('') FOR [designer];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_show_report]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_show_report] DEFAULT 1 FOR [show_report];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_spec_id]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_spec_id] DEFAULT ((0)) FOR [spec_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_effective_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_effective_date] DEFAULT (getdate()) FOR [effective_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_completed_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_completed_date] DEFAULT (((1)/(1))/(1900)) FOR [completed_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_first_completed_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_first_completed_date] DEFAULT (((1)/(1))/(1900)) FOR [first_completed_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_export_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_export_date] DEFAULT (((1)/(1))/(1900)) FOR [export_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_address_id]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_address_id] DEFAULT ((0)) FOR [address_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_rounding_type]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_rounding_type] DEFAULT ((0)) FOR [rounding_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_rounding_places]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_rounding_places] DEFAULT ((2)) FOR [rounding_places];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_builder_markup_hb_pricing]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_builder_markup_hb_pricing] DEFAULT ((0)) FOR [builder_markup_hb_pricing];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_pricing_generated]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_pricing_generated] DEFAULT (getdate()) FOR [pricing_generated];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_pricing_published]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_pricing_published] DEFAULT (getdate()) FOR [pricing_published];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_author]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_create_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_modifier]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_modified_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_precon_notes]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_precon_notes] DEFAULT ('') FOR [precon_notes];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_documents_application_id]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions_documents]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_documents_application_id] DEFAULT ('ALL') FOR [application_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_documents_product_id]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions_documents]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_documents_product_id] DEFAULT ('ALL') FOR [product_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_documents_area_id_1]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions_documents]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_documents_area_id_1] DEFAULT ('ALLstd') FOR [area_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_documents_sub_area_id_1]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions_documents]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_documents_sub_area_id_1] DEFAULT ('<All>') FOR [sub_area_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_documents_location_id]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions_documents]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_documents_location_id] DEFAULT ((1)) FOR [location_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_catalog_sessions_documents_type]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions_documents]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_catalog_sessions_documents_type] DEFAULT ('Session') FOR [document_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_documents_community_name]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_documents]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_documents_community_name] DEFAULT ('') FOR [community_name];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_documents_community_id]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_documents]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_documents_community_id] DEFAULT ((0)) FOR [community_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_documents_doc_type]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_documents]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_documents_doc_type] DEFAULT ('') FOR [doc_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_documents_author]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_documents]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_documents_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_documents_create_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_documents]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_documents_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_documents_modifier]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_documents]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_documents_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_documents_modified_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_documents]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_documents_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_options_budget_id]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_options_budget_items]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_options_budget_id] DEFAULT (newid()) FOR [id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_options_budget_items_source]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_options_budget_items]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_options_budget_items_source] DEFAULT ('') FOR [source];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_options_budget_items_author]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_options_budget_items]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_options_budget_items_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_options_budget_items_create_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_options_budget_items]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_options_budget_items_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_options_budget_items_modifier]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_options_budget_items]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_options_budget_items_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_options_budget_items_modified_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_options_budget_items]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_options_budget_items_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_original_status_create_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_original_status]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_original_status_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_original_status_modifier]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_original_status]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_original_status_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_profile_plan_original_status_modified_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_original_status]
    ADD CONSTRAINT [DF_account_organization_user_profile_plan_original_status_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_users_wishlist_items_wishlist_item_id]...';


GO
ALTER TABLE [dbo].[account_organization_user_wishlist_items]
    ADD CONSTRAINT [DF_account_users_wishlist_items_wishlist_item_id] DEFAULT (newid()) FOR [wishlist_item_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_wishlist_items_description]...';


GO
ALTER TABLE [dbo].[account_organization_user_wishlist_items]
    ADD CONSTRAINT [DF_account_organization_user_wishlist_items_description] DEFAULT ('') FOR [description];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_organization_user_wishlist_items_notes]...';


GO
ALTER TABLE [dbo].[account_organization_user_wishlist_items]
    ADD CONSTRAINT [DF_account_organization_user_wishlist_items_notes] DEFAULT ('') FOR [notes];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_users_wishlist_items_author]...';


GO
ALTER TABLE [dbo].[account_organization_user_wishlist_items]
    ADD CONSTRAINT [DF_account_users_wishlist_items_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_users_wishlist_items_create_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_wishlist_items]
    ADD CONSTRAINT [DF_account_users_wishlist_items_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_users_wishlist_items_modifier]...';


GO
ALTER TABLE [dbo].[account_organization_user_wishlist_items]
    ADD CONSTRAINT [DF_account_users_wishlist_items_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_users_wishlist_items_modified_date]...';


GO
ALTER TABLE [dbo].[account_organization_user_wishlist_items]
    ADD CONSTRAINT [DF_account_users_wishlist_items_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[account_organization_user_wishlist_items]...';


GO
ALTER TABLE [dbo].[account_organization_user_wishlist_items]
    ADD DEFAULT ('') FOR [gpc_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_product_guide_pages_page_id]...';


GO
ALTER TABLE [dbo].[account_product_guide_pages]
    ADD CONSTRAINT [DF_product_guide_pages_page_id] DEFAULT (newid()) FOR [page_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_product_guide_pages_author]...';


GO
ALTER TABLE [dbo].[account_product_guide_pages]
    ADD CONSTRAINT [DF_product_guide_pages_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_product_guide_pages_create_date]...';


GO
ALTER TABLE [dbo].[account_product_guide_pages]
    ADD CONSTRAINT [DF_product_guide_pages_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_product_guide_pages_modifier]...';


GO
ALTER TABLE [dbo].[account_product_guide_pages]
    ADD CONSTRAINT [DF_product_guide_pages_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_product_guide_pages_modified_date]...';


GO
ALTER TABLE [dbo].[account_product_guide_pages]
    ADD CONSTRAINT [DF_product_guide_pages_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_product_guide_pages_links_link_id]...';


GO
ALTER TABLE [dbo].[account_product_guide_pages_links]
    ADD CONSTRAINT [DF_account_product_guide_pages_links_link_id] DEFAULT (newid()) FOR [link_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_product_guide_pages_links_author]...';


GO
ALTER TABLE [dbo].[account_product_guide_pages_links]
    ADD CONSTRAINT [DF_account_product_guide_pages_links_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_product_guide_pages_links_create_date]...';


GO
ALTER TABLE [dbo].[account_product_guide_pages_links]
    ADD CONSTRAINT [DF_account_product_guide_pages_links_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_product_guide_pages_links_modifier]...';


GO
ALTER TABLE [dbo].[account_product_guide_pages_links]
    ADD CONSTRAINT [DF_account_product_guide_pages_links_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_account_product_guide_pages_links_modified_date]...';


GO
ALTER TABLE [dbo].[account_product_guide_pages_links]
    ADD CONSTRAINT [DF_account_product_guide_pages_links_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_address_types_author]...';


GO
ALTER TABLE [dbo].[address_types]
    ADD CONSTRAINT [DF_address_types_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_address_types_create_date]...';


GO
ALTER TABLE [dbo].[address_types]
    ADD CONSTRAINT [DF_address_types_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_address_types_modifier]...';


GO
ALTER TABLE [dbo].[address_types]
    ADD CONSTRAINT [DF_address_types_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_address_types_modified_date]...';


GO
ALTER TABLE [dbo].[address_types]
    ADD CONSTRAINT [DF_address_types_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_addresses_author]...';


GO
ALTER TABLE [dbo].[addresses]
    ADD CONSTRAINT [DF_addresses_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_addresses_create_date]...';


GO
ALTER TABLE [dbo].[addresses]
    ADD CONSTRAINT [DF_addresses_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_addresses_modifier]...';


GO
ALTER TABLE [dbo].[addresses]
    ADD CONSTRAINT [DF_addresses_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_addresses_modified_date]...';


GO
ALTER TABLE [dbo].[addresses]
    ADD CONSTRAINT [DF_addresses_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[application_icon]...';


GO
ALTER TABLE [dbo].[application_icon]
    ADD DEFAULT (SUSER_SNAME()) FOR [author];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[application_icon]...';


GO
ALTER TABLE [dbo].[application_icon]
    ADD DEFAULT (GETDATE()) FOR [create_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[application_icon]...';


GO
ALTER TABLE [dbo].[application_icon]
    ADD DEFAULT (SUSER_SNAME()) FOR [modifier];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[application_icon]...';


GO
ALTER TABLE [dbo].[application_icon]
    ADD DEFAULT (GETDATE()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_bom_modification_types_author]...';


GO
ALTER TABLE [dbo].[builder_bom_modification_types]
    ADD CONSTRAINT [DF_builder_bom_modification_types_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_bom_modification_types_create_date]...';


GO
ALTER TABLE [dbo].[builder_bom_modification_types]
    ADD CONSTRAINT [DF_builder_bom_modification_types_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_bom_modification_types_modifier]...';


GO
ALTER TABLE [dbo].[builder_bom_modification_types]
    ADD CONSTRAINT [DF_builder_bom_modification_types_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_bom_modification_types_modified_date]...';


GO
ALTER TABLE [dbo].[builder_bom_modification_types]
    ADD CONSTRAINT [DF_builder_bom_modification_types_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_bom_modifications_modification_type]...';


GO
ALTER TABLE [dbo].[builder_bom_modifications]
    ADD CONSTRAINT [DF_builder_bom_modifications_modification_type] DEFAULT ((0)) FOR [modification_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_bom_modifications_qty]...';


GO
ALTER TABLE [dbo].[builder_bom_modifications]
    ADD CONSTRAINT [DF_builder_bom_modifications_qty] DEFAULT ((0)) FOR [quantity];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_bom_modifications_price]...';


GO
ALTER TABLE [dbo].[builder_bom_modifications]
    ADD CONSTRAINT [DF_builder_bom_modifications_price] DEFAULT ((0)) FOR [price];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_bom_modifications_option_pricing_display]...';


GO
ALTER TABLE [dbo].[builder_bom_modifications]
    ADD CONSTRAINT [DF_builder_bom_modifications_option_pricing_display] DEFAULT ((0)) FOR [option_pricing_display];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_bom_modifications_create_date]...';


GO
ALTER TABLE [dbo].[builder_bom_modifications]
    ADD CONSTRAINT [DF_builder_bom_modifications_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_bom_modifications_modified_date]...';


GO
ALTER TABLE [dbo].[builder_bom_modifications]
    ADD CONSTRAINT [DF_builder_bom_modifications_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_features_value]...';


GO
ALTER TABLE [dbo].[builder_features]
    ADD CONSTRAINT [DF_builder_features_value] DEFAULT ((0)) FOR [value];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_features_author]...';


GO
ALTER TABLE [dbo].[builder_features]
    ADD CONSTRAINT [DF_builder_features_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_features_create_date]...';


GO
ALTER TABLE [dbo].[builder_features]
    ADD CONSTRAINT [DF_builder_features_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_features_modifier]...';


GO
ALTER TABLE [dbo].[builder_features]
    ADD CONSTRAINT [DF_builder_features_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_features_modified_date]...';


GO
ALTER TABLE [dbo].[builder_features]
    ADD CONSTRAINT [DF_builder_features_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_plan_budget_values_community_defaults_author]...';


GO
ALTER TABLE [dbo].[builder_plan_budget_values_community_defaults]
    ADD CONSTRAINT [DF_builder_plan_budget_values_community_defaults_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_plan_budget_values_community_defaults_create_date]...';


GO
ALTER TABLE [dbo].[builder_plan_budget_values_community_defaults]
    ADD CONSTRAINT [DF_builder_plan_budget_values_community_defaults_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_plan_budget_values_community_defaults_modifier]...';


GO
ALTER TABLE [dbo].[builder_plan_budget_values_community_defaults]
    ADD CONSTRAINT [DF_builder_plan_budget_values_community_defaults_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_plan_budget_values_community_defaults_modified_date]...';


GO
ALTER TABLE [dbo].[builder_plan_budget_values_community_defaults]
    ADD CONSTRAINT [DF_builder_plan_budget_values_community_defaults_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_plan_budget_values_settings_enabled]...';


GO
ALTER TABLE [dbo].[builder_plan_budget_values_settings]
    ADD CONSTRAINT [DF_builder_plan_budget_values_settings_enabled] DEFAULT (0) FOR [enabled];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_plan_budget_values_settings_author]...';


GO
ALTER TABLE [dbo].[builder_plan_budget_values_settings]
    ADD CONSTRAINT [DF_builder_plan_budget_values_settings_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_plan_budget_values_settings_create_date]...';


GO
ALTER TABLE [dbo].[builder_plan_budget_values_settings]
    ADD CONSTRAINT [DF_builder_plan_budget_values_settings_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_plan_budget_values_settings_modifier]...';


GO
ALTER TABLE [dbo].[builder_plan_budget_values_settings]
    ADD CONSTRAINT [DF_builder_plan_budget_values_settings_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_builder_plan_budget_values_settings_modified_date]...';


GO
ALTER TABLE [dbo].[builder_plan_budget_values_settings]
    ADD CONSTRAINT [DF_builder_plan_budget_values_settings_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_row_id]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_row_id] DEFAULT (newid()) FOR [row_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_community]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_community] DEFAULT ('All') FOR [community];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_series]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_series] DEFAULT ('All') FOR [series];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_plan]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_plan] DEFAULT ('All') FOR [plan];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_application]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_application] DEFAULT ('') FOR [application];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_product]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_product] DEFAULT ('') FOR [product];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_area]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_area] DEFAULT ('') FOR [area];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_sub_area]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_sub_area] DEFAULT ('') FOR [sub_area];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_item_no]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_item_no] DEFAULT ('') FOR [item_no];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_item]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_item] DEFAULT ('') FOR [item];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_vendor]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_vendor] DEFAULT ('') FOR [vendor];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_standard]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_standard] DEFAULT ('') FOR [standard];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_qty]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_qty] DEFAULT ((1)) FOR [qty];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_cost]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_cost] DEFAULT ((0)) FOR [cost];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_notes]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_notes] DEFAULT ('') FOR [notes];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_homebuyer_display]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_homebuyer_display] DEFAULT ((0)) FOR [option_pricing_display];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_mutally_exclusive]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_mutally_exclusive] DEFAULT ((1)) FOR [mutually_exclusive];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_model]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_model] DEFAULT ('') FOR [model];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_elevation]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_elevation] DEFAULT ('All') FOR [elevation];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_author]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_create_date]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_modifier]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_items_modified_date]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD CONSTRAINT [DF_catalog_items_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[catalog_items]...';


GO
ALTER TABLE [dbo].[catalog_items]
    ADD DEFAULT ((0)) FOR [is_package];


GO
PRINT N'Creating Default Constraint [dbo].[DF_prices_published_published]...';


GO
ALTER TABLE [dbo].[catalog_prices_published]
    ADD CONSTRAINT [DF_prices_published_published] DEFAULT (getdate()) FOR [published];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_id]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD CONSTRAINT [DF_catalog_selections_area_id] DEFAULT ('') FOR [area_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_sub_area_id]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD CONSTRAINT [DF_catalog_selections_sub_area_id] DEFAULT ('') FOR [sub_area_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_item_type]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD CONSTRAINT [DF_catalog_selections_item_type] DEFAULT ('') FOR [item_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_cost]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD CONSTRAINT [DF_catalog_selections_cost] DEFAULT ((0)) FOR [cost];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_option_pricing_display]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD CONSTRAINT [DF_catalog_selections_option_pricing_display] DEFAULT ((0)) FOR [option_pricing_display];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_mutually_exclusive]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD CONSTRAINT [DF_catalog_selections_mutually_exclusive] DEFAULT ((0)) FOR [mutually_exclusive];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_source]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD CONSTRAINT [DF_catalog_selections_source] DEFAULT ('') FOR [source];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_build_id]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD CONSTRAINT [DF_catalog_selections_build_id] DEFAULT ((0)) FOR [build_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_model]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD CONSTRAINT [DF_catalog_selections_model] DEFAULT ('') FOR [model];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_make_std]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD CONSTRAINT [DF_catalog_selections_make_std] DEFAULT ((0)) FOR [make_std];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_is_credit]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD CONSTRAINT [DF_catalog_selections_is_credit] DEFAULT ((0)) FOR [is_credit];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_author]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD CONSTRAINT [DF_catalog_selections_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_create_date]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD CONSTRAINT [DF_catalog_selections_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_modifier]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD CONSTRAINT [DF_catalog_selections_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_modified_date]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD CONSTRAINT [DF_catalog_selections_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[catalog_selections]...';


GO
ALTER TABLE [dbo].[catalog_selections]
    ADD DEFAULT ((0)) FOR [is_package];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_bom_modifications_price]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_bom_modifications]
    ADD CONSTRAINT [DF_catalog_selections_area_bom_modifications_price] DEFAULT ((0)) FOR [price];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_bom_modifications_create_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_bom_modifications]
    ADD CONSTRAINT [DF_catalog_selections_area_bom_modifications_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_bom_modifications_modified_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_bom_modifications]
    ADD CONSTRAINT [DF_catalog_selections_area_bom_modifications_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_detail_options_item_type]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_detail_options]
    ADD CONSTRAINT [DF_catalog_selections_area_detail_options_item_type] DEFAULT ('') FOR [item_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_detail_options_option_source]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_detail_options]
    ADD CONSTRAINT [DF_catalog_selections_area_detail_options_option_source] DEFAULT ('') FOR [option_source];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_detail_options_included]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_detail_options]
    ADD CONSTRAINT [DF_catalog_selections_area_detail_options_included] DEFAULT ((1)) FOR [included];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_detail_options_qty]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_detail_options]
    ADD CONSTRAINT [DF_catalog_selections_area_detail_options_qty] DEFAULT ((0)) FOR [qty];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_detail_options_retail_percentage]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_detail_options]
    ADD CONSTRAINT [DF_catalog_selections_area_detail_options_retail_percentage] DEFAULT ((1)) FOR [retail_percentage];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_detail_options_retail_percentage_type]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_detail_options]
    ADD CONSTRAINT [DF_catalog_selections_area_detail_options_retail_percentage_type] DEFAULT ('') FOR [retail_percentage_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_detail_options_price_type]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_detail_options]
    ADD CONSTRAINT [DF_catalog_selections_area_detail_options_price_type] DEFAULT ('') FOR [price_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_detail_options_pricing_source]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_detail_options]
    ADD CONSTRAINT [DF_catalog_selections_area_detail_options_pricing_source] DEFAULT ('') FOR [pricing_source];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_detail_options_error_message]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_detail_options]
    ADD CONSTRAINT [DF_catalog_selections_area_detail_options_error_message] DEFAULT ('') FOR [error_message];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_detail_options_author]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_detail_options]
    ADD CONSTRAINT [DF_catalog_selections_area_detail_options_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_detail_options_create_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_detail_options]
    ADD CONSTRAINT [DF_catalog_selections_area_detail_options_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_detail_options_modifier]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_detail_options]
    ADD CONSTRAINT [DF_catalog_selections_area_detail_options_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_detail_options_modified_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_detail_options]
    ADD CONSTRAINT [DF_catalog_selections_area_detail_options_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_item_type]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_item_type] DEFAULT ('') FOR [item_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_selectable]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_selectable] DEFAULT ((0)) FOR [selectable];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_bom_real_item_id]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_bom_real_item_id] DEFAULT ('') FOR [bom_real_item_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_real_item_id]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_real_item_id] DEFAULT ('') FOR [real_item_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_bom_bill_qty]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_bom_bill_qty] DEFAULT ((0)) FOR [bom_bill_qty];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_bom_uom_id]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_bom_uom_id] DEFAULT ('') FOR [bom_uom_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_builder_price]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_builder_price] DEFAULT ((0)) FOR [builder_price];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_homeowner_price]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_homeowner_price] DEFAULT ((0)) FOR [homeowner_price];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_pattern_id]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_pattern_id] DEFAULT ((0)) FOR [pattern_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_is_pattern_item]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_is_pattern_item] DEFAULT ((0)) FOR [is_pattern_item];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_pattern_percentage]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_pattern_percentage] DEFAULT ((100)) FOR [pattern_percentage];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_force_reprice]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_force_reprice] DEFAULT ((0)) FOR [force_reprice];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_price_type]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_price_type] DEFAULT ('') FOR [price_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_price_source]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_price_source] DEFAULT ('') FOR [price_source];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_retail_percentage]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_retail_percentage] DEFAULT ((1)) FOR [retail_percentage];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_retail_percentage_type]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_retail_percentage_type] DEFAULT ('') FOR [retail_percentage_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_accent_prompt]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_accent_prompt] DEFAULT ('') FOR [accent_prompt];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_priced]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_priced] DEFAULT ((0)) FOR [priced];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_bom_item_id]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_bom_item_id] DEFAULT ('') FOR [bom_item_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_author]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_create_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_modifier]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_modified_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [DF_catalog_selections_area_details_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_change_log_modification_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details_change_log]
    ADD CONSTRAINT [DF_catalog_selections_area_details_change_log_modification_date] DEFAULT ('') FOR [modification_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_lay_directions_author]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details_lay_directions]
    ADD CONSTRAINT [DF_catalog_selections_area_details_lay_directions_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_lay_directions_create_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details_lay_directions]
    ADD CONSTRAINT [DF_catalog_selections_area_details_lay_directions_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_lay_directions_modifier]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details_lay_directions]
    ADD CONSTRAINT [DF_catalog_selections_area_details_lay_directions_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_details_lay_directions_modified_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details_lay_directions]
    ADD CONSTRAINT [DF_catalog_selections_area_details_lay_directions_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_properties_id]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_properties]
    ADD CONSTRAINT [DF_catalog_selections_area_properties_id] DEFAULT (newid()) FOR [id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_properties_build_id]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_properties]
    ADD CONSTRAINT [DF_catalog_selections_area_properties_build_id] DEFAULT ((0)) FOR [build_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_properties_author]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_properties]
    ADD CONSTRAINT [DF_catalog_selections_area_properties_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_properties_create_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_properties]
    ADD CONSTRAINT [DF_catalog_selections_area_properties_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_properties_modifier]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_properties]
    ADD CONSTRAINT [DF_catalog_selections_area_properties_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_properties_modified_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_properties]
    ADD CONSTRAINT [DF_catalog_selections_area_properties_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_slabs_row_id]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_slabs]
    ADD CONSTRAINT [DF_catalog_selections_area_slabs_row_id] DEFAULT (newid()) FOR [row_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_slabs_author]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_slabs]
    ADD CONSTRAINT [DF_catalog_selections_area_slabs_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_slabs_create_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_slabs]
    ADD CONSTRAINT [DF_catalog_selections_area_slabs_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_slabs_modifier]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_slabs]
    ADD CONSTRAINT [DF_catalog_selections_area_slabs_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_area_slabs_modified_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_slabs]
    ADD CONSTRAINT [DF_catalog_selections_area_slabs_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_areas_area_id]...';


GO
ALTER TABLE [dbo].[catalog_selections_areas]
    ADD CONSTRAINT [DF_catalog_selections_areas_area_id] DEFAULT ('') FOR [area_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_areas_sub_area_id]...';


GO
ALTER TABLE [dbo].[catalog_selections_areas]
    ADD CONSTRAINT [DF_catalog_selections_areas_sub_area_id] DEFAULT ('') FOR [sub_area_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selection_areas_notes]...';


GO
ALTER TABLE [dbo].[catalog_selections_areas]
    ADD CONSTRAINT [DF_catalog_selection_areas_notes] DEFAULT ('') FOR [notes];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selection_areas_selection_total]...';


GO
ALTER TABLE [dbo].[catalog_selections_areas]
    ADD CONSTRAINT [DF_catalog_selection_areas_selection_total] DEFAULT ((0)) FOR [selection_total];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_areas_pattern_id]...';


GO
ALTER TABLE [dbo].[catalog_selections_areas]
    ADD CONSTRAINT [DF_catalog_selections_areas_pattern_id] DEFAULT ((0)) FOR [pattern_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_areas_area_selected]...';


GO
ALTER TABLE [dbo].[catalog_selections_areas]
    ADD CONSTRAINT [DF_catalog_selections_areas_area_selected] DEFAULT ((1)) FOR [area_selected];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_areas_build_id]...';


GO
ALTER TABLE [dbo].[catalog_selections_areas]
    ADD CONSTRAINT [DF_catalog_selections_areas_build_id] DEFAULT ((0)) FOR [build_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_areas_author]...';


GO
ALTER TABLE [dbo].[catalog_selections_areas]
    ADD CONSTRAINT [DF_catalog_selections_areas_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_areas_create_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_areas]
    ADD CONSTRAINT [DF_catalog_selections_areas_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_areas_modifier]...';


GO
ALTER TABLE [dbo].[catalog_selections_areas]
    ADD CONSTRAINT [DF_catalog_selections_areas_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_areas_modified_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_areas]
    ADD CONSTRAINT [DF_catalog_selections_areas_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_bom_modifications_quantity]...';


GO
ALTER TABLE [dbo].[catalog_selections_bom_modifications]
    ADD CONSTRAINT [DF_catalog_selections_bom_modifications_quantity] DEFAULT ((0)) FOR [quantity];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_bom_modifications_price]...';


GO
ALTER TABLE [dbo].[catalog_selections_bom_modifications]
    ADD CONSTRAINT [DF_catalog_selections_bom_modifications_price] DEFAULT ((0)) FOR [price];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_bom_modifications_option_pricing_display]...';


GO
ALTER TABLE [dbo].[catalog_selections_bom_modifications]
    ADD CONSTRAINT [DF_catalog_selections_bom_modifications_option_pricing_display] DEFAULT ((0)) FOR [option_pricing_display];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_bom_modifications_create_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_bom_modifications]
    ADD CONSTRAINT [DF_catalog_selections_bom_modifications_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_bom_modifications_modified_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_bom_modifications]
    ADD CONSTRAINT [DF_catalog_selections_bom_modifications_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_items_author]...';


GO
ALTER TABLE [dbo].[catalog_selections_designer_images]
    ADD CONSTRAINT [DF_catalog_selections_items_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_items_create_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_designer_images]
    ADD CONSTRAINT [DF_catalog_selections_items_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_items_modifier]...';


GO
ALTER TABLE [dbo].[catalog_selections_designer_images]
    ADD CONSTRAINT [DF_catalog_selections_items_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_items_modified_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_designer_images]
    ADD CONSTRAINT [DF_catalog_selections_items_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_error_log_source]...';


GO
ALTER TABLE [dbo].[catalog_selections_error_log]
    ADD CONSTRAINT [DF_catalog_selections_error_log_source] DEFAULT ('') FOR [source];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_group_detail_author]...';


GO
ALTER TABLE [dbo].[catalog_selections_group_detail]
    ADD CONSTRAINT [DF_catalog_selections_group_detail_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_group_detail_create_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_group_detail]
    ADD CONSTRAINT [DF_catalog_selections_group_detail_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_group_detail_modifier]...';


GO
ALTER TABLE [dbo].[catalog_selections_group_detail]
    ADD CONSTRAINT [DF_catalog_selections_group_detail_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_group_detail_modified_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_group_detail]
    ADD CONSTRAINT [DF_catalog_selections_group_detail_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_group_detail_area_id]...';


GO
ALTER TABLE [dbo].[catalog_selections_group_detail]
    ADD CONSTRAINT [DF_catalog_selections_group_detail_area_id] DEFAULT ('') FOR [area_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_group_detail_sub_area_id]...';


GO
ALTER TABLE [dbo].[catalog_selections_group_detail]
    ADD CONSTRAINT [DF_catalog_selections_group_detail_sub_area_id] DEFAULT ('') FOR [sub_area_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_price_level_boms_author]...';


GO
ALTER TABLE [dbo].[catalog_selections_price_level_boms]
    ADD CONSTRAINT [DF_catalog_selections_price_level_boms_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_price_level_boms_create_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_price_level_boms]
    ADD CONSTRAINT [DF_catalog_selections_price_level_boms_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_price_level_boms_modifier]...';


GO
ALTER TABLE [dbo].[catalog_selections_price_level_boms]
    ADD CONSTRAINT [DF_catalog_selections_price_level_boms_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_price_level_boms_modified_date]...';


GO
ALTER TABLE [dbo].[catalog_selections_price_level_boms]
    ADD CONSTRAINT [DF_catalog_selections_price_level_boms_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_commission_rates_author]...';


GO
ALTER TABLE [dbo].[commission_rates]
    ADD CONSTRAINT [DF_commission_rates_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_commission_rates_create_date]...';


GO
ALTER TABLE [dbo].[commission_rates]
    ADD CONSTRAINT [DF_commission_rates_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_commission_rates_modifier]...';


GO
ALTER TABLE [dbo].[commission_rates]
    ADD CONSTRAINT [DF_commission_rates_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_commission_rates_modified_date]...';


GO
ALTER TABLE [dbo].[commission_rates]
    ADD CONSTRAINT [DF_commission_rates_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_default_support_emails_author]...';


GO
ALTER TABLE [dbo].[default_support_emails]
    ADD CONSTRAINT [DF_default_support_emails_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_default_support_emails_create_date]...';


GO
ALTER TABLE [dbo].[default_support_emails]
    ADD CONSTRAINT [DF_default_support_emails_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_default_support_emails_modifier]...';


GO
ALTER TABLE [dbo].[default_support_emails]
    ADD CONSTRAINT [DF_default_support_emails_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_default_support_emails_modified_date]...';


GO
ALTER TABLE [dbo].[default_support_emails]
    ADD CONSTRAINT [DF_default_support_emails_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_email_events_id]...';


GO
ALTER TABLE [dbo].[email_events]
    ADD CONSTRAINT [DF_email_events_id] DEFAULT NEWID() FOR [id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_event_log_event_log_id]...';


GO
ALTER TABLE [dbo].[event_log]
    ADD CONSTRAINT [DF_event_log_event_log_id] DEFAULT (newid()) FOR [event_log_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_features_author]...';


GO
ALTER TABLE [dbo].[features]
    ADD CONSTRAINT [DF_features_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_features_create_date]...';


GO
ALTER TABLE [dbo].[features]
    ADD CONSTRAINT [DF_features_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_features_modifier]...';


GO
ALTER TABLE [dbo].[features]
    ADD CONSTRAINT [DF_features_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_features_modified_date]...';


GO
ALTER TABLE [dbo].[features]
    ADD CONSTRAINT [DF_features_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_floorplans_id]...';


GO
ALTER TABLE [dbo].[floorplans]
    ADD CONSTRAINT [DF_floorplans_id] DEFAULT (newid()) FOR [id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_floorplans_author]...';


GO
ALTER TABLE [dbo].[floorplans]
    ADD CONSTRAINT [DF_floorplans_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_floorplans_create_date]...';


GO
ALTER TABLE [dbo].[floorplans]
    ADD CONSTRAINT [DF_floorplans_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_floorplans_modifier]...';


GO
ALTER TABLE [dbo].[floorplans]
    ADD CONSTRAINT [DF_floorplans_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_floorplans_modified_date]...';


GO
ALTER TABLE [dbo].[floorplans]
    ADD CONSTRAINT [DF_floorplans_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_floorplans_sequence_author]...';


GO
ALTER TABLE [dbo].[floorplans_sequence]
    ADD CONSTRAINT [DF_floorplans_sequence_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_floorplans_sequence_create_date]...';


GO
ALTER TABLE [dbo].[floorplans_sequence]
    ADD CONSTRAINT [DF_floorplans_sequence_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_floorplans_sequence_modifier]...';


GO
ALTER TABLE [dbo].[floorplans_sequence]
    ADD CONSTRAINT [DF_floorplans_sequence_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_floorplans_sequence_modified_date]...';


GO
ALTER TABLE [dbo].[floorplans_sequence]
    ADD CONSTRAINT [DF_floorplans_sequence_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_homebuyer_catalog_estimated_selections_author]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_estimated_selections]
    ADD CONSTRAINT [DF_homebuyer_catalog_estimated_selections_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_homebuyer_catalog_estimated_selections_create_date]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_estimated_selections]
    ADD CONSTRAINT [DF_homebuyer_catalog_estimated_selections_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_homebuyer_catalog_estimated_selections_modifier]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_estimated_selections]
    ADD CONSTRAINT [DF_homebuyer_catalog_estimated_selections_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_homebuyer_catalog_estimated_selections_modified_date]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_estimated_selections]
    ADD CONSTRAINT [DF_homebuyer_catalog_estimated_selections_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[homebuyer_catalog_nonestimated_selections]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_nonestimated_selections]
    ADD DEFAULT 1 FOR [quantity];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[homebuyer_catalog_nonestimated_selections]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_nonestimated_selections]
    ADD DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[homebuyer_catalog_nonestimated_selections]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_nonestimated_selections]
    ADD DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[homebuyer_catalog_nonestimated_selections]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_nonestimated_selections]
    ADD DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[homebuyer_catalog_nonestimated_selections]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_nonestimated_selections]
    ADD DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_homebuyer_catalog_price_level_filters_author]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_price_level_filters]
    ADD CONSTRAINT [DF_homebuyer_catalog_price_level_filters_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_homebuyer_catalog_price_level_filters_create_date]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_price_level_filters]
    ADD CONSTRAINT [DF_homebuyer_catalog_price_level_filters_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_homebuyer_catalog_price_level_filters_modifier]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_price_level_filters]
    ADD CONSTRAINT [DF_homebuyer_catalog_price_level_filters_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_homebuyer_catalog_price_level_filters_modified_date]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_price_level_filters]
    ADD CONSTRAINT [DF_homebuyer_catalog_price_level_filters_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_homebuyer_orientation_row_id]...';


GO
ALTER TABLE [dbo].[homebuyer_orientation]
    ADD CONSTRAINT [DF_homebuyer_orientation_row_id] DEFAULT (newid()) FOR [row_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_homebuyer_orientation_create_date]...';


GO
ALTER TABLE [dbo].[homebuyer_orientation]
    ADD CONSTRAINT [DF_homebuyer_orientation_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_homebuyer_orientation_modified_date]...';


GO
ALTER TABLE [dbo].[homebuyer_orientation]
    ADD CONSTRAINT [DF_homebuyer_orientation_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[icon]...';


GO
ALTER TABLE [dbo].[icon]
    ADD DEFAULT (NEWID()) FOR [id];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[icon]...';


GO
ALTER TABLE [dbo].[icon]
    ADD DEFAULT (SUSER_SNAME()) FOR [author];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[icon]...';


GO
ALTER TABLE [dbo].[icon]
    ADD DEFAULT (GETDATE()) FOR [create_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[icon]...';


GO
ALTER TABLE [dbo].[icon]
    ADD DEFAULT (SUSER_SNAME()) FOR [modifier];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[icon]...';


GO
ALTER TABLE [dbo].[icon]
    ADD DEFAULT (GETDATE()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[icon_tags]...';


GO
ALTER TABLE [dbo].[icon_tags]
    ADD DEFAULT (SUSER_SNAME()) FOR [author];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[icon_tags]...';


GO
ALTER TABLE [dbo].[icon_tags]
    ADD DEFAULT (GETDATE()) FOR [create_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[icon_tags]...';


GO
ALTER TABLE [dbo].[icon_tags]
    ADD DEFAULT (SUSER_SNAME()) FOR [modifier];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[icon_tags]...';


GO
ALTER TABLE [dbo].[icon_tags]
    ADD DEFAULT (GETDATE()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_invoice_lines_application]...';


GO
ALTER TABLE [dbo].[invoice_lines]
    ADD CONSTRAINT [DF_invoice_lines_application] DEFAULT ('') FOR [application];


GO
PRINT N'Creating Default Constraint [dbo].[DF_invoice_lines_product]...';


GO
ALTER TABLE [dbo].[invoice_lines]
    ADD CONSTRAINT [DF_invoice_lines_product] DEFAULT ('') FOR [product];


GO
PRINT N'Creating Default Constraint [dbo].[DF_invoice_lines_area]...';


GO
ALTER TABLE [dbo].[invoice_lines]
    ADD CONSTRAINT [DF_invoice_lines_area] DEFAULT ('') FOR [area];


GO
PRINT N'Creating Default Constraint [dbo].[DF_invoice_lines_item]...';


GO
ALTER TABLE [dbo].[invoice_lines]
    ADD CONSTRAINT [DF_invoice_lines_item] DEFAULT ('') FOR [item];


GO
PRINT N'Creating Default Constraint [dbo].[DF_invoice_lines_vendor]...';


GO
ALTER TABLE [dbo].[invoice_lines]
    ADD CONSTRAINT [DF_invoice_lines_vendor] DEFAULT ('') FOR [vendor];


GO
PRINT N'Creating Default Constraint [dbo].[DF_invoice_lines_line_amount]...';


GO
ALTER TABLE [dbo].[invoice_lines]
    ADD CONSTRAINT [DF_invoice_lines_line_amount] DEFAULT ((0)) FOR [line_amount];


GO
PRINT N'Creating Default Constraint [dbo].[DF_invoice_lines_orig_line_amount]...';


GO
ALTER TABLE [dbo].[invoice_lines]
    ADD CONSTRAINT [DF_invoice_lines_orig_line_amount] DEFAULT ((0)) FOR [orig_line_amount];


GO
PRINT N'Creating Default Constraint [dbo].[DF_invoice_lines_invoice]...';


GO
ALTER TABLE [dbo].[invoice_lines]
    ADD CONSTRAINT [DF_invoice_lines_invoice] DEFAULT ((0)) FOR [invoice];


GO
PRINT N'Creating Default Constraint [dbo].[DF_invoice_lines_invoice_amount]...';


GO
ALTER TABLE [dbo].[invoice_lines]
    ADD CONSTRAINT [DF_invoice_lines_invoice_amount] DEFAULT ((0)) FOR [invoice_amount];


GO
PRINT N'Creating Default Constraint [dbo].[DF_invoice_lines_notes]...';


GO
ALTER TABLE [dbo].[invoice_lines]
    ADD CONSTRAINT [DF_invoice_lines_notes] DEFAULT ('') FOR [notes];


GO
PRINT N'Creating Default Constraint [dbo].[DF_invoice_lines_author]...';


GO
ALTER TABLE [dbo].[invoice_lines]
    ADD CONSTRAINT [DF_invoice_lines_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_invoice_lines_create_date]...';


GO
ALTER TABLE [dbo].[invoice_lines]
    ADD CONSTRAINT [DF_invoice_lines_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_invoice_lines_modifier]...';


GO
ALTER TABLE [dbo].[invoice_lines]
    ADD CONSTRAINT [DF_invoice_lines_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_invoice_lines_modified_date]...';


GO
ALTER TABLE [dbo].[invoice_lines]
    ADD CONSTRAINT [DF_invoice_lines_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_invoices_author]...';


GO
ALTER TABLE [dbo].[invoices]
    ADD CONSTRAINT [DF_catalog_selections_invoices_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_invoices_create_date]...';


GO
ALTER TABLE [dbo].[invoices]
    ADD CONSTRAINT [DF_catalog_selections_invoices_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_invoices_modifier]...';


GO
ALTER TABLE [dbo].[invoices]
    ADD CONSTRAINT [DF_catalog_selections_invoices_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_catalog_selections_invoices_modified_date]...';


GO
ALTER TABLE [dbo].[invoices]
    ADD CONSTRAINT [DF_catalog_selections_invoices_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_jobs_stages_id]...';


GO
ALTER TABLE [dbo].[jobs_stages]
    ADD CONSTRAINT [DF_jobs_stages_id] DEFAULT (newid()) FOR [id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_jobs_stages_author]...';


GO
ALTER TABLE [dbo].[jobs_stages]
    ADD CONSTRAINT [DF_jobs_stages_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_jobs_stages_create_date]...';


GO
ALTER TABLE [dbo].[jobs_stages]
    ADD CONSTRAINT [DF_jobs_stages_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_jobs_stages_modifier]...';


GO
ALTER TABLE [dbo].[jobs_stages]
    ADD CONSTRAINT [DF_jobs_stages_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_jobs_stages_modified_date]...';


GO
ALTER TABLE [dbo].[jobs_stages]
    ADD CONSTRAINT [DF_jobs_stages_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_id]...';


GO
ALTER TABLE [dbo].[plan_budget]
    ADD CONSTRAINT [DF_plan_budget_id] DEFAULT (newid()) FOR [id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_upgrade_budget]...';


GO
ALTER TABLE [dbo].[plan_budget]
    ADD CONSTRAINT [DF_plan_budget_upgrade_budget] DEFAULT 0 FOR [upgrade_budget];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_monthly_payment_home]...';


GO
ALTER TABLE [dbo].[plan_budget]
    ADD CONSTRAINT [DF_plan_budget_monthly_payment_home] DEFAULT 0 FOR [monthly_payment_home];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_monthly_payment_upgrades]...';


GO
ALTER TABLE [dbo].[plan_budget]
    ADD CONSTRAINT [DF_plan_budget_monthly_payment_upgrades] DEFAULT 0 FOR [monthly_payment_upgrades];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_monthly_payment_total]...';


GO
ALTER TABLE [dbo].[plan_budget]
    ADD CONSTRAINT [DF_plan_budget_monthly_payment_total] DEFAULT 0 FOR [monthly_payment_total];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_author]...';


GO
ALTER TABLE [dbo].[plan_budget]
    ADD CONSTRAINT [DF_plan_budget_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_create_date]...';


GO
ALTER TABLE [dbo].[plan_budget]
    ADD CONSTRAINT [DF_plan_budget_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_modifier]...';


GO
ALTER TABLE [dbo].[plan_budget]
    ADD CONSTRAINT [DF_plan_budget_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_modified_date]...';


GO
ALTER TABLE [dbo].[plan_budget]
    ADD CONSTRAINT [DF_plan_budget_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_values_id]...';


GO
ALTER TABLE [dbo].[plan_budget_values]
    ADD CONSTRAINT [DF_plan_budget_values_id] DEFAULT (newid()) FOR [id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_values_value]...';


GO
ALTER TABLE [dbo].[plan_budget_values]
    ADD CONSTRAINT [DF_plan_budget_values_value] DEFAULT 0 FOR [value];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_values_author]...';


GO
ALTER TABLE [dbo].[plan_budget_values]
    ADD CONSTRAINT [DF_plan_budget_values_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_values_create_date]...';


GO
ALTER TABLE [dbo].[plan_budget_values]
    ADD CONSTRAINT [DF_plan_budget_values_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_values_modifier]...';


GO
ALTER TABLE [dbo].[plan_budget_values]
    ADD CONSTRAINT [DF_plan_budget_values_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_values_modified_date]...';


GO
ALTER TABLE [dbo].[plan_budget_values]
    ADD CONSTRAINT [DF_plan_budget_values_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_values_names_data_type]...';


GO
ALTER TABLE [dbo].[plan_budget_values_names]
    ADD CONSTRAINT [DF_plan_budget_values_names_data_type] DEFAULT ('') FOR [data_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_values_names_required]...';


GO
ALTER TABLE [dbo].[plan_budget_values_names]
    ADD CONSTRAINT [DF_plan_budget_values_names_required] DEFAULT (0) FOR [required];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_values_names_enabled_by_default]...';


GO
ALTER TABLE [dbo].[plan_budget_values_names]
    ADD CONSTRAINT [DF_plan_budget_values_names_enabled_by_default] DEFAULT (0) FOR [enabled_by_default];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_values_names_community_default]...';


GO
ALTER TABLE [dbo].[plan_budget_values_names]
    ADD CONSTRAINT [DF_plan_budget_values_names_community_default] DEFAULT (0) FOR [community_default];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_values_names_author]...';


GO
ALTER TABLE [dbo].[plan_budget_values_names]
    ADD CONSTRAINT [DF_plan_budget_values_names_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_values_names_create_date]...';


GO
ALTER TABLE [dbo].[plan_budget_values_names]
    ADD CONSTRAINT [DF_plan_budget_values_names_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_values_names_modifier]...';


GO
ALTER TABLE [dbo].[plan_budget_values_names]
    ADD CONSTRAINT [DF_plan_budget_values_names_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_budget_values_names_modified_date]...';


GO
ALTER TABLE [dbo].[plan_budget_values_names]
    ADD CONSTRAINT [DF_plan_budget_values_names_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_session_documents_types_author]...';


GO
ALTER TABLE [dbo].[plan_document_types]
    ADD CONSTRAINT [DF_session_documents_types_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_session_documents_types_create_date]...';


GO
ALTER TABLE [dbo].[plan_document_types]
    ADD CONSTRAINT [DF_session_documents_types_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_session_documents_types_modifier]...';


GO
ALTER TABLE [dbo].[plan_document_types]
    ADD CONSTRAINT [DF_session_documents_types_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_session_documents_types_modified_date]...';


GO
ALTER TABLE [dbo].[plan_document_types]
    ADD CONSTRAINT [DF_session_documents_types_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_documents_author]...';


GO
ALTER TABLE [dbo].[plan_documents]
    ADD CONSTRAINT [DF_plan_documents_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_documents_create_date]...';


GO
ALTER TABLE [dbo].[plan_documents]
    ADD CONSTRAINT [DF_plan_documents_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_documents_modifier]...';


GO
ALTER TABLE [dbo].[plan_documents]
    ADD CONSTRAINT [DF_plan_documents_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_plan_documents_modified_date]...';


GO
ALTER TABLE [dbo].[plan_documents]
    ADD CONSTRAINT [DF_plan_documents_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_primary_plan_catalogs_author]...';


GO
ALTER TABLE [dbo].[primary_plan_catalogs]
    ADD CONSTRAINT [DF_primary_plan_catalogs_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_primary_plan_catalogs_create_date]...';


GO
ALTER TABLE [dbo].[primary_plan_catalogs]
    ADD CONSTRAINT [DF_primary_plan_catalogs_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_primary_plan_catalogs_modifier]...';


GO
ALTER TABLE [dbo].[primary_plan_catalogs]
    ADD CONSTRAINT [DF_primary_plan_catalogs_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_primary_plan_catalogs_modified_date]...';


GO
ALTER TABLE [dbo].[primary_plan_catalogs]
    ADD CONSTRAINT [DF_primary_plan_catalogs_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_problem_types_author]...';


GO
ALTER TABLE [dbo].[problem_types]
    ADD CONSTRAINT [DF_problem_types_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_problem_types_create_date]...';


GO
ALTER TABLE [dbo].[problem_types]
    ADD CONSTRAINT [DF_problem_types_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_problem_types_modifier]...';


GO
ALTER TABLE [dbo].[problem_types]
    ADD CONSTRAINT [DF_problem_types_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_problem_types_modified_date]...';


GO
ALTER TABLE [dbo].[problem_types]
    ADD CONSTRAINT [DF_problem_types_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_report_storage_report_type]...';


GO
ALTER TABLE [dbo].[report_storage]
    ADD CONSTRAINT [DF_report_storage_report_type] DEFAULT ('') FOR [report_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_report_storage_report_output_type]...';


GO
ALTER TABLE [dbo].[report_storage]
    ADD CONSTRAINT [DF_report_storage_report_output_type] DEFAULT ('') FOR [report_output_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_report_storage_author]...';


GO
ALTER TABLE [dbo].[report_storage]
    ADD CONSTRAINT [DF_report_storage_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_report_storage_create_date]...';


GO
ALTER TABLE [dbo].[report_storage]
    ADD CONSTRAINT [DF_report_storage_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_report_storage_modifier]...';


GO
ALTER TABLE [dbo].[report_storage]
    ADD CONSTRAINT [DF_report_storage_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_report_storage_modified_date]...';


GO
ALTER TABLE [dbo].[report_storage]
    ADD CONSTRAINT [DF_report_storage_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[restricted_application_product]...';


GO
ALTER TABLE [dbo].[restricted_application_product]
    ADD DEFAULT (newid()) FOR [id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_restricted_application_product_author]...';


GO
ALTER TABLE [dbo].[restricted_application_product]
    ADD CONSTRAINT [DF_restricted_application_product_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_restricted_application_product_create_date]...';


GO
ALTER TABLE [dbo].[restricted_application_product]
    ADD CONSTRAINT [DF_restricted_application_product_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_restricted_application_product_modifier]...';


GO
ALTER TABLE [dbo].[restricted_application_product]
    ADD CONSTRAINT [DF_restricted_application_product_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_restricted_application_product_modified_date]...';


GO
ALTER TABLE [dbo].[restricted_application_product]
    ADD CONSTRAINT [DF_restricted_application_product_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[room_sections]...';


GO
ALTER TABLE [dbo].[room_sections]
    ADD DEFAULT newid() FOR [id];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[room_sections]...';


GO
ALTER TABLE [dbo].[room_sections]
    ADD DEFAULT suser_sname() FOR [author];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[room_sections]...';


GO
ALTER TABLE [dbo].[room_sections]
    ADD DEFAULT getdate() FOR [create_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[room_sections]...';


GO
ALTER TABLE [dbo].[room_sections]
    ADD DEFAULT suser_sname() FOR [modifier];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[room_sections]...';


GO
ALTER TABLE [dbo].[room_sections]
    ADD DEFAULT getdate() FOR [modified_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[rooms]...';


GO
ALTER TABLE [dbo].[rooms]
    ADD DEFAULT (newid()) FOR [id];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[rooms]...';


GO
ALTER TABLE [dbo].[rooms]
    ADD DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[rooms]...';


GO
ALTER TABLE [dbo].[rooms]
    ADD DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[rooms]...';


GO
ALTER TABLE [dbo].[rooms]
    ADD DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[rooms]...';


GO
ALTER TABLE [dbo].[rooms]
    ADD DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointment_confirmation_log_id]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_confirmation_log]
    ADD CONSTRAINT [DF_scheduling_appointment_confirmation_log_id] DEFAULT (newid()) FOR [id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_templates_author]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_templates]
    ADD CONSTRAINT [DF_scheduling_templates_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_templates_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_templates]
    ADD CONSTRAINT [DF_scheduling_templates_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_templates_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_templates]
    ADD CONSTRAINT [DF_scheduling_templates_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_templates_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_templates]
    ADD CONSTRAINT [DF_scheduling_templates_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointment_templates_appointments_template_appointment_id]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_templates_detail]
    ADD CONSTRAINT [DF_scheduling_appointment_templates_appointments_template_appointment_id] DEFAULT (newid()) FOR [template_appointment_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointment_templates_appointments_appointment_type]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_templates_detail]
    ADD CONSTRAINT [DF_scheduling_appointment_templates_appointments_appointment_type] DEFAULT ((0)) FOR [appointment_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointment_templates_appointments_duration]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_templates_detail]
    ADD CONSTRAINT [DF_scheduling_appointment_templates_appointments_duration] DEFAULT ((0)) FOR [duration];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointment_templates_appointments_author]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_templates_detail]
    ADD CONSTRAINT [DF_scheduling_appointment_templates_appointments_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointment_templates_appointments_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_templates_detail]
    ADD CONSTRAINT [DF_scheduling_appointment_templates_appointments_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointment_templates_appointments_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_templates_detail]
    ADD CONSTRAINT [DF_scheduling_appointment_templates_appointments_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointment_templates_appointments_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_templates_detail]
    ADD CONSTRAINT [DF_scheduling_appointment_templates_appointments_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointment_types_author]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_types]
    ADD CONSTRAINT [DF_scheduling_appointment_types_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointment_types_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_types]
    ADD CONSTRAINT [DF_scheduling_appointment_types_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointment_types_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_types]
    ADD CONSTRAINT [DF_scheduling_appointment_types_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointment_types_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_types]
    ADD CONSTRAINT [DF_scheduling_appointment_types_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointments_appointment_id]...';


GO
ALTER TABLE [dbo].[scheduling_appointments]
    ADD CONSTRAINT [DF_scheduling_appointments_appointment_id] DEFAULT (newid()) FOR [appointment_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointments_appointment_duration]...';


GO
ALTER TABLE [dbo].[scheduling_appointments]
    ADD CONSTRAINT [DF_scheduling_appointments_appointment_duration] DEFAULT ((0)) FOR [appointment_duration];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointments_is_scheduled]...';


GO
ALTER TABLE [dbo].[scheduling_appointments]
    ADD CONSTRAINT [DF_scheduling_appointments_is_scheduled] DEFAULT ((0)) FOR [is_scheduled];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointments_is_conflict]...';


GO
ALTER TABLE [dbo].[scheduling_appointments]
    ADD CONSTRAINT [DF_scheduling_appointments_is_conflict] DEFAULT ((0)) FOR [is_conflict];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointments_calendar_label]...';


GO
ALTER TABLE [dbo].[scheduling_appointments]
    ADD CONSTRAINT [DF_scheduling_appointments_calendar_label] DEFAULT ('') FOR [appointment_label];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointments_appointment_note]...';


GO
ALTER TABLE [dbo].[scheduling_appointments]
    ADD CONSTRAINT [DF_scheduling_appointments_appointment_note] DEFAULT ('') FOR [appointment_note];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointments_virtual]...';


GO
ALTER TABLE [dbo].[scheduling_appointments]
    ADD CONSTRAINT [DF_scheduling_appointments_virtual] DEFAULT ((0)) FOR [is_virtual];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointments_inDesign]...';


GO
ALTER TABLE [dbo].[scheduling_appointments]
    ADD CONSTRAINT [DF_scheduling_appointments_inDesign] DEFAULT ((0)) FOR [in_design];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointments_author]...';


GO
ALTER TABLE [dbo].[scheduling_appointments]
    ADD CONSTRAINT [DF_scheduling_appointments_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointments_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_appointments]
    ADD CONSTRAINT [DF_scheduling_appointments_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointments_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_appointments]
    ADD CONSTRAINT [DF_scheduling_appointments_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_appointments_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_appointments]
    ADD CONSTRAINT [DF_scheduling_appointments_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_buyers_buyer_name]...';


GO
ALTER TABLE [dbo].[scheduling_buyers]
    ADD CONSTRAINT [DF_scheduling_buyers_buyer_name] DEFAULT ('') FOR [buyer_name];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_buyers_author]...';


GO
ALTER TABLE [dbo].[scheduling_buyers]
    ADD CONSTRAINT [DF_scheduling_buyers_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_buyers_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_buyers]
    ADD CONSTRAINT [DF_scheduling_buyers_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_buyers_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_buyers]
    ADD CONSTRAINT [DF_scheduling_buyers_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_buyers_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_buyers]
    ADD CONSTRAINT [DF_scheduling_buyers_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_buyer_contacts_is_buyer]...';


GO
ALTER TABLE [dbo].[scheduling_buyers_contacts]
    ADD CONSTRAINT [DF_scheduling_buyer_contacts_is_buyer] DEFAULT ((0)) FOR [is_buyer];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_buyer_contacts_mobile_phone_send_message]...';


GO
ALTER TABLE [dbo].[scheduling_buyers_contacts]
    ADD CONSTRAINT [DF_scheduling_buyer_contacts_mobile_phone_send_message] DEFAULT ((0)) FOR [mobile_phone_send_message];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_buyer_contacts_work_phone_send_message]...';


GO
ALTER TABLE [dbo].[scheduling_buyers_contacts]
    ADD CONSTRAINT [DF_scheduling_buyer_contacts_work_phone_send_message] DEFAULT ((0)) FOR [work_phone_send_message];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_buyer_contacts_home_phone_send_message]...';


GO
ALTER TABLE [dbo].[scheduling_buyers_contacts]
    ADD CONSTRAINT [DF_scheduling_buyer_contacts_home_phone_send_message] DEFAULT ((0)) FOR [home_phone_send_message];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_buyers_contacts_active]...';


GO
ALTER TABLE [dbo].[scheduling_buyers_contacts]
    ADD CONSTRAINT [DF_scheduling_buyers_contacts_active] DEFAULT ((0)) FOR [active];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_buyer_contacts_author]...';


GO
ALTER TABLE [dbo].[scheduling_buyers_contacts]
    ADD CONSTRAINT [DF_scheduling_buyer_contacts_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_buyer_contacts_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_buyers_contacts]
    ADD CONSTRAINT [DF_scheduling_buyer_contacts_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_buyer_contacts_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_buyers_contacts]
    ADD CONSTRAINT [DF_scheduling_buyer_contacts_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_buyer_contacts_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_buyers_contacts]
    ADD CONSTRAINT [DF_scheduling_buyer_contacts_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_message_types_message_type_name]...';


GO
ALTER TABLE [dbo].[scheduling_message_types]
    ADD CONSTRAINT [DF_scheduling_message_types_message_type_name] DEFAULT ('') FOR [message_type_name];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_message_types_author]...';


GO
ALTER TABLE [dbo].[scheduling_message_types]
    ADD CONSTRAINT [DF_scheduling_message_types_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_message_types_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_message_types]
    ADD CONSTRAINT [DF_scheduling_message_types_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_message_types_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_message_types]
    ADD CONSTRAINT [DF_scheduling_message_types_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_message_types_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_message_types]
    ADD CONSTRAINT [DF_scheduling_message_types_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_messages_is_read]...';


GO
ALTER TABLE [dbo].[scheduling_messages]
    ADD CONSTRAINT [DF_scheduling_messages_is_read] DEFAULT ((0)) FOR [is_read];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_messages_message_title]...';


GO
ALTER TABLE [dbo].[scheduling_messages]
    ADD CONSTRAINT [DF_scheduling_messages_message_title] DEFAULT ('') FOR [message_title];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_messages_message_priority]...';


GO
ALTER TABLE [dbo].[scheduling_messages]
    ADD CONSTRAINT [DF_scheduling_messages_message_priority] DEFAULT ((0)) FOR [message_priority];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_messages_dismissed]...';


GO
ALTER TABLE [dbo].[scheduling_messages]
    ADD CONSTRAINT [DF_scheduling_messages_dismissed] DEFAULT ((0)) FOR [dismissed];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_messages_author]...';


GO
ALTER TABLE [dbo].[scheduling_messages]
    ADD CONSTRAINT [DF_scheduling_messages_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_messages_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_messages]
    ADD CONSTRAINT [DF_scheduling_messages_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_messages_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_messages]
    ADD CONSTRAINT [DF_scheduling_messages_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_messages_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_messages]
    ADD CONSTRAINT [DF_scheduling_messages_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_organizations_author]...';


GO
ALTER TABLE [dbo].[scheduling_organizations]
    ADD CONSTRAINT [DF_scheduling_organizations_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_organizations_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_organizations]
    ADD CONSTRAINT [DF_scheduling_organizations_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_organizations_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_organizations]
    ADD CONSTRAINT [DF_scheduling_organizations_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_organizations_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_organizations]
    ADD CONSTRAINT [DF_scheduling_organizations_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_roles_author]...';


GO
ALTER TABLE [dbo].[scheduling_roles]
    ADD CONSTRAINT [DF_scheduling_roles_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_roles_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_roles]
    ADD CONSTRAINT [DF_scheduling_roles_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_roles_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_roles]
    ADD CONSTRAINT [DF_scheduling_roles_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_roles_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_roles]
    ADD CONSTRAINT [DF_scheduling_roles_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_settings_setting_name]...';


GO
ALTER TABLE [dbo].[scheduling_settings]
    ADD CONSTRAINT [DF_scheduling_settings_setting_name] DEFAULT 'Default Setting Name' FOR [setting_name];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_sms_opt_in_invite_date]...';


GO
ALTER TABLE [dbo].[scheduling_sms_opt_in]
    ADD CONSTRAINT [DF_scheduling_sms_opt_in_invite_date] DEFAULT (getdate()) FOR [invite_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_sms_opt_in_is_pending_confirmation]...';


GO
ALTER TABLE [dbo].[scheduling_sms_opt_in]
    ADD CONSTRAINT [DF_scheduling_sms_opt_in_is_pending_confirmation] DEFAULT ((1)) FOR [is_pending_confirmation];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_sms_opt_in_is_opted_in]...';


GO
ALTER TABLE [dbo].[scheduling_sms_opt_in]
    ADD CONSTRAINT [DF_scheduling_sms_opt_in_is_opted_in] DEFAULT ((0)) FOR [is_opted_in];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_sms_opt_in_reply_message]...';


GO
ALTER TABLE [dbo].[scheduling_sms_opt_in]
    ADD CONSTRAINT [DF_scheduling_sms_opt_in_reply_message] DEFAULT ('') FOR [reply_message];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_status_author]...';


GO
ALTER TABLE [dbo].[scheduling_status]
    ADD CONSTRAINT [DF_scheduling_status_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_status_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_status]
    ADD CONSTRAINT [DF_scheduling_status_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_status_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_status]
    ADD CONSTRAINT [DF_scheduling_status_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_status_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_status]
    ADD CONSTRAINT [DF_scheduling_status_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_locations_author]...';


GO
ALTER TABLE [dbo].[scheduling_user_locations]
    ADD CONSTRAINT [DF_scheduling_user_locations_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_locations_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_user_locations]
    ADD CONSTRAINT [DF_scheduling_user_locations_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_locations_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_user_locations]
    ADD CONSTRAINT [DF_scheduling_user_locations_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_locations_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_user_locations]
    ADD CONSTRAINT [DF_scheduling_user_locations_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_organizations_author]...';


GO
ALTER TABLE [dbo].[scheduling_user_organizations]
    ADD CONSTRAINT [DF_scheduling_user_organizations_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_organizations_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_user_organizations]
    ADD CONSTRAINT [DF_scheduling_user_organizations_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_organizations_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_user_organizations]
    ADD CONSTRAINT [DF_scheduling_user_organizations_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_organizations_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_user_organizations]
    ADD CONSTRAINT [DF_scheduling_user_organizations_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_options_author]...';


GO
ALTER TABLE [dbo].[scheduling_user_preferences]
    ADD CONSTRAINT [DF_scheduling_user_options_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_options_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_user_preferences]
    ADD CONSTRAINT [DF_scheduling_user_options_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_options_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_user_preferences]
    ADD CONSTRAINT [DF_scheduling_user_options_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_options_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_user_preferences]
    ADD CONSTRAINT [DF_scheduling_user_options_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_roles_author]...';


GO
ALTER TABLE [dbo].[scheduling_user_roles]
    ADD CONSTRAINT [DF_scheduling_user_roles_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_roles_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_user_roles]
    ADD CONSTRAINT [DF_scheduling_user_roles_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_roles_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_user_roles]
    ADD CONSTRAINT [DF_scheduling_user_roles_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_roles_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_user_roles]
    ADD CONSTRAINT [DF_scheduling_user_roles_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_settings_author]...';


GO
ALTER TABLE [dbo].[scheduling_user_settings]
    ADD CONSTRAINT [DF_scheduling_user_settings_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_settings_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_user_settings]
    ADD CONSTRAINT [DF_scheduling_user_settings_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_settings_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_user_settings]
    ADD CONSTRAINT [DF_scheduling_user_settings_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_settings_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_user_settings]
    ADD CONSTRAINT [DF_scheduling_user_settings_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_work_schedules_author]...';


GO
ALTER TABLE [dbo].[scheduling_user_work_schedules]
    ADD CONSTRAINT [DF_scheduling_user_work_schedules_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_work_schedules_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_user_work_schedules]
    ADD CONSTRAINT [DF_scheduling_user_work_schedules_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_work_schedules_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_user_work_schedules]
    ADD CONSTRAINT [DF_scheduling_user_work_schedules_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_user_work_schedules_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_user_work_schedules]
    ADD CONSTRAINT [DF_scheduling_user_work_schedules_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_users_author]...';


GO
ALTER TABLE [dbo].[scheduling_users]
    ADD CONSTRAINT [DF_scheduling_users_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_users_create_date]...';


GO
ALTER TABLE [dbo].[scheduling_users]
    ADD CONSTRAINT [DF_scheduling_users_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_users_modifier]...';


GO
ALTER TABLE [dbo].[scheduling_users]
    ADD CONSTRAINT [DF_scheduling_users_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_scheduling_users_modified_date]...';


GO
ALTER TABLE [dbo].[scheduling_users]
    ADD CONSTRAINT [DF_scheduling_users_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_session_designer_documents_author]...';


GO
ALTER TABLE [dbo].[session_designer_documents]
    ADD CONSTRAINT [DF_session_designer_documents_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_session_designer_documents_create_date]...';


GO
ALTER TABLE [dbo].[session_designer_documents]
    ADD CONSTRAINT [DF_session_designer_documents_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_session_designer_documents_modifier]...';


GO
ALTER TABLE [dbo].[session_designer_documents]
    ADD CONSTRAINT [DF_session_designer_documents_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_session_designer_documents_modified_date]...';


GO
ALTER TABLE [dbo].[session_designer_documents]
    ADD CONSTRAINT [DF_session_designer_documents_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_session_statuses_author]...';


GO
ALTER TABLE [dbo].[session_statuses]
    ADD CONSTRAINT [DF_session_statuses_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_session_statuses_create_date]...';


GO
ALTER TABLE [dbo].[session_statuses]
    ADD CONSTRAINT [DF_session_statuses_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_session_statuses_modifier]...';


GO
ALTER TABLE [dbo].[session_statuses]
    ADD CONSTRAINT [DF_session_statuses_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_session_statuses_modified_date]...';


GO
ALTER TABLE [dbo].[session_statuses]
    ADD CONSTRAINT [DF_session_statuses_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_sessions_converted_bom_count]...';


GO
ALTER TABLE [dbo].[sessions_converted]
    ADD CONSTRAINT [DF_sessions_converted_bom_count] DEFAULT ((0)) FOR [bom_count];


GO
PRINT N'Creating Default Constraint [dbo].[DF_sessions_converted_missing_count]...';


GO
ALTER TABLE [dbo].[sessions_converted]
    ADD CONSTRAINT [DF_sessions_converted_missing_count] DEFAULT ((0)) FOR [missing_count];


GO
PRINT N'Creating Default Constraint [dbo].[DF_sms_default_templates_author]...';


GO
ALTER TABLE [dbo].[sms_default_templates]
    ADD CONSTRAINT [DF_sms_default_templates_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_sms_default_templates_create_date]...';


GO
ALTER TABLE [dbo].[sms_default_templates]
    ADD CONSTRAINT [DF_sms_default_templates_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_sms_default_templates_modifier]...';


GO
ALTER TABLE [dbo].[sms_default_templates]
    ADD CONSTRAINT [DF_sms_default_templates_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_sms_default_templates_modified_date]...';


GO
ALTER TABLE [dbo].[sms_default_templates]
    ADD CONSTRAINT [DF_sms_default_templates_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_Table_1_link_id]...';


GO
ALTER TABLE [dbo].[support_links]
    ADD CONSTRAINT [DF_Table_1_link_id] DEFAULT (newid()) FOR [row_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_links_account_org]...';


GO
ALTER TABLE [dbo].[support_links]
    ADD CONSTRAINT [DF_support_links_account_org] DEFAULT ('') FOR [account_org];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_links_role_id]...';


GO
ALTER TABLE [dbo].[support_links]
    ADD CONSTRAINT [DF_support_links_role_id] DEFAULT ('') FOR [role_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_links_author]...';


GO
ALTER TABLE [dbo].[support_links]
    ADD CONSTRAINT [DF_support_links_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_links_create_date]...';


GO
ALTER TABLE [dbo].[support_links]
    ADD CONSTRAINT [DF_support_links_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_links_modifier]...';


GO
ALTER TABLE [dbo].[support_links]
    ADD CONSTRAINT [DF_support_links_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_links_modified_date]...';


GO
ALTER TABLE [dbo].[support_links]
    ADD CONSTRAINT [DF_support_links_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_log_entry_date]...';


GO
ALTER TABLE [dbo].[support_log]
    ADD CONSTRAINT [DF_support_log_entry_date] DEFAULT (getdate()) FOR [entry_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_log_cc_list]...';


GO
ALTER TABLE [dbo].[support_log]
    ADD CONSTRAINT [DF_support_log_cc_list] DEFAULT ('') FOR [cc_list];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_log_subject_type]...';


GO
ALTER TABLE [dbo].[support_log]
    ADD CONSTRAINT [DF_support_log_subject_type] DEFAULT ('') FOR [problem_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_log_body_message]...';


GO
ALTER TABLE [dbo].[support_log]
    ADD CONSTRAINT [DF_support_log_body_message] DEFAULT ('') FOR [body_message];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_log_application]...';


GO
ALTER TABLE [dbo].[support_log]
    ADD CONSTRAINT [DF_support_log_application] DEFAULT ('') FOR [application];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_log_product]...';


GO
ALTER TABLE [dbo].[support_log]
    ADD CONSTRAINT [DF_support_log_product] DEFAULT ('') FOR [product];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_log_problem_source_id]...';


GO
ALTER TABLE [dbo].[support_log]
    ADD CONSTRAINT [DF_support_log_problem_source_id] DEFAULT ((0)) FOR [problem_source];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_log_problem_status]...';


GO
ALTER TABLE [dbo].[support_log]
    ADD CONSTRAINT [DF_support_log_problem_status] DEFAULT ((0)) FOR [problem_status];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_log_problem_resolution]...';


GO
ALTER TABLE [dbo].[support_log]
    ADD CONSTRAINT [DF_support_log_problem_resolution] DEFAULT ((0)) FOR [problem_resolution];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_log_notes]...';


GO
ALTER TABLE [dbo].[support_log]
    ADD CONSTRAINT [DF_support_log_notes] DEFAULT ('') FOR [notes];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_log_author]...';


GO
ALTER TABLE [dbo].[support_log]
    ADD CONSTRAINT [DF_support_log_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_log_create_date]...';


GO
ALTER TABLE [dbo].[support_log]
    ADD CONSTRAINT [DF_support_log_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_log_modifier]...';


GO
ALTER TABLE [dbo].[support_log]
    ADD CONSTRAINT [DF_support_log_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_log_modified_date]...';


GO
ALTER TABLE [dbo].[support_log]
    ADD CONSTRAINT [DF_support_log_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_problem_resolutions_author]...';


GO
ALTER TABLE [dbo].[support_problem_resolutions]
    ADD CONSTRAINT [DF_support_problem_resolutions_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_problem_resolutions_create_date]...';


GO
ALTER TABLE [dbo].[support_problem_resolutions]
    ADD CONSTRAINT [DF_support_problem_resolutions_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_problem_resolutions_modifier]...';


GO
ALTER TABLE [dbo].[support_problem_resolutions]
    ADD CONSTRAINT [DF_support_problem_resolutions_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_problem_resolutions_modified_date]...';


GO
ALTER TABLE [dbo].[support_problem_resolutions]
    ADD CONSTRAINT [DF_support_problem_resolutions_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_problem_sources_author]...';


GO
ALTER TABLE [dbo].[support_problem_sources]
    ADD CONSTRAINT [DF_support_problem_sources_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_problem_sources_create_date]...';


GO
ALTER TABLE [dbo].[support_problem_sources]
    ADD CONSTRAINT [DF_support_problem_sources_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_problem_sources_modifier]...';


GO
ALTER TABLE [dbo].[support_problem_sources]
    ADD CONSTRAINT [DF_support_problem_sources_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_support_problem_sources_modified_date]...';


GO
ALTER TABLE [dbo].[support_problem_sources]
    ADD CONSTRAINT [DF_support_problem_sources_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_user_completed_orientation_steps_author]...';


GO
ALTER TABLE [dbo].[user_completed_orientation_steps]
    ADD CONSTRAINT [DF_user_completed_orientation_steps_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_user_completed_orientation_steps_create_date]...';


GO
ALTER TABLE [dbo].[user_completed_orientation_steps]
    ADD CONSTRAINT [DF_user_completed_orientation_steps_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_user_completed_orientation_steps_modifier]...';


GO
ALTER TABLE [dbo].[user_completed_orientation_steps]
    ADD CONSTRAINT [DF_user_completed_orientation_steps_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_user_completed_orientation_steps_modified_date]...';


GO
ALTER TABLE [dbo].[user_completed_orientation_steps]
    ADD CONSTRAINT [DF_user_completed_orientation_steps_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_enable_homebuyer_access]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_enable_homebuyer_access] DEFAULT ((0)) FOR [enable_homebuyer_access];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_master_plan_name]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_master_plan_name] DEFAULT ('') FOR [base_plan_name];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_home_down_payment]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_home_down_payment] DEFAULT ((0)) FOR [home_down_payment];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_home_allowance]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_home_allowance] DEFAULT ((0)) FOR [home_allowance];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_address_1]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_address_1] DEFAULT ('') FOR [address];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_property_desc_1]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_property_desc_1] DEFAULT ('') FOR [property_desc_1];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_property_desc_2]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_property_desc_2] DEFAULT ('') FOR [property_desc_2];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_block_1]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_block_1] DEFAULT ('') FOR [block];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_lot_1]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_lot_1] DEFAULT ('') FOR [lot];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_country_home_phone]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_country_home_phone] DEFAULT ('') FOR [country_home_phone];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_country_work_phone]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_country_work_phone] DEFAULT ('') FOR [country_work_phone];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_country_spouse_phone]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_country_spouse_phone] DEFAULT ('') FOR [country_spouse_phone];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_job_type]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_job_type] DEFAULT ((0)) FOR [job_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_stage_1]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_stage_1] DEFAULT ('') FOR [stage];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_superintendent]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_superintendent] DEFAULT ('') FOR [superintendent];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_catalog_sessions_community_id]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_catalog_sessions_community_id] DEFAULT ((0)) FOR [community_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_catalog_sessions_plan_version]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_catalog_sessions_plan_version] DEFAULT ('') FOR [plan_version];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_catalog_sessions_show_report]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_catalog_sessions_show_report] DEFAULT ((1)) FOR [show_report];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_catalog_sessions_address_id]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_catalog_sessions_address_id] DEFAULT ((0)) FOR [address_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_catalog_sessions_rounding_type]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_catalog_sessions_rounding_type] DEFAULT ((0)) FOR [rounding_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_catalog_sessions_rounding_places]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_catalog_sessions_rounding_places] DEFAULT ((2)) FOR [rounding_places];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_account_organization_user_profile_plan_catalog_sessions_builder_markup_hb_pricing]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [DF_z_account_organization_user_profile_plan_catalog_sessions_builder_markup_hb_pricing] DEFAULT ((0)) FOR [builder_markup_hb_pricing];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[z_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[z_account_organization_user_profile_plan_catalog_sessions]
    ADD DEFAULT ('') FOR [precon_notes];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_catalog_selections_cost]...';


GO
ALTER TABLE [dbo].[z_catalog_selections]
    ADD CONSTRAINT [DF_z_catalog_selections_cost] DEFAULT ((0)) FOR [cost];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_catalog_selections_price_overridden]...';


GO
ALTER TABLE [dbo].[z_catalog_selections]
    ADD CONSTRAINT [DF_z_catalog_selections_price_overridden] DEFAULT ((0)) FOR [make_std];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_catalog_selections_is_credit]...';


GO
ALTER TABLE [dbo].[z_catalog_selections]
    ADD CONSTRAINT [DF_z_catalog_selections_is_credit] DEFAULT ((0)) FOR [is_credit];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_catalog_selections_area_bom_modifications_price]...';


GO
ALTER TABLE [dbo].[z_catalog_selections_area_bom_modifications]
    ADD CONSTRAINT [DF_z_catalog_selections_area_bom_modifications_price] DEFAULT ((0)) FOR [price];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_catalog_selections_area_details_bom_real_item_id]...';


GO
ALTER TABLE [dbo].[z_catalog_selections_area_details]
    ADD CONSTRAINT [DF_z_catalog_selections_area_details_bom_real_item_id] DEFAULT ('') FOR [bom_real_item_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_catalog_selections_area_details_bom_bill_qty]...';


GO
ALTER TABLE [dbo].[z_catalog_selections_area_details]
    ADD CONSTRAINT [DF_z_catalog_selections_area_details_bom_bill_qty] DEFAULT ((0)) FOR [bom_bill_qty];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_catalog_selections_area_details_bom_uom_id]...';


GO
ALTER TABLE [dbo].[z_catalog_selections_area_details]
    ADD CONSTRAINT [DF_z_catalog_selections_area_details_bom_uom_id] DEFAULT ('') FOR [bom_uom_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_catalog_selections_area_details_retail_percentage]...';


GO
ALTER TABLE [dbo].[z_catalog_selections_area_details]
    ADD CONSTRAINT [DF_z_catalog_selections_area_details_retail_percentage] DEFAULT ((1)) FOR [retail_percentage];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_catalog_selections_area_details_retail_percentage_type]...';


GO
ALTER TABLE [dbo].[z_catalog_selections_area_details]
    ADD CONSTRAINT [DF_z_catalog_selections_area_details_retail_percentage_type] DEFAULT ('') FOR [retail_percentage_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_catalog_selections_area_details_accent_prompt]...';


GO
ALTER TABLE [dbo].[z_catalog_selections_area_details]
    ADD CONSTRAINT [DF_z_catalog_selections_area_details_accent_prompt] DEFAULT ('') FOR [accent_prompt];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_catalog_selections_area_details_priced]...';


GO
ALTER TABLE [dbo].[z_catalog_selections_area_details]
    ADD CONSTRAINT [DF_z_catalog_selections_area_details_priced] DEFAULT ((0)) FOR [priced];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_catalog_selections_area_details_bom_item_id]...';


GO
ALTER TABLE [dbo].[z_catalog_selections_area_details]
    ADD CONSTRAINT [DF_z_catalog_selections_area_details_bom_item_id] DEFAULT ('') FOR [bom_item_id];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_catalog_selections_bom_modifications_quantity]...';


GO
ALTER TABLE [dbo].[z_catalog_selections_bom_modifications]
    ADD CONSTRAINT [DF_z_catalog_selections_bom_modifications_quantity] DEFAULT ((0)) FOR [quantity];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_catalog_selections_bom_modifications_price]...';


GO
ALTER TABLE [dbo].[z_catalog_selections_bom_modifications]
    ADD CONSTRAINT [DF_z_catalog_selections_bom_modifications_price] DEFAULT ((0)) FOR [price];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_catalog_selections_bom_modifications_option_pricing_display]...';


GO
ALTER TABLE [dbo].[z_catalog_selections_bom_modifications]
    ADD CONSTRAINT [DF_z_catalog_selections_bom_modifications_option_pricing_display] DEFAULT ((0)) FOR [option_pricing_display];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_commission_rates_author]...';


GO
ALTER TABLE [dbo].[z_commission_rates]
    ADD CONSTRAINT [DF_z_commission_rates_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_commission_rates_create_date]...';


GO
ALTER TABLE [dbo].[z_commission_rates]
    ADD CONSTRAINT [DF_z_commission_rates_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_commission_rates_modifier]...';


GO
ALTER TABLE [dbo].[z_commission_rates]
    ADD CONSTRAINT [DF_z_commission_rates_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_commission_rates_modified_date]...';


GO
ALTER TABLE [dbo].[z_commission_rates]
    ADD CONSTRAINT [DF_z_commission_rates_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[z_homebuyer_catalog_nonestimated_selections]...';


GO
ALTER TABLE [dbo].[z_homebuyer_catalog_nonestimated_selections]
    ADD DEFAULT 1 FOR [quantity];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_invoice_lines_orig_line_amount]...';


GO
ALTER TABLE [dbo].[z_invoice_lines]
    ADD CONSTRAINT [DF_z_invoice_lines_orig_line_amount] DEFAULT ((0)) FOR [orig_line_amount];


GO
PRINT N'Creating Default Constraint [dbo].[DF__z_jobs_st__autho__709E980D]...';


GO
ALTER TABLE [dbo].[z_jobs_stages]
    ADD CONSTRAINT [DF__z_jobs_st__autho__709E980D] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF__z_jobs_st__creat__7192BC46]...';


GO
ALTER TABLE [dbo].[z_jobs_stages]
    ADD CONSTRAINT [DF__z_jobs_st__creat__7192BC46] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF__z_jobs_st__modif__7286E07F]...';


GO
ALTER TABLE [dbo].[z_jobs_stages]
    ADD CONSTRAINT [DF__z_jobs_st__modif__7286E07F] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF__z_jobs_st__modif__737B04B8]...';


GO
ALTER TABLE [dbo].[z_jobs_stages]
    ADD CONSTRAINT [DF__z_jobs_st__modif__737B04B8] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_plan_budget_values_names_data_type]...';


GO
ALTER TABLE [dbo].[z_plan_budget_values_names]
    ADD CONSTRAINT [DF_z_plan_budget_values_names_data_type] DEFAULT ('') FOR [data_type];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_plan_budget_values_names_required]...';


GO
ALTER TABLE [dbo].[z_plan_budget_values_names]
    ADD CONSTRAINT [DF_z_plan_budget_values_names_required] DEFAULT (0) FOR [required];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_plan_budget_values_names_enabled_by_default]...';


GO
ALTER TABLE [dbo].[z_plan_budget_values_names]
    ADD CONSTRAINT [DF_z_plan_budget_values_names_enabled_by_default] DEFAULT (0) FOR [enabled_by_default];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_plan_budget_values_names_community_default]...';


GO
ALTER TABLE [dbo].[z_plan_budget_values_names]
    ADD CONSTRAINT [DF_z_plan_budget_values_names_community_default] DEFAULT (0) FOR [community_default];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_restricted_application_product_author]...';


GO
ALTER TABLE [dbo].[z_restricted_application_product]
    ADD CONSTRAINT [DF_z_restricted_application_product_author] DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_restricted_application_product_create_date]...';


GO
ALTER TABLE [dbo].[z_restricted_application_product]
    ADD CONSTRAINT [DF_z_restricted_application_product_create_date] DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_restricted_application_product_modifier]...';


GO
ALTER TABLE [dbo].[z_restricted_application_product]
    ADD CONSTRAINT [DF_z_restricted_application_product_modifier] DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint [dbo].[DF_z_restricted_application_product_modified_date]...';


GO
ALTER TABLE [dbo].[z_restricted_application_product]
    ADD CONSTRAINT [DF_z_restricted_application_product_modified_date] DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[z_room_sections]...';


GO
ALTER TABLE [dbo].[z_room_sections]
    ADD DEFAULT suser_sname() FOR [author];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[z_room_sections]...';


GO
ALTER TABLE [dbo].[z_room_sections]
    ADD DEFAULT getdate() FOR [create_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[z_room_sections]...';


GO
ALTER TABLE [dbo].[z_room_sections]
    ADD DEFAULT suser_sname() FOR [modifier];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[z_room_sections]...';


GO
ALTER TABLE [dbo].[z_room_sections]
    ADD DEFAULT getdate() FOR [modified_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[z_rooms]...';


GO
ALTER TABLE [dbo].[z_rooms]
    ADD DEFAULT (suser_sname()) FOR [author];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[z_rooms]...';


GO
ALTER TABLE [dbo].[z_rooms]
    ADD DEFAULT (getdate()) FOR [create_date];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[z_rooms]...';


GO
ALTER TABLE [dbo].[z_rooms]
    ADD DEFAULT (suser_sname()) FOR [modifier];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[z_rooms]...';


GO
ALTER TABLE [dbo].[z_rooms]
    ADD DEFAULT (getdate()) FOR [modified_date];


GO
PRINT N'Creating Foreign Key [dbo].[FK_account_organization_support_emails_problem_types]...';


GO
ALTER TABLE [dbo].[account_organization_support_emails]
    ADD CONSTRAINT [FK_account_organization_support_emails_problem_types] FOREIGN KEY ([problem_type_id]) REFERENCES [dbo].[problem_types] ([type_id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_account_organization_user_profile_plan_account_organization_user_profile]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan]
    ADD CONSTRAINT [FK_account_organization_user_profile_plan_account_organization_user_profile] FOREIGN KEY ([account_id], [organization_id], [user_id]) REFERENCES [dbo].[account_organization_user_profile] ([account_id], [organization_id], [user_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_account_organization_user_profile_plan_catalog_sessions_account_organization_user_profile_plan]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [FK_account_organization_user_profile_plan_catalog_sessions_account_organization_user_profile_plan] FOREIGN KEY ([account_id], [organization_id], [user_id], [community_name], [series], [plan_name]) REFERENCES [dbo].[account_organization_user_profile_plan] ([account_id], [organization_id], [user_id], [community_name], [series], [plan_name]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_account_organization_user_profile_plan_catalog_sessions_session_statuses]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions]
    ADD CONSTRAINT [FK_account_organization_user_profile_plan_catalog_sessions_session_statuses] FOREIGN KEY ([status]) REFERENCES [dbo].[session_statuses] ([status_id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_account_organization_user_profile_plan_catalog_sessions_documents_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_catalog_sessions_documents]
    ADD CONSTRAINT [FK_account_organization_user_profile_plan_catalog_sessions_documents_account_organization_user_profile_plan_catalog_sessions] FOREIGN KEY ([session_id]) REFERENCES [dbo].[account_organization_user_profile_plan_catalog_sessions] ([session_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_account_organization_user_profile_plan_documents_account_organization_user_profile_plan]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_documents]
    ADD CONSTRAINT [FK_account_organization_user_profile_plan_documents_account_organization_user_profile_plan] FOREIGN KEY ([account_id], [organization_id], [user_id], [community_name], [series], [plan_name]) REFERENCES [dbo].[account_organization_user_profile_plan] ([account_id], [organization_id], [user_id], [community_name], [series], [plan_name]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_account_organization_user_profile_plan_options_budget_items_account_organization_user_profile_plan]...';


GO
ALTER TABLE [dbo].[account_organization_user_profile_plan_options_budget_items]
    ADD CONSTRAINT [FK_account_organization_user_profile_plan_options_budget_items_account_organization_user_profile_plan] FOREIGN KEY ([account_id], [organization_id], [user_id], [community], [series], [plan_name]) REFERENCES [dbo].[account_organization_user_profile_plan] ([account_id], [organization_id], [user_id], [community_name], [series], [plan_name]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_application_icon_icon]...';


GO
ALTER TABLE [dbo].[application_icon]
    ADD CONSTRAINT [FK_application_icon_icon] FOREIGN KEY ([icon_id]) REFERENCES [dbo].[icon] ([id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_builder_bom_modifications_builder_bom_modification_types]...';


GO
ALTER TABLE [dbo].[builder_bom_modifications]
    ADD CONSTRAINT [FK_builder_bom_modifications_builder_bom_modification_types] FOREIGN KEY ([modification_type]) REFERENCES [dbo].[builder_bom_modification_types] ([id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_builder_features_features]...';


GO
ALTER TABLE [dbo].[builder_features]
    ADD CONSTRAINT [FK_builder_features_features] FOREIGN KEY ([feature_id]) REFERENCES [dbo].[features] ([id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_builder_plan_budget_values_community_defaults_plan_budget_values_names]...';


GO
ALTER TABLE [dbo].[builder_plan_budget_values_community_defaults]
    ADD CONSTRAINT [FK_builder_plan_budget_values_community_defaults_plan_budget_values_names] FOREIGN KEY ([name_id]) REFERENCES [dbo].[plan_budget_values_names] ([id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_builder_plan_budget_values_settings_plan_budget_values_names]...';


GO
ALTER TABLE [dbo].[builder_plan_budget_values_settings]
    ADD CONSTRAINT [FK_builder_plan_budget_values_settings_plan_budget_values_names] FOREIGN KEY ([name_id]) REFERENCES [dbo].[plan_budget_values_names] ([id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_prices_published_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[catalog_prices_published]
    ADD CONSTRAINT [FK_catalog_prices_published_account_organization_user_profile_plan_catalog_sessions] FOREIGN KEY ([session_id]) REFERENCES [dbo].[account_organization_user_profile_plan_catalog_sessions] ([session_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_prices_published_groups_detail_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[catalog_prices_published_groups_detail]
    ADD CONSTRAINT [FK_catalog_prices_published_groups_detail_account_organization_user_profile_plan_catalog_sessions] FOREIGN KEY ([session_id]) REFERENCES [dbo].[account_organization_user_profile_plan_catalog_sessions] ([session_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_area_bom_modifications_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_bom_modifications]
    ADD CONSTRAINT [FK_catalog_selections_area_bom_modifications_account_organization_user_profile_plan_catalog_sessions] FOREIGN KEY ([session_id]) REFERENCES [dbo].[account_organization_user_profile_plan_catalog_sessions] ([session_id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_area_bom_modifications_catalog_selections_bom_modifications]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_bom_modifications]
    ADD CONSTRAINT [FK_catalog_selections_area_bom_modifications_catalog_selections_bom_modifications] FOREIGN KEY ([session_bom_modification_id]) REFERENCES [dbo].[catalog_selections_bom_modifications] ([id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_area_detail_options_catalog_selections_area_details]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_detail_options]
    ADD CONSTRAINT [FK_catalog_selections_area_detail_options_catalog_selections_area_details] FOREIGN KEY ([session_id], [application], [product], [area], [sub_area], [item_type], [item_id]) REFERENCES [dbo].[catalog_selections_area_details] ([session_id], [application], [product], [area], [sub_area], [item_type], [item_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_area_details_catalog_selections_areas]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details]
    ADD CONSTRAINT [FK_catalog_selections_area_details_catalog_selections_areas] FOREIGN KEY ([session_id], [application], [product], [area], [sub_area]) REFERENCES [dbo].[catalog_selections_areas] ([session_id], [application], [product], [area], [sub_area]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_area_details_change_log_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details_change_log]
    ADD CONSTRAINT [FK_catalog_selections_area_details_change_log_account_organization_user_profile_plan_catalog_sessions] FOREIGN KEY ([session_id]) REFERENCES [dbo].[account_organization_user_profile_plan_catalog_sessions] ([session_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_area_details_lay_directions_catalog_selections_area_details]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_details_lay_directions]
    ADD CONSTRAINT [FK_catalog_selections_area_details_lay_directions_catalog_selections_area_details] FOREIGN KEY ([session_id], [application], [product], [area], [sub_area], [item_type], [item_id]) REFERENCES [dbo].[catalog_selections_area_details] ([session_id], [application], [product], [area], [sub_area], [item_type], [item_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_area_properties_catalog_selections_areas]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_properties]
    ADD CONSTRAINT [FK_catalog_selections_area_properties_catalog_selections_areas] FOREIGN KEY ([session_id], [build_id]) REFERENCES [dbo].[catalog_selections_areas] ([session_id], [build_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_area_slabs_catalog_selections_areas]...';


GO
ALTER TABLE [dbo].[catalog_selections_area_slabs]
    ADD CONSTRAINT [FK_catalog_selections_area_slabs_catalog_selections_areas] FOREIGN KEY ([session_id], [build_id]) REFERENCES [dbo].[catalog_selections_areas] ([session_id], [build_id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_areas_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[catalog_selections_areas]
    ADD CONSTRAINT [FK_catalog_selections_areas_account_organization_user_profile_plan_catalog_sessions] FOREIGN KEY ([session_id]) REFERENCES [dbo].[account_organization_user_profile_plan_catalog_sessions] ([session_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_bom_modifications_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[catalog_selections_bom_modifications]
    ADD CONSTRAINT [FK_catalog_selections_bom_modifications_account_organization_user_profile_plan_catalog_sessions] FOREIGN KEY ([session_id]) REFERENCES [dbo].[account_organization_user_profile_plan_catalog_sessions] ([session_id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_bom_modifications_builder_bom_modification_types]...';


GO
ALTER TABLE [dbo].[catalog_selections_bom_modifications]
    ADD CONSTRAINT [FK_catalog_selections_bom_modifications_builder_bom_modification_types] FOREIGN KEY ([modification_type]) REFERENCES [dbo].[builder_bom_modification_types] ([id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_images_catalog_selections]...';


GO
ALTER TABLE [dbo].[catalog_selections_designer_images]
    ADD CONSTRAINT [FK_catalog_selections_images_catalog_selections] FOREIGN KEY ([session_id], [row_id]) REFERENCES [dbo].[catalog_selections] ([session_id], [row_id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_error_log_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[catalog_selections_error_log]
    ADD CONSTRAINT [FK_catalog_selections_error_log_account_organization_user_profile_plan_catalog_sessions] FOREIGN KEY ([session_id]) REFERENCES [dbo].[account_organization_user_profile_plan_catalog_sessions] ([session_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_group_detail_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[catalog_selections_group_detail]
    ADD CONSTRAINT [FK_catalog_selections_group_detail_account_organization_user_profile_plan_catalog_sessions] FOREIGN KEY ([session_id]) REFERENCES [dbo].[account_organization_user_profile_plan_catalog_sessions] ([session_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_price_level_boms_catalog_selections]...';


GO
ALTER TABLE [dbo].[catalog_selections_price_level_boms]
    ADD CONSTRAINT [FK_catalog_selections_price_level_boms_catalog_selections] FOREIGN KEY ([session_id], [catalog_selections_row_id]) REFERENCES [dbo].[catalog_selections] ([session_id], [row_id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_catalog_selections_price_overrides_catalog_selections]...';


GO
ALTER TABLE [dbo].[catalog_selections_price_overrides]
    ADD CONSTRAINT [FK_catalog_selections_price_overrides_catalog_selections] FOREIGN KEY ([session_id], [row_id]) REFERENCES [dbo].[catalog_selections] ([session_id], [row_id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_floorplans_account_organization_user_profile_plan]...';


GO
ALTER TABLE [dbo].[floorplans]
    ADD CONSTRAINT [FK_floorplans_account_organization_user_profile_plan] FOREIGN KEY ([account_id], [organization_id], [user_id], [community], [series], [plan]) REFERENCES [dbo].[account_organization_user_profile_plan] ([account_id], [organization_id], [user_id], [community_name], [series], [plan_name]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_homebuyer_catalog_estimated_selections_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_estimated_selections]
    ADD CONSTRAINT [FK_homebuyer_catalog_estimated_selections_account_organization_user_profile_plan_catalog_sessions] FOREIGN KEY ([session_id]) REFERENCES [dbo].[account_organization_user_profile_plan_catalog_sessions] ([session_id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_homebuyer_catalog_nonestimated_selections_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_nonestimated_selections]
    ADD CONSTRAINT [FK_homebuyer_catalog_nonestimated_selections_account_organization_user_profile_plan_catalog_sessions] FOREIGN KEY ([session_id]) REFERENCES [dbo].[account_organization_user_profile_plan_catalog_sessions] ([session_id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_homebuyer_catalog_price_level_filters_primary_plan_catalogs]...';


GO
ALTER TABLE [dbo].[homebuyer_catalog_price_level_filters]
    ADD CONSTRAINT [FK_homebuyer_catalog_price_level_filters_primary_plan_catalogs] FOREIGN KEY ([session_id]) REFERENCES [dbo].[primary_plan_catalogs] ([session_id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_icon_tags_icon]...';


GO
ALTER TABLE [dbo].[icon_tags]
    ADD CONSTRAINT [FK_icon_tags_icon] FOREIGN KEY ([icon_id]) REFERENCES [dbo].[icon] ([id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_invoice_lines_invoices]...';


GO
ALTER TABLE [dbo].[invoice_lines]
    ADD CONSTRAINT [FK_invoice_lines_invoices] FOREIGN KEY ([invoice_id]) REFERENCES [dbo].[invoices] ([invoice_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_plan_budget_account_organization_user_profile_plan]...';


GO
ALTER TABLE [dbo].[plan_budget]
    ADD CONSTRAINT [FK_plan_budget_account_organization_user_profile_plan] FOREIGN KEY ([plan_id]) REFERENCES [dbo].[account_organization_user_profile_plan] ([profile_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_plan_budget_values_plan_budget]...';


GO
ALTER TABLE [dbo].[plan_budget_values]
    ADD CONSTRAINT [FK_plan_budget_values_plan_budget] FOREIGN KEY ([plan_budget_id]) REFERENCES [dbo].[plan_budget] ([id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_plan_budget_values_plan_budget_values_names]...';


GO
ALTER TABLE [dbo].[plan_budget_values]
    ADD CONSTRAINT [FK_plan_budget_values_plan_budget_values_names] FOREIGN KEY ([name_id]) REFERENCES [dbo].[plan_budget_values_names] ([id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_plan_documents_to_account_organization_user_profile_plan]...';


GO
ALTER TABLE [dbo].[plan_documents]
    ADD CONSTRAINT [FK_plan_documents_to_account_organization_user_profile_plan] FOREIGN KEY ([profile_plan_id]) REFERENCES [dbo].[account_organization_user_profile_plan] ([profile_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_plan_documents_to_plan_document_types]...';


GO
ALTER TABLE [dbo].[plan_documents]
    ADD CONSTRAINT [FK_plan_documents_to_plan_document_types] FOREIGN KEY ([doc_type]) REFERENCES [dbo].[plan_document_types] ([doc_type]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_primary_plan_catalogs_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[primary_plan_catalogs]
    ADD CONSTRAINT [FK_primary_plan_catalogs_account_organization_user_profile_plan_catalog_sessions] FOREIGN KEY ([session_id]) REFERENCES [dbo].[account_organization_user_profile_plan_catalog_sessions] ([session_id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_primary_plan_catalogs_account_organization_user_profile_plan]...';


GO
ALTER TABLE [dbo].[primary_plan_catalogs]
    ADD CONSTRAINT [FK_primary_plan_catalogs_account_organization_user_profile_plan] FOREIGN KEY ([profile_plan_id]) REFERENCES [dbo].[account_organization_user_profile_plan] ([profile_id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_room_sections_rooms]...';


GO
ALTER TABLE [dbo].[room_sections]
    ADD CONSTRAINT [FK_room_sections_rooms] FOREIGN KEY ([room_id]) REFERENCES [dbo].[rooms] ([id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_rooms_icons]...';


GO
ALTER TABLE [dbo].[rooms]
    ADD CONSTRAINT [FK_rooms_icons] FOREIGN KEY ([icon_id]) REFERENCES [dbo].[icon] ([id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_appointment_confirmation_log_scheduling_users]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_confirmation_log]
    ADD CONSTRAINT [FK_scheduling_appointment_confirmation_log_scheduling_users] FOREIGN KEY ([user_id]) REFERENCES [dbo].[scheduling_users] ([user_id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_appointment_templates_scheduling_organizations]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_templates]
    ADD CONSTRAINT [FK_scheduling_appointment_templates_scheduling_organizations] FOREIGN KEY ([account_org_id]) REFERENCES [dbo].[scheduling_organizations] ([account_org_id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_appointment_templates_detail_scheduling_appointment_types]...';


GO
ALTER TABLE [dbo].[scheduling_appointment_templates_detail]
    ADD CONSTRAINT [FK_scheduling_appointment_templates_detail_scheduling_appointment_types] FOREIGN KEY ([appointment_type]) REFERENCES [dbo].[scheduling_appointment_types] ([appointment_type]) ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_appointments_scheduling_appointment_types]...';


GO
ALTER TABLE [dbo].[scheduling_appointments]
    ADD CONSTRAINT [FK_scheduling_appointments_scheduling_appointment_types] FOREIGN KEY ([appointment_type]) REFERENCES [dbo].[scheduling_appointment_types] ([appointment_type]) ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_appointments_scheduling_organizations]...';


GO
ALTER TABLE [dbo].[scheduling_appointments]
    ADD CONSTRAINT [FK_scheduling_appointments_scheduling_organizations] FOREIGN KEY ([account_org_id]) REFERENCES [dbo].[scheduling_organizations] ([account_org_id]) ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_buyers_scheduling_status]...';


GO
ALTER TABLE [dbo].[scheduling_buyers]
    ADD CONSTRAINT [FK_scheduling_buyers_scheduling_status] FOREIGN KEY ([schedule_status]) REFERENCES [dbo].[scheduling_status] ([status_id]) ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_buyers_contacts_scheduling_buyers]...';


GO
ALTER TABLE [dbo].[scheduling_buyers_contacts]
    ADD CONSTRAINT [FK_scheduling_buyers_contacts_scheduling_buyers] FOREIGN KEY ([profile_id]) REFERENCES [dbo].[scheduling_buyers] ([profile_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_messages_scheduling_message_types]...';


GO
ALTER TABLE [dbo].[scheduling_messages]
    ADD CONSTRAINT [FK_scheduling_messages_scheduling_message_types] FOREIGN KEY ([message_type]) REFERENCES [dbo].[scheduling_message_types] ([message_type]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_user_locations_scheduling_users]...';


GO
ALTER TABLE [dbo].[scheduling_user_locations]
    ADD CONSTRAINT [FK_scheduling_user_locations_scheduling_users] FOREIGN KEY ([user_id]) REFERENCES [dbo].[scheduling_users] ([user_id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_user_organizations_scheduling_organizations]...';


GO
ALTER TABLE [dbo].[scheduling_user_organizations]
    ADD CONSTRAINT [FK_scheduling_user_organizations_scheduling_organizations] FOREIGN KEY ([account_org_id]) REFERENCES [dbo].[scheduling_organizations] ([account_org_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_user_organizations_scheduling_users]...';


GO
ALTER TABLE [dbo].[scheduling_user_organizations]
    ADD CONSTRAINT [FK_scheduling_user_organizations_scheduling_users] FOREIGN KEY ([user_id]) REFERENCES [dbo].[scheduling_users] ([user_id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_user_preferences_scheduling_users]...';


GO
ALTER TABLE [dbo].[scheduling_user_preferences]
    ADD CONSTRAINT [FK_scheduling_user_preferences_scheduling_users] FOREIGN KEY ([user_id]) REFERENCES [dbo].[scheduling_users] ([user_id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_user_roles_scheduling_roles]...';


GO
ALTER TABLE [dbo].[scheduling_user_roles]
    ADD CONSTRAINT [FK_scheduling_user_roles_scheduling_roles] FOREIGN KEY ([role_id]) REFERENCES [dbo].[scheduling_roles] ([role_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_user_roles_scheduling_users]...';


GO
ALTER TABLE [dbo].[scheduling_user_roles]
    ADD CONSTRAINT [FK_scheduling_user_roles_scheduling_users] FOREIGN KEY ([user_id]) REFERENCES [dbo].[scheduling_users] ([user_id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_user_settings_scheduling_settings]...';


GO
ALTER TABLE [dbo].[scheduling_user_settings]
    ADD CONSTRAINT [FK_scheduling_user_settings_scheduling_settings] FOREIGN KEY ([setting_id]) REFERENCES [dbo].[scheduling_settings] ([id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_user_settings_users]...';


GO
ALTER TABLE [dbo].[scheduling_user_settings]
    ADD CONSTRAINT [FK_scheduling_user_settings_users] FOREIGN KEY ([user_id]) REFERENCES [dbo].[scheduling_users] ([user_id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_scheduling_user_work_schedules_scheduling_users]...';


GO
ALTER TABLE [dbo].[scheduling_user_work_schedules]
    ADD CONSTRAINT [FK_scheduling_user_work_schedules_scheduling_users] FOREIGN KEY ([user_id]) REFERENCES [dbo].[scheduling_users] ([user_id]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_session_changes_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[session_changes]
    ADD CONSTRAINT [FK_session_changes_account_organization_user_profile_plan_catalog_sessions] FOREIGN KEY ([session_id]) REFERENCES [dbo].[account_organization_user_profile_plan_catalog_sessions] ([session_id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_session_changes_applied_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[session_changes_applied]
    ADD CONSTRAINT [FK_session_changes_applied_account_organization_user_profile_plan_catalog_sessions] FOREIGN KEY ([session_id]) REFERENCES [dbo].[account_organization_user_profile_plan_catalog_sessions] ([session_id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_session_designer_documents_account_organization_user_profile_plan_catalog_sessions]...';


GO
ALTER TABLE [dbo].[session_designer_documents]
    ADD CONSTRAINT [FK_session_designer_documents_account_organization_user_profile_plan_catalog_sessions] FOREIGN KEY ([session_id]) REFERENCES [dbo].[account_organization_user_profile_plan_catalog_sessions] ([session_id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [dbo].[FK_session_designer_documents_account_organization_documents]...';


GO
ALTER TABLE [dbo].[session_designer_documents]
    ADD CONSTRAINT [FK_session_designer_documents_account_organization_documents] FOREIGN KEY ([doc_id]) REFERENCES [dbo].[account_organization_documents] ([doc_id]) ON DELETE CASCADE;


GO
PRINT N'Creating Trigger [dbo].[ot_del_account_organization_addresses]...';


GO
create trigger ot_del_account_organization_addresses on dbo.account_organization_addresses
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_account_organization_addresses
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	account_org_id, 
	address_id, 
	address_name
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_account_organization_addresses]...';


GO
create trigger ot_ins_account_organization_addresses on dbo.account_organization_addresses
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_account_organization_addresses
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	account_org_id, 
	address_id, 
	address_name
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_account_organization_addresses]...';


GO


create trigger ot_upd_account_organization_addresses on dbo.account_organization_addresses
for update as

--=====================
-- Update audit fields
--=====================
update
	account_organization_addresses
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	account_organization_addresses main, inserted i
where
	main.account_org_id = i.account_org_id
	and main.address_id = i.address_id


--========================
-- Insert z table records
--========================
insert into 
	z_account_organization_addresses
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	account_org_id, 
	address_id, 
	address_name
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_ins_account_organization_application_product_sort_order]...';


GO
create trigger ot_ins_account_organization_application_product_sort_order on dbo.account_organization_application_product_sort_order
for insert as

--========================
-- Insert z table records
--========================
insert into
	z_account_organization_application_product_sort_order
select
	i.author as z_user_name,
	'insert' as z_action,
	getdate() as z_time,
	*
from
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_account_organization_application_product_sort_order]...';


GO
create trigger ot_upd_account_organization_application_product_sort_order on dbo.account_organization_application_product_sort_order
for update as

--=====================
-- Update audit fields
--=====================
update
	account_organization_application_product_sort_order
set
	modifier = i.modifier,
	modified_date = getdate()
from
	account_organization_application_product_sort_order main, inserted i
where
	main.account_id = i.account_id
	and main.organization_id = i.organization_id
	and main.application = i.application
	and main.product = i.product


--========================
-- Insert z table records
--========================
insert into
	z_account_organization_application_product_sort_order
select
	i.modifier as z_user_name,
	'update' as z_action,
	getdate() as z_time,
	*
from
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_account_organization_application_product_sort_order]...';


GO
create trigger ot_del_account_organization_application_product_sort_order on dbo.account_organization_application_product_sort_order
for delete as

--========================
-- Insert z table records
--========================
insert into
	z_account_organization_application_product_sort_order
select
	d.modifier as z_user_name,
	'delete' as z_action,
	getdate() as z_time,
	*
from
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_account_organization_support_emails]...';


GO
create trigger ot_ins_account_organization_support_emails on dbo.account_organization_support_emails
for insert as

--========================
-- Insert z table records
--========================
insert into
	z_account_organization_support_emails
select
	i.author as z_user_name,
	'insert' as z_action,
	getdate() as z_time,
	*
from
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_account_organization_support_emails]...';


GO
create trigger ot_upd_account_organization_support_emails on dbo.account_organization_support_emails
for update as

--=====================
-- Update audit fields
--=====================
update
	z_account_organization_support_emails
set
	modifier = i.modifier,
	modified_date = getdate()
from
	account_organization_support_emails main, inserted i
where
	main.account_org_id = i.account_org_id
	and main.problem_type_id = i.problem_type_id


--========================
-- Insert z table records
--========================
insert into
	z_account_organization_support_emails
select
	i.modifier as z_user_name,
	'update' as z_action,
	getdate() as z_time,
	*
from
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_account_organization_support_emails]...';


GO
create trigger ot_del_account_organization_support_emails on dbo.account_organization_support_emails
for delete as

--========================
-- Insert z table records
--========================
insert into
	z_account_organization_support_emails
select
	d.modifier as z_user_name,
	'delete' as z_action,
	getdate() as z_time,
	*
from
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_del_account_organization_user_profile]...';


GO
create trigger ot_del_account_organization_user_profile on dbo.account_organization_user_profile
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_account_organization_user_profile
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_account_organization_user_profile]...';


GO
create trigger ot_ins_account_organization_user_profile on dbo.account_organization_user_profile
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_account_organization_user_profile
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_account_organization_user_profile]...';


GO
create trigger ot_upd_account_organization_user_profile on dbo.account_organization_user_profile
for update as

--=====================
-- Update audit fields
--=====================
update
	account_organization_user_profile
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	account_organization_user_profile main, inserted i
where
	main.account_id = i.account_id
	and main.organization_id = i.organization_id
	and main.user_id = i.user_id


--========================
-- Insert z table records
--========================
insert into 
	z_account_organization_user_profile
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_account_organization_user_profile_plan]...';


GO
create trigger ot_del_account_organization_user_profile_plan on dbo.account_organization_user_profile_plan
for delete as

--========================
-- Insert z table records
--========================
insert into
	z_account_organization_user_profile_plan
select
	d.modifier as z_user_name,
	'delete' as z_action,
	getdate() as z_time,
	*
from
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_account_organization_user_profile_plan]...';


GO
create trigger ot_ins_account_organization_user_profile_plan on dbo.account_organization_user_profile_plan
for insert as

--========================
-- Insert z table records
--========================
insert into
	z_account_organization_user_profile_plan
select
	i.author as z_user_name,
	'insert' as z_action,
	getdate() as z_time,
	*
from
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_account_organization_user_profile_plan]...';


GO
create trigger ot_upd_account_organization_user_profile_plan on dbo.account_organization_user_profile_plan
for update as

--=====================
-- Update audit fields
--=====================
update
	account_organization_user_profile_plan
set
	modifier = i.modifier,
	modified_date = getdate()
from
	account_organization_user_profile_plan main, inserted i
where
	main.account_id = i.account_id
	and main.organization_id = i.organization_id
	and main.user_id = i.user_id
	and main.community_name = i.community_name
	and main.series = i.series
	and main.plan_name = i.plan_name


--========================
-- Insert z table records
--========================
insert into
	z_account_organization_user_profile_plan
select
	i.modifier as z_user_name,
	'update' as z_action,
	getdate() as z_time,
	*
from
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_account_organization_user_profile_plan_catalog_sessions]...';


GO
create trigger [dbo].[ot_del_account_organization_user_profile_plan_catalog_sessions] on [dbo].[account_organization_user_profile_plan_catalog_sessions]
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_account_organization_user_profile_plan_catalog_sessions
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d

--========================
-- Delete reports for this session
--========================
DELETE FROM plan_documents WHERE session_id IN (SELECT session_id FROM deleted)
GO
PRINT N'Creating Trigger [dbo].[ot_ins_account_organization_user_profile_plan_catalog_sessions]...';


GO


create trigger [dbo].[ot_ins_account_organization_user_profile_plan_catalog_sessions] on [dbo].[account_organization_user_profile_plan_catalog_sessions]
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_account_organization_user_profile_plan_catalog_sessions
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_account_organization_user_profile_plan_catalog_sessions]...';


GO
CREATE trigger [dbo].[ot_upd_account_organization_user_profile_plan_catalog_sessions] on [dbo].[account_organization_user_profile_plan_catalog_sessions]
for update as

--=====================
-- Update audit fields
--=====================
update
	account_organization_user_profile_plan_catalog_sessions
set
/*
		case
			when main.first_completed_date = '1/1/1900' then main.completed_date
			when main.completed_date = '1/1/1900' then i.first_completed_date
			when main.completed_date < i.first_completed_date then main.completed_date
			else i.first_completed_date
		end,*/
	first_completed_date = 
		case 
			when i.status = 2 and d.status <> 2 and main.first_completed_date = '1/1/1900' then getdate()
			else main.first_completed_date
		end,
	completed_date = 
		case 
			when (i.status = 2 and main.completed_date = cast('01/01/1900' as datetime)) then getdate()
			when i.completed_date = cast('01/01/1900' as datetime) then d.completed_date
			else i.completed_date
		end,
	modifier = i.modifier, 
	modified_date = getdate()
from
	account_organization_user_profile_plan_catalog_sessions main, inserted i, deleted d
where
	main.account_id = i.account_id
	and main.organization_id = i.organization_id
	and main.user_id = i.user_id
	and main.session_id = i.session_id
	and main.community_name = i.community_name
	and main.series = i.series
	and main.plan_name = i.plan_name

	and main.account_id = d.account_id
	and main.organization_id = d.organization_id
	and main.user_id = d.user_id
	and main.session_id = d.session_id
	and main.community_name = d.community_name
	and main.series = d.series
	and main.plan_name = d.plan_name

--========================
-- Insert z table records
--========================
insert into 
	z_account_organization_user_profile_plan_catalog_sessions
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_ins_account_organization_user_profile_plan_exterior_selections]...';


GO
create trigger ot_ins_account_organization_user_profile_plan_exterior_selections on dbo.account_organization_user_profile_plan_exterior_selections
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_account_organization_user_profile_plan_exterior_selections
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_account_organization_user_profile_plan_exterior_selections]...';


GO
create trigger ot_upd_account_organization_user_profile_plan_exterior_selections on dbo.account_organization_user_profile_plan_exterior_selections
for update as

--=====================
-- Update audit fields
--=====================
update
	account_organization_user_profile_plan_exterior_selections
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	account_organization_user_profile_plan_exterior_selections main, inserted i
where
	main.account_id = i.account_id
	and main.organization_id = i.organization_id
	and main.user_id = i.user_id
	and main.selection_line_no = i.selection_line_no
	and main.community_name = i.community_name
	and main.series = i.series
	and main.plan_name = i.plan_name


--========================
-- Insert z table records
--========================
insert into 
	z_account_organization_user_profile_plan_exterior_selections
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_account_organization_user_profile_plan_exterior_selections]...';


GO
create trigger ot_del_account_organization_user_profile_plan_exterior_selections on dbo.account_organization_user_profile_plan_exterior_selections
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_account_organization_user_profile_plan_exterior_selections
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_del_account_organization_user_profile_plan_options_budget_items]...';


GO

create trigger ot_del_account_organization_user_profile_plan_options_budget_items on dbo.account_organization_user_profile_plan_options_budget_items
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_account_organization_user_profile_plan_options_budget_items
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_account_organization_user_profile_plan_options_budget_items]...';


GO

create trigger ot_ins_account_organization_user_profile_plan_options_budget_items on dbo.account_organization_user_profile_plan_options_budget_items
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_account_organization_user_profile_plan_options_budget_items
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_account_organization_user_profile_plan_options_budget_items]...';


GO

create trigger ot_upd_account_organization_user_profile_plan_options_budget_items on dbo.account_organization_user_profile_plan_options_budget_items
for update as

--=====================
-- Update audit fields
--=====================
update
	account_organization_user_profile_plan_options_budget_items
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	account_organization_user_profile_plan_options_budget_items main, inserted i
where
	main.account_id = i.account_id
	and main.organization_id = i.organization_id
	and main.user_id = i.user_id
	and main.community = i.community
	and main.series = i.series
	and main.plan_name = i.plan_name
	and main.application_name = i.application_name
	and main.product_name = i.product_name
	and main.area = i.area
	and main.sub_area = i.sub_area
	and main.item_no = i.item_no
	and main.item_name = i.item_name


--========================
-- Insert z table records
--========================
insert into 
	z_account_organization_user_profile_plan_options_budget_items
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_ins_account_product_guide_pages]...';


GO




create trigger ot_ins_account_product_guide_pages on dbo.account_product_guide_pages
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_account_product_guide_pages
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_account_product_guide_pages]...';


GO




create trigger ot_upd_account_product_guide_pages on dbo.account_product_guide_pages
for update as

--=====================
-- Update audit fields
--=====================
update
	account_product_guide_pages
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	account_product_guide_pages main, inserted i
where
	main.page_id = i.page_id
	and main.account_id = i.account_id


--========================
-- Insert z table records
--========================
insert into 
	z_account_product_guide_pages
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_account_product_guide_pages]...';


GO




create trigger ot_del_account_product_guide_pages on dbo.account_product_guide_pages
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_account_product_guide_pages
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_del_account_product_guide_pages_links]...';


GO




create trigger ot_del_account_product_guide_pages_links on dbo.account_product_guide_pages_links
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_account_product_guide_pages_links
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_account_product_guide_pages_links]...';


GO




create trigger ot_ins_account_product_guide_pages_links on dbo.account_product_guide_pages_links
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_account_product_guide_pages_links
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_account_product_guide_pages_links]...';


GO




create trigger ot_upd_account_product_guide_pages_links on dbo.account_product_guide_pages_links
for update as

--=====================
-- Update audit fields
--=====================
update
	account_product_guide_pages_links
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	account_product_guide_pages_links main, inserted i
where
	main.link_id = i.link_id


--========================
-- Insert z table records
--========================
insert into 
	z_account_product_guide_pages_links
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_ins_address_types]...';


GO
create trigger ot_ins_address_types on dbo.address_types
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_address_types
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_address_types]...';


GO
create trigger ot_upd_address_types on dbo.address_types
for update as

--=====================
-- Update audit fields
--=====================
update
	address_types
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	address_types main, inserted i
where
	main.address_type = i.address_type
	and main.address_type = i.address_type


--========================
-- Insert z table records
--========================
insert into 
	z_address_types
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_address_types]...';


GO
create trigger ot_del_address_types on dbo.address_types
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_address_types
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_del_addresses]...';


GO

create trigger ot_del_addresses on dbo.addresses
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_addresses
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_addresses]...';


GO

create trigger ot_ins_addresses on dbo.addresses
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_addresses
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_addresses]...';


GO


create trigger ot_upd_addresses on dbo.addresses
for update as

--=====================
-- Update audit fields
--=====================
update
	addresses
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	addresses main, inserted i
where
	main.address_id = i.address_id


--========================
-- Insert z table records
--========================
insert into 
	z_addresses
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_ins_builder_bom_modification_types]...';


GO
create trigger ot_ins_builder_bom_modification_types on dbo.builder_bom_modification_types
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_builder_bom_modification_types
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_builder_bom_modification_types]...';


GO
create trigger ot_upd_builder_bom_modification_types on dbo.builder_bom_modification_types
for update as

--=====================
-- Update audit fields
--=====================
update
	builder_bom_modification_types
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	builder_bom_modification_types main, inserted i
where
	main.id = i.id


--========================
-- Insert z table records
--========================
insert into 
	z_builder_bom_modification_types
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_builder_bom_modification_types]...';


GO
create trigger ot_del_builder_bom_modification_types on dbo.builder_bom_modification_types
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_builder_bom_modification_types
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_builder_features]...';


GO
create trigger ot_ins_builder_features on dbo.builder_features
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_builder_features
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_builder_features]...';


GO
create trigger ot_upd_builder_features on dbo.builder_features
for update as

--=====================
-- Update audit fields
--=====================
update
	builder_features
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	builder_features main, inserted i
where
	main.organization_id = i.organization_id
	and main.feature_id = i.feature_id


--========================
-- Insert z table records
--========================
insert into 
	z_builder_features
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_builder_features]...';


GO
create trigger ot_del_builder_features on dbo.builder_features
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_builder_features
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_builder_plan_budget_values_community_defaults]...';


GO
create trigger ot_ins_builder_plan_budget_values_community_defaults on dbo.builder_plan_budget_values_community_defaults
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_builder_plan_budget_values_community_defaults
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_builder_plan_budget_values_community_defaults]...';


GO
create trigger ot_upd_builder_plan_budget_values_community_defaults on dbo.builder_plan_budget_values_community_defaults
for update as

--=====================
-- Update audit fields
--=====================
update
	builder_plan_budget_values_community_defaults
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	builder_plan_budget_values_community_defaults main, inserted i
where
	main.builder_id = i.builder_id
	and main.community_id = i.community_id
	and main.name_id = i.name_id


--========================
-- Insert z table records
--========================
insert into 
	z_builder_plan_budget_values_community_defaults
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_builder_plan_budget_values_community_defaults]...';


GO
create trigger ot_del_builder_plan_budget_values_community_defaults on dbo.builder_plan_budget_values_community_defaults
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_builder_plan_budget_values_community_defaults
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_builder_plan_budget_values_settings]...';


GO
create trigger ot_ins_builder_plan_budget_values_settings on dbo.builder_plan_budget_values_settings
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_builder_plan_budget_values_settings
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_builder_plan_budget_values_settings]...';


GO
create trigger ot_upd_builder_plan_budget_values_settings on dbo.builder_plan_budget_values_settings
for update as

--=====================
-- Update audit fields
--=====================
update
	builder_plan_budget_values_settings
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	builder_plan_budget_values_settings main, inserted i
where
	main.builder_id = i.builder_id
	and main.name_id = i.name_id


--========================
-- Insert z table records
--========================
insert into 
	z_builder_plan_budget_values_settings
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_builder_plan_budget_values_settings]...';


GO
create trigger ot_del_builder_plan_budget_values_settings on dbo.builder_plan_budget_values_settings
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_builder_plan_budget_values_settings
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_catalog_items]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
CREATE trigger [dbo].[ot_ins_catalog_items] on dbo.catalog_items
for insert as

-- automatically create account_organization_application_product_sort_order records
if trigger_nestlevel() = 1
begin
	declare @account_id uniqueidentifier, @organization_id uniqueidentifier
	declare @application varchar(100), @product varchar(100)
	declare c cursor for
	select account_id, organization_id, application, product from inserted 
	open c

	declare @sort_order int
	fetch next from c into @account_id, @organization_id, @application, @product
	while @@fetch_status = 0
	begin
		-- if the full key doesn't exist
		if not exists(select account_id from account_organization_application_product_sort_order where account_id = @account_id and organization_id = @organization_id and application = @application and product = @product)
		begin
			-- what is the application's largest sort order
			set @sort_order = -1
			select @sort_order = isnull(max(sort_order),-1) from account_organization_application_product_sort_order where application = @application
			-- if the application isn't represented at all
			if @sort_order = -1
			begin
				-- insert a new row with the MAXIMUM sort order
				insert into account_organization_application_product_sort_order(account_id, organization_id, application, product, sort_order) values (@account_id, @organization_id, @application, @product, 9999999)
			end
			else
			-- if more than 1 product exists
			begin
				-- insert a new row with an INCREMENTED sort order
				insert into account_organization_application_product_sort_order(account_id, organization_id, application, product, sort_order) values (@account_id, @organization_id, @application, @product, @sort_order + 100)
			end
		end
		fetch next from c into @account_id, @organization_id, @application, @product
	end
	close c
	deallocate c
end
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Creating Trigger [dbo].[ot_upd_catalog_items]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
CREATE trigger [dbo].[ot_upd_catalog_items] on dbo.catalog_items
for update as

-- automatically create account_organization_application_product_sort_order records
if trigger_nestlevel() = 1
begin
	declare @account_id uniqueidentifier, @organization_id uniqueidentifier
	declare @application varchar(100), @product varchar(100)
	declare c cursor for
	select account_id, organization_id, application, product from inserted 
	open c

	declare @sort_order int
	fetch next from c into @account_id, @organization_id, @application, @product
	while @@fetch_status = 0
	begin
		-- if the full key doesn't exist
		if not exists(select account_id from account_organization_application_product_sort_order where account_id = @account_id and organization_id = @organization_id and application = @application and product = @product)
		begin
			-- what is the application's largest sort order
			set @sort_order = -1
			select @sort_order = isnull(max(sort_order),-1) from account_organization_application_product_sort_order where application = @application
			-- if the application isn't represented at all
			if @sort_order = -1
			begin
				-- insert a new row with the MAXIMUM sort order
				insert into account_organization_application_product_sort_order(account_id, organization_id, application, product, sort_order) values (@account_id, @organization_id, @application, @product, 9999999)
			end
			else
			-- if more than 1 product exists
			begin
				-- insert a new row with an INCREMENTED sort order
				insert into account_organization_application_product_sort_order(account_id, organization_id, application, product, sort_order) values (@account_id, @organization_id, @application, @product, @sort_order + 100)
			end
		end
		fetch next from c into @account_id, @organization_id, @application, @product
	end
	close c
	deallocate c
end

--=====================
-- Update audit fields
--=====================
update
	catalog_items
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	catalog_items main, inserted i
where
	main.row_id = i.row_id
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Creating Trigger [dbo].[ot_upd_catalog_selections]...';


GO
CREATE TRIGGER [dbo].[ot_upd_catalog_selections] ON dbo.catalog_selections
FOR UPDATE AS
BEGIN
	-- Update audit fields
	UPDATE
		catalog_selections
	SET
		modifier = i.modifier,
		modified_date = GETDATE()
	FROM
		catalog_selections main, inserted i
	WHERE
		main.session_id = i.session_id
		AND main.row_id = i.row_id

	-- update the change log
	DECLARE @modification_date DATETIME = GETDATE()
	DECLARE @change_log TABLE
	(
		session_id UNIQUEIDENTIFIER
	)

	INSERT INTO @change_log
	SELECT DISTINCT
		i.session_id
	FROM
		inserted i
		LEFT JOIN catalog_selections_area_details_change_log l ON l.session_id = i.session_id
	WHERE
		l.session_id IS NULL

	INSERT INTO catalog_selections_area_details_change_log
	SELECT
		session_id,
		@modification_date
	FROM
		@change_log

	-- Insert z table records
	INSERT INTO
		z_catalog_selections
		(
			z_user_name,
			z_action,
			z_time,
			[session_id],
			[row_id],
			[account_id],
			[organization_id],
			[community],
			[series],
			[plan],
			[application],
			[product],
			[area],
			[area_id],
			[sub_area],
			[sub_area_id],
			[item_type],
			[item_no],
			[item],
			[vendor],
			[standard],
			[qty],
			[cost],
			[price],
			[selected],
			[notes],
			[option_pricing_display],
			[mutually_exclusive],
			[build_data],
			[original_build_data],
			[source],
			[build_id],
			[gpc],
			[model],
			[make_std],
			[is_credit],
			[option_id],
			[stage],
			[author],
			[create_date],
			[modifier],
			[modified_date],
			[stamp],
			[is_package]
		)
	SELECT
		i.modifier AS z_user_name,
		'update' AS z_action,
		GETDATE() AS z_time,
		[session_id],
		[row_id],
		[account_id],
		[organization_id],
		[community],
		[series],
		[plan],
		[application],
		[product],
		[area],
		[area_id],
		[sub_area],
		[sub_area_id],
		[item_type],
		[item_no],
		[item],
		[vendor],
		[standard],
		[qty],
		[cost],
		[price],
		[selected],
		[notes],
		[option_pricing_display],
		[mutually_exclusive],
		[build_data],
		[original_build_data],
		[source],
		[build_id],
		[gpc],
		[model],
		[make_std],
		[is_credit],
		[option_id],
		[stage],
		[author],
		[create_date],
		[modifier],
		[modified_date],
		[stamp],
		[is_package]
	FROM
		inserted i
END
GO
PRINT N'Creating Trigger [dbo].[ot_ins_catalog_selections]...';


GO
CREATE TRIGGER [dbo].[ot_ins_catalog_selections] ON dbo.catalog_selections
FOR INSERT AS
BEGIN
	-- Add record to change log
	DECLARE @modification_date DATETIME = GETDATE()
	DECLARE	@session_ids TABLE (session_id UNIQUEIDENTIFIER)

	INSERT INTO @session_ids
	SELECT DISTINCT
		i.session_id
	FROM
		inserted i
		LEFT JOIN catalog_selections_area_details_change_log l ON l.session_id = i.session_id
	WHERE
		l.session_id IS NULL

	INSERT INTO catalog_selections_area_details_change_log
	SELECT
		session_id, 
		@modification_date 
	FROM
		@session_ids

	-- Insert z table records
	INSERT INTO
		z_catalog_selections
		(
			z_user_name,
			z_action,
			z_time,
			[session_id],
			[row_id],
			[account_id],
			[organization_id],
			[community],
			[series],
			[plan],
			[application],
			[product],
			[area],
			[area_id],
			[sub_area],
			[sub_area_id],
			[item_type],
			[item_no],
			[item],
			[vendor],
			[standard],
			[qty],
			[cost],
			[price],
			[selected],
			[notes],
			[option_pricing_display],
			[mutually_exclusive],
			[build_data],
			[original_build_data],
			[source],
			[build_id],
			[gpc],
			[model],
			[make_std],
			[is_credit],
			[option_id],
			[stage],
			[author],
			[create_date],
			[modifier],
			[modified_date],
			[stamp],
			[is_package]
		)
	SELECT
		i.author AS z_user_name,
		'insert' AS z_action,
		GETDATE() AS z_time,
		[session_id],
		[row_id],
		[account_id],
		[organization_id],
		[community],
		[series],
		[plan],
		[application],
		[product],
		[area],
		[area_id],
		[sub_area],
		[sub_area_id],
		[item_type],
		[item_no],
		[item],
		[vendor],
		[standard],
		[qty],
		[cost],
		[price],
		[selected],
		[notes],
		[option_pricing_display],
		[mutually_exclusive],
		[build_data],
		[original_build_data],
		[source],
		[build_id],
		[gpc],
		[model],
		[make_std],
		[is_credit],
		[option_id],
		[stage],
		[author],
		[create_date],
		[modifier],
		[modified_date],
		[stamp],
		[is_package]
	FROM
		inserted i
END
GO
PRINT N'Creating Trigger [dbo].[ot_del_catalog_selections]...';


GO
CREATE TRIGGER ot_del_catalog_selections ON dbo.catalog_selections
FOR DELETE AS
BEGIN
	INSERT INTO
		z_catalog_selections
		(
			z_user_name,
			z_action,
			z_time,
			[session_id],
			[row_id],
			[account_id],
			[organization_id],
			[community],
			[series],
			[plan],
			[application],
			[product],
			[area],
			[area_id],
			[sub_area],
			[sub_area_id],
			[item_type],
			[item_no],
			[item],
			[vendor],
			[standard],
			[qty],
			[cost],
			[price],
			[selected],
			[notes],
			[option_pricing_display],
			[mutually_exclusive],
			[build_data],
			[original_build_data],
			[source],
			[build_id],
			[gpc],
			[model],
			[make_std],
			[is_credit],
			[option_id],
			[stage],
			[author],
			[create_date],
			[modifier],
			[modified_date],
			[stamp],
			[is_package]
		)
	SELECT
		d.modifier AS z_user_name,
		'delete' AS z_action,
		GETDATE() AS z_time,
		[session_id],
		[row_id],
		[account_id],
		[organization_id],
		[community],
		[series],
		[plan],
		[application],
		[product],
		[area],
		[area_id],
		[sub_area],
		[sub_area_id],
		[item_type],
		[item_no],
		[item],
		[vendor],
		[standard],
		[qty],
		[cost],
		[price],
		[selected],
		[notes],
		[option_pricing_display],
		[mutually_exclusive],
		[build_data],
		[original_build_data],
		[source],
		[build_id],
		[gpc],
		[model],
		[make_std],
		[is_credit],
		[option_id],
		[stage],
		[author],
		[create_date],
		[modifier],
		[modified_date],
		[stamp],
		[is_package]
	FROM
		deleted d
END
GO
PRINT N'Creating Trigger [dbo].[ot_ins_catalog_selections_area_bom_modifications]...';


GO
CREATE TRIGGER [dbo].[ot_ins_catalog_selections_area_bom_modifications]
    ON [dbo].[catalog_selections_area_bom_modifications]
    FOR INSERT
    AS
    BEGIN
		/*
		* Add 'insert' z records
		*/
		INSERT INTO
		    z_catalog_selections_area_bom_modifications
		SELECT
			i.author AS z_user_name,
			'insert' AS z_action,
			GETDATE() AS z_time,
			*
		FROM
			inserted i	
    END
GO
PRINT N'Creating Trigger [dbo].[ot_upd_catalog_selections_area_bom_modifications]...';


GO
CREATE TRIGGER [dbo].[ot_upd_catalog_selections_area_bom_modifications]
    ON [dbo].[catalog_selections_area_bom_modifications]
    FOR UPDATE
    AS
    BEGIN
        /*
		* Update the audit fields in the main table records
		*/
		UPDATE
			catalog_selections_area_bom_modifications
		SET
			modifier = i.modifier,
			modified_date = GETDATE()
		FROM
			catalog_selections_area_bom_modifications main, inserted i
		WHERE
			main.session_id = i.session_id
			AND main.build_id = i.build_id
			AND main.session_bom_modification_id = i.session_bom_modification_id

		/*
		* Add 'update' z records
		*/
		INSERT INTO
			z_catalog_selections_area_bom_modifications
		SELECT
			i.modifier AS z_user_name,
			'update' AS z_action,
			GETDATE() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_del_catalog_selections_area_bom_modifications]...';


GO
CREATE TRIGGER [dbo].[ot_del_catalog_selections_area_bom_modifications]
    ON [dbo].[catalog_selections_area_bom_modifications]
    FOR DELETE
    AS
    BEGIN
        /*
		* Add 'delete' z records
		*/
		INSERT INTO
			z_catalog_selections_area_bom_modifications
		SELECT
			d.modifier AS z_user_name,
			'delete' AS z_action,
			GETDATE() AS z_time,
			*
		FROM
			deleted d
    END
GO
PRINT N'Creating Trigger [dbo].[ot_ins_catalog_selections_area_detail_options]...';


GO
create trigger ot_ins_catalog_selections_area_detail_options on dbo.catalog_selections_area_detail_options
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_area_detail_options
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_catalog_selections_area_detail_options]...';


GO
create trigger ot_upd_catalog_selections_area_detail_options on dbo.catalog_selections_area_detail_options
for update as

--=====================
-- Update audit fields
--=====================
update
	catalog_selections_area_detail_options
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	catalog_selections_area_detail_options main, inserted i
where
	main.session_id = i.session_id
	and main.application = i.application
	and main.product = i.product
	and main.area = i.area
	and main.sub_area = i.sub_area
	and main.item_type = i.item_type
	and main.item_id = i.item_id
	and main.option_id = i.option_id


--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_area_detail_options
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_catalog_selections_area_detail_options]...';


GO
create trigger ot_del_catalog_selections_area_detail_options on dbo.catalog_selections_area_detail_options
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_area_detail_options
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_catalog_selections_area_details]...';


GO
CREATE trigger [dbo].[ot_ins_catalog_selections_area_details] on dbo.catalog_selections_area_details
for insert as

-- ======================
-- update the change log
-- ======================
declare @modification_date datetime = getdate()
declare @session_ids table (session_id uniqueidentifier)
insert into @session_ids 
select distinct 
	i.session_id 
from 
	inserted i
	left join catalog_selections_area_details_change_log l on l.session_id = i.session_id
where
	l.session_id is null

insert into catalog_selections_area_details_change_log
select session_id, @modification_date from @session_ids

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_area_details
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_catalog_selections_area_details]...';


GO
CREATE trigger [dbo].[ot_upd_catalog_selections_area_details] on dbo.catalog_selections_area_details
for update as

--=====================
-- Update audit fields
--=====================
update
	catalog_selections_area_details
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	catalog_selections_area_details main, inserted i
where
	main.session_id = i.session_id
	and main.application = i.application
	and main.product = i.product
	and main.area = i.area
	and main.sub_area = i.sub_area
	and main.item_type = i.item_type
	and main.item_id = i.item_id

-- ======================
-- update the change log
-- ======================
declare @modification_date datetime = getdate()
declare @change_log table 
(
	session_id uniqueidentifier
)
insert into @change_log 
select distinct 
	i.session_id
from 
	inserted i
	left join catalog_selections_area_details_change_log l on l.session_id = i.session_id
where
	l.session_id is null

insert into catalog_selections_area_details_change_log
select session_id, @modification_date from @change_log

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_area_details
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_catalog_selections_area_details]...';


GO
CREATE trigger [dbo].[ot_del_catalog_selections_area_details] on [dbo].[catalog_selections_area_details]
for delete as

-- ======================
-- update the change log
-- ======================
declare @modification_date datetime = getdate()
declare @session_ids table (session_id uniqueidentifier)
insert into @session_ids 
select distinct 
	d.session_id 
from 
	deleted d
	left join catalog_selections_area_details_change_log l on l.session_id = d.session_id
where
	l.session_id is null

-- RIG 20150427 If the session no longer exists, referential integrity will cause an error to insert into the change log, so don't try to insert a value if the session has been removed
if exists(select top 1 session_id from catalog_selections_area_details where session_id in (select session_id from @session_ids))
	insert into catalog_selections_area_details_change_log select session_id, @modification_date from @session_ids

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_area_details
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_catalog_selections_area_details_lay_directions]...';


GO

CREATE trigger [dbo].[ot_ins_catalog_selections_area_details_lay_directions] on [dbo].[catalog_selections_area_details_lay_directions]
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_area_details_lay_directions
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_catalog_selections_area_details_lay_directions]...';


GO
CREATE trigger [dbo].[ot_catalog_selections_area_details_lay_directions] on [dbo].[catalog_selections_area_details_lay_directions]
for update as

--=====================
-- Update audit fields
--=====================
update
	catalog_selections_area_details_lay_directions
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	catalog_selections_area_details_lay_directions main, inserted i
where
	main.session_id = i.session_id
	and main.application = i.application
	and main.product = i.product
	and main.area = i.area
	and main.sub_area = i.sub_area
	and main.item_type = i.item_type
	and main.item_id = i.item_id

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_area_details_lay_directions
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_catalog_selections_area_details_lay_directions]...';


GO
CREATE trigger [dbo].[ot_del_catalog_selections_area_details_lay_directions] on [dbo].[catalog_selections_area_details_lay_directions]
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_area_details_lay_directions
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_del_catalog_selections_area_properties]...';


GO

create trigger [dbo].[ot_del_catalog_selections_area_properties] on dbo.catalog_selections_area_properties
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_area_properties
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_catalog_selections_area_properties]...';


GO

create trigger [dbo].[ot_ins_catalog_selections_area_properties] on dbo.catalog_selections_area_properties
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_area_properties
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_catalog_selections_area_properties]...';


GO

create trigger [dbo].[ot_upd_catalog_selections_area_properties] on dbo.catalog_selections_area_properties
for update as

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_area_properties
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_ins_catalog_selections_area_slabs]...';


GO
create trigger ot_ins_catalog_selections_area_slabs on dbo.catalog_selections_area_slabs
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_area_slabs
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_catalog_selections_area_slabs]...';


GO
create trigger ot_upd_catalog_selections_area_slabs on dbo.catalog_selections_area_slabs
for update as

--=====================
-- Update audit fields
--=====================
update
	catalog_selections_area_slabs
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	catalog_selections_area_slabs main, inserted i
where
	main.row_id = i.row_id


--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_area_slabs
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_catalog_selections_area_slabs]...';


GO
create trigger ot_del_catalog_selections_area_slabs on dbo.catalog_selections_area_slabs
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_area_slabs
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_del_catalog_selections_areas]...';


GO
create trigger [dbo].[ot_del_catalog_selections_areas] on dbo.catalog_selections_areas
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_areas
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_catalog_selections_areas]...';


GO
create trigger [dbo].[ot_ins_catalog_selections_areas] on dbo.catalog_selections_areas
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_areas
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_catalog_selections_areas]...';


GO
create trigger [dbo].[ot_upd_catalog_selections_areas] on dbo.catalog_selections_areas
for update as

--=====================
-- Update audit fields
--=====================
update
	catalog_selections_areas
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	catalog_selections_areas main, inserted i
where
	main.session_id = i.session_id
	and main.application = i.application
	and main.product = i.product
	and main.area = i.area
	and main.sub_area = i.sub_area


--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_areas
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_ins_catalog_selections_bom_modifications]...';


GO
CREATE TRIGGER [dbo].[ot_ins_catalog_selections_bom_modifications]
    ON [dbo].[catalog_selections_bom_modifications]
    FOR INSERT
    AS
    BEGIN
        /*
		* Add 'insert' z records.
		*/
		INSERT INTO
			z_catalog_selections_bom_modifications
		SELECT
			i.author AS z_user_name,
			'insert' AS z_action,
			GETDATE() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_upd_catalog_selections_bom_modifications]...';


GO
CREATE TRIGGER [dbo].[ot_upd_catalog_selections_bom_modifications]
    ON [dbo].[catalog_selections_bom_modifications]
    FOR UPDATE
    AS
    BEGIN
        /*
		* Update the audit fields on the main records
		*/
		UPDATE
			catalog_selections_bom_modifications
		SET
			modifier = i.modifier,
			modified_date = GETDATE()
		FROM
			catalog_selections_bom_modifications main, inserted i
		WHERE
			main.id = i.id

		/*
		* Add 'update' z records.
		*/
		INSERT INTO
			z_catalog_selections_bom_modifications
		SELECT
			i.modifier AS z_user_name,
			'update' AS z_action,
			GETDATE() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_del_catalog_selections_bom_modifications]...';


GO

CREATE TRIGGER [dbo].[ot_del_catalog_selections_bom_modifications]
    ON [dbo].[catalog_selections_bom_modifications]
    FOR DELETE
    AS
    BEGIN
        /*
		* Add 'delete' z records
		*/
		INSERT INTO
			z_catalog_selections_bom_modifications
		SELECT
			d.modifier AS z_user_name,
			'delete' AS z_action,
			GETDATE() AS z_time,
			*
		FROM
			deleted d
    END
GO
PRINT N'Creating Trigger [dbo].[ot_ins_catalog_selections_group_detail]...';


GO

create trigger ot_ins_catalog_selections_group_detail on dbo.catalog_selections_group_detail
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_group_detail
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_catalog_selections_group_detail]...';


GO

create trigger ot_upd_catalog_selections_group_detail on dbo.catalog_selections_group_detail
for update as

--=====================
-- Update audit fields
--=====================
update
	catalog_selections_group_detail
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	catalog_selections_group_detail main, inserted i
where
	main.session_id = i.session_id
	and main.group_id = i.group_id
	and main.item_type = i.item_type
	and main.item = i.item


--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_group_detail
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_catalog_selections_group_detail]...';


GO

create trigger ot_del_catalog_selections_group_detail on dbo.catalog_selections_group_detail
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_catalog_selections_group_detail
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_default_support_emails]...';


GO
create trigger ot_ins_default_support_emails on dbo.default_support_emails
for insert as

--========================
-- Insert z table records
--========================
insert into
	z_default_support_emails
select
	i.author as z_user_name,
	'insert' as z_action,
	getdate() as z_time,
	*
from
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_default_support_emails]...';


GO
create trigger ot_upd_default_support_emails on dbo.default_support_emails
for update as

--=====================
-- Update audit fields
--=====================
update
	default_support_emails
set
	modifier = i.modifier,
	modified_date = getdate()
from
	default_support_emails main, inserted i
where
	main.email_key = i.email_key


--========================
-- Insert z table records
--========================
insert into
	z_default_support_emails
select
	i.modifier as z_user_name,
	'update' as z_action,
	getdate() as z_time,
	*
from
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_default_support_emails]...';


GO
create trigger ot_del_default_support_emails on dbo.default_support_emails
for delete as

--========================
-- Insert z table records
--========================
insert into
	z_default_support_emails
select
	d.modifier as z_user_name,
	'delete' as z_action,
	getdate() as z_time,
	*
from
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_del_designer_assigned_applications]...';


GO
CREATE TRIGGER ot_del_designer_assigned_applications 
	ON dbo.designer_assigned_applications
FOR DELETE AS
	BEGIN
		INSERT INTO
			z_designer_assigned_applications
		SELECT 
			d.modifier AS z_user_name, 
			'delete' AS z_action, 
			getdate() AS z_time, 
			*
		FROM 
			deleted d
	END

--=======================
--Insert Trigger
--=======================
GO
PRINT N'Creating Trigger [dbo].[ot_ins_designer_selectable_applications]...';


GO
CREATE trigger [dbo].[ot_ins_designer_selectable_applications] 
	ON dbo.designer_assigned_applications
FOR INSERT AS
	BEGIN
		INSERT INTO 
			z_designer_assigned_applications
		SELECT
			i.author AS z_user_name, 
			'insert' AS z_action, 
			getdate() AS z_time, 
			*
		FROM 
			inserted i
	END

--=======================
--Update Trigger
--=======================
GO
PRINT N'Creating Trigger [dbo].[ot_upd_designer_assigned_applications]...';


GO
CREATE TRIGGER [dbo].[ot_upd_designer_assigned_applications]
    ON [dbo].designer_assigned_applications
FOR UPDATE AS
    BEGIN
        /*
		* Update the audit fields on the main records
		*/
		UPDATE
			designer_assigned_applications
		SET
			modifier = i.modifier,
			modified_date = GETDATE()
		FROM
			designer_assigned_applications main, inserted i
		WHERE
			main.[id] = i.[id]

		/*
		* Add 'update' z records.
		*/
		INSERT INTO
			z_designer_assigned_applications
		SELECT
			i.modifier AS z_user_name,
			'update' AS z_action,
			GETDATE() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_ins_features]...';


GO
create trigger ot_ins_features on dbo.features
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_features
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_features]...';


GO
create trigger ot_upd_features on dbo.features
for update as

--=====================
-- Update audit fields
--=====================
update
	features
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	features main, inserted i
where
	main.id = i.id


--========================
-- Insert z table records
--========================
insert into 
	z_features
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_features]...';


GO
create trigger ot_del_features on dbo.features
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_features
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_floorplans_sequence]...';


GO
create trigger ot_ins_floorplans_sequence on dbo.floorplans_sequence
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_floorplans_sequence
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_floorplans_sequence]...';


GO
create trigger ot_upd_floorplans_sequence on dbo.floorplans_sequence
for update as

--=====================
-- Update audit fields
--=====================
update
	floorplans_sequence
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	floorplans_sequence main, inserted i
where
	main.profile_plan_id = i.profile_plan_id


--========================
-- Insert z table records
--========================
insert into 
	z_floorplans_sequence
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_floorplans_sequence]...';


GO
create trigger ot_del_floorplans_sequence on dbo.floorplans_sequence
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_floorplans_sequence
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_homebuyer_catalog_estimated_selections]...';


GO

--=====================
-- Insert Audit Trigger
--=====================

CREATE TRIGGER ot_ins_homebuyer_catalog_estimated_selections ON [dbo].[homebuyer_catalog_estimated_selections]
FOR INSERT AS

INSERT INTO
	z_homebuyer_catalog_estimated_selections
SELECT
	i.author AS z_user_name,
	'insert' AS z_action,
	GETDATE() AS z_time,
	*
FROM
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_homebuyer_catalog_estimated_selections]...';


GO

--=====================
-- Update Audit Trigger
--=====================

CREATE TRIGGER ot_upd_homebuyer_catalog_estimated_selections ON [dbo].[homebuyer_catalog_estimated_selections]
FOR UPDATE AS

UPDATE
	homebuyer_catalog_estimated_selections
SET
	modifier = i.modifier,
	modified_date = GETDATE()
FROM
	homebuyer_catalog_estimated_selections main, inserted i
WHERE
	main.id = i.id

INSERT INTO
	z_homebuyer_catalog_estimated_selections
SELECT
	i.modifier AS z_user_name,
	'update' AS z_action,
	GETDATE() AS z_time,
	*
FROM
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_homebuyer_catalog_estimated_selections]...';


GO

--=====================
-- Delete Audit Trigger
--=====================

CREATE TRIGGER ot_del_homebuyer_catalog_estimated_selections ON [dbo].[homebuyer_catalog_estimated_selections]
FOR DELETE AS

INSERT INTO
	z_homebuyer_catalog_estimated_selections
SELECT
	d.modifier AS z_user_name,
	'delete' AS z_action,
	GETDATE() AS z_time,
	*
FROM
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_homebuyer_catalog_nonestimated_selections]...';


GO

--=====================
-- Insert Audit Trigger
--=====================

CREATE TRIGGER ot_ins_homebuyer_catalog_nonestimated_selections ON [dbo].[homebuyer_catalog_nonestimated_selections]
FOR INSERT AS

INSERT INTO
	z_homebuyer_catalog_nonestimated_selections
SELECT
	i.author AS z_user_name,
	'insert' AS z_action,
	GETDATE() AS z_time,
	*
FROM
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_homebuyer_catalog_nonestimated_selections]...';


GO

--=====================
-- Update Audit Trigger
--=====================

CREATE TRIGGER ot_upd_homebuyer_catalog_nonestimated_selections ON [dbo].[homebuyer_catalog_nonestimated_selections]
FOR UPDATE AS

UPDATE
	homebuyer_catalog_nonestimated_selections
SET
	modifier = i.modifier,
	modified_date = GETDATE()
FROM
	homebuyer_catalog_nonestimated_selections main, inserted i
WHERE
	main.id = i.id

INSERT INTO
	z_homebuyer_catalog_nonestimated_selections
SELECT
	i.modifier AS z_user_name,
	'update' AS z_action,
	GETDATE() AS z_time,
	*
FROM
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_homebuyer_catalog_nonestimated_selections]...';


GO

--=====================
-- Delete Audit Trigger
--=====================

CREATE TRIGGER ot_del_homebuyer_catalog_nonestimated_selections ON [dbo].[homebuyer_catalog_nonestimated_selections]
FOR DELETE AS

INSERT INTO
	z_homebuyer_catalog_nonestimated_selections
SELECT
	d.modifier AS z_user_name,
	'delete' AS z_action,
	GETDATE() AS z_time,
	*
FROM
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_homebuyer_catalog_price_level_filters]...';


GO

--=====================
-- Insert Audit Trigger
--=====================
CREATE TRIGGER ot_ins_homebuyer_catalog_price_level_filters ON [dbo].[homebuyer_catalog_price_level_filters]
FOR INSERT AS

INSERT INTO
	z_homebuyer_catalog_price_level_filters
SELECT
	i.author AS z_user_name,
	'insert' AS z_action,
	GETDATE() AS z_time,
	*
FROM
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_homebuyer_catalog_price_level_filters]...';


GO

--=====================
-- Update Audit Trigger
--=====================
CREATE TRIGGER ot_upd_homebuyer_catalog_price_level_filters ON [dbo].[homebuyer_catalog_price_level_filters]
FOR UPDATE AS

UPDATE
	homebuyer_catalog_price_level_filters
SET
	modifier = i.modifier,
	modified_date = GETDATE()
FROM
	homebuyer_catalog_price_level_filters main, inserted i
WHERE
	main.id = i.id

INSERT INTO
	z_homebuyer_catalog_price_level_filters
SELECT
	i.modifier AS z_user_name,
	'update' AS z_action,
	GETDATE() AS z_time,
	*
FROM
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_homebuyer_catalog_price_level_filters]...';


GO

--=====================
-- Delete Audit Trigger
--=====================
CREATE TRIGGER ot_del_homebuyer_catalog_price_level_filters ON [dbo].[homebuyer_catalog_price_level_filters]
FOR DELETE AS

INSERT INTO
	z_homebuyer_catalog_price_level_filters
SELECT
	d.modifier AS z_user_name,
	'delete' AS z_action,
	GETDATE() AS z_time,
	*
FROM
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_homebuyer_orientation]...';


GO

create trigger ot_ins_homebuyer_orientation on dbo.homebuyer_orientation
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_homebuyer_orientation
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_homebuyer_orientation]...';


GO

create trigger ot_upd_homebuyer_orientation on dbo.homebuyer_orientation
for update as

--=====================
-- Update audit fields
--=====================
update
	homebuyer_orientation
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	homebuyer_orientation main, inserted i
where
	main.row_id = i.row_id


--========================
-- Insert z table records
--========================
insert into 
	z_homebuyer_orientation
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_homebuyer_orientation]...';


GO

create trigger ot_del_homebuyer_orientation on dbo.homebuyer_orientation
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_homebuyer_orientation
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_upd_invoice_lines]...';


GO
create trigger [dbo].[ot_upd_invoice_lines] on [dbo].[invoice_lines]
for update as

--=====================
-- Update audit fields
--=====================
update
	invoice_lines
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	invoice_lines main, inserted i
where
	main.invoice_id = i.invoice_id
	and main.line_no = i.line_no


--========================
-- Insert z table records
--========================
insert into 
	z_invoice_lines
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_ins_invoice_lines]...';


GO
create trigger [dbo].[ot_ins_invoice_lines] on [dbo].[invoice_lines]
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_invoice_lines
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_invoice_lines]...';


GO
create trigger [dbo].[ot_del_invoice_lines] on [dbo].[invoice_lines]
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_invoice_lines
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_del_invoices]...';


GO




create trigger [dbo].[ot_del_invoices] on [dbo].[invoices]
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_invoices
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_upd_invoices]...';


GO




create trigger [dbo].[ot_upd_invoices] on [dbo].[invoices]
for update as

--=====================
-- Update audit fields
--=====================
update
	invoices
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	invoices main, inserted i
where
	main.invoice_id = i.invoice_id


--========================
-- Insert z table records
--========================
insert into 
	z_invoices
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_ins_invoices]...';


GO




create trigger [dbo].[ot_ins_invoices] on [dbo].[invoices]
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_invoices
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_jobs_stages]...';


GO
create trigger [dbo].[ot_del_jobs_stages] on [dbo].[jobs_stages]
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_jobs_stages
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_jobs_stages]...';


GO

create trigger [dbo].[ot_ins_jobs_stages] on [dbo].[jobs_stages]
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_jobs_stages
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_jobs_stages]...';


GO
create trigger [dbo].[ot_upd_jobs_stages] on [dbo].[jobs_stages]
for update as

--=====================
-- Update audit fields
--=====================
update
	jobs_stages
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	jobs_stages main, inserted i
where
	main.[id] = i.[id] 

--========================
-- Insert z table records
--========================
insert into 
	z_jobs_stages
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_plan_budget]...';


GO

CREATE TRIGGER [dbo].[ot_del_plan_budget]
    ON [dbo].[plan_budget]
    FOR DELETE
    AS
    BEGIN
        SET NoCount ON

		INSERT INTO 
			z_plan_budget
		SELECT
			d.modifier AS z_user_name,
			'delete' AS z_action,
			getdate() AS z_time,
			*
		FROM
			deleted d
    END
GO
PRINT N'Creating Trigger [dbo].[ot_ins_plan_budget]...';


GO

CREATE TRIGGER [dbo].[ot_ins_plan_budget]
    ON [dbo].[plan_budget]
    FOR INSERT
    AS
    BEGIN
        SET NoCount ON

		INSERT INTO
			z_plan_budget
		SELECT
			i.author AS z_user_name,
			'insert' AS z_action,
			getdate() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_upd_plan_budget]...';


GO

CREATE TRIGGER [dbo].[ot_upd_plan_budget]
    ON [dbo].[plan_budget]
    FOR UPDATE
    AS
    BEGIN
        SET NoCount ON

		UPDATE
			plan_budget
		SET
			modifier = i.modifier,
			modified_date = getdate()
		FROM
			plan_budget b, inserted i
		WHERE
			b.id = i.id

		INSERT INTO
			z_plan_budget
		SELECT
			i.modifier AS z_user_name,
			'update' AS z_action,
			getdate() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_del_plan_budget_values]...';


GO

CREATE TRIGGER [dbo].[ot_del_plan_budget_values]
    ON [dbo].[plan_budget_values]
    FOR DELETE
    AS
    BEGIN
        SET NoCount ON

		INSERT INTO
			z_plan_budget_values
		SELECT
			d.modifier AS z_user_name,
			'delete' AS z_action,
			getdate() AS z_time,
			*
		FROM
			deleted d
    END
GO
PRINT N'Creating Trigger [dbo].[ot_ins_plan_budget_values]...';


GO

CREATE TRIGGER [dbo].[ot_ins_plan_budget_values]
    ON [dbo].[plan_budget_values]
    FOR INSERT
    AS
    BEGIN
        SET NoCount ON

		INSERT INTO
			z_plan_budget_values
		SELECT
			i.author AS z_user_name,
			'insert' AS z_action,
			getdate() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_upd_plan_budget_values]...';


GO

CREATE TRIGGER [dbo].[ot_upd_plan_budget_values]
    ON [dbo].[plan_budget_values]
    FOR UPDATE
    AS
    BEGIN
        SET NoCount ON

		UPDATE
			plan_budget_values
		SET
			modifier = i.modifier,
			modified_date = getdate()
		FROM
			plan_budget_values bv, inserted i
		WHERE
			bv.id = i.id

		INSERT INTO
			z_plan_budget_values
		SELECT
			i.modifier AS z_user_name,
			'update' AS z_action,
			getdate() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_del_plan_budget_values_names]...';


GO
CREATE TRIGGER [dbo].[ot_del_plan_budget_values_names]
	ON [dbo].[plan_budget_values_names]
	FOR DELETE
	AS
	BEGIN
		SET NoCount ON

		INSERT INTO
			z_plan_budget_values_names
		SELECT
			d.modifier AS z_user_name,
			'delete' AS z_action,
			getdate() AS z_time,
			*
		FROM
			deleted d
	END
GO
PRINT N'Creating Trigger [dbo].[ot_ins_plan_budget_values_names]...';


GO

CREATE TRIGGER [dbo].[ot_ins_plan_budget_values_names]
	ON [dbo].[plan_budget_values_names]
	FOR INSERT
	AS
	BEGIN
		SET NoCount ON

		INSERT INTO
			z_plan_budget_values_names
		SELECT
			i.author AS z_user_name,
			'insert' AS z_action,
			getdate() AS z_time,
			*
		FROM
			inserted i
	END
GO
PRINT N'Creating Trigger [dbo].[ot_upd_plan_budget_values_names]...';


GO

CREATE TRIGGER [dbo].[ot_upd_plan_budget_values_names]
	ON [dbo].[plan_budget_values_names]
	FOR UPDATE
	AS
	BEGIN
		SET NoCount ON

		UPDATE
			plan_budget_values_names
		SET
			modifier = i.modifier,
			modified_date = i.modified_date
		FROM
			plan_budget_values_names bvn, inserted i
		WHERE
			bvn.id = i.id

		INSERT INTO
			z_plan_budget_values_names
		SELECT
			i.modifier AS z_user_name,
			'update' AS z_action,
			getdate() AS z_time,
			*
		FROM
			inserted i
	END
GO
PRINT N'Creating Trigger [dbo].[ot_del_plan_document_types]...';


GO

create trigger [dbo].[ot_del_plan_document_types] on [dbo].[plan_document_types]
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_plan_document_types
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_plan_document_types]...';


GO

create trigger [dbo].[ot_ins_plan_document_types] on [dbo].[plan_document_types]
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_plan_document_types
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_plan_document_types]...';


GO

create trigger [dbo].[ot_upd_plan_document_types] on [dbo].[plan_document_types]
for update as

--=====================
-- Update audit fields
--=====================
update
	plan_document_types
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	plan_document_types main, inserted i
where
	main.[doc_type] = i.[doc_type] 

--========================
-- Insert z table records
--========================
insert into 
	z_plan_document_types
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_ins_primary_plan_catalogs]...';


GO

create trigger ot_ins_primary_plan_catalogs on dbo.primary_plan_catalogs
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_primary_plan_catalogs
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_primary_plan_catalogs]...';


GO
create trigger ot_upd_primary_plan_catalogs on dbo.primary_plan_catalogs
for update as

--=====================
-- Update audit fields
--=====================
update
	primary_plan_catalogs
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	primary_plan_catalogs main, inserted i
where
	main.session_id = i.session_id


--========================
-- Insert z table records
--========================
insert into 
	z_primary_plan_catalogs
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_primary_plan_catalogs]...';


GO
create trigger ot_del_primary_plan_catalogs on dbo.primary_plan_catalogs
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_primary_plan_catalogs
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_problem_types]...';


GO
create trigger ot_ins_problem_types on dbo.problem_types
for insert as

--========================
-- Insert z table records
--========================
insert into
	z_problem_types
select
	i.author as z_user_name,
	'insert' as z_action,
	getdate() as z_time,
	*
from
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_problem_types]...';


GO
create trigger ot_upd_problem_types on dbo.problem_types
for update as

--=====================
-- Update audit fields
--=====================
update
	z_problem_types
set
	modifier = i.modifier,
	modified_date = getdate()
from
	problem_types main, inserted i
where
	main.[type_id] = i.[type_id]


--========================
-- Insert z table records
--========================
insert into
	z_problem_types
select
	i.modifier as z_user_name,
	'update' as z_action,
	getdate() as z_time,
	*
from
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_problem_types]...';


GO
create trigger ot_del_problem_types on dbo.problem_types
for delete as

--========================
-- Insert z table records
--========================
insert into
	z_problem_types
select
	d.modifier as z_user_name,
	'delete' as z_action,
	getdate() as z_time,
	*
from
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_upd_report_storage]...';


GO




create trigger ot_upd_report_storage on dbo.report_storage
for update as

--=====================
-- Update audit fields
--=====================
update
	report_storage
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	report_storage main, inserted i
where
	main.storage_id = i.storage_id


--========================
-- Insert z table records
--========================
insert into 
	z_report_storage
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_report_storage]...';


GO




create trigger ot_del_report_storage on dbo.report_storage
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_report_storage
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_report_storage]...';


GO




create trigger ot_ins_report_storage on dbo.report_storage
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_report_storage
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_restricted_application_product]...';


GO

CREATE TRIGGER [dbo].[ot_del_restricted_application_product]
    ON [dbo].[restricted_application_product]
    FOR DELETE
    AS
    BEGIN
        SET NoCount ON

		INSERT INTO
			[z_restricted_application_product]
		SELECT
			d.modifier AS z_user_name,
			'delete' AS z_action,
			getdate() AS z_time,
			*
		FROM
			deleted d
    END
GO
PRINT N'Creating Trigger [dbo].[ot_ins_restricted_application_product]...';


GO

CREATE TRIGGER [dbo].[ot_ins_restricted_application_product]
    ON [dbo].[restricted_application_product]
    FOR INSERT
    AS
    BEGIN
        SET NoCount ON

		INSERT INTO
			[z_restricted_application_product]
		SELECT
			i.author AS z_user_name,
			'insert' AS z_action,
			getdate() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_upd_restricted_application_product]...';


GO

CREATE TRIGGER [dbo].[ot_upd_restricted_application_product]
    ON [dbo].[restricted_application_product]
    FOR UPDATE
    AS
    BEGIN
        SET NoCount ON

		UPDATE
			[restricted_application_product]
		SET
			modifier = i.modifier,
			modified_date = getdate()
		FROM
			restricted_application_product rap, inserted i
		WHERE
			rap.id = i.id

		INSERT INTO
			[z_restricted_application_product]
		SELECT
			i.modifier AS z_user_name,
			'update' AS z_action,
			getdate() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_del_room_section]...';


GO

CREATE TRIGGER [dbo].[ot_del_room_section]
    ON [dbo].[room_sections]
    FOR DELETE
    AS
    BEGIN
        SET NoCount ON

		INSERT INTO 
			z_room_sections
		SELECT
			d.modifier AS z_user_name,
			'delete' AS z_action,
			getdate() AS z_time,
			*
		FROM
			deleted d
    END
GO
PRINT N'Creating Trigger [dbo].[ot_ins_room_section]...';


GO

CREATE TRIGGER [dbo].[ot_ins_room_section]
    ON [dbo].[room_sections]
    FOR INSERT
    AS
    BEGIN
        SET NoCount ON

		INSERT INTO
			z_room_sections
		SELECT
			i.author AS z_user_name,
			'insert' AS z_action,
			getdate() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_upd_room_section]...';


GO

CREATE TRIGGER [dbo].[ot_upd_room_section]
    ON [dbo].[room_sections]
    FOR UPDATE
    AS
    BEGIN
        SET NoCount ON

		UPDATE
			z_room_sections
		SET
			modifier = i.modifier,
			modified_date = getdate()
		FROM
			room_sections rs, inserted i
		WHERE
			rs.id = i.id

		INSERT INTO
			z_room_sections
		SELECT
			i.modifier AS z_user_name,
			'update' AS z_action,
			getdate() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_del_room]...';


GO

CREATE TRIGGER [dbo].[ot_del_room]
    ON [dbo].[rooms]
    FOR DELETE
    AS
    BEGIN
        SET NoCount ON

		INSERT INTO 
			z_rooms
		SELECT
			d.modifier AS z_user_name,
			'delete' AS z_action,
			getdate() AS z_time,
			*
		FROM
			deleted d
    END
GO
PRINT N'Creating Trigger [dbo].[ot_ins_room]...';


GO

CREATE TRIGGER [dbo].[ot_ins_room]
    ON [dbo].[rooms]
    FOR INSERT
    AS
    BEGIN
        SET NoCount ON

		INSERT INTO
			z_rooms
		SELECT
			i.author AS z_user_name,
			'insert' AS z_action,
			getdate() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_upd_room]...';


GO

CREATE TRIGGER [dbo].[ot_upd_room]
    ON [dbo].[rooms]
    FOR UPDATE
    AS
    BEGIN
        SET NoCount ON

		UPDATE
			rooms
		SET
			modifier = i.modifier,
			modified_date = getdate()
		FROM
			rooms r, inserted i
		WHERE
			r.id = i.id

		INSERT INTO
			z_rooms
		SELECT
			i.modifier AS z_user_name,
			'update' AS z_action,
			getdate() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_appointment_templates]...';


GO
create trigger ot_ins_scheduling_appointment_templates on dbo.scheduling_appointment_templates
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_appointment_templates
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_appointment_templates]...';


GO
create trigger ot_upd_scheduling_appointment_templates on dbo.scheduling_appointment_templates
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_appointment_templates
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_appointment_templates main, inserted i
where
	main.account_org_id = i.account_org_id
	and main.template_id = i.template_id


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_appointment_templates
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_appointment_templates]...';


GO
create trigger ot_del_scheduling_appointment_templates on dbo.scheduling_appointment_templates
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_appointment_templates
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_appointment_templates_detail]...';


GO
create trigger ot_ins_scheduling_appointment_templates_detail on dbo.scheduling_appointment_templates_detail
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_appointment_templates_detail
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_appointment_templates_detail]...';


GO
create trigger ot_upd_scheduling_appointment_templates_detail on dbo.scheduling_appointment_templates_detail
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_appointment_templates_detail
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_appointment_templates_detail main, inserted i
where
	main.template_appointment_id = i.template_appointment_id


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_appointment_templates_detail
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_appointment_templates_detail]...';


GO
create trigger ot_del_scheduling_appointment_templates_detail on dbo.scheduling_appointment_templates_detail
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_appointment_templates_detail
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_appointment_types]...';


GO

create trigger ot_ins_scheduling_appointment_types on dbo.scheduling_appointment_types
for insert as

--========================
-- Insert z table records
--========================
insert into
	z_scheduling_appointment_types
select
	i.author as z_user_name,
	'insert' as z_action,
	getdate() as z_time,
	*
from
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_appointment_types]...';


GO

create trigger ot_upd_scheduling_appointment_types on dbo.scheduling_appointment_types
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_appointment_types
set
	modifier = i.modifier,
	modified_date = getdate()
from
	scheduling_appointment_types main, inserted i
where
	main.appointment_type = i.appointment_type


--========================
-- Insert z table records
--========================
insert into
	z_scheduling_appointment_types
select
	i.modifier as z_user_name,
	'update' as z_action,
	getdate() as z_time,
	*
from
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_appointment_types]...';


GO

create trigger ot_del_scheduling_appointment_types on dbo.scheduling_appointment_types
for delete as

--========================
-- Insert z table records
--========================
insert into
	z_scheduling_appointment_types
select
	d.modifier as z_user_name,
	'delete' as z_action,
	getdate() as z_time,
	*
from
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_appointments]...';


GO
create trigger ot_del_scheduling_appointments on dbo.scheduling_appointments
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_appointments
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_appointments]...';


GO
create trigger ot_ins_scheduling_appointments on dbo.scheduling_appointments
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_appointments
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_appointments]...';


GO
create trigger ot_upd_scheduling_appointments on dbo.scheduling_appointments
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_appointments
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_appointments main, inserted i
where
	main.appointment_id = i.appointment_id


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_appointments
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_buyers]...';


GO
create trigger [dbo].[ot_del_scheduling_buyers] on [dbo].[scheduling_buyers]
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_buyers
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_buyers]...';


GO
create trigger [dbo].[ot_ins_scheduling_buyers] on [dbo].[scheduling_buyers]
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_buyers
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_buyers]...';


GO
create trigger [dbo].[ot_upd_scheduling_buyers] on [dbo].[scheduling_buyers]
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_buyers
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_buyers main, inserted i
where
	main.profile_id = i.profile_id


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_buyers
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_buyers_contacts]...';


GO
create trigger ot_del_scheduling_buyers_contacts on dbo.scheduling_buyers_contacts
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_buyers_contacts
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_buyers_contacts]...';


GO
create trigger ot_ins_scheduling_buyers_contacts on dbo.scheduling_buyers_contacts
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_buyers_contacts
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_buyers_contacts]...';


GO
create trigger ot_upd_scheduling_buyers_contacts on dbo.scheduling_buyers_contacts
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_buyers_contacts
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_buyers_contacts main, inserted i
where
	main.profile_id = i.profile_id
	and main.contact_label = i.contact_label


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_buyers_contacts
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_message_types]...';


GO




create trigger ot_del_scheduling_message_types on dbo.scheduling_message_types
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_message_types
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_message_types]...';


GO




create trigger ot_ins_scheduling_message_types on dbo.scheduling_message_types
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_message_types
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_message_types]...';


GO




create trigger ot_upd_scheduling_message_types on dbo.scheduling_message_types
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_message_types
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_message_types main, inserted i
where
	main.message_type = i.message_type


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_message_types
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_messages]...';


GO

create trigger ot_del_scheduling_messages on dbo.scheduling_messages
for delete as

--========================
-- Insert z table records
--========================
insert into
	z_scheduling_messages
select
	d.modifier as z_user_name,
	'delete' as z_action,
	getdate() as z_time,
	*
from
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_messages]...';


GO
create trigger ot_ins_scheduling_messages on dbo.scheduling_messages
for insert as

--========================
-- Insert z table records
--========================
insert into
	z_scheduling_messages
select
	i.author as z_user_name,
	'insert' as z_action,
	getdate() as z_time,
	*
from
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_messages]...';


GO
create trigger ot_upd_scheduling_messages on dbo.scheduling_messages
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_messages
set
	modifier = i.modifier,
	modified_date = getdate()
from
	scheduling_messages main, inserted i
where
	main.message_id = i.message_id


--========================
-- Insert z table records
--========================
insert into
	z_scheduling_messages
select
	i.modifier as z_user_name,
	'update' as z_action,
	getdate() as z_time,
	*
from
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_organizations]...';


GO
create trigger ot_ins_scheduling_organizations on dbo.scheduling_organizations
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_organizations
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_organizations]...';


GO
create trigger ot_upd_scheduling_organizations on dbo.scheduling_organizations
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_organizations
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_organizations main, inserted i
where
	main.account_org_id = i.account_org_id


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_organizations
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_organizations]...';


GO
create trigger ot_del_scheduling_organizations on dbo.scheduling_organizations
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_organizations
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_roles]...';


GO




create trigger ot_del_scheduling_roles on dbo.scheduling_roles
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_roles
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_roles]...';


GO




create trigger ot_ins_scheduling_roles on dbo.scheduling_roles
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_roles
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_roles]...';


GO




create trigger ot_upd_scheduling_roles on dbo.scheduling_roles
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_roles
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_roles main, inserted i
where
	main.role_id = i.role_id


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_roles
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_status]...';


GO




create trigger ot_del_scheduling_status on dbo.scheduling_status
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_status
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_status]...';


GO




create trigger ot_ins_scheduling_status on dbo.scheduling_status
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_status
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_status]...';


GO




create trigger ot_upd_scheduling_status on dbo.scheduling_status
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_status
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_status main, inserted i
where
	main.status_id = i.status_id


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_status
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_user_locations]...';


GO




create trigger ot_del_scheduling_user_locations on dbo.scheduling_user_locations
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_locations
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_user_locations]...';


GO




create trigger ot_ins_scheduling_user_locations on dbo.scheduling_user_locations
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_locations
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_user_locations]...';


GO




create trigger ot_upd_scheduling_user_locations on dbo.scheduling_user_locations
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_user_locations
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_user_locations main, inserted i
where
	main.user_id = i.user_id
	and main.location_id = i.location_id


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_locations
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_user_organizations]...';


GO




create trigger ot_del_scheduling_user_organizations on dbo.scheduling_user_organizations
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_organizations
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_user_organizations]...';


GO




create trigger ot_ins_scheduling_user_organizations on dbo.scheduling_user_organizations
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_organizations
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_user_organizations]...';


GO




create trigger ot_upd_scheduling_user_organizations on dbo.scheduling_user_organizations
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_user_organizations
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_user_organizations main, inserted i
where
	main.user_id = i.user_id
	and main.account_org_id = i.account_org_id


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_organizations
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_user_preferences]...';


GO




create trigger ot_del_scheduling_user_preferences on dbo.scheduling_user_preferences
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_preferences
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_user_preferences]...';


GO




create trigger ot_ins_scheduling_user_preferences on dbo.scheduling_user_preferences
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_preferences
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_user_preferences]...';


GO




create trigger ot_upd_scheduling_user_preferences on dbo.scheduling_user_preferences
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_user_preferences
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_user_preferences main, inserted i
where
	main.user_id = i.user_id
	and main.pref_key = i.pref_key


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_preferences
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_user_roles]...';


GO




create trigger ot_ins_scheduling_user_roles on dbo.scheduling_user_roles
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_roles
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_user_roles]...';


GO




create trigger ot_upd_scheduling_user_roles on dbo.scheduling_user_roles
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_user_roles
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_user_roles main, inserted i
where
	main.user_id = i.user_id
	and main.role_id = i.role_id


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_roles
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_user_roles]...';


GO




create trigger ot_del_scheduling_user_roles on dbo.scheduling_user_roles
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_roles
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_user_settings]...';


GO

create trigger ot_ins_scheduling_user_settings on dbo.scheduling_user_settings
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_settings
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_user_settings]...';


GO

create trigger ot_upd_scheduling_user_settings on dbo.scheduling_user_settings
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_user_settings
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_user_settings main, inserted i
where
	main.id = i.id


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_settings
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_user_settings]...';


GO

create trigger ot_del_scheduling_user_settings on dbo.scheduling_user_settings
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_settings
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_user_work_schedules]...';


GO




create trigger ot_del_scheduling_user_work_schedules on dbo.scheduling_user_work_schedules
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_work_schedules
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_user_work_schedules]...';


GO




create trigger ot_ins_scheduling_user_work_schedules on dbo.scheduling_user_work_schedules
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_work_schedules
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_user_work_schedules]...';


GO




create trigger ot_upd_scheduling_user_work_schedules on dbo.scheduling_user_work_schedules
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_user_work_schedules
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_user_work_schedules main, inserted i
where
	main.user_id = i.user_id
	and main.day = i.day


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_user_work_schedules
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_scheduling_users]...';


GO




create trigger ot_upd_scheduling_users on dbo.scheduling_users
for update as

--=====================
-- Update audit fields
--=====================
update
	scheduling_users
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	scheduling_users main, inserted i
where
	main.user_id = i.user_id


--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_users
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_scheduling_users]...';


GO




create trigger ot_del_scheduling_users on dbo.scheduling_users
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_users
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_scheduling_users]...';


GO




create trigger ot_ins_scheduling_users on dbo.scheduling_users
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_scheduling_users
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_session_designer_documents]...';


GO

CREATE TRIGGER [dbo].[ot_del_session_designer_documents]
    ON [dbo].[session_designer_documents]
    FOR DELETE
    AS
    BEGIN
        SET NoCount ON

		INSERT INTO
			[z_session_designer_documents]
		SELECT
			d.modifier AS z_user_name,
			'delete' AS z_action,
			getdate() AS z_time,
			*
		FROM
			deleted d
    END
GO
PRINT N'Creating Trigger [dbo].[ot_ins_session_designer_documents]...';


GO

CREATE TRIGGER [dbo].[ot_ins_session_designer_documents]
    ON [dbo].[session_designer_documents]
    FOR INSERT
    AS
    BEGIN
        SET NoCount ON

		INSERT INTO
			[z_session_designer_documents]
		SELECT
			i.author AS z_user_name,
			'insert' AS z_action,
			getdate() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_upd_session_designer_documents]...';


GO

CREATE TRIGGER [dbo].[ot_upd_session_designer_documents]
    ON [dbo].[session_designer_documents]
    FOR UPDATE
    AS
    BEGIN
        SET NoCount ON

		UPDATE
			[session_designer_documents]
		SET
			modifier = i.modifier,
			modified_date = getdate()
		FROM
			session_designer_documents rap, inserted i
		WHERE
			rap.id = i.id

		INSERT INTO
			[z_session_designer_documents]
		SELECT
			i.modifier AS z_user_name,
			'update' AS z_action,
			getdate() AS z_time,
			*
		FROM
			inserted i
    END
GO
PRINT N'Creating Trigger [dbo].[ot_ins_session_statuses]...';


GO
create trigger ot_ins_session_statuses on dbo.session_statuses
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_session_statuses
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_session_statuses]...';


GO
create trigger ot_upd_session_statuses on dbo.session_statuses
for update as

--=====================
-- Update audit fields
--=====================
update
	session_statuses
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	session_statuses main, inserted i
where
	main.status_id = i.status_id


--========================
-- Insert z table records
--========================
insert into 
	z_session_statuses
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_session_statuses]...';


GO
create trigger ot_del_session_statuses on dbo.session_statuses
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_session_statuses
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_support_links]...';


GO
create trigger ot_ins_support_links on dbo.support_links
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_support_links
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_support_links]...';


GO
create trigger ot_upd_support_links on dbo.support_links
for update as

--=====================
-- Update audit fields
--=====================
update
	support_links
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	support_links main, inserted i
where
	main.row_id = i.row_id


--========================
-- Insert z table records
--========================
insert into 
	z_support_links
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_support_links]...';


GO
create trigger ot_del_support_links on dbo.support_links
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_support_links
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_support_problem_resolutions]...';


GO
create trigger ot_ins_support_problem_resolutions on dbo.support_problem_resolutions
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_support_problem_resolutions
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_support_problem_resolutions]...';


GO
create trigger ot_upd_support_problem_resolutions on dbo.support_problem_resolutions
for update as

--=====================
-- Update audit fields
--=====================
update
	support_problem_resolutions
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	support_problem_resolutions main, inserted i
where
	main.resolution_id = i.resolution_id


--========================
-- Insert z table records
--========================
insert into 
	z_support_problem_resolutions
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_support_problem_resolutions]...';


GO
create trigger ot_del_support_problem_resolutions on dbo.support_problem_resolutions
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_support_problem_resolutions
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_support_problem_sources]...';


GO
create trigger ot_ins_support_problem_sources on dbo.support_problem_sources
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_support_problem_sources
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_support_problem_sources]...';


GO
create trigger ot_upd_support_problem_sources on dbo.support_problem_sources
for update as

--=====================
-- Update audit fields
--=====================
update
	support_problem_sources
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	support_problem_sources main, inserted i
where
	main.source_id = i.source_id


--========================
-- Insert z table records
--========================
insert into 
	z_support_problem_sources
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_support_problem_sources]...';


GO
create trigger ot_del_support_problem_sources on dbo.support_problem_sources
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_support_problem_sources
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Trigger [dbo].[ot_ins_user_completed_orientation_steps]...';


GO
create trigger ot_ins_user_completed_orientation_steps on dbo.user_completed_orientation_steps
for insert as

--========================
-- Insert z table records
--========================
insert into 
	z_user_completed_orientation_steps
select 
	i.author as z_user_name, 
	'insert' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_upd_user_completed_orientation_steps]...';


GO
create trigger ot_upd_user_completed_orientation_steps on dbo.user_completed_orientation_steps
for update as

--=====================
-- Update audit fields
--=====================
update
	user_completed_orientation_steps
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	user_completed_orientation_steps main, inserted i
where
	main.id = i.id


--========================
-- Insert z table records
--========================
insert into 
	z_user_completed_orientation_steps
select 
	i.modifier as z_user_name, 
	'update' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i
GO
PRINT N'Creating Trigger [dbo].[ot_del_user_completed_orientation_steps]...';


GO
create trigger ot_del_user_completed_orientation_steps on dbo.user_completed_orientation_steps
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_user_completed_orientation_steps
select 
	d.modifier as z_user_name, 
	'delete' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d
GO
PRINT N'Creating Function [dbo].[ef_getUserEmailFromSecurityToken]...';


GO
CREATE FUNCTION [dbo].[ef_getUserEmailFromSecurityToken]
(
	@security_token UNIQUEIDENTIFIER = null
)
RETURNS VARCHAR(100)
AS
/*
	Author: ???
	Date: ???
	Description: Returns a string that identifies the user associated with the passed in Security Token. For
		users, it will return their email address, from the users table. However, for non-users, it will return
		some sort of identifying text. These non-user security tokens are special case tokens.

	Modified By: Shelby Mansker
	Date: 6/15/2020
	Description: I reformatted this function to bring it inline with the formatting we've adopted in our more recent
		procedures and functions. Also, I updated it to look for security tokens that exist for Integration Clients.

	Modified By: Shelby Mansker
	Date: 8/27/2020
	Description: Removed the check for security_token in api_organizations table.
*/
BEGIN
	-- If the security token is null, return the System User. This how the function originally worked, for backwards compatibility
	IF @security_token IS NULL RETURN SYSTEM_USER

	-- If the security token passed in is an empty guid, return the System User. This how the function originally worked, for backwards compatibility
	IF @security_token = '00000000-0000-0000-0000-000000000000' RETURN SYSTEM_USER

	-- If the security token passed in is the special override token, return the System User. This how the function originally worked, for backwards compatibility
	IF @security_token = '01234567-89AB-CDEF-0000-123456789ABC' RETURN SYSTEM_USER

	-- Check to see if the Security Token is for an Integration Client
	IF EXISTS (SELECT id FROM VeoSolutionsSecurity_integration_clients WITH (NOLOCK) WHERE security_token = @security_token)
	BEGIN
		RETURN 'Integration Client'
	END

	-- Check to see if the Security Token is for a User.
	DECLARE @user_email VARCHAR(100) = NULL

	SELECT
		@user_email = email
	FROM
		VeoSolutionsSecurity_users_login_sessions uls WITH (NOLOCK) 
		JOIN VeoSolutionsSecurity_users u WITH (NOLOCK) ON u.[user_id] = uls.[user_id]
	WHERE
		uls.security_token = @security_token

	IF @user_email IS NOT NULL RETURN @user_email

	-- If no user was found, just return the SYSTEM USER
	RETURN SYSTEM_USER
END
GO
PRINT N'Creating Function [dbo].[ef_getUserIdFromSecurityToken]...';


GO
-- =============================================
-- Author:		Shelby Mansker
-- Create date: 5/22/2014
-- Description:	Returns the user id linked to the specified security token.
--  If the token is invalid, it returns null
-- =============================================
CREATE FUNCTION dbo.ef_getUserIdFromSecurityToken
(
	@security_token AS UNIQUEIDENTIFIER = NULL
)
RETURNS UNIQUEIDENTIFIER
AS
BEGIN
	DECLARE @active_user_id UNIQUEIDENTIFIER = NULL

	SELECT DISTINCT 
		@active_user_id = [user_id]
	FROM 
		VeoSolutionsSecurity_users_login_sessions WITH (NOLOCK) 
	WHERE 
		security_token = @security_token

	RETURN @active_user_id	
END
GO
PRINT N'Creating Function [dbo].[ef_selAppointmentCheckInCheckOutTimeByOrdinal]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION [dbo].[ef_selAppointmentCheckInCheckOutTimeByOrdinal]
(
	@profile_id uniqueidentifier,
	@ordinal int, 
	@check_in bit = 1 -- if 
)
RETURNS time
AS
BEGIN

/* 
select * from scheduling_appointments where start_time_actual is not null
select dbo.ef_selAppointmentCheckInCheckOutTimeByOrdinal('CAF34D10-0D41-4750-82A2-C12DC756C7F1',1,null)
*/


declare @appointments as table 
( row_id int IDENTITY(1,1),
appointment_type int, 
appointment_date datetime, 
appointment_start time,
start_time_actual time, 
end_time_actual time ) 

-- select * from scheduling_appointments 
 
insert into @appointments 
select 
appointment_type, 
appointment_date, 
start_time, 
start_time_actual, 
end_time_actual
from 
scheduling_appointments 
where 
buyer_profile_id = @profile_id 
and is_scheduled = 1
order by 
appointment_date, start_time asc

declare @time time 

if (@check_in = 1) 
begin 

select @time =  start_time_actual from @appointments where row_id = @ordinal

end 
else 
begin 

select @time = end_time_actual from @appointments where row_id = @ordinal 

end 

return @time 


END
GO
PRINT N'Creating Function [dbo].[ef_selAppointmentDateByOrdinal]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION [dbo].[ef_selAppointmentDateByOrdinal]
(
	@profile_id uniqueidentifier,
	@ordinal int
)
RETURNS datetime
AS
BEGIN

/* 
select dbo.ef_selAppointmentDateByOrdinal('E573DFEF-DF84-409B-B49A-EF73B8252B02',1)
select dbo.ef_selAppointmentDateByOrdinal('73E64567-CAA0-4AFF-83C3-018EA2D61A25',2)
*/

declare @appointments as table 
( row_id int IDENTITY(1,1),
appointment_type int, 
appointment_date datetime, 
appointment_start time) 
 
insert into @appointments 
select 
appointment_type, 
appointment_date, 
start_time 
from 
scheduling_appointments 
where 
buyer_profile_id = @profile_id 
and is_scheduled = 1
order by 
appointment_date, start_time asc

declare @date datetime
select @date = cast(appointment_date as datetime) + cast(appointment_start as datetime)
from @appointments
where row_id = @ordinal

return @date 

	-- OLD CODE...TRYING TABLE VARIABLE ABOVE...
	--declare @date datetime
	
	--select top 1  
	--	@date = cast(appointment_date as datetime) + cast(start_time as datetime)
	--from 
	--	scheduling_appointments
	--where
	--	buyer_profile_id = @profile_id
	--	and (cast(appointment_date as datetime) + CAST(start_time as datetime))
	--		not in (select top (@ordinal-1) (cast(appointment_date as datetime) + CAST(start_time as datetime))
	--					from scheduling_appointments where buyer_profile_id = @profile_id
	--					order by (cast(appointment_date as datetime) + CAST(start_time as datetime)) asc)
	--order by
	--	appointment_date asc
		
	--return @date

END
GO
PRINT N'Creating Function [dbo].[ef_selAppointmentDesignTypeByOrdinal]...';


GO
create FUNCTION [dbo].[ef_selAppointmentDesignTypeByOrdinal]
(
	@profile_id uniqueidentifier,
	@ordinal int
)
RETURNS varchar(50)
AS
BEGIN


declare @appointments as table 
( row_id int IDENTITY(1,1),
appointment_type int, 
design_type varchar(50)) 
 
insert into @appointments 
select 
sa.appointment_type, 
oat.description
from 
scheduling_appointments  sa
left join VeoScheduling_organization_appointment_types oat on oat.appointment_type = sa.design_type

where 
buyer_profile_id = @profile_id 
and is_scheduled = 1
order by 
appointment_date, start_time asc

declare @design_type varchar(50) = ''

select 
@design_type = isnull(design_type,'')
from @appointments
where row_id = @ordinal

return @design_type 


END
GO
PRINT N'Creating Function [dbo].[ef_selAppointmentDurationByOrdinal]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION [dbo].[ef_selAppointmentDurationByOrdinal]
(
	@profile_id uniqueidentifier,
	@ordinal int
)
RETURNS time
AS
BEGIN

/* 
select * from scheduling_appointments where start_time_actual is not null and end_time_actual is not null 
select dbo.ef_selAppointmentCheckInCheckOutTimeByOrdinal('CAF34D10-0D41-4750-82A2-C12DC756C7F1',3,null)
select dbo.[ef_selAppointmentDurationByOrdinal]('E573DFEF-DF84-409B-B49A-EF73B8252B02', 1) 
select dbo.[ef_selAppointmentDurationByOrdinal]('CAF34D10-0D41-4750-82A2-C12DC756C7F1', 3) 
*/

declare @total_time time(7) 
declare @time_in time(7) 
declare @time_out time(7) 



select @time_in = dbo.ef_selAppointmentCheckInCheckOutTimeByOrdinal(@profile_id , @ordinal, 1)

select @time_out = dbo.ef_selAppointmentCheckInCheckOutTimeByOrdinal(@profile_id , @ordinal, 0)


--declare @appointments as table 
--( row_id int IDENTITY(1,1),
--appointment_type int, 
--appointment_date datetime, 
--appointment_start time,
--start_time_actual time, 
--end_time_actual time ) 

---- select * from scheduling_appointments 
 
--insert into @appointments 
--select 
--appointment_type, 
--appointment_date, 
--start_time, 
--start_time_actual, 
--end_time_actual
--from 
--scheduling_appointments 
--where 
--buyer_profile_id = @profile_id 
--and is_scheduled = 1
--order by 
--appointment_date, start_time asc

--declare @time time 

--if (@check_in = 1) 
--begin 

--select @time =  start_time_actual from @appointments where row_id = @ordinal

--end 
--else 
--begin 

--select @time = end_time_actual from @appointments where row_id = @ordinal 

--end 


return convert(time, DATEADD(s, DATEDIFF(s, dbo.ef_selAppointmentCheckInCheckOutTimeByOrdinal(@profile_id, @ordinal, 1), dbo.ef_selAppointmentCheckInCheckOutTimeByOrdinal(@profile_id, @ordinal, 0)),0)   )


	  
END
GO
PRINT N'Creating Function [dbo].[ef_selBuyerAppointmentAverageDuration]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION [dbo].[ef_selBuyerAppointmentAverageDuration]
(
	@profile_id uniqueidentifier
)
RETURNS time
AS
BEGIN

/* 
select * from scheduling_appointments where buyer_profile_id = 'CAF34D10-0D41-4750-82A2-C12DC756C7F1' --  where start_time_actual is not null
select dbo.[ef_selBuyerAppointmentAverageDuration]('CAF34D10-0D41-4750-82A2-C12DC756C7F1')
*/


declare @appointments as table 
( row_id int IDENTITY(1,1),
appointment_type int, 
appointment_date datetime, 
appointment_start time,
start_time_actual time, 
end_time_actual time, 
appt_duration_minutes int) 

-- select * from scheduling_appointments 
 
insert into @appointments 
select 
appointment_type, 
appointment_date, 
start_time, 
start_time_actual, 
end_time_actual, 
null
from 
scheduling_appointments 
where 
buyer_profile_id = @profile_id 
and is_scheduled = 1
order by 
appointment_date, start_time asc

update @appointments 
set appt_duration_minutes = DATEDIFF(minute, dbo.ef_selAppointmentCheckInCheckOutTimeByOrdinal(@profile_id, row_id, 1), dbo.ef_selAppointmentCheckInCheckOutTimeByOrdinal(@profile_id, row_id, 0))   

declare @count int 
select @count = count(*) from @appointments where start_time_actual is not null and end_time_actual is not null 

declare @total int 

select @total = sum(appt_duration_minutes)  from @appointments 

declare @average int 
select @average = @total / @count from @appointments

-- return @total
-- return @count 
-- average == minutes
declare @time time 
select @time = convert(time, DATEADD(minute, @average,0))  from @appointments 

return @time 


END
GO
PRINT N'Creating Function [dbo].[ef_selBuyerCycleTimeByPlanProfileID]...';


GO
-- =============================================
-- Author:		Robert Hobbs
-- Create date: 02/11/13
-- Description:	Calculates the buyer cycle time using 
-- the following logic: 
-- The Date of the last completed selection session - 
-- the contract receipt date. 
-- If there is no completed selection session, then 
-- use TODAY. 
-- History:		20150111 RIG Added second parameter
-- =============================================
create FUNCTION [dbo].[ef_selBuyerCycleTimeByPlanProfileID]
(
	@profile_id uniqueidentifier,
	@account_organization_user_profile_plan_profile_id uniqueidentifier
)
RETURNS int
AS
BEGIN

-- SUMMARY: 
-- Calculate the days between two dates, where one date is the received date for the buyer, and the other is the completion date for the design sessions. 

-- HISTORY: 
-- MARCH 2013 - Terry wanted to change this logic to work off of received date - (saved when they choose an appointment template) 
-- APRIL 2013 - they want working days, so adding logic to ignore weekends 

-- TESTING 
-- find a buyer where they have completed sessions and a contract date:
-- UNCOMMENT BELOW: 
-- select 
--	pp.*, 
--	s.*
--from 
--account_organization_user_profile_plan_catalog_sessions s
--join account_organization_user_profile_plan pp on s.account_id = pp.account_id and s.organization_id = pp.organization_id and s.user_id = pp.user_id 
--and s.community_name = pp.community_name and s.series = pp.series and s.plan_name = pp.plan_name 
--where 
--s.completed_date not in ('01/01/1900' , '01/01/1980') 
--and pp.contract_date is not null 

-- select top 10 * from account_organization_user_profile_plan where user_id in ('1ECCAB4D-E8A1-49EC-84DD-539176456BDC', '424059BC-E4C9-4F21-BDC2-52E5A24BF9AE')
-- select top 10 * from account_organization_user_profile_plan_catalog_sessions where completed_date <> '1/1/1900'
-- select * from scheduling_buyers where profile_id = 'DD8B964E-FC8B-4856-9EC3-B3D485D4AF98'

-- SANDBOX TESTING: 
-- 

-- FETCH CONTRACT DATE 
--declare @contract_date datetime 
--select @contract_date = contract_date from account_organization_user_profile_plan where profile_id = @profile_id 

-- APRIL

declare @received_date datetime 
select @received_date = received_date from scheduling_buyers where profile_id = @profile_id 

-- FETCH LAST COMPLETED SESSION 
declare @last_session datetime 
set @last_session = null 

select 
	@last_session = max(s.first_completed_date)
from 
	account_organization_user_profile_plan_catalog_sessions s
	join account_organization_user_profile_plan pp on 
		s.account_id = pp.account_id 
		and s.organization_id = pp.organization_id 
		and s.user_id = pp.user_id 
		and s.community_name = pp.community_name 
		and s.series = pp.series 
		and s.plan_name = pp.plan_name 
where 
	s.first_completed_date not in ('01/01/1900' , '01/01/1980') 
	--RIG 2016011
	--and pp.profile_id = dbo.ef_selSchedulingBuyerActiveProfilePlan(@profile_id )
	and pp.profile_id = @account_organization_user_profile_plan_profile_id

-- if last session date is null (no completed sessions that quality), then use TODAY 
declare @calc_date datetime 

set @calc_date = @last_session 

if (@calc_date is null) 
begin 
	set @calc_date = getdate() 
end 


-- return DATEDIFF(dd, @received_date ,@calc_date ) 
declare @cycle_time int 

SELECT 
	@cycle_time = COUNT(*) 
FROM 
	dbo.calendar
WHERE 
	dt > convert(date, @received_date) -- INCLUDE START DATE 
	AND dt <=  convert(date, @calc_date) -- INCLUDE COMPLETION DATE 
	AND IsWorkDay = 1;

return @cycle_time 


--return DATEDIFF(dd, @received_date ,@calc_date ) 


/* 
select dbo.[ef_selBuyerCycleTime]('F9BA74FC-AA3F-4451-8FBC-A7E9D354EC83') 
*/

END
GO
PRINT N'Creating Function [dbo].[ef_selFirstLastAppointmentDate]...';


GO
create function ef_selFirstLastAppointmentDate(@buyer_profile_id uniqueidentifier, @first bit)
returns datetime
as
begin
	/*
	select top 1 * from scheduling_appointments where is_scheduled = 1
	select dbo.ef_selFirstLastAppointmentDate('520FA309-5E82-46CC-95E4-1CD96109E2EE',0)
	--drop function ef_firstLastAppointmentDate
	*/
	declare @date datetime

	if @first = 1
		select top 1 
			@date = isnull(sa.appointment_date, '1/1/1900')
		from 
			account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock)
			join account_organization_user_profile aoup with (nolock) on 
				aoup.account_id = aouppcs.account_id 
				and aoup.organization_id = aouppcs.organization_id 
				and aoup.[user_id] = aouppcs.[user_id]
			join scheduling_appointments sa with (nolock) on sa.buyer_profile_id = aoup.profile_id 
		where 
			is_scheduled = 1 
			and buyer_profile_id = @buyer_profile_id
		order by
			appointment_date asc
	else
		select top 1 
			@date = isnull(sa.appointment_date, '1/1/1900')
		from 
			account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock)
			join account_organization_user_profile aoup with (nolock) on 
				aoup.account_id = aouppcs.account_id 
				and aoup.organization_id = aouppcs.organization_id 
				and aoup.[user_id] = aouppcs.[user_id]
			join scheduling_appointments sa with (nolock) on sa.buyer_profile_id = aoup.profile_id 
		where 
			is_scheduled = 1 
			and buyer_profile_id = @buyer_profile_id
		order by
			appointment_date desc

	return @date
end
GO
PRINT N'Creating Function [dbo].[ef_selFullLegalDescription]...';


GO
create FUNCTION ef_selFullLegalDescription 
(
	-- Add the parameters for the function here
	@account_id uniqueidentifier,
	@organization_id uniqueidentifier,
	@user_id uniqueidentifier,
	@community_name varchar(50),
	@series varchar(50),
	@plan_name varchar(50)
)
RETURNS varchar(100)
AS
BEGIN

	/*
		Usage: select dbo.ef_selFullLegalDescription(account_id, organization_id, user_id, community_name, series, plan_name) from account_organization_user_profile_plan aoupp with (nolock)
		
		Modified By: Charles Moore
		Date: 9/10/2021
		Description: Convert Lot to string values 
	*/
	-- Declare the return variable here
	DECLARE @address varchar(100)

	-- get the property desc 1&2 labels
	declare @property_desc_label_1 varchar(20)
	declare @property_desc_label_2 varchar(20)

	select 
		@property_desc_label_1 = isnull(property_desc_1_label,''),
		@property_desc_label_2 = isnull(property_desc_2_label,'')
	from
		veosolutionssecurity_organizations vso with (nolock)
	where
		vso.organization_id = @organization_id

	select 

		@address = 

		[address] + ' ' + 
		case len(property_desc_1) when 0 then '' else @property_desc_label_1 + ' ' + isnull(property_desc_1,'') + ' '  end + 
		case len(property_desc_2) when 0 then '' else @property_desc_label_2 + ' ' + isnull(property_desc_2,'') + ' '  end +
		case len(block) when 0 then '' else 'Block: ' + block + ' ' end +
		case when lot in('0','') then '' else 'Lot: ' + lot end
	from 
		account_organization_user_profile_plan aoupp with (nolock)
	where
		account_id = @account_id 
		and organization_id = @organization_id
		and [user_id] = @user_id
		and community_name = @community_name
		and series = @series 
		and plan_name = @plan_name

	-- Return the result of the function
	RETURN @address

END
GO
PRINT N'Creating Function [dbo].[ef_selLastCompletionDateByUser]...';


GO

CREATE function [dbo].[ef_selLastCompletionDateByUser]
(
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier
)
returns datetime
as
begin
	declare @completion_date datetime
	select top 1 
		@completion_date = first_completed_date
	from
		account_organization_user_profile_plan_catalog_sessions with (nolock) 
	where
		account_id = @account_id
		and organization_id = @organization_id
		and [user_id] = @user_id	
	order by 
		first_completed_date desc
	return @completion_date
end
GO
PRINT N'Creating Function [dbo].[ef_selSalesCounselorNameFromProfilePlan]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION ef_selSalesCounselorNameFromProfilePlan 
(
	-- Add the parameters for the function here
	@account_id uniqueidentifier,
	@organization_id uniqueidentifier,
	@user_id uniqueidentifier,
	@community_name varchar(50),
	@series varchar(50),
	@plan_name varchar(50)
)
RETURNS varchar(50)
AS
BEGIN
	-- Declare the return variable here
	DECLARE @salesCounselorName varchar(50)

	declare @salesCounselorID varchar(50)
	select @salesCounselorID = sales_counselor from account_organization_user_profile_plan where
		account_id = @account_id 
		and organization_id = @organization_id 
		and [user_id] = @user_id 
		and community_name = @community_name 
		and series = @series
		and plan_name = @plan_name 
		
	declare @first_name varchar(25), @last_name varchar(25)
	if exists(select first_name from veosolutionssecurity_users where email = @salesCounselorID)
	begin
		select @first_name = first_name, @last_name = last_name from veosolutionssecurity_users where email = @salesCounselorID
		set @salesCounselorName = @first_name + ' ' + @last_name
	end
	else
	begin
		set @salesCounselorName = @salesCounselorID
	end

	-- Return the result of the function
	RETURN @salesCounselorName

END
GO
PRINT N'Creating Function [dbo].[ef_selSchedulingAppointmentSystemNote]...';


GO

/*
 =============================================
 Author:		Robert Hobbs
 Create date:   04/23/13
 Description:	Builds a system generated buyer note
 =============================================
 Modifier:		Justin Pope
 Modified date: 11/13/24
 Description:	17656 - Provitional Note for Appointments
 =============================================
 */
CREATE FUNCTION [dbo].[ef_selSchedulingAppointmentSystemNote]
(
	@appointment_id uniqueidentifier, 
	@action varchar(30),
    @is_provisional bit = 0
)
RETURNS varchar(300)
AS
BEGIN
    /*
	testing 
	select * from scheduling_appointments where is_scheduled = 1 
	select * from scheduling_users
	declare @note varchar(300); select @note =  dbo.ef_selSchedulingAppointmentSystemNote('0FB1BA09-40A2-411F-85BF-0A13EB573366', 'Scheduled'); select @note;
	declare @note varchar(300); select @note =  dbo.ef_selSchedulingAppointmentSystemNote('0FB1BA09-40A2-411F-85BF-0A13EB573366', 'Changed Start Time'); select @note;
	declare @note varchar(300); select @note =  dbo.ef_selSchedulingAppointmentSystemNote('0FB1BA09-40A2-411F-85BF-0A13EB573366', 'Changed Duration'); select @note;
    */
	
	declare @note varchar(300) 
	set @note = '' 

	declare @appt_ord varchar(10)
	declare @date varchar(25) 
	declare @time varchar(25) 
	declare @designer varchar(100) 
	declare @duration int

	-- select * from scheduling_appointment_types
	select 
		@appt_ord = at.abbrev, 
		@date = convert(varchar, a.appointment_date,107), 
		@time = convert(varchar(15), a.start_time, 100), 
		@designer = (u.first_name + ' ' + u.last_name), 
		@duration = a.appointment_duration
	from 
		scheduling_appointments a 
		join scheduling_appointment_types at on at.appointment_type = a.appointment_type 
		join scheduling_users u on u.user_id = a.schedule_user_id
	where
		a.appointment_id = @appointment_id 

    declare @appointment varchar(50) = 'appt';
    if @is_provisional = 1
    begin
        set @appointment = 'provisional appt';
    end

	declare @note_1 varchar(150) = '<action> <appt_ord> <appointment> ';
	declare @note_2 varchar(150) = 'for <date> @ <time> w/<designer>';
	declare @note_3 varchar(150) = 'on <date> w/<designer> to <time>';
	declare @note_4 varchar(150) = 'on <date> w/<designer> to <duration>h';

	if @action in ( 'Scheduled' , 'Rescheduled', 'Reassigned') 
	begin 
		set @note = @note_1 + @note_2
	end 
	else if @action = 'Changed Start Time' 
	begin 
		set @action = @action + ' for';
		set @note = @note_1 + @note_3;
	end 
	else if @action = 'Changed Duration'
	begin 
		set @action = @action + ' for';
		set @note = @note_1 + @note_4;
	end 

	return replace(replace(replace(replace(replace(replace(replace(@note, '<action>', @action), 
																		  '<appt_ord>', @appt_ord), 
																		  '<appointment>', @appointment), 
																		  '<date>', @date), 
																		  '<time>', @time), 
																		  '<designer>', @designer), 
																		  '<duration>', convert(varchar(3), @duration/60))

END
GO
PRINT N'Creating Function [dbo].[ef_selSchedulingBuyerActivityNotes]...';


GO
CREATE function [dbo].[ef_selSchedulingBuyerActivityNotes]
	(@buyer_profile_id uniqueidentifier = '55900518-336A-4528-B9F2-68A34C3A6FAF')
returns varchar(max)
as
/*
		Procedure:		ef_selSchedulingBuyerActivityNotes
		Author:			Richard Gladstone
		Date:			07/15/2014
		Purpose:		Creates a single, congomerated notes value for a session
						Excludes system-generated notes
		Usage:			select dbo.ef_selSchedulingBuyerActivityNotes('BA20BB0A-2026-46BC-9EB9-563E5C5B36E5')
						select * from scheduling_messages where buyer_profile_id = 'BA20BB0A-2026-46BC-9EB9-563E5C5B36E5'
*/
begin
	declare @notes varchar(max) = ''

	select 
		@notes = @notes + convert(varchar(5), create_date,101) + ': ' + message_body + ' '
	from  
		scheduling_messages 
	where 
		buyer_profile_id = @buyer_profile_id 
		-- and message_type not in (10, 2, 0)
		and message_title = ''
	order by 
		create_date

	return replace(replace( @notes,char(10),''),char(13),'')
end
GO
PRINT N'Creating Function [dbo].[ef_selSchedulingBuyerContactsByRole]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION ef_selSchedulingBuyerContactsByRole
(
	@profile_id uniqueidentifier,
	@role varchar(200)
)
RETURNS varchar(200)
AS
BEGIN

	declare @contact_label varchar(200)
	
	-- Add the T-SQL statements to compute the return value here
	SELECT 
		@contact_label = contact_label 
	from 
		scheduling_buyers_contacts
	where
		profile_id = @profile_id 
		and contact_role = @role

	-- Return the result of the function
	RETURN @contact_label

END
GO
PRINT N'Creating Function [dbo].[ef_selSchedulingBuyerFirstPhone]...';


GO
CREATE function ef_selSchedulingBuyerFirstPhone
(@profile_id uniqueidentifier)
RETURNS varchar(25)
AS
BEGIN 
--SUMMARY 
-- Looks for the first available phone number for a buyer using an order of precedence: 
-- CELL/MOBILE
-- HOME
-- WORK 

-- select * from scheduling_buyers_contacts
-- select dbo.ef_selSchedulingBuyerFirstPhone('BD00E76B-0737-464B-82B7-2311B84E6B20')

declare @mobile_phone varchar(20) 
declare @work_phone varchar(20) 
declare @home_phone varchar(20) 

-- LOOK FOR BUYER FIRST
SELECT
	@mobile_phone = mobile_phone, 
	@work_phone = work_phone, 
	@home_phone = home_phone 
from 
		scheduling_buyers_contacts
	where
		contact_role = 'Buyer' 
		and profile_id = @profile_id 


if len(@mobile_phone) > 0 
return @mobile_phone + ' (c)' 

if len(@home_phone) > 0 
return @home_phone + ' (h)'

if len(@work_phone) > 0 
return @work_phone + ' (w)'


return '' 

END
GO
PRINT N'Creating Function [dbo].[ef_selTotalBuyerDesignDuration]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION [dbo].[ef_selTotalBuyerDesignDuration]
(
	@profile_id uniqueidentifier
)
RETURNS time
AS
BEGIN

/* 
select * from scheduling_appointments where start_time_actual is not null
select dbo.[ef_selTotalBuyerDesignDuration]('CAF34D10-0D41-4750-82A2-C12DC756C7F1')
*/


declare @appointments as table 
( row_id int IDENTITY(1,1),
appointment_type int, 
appointment_date datetime, 
appointment_start time,
start_time_actual time, 
end_time_actual time, 
appt_duration_minutes int) 

-- select * from scheduling_appointments 
 
insert into @appointments 
select 
appointment_type, 
appointment_date, 
start_time, 
start_time_actual, 
end_time_actual, 
null
from 
scheduling_appointments 
where 
buyer_profile_id = @profile_id 
and is_scheduled = 1
order by 
appointment_date, start_time asc

update @appointments 
set appt_duration_minutes = DATEDIFF(minute, dbo.ef_selAppointmentCheckInCheckOutTimeByOrdinal(@profile_id, row_id, 1), dbo.ef_selAppointmentCheckInCheckOutTimeByOrdinal(@profile_id, row_id, 0))   

declare @minutes int
select @minutes =0 


declare @time time 



select @time = convert(time, DATEADD(minute, sum(appt_duration_minutes), 0))  from @appointments 

return @time 


END
GO
PRINT N'Creating Function [dbo].[ef_selWorkingDatesBetweenDates]...';


GO
-- =============================================
-- Author:		Robert Hobbs
-- Create date: 02/11/13
-- Description:	Calculates workdays between dates
-- =============================================
CREATE FUNCTION [dbo].[ef_selWorkingDatesBetweenDates]
(
	@start datetime, 
	@end datetime, 
	@exclude_start bit = 0 
)
RETURNS int
AS
BEGIN

-- SUMMARY: 
-- Calculate the working days between two dates
-- if @excelude_start = 1, then it discounts this date. 



-- return DATEDIFF(dd, @received_date ,@calc_date ) 
declare @days int 

SELECT 
	@days = COUNT(*) 
FROM 
	dbo.calendar
WHERE 
dt >= convert(date, @start) -- INCLUDE START DATE 
AND dt <=  convert(date, @end) -- INCLUDE COMPLETION DATE 
AND IsWorkDay = 1;

if (@days = 1) 
return 1; 

if (@days <= 0) 
return null; 

if (@exclude_start = 1) 
begin 
	return @days -1; 
end 

return @days


END
GO
PRINT N'Creating Function [dbo].[getSessionWBSCommunityID]...';


GO
CREATE function [dbo].[getSessionWBSCommunityID]  
(  
 @session_id varchar(36)
)  
returns int 
as  
begin
declare @community_id int
set @community_id = 0

select 
	top 1
	@community_id = isnull(ec.community_id,ec2.community_id)

from  
	account_organization_user_profile_plan_catalog_sessions cs with (nolock)  

left join veosolutionssecurity_organizations vso with (nolock) on vso.organization_id = cs.organization_id

left join dbo.veo_customers vcust with (nolock) on vcust.custnmbr = vso.external_organization_id	

left join veosolutionssecurity_account_organization_communities aoc with (nolock) on 
	aoc.account_id = cs.account_id 
	and aoc.organization_id = cs.organization_id
	and aoc.name = cs.community_name
	
left join veosolutionssecurity_account_organization_communities_mappings aocm with (nolock) on
	aocm.community_id = aoc.community_id

left join dbo.veo_communities ec with (nolock) on --join actual community to wbs communities
	ec.name = aoc.name

	
left join dbo.veo_communities ec2 with (nolock) on -- join mapped commuity to wbs communities
	ec2.name = aocm.mapped_name
	

where
	cs.session_id = @session_id
	and ec.region_id = vcust.region_id
	
return @community_id

end
GO
PRINT N'Creating Function [dbo].[getSessionWBSSeries]...';


GO

CREATE function [dbo].[getSessionWBSSeries]  
(  
 @session_id varchar(36)
)  
returns varchar(50)
as  
begin

declare @series varchar(50)


--first determine of we have any mapped wbs series

declare @series_mapped_count int
select 
	@series_mapped_count = count(aosm.mapped_name)
	
from  
	account_organization_user_profile_plan_catalog_sessions cs with (nolock)  


left join veosolutionssecurity_organizations vso with (nolock) on vso.organization_id = cs.organization_id


left join veosolutionssecurity_account_organization_series aos with (nolock) on 
	aos.account_id = cs.account_id 
	and aos.organization_id = cs.organization_id
	and aos.name = cs.series
	
left join veosolutionssecurity_account_organization_series_mappings aosm with (nolock) on	
	aosm.series_id = aos.series_id



where
	cs.session_id = @session_id



if @series_mapped_count = 0 or @series_mapped_count > 1
	begin
		-- no mapped series, this assume that vs series is wbs series
		select 
			--count(aosm.mapped_name)
			@series= cs.series
		from  
			account_organization_user_profile_plan_catalog_sessions cs with (nolock)  
		left join veosolutionssecurity_organizations vso with (nolock) on 
			vso.organization_id = cs.organization_id
		where
			cs.session_id = @session_id
	end
else if @series_mapped_count = 1
	begin
	-- 1 mapped series so this is the wbs series
		select 
			@series =aosm.mapped_name
		from  
			account_organization_user_profile_plan_catalog_sessions cs with (nolock)  


		left join veosolutionssecurity_organizations vso with (nolock) on 
			vso.organization_id = cs.organization_id

		left join veosolutionssecurity_account_organization_series aos with (nolock) on 
			aos.account_id = cs.account_id 
			and aos.organization_id = cs.organization_id
			and aos.name = cs.series
	
		left join veosolutionssecurity_account_organization_series_mappings aosm with (nolock) on	
			aosm.series_id = aos.series_id

		where
			cs.session_id = @session_id
	end

--else
--	begin
--		set @series = ''
--	end

-- orig code - changed 10/1/13 ADG 
--select 
--	--cs.spec_id,
--	--cs.session_id,
--	--vcust.custnmbr,
--	--aosm.mapped_name,
--	--cs.series,
--	--ss.series,
--	@series = isnull(ss.series,cs.series)
	
--from  
--	account_organization_user_profile_plan_catalog_sessions cs with (nolock)  


--left join veosolutionssecurity_organizations vso with (nolock) on vso.organization_id = cs.organization_id

--left join veo_customers vcust with (nolock) on vcust.custnmbr = vso.external_organization_id	

--left join veosolutionssecurity_account_organization_series aos with (nolock) on 
--	aos.account_id = cs.account_id 
--	and aos.organization_id = cs.organization_id
--	and aos.name = cs.series
	
--left join veosolutionssecurity_account_organization_series_mappings aosm with (nolock) on
	
--	aosm.series_id = aos.series_id

--left join veo_spec_series ss with (nolock) on
--	ss.spec_id = cs.spec_id and
--	ss.series = aosm.mapped_name

--where
--	cs.session_id = @session_id

return @series

end
GO
PRINT N'Creating Function [dbo].[of_selPublishedSessionItemStyleGroup]...';


GO

CREATE  function [dbo].[of_selPublishedSessionItemStyleGroup]     
(        
 @session_id uniqueidentifier,
 @customer_id varchar(50),         
 @effective_date varchar(30),        
 @application_id varchar(10),         
 @product_id varchar(10),          
 @item_number varchar(81),
 @published_date datetime         
)        
returns int        
        

/*



*/        
as        
begin        
        
 declare @group_id int        
 set @group_id = null        
        
 --==================================        
 -- Check if the color is in a group        
 --==================================        
 select top 1         
   @group_id = sgd.group_id        
 from         
  catalog_prices_published_groups_detail sgd with (nolock)        
  join dbo.Veo_styles_groups sg with (nolock) on sg.group_id = sgd.group_id        
 where        
  sg.application_id = @application_id         
  and sg.product_id = @product_id         
  and sgd.customer_id = @customer_id        
  and sgd.item_type = 'color'         
  and sgd.item = @item_number         
  and sgd.effective_date <= @effective_date      
  and (cast(sgd.end_date as date) >= cast(@effective_date as date) or sgd.end_date is null)     
  and session_id = @session_id
 order by        
  effective_date desc        
        
 if @group_id is null         
  begin         
   --==========================================        
   -- Check if the color's style is in a group        
   --==========================================        
   declare @style_id varchar(50)        
   set @style_id = ''        
         
   select @style_id = style_id from veo_colors with (nolock) where part_no = @item_number         
        
   select top 1         
     @group_id = sgd.group_id        
   from         
    catalog_prices_published_groups_detail sgd with (nolock)       
    join veo_styles_groups sg with (nolock) on sg.group_id = sgd.group_id        
   where        
    sg.application_id = @application_id         
    and sg.product_id = @product_id         
    and sgd.customer_id = @customer_id        
    and sgd.item_type = 'style'         
    and sgd.item = @style_id         
    and sgd.effective_date <= @effective_date        
    and (cast(sgd.end_date as date) >= cast(@effective_date as date) or sgd.end_date is null)  
	and session_id = @session_id         
   order by effective_date desc        
  end         
        
 return @group_id        
end
GO
PRINT N'Creating Function [dbo].[vdsf_buildHasFreePriceLevel]...';


GO
-- =============================================
-- Author:		Shelby Mansker
-- Create date: 9/22/2014
-- Description:	This function indicates whether or not the build,
--  for a given session, has a free (zero price) price level in it,
--  that isn't custom or a pad level.
-- =============================================
CREATE FUNCTION [dbo].[vdsf_buildHasFreePriceLevel] 
(
	@session_id UNIQUEIDENTIFIER,
    @build_id INT
)
RETURNS BIT
AS
BEGIN
	
    --initialize the flag to indicate not a standard product
    DECLARE @is_standard BIT = 0

    --set the standard flag if we find a price of zero that isn't custom or pad levels
    SELECT
        @is_standard = 1
    FROM
        dbo.catalog_selections WITH (NOLOCK)
    WHERE
        session_id = @session_id
        AND build_id = @build_id
        AND RTRIM(item) <> 'custom'
        AND item NOT LIKE '%pad%'
        AND price = 0.00

    RETURN ISNULL(@is_standard, 0)
END
GO
PRINT N'Creating Function [dbo].[vdsf_getBomModificationNotes]...';


GO
CREATE FUNCTION [dbo].[vdsf_getBomModificationNotes]
(
@session_id uniqueidentifier,
@build_id int
)
returns varchar(max)
as

/*
	Author:	Adrian Garza
	Date:	2/15/2017
	Purpose:	used by vs_selVeoSolutionsSelectionSetDataExport to add bom mod notes

	Modifier:    Saul Sanchez
	Date:        11/12/2018
	Description: Someone changed the proc in production, and I am simply updating it here to match what was in production.
*/

begin

	declare @result varchar(max) = '',@value_delim char = ' ',@item_delim char = ';'

	declare @item varchar(50),@qty as int, @cost decimal(18,2),@notes varchar(max),@modification_type varchar(20)

	declare cur_bom_modificiation cursor for

	SELECT 
		   csbm.item,
		   csabm.quantity,
		   csbm.cost,
		   csabm.notes,
		   bbmt.[name] AS modification_type
	FROM 
		   catalog_selections_area_bom_modifications csabm
		   JOIN catalog_selections_bom_modifications csbm ON csbm.id = csabm.session_bom_modification_id
		   JOIN builder_bom_modification_types bbmt ON bbmt.id = csbm.modification_type
	WHERE csabm.session_id = @session_id
	and csabm.build_id = @build_id

	open cur_bom_modificiation
	fetch next from cur_bom_modificiation into
		@item,
		@qty,
		@cost,
		@notes,
		@modification_type

	while @@FETCH_STATUS = 0
	begin
		set @result = @result +'Item: '+ @item + @value_delim + 'Qty: '+ ltrim(str(@qty)) + @value_delim +'Cost: ' + ltrim(str(@cost)) + @value_delim +'Notes: ' + @notes + @value_delim+ 'Mod Type: ' + @modification_type + @item_delim + @value_delim
		fetch next from cur_bom_modificiation into
			@item,
			@qty,
			@cost,
			@notes,
			@modification_type
	end
	close cur_bom_modificiation
	deallocate cur_bom_modificiation

	return @result

end
GO
PRINT N'Creating Function [dbo].[vdsf_isCreditArea]...';


GO
CREATE FUNCTION [dbo].[vdsf_isCreditArea](@session_id UNIQUEIDENTIFIER, @application VARCHAR(100), @product VARCHAR(100), @area VARCHAR(100), @sub_area VARCHAR(100))
RETURNS BIT AS
BEGIN

DECLARE @is_credit_area BIT = 0

SELECT TOP 1
    @is_credit_area = is_credit
FROM
    dbo.catalog_selections WITH (NOLOCK)
WHERE
    session_id = @session_id
    AND [application] = @application
    AND product = @product
    AND area = @area
    AND sub_area = @sub_area
    AND RTRIM(item) <> 'custom'
    AND item NOT LIKE '%pad%'

RETURN @is_credit_area

END
GO
PRINT N'Creating Function [dbo].[vdsf_isOrganizationFeatureOn]...';


GO
CREATE FUNCTION vdsf_isOrganizationFeatureOn
(
	@organization_id UNIQUEIDENTIFIER,
	@feature_id INT
)
RETURNS BIT
AS

/*
	Author: Eric Hickey
	Date: 1/12/2020
	Description: Determines if a feature flag is on for an organization.
				If the organization is not configured for this feature, 0 will be returned.
				If the feature is not defined, 0 will be returned.
*/

BEGIN
	DECLARE @result BIT

	SELECT
		@result = [value]
	FROM
		[dbo].builder_features
	WHERE
		organization_id = @organization_id
		AND
		feature_id = @feature_id

	-- Return the value of the feature, or 0 if the organization or feature was not found.
	RETURN COALESCE(@result, 0)
END
GO
PRINT N'Creating Function [dbo].[vdsf_isSpecItemExcludedOnSessionBuild]...';


GO
CREATE FUNCTION [dbo].[vdsf_isSpecItemExcludedOnSessionBuild] (
    @session_id UNIQUEIDENTIFIER,
    @build_id INT,
    @real_item_id VARCHAR(31),
    @application_id VARCHAR(10) = '',
    @product_id VARCHAR(10) = '',
    @area_id VARCHAR(10) = '',
    @sub_area_id VARCHAR(10) = '')
RETURNS BIT
AS
BEGIN

	--=================================================================
    -- Declare the return value.
	--=================================================================
    DECLARE @spec_item_excluded BIT
    SET @spec_item_excluded = 0

	--=================================================================
    -- Declare variables.
	--=================================================================
    DECLARE @spec_id INT
    DECLARE @plan_id INT
    DECLARE @location_id INT
    DECLARE @application_product_flags_found BIT
    DECLARE @application_product_included BIT
    DECLARE @application_product_excluded BIT
    DECLARE @area_sub_area_flags_found BIT
    DECLARE @area_sub_area_included BIT
    DECLARE @area_sub_area_excluded BIT

	--=================================================================
    -- Populate the application, product, area, and sub area ids if
    -- they were not already passed in.
	--=================================================================
    IF (@application_id = '' AND @product_id = '' AND @area_id = '' AND @sub_area_id = '')
    BEGIN
        SELECT
            @application_id = app.application_id,
            @product_id = p.product_id,
            @area_id = csa.area_id,
            @sub_area_id = csa.sub_area_id
        FROM
            catalog_selections_areas csa WITH (NOLOCK)
            LEFT JOIN Veo_applications app WITH (NOLOCK) ON app.name = csa.[application]
            LEFT JOIN Veo_products p WITH (NOLOCK) ON p.name = csa.product
        WHERE
            csa.session_id = @session_id
            AND csa.build_id = @build_id
    END

	--=================================================================
    -- Use the session id to get the spec id, plan id, and location id.
	--=================================================================
    SELECT
        @spec_id = ppcs.spec_id,
        @plan_id = pm.plan_id,
        @location_id = pb.location_id
    FROM
        dbo.account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
        LEFT JOIN Veo_plan_mstr pm WITH (NOLOCK)
            ON pm.spec_id = ppcs.spec_id
            AND pm.plan_name = ppcs.plan_name
            AND pm.active = 1
        LEFT JOIN Veo_plan_builds pb WITH (NOLOCK)
            ON pb.plan_id = pm.plan_id
            AND pb.application_id = @application_id
            AND pb.product_id = @product_id
            AND pb.area_id = @area_id
            AND pb.sub_area_id = @sub_area_id
            AND pb.build_id = @build_id
            AND (pb.elevation = 'Any' OR pb.elevation = pm.elevation)
            AND pb.active = 1
    WHERE
        ppcs.session_id = @session_id

    --=================================================================
    -- Get the included/excluded flags at the application/product level.
    --=================================================================
    SELECT
        @application_product_flags_found = (CASE included
                                                WHEN NULL THEN 0
                                                ELSE 1
                                            END),
        @application_product_included = included,
        @application_product_excluded = excluded
    FROM
        veo_spec_areas_items WITH (NOLOCK)
    WHERE
        spec_id = @spec_id
        AND application_id = @application_id
        AND product_id = @product_id
        AND LEN(area_id) = 0
        AND LEN(sub_area_id) = 0
        AND (location_id = @location_id or location_id = 0)
        AND item = @real_item_id

    --=================================================================
    -- Get the included/excluded flags at the area/sub area level.
    --=================================================================
    SELECT
        @area_sub_area_flags_found = (CASE included
                                          WHEN NULL THEN 0
                                          ELSE 1
                                      END),
        @area_sub_area_included = included,
        @area_sub_area_excluded = excluded
    FROM
        veo_spec_areas_items WITH (NOLOCK)
    WHERE
        spec_id = @spec_id
        AND application_id = @application_id
        AND product_id = @product_id
        AND area_id = @area_id
        AND sub_area_id = @sub_area_id
        AND (location_id = @location_id or location_id = 0)
        AND item = @real_item_id

    --=================================================================
    -- If we found include/exclude flags at the application/product
    -- level, then use these flags to determine the return value.
    --=================================================================
    IF @application_product_flags_found = 1
    BEGIN
        IF @application_product_included = 1
            SET @spec_item_excluded = 0

        IF @application_product_excluded = 1
            SET @spec_item_excluded = 1
    END

    --=================================================================
    -- If we found include/exclude flags at the area/sub area level,
    -- then these flags override those found at the application/product
    -- level.
    --=================================================================
    IF @area_sub_area_flags_found = 1
    BEGIN
        IF @area_sub_area_included = 1
            SET @spec_item_excluded = 0

        IF @area_sub_area_excluded = 1
            SET @spec_item_excluded = 1
    END

    RETURN @spec_item_excluded

END
GO
PRINT N'Creating Function [dbo].[vdsf_isUserSysAdmin]...';


GO
CREATE FUNCTION [dbo].[vdsf_isUserSysAdmin]
(
	@user_id uniqueidentifier
)
RETURNS bit
AS
BEGIN
	DECLARE @is_sysadmin int
	set @is_sysadmin = (
		select 

			count(*)

		from VeoSolutionsSecurity_users vssu with (nolock)

		left join  VeoSolutionsSecurity_account_organization_users aou with (nolock) on
			aou.user_id = vssu.user_id

		left join VeoSolutionsSecurity_account_organization_users_roles_legacy aour with (nolock) on
			aour.account_id = aou.account_id
			and aour.organization_id = aou.organization_id
			and aour.user_id = @user_id

		left join VeoSolutionsSecurity_roles_legacy r with (nolock) on 
			r.role_id = aour.role_id

		where 
			vssu.user_id = @user_id and r.name = 'System Administrator'
			)
	declare @result bit;
	if (@is_sysadmin >= 1) set @result = 1 else set @result = 0;
	return @result;
END
GO
PRINT N'Creating Function [dbo].[vdsf_RoundBanker]...';


GO

CREATE FUNCTION [dbo].[vdsf_RoundBanker] (@x money, @DecimalPlaces tinyint) 
RETURNS money AS 
BEGIN 
--http://www.sqlservercentral.com/Forums/Topic246556-8-1.aspx
set @x = @x * power(10, @DecimalPlaces)

return
  case when @x = floor(@x) then @x
  else
    case sign(ceiling(@x) - 2*@x + floor(@x))
    when 1 then floor(@x)
    when -1 then ceiling(@x)
    else 2*round(@x/2,0) end
  end / power(10, @DecimalPlaces) 

END
GO
PRINT N'Creating Function [dbo].[vdsf_sanitizeStringForXml]...';


GO
CREATE FUNCTION [dbo].[vdsf_sanitizeStringForXml]
(
	@textToSanitize VARCHAR(MAX)
)
RETURNS VARCHAR(MAX)
AS
BEGIN
	DECLARE @ret VARCHAR(MAX)
	DECLARE @Pattern CHAR(37)  --Bad characters to look for

	SELECT @Pattern = '%['
					+ CHAR(0)+CHAR(1)+CHAR(2)+CHAR(3)+CHAR(4)
					+ CHAR(5)+CHAR(6)+CHAR(7)+CHAR(8)+CHAR(9)
					+ CHAR(10)+CHAR(11)+CHAR(12)+CHAR(13)+CHAR(14)
					+ CHAR(15)+CHAR(16)+CHAR(17)+CHAR(18)+CHAR(19)
					+ CHAR(20)+CHAR(21)+CHAR(22)+CHAR(23)+CHAR(24)
					+ CHAR(25)+CHAR(26)+CHAR(27)+CHAR(28)+CHAR(29)
					+ CHAR(30)+CHAR(31)+CHAR(127)
					+ ']%'

	;WITH t1 AS (SELECT 1 N UNION ALL SELECT 1 N), 
	t2 AS (SELECT 1 N FROM t1 x, t1 y),
	t3 AS (SELECT 1 N FROM t2 x, t2 y),
	t4 AS (SELECT 1 N FROM t3 x, t3 y),
	t5 AS (SELECT 1 N FROM t4 x, t4 y),
	cteTally AS (SELECT ROW_NUMBER() OVER (ORDER BY (SELECT NULL)) N
			  FROM t5 x, t5 y) ,
	-- cte to return each character on a seperate row.  1st where condition eliminates the
	-- unwanted characters
	cteEachChar AS (
		SELECT N 
			, SUBSTRING(@textToSanitize, N, 1) AS Ch
		FROM cteTally
		WHERE PATINDEX(@Pattern, SUBSTRING(@textToSanitize, N, 1)) = 0  
			AND N <= LEN(@textToSanitize)
	),
	-- cte puts the characters back into a single row/single column
	cteStringify(NewString) AS (
		SELECT  Ch [text()]
		FROM cteEachChar  
		FOR XML PATH('') 
	)
	-- fix our spaces (FOR XML added coding)
	SELECT @ret = REPLACE(ISNULL(NewString, ''), '&#x20;', ' ') 
	FROM cteStringify

	RETURN @ret
END
GO
PRINT N'Creating Function [dbo].[vdsf_selRoleIdByName]...';


GO
CREATE FUNCTION [dbo].[vdsf_selRoleIdByName]
(
	@role_name varchar(100)
)
RETURNS UNIQUEIDENTIFIER
AS
BEGIN

	DECLARE @role_id UNIQUEIDENTIFIER

	SELECT
         @role_id = role_id
    FROM
        VeoSolutionsSecurity_roles_legacy WITH (NOLOCK)
    WHERE
        name = @role_name

	-- Return the result of the function
	RETURN @role_id

END
GO
PRINT N'Creating Function [dbo].[vdsf_selUserIDFromToken]...';


GO

create FUNCTION [dbo].[vdsf_selUserIDFromToken]
(
	@security_token UNIQUEIDENTIFIER
)
RETURNS uniqueidentifier
AS
/*
	Author:	Adrian Garza
	Create date: 9/10/2014
	Description: returns user_id from security token

*/
BEGIN

	declare @user_id uniqueidentifier

	-- Calculate the expiration date by adding 1 day to the date which the token was created
	SELECT 
		top 1 @user_id = user_id
	FROM 
		VeoSolutionsSecurity_users_login_sessions WITH (NOLOCK) 
	WHERE 
		security_token = @security_token



	RETURN @user_id
END
GO
PRINT N'Creating Function [dbo].[vdsf_Veoround]...';


GO

CREATE FUNCTION [dbo].[vdsf_Veoround](@value decimal(18,4),@sessionID uniqueidentifier)
returns decimal(18,4) as
begin

declare @result decimal(18,4)

declare @roundingType int
declare @roundingPlaces int

-- read rounding types from session

SELECT 
	@roundingType = aouppcs.rounding_type,
	@roundingPlaces = aouppcs.rounding_places
FROM 
	account_organization_user_profile_plan_catalog_sessions aouppcs WITH (NOLOCK)
	--left join VeoSolutionsSecurity_organizations o with (nolock) on 
	--	o.organization_id = aouppcs.organization_id
WHERE 
	session_id = @sessionID


set @result = @value

if (@roundingType = 0) -- truncate
begin

	 select @result =  round(@value,@roundingPlaces,1)
end

if (@roundingType = 1) -- midpoint
begin

	set @result =  round(@value,@roundingPlaces)
end

if (@roundingType = 2) -- ceiling
begin

	set @result =  ceiling(@value)
end

if (@roundingType = 3) -- banker
begin

	 select @result =  dbo.vdsf_RoundBanker(@value,@roundingPlaces)
end


return  @result

END
GO
PRINT N'Creating Function [dbo].[vdsf_VeoroundBySession]...';


GO
CREATE FUNCTION [dbo].[vdsf_VeoroundBySession](@value decimal(18,4), @sessionID uniqueidentifier)
returns decimal(18,4) as
begin

-- Modified 11/17/2014. Only handle rounding for a non-null value. Saul.

declare @result decimal(18,4) = null

declare @roundingType int
declare @roundingPlaces int

-- read rounding types from session
IF (@value IS NOT NULL)
BEGIN
    SELECT 
	    @roundingType = aouppcs.rounding_type,
	    @roundingPlaces = aouppcs.rounding_places
    FROM 
	    account_organization_user_profile_plan_catalog_sessions aouppcs WITH (NOLOCK)
    WHERE 
	    session_id = @sessionID
        
    set @result = @value

    if (@roundingType = 0) -- truncate
    begin

	     select @result =  round(@value,@roundingPlaces,1)
    end

    if (@roundingType = 1) -- midpoint
    begin

	    set @result =  round(@value,@roundingPlaces)
    end

    if (@roundingType = 2) -- ceiling
    begin

	    set @result =  ceiling(@value)
    end

    if (@roundingType = 3) -- banker
    begin

	     select @result =  dbo.vdsf_RoundBanker(@value,@roundingPlaces)
    end
END

return @result

END
GO
PRINT N'Creating Function [dbo].[ef_IsSessionBillable]...';


GO
CREATE function ef_IsSessionBillable
(
@session_id uniqueidentifier
)
returns bit
as
begin

/*
select dbo.ef_IsSessionBillable ('a9414e2e-27da-436b-bd2e-a150f888e342')
*/

-- get last selection date
declare @lastSelectionDate datetime 
select @lastSelectionDate = max(modification_date) from catalog_selections_area_details_change_log where session_id = @session_id
-- last selection date must be greater than 7 days ago
if datediff(day, @lastSelectionDate, getdate()) <= 7
	return 0

-- get the next / last appointment
declare @lastApptDate datetime
select
	@lastApptDate = dbo.ef_selFirstLastAppointmentDate(p.profile_id, 0)
from 
	account_organization_user_profile_plan_catalog_sessions cs with (nolock)
	left join account_organization_user_profile p with (nolock) on p.account_id = cs.account_id and p.organization_id = cs.organization_id and p.[user_id] = cs.[user_id]
where
	session_id = @session_id

-- homebuyer sessions whose homebuyers have future appointments aren't billable
if @lastApptDate is not null
begin
	if datediff(day, @lastApptDate, getdate()) <= 7
		return 0
end

-- if any appointment exists
if @lastApptDate is not null
begin
	-- if last selection was over 7 days ago
	if datediff(day, @lastSelectionDate, getdate()) > 7
		return 1
	else
		return 0
end
else
begin
	-- if no appointments exist (spec)
	declare @sessionCreateDate datetime
	select @sessionCreateDate = create_date from account_organization_user_profile_plan_catalog_sessions with (nolock) where session_id = @session_id
	-- if the session was created over 30 days ago
	if datediff(day, @sessionCreateDate, getdate()) > 30
		return 1
	else
		return 0
end

return 0

end
GO
PRINT N'Creating Function [dbo].[ef_selSchedulingBuyerActiveProfilePlan]...';


GO
-- =============================================
-- Author:		Robert Hobbs
-- Create date: 04/16/13
-- Description:	
-- Fetches the most active profile plan based on statuses
-- =============================================

/*
	Modified: 1/13/2020 - Eric Hickey
		Conditionally removing section that attempts to return an 'active' profile plan when the organization is using the Prospective Status Feature
*/

CREATE FUNCTION [dbo].[ef_selSchedulingBuyerActiveProfilePlan]
(
	@profile_id uniqueidentifier
)
RETURNS uniqueidentifier
AS
BEGIN

-- note that the early data used plan id instead, so the @profile_id passed here might be a user profile id or it might be a plan profile id. 
-- handle both cases.  

declare @organization_id uniqueidentifier
declare @prospective_status_feature int
declare @user_profile_id uniqueidentifier

set @prospective_status_feature = 20
set @user_profile_id = null 

select @organization_id = organization_id, @user_profile_id = profile_id from account_organization_user_profile with (nolock) where profile_id = @profile_id 
if ( @user_profile_id is null ) 
	select 
		@organization_id = p.organization_id,
		@user_profile_id = p.profile_id 
	from 
		account_organization_user_profile_plan pp  with (nolock)
		join account_organization_user_profile p  with (nolock) on p.account_id = pp.account_id and p.organization_id = pp.organization_id and p.user_id = pp.user_id 
	where 
		pp.profile_id = @profile_id 

declare @plan_id as uniqueidentifier 
set @plan_id = null 

select 
	top 1 @plan_id = pp.profile_id 
from 
	account_organization_user_profile_plan pp  with (nolock)
	join account_organization_user_profile p   with (nolock) on p.account_id = pp.account_id and p.organization_id = pp.organization_id and p.user_id = pp.user_id 
where 
	(p.profile_id = @user_profile_id) 
	AND 
	pp.status = 'Contracted' 

-- The organization must not be using the Prospective Status Feature in order to see active plans
if (@plan_id is null AND [dbo].vdsf_isOrganizationFeatureOn(@organization_id, @prospective_status_feature) = 0)
begin 
	select 
		top 1 @plan_id = pp.profile_id 
	from 
		account_organization_user_profile_plan pp  with (nolock)
		join account_organization_user_profile p  with (nolock) on p.account_id = pp.account_id and p.organization_id = pp.organization_id and p.user_id = pp.user_id 
	where 
		(p.profile_id = @user_profile_id) 
		AND 
		pp.status = 'Active' 

end 

if (@plan_id is null)
begin 
	select 
		top 1 @plan_id = pp.profile_id 
	from 
		account_organization_user_profile_plan pp  with (nolock)
		join account_organization_user_profile p   with (nolock) on p.account_id = pp.account_id and p.organization_id = pp.organization_id and p.user_id = pp.user_id 
	where 
		(p.profile_id = @user_profile_id) 
		AND 
		pp.status = 'Complete' 

end 


if (@plan_id is null)
begin 
	select 
		top 1 @plan_id = pp.profile_id 
	from 
		account_organization_user_profile_plan pp  with (nolock)
		join account_organization_user_profile p   with (nolock) on p.account_id = pp.account_id and p.organization_id = pp.organization_id and p.user_id = pp.user_id 
	where 
		(p.profile_id = @user_profile_id) 
		AND 
		pp.status = 'Bustout' 

end 

return @plan_id

END
GO
PRINT N'Creating Function [dbo].[ef_selBuyerCycleTime]...';


GO
-- =============================================
-- Author:		Robert Hobbs
-- Create date: 02/11/13
-- Description:	Calculates the buyer cycle time using 
-- the following logic: 
-- The Date of the last completed selection session - 
-- the contract receipt date. 
-- If there is no completed selection session, then 
-- use TODAY. 
-- =============================================
CREATE FUNCTION [dbo].[ef_selBuyerCycleTime]
(
	@profile_id uniqueidentifier
)
RETURNS int
AS
BEGIN

-- SUMMARY: 
-- Calculate the days between two dates, where one date is the received date for the buyer, and the other is the completion date for the design sessions. 

-- HISTORY: 
-- MARCH 2013 - Terry wanted to change this logic to work off of received date - (saved when they choose an appointment template) 
-- APRIL 2013 - they want working days, so adding logic to ignore weekends 

-- TESTING 
-- find a buyer where they have completed sessions and a contract date:
-- UNCOMMENT BELOW: 
-- select 
--	pp.*, 
--	s.*
--from 
--account_organization_user_profile_plan_catalog_sessions s
--join account_organization_user_profile_plan pp on s.account_id = pp.account_id and s.organization_id = pp.organization_id and s.user_id = pp.user_id 
--and s.community_name = pp.community_name and s.series = pp.series and s.plan_name = pp.plan_name 
--where 
--s.completed_date not in ('01/01/1900' , '01/01/1980') 
--and pp.contract_date is not null 

-- select top 10 * from account_organization_user_profile_plan where user_id in ('1ECCAB4D-E8A1-49EC-84DD-539176456BDC', '424059BC-E4C9-4F21-BDC2-52E5A24BF9AE')
-- select top 10 * from account_organization_user_profile_plan_catalog_sessions where completed_date <> '1/1/1900'
-- select * from scheduling_buyers where profile_id = 'DD8B964E-FC8B-4856-9EC3-B3D485D4AF98'

-- SANDBOX TESTING: 
-- 

-- FETCH CONTRACT DATE 
--declare @contract_date datetime 
--select @contract_date = contract_date from account_organization_user_profile_plan where profile_id = @profile_id 

-- APRIL

declare @received_date datetime 
select @received_date = received_date from scheduling_buyers where profile_id = @profile_id 

-- FETCH LAST COMPLETED SESSION 
declare @last_session datetime 
set @last_session = null 

select 
	@last_session = max(s.first_completed_date)
from 
account_organization_user_profile_plan_catalog_sessions s
join account_organization_user_profile_plan pp on s.account_id = pp.account_id and s.organization_id = pp.organization_id and s.user_id = pp.user_id 
and s.community_name = pp.community_name and s.series = pp.series and s.plan_name = pp.plan_name 
where 
s.first_completed_date not in ('01/01/1900' , '01/01/1980') 
and pp.profile_id = dbo.ef_selSchedulingBuyerActiveProfilePlan(@profile_id )

-- if last session date is null (no completed sessions that quality), then use TODAY 
declare @calc_date datetime 

set @calc_date = @last_session 

if (@calc_date is null) 
begin 
	set @calc_date = getdate() 
end 


-- return DATEDIFF(dd, @received_date ,@calc_date ) 
declare @cycle_time int 

SELECT 
	@cycle_time = COUNT(*) 
FROM 
	dbo.calendar
WHERE 
dt > convert(date, @received_date) -- INCLUDE START DATE 
AND dt <=  convert(date, @calc_date) -- INCLUDE COMPLETION DATE 
AND IsWorkDay = 1;

return @cycle_time 


--return DATEDIFF(dd, @received_date ,@calc_date ) 


/* 
select dbo.[ef_selBuyerCycleTime]('F9BA74FC-AA3F-4451-8FBC-A7E9D354EC83') 
*/

END
GO
PRINT N'Creating Function [dbo].[of_split]...';


GO
create FUNCTION [dbo].[of_split] (@input_value varchar(max), @delimiter char(1))
RETURNS @return_values TABLE ([index] smallint identity(1, 1), [value] varchar(max))
AS
begin
	declare @found_index bigint
	set @found_index = charindex(@delimiter, @input_value)

	while @found_index > 0
		begin
			insert into @return_values select left(@input_value, @found_index - 1)
			set @input_value = right(@input_value, len(@input_value) - @found_index)
			set @found_index = charindex(@delimiter, @input_value)
		end

	if len(@input_value) > 0
		insert into @return_values select @input_value

	return
end
GO
PRINT N'Creating Function [dbo].[vdsf_selSpecAreaExcludedParts]...';


GO
CREATE FUNCTION [dbo].[vdsf_selSpecAreaExcludedParts]
(
	@session_id UNIQUEIDENTIFIER,
	@spec_id INT,
	@application_id VARCHAR(10),
	@product_id VARCHAR(10),
	@area_id VARCHAR(50),
	@sub_area_id VARCHAR(50),
	@location_id INT,
	@item_id VARCHAR(50)
)
RETURNS @parts TABLE
(
	part_no VARCHAR(81)
)
AS
/*
	Author: Roger Wang
	Date: 7/11/2023
	Description: Determines excluded parts for the session area.
*/
BEGIN
	IF @spec_id <> 0 AND EXISTS( SELECT TOP 1 line_no FROM veo_spec_areas_items WHERE spec_id = @spec_id)
	BEGIN
		INSERT
			@parts
		SELECT
			c.part_no
		FROM
			veo_spec_areas_items sai WITH (NOLOCK)
			INNER JOIN veo_styles_groups sg WITH (NOLOCK) ON sg.group_id = sai.item
			INNER JOIN catalog_selections_group_detail sgd WITH (NOLOCK) ON session_id = @session_id AND sgd.group_id = sg.group_id
			INNER JOIN veo_styles s WITH (NOLOCK) ON s.product_id = sg.product_id AND s.style_id = sgd.item
			INNER JOIN veo_colors c WITH (NOLOCK) ON c.product_id = s.product_id AND c.style_id = s.style_id
		WHERE
			sai.spec_id = @spec_id
			AND sgd.item_type = 'style'
			AND sai.application_id = @application_id
			AND sai.product_id = @product_id
			AND sai.area_id = @area_id
			AND sai.sub_area_id = @sub_area_id
			AND (sai.location_id = @location_id OR sai.location_id = 0)
			AND (sai.item_id = '' OR sai.item_id = @item_id)
			AND sai.item_type = 'group'
			AND sai.excluded = 1

		UNION

		SELECT
			c.part_no
		FROM
			veo_spec_areas_items sai WITH (NOLOCK)
			INNER JOIN veo_styles_groups sg WITH (NOLOCK) ON sg.group_id = sai.item
			INNER JOIN catalog_selections_group_detail sgd WITH (NOLOCK) ON session_id = @session_id AND sgd.group_id = sg.group_id
			INNER JOIN veo_colors c WITH (NOLOCK) ON c.part_no = sgd.item
		WHERE
			sai.spec_id = @spec_id
			AND sgd.item_type = 'color'
			AND sai.application_id = @application_id
			AND sai.product_id = @product_id
			AND sai.area_id = @area_id
			AND sai.sub_area_id = @sub_area_id
			AND (sai.location_id = @location_id OR sai.location_id = 0)
			AND (sai.item_id = '' OR sai.item_id = @item_id)
			AND sai.item_type = 'group'
			AND sai.excluded = 1

		UNION

		-- =======================================================
		-- remove spec_area_items --> styles --> colors
		-- =======================================================
		SELECT
			c.part_no
		FROM
			veo_spec_areas_items sai WITH (NOLOCK)
			INNER JOIN veo_styles s WITH (NOLOCK) ON s.product_id = sai.product_id AND s.style_id = sai.item
			INNER JOIN veo_colors c ON c.product_id = s.product_id AND c.style_id = s.style_id
		WHERE
			sai.spec_id = @spec_id
			AND	sai.application_id = @application_id
			AND sai.area_id = @area_id
			AND sai.sub_area_id = @sub_area_id
			AND (sai.location_id = @location_id OR sai.location_id = 0)
			AND (sai.item_id = '' OR sai.item_id = @item_id)
			AND sai.item_type = 'style'
			AND sai.excluded = 1

		UNION

		-- =======================================================
		-- remove spec_area_items --> colors
		-- =======================================================
		SELECT
			sai.item
		FROM
			veo_spec_areas_items sai WITH (NOLOCK)
		WHERE
			sai.spec_id = @spec_id
			AND	sai.application_id = @application_id
			AND sai.area_id = @area_id
			AND sai.sub_area_id = @sub_area_id
			AND (sai.location_id = @location_id or sai.location_id = 0)
			AND (sai.item_id = '' OR sai.item_id = @item_id)
			AND sai.item_type = 'color'
			AND sai.excluded = 1
	END

	RETURN
END
GO
PRINT N'Creating Function [dbo].[vdsf_selUserOrganizationsFromToken]...';


GO
	

create FUNCTION [dbo].[vdsf_selUserOrganizationsFromToken]
(
	@security_token UNIQUEIDENTIFIER
)
RETURNS @organizations TABLE ([organization_id] uniqueidentifier,[name] varchar(50))	
as
begin
	declare @user_id uniqueidentifier

	-- Calculate the expiration date by adding 1 day to the date which the token was created
	SELECT 
		top 1 @user_id = user_id
	FROM 
		VeoSolutionsSecurity_users_login_sessions WITH (NOLOCK) 
	WHERE 
		security_token = @security_token

    insert into @organizations (organization_id,name)
	select
	 distinct o.organization_id, o.name
	from VeoSolutionsSecurity_account_organization_users ao with (nolock)
	left join VeoSolutionsSecurity_organizations o on o.organization_id = ao.organization_id
	where user_id = @user_id

	return
end
GO
PRINT N'Creating Procedure [integrations].[taylorMorrisonWeeklyReport]...';


GO
CREATE PROCEDURE [integrations].[taylorMorrisonWeeklyReport]
	@account_organization_ids VARCHAR(MAX),
	@reference_date DATETIME NULL = NULL
AS
/*
	Author: Shelby Mansker
	Date: 3/16/2020
	Description: Taylor Morrison has requested that we provide them with a weekly report
		that shows upcoming, and recent, appointment and selection information.

		We will be using an Azure integration service to trigger the weekly report, which
		will call this stored procedure.

	Modified: Shelby Mansker
	Date: 3/30/2020
	Description: Fixed a couple of data issues. First, had to include completed plans when fetching appointment address
		information. Apparently, it is possible to have an appointment in the future, but have the profile plan status
		marked complete. Second, it is possible for the Lot value to be null, and I wasn't checking for that. This happens
		if there is an appointment for someone, and a profile, but their profile plan was deleted.

		Also, added an optional reference_date parameter, so that we can run the proc from a given reference time. If this
		parameter is not passed in, it defaults to the current date time.
	
	Modified By: Charles Moore
	Date: 9/10/2021
	Description: Convert Lot to string values

	Modified By: Shelby Mansker
	Date: 4/4/2022
	Description: Removed Primary Key from @appointments table variable. There are cases where a Profile Plan will have multiple sessions
		for the same address. The primary key constraint caused the sproc to fail when this was the case. We'll just report 
		each session separately when this occurs, which will look like a duplicate row in the output, except that the completion date
		will be different (if the sessions were completed).

	EXAMPLES:
		* TAYLOR MORRISON OF TEXAS, INC DFW (AccountOrgId 82F931BC-2117-4490-9101-FC1C7F01A5C1)
		* Darling Homes Dallas (AccountOrgId A487053E-272C-4BDB-8F04-4C43DEB6C598)

		EXEC integrations.taylorMorrisonWeeklyReport '82F931BC-2117-4490-9101-FC1C7F01A5C1,A487053E-272C-4BDB-8F04-4C43DEB6C598'
*/
BEGIN
	DECLARE @appointments TABLE
	(
		profile_id UNIQUEIDENTIFIER,
		homebuyer VARCHAR(100) NULL,
		email VARCHAR(100) NULL,
		actual_date DATETIME NULL,
		completion_date DATETIME NULL,
		job_type VARCHAR(10) NULL,
		job_status VARCHAR(15) NULL,
		community VARCHAR(50) NULL,
		[address] VARCHAR(50) NULL,
		lot VARCHAR(10) NULL,
		[block] VARCHAR(10) NULL
	)

	-- Grab the first and last appointment times for homebuyers in these organizations
	INSERT INTO @appointments (profile_id, actual_date, completion_date)
	SELECT
		buyer_profile_id [profile_id],
		MIN(appointment_date) actual_date,
		MAX(appointment_date) completion_date
	FROM
		scheduling_appointments sa WITH (NOLOCK)
		JOIN account_organization_user_profile p WITH (NOLOCK) ON p.profile_id = sa. buyer_profile_id
	WHERE
		sa.account_org_id IN (SELECT [value] FROM STRING_SPLIT(@account_organization_ids, ','))
		AND sa.is_scheduled = 1
	GROUP BY
		buyer_profile_id

	-- Limit homebuyers with appointments that have occurred in the last 30 days, or will occur in the future
	DECLARE @current_date DATETIME = ISNULL(@reference_date, GETDATE())

	DECLARE @cutoff_date DATETIME = DATEADD(DAY, -30, @current_date)

	DELETE @appointments
	WHERE
		(actual_date IS NULL OR actual_date < @cutoff_date) 
		AND (completion_date IS NULL OR completion_date < @cutoff_date)

	-- Fetch user information for each appointment record
	UPDATE @appointments
	SET
		homebuyer = CONCAT(u.first_name, ' ', u.last_name),
		email = u.email
	FROM
		@appointments a
		JOIN account_organization_user_profile p WITH (NOLOCK) ON p.profile_id = a.profile_id
		JOIN VeoSolutionsSecurity_users u WITH (NOLOCK) ON u.[user_id] = p.[user_id]

	-- For homebuyer appointments that will occur in the future, let's grab the address information from the active/contracted/completed plan.
	UPDATE @appointments
	SET 
		job_type = CASE pp.[job_type]
			WHEN 0 THEN 'Homebuyer'
			WHEN 1 THEN 'Spec'
			WHEN 2 THEN 'Model'
			ELSE 'Other'
		END,
		job_status = pp.[status],
		community = pp.community_name,
		[address] = pp.[address],
		lot = pp.lot,
		[block] = pp.[block]
	FROM
		@appointments a
		JOIN account_organization_user_profile p WITH (NOLOCK) ON p.profile_id = a.profile_id
		JOIN account_organization_user_profile_plan pp WITH (NOLOCK) ON pp.account_id = p.account_id AND pp.organization_id = p.organization_id AND pp.[user_id] = p.[user_id]
	WHERE
		(pp.[status] = 'Active' OR pp.[status] = 'Contracted' OR pp.[status] = 'Complete')
		AND (a.actual_date >= @current_date OR a.completion_date >= @current_date)

	-- For homebuyer appointments that are finished, in the last 30 days, let's grab the address information from their completed plan.
	UPDATE @appointments
	SET 
		job_type = CASE pp.[job_type]
			WHEN 0 THEN 'Homebuyer'
			WHEN 1 THEN 'Spec'
			WHEN 2 THEN 'Model'
			ELSE 'Other'
		END,
		job_status = pp.[status],
		community = pp.community_name,
		[address] = pp.[address],
		lot = pp.lot,
		[block] = pp.[block]
	FROM
		@appointments a
		JOIN account_organization_user_profile p WITH (NOLOCK) ON p.profile_id = a.profile_id
		JOIN account_organization_user_profile_plan pp WITH (NOLOCK) ON pp.account_id = p.account_id AND pp.organization_id = p.organization_id AND pp.[user_id] = p.[user_id]
	WHERE
		pp.[status] = 'Complete'
		AND a.actual_date < @current_date
		AND a.completion_date < @current_date

	-- It is possible for appointments completed in the past to still have profile plan's that aren't done, so let's clean that up next.
	UPDATE @appointments
	SET 
		job_type = CASE pp.[job_type]
			WHEN 0 THEN 'Homebuyer'
			WHEN 1 THEN 'Spec'
			WHEN 2 THEN 'Model'
			ELSE 'Other'
		END,
		job_status = pp.[status],
		community = pp.community_name,
		[address] = pp.[address],
		lot = pp.lot,
		[block] = pp.[block]
	FROM
		@appointments a
		JOIN account_organization_user_profile p WITH (NOLOCK) ON p.profile_id = a.profile_id
		JOIN account_organization_user_profile_plan pp WITH (NOLOCK) ON pp.account_id = p.account_id AND pp.organization_id = p.organization_id AND pp.[user_id] = p.[user_id]
	WHERE
		a.job_type IS NULL
		AND (pp.[status] = 'Active' OR pp.[status] = 'Contracted')
		AND a.actual_date < @current_date
		AND a.completion_date < @current_date

	-- Let's grab all Spec Homes that have been completed in the past 30 days, and aren't already captured via appointments
	INSERT INTO @appointments
	SELECT
		pp.[profile_id],
		CONCAT(u.first_name, ' ', u.last_name) homebuyer,
		u.email,
		NULL actual_date,
		cs.completed_date completion_type,
		job_type = CASE pp.[job_type]
			WHEN 0 THEN 'Homebuyer'
			WHEN 1 THEN 'Spec'
			WHEN 2 THEN 'Model'
			ELSE 'Other'
		END,
		job_status = pp.[status],
		community = pp.community_name,
		[address] = pp.[address],
		lot = pp.lot,
		[block] = pp.[block]
	FROM
		VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK)
		JOIN account_organization_user_profile p WITH (NOLOCK) ON p.account_id = ao.account_id AND p.organization_id = ao.organization_id
		JOIN VeoSolutionsSecurity_users u WITH (NOLOCK) ON u.[user_id] = p.[user_id]
		JOIN account_organization_user_profile_plan pp WITH (NOLOCK) ON pp.account_id = p.account_id AND pp.organization_id = p.organization_id AND pp.[user_id] = p.[user_id]
		JOIN account_organization_user_profile_plan_catalog_sessions cs WITH (NOLOCK) ON cs.account_id = pp.account_id AND cs.organization_id = pp.organization_id AND cs.[user_id] = pp.[user_id] AND cs.community_name = pp.community_name AND cs.series = pp.series AND cs.plan_name = pp.plan_name
		LEFT JOIN @appointments a ON a.profile_id = pp.profile_id
	WHERE
		ao.account_org_id IN (SELECT [value] FROM STRING_SPLIT(@account_organization_ids, ','))
		AND pp.job_type = 1 -- spec
		AND pp.[status] = 'Complete'
		AND cs.completed_date >= @cutoff_date
		AND a.profile_id IS NULL

	-- Now we need to update the completion date of each record, where the profile plan is complete, with the completed session date.
	UPDATE @appointments
		SET completion_date = session_completion_dates.max_completion_date
	FROM
		@appointments a
		JOIN 
			(
				SELECT
					p.profile_id,
					MAX(cs.completed_date) max_completion_date
				FROM
					VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK)
					JOIN account_organization_user_profile p WITH (NOLOCK) ON p.account_id = ao.account_id AND p.organization_id = ao.organization_id
					JOIN account_organization_user_profile_plan pp WITH (NOLOCK) ON pp.account_id = p.account_id AND pp.organization_id = p.organization_id AND pp.[user_id] = p.[user_id]
					JOIN account_organization_user_profile_plan_catalog_sessions cs WITH (NOLOCK) ON cs.account_id = pp.account_id AND cs.organization_id = pp.organization_id AND cs.[user_id] = pp.[user_id] AND cs.community_name = pp.community_name AND cs.series = pp.series AND cs.plan_name = pp.plan_name
				WHERE
					ao.account_org_id IN (SELECT [value] FROM STRING_SPLIT(@account_organization_ids, ','))
					AND cs.[status] = 2 --completed
				GROUP BY
					p.profile_id
			) AS session_completion_dates ON session_completion_dates.profile_id = a.profile_id
	WHERE
		a.job_status = 'Complete'

	-- They don't want us to return any entries that don't have an address or lot and block
	DELETE @appointments
	WHERE
		([address] IS NULL OR LEN([address]) = 0)
		AND (lot IS NULL OR lot IN('0',''))
		AND ([block] IS NULL OR LEN([block]) = 0)

	-- Return the results of this report
	SELECT
		community AS [Community],
		IIF([address] IS NULL OR LEN([address]) = 0, CONCAT('Lot: ', CAST(lot AS VARCHAR(10)), ', Block: ', [block]), [address]) AS [Address],
		homebuyer AS [Name],
		actual_date AS [Actual Date],
		completion_date AS [Completion Date],
		job_type AS [Job Type]
	FROM
		@appointments
END
GO
PRINT N'Creating Procedure [dbo].[create_z_table]...';


GO


CREATE  procedure [dbo].[create_z_table]
@table_name varchar(100)
as

--=========================================================================
-- Check if the table exists
--=========================================================================
if not exists	(	select
									so.id
								from
									sysobjects so
								where
									so.name = @table_name )
	begin
		raiserror ('The table does not exist on this database.', 16, 1)
		return
	end

--=========================================================================
-- Get list of columns with types .
--=========================================================================
declare @column_list varchar(7000)
set @column_list = ''

select
	@column_list = @column_list + '	[' + sc.name + '] ' + st.name + case when sc.xtype = 167 then '(' + cast(sc.length as varchar(10)) + ')' when sc.xtype = 106 then '(' + cast(sc.xprec as varchar(10)) + ',' + cast(sc.xscale as varchar(10)) + ')' else '' end + ' NOT NULL,
'
from
	syscolumns sc
join sysobjects so on
	so.id = sc.id
join systypes st on
	sc.xtype = st.xtype
where
	so.name = @table_name
	and so.type = 'u'
order by
	sc.colid

set @column_list = left(@column_list, len(@column_list) - 3)
set @column_list = replace(@column_list, 'timestamp', 'varchar(50)')

--=========================================================================
-- Create z table
--=========================================================================
declare @z_table_sql varchar(8000)
set @z_table_sql = ''

set @z_table_sql = '
create table z_' + @table_name + ' (
	[z_user_name] varchar(50) NOT NULL,
	[z_action] varchar(10) NOT NULL,
	[z_time] datetime NOT NULL,
' + @column_list + ',
	[auto_number] int IDENTITY (1, 1) NOT NULL,
	CONSTRAINT [PK_z_' + @table_name + '] PRIMARY KEY CLUSTERED ([auto_number]))'

print(@z_table_sql)
print '


'
print('GO')
GO
PRINT N'Creating Procedure [dbo].[dev_archiveSessions]...';


GO
CREATE PROCEDURE dev_archiveSessions
@trial_mode int =  1 
as
-- Objective: 
-- 'archive' some sessions my moving them into other tables. 
-- remove dupes so we can create a unique constraint on catalog_selections_areas

-- Questions 
-- Q: should we archive to a different database? YES 
-- Q: what would be required to make sure that they don't try to make further selections or edit archived sessions? 
-- Q: does MVP require that we create an un-archive feature? NO?
-- Q: once we have a unique constraint on the table how would we un-archive one of these? it would fail. 
-- Idea: analyze if dupes (non zero) have selections. keep that one, kill the other 

---- create the archive table if it does not exist 
--if not exists (select * from sysobjects where name='catalog_sessions_archived' and xtype='U')
--    create table catalog_sessions_archived (
--        Name varchar(64) not null
--    )
--go

-- control table 
declare @sessions_to_archive table
(	session_id uniqueidentifier,
	create_date datetime, 
	dupe_type varchar(100),   
	archived bit, 
	deleted bit ) ;

-- get sessions with build ids == 0 
WITH dupes_cte_zero 
(session_id)
AS
( 
	SELECT DISTINCT
		s.session_id 
	FROM
		account_organization_user_profile_plan_catalog_sessions s
		JOIN catalog_selections cs ON cs.session_id = s.session_id
	WHERE
		cs.[source] = 'Prices Landed'
		AND cs.item_type <> 'custom'
		AND cs.build_id = 0)
INSERT @sessions_to_archive
SELECT session_id, '01/01/1900', 'ZERO BUILDS', 0, 0 FROM dupes_cte_zero;

-- get sessions with dupes (non-zero builds) 
WITH dupes_cte_nonzero
(session_id, build_id, counts)
AS
( 
	SELECT 
		session_id , build_id, count(*) 
	FROM catalog_selections_areas
	WHERE build_id > 0 
	GROUP BY session_id, build_id
	HAVING count(*) > 1)
INSERT @sessions_to_archive
SELECT session_id, '01/01/1900', 'NON-ZERO BUILDS', 0, 0 FROM dupes_cte_nonzero

-- get other session info 
UPDATE 
	@sessions_to_archive 
	SET create_date = s.create_date
	FROM @sessions_to_archive a
	INNER JOIN account_organization_user_profile_plan_catalog_sessions s ON s.session_id = a.session_id
	
--todo: other sessions to archive here? date based? 
SELECT 'Sessions with Dupes or 0 Build IDs' 
SELECT * FROM @sessions_to_archive

IF (@trial_mode = 1)
BEGIN 
 PRINT 'Test Run Only - No Sessions Archived' 
 RETURN; 
END 

-- archiving 
BEGIN TRANSACTION 
-- note: as this is the first time we are running this, it's easier to do this 
-- with a select INTO 
-- may want this to be a cursor... 

-- catalog_selections 
SELECT * INTO catalog_selections_archive
	FROM catalog_selections cs 
	WHERE cs.session_id in (select session_id from @sessions_to_archive) 

-- catalog_selections_price_level_boms
SELECT * INTO catalog_selections_price_level_boms_archive
	FROM catalog_selections_price_level_boms b
	WHERE b.session_id in (select session_id from @sessions_to_archive) 

-- catalog_selections_areas
SELECT * INTO catalog_selections_areas_archive
	FROM catalog_selections_areas csa
	WHERE csa.session_id in (select session_id from @sessions_to_archive) 

-- catalog_selections_group_detail 
SELECT * INTO catalog_selections_group_detail_archive
	FROM catalog_selections_group_detail gd
	WHERE gd.session_id in (select session_id from @sessions_to_archive) 

-- catalog_selections_area_details
SELECT * INTO catalog_selections_area_details_archive
	FROM catalog_selections_area_details ad
	WHERE ad.session_id in (select session_id from @sessions_to_archive) 

-- catalog_selections_area_detail_options
SELECT * INTO catalog_selections_area_detail_options_archive
	FROM catalog_selections_area_detail_options do
	WHERE do.session_id in (select session_id from @sessions_to_archive)

-- catalog_selections_area_bom_modifications
SELECT * INTO catalog_selections_area_bom_modifications_archive
	FROM catalog_selections_area_bom_modifications bm
	WHERE bm.session_id in (select session_id from @sessions_to_archive)

-- catalog_selections_error_log 
SELECT * INTO catalog_selections_error_log_archive
	FROM catalog_selections_error_log el
	WHERE el.session_id in (select session_id from @sessions_to_archive)

-- account_organization_user_profile_plan_catalog_sessions_documents 
SELECT * INTO account_organization_user_profile_plan_catalog_sessions_documents_archive
	FROM account_organization_user_profile_plan_catalog_sessions_documents d
	WHERE d.session_id in (select session_id from @sessions_to_archive)

-- catalog_selections_area_properties 
SELECT * INTO catalog_selections_area_properties_archive
	FROM catalog_selections_area_properties p
	WHERE p.session_id in (select session_id from @sessions_to_archive)

-- delete here 

-- catalog_selections_area_slabs 
SELECT * INTO catalog_selections_area_slabs_archive
	FROM catalog_selections_area_slabs s
	WHERE s.session_id in (select session_id from @sessions_to_archive)

-- 	account_organization_user_profile_plan_catalog_sessions
SELECT * INTO
	account_organization_user_profile_plan_catalog_sessions_archive
	FROM 
	account_organization_user_profile_plan_catalog_sessions s
	WHERE 
		s.session_id in (select session_id from @sessions_to_archive) 

-- DELETES
DELETE FROM 
	account_organization_user_profile_plan_catalog_sessions
	WHERE
		session_id in (select session_id from @sessions_to_archive) 


ROLLBACK TRANSACTION 

--BACKGROUND INFO / SQL 
--SELECT DISTINCT
--top 100
--	s.session_id, 
--	s.create_date 
--FROM
--	account_organization_user_profile_plan_catalog_sessions s
--	JOIN catalog_selections cs ON cs.session_id = s.session_id
--WHERE
--	cs.[source] = 'Prices Landed'
--	AND cs.item_type <> 'custom'
--	AND cs.build_id = 0
--ORDER BY 
--	s.create_date desc

-- FIND SESSIONS with DUPES 
-- select top 10 * from catalog_selections_areas

--SELECT 
--	session_id , build_id, count(*) 
--FROM catalog_selections_areas
--WHERE build_id > 0 
--GROUP BY session_id, build_id
--HAVING count(*) > 1

-- look at something specific 
--select * from catalog_selections_areas 
--where session_id = 'D46F1BD2-E6A8-44D2-869A-375497D641E3'
--and build_id = 12250646

--SELECT DISTINCT
--	s.session_id, s.organization_id, pp.[address], ss.[status], s.create_date, s.author
--FROM
--	account_organization_user_profile_plan_catalog_sessions s
--	JOIN session_statuses ss ON ss.status_id = s.[status]
--	JOIN account_organization_user_profile_plan pp ON  pp.account_id = s.account_id AND pp.organization_id = s.organization_id AND pp.[user_id] = s.[user_id] AND pp.community_name = s.community_name AND pp.series = s.series AND pp.plan_name = s.plan_name
--	JOIN catalog_selections cs ON cs.session_id = s.session_id
--WHERE
--	cs.[source] = 'Prices Landed'
--	AND cs.item_type <> 'custom'
--	AND cs.build_id = 0
--ORDER BY
--	s.create_date DESC

--Here's a fun query for finding sessions with records in the catalog_selections_area table that have build_id columns of zero:

--SELECT DISTINCT
--	s.session_id, s.organization_id, pp.[address], ss.[status], s.create_date, s.author
--FROM
--	account_organization_user_profile_plan_catalog_sessions s
--	JOIN session_statuses ss ON ss.status_id = s.[status]
--	JOIN account_organization_user_profile_plan pp ON  pp.account_id = s.account_id AND pp.organization_id = s.organization_id AND pp.[user_id] = s.[user_id] AND pp.community_name = s.community_name AND pp.series = s.series AND pp.plan_name = s.plan_name
--	JOIN catalog_selections_areas csa ON csa.session_id = s.session_id
--WHERE
--	csa.build_id = 0
--ORDER BY
--	s.create_date DESC
GO
PRINT N'Creating Procedure [dbo].[dev_createCalendarTable]...';


GO
CREATE procedure [dbo].[dev_createCalendarTable] 
as

-- from: http://stackoverflow.com/questions/14749877/t-sql-get-number-of-working-days-between-2-dates
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[dbo].[calendar]') AND OBJECTPROPERTY(id, N'IsUserTable') = 1)
drop table calendar

CREATE TABLE dbo.calendar
(
  dt DATE PRIMARY KEY, -- use SMALLDATETIME if < SQL Server 2008
  IsWorkDay BIT
);

DECLARE @s DATE, @e DATE;
SELECT @s = '2010-01-01' , @e = '2029-12-31';

INSERT dbo.Calendar(dt, IsWorkDay)
  SELECT DATEADD(DAY, n-1, '2000-01-01'), 1 
  FROM
  (
    SELECT TOP (DATEDIFF(DAY, @s, @e)+1) ROW_NUMBER() 
      OVER (ORDER BY s1.[object_id])
      FROM sys.all_objects AS s1
      CROSS JOIN sys.all_objects AS s2
  ) AS x(n);

SET DATEFIRST 1;

-- weekends
UPDATE dbo.Calendar SET IsWorkDay = 0 
  WHERE DATEPART(WEEKDAY, dt) IN (6,7);

-- Christmas
UPDATE dbo.Calendar SET IsWorkDay = 0 
  WHERE MONTH(dt) = 12
  AND DAY(dt) = 25
  AND IsWorkDay = 1;

-- continue with other holidays, known company events, etc.
GO
PRINT N'Creating Procedure [dbo].[dev_createZTable]...';


GO


CREATE       procedure [dbo].[dev_createZTable]
@table_name varchar(100)
as

--=========================================================================
-- Check if the table exists
--=========================================================================
if not exists	(	select
									so.id
								from
									sysobjects so
								where
									so.name = @table_name )
	begin
		raiserror ('The table does not exist on this database.', 16, 1)
		return
	end

--=========================================================================
-- Get list of columns with types
--=========================================================================
declare @column_list varchar(7000)
set @column_list = ''

select
	@column_list = @column_list + '	[' + sc.name + '] ' + st.name + case when sc.xtype = 167 then '(' + cast(sc.length as varchar(10)) + ')' when sc.xtype = 106 then '(' + cast(sc.xprec as varchar(10)) + ',' + cast(sc.xscale as varchar(10)) + ')' else '' end + ' NOT NULL,
'
from
	syscolumns sc
join sysobjects so on
	so.id = sc.id
join systypes st on
	sc.xtype = st.xtype
where
	so.name = @table_name
	and so.type = 'u'
order by
	sc.colid

set @column_list = left(@column_list, len(@column_list) - 3)
set @column_list = replace(@column_list, 'timestamp', 'varchar(50)')

--=========================================================================
-- Create z table
--=========================================================================
declare @z_table_sql varchar(8000)
set @z_table_sql = ''

set @z_table_sql = '
create table z_' + @table_name + ' (
	[z_user_name] varchar(50) NOT NULL,
	[z_action] varchar(10) NOT NULL,
	[z_time] datetime NOT NULL,
' + @column_list + ',
	[auto_number] int IDENTITY (1, 1) NOT NULL,
	CONSTRAINT [PK_z_' + @table_name + '] PRIMARY KEY CLUSTERED ([auto_number]))'

print(@z_table_sql)
print '


'
print('GO')
GO
PRINT N'Creating Procedure [dbo].[dev_deactivateSession]...';


GO
CREATE PROCEDURE dev_deactivateSession 
@session_id uniqueidentifier, 
@modifier varchar(50) 
as
-- created by Rob for use in integration testing to deactivate session 
-- after creation 
-- test: 
-- dev_deactivateSession '148d9cee-cd4e-45c4-aab2-da39e05e7aa9', 'dev@eplanpartners.com' 
update 
	account_organization_user_profile_plan_catalog_sessions
set
	status = 0, 
	modifier = @modifier, 
	modified_date = getdate() 
where 
	session_id = @session_id
GO
PRINT N'Creating Procedure [dbo].[dev_deletePostmanUsers]...';


GO
CREATE PROCEDURE [dbo].[dev_deletePostmanUsers] 
@passcode varchar(50) = ''
as

/* SUMMARY 

Deletes all postman-generated users from the system. 

History: 
04.12.16 - modified to create a single user only (temporarily)
03.25.16 - Created - RH 

-- testing  
	dev_deletePostmanUsers 'eplan dev only' 
*/

IF (len(@passcode) = 0 )
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

IF NOT @passcode IN ('eplan dev only') 
BEGIN 
	RAISERROR('Access Denied.',16,1)
	RETURN
END 

-- general order of events: 
-- - select postman users into a memory table 
-- - delete from account_org_users and hope it all cascades 
-- - delete from users (in security) 
-- - sorry orphans! (if we have any then adjust the script or add relationships) 
declare @doomed as table 
(
	[user_id] uniqueidentifier
);

-- GET USERS TO DELETE WITH NO SESSIONS 
INSERT INTO 
	@doomed 
SELECT 
	u.[user_id]
FROM 
	VeoSolutionsSecurity_users u 
WHERE 
	u.email like '%@postmancollection.com' --= 'john.testapi@gmail.com' 
	--AND u.user_id NOT IN (SELECT [user_id] FROM account_organization_user_profile_plan_catalog_sessions s with (nolock) where s.user_id = u.user_id) 
	--AND u.first_name = 'Postman'  
	--AND u.last_name = 'User' 
	
BEGIN TRAN T1

-- DELETE PROFILE (should cascade?) 
DELETE p
FROM account_organization_user_profile p 
INNER JOIN @doomed d on d.user_id = p.user_id 

-- DELETE USER (should cascade?) 
DELETE u 
FROM VeoSolutionsSecurity_users u 
INNER JOIN @doomed d on d.user_id = u.user_id 

-- VERIFY 
select 'Deleted Users:' 
select user_id as 'doomed user' from @doomed 

select 'VeoSol Tables:' 
select * from account_organization_user_profile p with (nolock) 
	JOIN @doomed d on d.user_id = p.user_id 
select * from account_organization_user_profile_plan p with (nolock) 
	JOIN @doomed d on d.user_id = p.user_id 
select * from account_organization_user_profile_plan_documents docs with (nolock) 
	JOIN @doomed d on d.user_id  = docs.user_id 

select 'Security Tables:' 
select * from VEOSolutionsSecurity_users u with (nolock) 
	JOIN @doomed d on d.user_id = u.user_id 

COMMIT TRAN T1
GO
PRINT N'Creating Procedure [dbo].[dev_findDesignerAppointmentsByFirstName]...';


GO
create procedure dev_findDesignerAppointmentsByFirstName 
@name varchar(100),
@date datetime = null 
as

-- dev_findDesignerAppointmentsByFirstName 'Christina', '04/03/13'
-- select top 10 * from scheduling_users
-- select top 10 * from scheduling_appointments
select 
a.*
from scheduling_appointments a 
join scheduling_users su on su.user_id = a.schedule_user_id 
where
su.first_name = @name 
and (a.appointment_date = @date or @date is null)
order by a.appointment_date desc
GO
PRINT N'Creating Procedure [dbo].[dev_importAdminUserToScheduling]...';


GO
CREATE procedure dev_importAdminUserToScheduling 
@user_email varchar(100)
AS

-- Testing 
-- select * from veosolutionssecurity_users 
-- dev_importAdminUserToScheduling 'philm@eplanpartners.com' 
-- dev_importAdminUserToScheduling 'roberth@eplanpartners.com'
-- dev_importAdminUserToScheduling 'shelbyscheduler@mailinator.com'

-- todo: error handling for if @user_email is empty 

declare @user_id uniqueidentifier 
select @user_id = user_id from veosolutionssecurity_users where email = @user_email 

-- todo: raise an error if not found 
print 'Found user: ' + @user_email 
select @user_id as [user_id]

--select * from scheduling_users
--select * from veosolutionssecurity_dev.dbo.users 

PRINT 'Addming user to scheduling...' 

IF NOT EXISTS(select user_id from scheduling_users where user_id = @user_id) 
BEGIN 
	-- select * from scheduling_users 
	INSERT INTO scheduling_users 
	(user_id, scheduling_enabled, first_name, last_name, email, phone, author, create_date, modifier, modified_date) 
	SELECT 
		user_id, 1, first_name, last_name, email, '', 'ADMIN', getdate(), 'ADMIN', getdate() 
	FROM 
		veosolutionssecurity_users 
	WHERE
		user_id = @user_id

	print 'User imported into scheduling_users' 

END 
ELSE
PRINT 'User is already in Scheduling' 

-- select * from scheduling_user_roles
-- select * from veosolutionssecurity_app_roles
declare @admin_role_id uniqueidentifier 
SELECT 
	@admin_role_id = role_id 
FROM 
	veosolutionssecurity_app_roles_legacy
WHERE
	app_id = 'Scheduling' 
	AND [name] = 'System Administrator' 

-- todo: throw an error if admin role not found 
PRINT 'Adding admin role...' 
IF NOT EXISTS(SELECT user_id FROM scheduling_user_roles WHERE user_id = @user_id AND role_id = @admin_role_id) 
BEGIN 

	INSERT INTO scheduling_user_roles 
	(user_id, role_id, author, create_date, modifier, modified_date) 
	SELECT 
		@user_id, @admin_role_id, 'ADMIN', getdate(), 'ADMIN', getdate() 

	PRINT 'User admin role created in scheduling_user_roles' 

END 
ELSE
PRINT 'User is already an Admin' 

print 'Adding scheduling_user_organizations...' 
INSERT INTO 
	scheduling_user_organizations 
(user_id, account_org_id, author, create_date, modifier, modified_date) 
SELECT 
	@user_id, o.account_org_id, 'ADMIN',  getdate(), 'ADMIN', getdate()
FROM 
	scheduling_organizations o 

-- select * from scheduling_status
-- select * from scheduling_organizations 
--select * from scheduling_user_organizations where user_id = 'EEAD18BA-EDE2-4162-B503-A99A79C4CA93'
GO
PRINT N'Creating Procedure [dbo].[dev_importSchedulingRoles]...';


GO
CREATE procedure  dev_importSchedulingRoles

as

-- select * from scheduling_roles 
-- select * from veosolutionssecurity_roles 
-- select * from veosolutionssecurity_app_roles

-- APP ROLES 
insert into 
	veosolutionssecurity_app_roles_legacy
	(app_id, role_id, name, description, author, create_date, modifier, modified_date) 
select 
	'Scheduling', 
	role_id , 
	name, 
	'',
	'sa', 
	getdate(), 
	'sa', 
	getdate() 
from 
	veosolutionssecurity_roles_legacy
where 
	name in ('Designer','System Administrator','Scheduler','Builder Sales Counselor', 'Design Center Manager') 
	and role_id not in (select role_id from veosolutionssecurity_app_roles_legacy)



-- SCHEDULING ROLES 
insert into 
	scheduling_roles
	(role_id, author, create_date, modifier, modified_date) 
select 
	role_id , 
	'sa', 
	getdate(), 
	'sa', 
	getdate() 
from 
	veosolutionssecurity_roles_legacy
where 
	name in ('Designer','System Administrator','Scheduler','Builder Sales Counselor', 'Design Center Manager') 
	and role_id not in (select role_id from scheduling_roles) 



select 
	sr.role_id, 
	r. name
	from 
	scheduling_roles sr 
	left join veosolutionssecurity_roles_legacy r on r.role_id = sr.role_id
GO
PRINT N'Creating Procedure [dbo].[dev_ImportSupportLinks]...';


GO
create procedure [dbo].[dev_ImportSupportLinks]

as


insert into 
support_links 
(row_id, link_id, account_org, role_id, url, url_label)
select 
row_id, 
link_id, 
account_org, 
role_id, 
url, 
url_label 
from 
support_links
GO
PRINT N'Creating Procedure [dbo].[dev_importVEOImage]...';


GO
CREATE PROCEDURE [dbo].[dev_importVEOImage] (
     @ImageFolderPath NVARCHAR (1000)
   , @Filename NVARCHAR (1000)
   )
AS
BEGIN
-- select top 1 * from veo_photos 

   DECLARE @Path2OutFile NVARCHAR (2000);
   DECLARE @tsql NVARCHAR (2000);
   SET NOCOUNT ON
   SET @Path2OutFile = CONCAT (
         @ImageFolderPath
         ,'\'
         , @Filename
         );
   SET @tsql = 'DECLARE @img varbinary(max) 
				SET @img =  (SELECT * FROM Openrowset( Bulk ' + '''' + @Path2OutFile + '''' + ', Single_Blob) as img)'
				+ ' insert into veo_photos 
				(photo_data, enlarged_photo_data, thumbnail_photo_data) ' +
               ' VALUES(@img, @img, @img)'
			   + ' select scope_identity() as photo_id' 

   EXEC (@tsql)



   SET NOCOUNT OFF
END
GO
PRINT N'Creating Procedure [dbo].[dev_insConvertedSession]...';


GO
CREATE PROCEDURE [dbo].[dev_insConvertedSession] 
@session_id uniqueidentifier, 
@bom_count int, 
@missing_count int
AS

--testing 
-- dev_insConvertedSession 'f3c8c2c0-8083-4b7d-8b27-17af932fdb5b', 1, 1

declare @session_create_date datetime 
SELECT 
	@session_create_date = create_date 
FROM 
	account_organization_user_profile_plan_catalog_sessions WITH(NOLOCK)
WHERE
	session_id = @session_id 

INSERT INTO 
sessions_converted 
(session_id, bom_count, missing_count, convert_date, session_create_date)
VALUES
(@session_id, @bom_count, @missing_count, GETDATE(), @session_create_date)
GO
PRINT N'Creating Procedure [dbo].[dev_moveSchedulingAppointments]...';


GO
CREATE procedure  [dbo].[dev_moveSchedulingAppointments]
@source_date datetime, 
@target_date datetime
as

-- Summary 
-- Attempts to shift all appointments on a given day to another day. 
--
-- Checks to see if appointments already exist on the target day, and optionally errors out if so. 
-- Updates the 
--
-- TESTING: 
-- select top 100 * from scheduling_appointments order by create_date desc
-- dev_moveSchedulingAppointments '03/19/15', '03/20/15' 
--
--...simple check to prevent running in production...
if (@@servername like '%colo%') 
begin 

	RAISERROR('You cannot run this procedure in production.',16,1)
	RETURN

end 

-- ...check if appointments already exist...
IF exists(select appointment_id from scheduling_appointments where appointment_date = @target_date) 
BEGIN

	RAISERROR('The target date already has appointments.',16,1)
	RETURN

END

-- ...copy appointments by updating schedule date... 
print 'moving appointments...' 

UPDATE 
	scheduling_appointments 
SET
	appointment_date = @target_date 
WHERE
	appointment_date = @source_date
GO
PRINT N'Creating Procedure [dbo].[dev_resetSchedulingDataForTesting]...';


GO
CREATE procedure dev_resetSchedulingDataForTesting 
@password varchar(100) = ''  
as 

if (@password = 'dev08222013') 
begin 

-- dev_resetSchedulingDataForTesting 'dev08222013'

delete from scheduling_messages 

delete from scheduling_appointments 

update scheduling_buyers set is_active = 1, received_date = null 

return; 

end 

print 'data not reset'
GO
PRINT N'Creating Procedure [dbo].[dev_seedPlanDocuments]...';


GO
CREATE PROCEDURE dev_seedPlanDocuments 
AS
declare @report_id UNIQUEIDENTIFIER 
declare @session_id UNIQUEIDENTIFIER 
declare @profile_plan_id UNIQUEIDENTIFIER 

-- find a session with a report_id 
SELECT TOP 1 
	@session_id = s.session_id, 
	@report_id = s.report_id,
	@profile_plan_id = pp.profile_id
FROM 
	 account_organization_user_profile_plan_catalog_sessions s
	 JOIN account_organization_user_profile_plan pp ON 
		pp.account_id = s.account_id AND pp.organization_id = s.organization_id 
		AND pp.user_id = s.user_id and pp.community_name = s.community_name 
		AND pp.series = s.series AND pp.plan_name = s.plan_name 
WHERE
	s.report_id IS NOT NULL 
	 

--select top 10 * from account_organization_user_profile_plan
--select * from account_organization_user_profile_plan_catalog_sessions where report_id IS NOT NULL 
-- select * from plan_documents 
INSERT INTO 
	plan_documents 
(id, profile_plan_id, doc_type, mime_type, session_id, doc_data, author, create_date, modifier, modified_date) 
VALUES
(@report_id, @profile_plan_id, 'SESSION_SELECTIONS', 'application/pdf', @session_id, 0x, 'dev', getdate(), 'dev', getdate())
GO
PRINT N'Creating Procedure [dbo].[dev_selProcInfo]...';


GO
create procedure dev_selProcInfo 
@proc_name varchar(100)
as
--  'dev_createSchedulingBuyersActivityTable'
SELECT name, create_date, modify_date 
FROM sys.objects
WHERE type = 'P' and name = @proc_name
GO
PRINT N'Creating Procedure [dbo].[dev_selSchedulingAvailableAppointmentDates]...';


GO
CREATE procedure [dbo].[dev_selSchedulingAvailableAppointmentDates]
@appointment_id uniqueidentifier, 
@start_date datetime = null, 
@end_date datetime = null 
as


-- design: 
-- return a list of dates where there is at least 1 open block of time for a designer who can service that appt. 
-- when checking dates, stop processing after at least 1 time block has been found. 
-- need a function that returns a table of open blocks for a designer and a day 
-- 


-- algorithm 1 
-- for each date, check a designers schedule and determine if there is a free block of time that can accomodate the appt. 
-- determining blocks: order the scheduled appts sequentially. 
-- calculate the time difference between them ( end time - previous appointment start time) 
-- if no appointments then obviously it is a hit and we are done with that day 
-- 

-- TESTING 
-- select * from scheduling_appointments where appointment_id = 'C0D3F502-1E6A-420A-B014-026613C49AA4'
-- select top 10 * from scheduling_appointments with (nolock) where is_scheduled = 0  and create_date >= '07/10/13'
-- dev_selSchedulingAvailableAppointmentDates '5CEF80D9-C91C-4021-9884-470630384DC9', null, null 

if @start_date is null 
	set @start_date = DATEADD(dd, DATEDIFF(dd, 0, getdate()), 0)

declare @dc_open time(7) 
set @dc_open = '9:00:00'

declare @dc_close time(7) 
set @dc_close = '19:00:00' 

-- by default set @start_date 3 weeks 
declare @days int 
set @days = 30
set @end_date = dateadd(dd, @days, @start_date) 

-- fetch duration for this appointment 
declare @duration int 
declare @account_org_id uniqueidentifier 

select @duration = appointment_duration, @account_org_id = account_org_id from scheduling_appointments where appointment_id = @appointment_id 
--print @duration 
-- DESIGNERS WHO CAN SERVICE THIS APPOINTMENT 
declare @designers table 
(
designer_id uniqueidentifier, 
name varchar(100) 
) 

-- DESIGNER WORK DAYS AND LOCATIONS 
-- select * from scheduling_user_work_schedules where user_id = '0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B' 
declare @work_days table 
(
 designer_id uniqueidentifier, 
 dow int, 
 location_id uniqueidentifier, 
 start_time time, 
 end_time time 
) 


-- A LIST OF DATES FOR THE RANGE 
 declare @dates as table 
 ( 
	d datetime 
) 

-- THE CURRENT SCHEDULE (BUSY) 
 declare @schedule as table 
 (
	appointment_date datetime, 
	schedule_user_id uniqueidentifier,
	start_time time, 
	end_time time,
	name varchar(100), 
	is_busy bit, 
	location_id uniqueidentifier, 
	location_name varchar(100) 
 ) 

  declare @open as table 
 (
	appointment_date datetime, 
	schedule_user_id uniqueidentifier,
	start_time time, 
	end_time time, 
	name varchar(100), 
	is_busy bit, 
	location_id uniqueidentifier, 
	location_name varchar(100) 
 ) 

 
 -- FETCH DATES 
;with a as 
 ( -- find all days between start and end date
 select @start_date d
 union all 
 select dateadd(day, 1, d) 
 from a 
 where d < @end_date -- and d in (select dt from calendar where isworkday = 1) 
 )
 
 
 insert into @dates 
 select d from a 
 join calendar c on c.dt = a.d
 where c.isworkday = 1
 option (maxrecursion 0) 


-- FETCH DESIGNERS 
insert into @designers
select
	su.user_id , 
	u.first_name + ' ' + u.last_name 
from 
	scheduling_users su 
	join scheduling_user_organizations suo on suo.user_id = su.user_id 
    join scheduling_user_roles r on r.user_id = su.user_id 
	join veosolutionssecurity_users u on u.user_id = su.user_id 
	join veosolutionssecurity_roles_legacy sr on sr.role_id = r.role_id 
where
	suo.account_org_id = @account_org_id 
	and 
	sr.name = 'Designer'

-- FETCH DESIGNER WORK SCHEDULES
-- select * from scheduling_user_work_schedules where user_id = '0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B'
insert into @work_days 
select 
	[user_id], 
	[day], 
	location_id, 
	start_time, 
	end_time
from 
	scheduling_user_work_schedules w 
	join @designers d on d.designer_id = w.user_id 

-- testing 
--select * from @work_days where designer_id = '0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B'

-- FETCH SCHEDULE 
;with b  as 
 ( select 
		sa.appointment_date, 
		sa.schedule_user_id, 
		sa.start_time, 
		sa.end_time, d.name, 
		1 as is_busy, 
		sa.location_id, 
		l.name as location_name 
	from @dates dates, scheduling_appointments sa 
		join @designers d on d.designer_id = sa.schedule_user_id
		join VEOSolutionsSecurity_locations l on l.location_id = sa.location_id
	where 
		sa.is_scheduled = 1 and appointment_date = dates.d
 )

 insert into @schedule 
 select 
	appointment_date, schedule_user_id, start_time, end_time, name, is_busy, location_id, location_name 
 FROM 
( select * from b ) t2
	order by appointment_date, schedule_user_id, start_time asc 


 --select * from @dates 
 --select * from @designers 
 --select * from @schedule 
 -- select * from @work_days 

 -- for each distinct date/designer, calculate time gaps as follows: 
 -- open to 1st 
 -- between each appointment 
 -- last to close 
 -- create a record in the open table for each gap 

 declare D_CURSOR cursor
 for 
	select distinct 
		d.d , 
		d2.designer_id, 
		d2.name 
	from @dates d, @designers d2 
	
 OPEN D_CURSOR 

 declare @date datetime, @designer_id uniqueidentifier, @name varchar(100) 

 fetch next from D_CURSOR into @date, @designer_id , @name 
 while (@@fetch_status = 0) 
 begin 

	-- fetch day of the week for this date 
	declare @dow int 
	set @dow = datepart(dw, @date)  - 1 -- my table dow are 1-5 for M-F 

	-- fetch start/end time for this designer for that dow 
	-- select * from veosolutionssecurity_locations
	declare @designer_start_time time, @designer_end_time time, @location_id uniqueidentifier, @location_name varchar(100) 
	set @designer_start_time = null; 
	set @designer_end_time = null; 

	select
		@designer_start_time = d.start_time, 
		@designer_end_time = d.end_time, 
		@location_id = d.location_id, 
		@location_name = l.name  
	from 
		@work_days d join veosolutionssecurity_locations l on l.location_id = d.location_id 
		where 
			d.designer_id = @designer_id 
			and dow= @dow  

	
	-- DEBUGGING DOW PROBLEM....
	--if (@designer_id = '0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B' and @date = '2013-07-23 00:00:00.000') 
	--begin 
	--	print 'DOW:'
	--	print @dow 
	--	print @designer_start_time
	--	print @designer_end_time 
	--end 

	-- no appointments case 
	if not exists(select top 1 appointment_date from @schedule where appointment_date = @date and schedule_user_id = @designer_id) 
	begin 

		-- if no appointments, but the designer has a work scehdule for this DOW, then 
		-- then insert he entire work day block, if large enough for current appointment.
		if (@designer_start_time is not null) 
		begin 

			declare @work_day_minutes int   
		
			set @work_day_minutes = datediff(minute, @designer_start_time, @designer_end_time) 
		
			--print @work_day_minutes
		
			if (@work_day_minutes >= @duration) 
			begin 
				insert into @open 
				select @date, @designer_id, @designer_start_time, @designer_end_time, @name, 0, @location_id, @location_name 
			end 
		end 


	end 
	else 
	begin 
		-- CURSOR FOR PARSING DESIGNER SCHEDULE. ONLY RUNS IF THE DESIGNER HAS APPOINTMENTS ON THE DAY 
		declare S_CURSOR cursor 
		FOR 
			select  
				appointment_date, schedule_user_id, start_time, end_time, name
			from 
				@schedule 
			where 
				appointment_date = @date and schedule_user_id = @designer_id
			order by start_time asc 

		 OPEN S_CURSOR 

		 declare @s_date datetime, @s_designer_id uniqueidentifier, @s_name varchar(100), @s_start_time time, @s_end_time time
		 declare @s_last_end_time time 
		 set @s_last_end_time = null 

		 fetch next from S_CURSOR into @s_date, @s_designer_id, @s_start_time, @s_end_time,  @s_name
		 while (@@fetch_status = 0) 
		 begin 
			
			declare @time_gap_minutes int 
			
			if (@s_last_end_time is null) 
			begin -- to start things off, set last end time = to the start of the work day for the designer 
				set @s_last_end_time = @designer_start_time
			end 
			
			set @time_gap_minutes = datediff(minute, @s_last_end_time, @s_start_time) 
			
			print 'open, between appts:' 
			print '@time_gap_minutes:' 
			print @time_gap_minutes 
			print '@duration:' 
			print @duration

			-- INSERT OPEN RECORD 
			if (@time_gap_minutes > 0 and @time_gap_minutes >= @duration) 
			begin 
				insert into 
					@open 
				select 
					@date, 
					@designer_id, 
					@s_last_end_time, 
					@s_start_time, 
					@name, 
					0, 
					@location_id, 
					@location_name 

				-- DEBUGGING 
				-- print @date  
			end 
			
			-- store last end time = to the end of this appointment 
			set @s_last_end_time = @s_end_time 

			fetch next from S_CURSOR into @s_date, @s_designer_id, @s_start_time, @s_end_time,  @s_name

			-- DO WE HAVE AN APPT AFTER THIS ONE? IF NOT, WRITE END TIME-> END OF WORK DAY FOR DESIGNER 
		    if (@@fetch_status <> 0) 
			begin 

				set @time_gap_minutes = datediff(minute, @s_last_end_time, @designer_end_time) 

				-- INSERT OPEN RECORD 
				print 'last->end of day gap'
				print '@time_gap_minutes'
				print @time_gap_minutes 
				print '@duration:' 
				print @duration

				if (@time_gap_minutes > 0 and @time_gap_minutes >= @duration) 
				begin 
					insert into 
						@open 
					select 
						@date, 
						@designer_id, 
						@s_last_end_time, 
						@designer_end_time, 
						@name, 
						0, 
						@location_id, 
						@location_name 


					print 'INSERTING LAST APPT'
				end 

			end 

		 end 

		 
		close S_CURSOR 
		deallocate S_CURSOR 


	end 

	-- dev_selSchedulingAvailableAppointmentDates '834c94e2-569a-426f-9710-9730fe5b744f', null, null 

fetch next from D_CURSOR into @date, @designer_id , @name 
end 

close D_CURSOR 
deallocate D_CURSOR 

select * from @open 
union 
select * from @schedule 

-- TESTING NOTES 
-- scenarios: 
-- test normal gaps 
-- test insufficient gaps for current appt 
-- test not working days for the designer 
GO
PRINT N'Creating Procedure [dbo].[dev_selSessionIndexStats]...';


GO
CREATE procedure [dbo].[dev_selSessionIndexStats]
as
	SELECT 
	OBJECT_NAME(i.OBJECT_ID) as table_name, 
	ind.name AS index_name,
	i.index_type_desc,
	convert(varchar,convert(decimal(8,2), i.avg_fragmentation_in_percent )) + '%' as fragmentation
	FROM sys.dm_db_index_physical_stats
	(DB_ID(N'VEOSolutions'), NULL, NULL, NULL , 'LIMITED') i
	INNER JOIN sys.indexes ind  
	ON ind.object_id = i.object_id AND ind.index_id = i.index_id 
	WHERE 
		OBJECT_NAME(i.OBJECT_ID) 
		in ('catalog_selections', 'catalog_selections_areas', 'catalog_selections_area_details', 'catalog_selections_bom_details',  'catalog_selections_bom_detail_options', 'catalog_selections_group_detail') 
	ORDER BY 
		OBJECT_NAME(i.OBJECT_ID) ASC
GO
PRINT N'Creating Procedure [dbo].[dev_selSessionStorageInfo]...';


GO
CREATE procedure [dbo].[dev_selSessionStorageInfo] 
@session_id uniqueidentifier 
as
-- DEV PROC 
-- Returns information about the session in the database 
-- Feel free to expand - have fun! 
-- dev_selSessionStorageInfo '8930C252-67CE-4968-8082-2A3755DC4FD2'

select 'catalog_selections' as table_name, count(session_id) as row_count from catalog_selections where session_id = @session_id
union
select 'catalog_selections_areas' as table_name, count(session_id) as row_count from catalog_selections_areas where session_id = @session_id
union
select 'catalog_selections_area_details' as table_name, count(session_id) as row_count from catalog_selections_area_details where session_id = @session_id 
union 
select 'catalog_selections_group_detail' as table_name, count(session_id) as row_count from catalog_selections_group_detail where session_id = @session_id
GO
PRINT N'Creating Procedure [dbo].[dev_selSessionTableRowCounts]...';


GO
CREATE procedure [dbo].[dev_selSessionTableRowCounts] 
as
-- DEV PROC 
-- Returns information about the session related tables 
-- dev_selSessionTableRowCounts 
select 'catalog_selections' as table_name, count(session_id) as row_count 
	from catalog_selections 
union
select 'catalog_selections_areas' as table_name, count(session_id) as row_count 
	from catalog_selections_areas 
union
select 'catalog_selections_group_detail' as table_name, count(session_id) as row_count 
	from catalog_selections_group_detail 
union
select 'catalog_selections_area_details' as table_name, count(session_id) as row_count 
	from catalog_selections_area_details
GO
PRINT N'Creating Procedure [dbo].[dev_setupErrors]...';


GO
create PROCEDURE [dbo].[dev_setupErrors] 
AS

-- SCHEDULING MESSAGES 50100-50300
--  0 VALID 
-- -1 appointment changed since update (timestamp) 
-- -10 eclipse 
-- -20 end overlap 
-- -30 start overlap
-- -100 designer schedule is invalid now 
-- -110 designer no longer active 
-- -120 designer no longer has account org 
 
EXEC master.dbo.sp_addmessage @msgnum =50101,@severity =10,@msgtext ='Appointment changed by another user.'

EXEC master.dbo.sp_addmessage @msgnum =50110,@severity =10,@msgtext ='Appointment would eclipse another.'

EXEC master.dbo.sp_addmessage @msgnum =50120,@severity =10,@msgtext ='Appointment end overlaps another'

EXEC master.dbo.sp_addmessage @msgnum =50130,@severity =10,@msgtext ='Appointment start overlaps another'

EXEC master.dbo.sp_addmessage @msgnum =50200,@severity =10,@msgtext ='The appointment cannot be scheduled because it falls outside the designer''s work times'

EXEC master.dbo.sp_addmessage @msgnum =50210,@severity =10,@msgtext ='Designer is not active'

EXEC master.dbo.sp_addmessage @msgnum =50220,@severity =10,@msgtext ='Designer is not associated with the Organization'
GO
PRINT N'Creating Procedure [dbo].[dev_setupSelectedBuilderTest]...';


GO
CREATE procedure [dbo].[dev_setupSelectedBuilderTest] 
@operator_id uniqueidentifier, 
@delete bit = 0, 
@account_org_id uniqueidentifier = null 

as 

-- NO FILTER 
-- vs_selSchedulingAppointments 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', '07/01/13', '08/05/13', null
-- DELETE FILTER 
-- dev_setupSelectedBuilderTest 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', 1
-- SETUP FILTER - contempo 
-- dev_setupSelectedBuilderTest 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', 0, 'CC2A0C00-FD76-408C-AFCB-3C5134671848'
-- SETUP FILTER - MHI-HOUSTON
-- dev_setupSelectedBuilderTest 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', 0, '2F3B34D1-80BD-41D8-8CC6-B662A186F7AE'

if (@delete = 1 ) 
begin 

	if exists ( select pref_value from scheduling_user_preferences where user_id = @operator_id and pref_key = 'selected_account_org' ) 
	begin 
		delete from scheduling_user_preferences where user_id = @operator_id and pref_key = 'selected_account_org' 
	end 

	print 'selected_account_org cleared' 

	return; 
end 

-- select * from scheduling_user_preferences
if exists ( select pref_value from scheduling_user_preferences where user_id = @operator_id and pref_key = 'selected_account_org' ) 
begin
	update 
		scheduling_user_preferences 
		set 
			pref_value = @account_org_id, 
			modified_date = getdate(), 
			modifier = 'sql test' 
		where 
			user_id = @operator_id and pref_key = 'selected_account_org'

			return; 
end 

insert into
		scheduling_user_preferences 
		(user_id, pref_key, pref_value, author,create_date, modifier, modified_date) 
		values
		(@operator_id, 'selected_account_org', @account_org_id, 'sql test', GETDATE(), 'sql test', GETDATE())
GO
PRINT N'Creating Procedure [dbo].[dev_updateBuyersComplete]...';


GO

CREATE procedure [dbo].[dev_updateBuyersComplete]
@account_org_id uniqueidentifier, 
@list_only bit = 1
as

-- select * from scheduling_buyers
-- select top 100 * from account_organization_user_profile_plan
-- select * from account_organization_user_profile_plan_catalog_sessions where user_id = 'E0C5C9C9-1659-4593-B326-AA4E04DD25A6'
-- select * from veosolutionssecurity_organizations

-- select * from account_organization_user_profile_plan where prof 
-- select * from veosolutionssecurity_account_organizations where organization_id = '722D7706-6E08-4993-B94A-45B71F5375DF'


-- find all buyers that have at least 1 session and are not complete in profile plan 

-- DEV - CONTEMPO 
-- dev_updateBuyersComplete 'CC2A0C00-FD76-408C-AFCB-3C5134671848'
-- SB - CONTEMPO 
-- dev_updateBuyersComplete '3BC8B01F-7CCD-44D6-B318-E5864BEC1EEF'
-- PRODUCTION - MHI 
-- dev_updateBuyersComplete '94487499-9E53-4860-82CD-F9CA4A946D8D'

-- PRODUCTION - TOLL '1D457390-D5E1-435A-A5DE-702EA1451D54'
-- dev_updateBuyersComplete '1D457390-D5E1-435A-A5DE-702EA1451D54'

declare @profiles as table 
(profile_id uniqueidentifier, buyer varchar(100), contract_date datetime, session_id uniqueidentifier, status int) 

-- fetch distinct list of all Contracted profiles with at least 1 COMPLETE selection session 
insert into 
@profiles 
select 
pp.profile_id,
sb.buyer_name, 
pp.contract_date,
s.session_id, 
s.status
from 
scheduling_buyers sb 
join account_organization_user_profile_plan pp on pp.profile_id = sb.profile_id 
join veosolutionssecurity_account_organizations o on o.account_id = pp.account_id and o.organization_id = pp.organization_id 
join account_organization_user_profile_plan_catalog_sessions s on s.account_id = pp.account_id and 
					s.organization_id = pp.organization_id and s.user_Id = pp.user_id and s.community_name = pp.community_name 
					and s.series = pp.series and s.plan_name = pp.plan_name 
where 
o.account_org_id = @account_org_id 
and pp.status = 'Contracted'

--select
--*
--from @profiles p
--where 
--p.status = 2 
--and p.profile_id not in (select profile_id from @profiles where status <> 2) 

select * from @profiles


declare @profiles_to_modify as table
(profile_id uniqueidentifier, buyer varchar(100), session_id uniqueidentifier, status int) 

insert into 
@profiles_to_modify 
select 
p.profile_id, 
p.buyer, 
p.session_id, 
p.status
from @profiles p
where 
p.status = 2 
and p.profile_id not in (select profile_id from @profiles where status <> 2) 

select * from @profiles_to_modify

-- select distinct status from account_organization_user_profile_plan
-- select * from account_organization_user_profile_plan
if @list_only = 0
begin 

begin transaction 

	update 
	account_organization_user_profile_plan
	set 
	status = 'Complete', 
	modifier = 'scheduling_update', 
	modified_date = getdate() 
	where 
	status = 'Contracted' 
	and profile_id in (select profile_id from @profiles_to_modify) 


commit transaction 

end 
else
begin 

print 'no records modified - list only' 

end 

-- select * from account_organization_user_profile_plan where modifier='scheduling_update'
GO
PRINT N'Creating Procedure [dbo].[dev_updateCatalogForGPC]...';


GO


CREATE procedure dev_updateCatalogForGPC
as
-- a proc that mass-update the catalog to create a gpc linkage where a match can be found on vendor/model

-- select * from catalog_items where len(model) > 0 
-- select * from catalog_items where len(vendor) > 0  and len(model) > 0 and len(gpc) = 0 

update 
	catalog_items 
	set gpc = (select gpc_id from [$(gpc)].dbo.products where vendor = c.vendor and model = c.model ) 
from 
	catalog_items c
where 
	c.gpc = '' 


--select top 100 * from catalog_selections 
GO
PRINT N'Creating Procedure [dbo].[dev_updateSchedulingBuyerProfile]...';


GO
CREATE procedure [dbo].[dev_updateSchedulingBuyerProfile]
@old_profile_id uniqueidentifier, 
@new_profile_id uniqueidentifier 
as

-- first make sure new identifier is not in table 
if exists(	 select profile_id from scheduling_buyers where profile_id = @new_profile_id) 
begin 
	raiserror ('NEW PROFILE ALREADY EXISTS IN BUYERS', 16, 1)
	return 
end 

begin transaction 

-- scheduling_buyers 
update scheduling_buyers set profile_id = @new_profile_id where profile_id = @old_profile_id 
update z_scheduling_buyers set profile_id = @new_profile_id where profile_id = @old_profile_id 

-- select top 10 * from scheduling_appointments 
update scheduling_appointments set buyer_profile_id = @new_profile_id where buyer_profile_id = @old_profile_id 
update z_scheduling_appointments set buyer_profile_id = @new_profile_id where buyer_profile_id = @old_profile_id 

-- select top 10 * from scheduling_messages
update scheduling_messages set buyer_profile_id = @new_profile_id where buyer_profile_id = @old_profile_id 
update z_scheduling_messages set buyer_profile_id = @new_profile_id where buyer_profile_id = @old_profile_id 


commit transaction
GO
PRINT N'Creating Procedure [dbo].[dev_updSessionAllocQtyByCustomer]...';


GO
CREATE PROCEDURE [dbo].[dev_updSessionAllocQtyByCustomer]
	@customer_id varchar(50)
	, @start_date date = null
	, @number_of_days int = null
	, @product varchar(10)
	, @debug bit = 0
AS
/*
	Author: Roger Wang
	Date: 8/16/2022
	Description: Updates alloc_qty session snapshot and selections
*/

declare @operation varchar(20) = 'alloc_qty'
	, @run_date datetime = GETDATE()

if ISNULL(@number_of_days, 0) = 0
begin
	set @number_of_days = 365
end

if @start_date is null
begin
	select @start_date = DATEADD(DAY, -@number_of_days, GETDATE())
end

declare @account_id uniqueidentifier
, @organization_id uniqueidentifier

select
	@organization_id = organization_id
from
	VeoSolutionsSecurity_organizations
where
	external_organization_id = @customer_id

declare a cursor for
select
	account_id
from
	VeoSolutionsSecurity_account_organizations
where
	organization_id = @organization_id

open a
fetch next from a into @account_id
while @@fetch_status = 0
begin
	-- Fetch snapshots for all eligible sessions
	drop table if exists #catalog_selections_bom_data

	select
		@operation as operation, [session_id], [catalog_selections_row_id], [serialized_bom_data], [author], [create_date], [modifier], [modified_date]
		, CAST(DECOMPRESS(b.serialized_bom_data) as varchar(MAX)) as decompressed_serialized_bom_data
		, CAST(null as varchar(max)) as modified_serialized_bom_data
	into
		#catalog_selections_bom_data
	from (
		select
			b.*
		from
			account_organization_user_profile_plan_catalog_sessions s
			inner join catalog_selections cs on cs.session_id = s.session_id
			inner join catalog_selections_price_level_boms b on b.session_id = cs.session_id and b.catalog_selections_row_id = cs.row_id
		where
			s.account_id = @account_id
			and s.organization_id = @organization_id
			and s.create_date >= @start_date
			and s.export_date = '1/1/1900'
			and cs.product = @product
	) b

	-- Fetch BOM lines for eligible sessions
	drop table if exists #catalog_selections_area_details

	select
		@operation as operation, [session_id], [application], [product], [area], [sub_area], [item_type], [item_id], [selectable], [bom_real_item_id], [real_item_id], [bom_bill_qty], [bill_qty], [alloc_qty], [credit_qty], [bom_uom_id], [uom_id], [builder_price], [homeowner_price], [pattern_id], [is_pattern_item], [pattern_percentage], [force_reprice], [price_type], [price_source], [retail_percentage], [retail_percentage_type], [accent_prompt], [priced], [bom_item_id], [author], [create_date], [modifier], [modified_date]
	into
		#catalog_selections_area_details
	from
		catalog_selections_area_details
	where
		session_id in (select distinct session_id from #catalog_selections_bom_data)
		and product = @product
		and item_type = 'material'
		and item_id = 'Field'

	-- Loop through session list to perform updates
	declare @session_id UNIQUEIDENTIFIER
		, @catalog_selections_row_id UNIQUEIDENTIFIER
		, @decompressed_serialized_bom_data VARCHAR(MAX)

	declare s cursor for
	select
		distinct [session_id]
	from
		#catalog_selections_bom_data

	open s
	fetch next from s into @session_id
	while @@FETCH_STATUS = 0
	begin
		-- Loop through snapshots and perform update
		declare upd cursor for
		select
			[catalog_selections_row_id], decompressed_serialized_bom_data
		from
			#catalog_selections_bom_data
		where
			session_id = @session_id

		open upd
		fetch next from upd into @catalog_selections_row_id, @decompressed_serialized_bom_data
		while @@FETCH_STATUS = 0
		begin
			-- Decompress snapshot and insert into a temp table
			drop table if exists #catalog_selections_row_bom_data

			SELECT *
			into
				#catalog_selections_row_bom_data
			FROM
				OPENJSON(@decompressed_serialized_bom_data)
			WITH (
				[ID] UNIQUEIDENTIFIER '$.ID',
				[CatalogSelectionID] UNIQUEIDENTIFIER '$.CatalogSelectionID',
				[LineNo] INT '$.LineNo',
				[PricingSource] VARCHAR(100) '$.PricingSource',
				[Options] VARCHAR(MAX) '$.Options',
				[SessionID] UNIQUEIDENTIFIER '$.SessionID',
				[PriceType] VARCHAR(100) '$.PriceType',
				[ItemType] VARCHAR(100) '$.ItemType',
				[ItemID] VARCHAR(100) '$.ItemID',
				[ItemClass] VARCHAR(100) '$.ItemClass',
				[ItemDescription] VARCHAR(1000) '$.ItemDescription',
				[Selectable] BIT '$.Selectable',
				[RealItemID] VARCHAR(100) '$.RealItemID',
				[RealItemDescription] VARCHAR(1000) '$.RealItemDescription',
				[BillQty] DECIMAL(18, 4) '$.BillQty',
				[AllocQty] DECIMAL(18, 4) '$.AllocQty',
				[CreditQty] DECIMAL(18, 4) '$.CreditQty',
				[UOM] VARCHAR(100) '$.UOM',
				[BuilderPrice] DECIMAL(18, 2) '$.BuilderPrice',
				[HomeownerPrice] DECIMAL(18, 2) '$.HomeownerPrice',
				[ForceReprice] BIT '$.ForceReprice',
				[RetailPercentage] DECIMAL(18, 4) '$.RetailPercentage',
				[RetailPercentageType] VARCHAR(100) '$.RetailPercentageType',
				[RotateDegree] INT '$.RotateDegree',
				[Author] VARCHAR(100) '$.Author',
				[CreateDate] VARCHAR(200) '$.CreateDate',
				[Modifier] VARCHAR(100) '$.Modifier',
				[ModifiedDate] VARCHAR(200) '$.ModifiedDate',
				[IsMaterial] BIT '$.IsMaterial',
				[IsLabor] BIT '$.IsLabor',
				[IsField] BIT '$.IsField',
				[IsCredit] BIT '$.IsCredit',
				[IsOverrideCredit] BIT '$.IsOverrideCredit',
				[IsPriceTypeArea] BIT '$.IsPriceTypeArea',
				[IsPriceTypeManual] BIT '$.IsPriceTypeManual',
				[IsUnderlayment] BIT '$.IsUnderlayment',
				[IsSink] BIT '$.IsSink',
				[IsEdge] BIT '$.IsEdge',
				[IsGrout] BIT '$.IsGrout',
				[IsCabinetHardware] BIT '$.IsCabinetHardware',
				[IsCabinetDoorHardware] BIT '$.IsCabinetDoorHardware',
				[IsCabinetDrawerHardware] BIT '$.IsCabinetDrawerHardware',
				[IsPatternLabor] BIT '$.IsPatternLabor',
				[IsAccent] BIT '$.IsAccent',
				[IsMargin] BIT '$.IsMargin',
				[IsMarkup] BIT '$.IsMarkup',
				[GetRotateDegree] INT '$.GetRotateDegree'
			)

			update
				bd
			set
				[AllocQty] = CEILING([AllocQty] * 0.97 * 1.08)
			from
				#catalog_selections_row_bom_data bd
			where
				[IsMaterial] = 1
				AND [ItemID] = 'Field'

			-- Serialize the updated BOM and store it back to the temp table
			declare @serialized_bom varchar(max)

			set @serialized_bom = (
				select
					[ID],
					[CatalogSelectionID],
					[LineNo],
					[PricingSource],
					[Options],
					[SessionID],
					[PriceType],
					[ItemType],
					[ItemID],
					[ItemClass],
					[ItemDescription],
					[Selectable],
					[RealItemID],
					[RealItemDescription],
					[BillQty],
					[AllocQty],
					[CreditQty],
					[UOM],
					[BuilderPrice],
					[HomeownerPrice],
					[ForceReprice],
					[RetailPercentage],
					[RetailPercentageType],
					[RotateDegree],
					[Author],
					[CreateDate],
					[Modifier],
					[ModifiedDate],
					[IsMaterial],
					[IsLabor],
					[IsField],
					[IsCredit],
					[IsOverrideCredit],
					[IsPriceTypeArea],
					[IsPriceTypeManual],
					[IsUnderlayment],
					[IsSink],
					[IsEdge],
					[IsGrout],
					[IsCabinetHardware],
					[IsCabinetDoorHardware],
					[IsCabinetDrawerHardware],
					[IsPatternLabor],
					[IsAccent],
					[IsMargin],
					[IsMarkup],
					[GetRotateDegree]
				from #catalog_selections_row_bom_data bd
				for json auto, INCLUDE_NULL_VALUES
			)

			set @serialized_bom = REPLACE(@serialized_bom, '"Options":null', '"Options":[]')

			update
				#catalog_selections_bom_data
			set
				modified_serialized_bom_data = @serialized_bom
			where current of upd

			fetch next from upd into @catalog_selections_row_id, @decompressed_serialized_bom_data
		end
		close upd
		deallocate upd

		-- Wrap backup/update operations in a transaction to make sure updates are done in full for a session
		begin tran
		begin try
			merge
				VEOSolutionsArchive_catalog_selections_area_details_update_backup TGT
			using
				(
					select *
					from
						#catalog_selections_area_details
					where
						session_id = @session_id
				) SRC
				on SRC.[operation] = TGT.[operation]
				and SRC.[session_id] = TGT.[session_id]
				and SRC.[application] = TGT.[application]
				and SRC.[product] = TGT.[product]
				and SRC.[area] = TGT.[area]
				and SRC.[sub_area] = TGT.[sub_area]
				and SRC.[item_type] = TGT.[item_type]
				and SRC.[item_id] = TGT.[item_id]
			when
				not matched then insert
			values (
				@run_date, SRC.operation, SRC.[session_id], SRC.[application], SRC.[product], SRC.[area], SRC.[sub_area], SRC.[item_type], SRC.[item_id], SRC.[selectable], SRC.[bom_real_item_id], SRC.[real_item_id], SRC.[bom_bill_qty], SRC.[bill_qty], SRC.[alloc_qty], SRC.[credit_qty], SRC.[bom_uom_id], SRC.[uom_id], SRC.[builder_price], SRC.[homeowner_price], SRC.[pattern_id], SRC.[is_pattern_item], SRC.[pattern_percentage], SRC.[force_reprice], SRC.[price_type], SRC.[price_source], SRC.[retail_percentage], SRC.[retail_percentage_type], SRC.[accent_prompt], SRC.[priced], SRC.[bom_item_id], SRC.[author], SRC.[create_date], SRC.[modifier], SRC.[modified_date]
			);

			merge
				VEOSolutionsArchive_catalog_selections_price_level_boms_update_backup TGT
			using
				(
					select *
					from
						#catalog_selections_bom_data
					where
						session_id = @session_id
				) SRC
				on SRC.[operation] = TGT.[operation]
				and SRC.[session_id] = TGT.[session_id]
				and SRC.[catalog_selections_row_id] = TGT.[catalog_selections_row_id]
			when
				not matched then insert
			values (
				@run_date, SRC.operation, SRC.[session_id], SRC.[catalog_selections_row_id], SRC.[serialized_bom_data], SRC.[author], SRC.[create_date], SRC.[modifier], SRC.[modified_date]
			);

			if @debug = 1
			begin
				select
					*
				from
					VEOSolutionsArchive_catalog_selections_area_details_update_backup
				where
					session_id = @session_id

				select
					*
				from
					VEOSolutionsArchive_catalog_selections_price_level_boms_update_backup
				where
					session_id = @session_id

				select *
				from
					catalog_selections_area_details d
				where
					d.session_id = @session_id
					and d.product = @product
					and d.item_type = 'material'
					and d.item_id = 'Field'
			end

			update
				d
			set
				alloc_qty = CEILING(alloc_qty * 0.97 * 1.08)
			from
				catalog_selections_area_details d
			where
				d.session_id = @session_id
				and d.product = @product
				and d.item_type = 'material'
				and d.item_id = 'Field'

			if @debug = 1
			begin
				select *
				from
					catalog_selections_area_details d
				where
					d.session_id = @session_id
					and d.product = @product
					and d.item_type = 'material'
					and d.item_id = 'Field'

				select b.*
					, CAST(DECOMPRESS(b.serialized_bom_data) as varchar(MAX)) as decompressed_serialized_bom_data
				from
					catalog_selections cs
				inner join
					catalog_selections_price_level_boms b on b.session_id = cs.session_id and b.catalog_selections_row_id = cs.row_id
				where
					cs.session_id = @session_id
					and cs.product = @product
			end

			update
				b
			set
				serialized_bom_data = COMPRESS(bd.modified_serialized_bom_data)
			from
				catalog_selections_price_level_boms b
			inner join
				#catalog_selections_bom_data bd on b.session_id = bd.session_id and b.catalog_selections_row_id = bd.catalog_selections_row_id
			where
				b.session_id = @session_id

			if @debug = 1
			begin
				select b.*
					, CAST(DECOMPRESS(b.serialized_bom_data) as varchar(MAX)) as decompressed_serialized_bom_data
				from
					catalog_selections cs
				inner join
					catalog_selections_price_level_boms b on b.session_id = cs.session_id and b.catalog_selections_row_id = cs.row_id
				where
					cs.session_id = @session_id
					and cs.product = @product
			end

			if @debug = 1
			begin
				rollback tran
			end
			else
			begin
				commit tran
			end
		end try
		begin catch
			rollback tran

			DECLARE @ErrorMessage NVARCHAR(4000);
			DECLARE @ErrorSeverity INT;
			DECLARE @ErrorState INT;
  
			SELECT
				@ErrorMessage = ERROR_MESSAGE(),
				@ErrorSeverity = ERROR_SEVERITY(),
				@ErrorState = ERROR_STATE();
  
			RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
		end catch

		fetch next from s into @session_id
	end
	close s
	deallocate s
end
close a
deallocate a
GO
PRINT N'Creating Procedure [dbo].[esp_createTableProceduresForMaintenance]...';


GO

create procedure [dbo].[esp_createTableProceduresForMaintenance]
@table_name varchar(100)
as
set nocount on
--=========================================================================
-- Check if the table exists
--=========================================================================
if not exists	(	select
									so.id
								from
									sysobjects so with (nolock)
								where
									so.name = @table_name )
	begin
		raiserror ('The table does not exist on this database', 16, 1)
		return
	end

--=========================================================================
-- Check to see if the table has a primary key
--=========================================================================
if not exists	( select
									si.id
								from
									sysindexes si with (nolock)
								join sysobjects so with (nolock) on
									so.id = si.id
								join sysindexkeys sik with (nolock) on
									sik.id = so.id
									and sik.indid = si.indid
								join syscolumns sc with (nolock) on
									sc.id = so.id
									and sc.colid = sik.colid
								join systypes st with (nolock) on
									sc.xtype = st.xtype
								where
									so.name = @table_name
									and si.name like 'PK_%')
	begin
		raiserror ('The table does not have a primary key.', 16, 1)
		return
	end

--=========================================================================
-- Table must have author, create_date, modifier, and modified_date columns
--=========================================================================
if not exists	( select
									sc.name
								from
									syscolumns sc with (nolock)
								join sysobjects so with (nolock) on
									so.id = sc.id
								join systypes st with (nolock) on
									sc.xtype = st.xtype
								where
									so.name = @table_name
									and so.type = 'u'
									and sc.name = 'author')
	begin
		raiserror ('The table does not have an ''author'' column.', 16, 1)
		return
	end

if not exists	( select
									sc.name
								from
									syscolumns sc with (nolock)
								join sysobjects so with (nolock) on
									so.id = sc.id
								join systypes st with (nolock) on
									sc.xtype = st.xtype
								where
									so.name = @table_name
									and so.type = 'u'
									and sc.name = 'create_date')
	begin
		raiserror ('The table does not have an ''create_date'' column.', 16, 1)
		return
	end

if not exists	( select
									sc.name
								from
									syscolumns sc with (nolock)
								join sysobjects so with (nolock) on
									so.id = sc.id
								join systypes st with (nolock) on
									sc.xtype = st.xtype
								where
									so.name = @table_name
									and so.type = 'u'
									and sc.name = 'modifier')
	begin
		raiserror ('The table does not have an ''modifier'' column.', 16, 1)
		return
	end

if not exists	( select
									sc.name
								from
									syscolumns sc with (nolock)
								join sysobjects so with (nolock) on
									so.id = sc.id
								join systypes st with (nolock) on
									sc.xtype = st.xtype
								where
									so.name = @table_name
									and so.type = 'u'
									and sc.name = 'modified_date')
	begin
		raiserror ('The table does not have an ''modified_date'' column.', 16, 1)
		return
	end

--=========================================================================
-- Get the table name in the correct case
--=========================================================================
declare @proc_table_name varchar(100)
set @proc_table_name = '_' + @table_name
/*
declare @underscore_position int

set @proc_table_name = ''
set @underscore_position = 0

set @proc_table_name = upper(left(@table_name,1)) + right(@table_name, len(@table_name) - 1)
set @underscore_position = charindex('_', @proc_table_name)

while @underscore_position > 0
	begin
		set @proc_table_name = left(@proc_table_name, @underscore_position - 1) + 
														upper(substring(@proc_table_name, @underscore_position + 1, 1))	+
														right(@proc_table_name, len(@proc_table_name) - @underscore_position - 1)
		set @underscore_position = charindex('_', @proc_table_name)
	end
*/

--=========================================================================
-- Get list of columns with types
--=========================================================================
declare @column_list_with_types varchar(7000)
set @column_list_with_types = ''

select
	@column_list_with_types = @column_list_with_types + '	[' + sc.name + '] ' + st.name + case when sc.xtype = 167 then '(' + cast(sc.length as varchar(10)) + ')' when sc.xtype = 106 then '(' + cast(sc.xprec as varchar(10)) + ',' + cast(sc.xscale as varchar(10)) + ')' else '' end + ' ' + case when sc.isnullable = 1 then 'NULL' else 'NOT NULL' end + ',
'
from
	syscolumns sc with (nolock)
join sysobjects so with (nolock) on
	so.id = sc.id
join systypes st with (nolock) on
	sc.xtype = st.xtype
where
	so.name = @table_name
	and so.type = 'u'
order by
	sc.colid

set @column_list_with_types = left(@column_list_with_types, len(@column_list_with_types) - 3)
set @column_list_with_types = replace(@column_list_with_types, 'timestamp', 'varchar(50)')

/*
--=========================================================================
-- Create z table
--=========================================================================
declare @z_table_sql varchar(8000)
set @z_table_sql = ''

set @z_table_sql = '
create table z_' + @table_name + ' (
	[z_user_name] varchar(50) NOT NULL,
	[z_action] varchar(10) NOT NULL,
	[z_time] datetime NOT NULL,
' + @column_list_with_types + ',
	[auto_number] int IDENTITY (1, 1) NOT NULL,
	CONSTRAINT [PK_z_' + @table_name + '] PRIMARY KEY CLUSTERED ([auto_number]))'

print(@z_table_sql)
print '


'
print('GO')
print '


'
*/

--=========================================================================
-- Get primary key parameter list and primary key where clause
--=========================================================================
declare @primary_key_parameter_list varchar(2000)
declare @primary_key_where_clause varchar(2000)
declare @primary_key_order_by_clause varchar(1000)

set @primary_key_parameter_list = ''
set @primary_key_where_clause = ''
set @primary_key_order_by_clause = ''

select
	@primary_key_parameter_list = @primary_key_parameter_list + '@' + sc.name + ' ' +
			case when st.name = 'char' then 'varchar' else st.name end +
			case
				when sc.xtype = 167 then '(' + cast(sc.length as varchar(10)) + ')'
				when sc.xtype = 175 then '(' + cast(sc.length as varchar(10)) + ')'
				when sc.xtype = 106 then '(' + cast(sc.xprec as varchar(10)) + ',' + cast(sc.xscale as varchar(10)) + ')'
				else ''
			end + ',
',
	@primary_key_where_clause = @primary_key_where_clause + '	and ' + sc.name + ' = @' + sc.name + '
',
	@primary_key_order_by_clause = @primary_key_order_by_clause + '	' + sc.name + ',
'
from
	sysindexes si with (nolock)
join sysobjects so with (nolock) on
	so.id = si.id
join sysindexkeys sik with (nolock) on
	sik.id = so.id
	and sik.indid = si.indid
join syscolumns sc with (nolock) on
	sc.id = so.id
	and sc.colid = sik.colid
join systypes st with (nolock) on
	sc.xtype = st.xtype
where
	so.name = @table_name
	and si.name like 'PK_%'

set @primary_key_parameter_list = left(@primary_key_parameter_list, len(@primary_key_parameter_list) - 3)
set @primary_key_where_clause = '	' + right(@primary_key_where_clause, len(@primary_key_where_clause) - 5)
set @primary_key_order_by_clause = left(@primary_key_order_by_clause, len(@primary_key_order_by_clause) - 3)

--=========================================================================
-- Get primary key where clause for insert audit
--=========================================================================
declare @primary_key_where_clause_for_insert_audit varchar(2000)
set @primary_key_where_clause_for_insert_audit = ''

select
	@primary_key_where_clause_for_insert_audit = @primary_key_where_clause_for_insert_audit + '	and ' + sc.name + ' = ' + case when sc.autoval is null then '@' + sc.name else 'scope_identity()' end + '
'
from
	sysindexes si with (nolock) 
join sysobjects so with (nolock) on
	so.id = si.id
join sysindexkeys sik with (nolock) on
	sik.id = so.id
	and sik.indid = si.indid
join syscolumns sc with (nolock) on
	sc.id = so.id
	and sc.colid = sik.colid
join systypes st with (nolock) on
	sc.xtype = st.xtype
where
	so.name = @table_name
	and si.name like 'PK_%'

set @primary_key_where_clause_for_insert_audit = '	' + right(@primary_key_where_clause_for_insert_audit, len(@primary_key_where_clause_for_insert_audit) - 5)

--=======================
-- Get autonumber column
--=======================
declare @autonumber_column varchar(255)
set @autonumber_column = ''

select
	@autonumber_column = sc.name
from
	syscolumns sc with (nolock)
join sysobjects so with (nolock) on
	so.id = sc.id
where
	so.name = @table_name
	and not sc.autoval is null

--==============================================================================
-- Get list of table columns minus author, create_date, modifier, modified_date 
--==============================================================================
declare @column_list varchar(2000)
declare @include_audit_fields_in_select bit

set @column_list = ''
set @include_audit_fields_in_select = 1

select
	@column_list = @column_list + '	' + sc.name + ',
'
from
	syscolumns sc with (nolock)
join sysobjects so with (nolock) on
	so.id = sc.id
where
	so.name = @table_name
	and so.type = 'u'
	and (sc.name <> 'author' or @include_audit_fields_in_select = 1)
	and (sc.name <> 'create_date' or @include_audit_fields_in_select = 1)
	and (sc.name <> 'modifier' or @include_audit_fields_in_select = 1)
	and (sc.name <> 'modified_date' or @include_audit_fields_in_select = 1) 
order by
	sc.colid

set @column_list = left(@column_list, len(@column_list) - 3)


--=========================================================================
-- Select stored procedure
--=========================================================================
declare @proc_action varchar(20)

declare @select_sql varchar(8000)
set @select_sql = ''

if exists (select name from sysobjects with (nolock) where name = 'esp_sel_' + @proc_table_name)
	set @proc_action = 'alter'
else
	set @proc_action = 'create'

set @select_sql = '
' + @proc_action + ' procedure esp_sel' + @proc_table_name + '
' + @primary_key_parameter_list + ',
@security_token varchar(36)
as

declare @edit_user_id varchar(75)
set @edit_user_id = dbo.ef_getSessionUsername(@security_token)
if (@edit_user_id is null)
	begin
		raiserror(''Invalid credentials.'',16,1)
		return
	end

select
' + @column_list + '
from
	' + @table_name + ' with (nolock)
where
' + @primary_key_where_clause + 'order by
' + @primary_key_order_by_clause

print(@select_sql)
print '


'
print('GO')
print '



'

--=========================================================================
-- Get insert parameter list, column names, and column values
--=========================================================================
declare @insert_parameter_list varchar(4000)
declare @insert_column_list varchar(4000)
declare @insert_column_values varchar(2000)

set @insert_parameter_list = ''
set @insert_column_list = ''
set @insert_column_values = ''

select
	@insert_parameter_list = @insert_parameter_list + '@' + sc.name + ' ' +
			case when st.name = 'char' then 'varchar' else st.name end +
			case
				when sc.xtype = 167 then '(' + cast(sc.length as varchar(10)) + ')'
				when sc.xtype = 175 then '(' + cast(sc.length as varchar(10)) + ')'
				when sc.xtype = 106 then '(' + cast(sc.xprec as varchar(10)) + ',' + cast(sc.xscale as varchar(10)) + ')'
				else ''
			end + ',
',
	@insert_column_list = @insert_column_list + '	' +	sc.name + ',
',
	@insert_column_values = @insert_column_values + '	@' + sc.name + ',
'
from
	syscolumns sc with (nolock)
join sysobjects so with (nolock) on
	so.id = sc.id
join systypes st with (nolock) on
	sc.xtype = st.xtype
where
	so.name = @table_name
	and so.type = 'u'
	and sc.name <> 'author'
	and sc.name <> 'create_date'
	and sc.name <> 'modifier'
	and sc.name <> 'modified_date'
	and sc.name <> 'stamp'
	and sc.autoval is null
order by
	sc.colid

set @insert_parameter_list = left(@insert_parameter_list, len(@insert_parameter_list) - 3)
set @insert_column_list = left(@insert_column_list, len(@insert_column_list) - 3)
set @insert_column_values = left(@insert_column_values, len(@insert_column_values) - 3)

--=========================================================================
-- Insert stored procedure
--=========================================================================
declare @insert_sql varchar(8000)
set @insert_sql = ''

/*
if right(@proc_table_name, 1) = 's' and right(@proc_table_name, 2) <> 'ss'
	set @proc_table_name = left(@proc_table_name, len(@proc_table_name) - 1)
*/

set @insert_sql = '
' + @proc_action + ' procedure esp_ins' + @proc_table_name + '
' + @insert_parameter_list + ',
@security_token varchar(36)
as

declare @edit_user_id varchar(75)
set @edit_user_id = dbo.ef_getSessionUsername(@security_token)
if (@edit_user_id is null)
	begin
		raiserror(''Invalid credentials.'',16,1)
		return
	end

insert into ' + @table_name + ' (
' + @insert_column_list + ',
	author,
	create_date,
	modifier,
	modified_date )
values (
' + @insert_column_values + ',
	@edit_user_id,
	getdate(),
	@edit_user_id,
	getdate() )

if @@error <> 0
	begin
		return
	end
'

if @autonumber_column <> ''
	begin
		set @insert_sql = @insert_sql + char(13) + 'select scope_identity() as ' + @autonumber_column + char(13)
	end

set @insert_sql = @insert_sql + '
--=======================
-- Insert z table record
--=======================
insert into 
	z_' + @table_name + '
select 
	@edit_user_id as z_user_name, 
	''insert'' as z_action, 
	getdate() as z_time, 
	*
from 
	' + @table_name + ' with (nolock)
where
' + @primary_key_where_clause_for_insert_audit

set @insert_sql = @insert_sql + '
--=======================
-- Return changed values
--=======================
select 
	author,
	create_date,
	modifier,
	modified_date,
	stamp
from 
	' + @table_name + ' with (nolock)
where
' + @primary_key_where_clause

print(@insert_sql)
print '


'
print('GO')
print '


'

--=========================================================================
-- Build stamp strings for use in update/delete procedures
--=========================================================================
declare @stamp_parameter varchar(100)
declare @stamp_where_clause varchar(100)

set @stamp_parameter = ''
set @stamp_where_clause = ''

select
	@stamp_parameter = ',
@' + sc.name + ' ' + st.name,
	@stamp_where_clause = '	and ' + sc.name + ' = @' + sc.name
from
	syscolumns sc with (nolock)
join sysobjects so with (nolock) on
	so.id = sc.id
join systypes st with (nolock) on
	sc.xtype = st.xtype
where
	so.name = @table_name
	and so.type = 'u'
	and sc.name = 'stamp'

--=========================================================================
-- Get update parameter list and column set list
--=========================================================================
declare @update_parameter_list varchar(4000)
declare @update_column_set_list varchar(4000)

set @update_parameter_list = ''
set @update_column_set_list = ''

select
	@update_parameter_list = @update_parameter_list + '@' + sc.name + ' ' +
			case when st.name = 'char' then 'varchar' else st.name end  +
			case
				when sc.xtype = 167 then '(' + cast(sc.length as varchar(10)) + ')'
				when sc.xtype = 175 then '(' + cast(sc.length as varchar(10)) + ')'
				when sc.xtype = 106 then '(' + cast(sc.xprec as varchar(10)) + ',' + cast(sc.xscale as varchar(10)) + ')'
				else ''
			end + ',
'
from
	syscolumns sc with (nolock)
join sysobjects so with (nolock) on
	so.id = sc.id
join systypes st with (nolock) on
	sc.xtype = st.xtype
where
	so.name = @table_name
	and so.type = 'u'
	and sc.name <> 'author'
	and sc.name <> 'create_date'
	and sc.name <> 'modifier'
	and sc.name <> 'modified_date'
	and sc.name <> 'stamp'
order by
	sc.colid

select
	@update_column_set_list = @update_column_set_list + '	' + sc.name + ' = @' + sc.name + ',
'
from
	syscolumns sc with (nolock)
join sysobjects so with (nolock) on
	so.id = sc.id
join systypes st with (nolock) on
	sc.xtype = st.xtype
where
	so.name = @table_name
	and so.type = 'u'
	and sc.name <> 'author'
	and sc.name <> 'create_date'
	and sc.name <> 'modifier'
	and sc.name <> 'modified_date'
	and sc.name <> 'stamp'
	and sc.name not in (	select
												sc.name
											from
												sysindexes si with (nolock)
											join sysobjects so with (nolock) on
												so.id = si.id
											join sysindexkeys sik with (nolock) on
												sik.id = so.id
												and sik.indid = si.indid
											join syscolumns sc with (nolock) on
												sc.id = so.id
												and sc.colid = sik.colid
											join systypes st with (nolock) on
												sc.xtype = st.xtype
											where
												so.name = @table_name
												and si.name like 'PK_%'	)
order by
	sc.colid

set @update_parameter_list = left(@update_parameter_list, len(@update_parameter_list) - 3)

if @update_column_set_list <> ''
	begin
		set @update_column_set_list = left(@update_column_set_list, len(@update_column_set_list) - 3)
		
--=========================================================================
-- Update stored procedure
--=========================================================================
declare @update_sql varchar(8000)
set @update_sql = ''

set @update_sql = '
' + @proc_action + ' procedure esp_upd' + @proc_table_name + '
' + @update_parameter_list + @stamp_parameter + ',
@security_token varchar(36)
as

declare @edit_user_id varchar(75)
set @edit_user_id = dbo.ef_getSessionUsername(@security_token)
if (@edit_user_id is null)
	begin
		raiserror(''Invalid credentials.'',16,1)
		return
	end

update
	' + @table_name + '
set
' + @update_column_set_list + ',
	modifier = @edit_user_id,
	modified_date = getdate()
where
' + @primary_key_where_clause + @stamp_where_clause + '

if @@error <> 0
	begin
		return
	end

--=======================
-- Insert z table record
--=======================
insert into 
	z_' + @table_name + '
select 
	@edit_user_id as z_user_name, 
	''update'' as z_action, 
	getdate() as z_time, 
	*
from
	' + @table_name + ' with (nolock)
where
' + @primary_key_where_clause 

set @update_sql = @update_sql + '
--=======================
-- Return changed values
--=======================
select 
	modifier,
	modified_date,
	stamp
from 
	' + @table_name + ' with (nolock)
where
' + @primary_key_where_clause

print(@update_sql)
print '


'
print('GO')
print '


'

	end

--=========================================================================
-- Delete stored procedure
--=========================================================================
declare @delete_sql varchar(8000)
set @delete_sql = ''

set @delete_sql = '
' + @proc_action + ' procedure esp_del' + @proc_table_name + '
' + @primary_key_parameter_list + @stamp_parameter + ',
@security_token varchar(36)
as

declare @edit_user_id varchar(75)
set @edit_user_id = dbo.ef_getSessionUsername(@security_token)
if (@edit_user_id is null)
	begin
		raiserror(''Invalid credentials.'',16,1)
		return
	end

--=======================
-- Insert z table record
--=======================
insert into 
	z_' + @table_name + '
select 
	@edit_user_id as z_user_name, 
	''delete'' as z_action, 
	getdate() as z_time, 
	*
from 
	' + @table_name + ' with (nolock)
where
' + @primary_key_where_clause + '

if @@error <> 0
	begin
		return
	end

delete from
	' + @table_name + '
where
' + @primary_key_where_clause + @stamp_where_clause


print(@delete_sql)
print '


'
print('GO')
print '


'
GO
PRINT N'Creating Procedure [dbo].[esp_createTableTriggers]...';


GO
CREATE procedure [dbo].[esp_createTableTriggers]
@table_name varchar(100)
as
/*
esp_createTableTriggers account_organization_documents
*/

--=========================================================================
-- Check if the table exists
--=========================================================================
if not exists	(	select
									so.id
								from
									sysobjects so
								where
									so.name = @table_name )
	begin
		raiserror ('The table does not exist on this database.', 16, 1)
		return
	end

--=========================================================================
-- Check to see if the table has a primary key
--=========================================================================
if not exists	( select
									si.id
								from
									sysindexes si
								join sysobjects so on
									so.id = si.id
								join sysindexkeys sik on
									sik.id = so.id
									and sik.indid = si.indid
								join syscolumns sc on
									sc.id = so.id
									and sc.colid = sik.colid
								join systypes st on
									sc.xtype = st.xtype
								where
									so.name = @table_name
									and si.name like 'PK_%')
	begin
		raiserror ('The table does not have a primary key.', 16, 1)
		return
	end

--=========================================================================
-- Table must have author, create_date, modifier, and modified_date columns
--=========================================================================
if not exists	( select
									sc.name
								from
									syscolumns sc
								join sysobjects so on
									so.id = sc.id
								join systypes st on
									sc.xtype = st.xtype
								where
									so.name = @table_name
									and so.type = 'u'
									and sc.name = 'author')
	begin
		raiserror ('The table does not have an ''author'' column.', 16, 1)
		return
	end

if not exists	( select
									sc.name
								from
									syscolumns sc
								join sysobjects so on
									so.id = sc.id
								join systypes st on
									sc.xtype = st.xtype
								where
									so.name = @table_name
									and so.type = 'u'
									and sc.name = 'create_date')
	begin
		raiserror ('The table does not have an ''create_date'' column.', 16, 1)
		return
	end

if not exists	( select
									sc.name
								from
									syscolumns sc
								join sysobjects so on
									so.id = sc.id
								join systypes st on
									sc.xtype = st.xtype
								where
									so.name = @table_name
									and so.type = 'u'
									and sc.name = 'modifier')
	begin
		raiserror ('The table does not have an ''modifier'' column.', 16, 1)
		return
	end

if not exists	( select
									sc.name
								from
									syscolumns sc
								join sysobjects so on
									so.id = sc.id
								join systypes st on
									sc.xtype = st.xtype
								where
									so.name = @table_name
									and so.type = 'u'
									and sc.name = 'modified_date')
	begin
		raiserror ('The table does not have an ''modified_date'' column.', 16, 1)
		return
	end

--=========================================================================
-- Get list of columns with types
--=========================================================================
declare @column_list varchar(7000)
set @column_list = ''

select
	@column_list = @column_list + '	[' + sc.name + '] ' + st.name + 
		case 
			when sc.length = -1 then '(max)'
			when sc.xtype = 167 then '(' + cast(sc.length as varchar(10)) + ')' 
			when sc.xtype = 106 then '(' + cast(sc.xprec as varchar(10)) + ',' + cast(sc.xscale as varchar(10)) + ')' 
			else '' end + ' ' + 
		case when sc.isnullable = 1 then 'NULL' else 'NOT NULL' end + ',
'
from
	syscolumns sc
join sysobjects so on
	so.id = sc.id
join systypes st on
	sc.xtype = st.xtype
where
	so.name = @table_name
	and so.type = 'u'
order by
	sc.colid

--print 'column list'
--print '>' + @column_list + '<'
--print 'column list'

set @column_list = left(@column_list, len(@column_list) - 3)

--print 'column list'
--print '>' + @column_list + '<'
--print 'column list'

set @column_list = replace(@column_list, 'timestamp', 'varchar(50)')

--=========================================================================
-- Create z table
--=========================================================================
declare @z_table_sql varchar(8000)
set @z_table_sql = ''

set @z_table_sql = '
create table z_' + @table_name + ' (
	[z_user_name] varchar(50) NOT NULL,
	[z_action] varchar(10) NOT NULL,
	[z_time] datetime NOT NULL,
' + @column_list + ',
	[auto_number] int IDENTITY (1, 1) NOT NULL,
	CONSTRAINT [PK_z_' + @table_name + '] PRIMARY KEY CLUSTERED ([auto_number]))'

print(@z_table_sql)
print('GO')

--=========================================================================
-- Get primary key where clause
--=========================================================================
declare @primary_key_where_clause varchar(1000)
set @primary_key_where_clause = ''

select
	@primary_key_where_clause = @primary_key_where_clause + '	and main.' + sc.name + ' = i.' + sc.name + '
'
from
	sysindexes si
join sysobjects so on
	so.id = si.id
join sysindexkeys sik on
	sik.id = so.id
	and sik.indid = si.indid
join syscolumns sc on
	sc.id = so.id
	and sc.colid = sik.colid
join systypes st on
	sc.xtype = st.xtype
where
	so.name = @table_name
	and si.name like 'PK_%'

set @primary_key_where_clause = '	' + right(@primary_key_where_clause, len(@primary_key_where_clause) - 5)

--=========================================================================
-- Insert trigger
--=========================================================================
declare @insert_sql varchar(4000)
set @insert_sql = ''

set @insert_sql = '
create trigger ot_ins_' + @table_name + ' on dbo.' + @table_name + '
for insert as
'
/*
--=====================
-- Update audit fields
--=====================
update
	' + @table_name + '
set
	author = system_user, 
	create_date = getdate(), 
	modifier = system_user, 
	modified_date = getdate()
from
	' + @table_name + ' main, inserted i
where
' + @primary_key_where_clause + '
*/

set @insert_sql = @insert_sql + '
--========================
-- Insert z table records
--========================
insert into 
	z_' + @table_name + '
select 
	i.author as z_user_name, 
	''insert'' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i'


print(@insert_sql)
print('GO')

--=========================================================================
-- Update trigger
--=========================================================================
declare @update_sql varchar(4000)
set @update_sql = ''

set @update_sql = '
create trigger ot_upd_' + @table_name + ' on dbo.' + @table_name + '
for update as
'

/*
if trigger_nestlevel() = 1
	begin
*/

set @update_sql = @update_sql + '
--=====================
-- Update audit fields
--=====================
update
	' + @table_name + '
set
	modifier = i.modifier, 
	modified_date = getdate()
from
	' + @table_name + ' main, inserted i
where
' + @primary_key_where_clause + '

--========================
-- Insert z table records
--========================
insert into 
	z_' + @table_name + '
select 
	i.modifier as z_user_name, 
	''update'' as z_action, 
	getdate() as z_time, 
	*
from 
	inserted i'

--end'


print(@update_sql)
print('GO')

--=========================================================================
-- Delete trigger
--=========================================================================
declare @delete_sql varchar(4000)
set @delete_sql = ''

set @delete_sql = '
create trigger ot_del_' + @table_name + ' on dbo.' + @table_name + '
for delete as

--========================
-- Insert z table records
--========================
insert into 
	z_' + @table_name + '
select 
	d.modifier as z_user_name, 
	''delete'' as z_action, 
	getdate() as z_time, 
	*
from 
	deleted d'


print(@delete_sql)
print('GO')
GO
PRINT N'Creating Procedure [dbo].[esp_updConciergeSelectionSetExported]...';


GO
create procedure [dbo].[esp_updConciergeSelectionSetExported]
@user_plan_id uniqueidentifier,
@exported bit
as


	
-- update veo solution session	
if (@exported = 0)
	update account_organization_user_profile_plan_catalog_sessions
	set export_date = '1/1/1900'
	where session_id = @user_plan_id
GO
PRINT N'Creating Procedure [dbo].[find]...';


GO

  CREATE procedure [dbo].[find]    
    
@searchValue varchar(100)    
as    
    
select distinct     
  name     
from  sysobjects so     
left join syscomments sc on so.id = sc.id     
where     
  text like '%' + @searchValue + '%'  
order by
	name
GO
PRINT N'Creating Procedure [dbo].[find_text]...';


GO
create procedure [dbo].[find_text]
@searchString varchar(max)

as

--declare @searchString varchar(255)
--set @searchString = 'varchar'

-----------------------------------------------------------------------
-- Find any stored procedure containing the search string.
-----------------------------------------------------------------------
declare @nameTable table
( 
idx bigint primary key identity(1,1),
name varchar(max) 
)

insert into @nameTable 
    ( name )
select distinct
    so.name
from
    sysobjects so
    left join syscomments sc on sc.id = so.id
where
    sc.text like '%' + @searchString + '%'
order by
    so.name

-----------------------------------------------------------------------
-- Determine how many names there are.
-----------------------------------------------------------------------
declare @nameIdx bigint = 1
declare @name varchar(max)
declare @nameCount bigint = (select COUNT(*) from @nameTable)
declare @nameMax bigint = (select MAX(idx) from @nameTable)

declare @helptextTable table
(
line varchar(max)
)

declare @returnTable table
(
name varchar(max),
line varchar(max)
)

if @nameCount > 0
begin

    while (@nameIdx <=@nameMax)
    begin
        ---------------------------------------------------------------
        -- Get the next stored procedure name.
        ---------------------------------------------------------------
        set @name = (select name from @nameTable where idx = @nameIdx)
        ---------------------------------------------------------------
        -- Reset the help text table for this stored procedure.
        ---------------------------------------------------------------
        delete from @helptextTable where line is not null

        insert into @helptextTable exec sp_helptext @name

        insert into @returnTable
        (
            name,
            line
        )
        select
            @name,
            t1.line
        from
            (
            select
                line
            from
                @helptextTable
            ) t1
        where
            t1.line like '%' + @searchString + '%'

        ---------------------------------------------------------------
        -- Increment the counter.
        ---------------------------------------------------------------
        set @nameIdx = @nameIdx + 1
    end

end

select * from @returnTable
GO
PRINT N'Creating Procedure [dbo].[integration_revenuePrediction]...';


GO
CREATE PROCEDURE [dbo].[integration_revenuePrediction]
	@start_date DateTime = NULL,
	@end_date DateTime = NULL, 
	@use_session_first_completed_date bit = 0,
	@ignore_credits_for_builder bit = 1, 
	@address_filter nvarchar(200) = NULL 
AS
/*
	Author: Shelby Mansker
	Date: 8/23/2018
	Description: This is an integration stored proc, designed for the data delivery group, so that they
		my feed data from VDS to their Revenue Prediction Simulation.

	Updated: 11/06/18
	Author: Robert Hobbs 
		Added parameters for which completion date to use 
		Also added a flag or handling credits 
		Also an address filter 
		Modified the session selection logic 
		Added bom modifications

	NOTES: 
	Builder Cost is the sum of the product of the quantity and builder price.
	    The quantity is calculated as follows:
		- for area uom, always 1
		- for credit areas, use credit_qty
		- otherwise, use bill_qty	
	
	Testing:
	integration_revenuePrediction '10/01/2018', '10/31/2018' 

	integration_revenuePrediction '01/01/2018', '10/31/2018' 

*/
BEGIN
	
	--DECLARE @debug bit = 0

	DECLARE @sessions TABLE 
	(
		session_id uniqueidentifier primary key,
		[address] varchar(100) 
	)

	INSERT INTO @sessions 
	SELECT 
		s.session_id,
		a.address
	FROM 
		account_organization_user_profile_plan_catalog_sessions s WITH (NOLOCK)
		JOIN account_organization_user_profile_plan a with (nolock) on a.account_id  = s.account_id and a.organization_id = s.organization_id and a.user_id = s.user_id and a.community_name = s. community_name and a.series = s.series and a.plan_name = s.plan_name 
		JOIN veosolutionssecurity_organizations o on o.organization_id = s.organization_id
	WHERE
		(s.[status] = 2 OR s.[status] = 3) -- 2 = Complete, 3 = Invoiced
		AND 
		( CASE @use_session_first_completed_date 
			WHEN 0 THEN s.first_completed_date 
			ELSE s.completed_date 
		END  >= @start_date OR @start_date is null) 
		AND 
		( CASE @use_session_first_completed_date 
			WHEN 0 THEN s.first_completed_date 
			ELSE s.completed_date 
		END  <= @end_date OR @end_date is null)
		AND o.name not like 'Contempo%'
		AND o.name not like '%Staggered%'
		AND o.name not like 'Happy%'
		AND (a.address = @address_filter or @address_filter is null)

		-- REFERENCE: 
		-- RG's VeoInvoicing Proc filters on the following: 
		--case ss.status 
		--	when 'Complete' then s.first_completed_date
		--	when 'Invoiced' then s.first_completed_date
		--	when 'Pending' then s.first_completed_date		
		--else s.modified_date
		--AND ss.status not in ('Inactive')

	-- DEBUG 
	--if (@debug = 1) 
	--begin 
	--	select * from @sessions 
	--end 

	DECLARE @selection_totals TABLE 
	(
		session_id uniqueidentifier, 
		[address] varchar(100),
		[application] varchar(100), 
		product varchar(100), 
		homebuyer_price decimal(18,4),
		builder_cost decimal(18,4) 
	)

	-- estimated selections - homebuyer
	INSERT INTO @selection_totals 
	SELECT
		s.session_id,
		s.address, 
		csa.[application],
		csa.product,
		SUM(csa.selection_total) AS homebuyer_price, 
		0 as builder_cost
	FROM
		@sessions s
		JOIN catalog_selections_areas csa WITH (NOLOCK) ON csa.session_id = s.session_id
	WHERE
		csa.area_selected = 1
		AND csa.selected > 0
	GROUP BY
		s.session_id,
		s.address, 
		csa.[application],
		csa.product
	
	-- estimated selections - builder 
	INSERT INTO @selection_totals
	SELECT
		s.session_id,
		s.address,
		csa.[application],
		csa.product,
		0 as homebuyer_price,
		SUM( CASE 
			WHEN ( @ignore_credits_for_builder = 1 AND ( csad.item_id = 'credit' OR csad.item_id = 'promo_credit') ) THEN 0 
			WHEN csad.price_type = 'area' THEN csad.builder_price 
			WHEN cs.is_credit = 1 THEN csad.builder_price * csad.credit_qty 
			WHEN csad.bill_qty = 0 THEN csad.builder_price * csad.credit_qty 
			ELSE 
				csad.builder_price * csad.bill_qty
			END) AS builder_cost  
			 
		-- REFERENCE 
		--ORIGINAL PRICING LOGIC FOR COMPARISON 
		--SUM(CASE
		--	WHEN price_type = 'area' THEN csad.builder_price
		--	WHEN cs.is_credit = 1 THEN csad.builder_price * csad.credit_qty
		--	WHEN csad.bill_qty = 0 THEN csad.builder_price * csad.credit_qty 
		--	ELSE
		--		csad.builder_price * csad.bill_qty
		--	END) AS builder_cost

	FROM
		@sessions s
		JOIN catalog_selections_areas csa WITH (NOLOCK) ON csa.session_id = s.session_id
		JOIN catalog_selections cs WITH (NOLOCK) ON cs.session_id = csa.session_id AND cs.row_id = csa.selected_field_group
		JOIN catalog_selections_area_details csad WITH (NOLOCK) ON csad.session_id = csa.session_id AND csad.[application] = csa.[application] AND csad.product = csa.product AND csad.area = csa.area AND csad.sub_area = csa.sub_area
	WHERE
		csa.area_selected = 1
		AND csa.selected > 0
	GROUP BY
		s.session_id,
		s.address,
		csa.[application],
		csa.product

	-- bom modifications 
	INSERT INTO @selection_totals
	SELECT 
		s.session_id, 
		s.address, 
		csa.[application],
		csa.product,
		SUM(m.quantity * m.price) as homebuyer_price, 
		SUM(m.quantity * m2.cost) as builder_cost 
	FROM
		@sessions s
		JOIN catalog_selections_areas csa WITH (NOLOCK) ON csa.session_id = s.session_id
		JOIN catalog_selections_area_bom_modifications m on m.session_id = s.session_id and m.build_id = csa.build_id
		JOIN catalog_selections_bom_modifications m2 on m2.id = m.session_bom_modification_id 
	GROUP BY
		s.session_id,
		s.address, 
		csa.[application],
		csa.product

	--if (@debug = 1 ) 
	--BEGIN 
	--	select * from @selection_totals
	--END 

	SELECT
		o.[name] AS builder,
		o.organization_id AS builder_id,
		o.external_organization_id AS echelon_builder_id,
		s.session_id,
		t.[application],
		t.product,
		CASE
			WHEN pp.job_type = 0 THEN 'Homebuyer'
			WHEN pp.job_type = 1 THEN 'Spec'
			WHEN pp.job_type = 3 THEN 'Model'
			WHEN pp.job_type = 4 THEN 'Other'
			ELSE 'Unknown'
		END AS job_type,
		s.completed_date,
		s.address_id,
		pp.[address],
		pp.lot,
		pp.[block],
		SUM(t.homebuyer_price) as homebuyer_price,
		SUM(t.builder_cost) as builder_cost
	FROM
		VeoSolutionsSecurity_organizations o WITH (NOLOCK)
		JOIN account_organization_user_profile_plan pp WITH (NOLOCK) ON pp.organization_id = o.organization_id
		JOIN account_organization_user_profile_plan_catalog_sessions s WITH (NOLOCK) ON s.account_id = pp.account_id AND s.organization_id = pp.organization_id AND s.[user_id] = pp.[user_id] AND s.community_name = pp.community_name AND s.series = pp.series AND s.plan_name = pp.plan_name
		JOIN @selection_totals t on t.session_id = s.session_id 
	GROUP BY 
		o.[name] ,
		o.organization_id ,
		o.external_organization_id ,
		s.session_id,
		t.[application],
		t.product,
		job_type, 
		s.completed_date,
		s.address_id,
		pp.[address],
		pp.lot,
		pp.[block]
	ORDER BY 
		builder,
		s.session_id,
		t.[application],
		t.product

		
END
GO
PRINT N'Creating Procedure [dbo].[list]...';


GO
CREATE procedure [dbo].[list]
@stored_procedure_name varchar(max)
as

--declare @stored_procedure_name varchar(max)
--set @stored_procedure_name = 'osp_getTechnicians'

--=====================================================================
-- Declare temporary tables.
--=====================================================================
declare @helptextTable table (
line_pointer bigint identity(1,1),
line varchar(max) )

declare @returnTable table (
line varchar(max) )

--=====================================================================
-- Execute sp_helptext, and put the results in a temporary table.
--=====================================================================
insert into @helptextTable exec sp_helptext @stored_procedure_name

--=====================================================================
-- In SQL Server 2012, sp_helptext adds an extra CRLF to every line.
--=====================================================================
insert into @returnTable (
    line )
select
    SUBSTRING(t1.line, 1, (LEN(t1.line) - 2))
from
    ( select line from @helptextTable ) t1

--=====================================================================
-- Return the table.
--=====================================================================
select * from @returnTable
GO
PRINT N'Creating Procedure [dbo].[osp_selPublishedSessionUnitPriceDefaultLabor]...';


GO

CREATE procedure [dbo].[osp_selPublishedSessionUnitPriceDefaultLabor]    
 (    
  @session_id uniqueidentifier,
  @spec_id int,    
  @effective_date datetime,    
  @application_id varchar(10),    
  @product_id varchar(10),    
   @labor_code varchar(10),    
  @uom varchar(20),    
  @mode varchar(25),    
  @precision int = 2,    
  @publish_date datetime,
  @price decimal(18,6) output,    
  @retail_unit_price decimal(18,6) output,     
  @retail_percentage decimal(18,6) output,     
  @retail_percentage_type varchar(10) output,     
  @error_msg varchar(255) output    
 )    
    
as    
    
   
    
declare @multiplier decimal(18,6)    
declare @routine varchar(50)    
declare @table_uom varchar(50)    
    
set @price = null    
set @retail_unit_price = null     
set @retail_percentage = null     
set @retail_percentage_type = ''     
set @error_msg = ''    
set @multiplier = null    
set @routine = 'osp_selPublishedSessionUnitPriceDefaultLabor'    
    
select top 1    
 @price = p.price,    
 @retail_unit_price = p.retail_unit_price,    
 @retail_percentage = p.retail_percentage,     
 @retail_percentage_type = p.retail_percentage_type,     
 @multiplier = dbo.veo_getUomQty(1, p.uom, case len(@uom)     
       when 0 then p.uom     
       else @uom end     
     ),    
 @table_uom = p.uom    
from     
 catalog_prices_published p with (nolock)    
where     
 p.spec_id = @spec_id and    
 p.application_id = @application_id and     
 p.product_id = @product_id and    
 p.effective_date = @effective_date    

 and item_type = 'labor'
 and item = @labor_code
 and table_name = 'prices_default_labor'
 and cast(published as date) >= cast(@publish_date as date)
 and session_id = @session_id

order by    
 p.effective_date desc    
    
    
if @price is null      
--search again, this time without application. This handles labor codes assigned to an item used across multiple applications.     
 select top 1    
  @price = p.price,    
  @retail_unit_price = p.retail_unit_price,    
  @retail_percentage = p.retail_percentage,     
  @retail_percentage_type = p.retail_percentage_type,     
  @multiplier = dbo.veo_getUomQty(1, p.uom,  case len(@uom)     
       when 0 then p.uom     
       else @uom end     
     ),    
  @table_uom = p.uom    
 from     
  catalog_prices_published p with (nolock)    
  join veo_pricesets ps with (nolock) on ps.spec_id = p.spec_id and ps.effective_date = p.effective_date     
 where     
  p.spec_id = @spec_id and    
  p.product_id = @product_id and    
  ps.effective_date = @effective_date    
  and ps.active = 1    
  and item_type = 'labor'
  and item = @labor_code
  and table_name = 'prices_default_labor'
  and cast(published as date) >= cast(@publish_date as date)
  and session_id = @session_id
 order by    
  ps.effective_date desc    
    
    
if @price is not null -- found a record     
 begin    
  if @multiplier < 0 --(bad uom: abort)    
   begin    
    set @error_msg = 'The default labor price for ' + @labor_code + ' could not be converted to ''' + @uom + ''''    
    --set @error_msg = 'Cannot convert to pricing UOM (' + @table_uom + ')'    
    set @price = null    
    return -1    
   end    
    
  -- successfully return a price    
  set @price = round(@price / @multiplier,@precision)    
  set @retail_unit_price = round(@retail_unit_price / @multiplier, @precision)     
  set @retail_percentage = round(@retail_percentage / @multiplier, @precision)     
    
  return 0    
 end    
    
-- return a null price to allow system to go to next level    
set @price = round(@price / @multiplier,@precision)    
return 0
GO
PRINT N'Creating Procedure [dbo].[osp_selPublishedSessionUnitPriceGlobalLabor]...';


GO


CREATE procedure [dbo].[osp_selPublishedSessionUnitPriceGlobalLabor]
	(
	    @session_id uniqueidentifier,
		@effective_date datetime,
		@customer_id varchar(15),
		@application_id varchar(10),
		@product_id varchar(10),
	 	@labor_code varchar(10),
		@uom varchar(20),
		@mode varchar(25),
		@precision int = 2,
		@publish_date datetime,
		@price decimal(18,6) output,
		@retail_unit_price decimal(18,6) output, 
		@retail_percentage decimal(18,6) output, 
		@retail_percentage_type varchar(10) output,  
		@error_msg varchar(255) output
	)

as

/*
SUMMARY: 
this function returns the unit price & retail_unit_price 
from prices_global_labor 
in terms of the desired unit of measure.
*/

/*
select dbo.of_getUomQty(1,'SqFt','SqFt')

declare @price decimal(18,6), @error varchar(255)
exec osp_selUnitPricePublicLabor '01','TRACT - HOUSTON','3','6','NLBR','SqFt','',2, @price output, @error output
print @price
print @error

select * from styles where style_id = '6B1BRICW'
*/

declare @multiplier decimal(18,6)
declare @routine varchar(50)
declare @table_uom varchar(50)

set @price = null
set @retail_unit_price = null
set @error_msg = ''
set @multiplier = null
set @routine = 'osp_selUnitPriceGlobalLabor'

select top 1
	@price = p.price,
	@retail_unit_price = p.retail_unit_price, 
	@retail_percentage = p.retail_percentage, 
	@retail_percentage_type = p.retail_percentage_type,   
	@multiplier = dbo.veo_getUomQty(1, p.uom, @uom),
	@table_uom = p.uom
from 
	catalog_prices_published p with (nolock)
where 
	p.customer_id = @customer_id and
	p.application_id = @application_id and 
	p.product_id = @product_id and
	cast(p.effective_date as date) <= cast(@effective_date as date)
	and item_type = 'labor'
	and item = @labor_code
	and table_name = 'prices_global_labor'
	and cast(published as date) >= cast(@publish_date as date)
	and session_id = @session_id
order by
	p.effective_date desc

if @price is null 
--search again, without using the application 
select top 1
	@price = p.price,
	@retail_unit_price = p.retail_unit_price, 
	@retail_percentage = p.retail_percentage, 
	@retail_percentage_type = p.retail_percentage_type,   
	@multiplier = dbo.veo_getUomQty(1, p.uom, @uom),
	@table_uom = p.uom
from 
	catalog_prices_published p with (nolock)
where 
	p.customer_id = @customer_id and
	p.product_id = @product_id and
	cast(p.effective_date as date) <= cast(@effective_date as date)
	and item_type = 'labor'
	and item = @labor_code
	and table_name = 'prices_global_labor'
	and cast(published as date) >= cast(@publish_date as date)
	and session_id = @session_id
order by
	p.effective_date desc


if @price is not null -- found a record	
	begin
		if @multiplier < 0 --(bad uom: abort)
			begin
				--set @error_msg = 'Cannot convert to pricing UOM (' + @table_uom + ')'
				set @error_msg = 'The global labor price for the ' + 'labor code' + ' ''' + @labor_code + ''' could not be converted to ''' + @uom + '''.'

				set @price = null
				return -1
			end

		-- successfully return a price
		set @price = round(@price / @multiplier,@precision)
		set @retail_unit_price  = round(@retail_unit_price  / @multiplier, @precision) 
		set @retail_percentage  = round(@retail_percentage  / @multiplier, @precision) 

		return 0
	end

-- return a null price to allow system to go to next level
set @price = round(@price / @multiplier,@precision)
set @retail_unit_price = round(@retail_unit_price / @multiplier , @precision) 

return 0
GO
PRINT N'Creating Procedure [dbo].[osp_selPublishedSessionUnitPricePublicMaterial]...';


GO


CREATE  procedure [dbo].[osp_selPublishedSessionUnitPricePublicMaterial]
	(
	    @session_id uniqueidentifier,
		@effective_date datetime,
		@region_id varchar(2),
		@custclas varchar(25),
		@application_id varchar(10),
		@product_id varchar(10),
		@item_type varchar(10),
		@item varchar(81),
		@uom varchar(20),
		@mode varchar(25),
		@precision int = 2,
		@publish_date datetime,
		@price decimal(18,2) output,
		@error_msg varchar(255) output,
		@price_date datetime = '1/1/1900' output
	)

as

--===================================================================
-- This procedure returns the unit price from prices_public_material
-- in terms of the desired unit of measure.
--===================================================================

/*
select dbo.of_uomMultiplier('6', '754', '', 'LinFt', 'LinFt', 6)

declare @price decimal(18,6)
declare @error varchar(255)
exec osp_selUnitPricePublicMaterial '01','TRACT - HOUSTON','3','6','style','754','LinFt','', 2, @price output, @error output
print @price
print @error

print dbo.of_unitPricePublicMaterial('01','TRACT - HOUSTON','3','6','755','','Each','',2)
print 1.25 * 9
*/

declare @multiplier decimal(18,6)
declare @routine varchar(50)
declare @table_uom varchar(50)

set @price = null
set @error_msg = ''
set @multiplier = null
set @routine = 'osp_selPublishedUnitPricePublicMaterial'

--===========================
-- Get a price for the color
--===========================
if @item_type = 'color'
	begin
		declare @item_product varchar(10)
		declare @item_style varchar(20)
		declare @item_color varchar(50)
		
		select
			@item_product = product_id,
			@item_style = style_id,
			@item_color = color_id
		from
			veo_colors with (nolock)
		where
			part_no = @item
	
		select top 1
			@price = pp.price,
			@multiplier = dbo.veo_uomMultiplier(@item_product, @item_style, @item_color, pp.uom, @uom, 6),
			@table_uom = pp.uom,
			@price_date = pp.effective_date
		from 
			catalog_prices_published pp with (nolock)
		where 
			pp.region_id = @region_id and
			pp.custclas = @custclas and
			pp.application_id = @application_id and
			pp.product_id = @product_id and
			pp.item_type = @item_type and
			pp.item = @item and
			pp.effective_date <= @effective_date
			and table_name = 'prices_public_material'
			and cast(published as date) >= cast(@publish_date as date)
		    and session_id = @session_id
		order by
			pp.effective_date desc

		if @price is null
			return 0

		if @multiplier is null --(bad uom: abort)
			begin
				set @error_msg = 'The public price for the ' + @item_type + ' ''' + @item + ''' could not be converted to ''' + @uom + ''''
				--set @error_msg = 'Cannot convert to pricing UOM (' + @table_uom + ')'
				set @price = null
				return -1
			end

		-- successfully return a price
		set @price = round( @price / @multiplier, @precision)
		return 0
	end

--===========================
-- Get a price for the style
--===========================
if @item_type = 'style'
	begin
		select top 1
			@price = pp.price,
			@multiplier = dbo.veo_uomMultiplier(@product_id, @item, '', pp.uom, @uom, 6),
			@table_uom = pp.uom,
			@price_date = pp.effective_date
		from 
			catalog_prices_published pp with (nolock)
		where 
			pp.region_id = @region_id and
			pp.custclas = @custclas and
			pp.application_id = @application_id and
			pp.product_id = @product_id and
			pp.item_type = @item_type and
			pp.item = @item and
			pp.effective_date <= @effective_date
			and table_name = 'prices_public_material'
			and cast(published as date) >= cast(@publish_date as date)
			and session_id = @session_id
		order by
			pp.effective_date desc
		
		if @price is null
			return 0

		if @multiplier is null
			begin
				set @error_msg = 'The public price for the ' + @item_type + ' ''' + @item + ''' could not be converted to ''' + @uom + ''''
				--set @error_msg = 'Cannot convert to pricing UOM (' + @table_uom + ')'
				set @price = null
				return -1
			end
	
		set @price = round( @price / @multiplier, @precision)
		return 0
	end

return 0
GO
PRINT N'Creating Procedure [dbo].[rpt_CustomerOverrides]...';


GO
create procedure [dbo].[rpt_CustomerOverrides]
@start_date datetime , 
@end_date datetime,
@organization_id uniqueidentifier

as
/*
	autor: The Gladstones
	date: 1/4/2021


	rpt_CustomerOverrides '12/1/2020','12/31/2020','59C673FE-79F5-42CB-823E-76EB2066A081'

    Note:  Added org id parm 1/21/2021 --ADG
*/

with cte as 
(
select
                replace(replace(replace(replace( replace(replace(sl.body_message,char(10),' '),char(13),' '), ' ', '<>'), '><',''),'<>',' '),': ',':') as bm,
                sl.author,
                sl.entry_date,
                sl.problem_type,
                sl.application, 
                sl.product,
                sl.notes,
                o.name,
                aouppcs.session_id,
                aoupp.address,
                aouppcs.community_name, 
                aouppcs.series, 
                aouppcs.plan_name,
				o.organization_id
FROM
                [support_log] sl
                join dbo.account_organization_user_profile_plan_catalog_sessions aouppcs on sl.session_id = aouppcs.session_id  
                join account_organization_user_profile_plan aoupp on aoupp.account_id = aouppcs.account_id and aoupp.organization_id = aouppcs.organization_id and aoupp.user_id = aouppcs.user_id  
                                and aoupp.community_name = aouppcs.community_name and aoupp.series = aouppcs.series and aoupp.plan_name = aouppcs.plan_name
                join VEOSolutionsSecurity_organizations o on aouppcs.organization_id = o.organization_id
where 
                o.organization_id = @organization_id
), cte2 as
(
                select 
                                bm,
                                author,
                                entry_date,
                                problem_type,
                                application, 
                                product,
                                notes,
                                name,
								organization_id,
                                session_id,
                                address,
                                community_name, 
                                series, 
                                plan_name,
                                'Reason:' as reason_lbl,
                                charindex('Reason:', bm) as reason_lbl_start,
                                'Notes:' as notes_lbl,
                                charindex('Notes:', bm) as notes_lbl_start,
                                'Homebuyer' as homebuyer_lbl,
                                charindex('homebuyer', bm) as homebuyer_lbl_start,
                                'Original price:' as original_price_lbl,
                                charindex('original price:' , bm) as original_price_lbl_start,
                                'price:' as price_lbl,
                                case when charindex('price:', replace(bm,'original price:','')) > 0 then charindex('price:', replace(bm,'original price:',''))+len('original price:') else 0 end as price_lbl_start,
                                case when charindex('price:', replace(bm,'original price:','')) > 0 then
                                                charindex
                                                (
                                                                ' ',
                                                                substring
                                                                (
                                                                                bm,
                                                                                charindex('price:', replace(bm,'original price:',''))+len('original price:')+len('price:'),
                                                                                len(bm) - charindex('price:', replace(bm,'original price:',''))+len('original price:')+len('price:')
                                                                ) 
                                                ) - 1 
                                                else 0 end as price_length
                from cte
)

select 
                author,
                entry_date,
                problem_type,
                application, 
                product,
                notes as log_notes,
                name,
				organization_id,
                session_id,
                address,
                community_name, 
                series, 
                plan_name,
                case 
                                when reason_lbl_start = 0 then ''
                                when notes_lbl_start = 0 then ''
                                else
                                                substring(bm, reason_lbl_start + len(reason_lbl),notes_lbl_start - (reason_lbl_start + len(reason_lbl))) 
                end as [Reason],

                case 
                                when notes_lbl_start = 0 then ''
                                when homebuyer_lbl_start = 0 then ''
                                else
                                                substring(bm, notes_lbl_start + len(notes_lbl),homebuyer_lbl_start - (notes_lbl_start + len(notes_lbl))) 
                end as [Selection Notes],

                case 
                                when original_price_lbl_start = 0 then null
                                when price_lbl_start = 0 then null
                                else
                                                case ISNUMERIC (substring(bm, original_price_lbl_start + len(original_price_lbl),price_lbl_start - (original_price_lbl_start + len(original_price_lbl))) )
                                                                when 0 then null
                                                                else substring(bm, original_price_lbl_start + len(original_price_lbl),price_lbl_start - (original_price_lbl_start + len(original_price_lbl))) 
                                                end 
                end as [Orig Price],
                case
                                when price_length <= 0 then null
                                else
                                                case isnumeric( SUBSTRING(bm,price_lbl_start+len(price_lbl),price_length) )
                                                                when 0 then null
                                                                else SUBSTRING(bm,price_lbl_start+len(price_lbl),price_length)
                                                end
                end as [New Price]

from cte2
where entry_date >= @start_date  and entry_date <= @end_date
order by entry_date
GO
PRINT N'Creating Procedure [dbo].[rpt_homebuyerActivity]...';


GO
CREATE PROCEDURE [dbo].[rpt_homebuyerActivity]
@builder_name nvarchar(100) = null, 
@start datetime = null, 
@end datetime =  null
AS
BEGIN 
/* 
	Author: Robert Hobbs 
	Created: 01/14/19
	Description: Sales report on homebuyer activity

	TESTING: 
	-- no params 
	rpt_homebuyerActivity

	-- a few years 
	rpt_homebuyerActivity null, '01/01/2017', null 

	-- for a specific builder 
	rpt_homebuyerActivity 'Brookfield Residential - Austin'

	-- verify using defaults and a single user_id 
	select count(*) from users_login_sessions 
	where user_id = 'B63774BE-A337-43DC-9489-0D5B6E052592' 
	and create_date between dateadd(month, datediff(month, 0, getdate())-1,0) AND GETDATE()

*/

SET @start = ISNULL(@start, dateadd(month, datediff(month, 0, getdate())-1,0)) 
SET @end = ISNULL(@end, GETDATE()) -- get NOW or the date they passed in 
SET @end = DATEADD(second,-1,datediff(dd,0,@end)+1) -- set TIME part of the date to 11:59:59 PM

SELECT 
	o.organization_id as org_id, 
	o.name as org_name, 
	p.community_name, 
	p.series, 
	p.plan_name, 
	p.address,
	p.create_date, 
	p.contract_date,
	p.sales_counselor, 
	u.user_id, 
	u.first_name, 
	u.last_name, 
	u.email, 
	(appt.appointment_date + CAST(appt.start_time AS DATETIME)) as hb_first_appointment, 
	u.create_date as registered_on,
	u.author as registered_by,
	COUNT(DISTINCT dateadd(DAY,0, datediff(day,0, logins.create_date))) as days_signed_in,
	@start as report_start_date, 
	@end as report_end_date 
FROM
	VeoSolutionsSecurity_account_organization_users aou with (nolock)
	JOIN VeoSolutionsSecurity_account_organization_users_roles_legacy aour with (nolock)  on aour.account_id = aou.account_id and aour.organization_id = aou.organization_id and aour.user_id = aou.user_id
	JOIN VeoSolutionsSecurity_users u with (nolock) on u.[user_id] = aou.[user_id]
	JOIN VeoSolutionsSecurity_roles_legacy r with (nolock) on r.role_id = aour.role_id
	JOIN VeoSolutionsSecurity_organizations o on o.organization_id = aour.organization_id
	JOIN account_organization_user_profile prof on prof.user_id = aou.user_id AND prof.account_id = aou.account_id AND prof.organization_id = aou.organization_id
	JOIN account_organization_user_profile_plan p on p.account_id = aou.account_id AND p.organization_id = aou.organization_id AND p.user_id = aou.user_id 
	JOIN account_organization_user_profile aoup on aoup.account_id = aou.account_id AND aoup.organization_id = aou.organization_id AND aoup.user_id = aou.user_id 
	LEFT JOIN scheduling_appointments appt ON appt.appointment_id = (SELECT TOP 1 appointment_id FROM scheduling_appointments WHERE buyer_profile_id = prof.profile_id AND is_scheduled = 1 ORDER BY appointment_date DESC)
	JOIN VeoSolutionsSecurity_users_login_sessions logins on logins.user_id = u.user_id 
WHERE
	r.name = 'Homebuyer' 
	AND logins.create_date BETWEEN @start and @end
	AND (o.name = @builder_name OR @builder_name is null) 
GROUP BY 
	o.organization_id, 
	o.name, 
	p.community_name, 
	p.series, 
	p.plan_name, 
	p.address, -- or lot block? 
	p.create_date, 
	p.contract_date, 
	p.sales_counselor,
	u.user_id, 
	u.first_name, 
	u.last_name, 
	u.email,
	(appt.appointment_date + CAST(appt.start_time AS DATETIME)),
	u.create_date,
	u.author


END
GO
PRINT N'Creating Procedure [dbo].[rpt_JPatrickOverrides]...';


GO
create procedure [dbo].[rpt_JPatrickOverrides]
@start_date datetime,
@end_date datetime
as
/*
	autor: The Gladstones
	date: 1/4/2021


	rpt_JPatrickOverrides '12/1/2020','12/31/2020'
*/

with cte as 
(
select
                replace(replace(replace(replace( replace(replace(sl.body_message,char(10),' '),char(13),' '), ' ', '<>'), '><',''),'<>',' '),': ',':') as bm,
                sl.author,
                sl.entry_date,
                sl.problem_type,
                sl.application, 
                sl.product,
                sl.notes,
                o.name,
                aouppcs.session_id,
                aoupp.address,
                aouppcs.community_name, 
                aouppcs.series, 
                aouppcs.plan_name
FROM
                [support_log] sl
                join dbo.account_organization_user_profile_plan_catalog_sessions aouppcs on sl.session_id = aouppcs.session_id  
                join account_organization_user_profile_plan aoupp on aoupp.account_id = aouppcs.account_id and aoupp.organization_id = aouppcs.organization_id and aoupp.user_id = aouppcs.user_id  
                                and aoupp.community_name = aouppcs.community_name and aoupp.series = aouppcs.series and aoupp.plan_name = aouppcs.plan_name
                join VEOSolutionsSecurity_organizations o on aouppcs.organization_id = o.organization_id
where 
                o.name like 'J. PATRICK HOMES'
), cte2 as
(
                select 
                                bm,
                                author,
                                entry_date,
                                problem_type,
                                application, 
                                product,
                                notes,
                                name,
                                session_id,
                                address,
                                community_name, 
                                series, 
                                plan_name,
                                'Reason:' as reason_lbl,
                                charindex('Reason:', bm) as reason_lbl_start,
                                'Notes:' as notes_lbl,
                                charindex('Notes:', bm) as notes_lbl_start,
                                'Homebuyer' as homebuyer_lbl,
                                charindex('homebuyer', bm) as homebuyer_lbl_start,
                                'Original price:' as original_price_lbl,
                                charindex('original price:' , bm) as original_price_lbl_start,
                                'price:' as price_lbl,
                                case when charindex('price:', replace(bm,'original price:','')) > 0 then charindex('price:', replace(bm,'original price:',''))+len('original price:') else 0 end as price_lbl_start,
                                case when charindex('price:', replace(bm,'original price:','')) > 0 then
                                                charindex
                                                (
                                                                ' ',
                                                                substring
                                                                (
                                                                                bm,
                                                                                charindex('price:', replace(bm,'original price:',''))+len('original price:')+len('price:'),
                                                                                len(bm) - charindex('price:', replace(bm,'original price:',''))+len('original price:')+len('price:')
                                                                ) 
                                                ) - 1 
                                                else 0 end as price_length
                from cte
)

select 
                author,
                entry_date,
                problem_type,
                application, 
                product,
                notes as log_notes,
                name,
                session_id,
                address,
                community_name, 
                series, 
                plan_name,
                case 
                                when reason_lbl_start = 0 then ''
                                when notes_lbl_start = 0 then ''
                                else
                                                substring(bm, reason_lbl_start + len(reason_lbl),notes_lbl_start - (reason_lbl_start + len(reason_lbl))) 
                end as [Reason],

                case 
                                when notes_lbl_start = 0 then ''
                                when homebuyer_lbl_start = 0 then ''
                                else
                                                substring(bm, notes_lbl_start + len(notes_lbl),homebuyer_lbl_start - (notes_lbl_start + len(notes_lbl))) 
                end as [Selection Notes],

                case 
                                when original_price_lbl_start = 0 then null
                                when price_lbl_start = 0 then null
                                else
                                                case ISNUMERIC (substring(bm, original_price_lbl_start + len(original_price_lbl),price_lbl_start - (original_price_lbl_start + len(original_price_lbl))) )
                                                                when 0 then null
                                                                else substring(bm, original_price_lbl_start + len(original_price_lbl),price_lbl_start - (original_price_lbl_start + len(original_price_lbl))) 
                                                end 
                end as [Orig Price],
                case
                                when price_length <= 0 then null
                                else
                                                case isnumeric( SUBSTRING(bm,price_lbl_start+len(price_lbl),price_length) )
                                                                when 0 then null
                                                                else SUBSTRING(bm,price_lbl_start+len(price_lbl),price_length)
                                                end
                end as [New Price]

from cte2
where entry_date >= @start_date  and entry_date <= @end_date
order by entry_date
GO
PRINT N'Creating Procedure [dbo].[rpt_selBuilderFeaturesForAllBuildersAllStack]...';


GO
CREATE PROCEDURE [dbo].[rpt_selBuilderFeaturesForAllBuildersAllStack]
AS
/*
	Author: Roger Wang
	Create Date: 2/19/2019
	Description: Returns a list of builder features for all builders for all stack.
*/
SET FMTONLY OFF; -- disables schema-only execution mode; for ssrs (can be removed once all reports are finalized)

declare @db_name varchar(100),
	@stack varchar(50),
	@dev_server bit = 0

declare @db table
(
	[db_name] varchar(100),
	stack varchar(50)
)

if exists (
	select
		[name]
	from
		master.dbo.sysdatabases
	where
		[name] = 'VEOSolutions_DEV'
)
begin
	insert into @db
	select 'VEOSolutions_DEV' as [db_name], 'DEV' as stack
	union
	select 'VEOSolutions_QA' as [db_name], 'QA' as stack
end
else
begin
	insert into @db
	select
		[name] as [db_name],
		case [name]
			when 'VEOSolutions' then 'WBS'
			else (select top 1 [value] from of_split([name], '_') where [value] <> 'VEOSolutions')
		end as stack
	from
		master.dbo.sysdatabases
	where
		[name] like '%VEOSolutions%' and [name] not like '%VEOSolutionsSecurity%'
end

if OBJECT_ID('tempdb.dbo.#builder_features_across_stack', N'U') is not null drop table #builder_features_across_stack

create table #builder_features_across_stack
(
	stack varchar(50),
	account varchar(50),
	builder_name varchar(50),
	feature varchar(200),
	selected bit
)

declare db cursor for
select [db_name], stack from @db

open db
fetch next from db into @db_name, @stack
while @@FETCH_STATUS = 0
begin
	create table #builder_features
	(
		account varchar(50),
		builder_name varchar(50),
		feature varchar(200),
		selected bit
	)

	declare @sql varchar(max)
	set @sql = 'exec ' + @db_name + '.dbo.vds_selBuilderFeaturesForAllBuilders'

	insert into #builder_features
	exec (@sql)

	insert into #builder_features_across_stack
	select @stack, account, builder_name, feature, selected from #builder_features

	if OBJECT_ID('tempdb.dbo.#builder_features', N'U') is not null drop table #builder_features

	fetch next from db into @db_name, @stack
end
close db
deallocate db

select
	stack,
	account,
	builder_name,
	feature,
	selected
from
	#builder_features_across_stack
order by
	stack, account, builder_name, feature

if OBJECT_ID('tempdb.dbo.#builder_features_across_stack', N'U') is not null drop table #builder_features_across_stack
GO
PRINT N'Creating Procedure [dbo].[rpt_selContractedProfilePlanWithoutPrimarySession]...';


GO
CREATE PROCEDURE [dbo].[rpt_selContractedProfilePlanWithoutPrimarySession]
	@organization_name varchar(50)
	, @contracted_after datetime = null
AS
/*
	Author:			Roger Wang
	Date:			3/25/2021
	Description:	Returns a list of homebuyer who has a contracted plan
					but without primary session
*/

if @contracted_after is null
begin
	select @contracted_after = DATEADD(month, -6, CAST(GETDATE() as date))
end

select distinct
	o.[name] as builder_name
	, aou.first_name
	, aou.last_name
	, u.email
	, aoupp.[address]
	, aoupp.lot
	, aoupp.[block]
	, aoupp.community_name
	, aoupp.series
	, aoupp.plan_name
	, aoupp.base_plan_name
	, ISNULL(LTRIM(RTRIM(seu.first_name)) + ' ' + LTRIM(RTRIM(seu.last_name)), '') as sales_counselor
	, aouppcs.session_id
	, case aouppcs.[status]
		when 0 then 'Inactive'
		when 1 then 'Active'
		when 2 then 'Complete'
		when 3 then 'Invoiced'
		when 4 then 'Pending'
		else ''
	end as session_status
from
	account_organization_user_profile_plan aoupp
inner join
	veosolutionssecurity_organizations o on o.organization_id = aoupp.organization_id
inner join
	veosolutionssecurity_account_organization_users aou
	on aou.account_id = aoupp.account_id
	and aou.organization_id = aoupp.organization_id
	and aou.[user_id] = aoupp.[user_id]
inner join
	veosolutionssecurity_account_organization_users_roles_legacy aour
	on aour.account_id = aou.account_id
	and aour.organization_id = aou.organization_id
	and aour.[user_id] = aou.[user_id]
inner join
	veosolutionssecurity_roles_legacy r on r.role_id = aour.role_id
inner join
	veosolutionssecurity_users u on u.[user_id] = aou.[user_id]
left join
	veosolutionssecurity_users seu on seu.email = aoupp.sales_counselor
left join
	primary_plan_catalogs ppc on ppc.profile_plan_id = aoupp.profile_id
left join
	account_organization_user_profile_plan_catalog_sessions aouppcs
	on aouppcs.account_id = aoupp.account_id
	and aouppcs.organization_id = aoupp.organization_id
	and aouppcs.[user_id] = aoupp.[user_id]
	and aouppcs.community_name = aoupp.community_name
	and aouppcs.series = aoupp.series
	and aouppcs.plan_name = aoupp.plan_name
where
	o.[name] like '%' + LTRIM(RTRIM(@organization_name)) + '%'
	and aoupp.status = 'Contracted'
	and aoupp.contract_date >= @contracted_after
	and r.[name] = 'Homebuyer'
	and ppc.session_id is null
order by
	o.[name]
	, aou.first_name
	, aou.last_name
	, aoupp.community_name
	, aoupp.series
	, aoupp.plan_name
	, aoupp.[address]
	, aoupp.lot
	, aoupp.[block]
GO
PRINT N'Creating Procedure [dbo].[rpt_spendByHome]...';


GO
CREATE PROCEDURE [dbo].[rpt_spendByHome]
@builder_name nvarchar(100) = null, 
@community_name nvarchar(100) = null, 
@start datetime = null, 
@end datetime =  null
AS
BEGIN 
/* 
	Author: Robert Hobbs 
	Created: 01/25/19
	Description: Sales report for upgrade spending broken out by Builder/Community
	This procedure reports on plans that were marked Contracted or Complete during the period.
	For Completed plans, it totals the estimated + catalog + bom modifications and calculates an average/plan. 
	The proc supports partial name searches for Builder and Community. 
	It defaults to ALL Builders / ALL Communities for the most recent week period. 

	Updated: 02/13/19
	Changed the completed plans logic to only include plans with earliest session completion dates in range 

	-- TESTING (by environment) 
	-- No params; All builders, communities for the last week 
	-- both:	[rpt_spendByHome]

	-- partial builder match 
	-- dev:		[rpt_spendByHome] 'Stag' 
	-- prod:	[rpt_spendByHome] 'Gehan', null, '01/01/2019', null 

	-- partial builder, partial community 
	-- dev:		[rpt_spendByHome] 'Staggered', 'Lakes'
	-- dev:		[rpt_spendByHome] 'Brook', 'Grove'
	-- prod:	[rpt_spendByHome] 'Brook', 'Kissing'

	-- mismatched builder/community name search. should be 0 results 
	-- dev:		[rpt_spendByHome] 'Stagg', 'Grove' 
	

	-- for a specific builder - full name  
	-- dev:		[rpt_spendByHome] 'Brookfield Residential - Austin'
	-- prod:	[rpt_spendByHome] 'Gehan Homes-Houston', null, '01/01/2019', null 
	-- prod: 	[rpt_spendByHome] 'Gehan Homes SA', null, '09/01/2018', null 

	-- for a specific builder and community 
	-- dev:		[rpt_spendByHome] 'STAGGERED-QA', 'Lakes of Pine Forest'
	-- prod:	[rpt_spendByHome] 'Gehan Homes SA', 'Afton Oaks', '09/01/2018', null 

	-- defaults + last week only 
	-- both:	[rpt_spendByHome] null, null, '01/21/19', null 

	-- performance testing (long running, lots of data) 
	-- both:	[rpt_spendByHome] null, null, '01/01/18', null -- 2018 to now 
	-- both:	[rpt_spendByHome] null, null, '01/01/15', null -- 2015 to now 

	-- specific queries of interest to sales: 
	-- prod: [rpt_spendByHome] 'Gehan Homes SA', null, '09/01/2018', null 

*/

SET FMTONLY OFF; -- disables schema-only execution mode; for ssrs (can be removed once all reports are finalized)

DECLARE @debug BIT = 0  -- 0 = no debug, 1 = debug mode 

-- 1. Setup the Dates 
SET @start = CAST( ISNULL( @start, DATEADD(week,-1,GETDATE() ) ) AS DATE) -- 1 week ago 
SET @end = ISNULL(@end, GETDATE()) -- defaults to today 
SET @end = DATEADD(second,-1,datediff(dd,0,@end)+1) -- set TIME part of the end date to 11:59:59 PM (to get full day) 

IF (@debug=1) 
BEGIN 
	SELECT 'DATES' 
	SELECT @start as [start], @end as [end]  
END 

-- 2. We allow searching on partial builder name matches. 
declare @TABLE_BUILDERS_MATCH TABLE 
( 
	id UNIQUEIDENTIFIER,
	builder_name NVARCHAR(50)
)

INSERT INTO 
	@TABLE_BUILDERS_MATCH 
SELECT 
	o.organization_id, 
	o.name 
FROM 
	veosolutionssecurity_organizations o
WHERE
	(o.name like '%' + @builder_name + '%' OR @builder_name IS NULL) 

IF (@debug=1) 
BEGIN 
	SELECT '@TABLE_BUILDERS_MATCH' 
	SELECT * FROM @TABLE_BUILDERS_MATCH 
END 

-- 3. Identify CONTRACTED plans in the time range 
CREATE TABLE #TABLE_PLANS_CONTRACTED 
(
	builder NVARCHAR(50),
	community NVARCHAR(50), 
	plan_identifier UNIQUEIDENTIFIER
)

INSERT INTO 
	#TABLE_PLANS_CONTRACTED 
SELECT 
	DISTINCT 
	b.builder_name,
	p.community_name, 
	p.profile_id -- id of the plans 
FROM 
	account_organization_user_profile_plan p 
	JOIN @TABLE_BUILDERS_MATCH b ON b.id = p.organization_id
WHERE
	p.contract_date BETWEEN @start AND @end  
	AND (p.community_name LIKE '%' + @community_name + '%' OR @community_name IS NULL) 


IF (@debug=1) 
BEGIN 
	SELECT '#TABLE_PLANS_CONTRACTED' 
	SELECT * FROM #TABLE_PLANS_CONTRACTED  ORDER BY plan_identifier asc -- to look for multiple sessions/plan 
END 

-- 4. Identify Completed plans using Session first_completed_date (min) in time range 
CREATE TABLE #TABLE_PLANS_COMPLETED
(
	builder_id UNIQUEIDENTIFIER,  
	community NVARCHAR(50), 
	plan_identifier UNIQUEIDENTIFIER
)

-- Logic: 
-- Find the completed/invoiced plans for our builder/community where the earliest completed session has a first_completed_date in our date range 
-- inspired by this: https://dba.stackexchange.com/questions/29789/how-group-with-mindate-and-select-an-another-column-in-the-same-table
INSERT INTO 
	#TABLE_PLANS_COMPLETED
SELECT DISTINCT 
	p.organization_id, 
	p.community_name, 
	p.profile_id as plan_identifier  -- id of the plans
FROM 
	account_organization_user_profile_plan p 
	JOIN(
	SELECT 
		s.* 
	FROM 
		account_organization_user_profile_plan_catalog_sessions s
	WHERE 
		s.first_completed_date = 
		( SELECT MIN(s2.first_completed_date)
				FROM account_organization_user_profile_plan_catalog_sessions s2 
				WHERE s2.account_id = s.account_id AND s2.organization_id = s.organization_id 
				AND s2.user_id = s.user_id AND s2.community_name = s.community_name 
				AND s2.series = s.series AND s2.plan_name = s.plan_name
				AND s2.first_completed_date <> '1900-01-01 00:00:00.000') 
	) s3 ON s3.account_id = p.account_id AND s3.organization_id = p.organization_id 
				AND s3.user_id = p.user_id AND s3.community_name = p.community_name 
				AND s3.series = p.series AND s3.plan_name = p.plan_name
	JOIN @TABLE_BUILDERS_MATCH b ON b.id = p.organization_id
WHERE 
	p.status IN ('COMPLETE', 'INVOICED') 
	AND (p.community_name LIKE '%' + @community_name + '%' OR @community_name IS NULL) 
	AND s3.first_completed_date BETWEEN @start AND @end 

IF (@debug=1) 
BEGIN 
	SELECT '#TABLE_PLANS_COMPLETED' 
	SELECT * FROM #TABLE_PLANS_COMPLETED  ORDER BY plan_identifier asc -- to look for multiple sessions/plan 
END 

-- 5. Get all complete sessions for the plans identified above 
CREATE TABLE #TABLE_PLANS_COMPLETED_SESSIONS
(
	builder NVARCHAR(50),
	community NVARCHAR(50), 
	plan_identifier UNIQUEIDENTIFIER, 
	session_id UNIQUEIDENTIFIER, 
	first_completed_date DATETIME, 
	estimated_total DECIMAL(18,2), 
	catalog_total DECIMAL(18,2), 
	bom_mods_total DECIMAL(18,2), 
	total_spend DECIMAL(18,2)
)

CREATE CLUSTERED INDEX cx_temp_plans_completed ON #TABLE_PLANS_COMPLETED_SESSIONS (plan_identifier, session_id);

INSERT INTO 
	#TABLE_PLANS_COMPLETED_SESSIONS
SELECT 
	DISTINCT 
	b.builder_name,
	p.community, 
	p.plan_identifier,  -- id of the plans, 
	s.session_id,
	s.first_completed_date, 
	0.00, -- estimated
	0.00, -- catalog
	0.00, -- bom mods 
	0.00  -- total 
FROM
	#TABLE_PLANS_COMPLETED p 
	JOIN account_organization_user_profile_plan aoupp ON aoupp.profile_id = p.plan_identifier
	JOIN @TABLE_BUILDERS_MATCH b ON b.id = p.builder_id
	JOIN account_organization_user_profile_plan_catalog_sessions s ON s.account_id = aoupp.account_id AND s.organization_id = aoupp.organization_id AND s.user_id = aoupp.user_id AND s.community_name = aoupp.community_name AND s.series = aoupp.series and s.plan_name = aoupp.plan_name
WHERE 
	s.status > 1 
	AND s.first_completed_date <> '1900-01-01 00:00:00.000' -- get all completed sessions for the completed plans 

-- 6. Calculate estimated item spend for completed plans 
CREATE TABLE #TABLE_ESTIMATED_SPEND 
(
	plan_identifier UNIQUEIDENTIFIER, 
	session_id UNIQUEIDENTIFIER, 
	spend DECIMAL(18,2) 
)

CREATE CLUSTERED INDEX cx_temp_estimated_spend ON #TABLE_ESTIMATED_SPEND (plan_identifier);

INSERT INTO 
	#TABLE_ESTIMATED_SPEND 
SELECT 
	completed.plan_identifier,
	completed.session_id,  
	SUM(csa.selection_total) as spend 
FROM 
	#TABLE_PLANS_COMPLETED_SESSIONS completed 
	JOIN catalog_selections_areas csa ON csa.session_id = completed.session_id 
WHERE 
	csa.area_selected = 1
	AND csa.selected > 0 
GROUP BY 
	completed.plan_identifier,  -- really the plan identifier
	completed.session_id 

IF (@debug=1) 
BEGIN 
	SELECT '@estimated_spend' 
	SELECT * FROM #TABLE_ESTIMATED_SPEND  ORDER BY plan_identifier asc -- to look for multiple sessions/plan 
END 

-- 7. Calculate the catalog items spend for completed plans 
CREATE TABLE #TABLE_CATALOG_SPEND 
(
	plan_identifier UNIQUEIDENTIFIER, 
	session_id UNIQUEIDENTIFIER, 
	spend DECIMAL(18,2) 
)

CREATE CLUSTERED INDEX cx_temp_catalog_spend ON #TABLE_CATALOG_SPEND (plan_identifier);

INSERT INTO 
	#TABLE_CATALOG_SPEND
SELECT 
	completed.plan_identifier,
	completed.session_id,  
	SUM(qty * price) as spend
FROM 
	#TABLE_PLANS_COMPLETED_SESSIONS completed  
	JOIN catalog_selections cs ON cs.session_id = completed.session_id 
	WHERE 
		cs.selected = 1
	GROUP BY 
		completed.plan_identifier,  -- really the plan identifier
		completed.session_id 

-- 8. Calculate the bom modifications totals for completed plans 
DECLARE @mods_spend TABLE 
(
	plan_identifier UNIQUEIDENTIFIER, 
	session_id UNIQUEIDENTIFIER,
	spend DECIMAL(18,2) 
)

INSERT INTO 
	@mods_spend 
SELECT 
		completed.plan_identifier, 
		completed.session_id, 
		SUM(mods.quantity * mods.price) AS spend 
	FROM
		#TABLE_PLANS_COMPLETED_SESSIONS completed
		JOIN catalog_selections_area_bom_modifications mods ON mods.session_id = completed.session_id 
	GROUP BY 
		completed.plan_identifier, -- really the plan identifier 
		completed.session_id 

UPDATE 
	#TABLE_PLANS_COMPLETED_SESSIONS 
SET 
	estimated_total = ISNULL(e.spend, 0.00), 
	catalog_total = ISNULL(cat.spend, 0.00), 
	bom_mods_total = ISNULL(mods.spend, 0.00),
	total_spend = ISNULL(e.spend,0.00) + ISNULL(cat.spend, 0.00) + ISNULL(mods.spend, 0.00) 
FROM
	#TABLE_PLANS_COMPLETED_SESSIONS completed  
	LEFT JOIN #TABLE_ESTIMATED_SPEND e ON e.plan_identifier = completed.plan_identifier AND e.session_id = completed.session_id
	LEFT JOIN #TABLE_CATALOG_SPEND cat ON cat.plan_identifier = completed.plan_identifier AND cat.session_id = completed.session_id
	LEFT JOIN @mods_spend mods ON mods.plan_identifier = completed.plan_identifier AND mods.session_id = completed.session_id 

IF (@debug=1) 
BEGIN 
SELECT '@TABLE_PLANS_COMPLETED_SESSIONS WITH SPEND AMOUNTS' 
SELECT * FROM #TABLE_PLANS_COMPLETED_SESSIONS ORDER BY plan_identifier, first_completed_date ASC 
END 

-- 9. POPULATE THE RESULTS TABLE WITH BUILDERS/COMMUNITIES
DECLARE @TABLE_RESULTS TABLE 
(	org_id UNIQUEIDENTIFIER, 
	builder NVARCHAR(50),
	community NVARCHAR(50), 
	plans_contracted INT, 
	plans_completed INT,
	avg_spend DECIMAL(18,2), 
	report_start_date DATETIME, 
	report_end_date DATETIME 

)

INSERT INTO @TABLE_RESULTS 
SELECT DISTINCT
	null,  
	builder, 
	community, 
	0,
	0, 
	0, 
	@start, 
	@end 
FROM 
	#TABLE_PLANS_CONTRACTED 
UNION 
SELECT DISTINCT
	null, 
	builder, 
	community, 
	0,
	0,
	0, 
	@start, 
	@end 
FROM 
	#TABLE_PLANS_COMPLETED_SESSIONS

-- SET BUILDER ID 
UPDATE	@TABLE_RESULTS
	SET org_id = b.id 
FROM 
	@TABLE_RESULTS results 
	JOIN @TABLE_BUILDERS_MATCH b ON b.builder_name = results.builder 

IF (@debug=1) 
BEGIN 
SELECT '@TABLE_RESULTS WITH SEEDED BUILDER/COMMUNITY' 
SELECT * FROM @TABLE_RESULTS 
END 

-- 10. UPDATE CONTRACTED PLANS COUNT
;WITH x AS 
(
  SELECT builder, community, cnt = COUNT(*) 
  FROM #TABLE_PLANS_CONTRACTED
  GROUP BY builder, community
) 
UPDATE 
	results 
SET 
	plans_contracted = x.cnt 
FROM 
	@TABLE_RESULTS results 
	INNER JOIN x ON x.builder = results.builder AND x.community = results.community;


-- 11. Update Completed Plans Count 
;WITH p AS 
(
  SELECT 
	builder_id, 
	community, 
	cnt = COUNT(*)
  FROM 
	#TABLE_PLANS_COMPLETED
  GROUP BY 
	builder_id, community
) 
UPDATE 
	results 
SET
	plans_completed = p.cnt 
FROM 
	@TABLE_RESULTS results 
	JOIN p on p.builder_id = results.org_id AND p.community = results.community 

-- 12. update average spend 
;WITH x AS 
(
  SELECT 
	builder, 
	community, 
	total_spend = SUM(total_spend) 
  FROM 
	#TABLE_PLANS_COMPLETED_SESSIONS
  GROUP BY 
	builder, community
) 
UPDATE 
	results 
SET 
	avg_spend = x.total_spend / plans_completed
FROM 
	@TABLE_RESULTS results 
	INNER JOIN x ON x.builder = results.builder AND x.community = results.community;


-- 13. Cleanup 
DROP TABLE #TABLE_PLANS_CONTRACTED
DROP TABLE #TABLE_PLANS_COMPLETED
DROP TABLE #TABLE_PLANS_COMPLETED_SESSIONS
DROP TABLE #TABLE_ESTIMATED_SPEND
DROP TABLE #TABLE_CATALOG_SPEND

SELECT * FROM @TABLE_RESULTS 

END
GO
PRINT N'Creating Procedure [dbo].[vds_addAccountOrganizationUser]...';


GO
CREATE PROCEDURE [dbo].[vds_addAccountOrganizationUser]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @user_id UNIQUEIDENTIFIER,
    @first_name VARCHAR(50),
	@last_name VARCHAR(50),
    @active BIT,
    @external_id VARCHAR(50),
    @is_designer BIT,
    @security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Create date: 03/28/2016
	Description: This procedure adds an account organization user.
	
	Modified: Shelby Mansker
	Date: 2/15/2017
	Description: There is no need to return the account org user fields. Doing so means we must maintain this
		code when the account user information changes, in addition to other places. For example, VDS expects
		that the email address and user's roles be returned with them. Also, the transaction code doesn't handle
		rollbacks on errors, so I added a try/catch block that raises an error and rolls back the transaction	
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

    BEGIN TRANSACTION

	BEGIN TRY
        -- Update all account organization users with a matching user id with the same external id.
        UPDATE
            VeoSolutionsSecurity_account_organization_users
        SET
            external_id = @external_id
        WHERE
            [user_id] = @user_id

        -- Add the account organization user.
        INSERT INTO VeoSolutionsSecurity_account_organization_users
        (
            account_id, organization_id, [user_id], first_name, last_name, active, external_id, is_designer
        )
        VALUES
        (
            @account_id, @organization_id, @user_id, @first_name, @last_name, @active, @external_id, @is_designer
        )
	END TRY
	BEGIN CATCH
        -- Since an error occured, we need to rollback the transaction
        IF @@TRANCOUNT > 0
            ROLLBACK TRANSACTION

        -- Rethrow the error
        DECLARE
            @ErrorMessage    NVARCHAR(4000),
            @ErrorNumber     INT,
            @ErrorSeverity   INT,
            @ErrorState      INT,
            @ErrorLine       INT,
            @ErrorProcedure  NVARCHAR(200);

        -- Assign variables to error-handling functions that 
        -- capture information for RAISERROR.
        SELECT 
            @ErrorNumber = ERROR_NUMBER(),
            @ErrorSeverity = ERROR_SEVERITY(),
            @ErrorState = ERROR_STATE(),
            @ErrorLine = ERROR_LINE(),
            @ErrorProcedure = ISNULL(ERROR_PROCEDURE(), '-');

        -- Build the message string that will contain original
        -- error information.
        SELECT @ErrorMessage = N'Add Account Organization User Failed: ' + ERROR_MESSAGE();

        -- Raise an error: msg_str parameter of RAISERROR will contain
        -- the original error information.
        RAISERROR 
            (
            @ErrorMessage, 
            @ErrorSeverity, 
            1,               
            @ErrorNumber,    -- parameter: original error number.
            @ErrorSeverity,  -- parameter: original error severity.
            @ErrorState,     -- parameter: original error state.
            @ErrorProcedure, -- parameter: original error procedure name.
            @ErrorLine       -- parameter: original error line number.
            );		
	END CATCH;

    /*
     * If things went well, commit the transaction
     */
	IF @@TRANCOUNT > 0
		COMMIT TRANSACTION
END
GO
PRINT N'Creating Procedure [dbo].[vds_addAccountOrganizationUserRole]...';


GO
-- ===============================================================
-- Author:		Saul Sanchez
-- Create date: 03/28/2016
-- Description:	This procedure adds an account organization user
--              role.
-- ===============================================================
-- HISTORY
-- 09.28.16 - added join to Roles table in final select - RH 
-- ===============================================================
-- TESTING 
-- vds_addAccountOrganizationUserRole 'BAB32B7E-3ADA-497C-862E-E5083971CC59', 'DD2D25BE-DFA6-4ECE-B91D-5A8DE929AC29', 'F5352E11-1A3A-4E69-A11F-1EE17F2BD4BB', 'A0A9C6C5-A686-48EB-B125-6901F74AA435', '01234567-89AB-CDEF-0000-123456789ABC'
-- ===============================================================
CREATE PROCEDURE [dbo].[vds_addAccountOrganizationUserRole]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @user_id UNIQUEIDENTIFIER,
    @role_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
BEGIN
	DECLARE @edit_user_id VARCHAR(75)
	SET @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	IF (@edit_user_id IS NULL)
		BEGIN
			RAISERROR('Invalid credentials.',16,1)
			RETURN
		END

    INSERT INTO VeoSolutionsSecurity_account_organization_users_roles_legacy
    (
        account_id, organization_id, [user_id], role_id, author, create_date, modifier, modified_date
    )
    VALUES
    (
        @account_id, @organization_id, @user_id, @role_id, @edit_user_id, GETDATE(), @edit_user_id, GETDATE()
    )

    SELECT
         ur.account_id, 
		 ur.organization_id, 
		 ur.[user_id], 
		 ur.role_id, 
		 r.name, 
		 r.alpha_role_id, 
		 r.numeric_role_id,
		 ur.author, ur.create_date, ur.modifier, ur.modified_date
    FROM
        VeoSolutionsSecurity_account_organization_users_roles_legacy ur WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_roles_legacy r on r.role_id = ur.role_id
    WHERE
        account_id = @account_id
        AND organization_id = @organization_id
        AND [user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_addFloorplan]...';


GO
CREATE PROCEDURE [dbo].[vds_addFloorplan]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER, 
	@user_id UNIQUEIDENTIFIER,
	@community VARCHAR(50),
	@series VARCHAR(50),
	@plan VARCHAR(50),
	@name VARCHAR(100),
	@background_image VARBINARY(MAX),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Create Date: 10/24/2017
	Description: Adds a floorplan record.
*/

/*
	Modified: Art deHoyos
	Date: 1/19/2019
	Description: Pass the background image to the report image field so that it will show up in the selections report immediately.
*/

BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	DECLARE @new_id TABLE (
		id UNIQUEIDENTIFIER);

	INSERT INTO [dbo].[floorplans] (
		[name],
		[background_image],
		[account_id],
		[organization_id],
		[user_id],
		[community],
		[series],
		[plan],
		[report_image])
	OUTPUT INSERTED.id INTO @new_id
    VALUES (
		@name,
		@background_image,
		@account_id,
		@organization_id,
		@user_id,
		@community,
		@series,
		@plan,
		@background_image
	)
	
	SELECT id FROM @new_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_addRoom]...';


GO
CREATE PROCEDURE [dbo].[vds_addRoom]
	@name VARCHAR(100),
	@icon_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	DECLARE @new_id UNIQUEIDENTIFIER = NEWID()

	INSERT INTO [rooms] (
		[id],
		[name], 
		[icon_id]
	)
	VALUES (
		@new_id,
		@name,
		@icon_id
	)

	SELECT * FROM [rooms] where [id] = @new_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_addSessionNonEstimatedOptionDesignerImage]...';


GO
CREATE PROCEDURE [dbo].[vds_addSessionNonEstimatedOptionDesignerImage]
	@session_id UNIQUEIDENTIFIER, 
    @row_id UNIQUEIDENTIFIER,
    @file_name VARCHAR(255),
    @mime_type VARCHAR(255),
    @image_data VARBINARY(MAX) NULL,
    @audit_user VARCHAR(50)
AS
/*
	Author: Shelby Mansker
	Date: 11/6/2018
	Description: Inserts, or updates, a designer image for a specific non-estimated option
*/
BEGIN
	IF (NOT EXISTS (SELECT TOP(1) * FROM catalog_selections_designer_images WHERE session_id = @session_id AND row_id = @row_id))
		BEGIN
			INSERT INTO dbo.catalog_selections_designer_images
			(
				session_id,
				row_id,
				[file_name],
				mime_type,
				image_data,
				author,
				create_date,
				modifier,
				modified_date
			)
			VALUES
			(
				@session_id,
				@row_id,
				@file_name,
				@mime_type,
				@image_data,
				@audit_user,
				GETDATE(),
				@audit_user,
				GETDATE()
			)
		END
	ELSE
		BEGIN
			UPDATE dbo.catalog_selections_designer_images
			SET
				[file_name] = @file_name,
				mime_type = @mime_type,
				image_data = @image_data,
				modifier = @audit_user,
				modified_date = GETDATE()
			WHERE
				session_id = @session_id
				AND row_id = @row_id
		END
END
GO
PRINT N'Creating Procedure [dbo].[vds_clearSession]...';


GO

create PROCEDURE [dbo].[vds_clearSession]
	@session_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:      Adrian Garza
	Create date: 2/4/2015
	Description: Clears all session selections


*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END


    DECLARE @empty_guid UNIQUEIDENTIFIER = '00000000-0000-0000-0000-000000000000'
	

    -- Begin a transaction since this stored proc executes multiple calls that 
    -- modify the database.
    BEGIN TRANSACTION

        -- Delete the area details.
        -- Do not give an error if no area details were deleted.
		print 'delete'

        DELETE FROM
            dbo.catalog_selections_area_detail_options
	    WHERE
		    session_id = @session_id

        DELETE FROM
            dbo.catalog_selections_area_details
	    WHERE
		    session_id = @session_id

        -- Reset the area values.
        -- Give an error if the record could not be updated.
		print 'update'
        UPDATE
            dbo.catalog_selections_areas
        SET
		    selected = 0,
		    selection_total = 0,
		    selected_field_group = @empty_guid,
            pattern_id = 0,
			notes = ''
	    WHERE
		    session_id = @session_id


		--clear any selected catalog items.

		update catalog_selections
		set selected = 0
		where session_id = @session_id



    COMMIT TRANSACTION

END
GO
PRINT N'Creating Procedure [dbo].[vds_copyDesignSelectionsSession]...';


GO
CREATE PROCEDURE [dbo].[vds_copyDesignSelectionsSession]
	@source_session_id UNIQUEIDENTIFIER,
	@target_session_id UNIQUEIDENTIFIER,
	@target_user_id UNIQUEIDENTIFIER,
	@include_selections BIT = 0,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Created: 2/16/2015
	Description: Makes a copy of a specific session for the target user. If include_selections = 1, copy the sessions selections over too.

	Modified: Shelby Mansker
	Date: 8/18/2015
	Description: Added code to copy the catalog_selections_bom_details and catalog_selections_bom_detail_options tables.

	Modified: Shelby Mansker
	Date: 11/2/2015
	Description: The copy process will now also copy the BOM Modifications (cabinet swaps)

	Modified: Shelby Mansker
	Date: 1/12/2016
	Description: Updated to copy the new catalog_selections_price_level_boms. It also now works with the modified catalog_selections_bom_detail_options
		tables, which addresses a VDS 2.4.0 bug. It will also verify that these tables exist, before attempting to copy. This will allow us to
		support the upcoming catalog_selections_price_level_boms table, and continue to support the legacy price level bom tables, since they may or may
		not exist.

	Modified: Shelby Mansker
	Date: 3/10/2016
	Description: Updated the bom modifications code to always copy over the session bom modifications (swaps, local options, etc.), and to only
		copy over the session bom modification selections when the include_selections parameter is true.

	Modified: Saul Sanchez
	Date: 9/3/3016
	Description: Removed references to the catalog_selections_bom_details and catalog_selections_bom_detail_options tables, which no longer exist.

	Modified: Shelby Mansker
	Date: 6/12/2017
	Description: Added logic to copy of area properties. Also, added logic to set the selected status of an area to partial (1) if it had slabs selected
		in the source target and was complete (2).

	Modified: Shelby Mansker
	Date: 3/15/2018
	Description: Fixed a bug where the columns option_id and stage weren't being copied with catalog_selections.

	Modified: Roger Wang
	Date: 2/17/2023
	Description: Copy designer images along with session

	Modified: Reid Wilson
	Date: 3/14/2023
	Description: Copy lay direction along with session

	Modified: Daniel Arwe
	Date: 1/31/2024
	Description: Made target_session_id a required parameter. Added null check to enforce this.  Removed validation
		of target_user_id against source session's account_id and organization_id (handling this upstream in C# instead,
		in order to keep TransactionScope from wrapping a distributed transaction across VeoSolutions and VeoSolutionsSecurity DBs).
		
	Modified: Daniel Arwe
	Date: 8/18/2025
	Description: Added precon_notes field to be copied.
*/
BEGIN

	/*
	* Validate the security token
	*/
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	/*
	* Wrap all of this in a Transaction
	*/
	BEGIN TRANSACTION

	/*
	* Put the majority of the copy session code in a try catch block, so we can manage errors and rollback the transaction if necessary
	*/
	BEGIN TRY

		/*
		* Make sure the target_session_id is not null.  If it is, throw an error
		*/

		IF @target_session_id IS NULL
		BEGIN
			RAISERROR('The target_session_id is required, but was not provided.', 16, 1)
			RETURN
		END

		-- Declare all of the variables that will be used by this proc
		DECLARE @active_user_email VARCHAR(100)
		DECLARE @source_account_id UNIQUEIDENTIFIER
		DECLARE @source_organization_id UNIQUEIDENTIFIER
		DECLARE @source_user_id UNIQUEIDENTIFIER
		DECLARE @source_community_name VARCHAR(50)
		DECLARE @source_series VARCHAR(50)
		DECLARE @source_plan_name VARCHAR(50)
		DECLARE @empty_guid UNIQUEIDENTIFIER = '00000000-0000-0000-0000-000000000000'

		-- Get the active user's email from the security token
		SET @active_user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

		/*
		* Make sure the source session id exists. If it doesn't, throw an error
		*/
		IF NOT EXISTS (SELECT session_id FROM dbo.account_organization_user_profile_plan_catalog_sessions WITH (NOLOCK) WHERE session_id = @source_session_id )
			BEGIN
				RAISERROR('Invalid Session ID', 16, 1)
				RETURN
			END

		/*
		* Now fetch source information from the source session
		*/
		SELECT
			@source_account_id = aoupp.account_id,
			@source_organization_id = aoupp.organization_id,
			@source_user_id = aouppcs.[user_id],
			@source_community_name = aouppcs.community_name,
			@source_series = aouppcs.series,
			@source_plan_name = aouppcs.plan_name
		FROM
			account_organization_user_profile_plan_catalog_sessions aouppcs WITH (NOLOCK)
			LEFT JOIN account_organization_user_profile_plan aoupp WITH (NOLOCK) ON aoupp.account_id = aouppcs.account_id AND aoupp.organization_id = aouppcs.organization_id AND aoupp.[user_id] = aouppcs.[user_id] AND aoupp.community_name = aouppcs.community_name AND aoupp.series = aouppcs.series AND aoupp.plan_name = aouppcs.plan_name
		WHERE
			session_id = @source_session_id

		/*
		* Make sure the source session id exists
		*/
		IF NOT EXISTS (SELECT * FROM dbo.account_organization_user_profile_plan_catalog_sessions WHERE session_id = @source_session_id)
			BEGIN
				RAISERROR('The specified source session is not a valid session.', 16, 1)
				RETURN
			END

		/*
		* Make sure the target user has the profile from the source.
		*/
		IF NOT EXISTS (SELECT * FROM dbo.account_organization_user_profile WHERE account_id = @source_account_id AND organization_id = @source_organization_id AND [user_id] = @target_user_id)
			BEGIN
				-- The target user does not have this profile, so we need to create it
				INSERT INTO dbo.account_organization_user_profile (account_id, organization_id, [user_id], interest_rate, loan_term, completed_steps, author, create_date, modifier, modified_date)
					SELECT  account_id, organization_id, @target_user_id, interest_rate, loan_term, completed_steps, @active_user_email, GETDATE(), @active_user_email, GETDATE()
					FROM
						dbo.account_organization_user_profile WITH (NOLOCK)
					WHERE
						account_id = @source_account_id
						AND organization_id = @source_organization_id
						AND [user_id] = @source_user_id
			END

		/*
		* Make sure the target user has the profile plan from the source.
		*/
		IF NOT EXISTS (SELECT * FROM dbo.account_organization_user_profile_plan WHERE account_id = @source_account_id AND organization_id = @source_organization_id AND [user_id] = @target_user_id AND community_name = @source_community_name AND series = @source_series AND plan_name = @source_plan_name)
			BEGIN
				-- The target user does not have this profile plan, so we need to create it
				INSERT INTO dbo.account_organization_user_profile_plan (
					account_id,
					organization_id,
					[user_id],
					community_name,
					series,
					plan_name,
					base_plan_name,
					spec_id,
					sales_price,
					sales_options,
					upgrades_incentive,
					additional_design_deposit,
					deposit_notes,
					home_down_payment,
					home_allowance,
					catalog_session_id,
					catalog_session_date,
					catalog_total, job_no,
					[address],
					address_lot_block,
					property_desc_1,
					property_desc_2,
					block,
					lot,
					city,
					[state],
					zip_code,
					sales_counselor,
					contract_date,
					receipt_date,
					country_home_phone,
					home_phone,
					country_work_phone,
					work_phone,
					spouse_first_name,
					spouse_last_name,
					country_spouse_phone,
					spouse_phone,
					dc_job_id,
					dc_contact_list,
					[status],
					echelon_exported,
					spec_home,
					job_type,
					elevation,
					stage,
					superintendent,
					author,
					create_date,
					modifier,
					modified_date,
					upgrade_deposit_percentage
				)
					SELECT
						account_id,
						organization_id,
						@target_user_id,
						community_name,
						series,
						plan_name,
						base_plan_name,
						spec_id,
						sales_price,
						sales_options,
						upgrades_incentive,
						additional_design_deposit,
						deposit_notes,
						home_down_payment,
						home_allowance,
						catalog_session_id,
						catalog_session_date,
						catalog_total,
						job_no,
						[address],
						address_lot_block,
						property_desc_1,
						property_desc_2,
						block,
						lot,
						city,
						[state],
						zip_code,
						sales_counselor,
						contract_date,
						receipt_date,
						country_home_phone,
						home_phone,
						country_work_phone,
						work_phone,
						spouse_first_name,
						spouse_last_name,
						country_spouse_phone,
						spouse_phone,
						dc_job_id,
						dc_contact_list,
						[status],
						echelon_exported,
						spec_home,
						job_type,
						elevation,
						stage,
						superintendent,
						@active_user_email,
						GETDATE(),
						@active_user_email,
						GETDATE(),
						upgrade_deposit_percentage
					FROM
						dbo.account_organization_user_profile_plan WITH (NOLOCK)
					WHERE
						account_id = @source_account_id
						AND organization_id = @source_organization_id
						AND [user_id] = @source_user_id
						AND community_name = @source_community_name
						AND series = @source_series
						AND plan_name = @source_plan_name
			END

		/*
		* Now insert the new session into the target profile plan
		*/
		INSERT INTO dbo.account_organization_user_profile_plan_catalog_sessions (account_id, organization_id, [user_id], community_id, community_name, series, plan_name, plan_version, session_id, [status], session_notes, precon_notes, deposit, deposit_notes, designer, spec_id, effective_date, completed_date, first_completed_date, export_date, address_id, rounding_type, rounding_places, builder_markup_hb_pricing, buyer_signature, buyer_signature_date, pricing_generated, pricing_published, author, create_date, modifier, modified_date, catalog_source, designer_id)
			SELECT
				account_id,
				organization_id,
				@target_user_id,
				community_id,
				community_name,
				series,
				plan_name,
				plan_version,
				@target_session_id,
				0, -- Set the new status to Inactive
				session_notes,
				precon_notes,
				deposit,
				deposit_notes,
				designer,
				spec_id,
				effective_date,
				completed_date,
				first_completed_date,
				export_date,
				address_id,
				rounding_type,
				rounding_places,
				builder_markup_hb_pricing,
				buyer_signature,
				buyer_signature_date,
				pricing_generated,
				pricing_published,
				@active_user_email,
				GETDATE(),
				@active_user_email,
				GETDATE(),
				catalog_source,
				designer_id
			FROM
				dbo.account_organization_user_profile_plan_catalog_sessions WITH (NOLOCK)
			WHERE
				session_id = @source_session_id

		/*
		* Next we need to copy over the session's documents
		*/
		INSERT INTO dbo.account_organization_user_profile_plan_catalog_sessions_documents (document_id, session_id, application_id, product_id, area_id, sub_area_id, location_id, document_type, document_data, author, create_date, modifier, modified_date)
			SELECT
				NEWID(),
				@target_session_id,
				application_id,
				product_id,
				area_id,
				sub_area_id,
				location_id,
				document_type,
				document_data,
				@active_user_email,
				GETDATE(),
				@active_user_email,
				GETDATE()
			FROM
				dbo.account_organization_user_profile_plan_catalog_sessions_documents WITH (NOLOCK)
			WHERE
				session_id = @source_session_id

		/*
		* Then we need to copy over the session selections.
		* NOTE: This copy step will maintain the row_id, instead of creating a new one. This means that row_ids are not guaranteed to be unique by themselves. They are only unique within a session.
		*/
		INSERT INTO dbo.catalog_selections (session_id, row_id, account_id, organization_id, community, series, [plan], [application], product, area, area_id, sub_area, sub_area_id, item_type, item_no, item, vendor, [standard], qty, cost, price, selected, notes, option_pricing_display, mutually_exclusive, build_data, original_build_data, [source], build_id, gpc, model, make_std, is_credit, option_id, stage, author, create_date, modifier, modified_date, is_package)
			SELECT
				@target_session_id,
				row_id,
				account_id,
				organization_id,
				community,
				series,
				[plan],
				[application],
				product,
				area,
				area_id,
				sub_area,
				sub_area_id,
				item_type,
				item_no,
				item,
				vendor,
				[standard],
				qty,
				cost,
				price,
				IIF(@include_selections = 1, selected, 0), -- don't copy this value, unless we're including selections
				notes,
				option_pricing_display,
				mutually_exclusive,
				build_data,
				original_build_data,
				[source],
				build_id,
				gpc,
				model,
				make_std,
				is_credit,
				option_id,
				stage,
				@active_user_email,
				GETDATE(),
				@active_user_email,
				GETDATE(),
				is_package
			FROM
				dbo.catalog_selections WITH (NOLOCK)
			WHERE
				session_id = @source_session_id

		/*
		* Then we need to copy over the images of custom items.
		*/
		INSERT INTO dbo.catalog_selections_designer_images (session_id, row_id, [file_name], mime_type, image_data, author, create_date, modifier, modified_date)
			SELECT
				@target_session_id,
				row_id,
				[file_name],
				mime_type,
				image_data,
				@active_user_email,
				GETDATE(),
				@active_user_email,
				GETDATE()
			FROM
				dbo.catalog_selections_designer_images WITH (NOLOCK)
			WHERE
				session_id = @source_session_id

		/*
		* Now copy the catalog_selections_price_level_boms table, if it exists.
		*/
		IF (EXISTS(SELECT * FROM INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'dbo' AND TABLE_NAME = 'catalog_selections_price_level_boms'))
		BEGIN
			INSERT INTO dbo.catalog_selections_price_level_boms (session_id, catalog_selections_row_id, serialized_bom_data, author, create_date, modifier, modified_date)
				SELECT
					@target_session_id,
					catalog_selections_row_id,
					serialized_bom_data,
					@active_user_email,
					GETDATE(),
					@active_user_email,
					GETDATE()
				FROM
					dbo.catalog_selections_price_level_boms WITH (NOLOCK)
				WHERE
					session_id = @source_session_id
		END

		/*
		* Now we can copy the catalog selections areas, only including selection information if include_selections is true
		*/
		INSERT INTO dbo.catalog_selections_areas (
			session_id,
			[application],
			product,
			area,
			sub_area,
			area_id,
			sub_area_id,
			[location],
			location_id,
			selected,
			notes,
			original_build_data,
			selection_total,
			selected_field_group,
			pattern_id,
			area_selected,
			build_id,
			author,
			create_date,
			modifier,
			modified_date
		)
			SELECT
				@target_session_id,
				[application],
				product,
				area,
				sub_area,
				area_id,
				sub_area_id,
				[location],
				location_id,
				IIF(@include_selections = 1, selected, 0), -- don't copy this value, unless we're including selections
				IIF(@include_selections = 1, notes, ''), -- don't copy this value, unless we're including selections
				original_build_data,
				IIF(@include_selections = 1, selection_total, 0), -- don't copy this value, unless we're including selections
				IIF(@include_selections = 1, selected_field_group, @empty_guid), -- don't copy this value, unless we're including selections
				IIF(@include_selections = 1, pattern_id, 0), -- don't copy this value, unless we're including selections
				area_selected,
				build_id,
				@active_user_email,
				GETDATE(),
				@active_user_email,
				GETDATE()
			FROM
				dbo.catalog_selections_areas WITH (NOLOCK)
			WHERE
				session_id = @source_session_id

		/*
		* Next, we need to copy over the area properties, but only if we're including selections
		*/
		IF @include_selections = 1
		BEGIN
			INSERT INTO dbo.catalog_selections_area_properties (id, session_id, build_id, [key], [value], author, create_date, modifier, modified_date)
			SELECT
				NEWID(),
				@target_session_id,
				build_id,
				[key],
				[value],
				@active_user_email,
				GETDATE(),
				@active_user_email,
				GETDATE()
			FROM
				dbo.catalog_selections_area_properties WITH (NOLOCK)
			WHERE
				session_id = @source_session_id
		END

		/*
		* If the source session had complete areas with slabs selected, we need to go through and mark those areas as incomplete
		*/
		IF @include_selections = 1
			BEGIN
				WITH source_complete_slabs_areas_cte (build_id)
				AS
				(
					SELECT DISTINCT
						csa.build_id
					FROM
						catalog_selections_areas csa WITH (NOLOCK)
						JOIN catalog_selections_area_slabs csas WITH (NOLOCK) ON csas.session_id = csa.session_id AND csas.build_id = csa.build_id
					WHERE
						csa.session_id = @source_session_id
						AND csa.selected = 2					
				)
				UPDATE csa
					SET selected = 1
				FROM
					catalog_selections_areas csa
					JOIN source_complete_slabs_areas_cte cte ON cte.build_id = csa.build_id
				WHERE
					csa.session_id = @target_session_id
			END

		/*
		* After copying selection areas, we need to copy area selection details, if we are including selections
		*/
		IF @include_selections = 1
			BEGIN
				INSERT INTO dbo.catalog_selections_area_details (session_id, [application], product, area, sub_area, item_type, item_id, selectable, bom_real_item_id, real_item_id, bom_bill_qty, bill_qty, alloc_qty, credit_qty, bom_uom_id, uom_id, builder_price, homeowner_price, pattern_id, is_pattern_item, pattern_percentage, force_reprice, price_type, price_source, retail_percentage, retail_percentage_type, accent_prompt, priced, bom_item_id, author, create_date, modifier, modified_date)
					SELECT
						@target_session_id,
						[application],
						product,
						area,
						sub_area,
						item_type,
						item_id,
						selectable,
						bom_real_item_id,
						real_item_id,
						bom_bill_qty,
						bill_qty,
						alloc_qty,
						credit_qty,
						bom_uom_id,
						uom_id,
						builder_price,
						homeowner_price,
						pattern_id,
						is_pattern_item,
						pattern_percentage,
						force_reprice,
						price_type,
						price_source,
						retail_percentage,
						retail_percentage_type,
						accent_prompt,
						priced,
						bom_item_id,
						@active_user_email,
						GETDATE(),
						@active_user_email,
						GETDATE()
					FROM
						dbo.catalog_selections_area_details WITH (NOLOCK)
					WHERE
						session_id = @source_session_id
				END

		/*
		* But the table for area selection details does not store the lay direction, so store the lay direction in its own table,
		* only if we are including selections
		*/
		IF @include_selections = 1
			BEGIN
				INSERT INTO dbo.catalog_selections_area_details_lay_directions (session_id, [application], product, area, sub_area, item_type, item_id, rotate_degree, author, create_date, modifier, modified_date)
					SELECT
						@target_session_id,
						[application],
						product,
						area,
						sub_area,
						item_type,
						item_id,
						rotate_degree,
						@active_user_email,
						GETDATE(),
						@active_user_email,
						GETDATE()
					FROM
						dbo.catalog_selections_area_details_lay_directions WITH (NOLOCK)
					WHERE
						session_id = @source_session_id
			END

		/*
		* Next, copy the catalog selections area detail options, if we are including selections
		*/
		IF @include_selections = 1
			BEGIN
				INSERT INTO dbo.catalog_selections_area_detail_options (session_id, [application], product, area, sub_area, item_type, item_id, option_id, option_value, option_source, included, qty, alloc_qty, price, price_retail, retail_percentage, retail_percentage_type, price_type, pricing_source, [error_message])
					SELECT
						@target_session_id,
						[application],
						product,
						area,
						sub_area,
						item_type,
						item_id,
						option_id,
						option_value,
						option_source,
						included,
						qty,
						alloc_qty,
						price,
						price_retail,
						retail_percentage,
						retail_percentage_type,
						price_type,
						pricing_source,
						[error_message]
					FROM
						dbo.catalog_selections_area_detail_options WITH (NOLOCK)
					WHERE
						session_id = @source_session_id
			END

		/*
		* copy over the catalog selections group detail
		*/
		INSERT INTO dbo.catalog_selections_group_detail (session_id, group_id, item_type, item, area_id, sub_area_id, author, create_date, modifier, modified_date)
			SELECT
				@target_session_id,
				group_id,
				item_type,
				item,
				area_id,
				sub_area_id,
				@active_user_email,
				GETDATE(),
				@active_user_email,
				GETDATE()
			FROM
				dbo.catalog_selections_group_detail WITH (NOLOCK)
			WHERE
				session_id = @source_session_id

		/*
		* Now we need to copy over the snapshotted bom modifications and the selected area bom modifications
		*/
		-- track the bom modification idsw
		DECLARE @ids TABLE
		(
			original_id UNIQUEIDENTIFIER,
			new_id UNIQUEIDENTIFIER
		)

		INSERT INTO @ids (original_id, new_id)
			SELECT
				id,
				NEWID()
			FROM
				catalog_selections_bom_modifications csbm WITH (NOLOCK)
			WHERE
				session_id = @source_session_id

		-- now copy over the snapshotted session data
		INSERT INTO dbo.catalog_selections_bom_modifications
		(
			id,
			session_id,
			application_id,
			product_id,
			area_id,
			sub_area_id,
			item_code,
			item,
			vendor,
			modification_type,
			quantity,
			price,
			cost,
			notes,
			gpc,
			option_pricing_display,
			author,
			create_date,
			modifier,
			modified_date
		)
		SELECT
			ids.new_id,
			@target_session_id,
			[source].application_id,
			[source].product_id,
			[source].area_id,
			[source].sub_area_id,
			[source].item_code,
			[source].item,
			[source].vendor,
			[source].modification_type,
			[source].quantity,
			[source].price,
			[source].cost,
			[source].notes,
			[source].gpc,
			[source].option_pricing_display,
			@active_user_email,
			GETDATE(),
			@active_user_email,
			GETDATE()
		FROM
			dbo.catalog_selections_bom_modifications [source]
			CROSS APPLY
			(
				SELECT new_id FROM @ids WHERE original_id = [source].id
			) ids
		WHERE
			[source].session_id = @source_session_id;

		-- If we are including selections, copy over the area selections for bom modifications
		IF @include_selections = 1
			BEGIN
				INSERT INTO dbo.catalog_selections_area_bom_modifications
				(
					session_id,
					build_id,
					session_bom_modification_id,
					quantity,
					price,
					notes,
					author,
					create_date,
					modifier,
					modified_date
				)
				SELECT
					@target_session_id,
					[source].build_id,
					ids.new_id,
					[source].quantity,
					[source].price,
					[source].notes,
					@active_user_email,
					GETDATE(),
					@active_user_email,
					GETDATE()
				FROM
					dbo.catalog_selections_area_bom_modifications [source]
					CROSS APPLY
					(
						SELECT new_id FROM @ids WHERE original_id = [source].session_bom_modification_id
					) ids
				WHERE
					[source].session_id = @source_session_id
			END

		/*
		* If everything goes well, return the new session id as a result
		*/
		SELECT @target_session_id AS session_id

	END TRY
	BEGIN CATCH

		-- Since an error occured, we need to rollback the transaction
		IF @@TRANCOUNT > 0
			ROLLBACK TRANSACTION

		-- Rethrow the error
		DECLARE
			@ErrorMessage    NVARCHAR(4000),
			@ErrorNumber     INT,
			@ErrorSeverity   INT,
			@ErrorState      INT,
			@ErrorLine       INT,
			@ErrorProcedure  NVARCHAR(200);

		-- Assign variables to error-handling functions that
		-- capture information for RAISERROR.
		SELECT
			@ErrorNumber = ERROR_NUMBER(),
			@ErrorSeverity = ERROR_SEVERITY(),
			@ErrorState = ERROR_STATE(),
			@ErrorLine = ERROR_LINE(),
			@ErrorProcedure = ISNULL(ERROR_PROCEDURE(), '-');

		-- Build the message string that will contain original
		-- error information.
		SELECT @ErrorMessage = N'Copy Session Failed: ' + ERROR_MESSAGE();

		-- Raise an error: msg_str parameter of RAISERROR will contain
		-- the original error information.
		RAISERROR
			(
			@ErrorMessage,
			@ErrorSeverity,
			1,
			@ErrorNumber,    -- parameter: original error number.
			@ErrorSeverity,  -- parameter: original error severity.
			@ErrorState,     -- parameter: original error state.
			@ErrorProcedure, -- parameter: original error procedure name.
			@ErrorLine       -- parameter: original error line number.
			);

	END CATCH

	/*
	* If things went well, commit the transaction
	*/
	IF @@TRANCOUNT > 0
		COMMIT TRANSACTION
END
GO
PRINT N'Creating Procedure [dbo].[vds_copySessionCatalogItemsToCatalogSelections]...';


GO
CREATE PROCEDURE [dbo].[vds_copySessionCatalogItemsToCatalogSelections]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@session_id UNIQUEIDENTIFIER,
	@community VARCHAR(100),
	@series VARCHAR(100),
	@plan_name VARCHAR(100),
	@base_plan_name VARCHAR(100),
	@unmapped_plan_name VARCHAR(100) = NULL, -- According to Nick, this should never be used. SLM
	@elevation VARCHAR(50) = NULL,
	@security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Create Date: 8/4/2015
    Description: Copies all of the catalog items from catalog_items table to
                 the specified sessions catalog_selections table. It only copies
                 those that match the community, series, and plan passed in.

	Modified: Shelby Mansker
	Date: 4/14/2016
	Description: Elevation is now an optional parameter. If it is not supplied, it will
		be pulled from the session's profile plan table instead.

	Modified: Shelby Mansker
	Date: 4/15/2016
	Description: Added the option_id to the data being copied over from catalog_items

	Modified: Saul Sanchez
	Date: 12/28/2016
	Description: Added stage to the data being copied over from catalog_items.

	Modified: Shelby Mansker
	Date: 9/8/2017
	Description: Updated Create and Modified date to the current date.

	Modified: Shelby Mansker
	Date: 6/8/2020
	Description: Nick Dzierewienko requested that we make a change to the way Address Specific items are
		brought into a newly created session. If the catalog_items table contains any items with the
		plan matching the Address Specific plan for the new session, then they will replace all of the items
		in catalog_items with the same Application, that are linked to the base plan of the new session.
		Items that are linked to 'All' in the plan column, will always come across.

		Also, according to Nick, they will never use the Echelon Plan Name in the catalog (@unmapped_plan_name),
		and will only ever use the VDS plan name (@plan_name).

	Modified: Shelby Mansker
	Date: 8/3/2020
	Description: The new is_package column is copied over now.

	Modified: Roger Wang
	Date: 10/6/2021
	Description: Round the price of catalog items based on builder's rounding rules before inserting to session.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Get the user id from the security token
	DECLARE @active_user_id VARCHAR(100)
	SET @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	-- If no elevation was passed in, fetch the elevation from the session's profile plan
	IF (@elevation IS NULL)
	BEGIN
		SELECT
			@elevation = isnull(elevation ,'')
		FROM
			account_organization_user_profile_plan_catalog_sessions s WITH (NOLOCK)
			JOIN account_organization_user_profile_plan pp WITH (NOLOCK) ON
				pp.account_id = s.account_id
				AND pp.organization_id = s.organization_id
				AND pp.[user_id] = s.[user_id]
				AND pp.community_name = s.community_name
				AND pp.series = s.series
				AND pp.plan_name = s.plan_name
		WHERE
			s.session_id = @session_id
	END

	-- We need to determine whether or not this session is address specific (has a base plan and a plan). If the base plan name is
	-- blank, or matches the plan name, then the session is not for an address specific plan.
	DECLARE @is_address_specific_plan BIT = IIF(@base_plan_name <> '' AND @base_plan_name <> @plan_name, 1, 0);

	-- Make sure the session's existing catalog items are empty
	DELETE FROM dbo.catalog_selections WHERE session_id = @session_id

	-- We will use a table variable to track all of the catalog items that will be inserted into the session.
	DECLARE @plan_items TABLE
	(
		[row_id] UNIQUEIDENTIFIER,
		account_id UNIQUEIDENTIFIER,
		organization_id UNIQUEIDENTIFIER,
		community VARCHAR(100),
		series VARCHAR(100),
		[plan] VARCHAR(100),
		[application] VARCHAR(100)
	)

	-- If this isn't an address specific plan, then lets make sure that the base plan is the same as the plan variable.
	SET @base_plan_name = IIF(@is_address_specific_plan = 0, @plan_name, @base_plan_name)

	-- Now determine all of the items that should be in the session based on the base_plan_name, as well as those that
	-- match 'All' or ''.
	INSERT INTO @plan_items ([row_id], account_id, organization_id, community, series, [plan], [application])
	SELECT
		[row_id],
		account_id,
		organization_id,
		community,
		series,
		[plan],
		[application]
	FROM
		[dbo].[catalog_items]
	WHERE
		account_id = @account_id
		AND organization_id = @organization_id
		AND (LTRIM(community) = LTRIM(@community) OR community = 'All' OR community = '')
		AND (LTRIM(series) = LTRIM(@series) OR series = 'All' OR series = '')
		AND (LTRIM([plan]) = LTRIM(@base_plan_name) OR [plan] = 'All' OR [plan] = '')
		AND (LTRIM(elevation) = LTRIM(@elevation) OR elevation = 'All' OR elevation = '')   		

	-- Now, if this is an address specific plan (the base plan is different from the plan), we need to fetch items specific to the Address Specific plan.
	-- Also, we need to overwrite any items in the Base plan that have the same application as in the address specific plan.
	IF (@is_address_specific_plan = 1)
	BEGIN
		
		-- For clarity sake, we'll create a new variable to store the address specific plan name (which will just contain the plan name)
		DECLARE @address_specific_plan_name VARCHAR(100) = @plan_name

		-- We need to determine which catalog items will be overwritten. We do this by Application; where an application in the base plan will be
		-- overwritten by the same application's items in the address specific plan.
		;WITH address_specific_plan_applications_cte ([application])
		AS
		(
			SELECT DISTINCT
				[application]
			FROM
				catalog_items
			WHERE
				account_id = @account_id
				AND organization_id = @organization_id
				AND (LTRIM(community) = LTRIM(@community) OR community = 'All' OR community = '')
				AND (LTRIM(series) = LTRIM(@series) OR series = 'All' OR series = '')
				AND LTRIM([plan]) = LTRIM(@address_specific_plan_name)
				AND (LTRIM(elevation) = LTRIM(@elevation) OR elevation = 'All' OR elevation = '')
		)
		DELETE @plan_items
		FROM
			@plan_items p
			JOIN address_specific_plan_applications_cte a ON a.[application] = p.[application]
		WHERE
			p.[plan] = @base_plan_name -- only replace the base plan items

		-- Now that we've cleared the base plan items that will be overwritten, out of our temp table, we need to bring all of the relevant address specific
		-- plan items in.
		INSERT INTO @plan_items ([row_id], account_id, organization_id, community, series, [plan], [application])
		SELECT
			[row_id],
			account_id,
			organization_id,
			community,
			series,
			[plan],
			[application]
		FROM
			[dbo].[catalog_items]
		WHERE
			account_id = @account_id
			AND organization_id = @organization_id
			AND (LTRIM(community) = LTRIM(@community) OR community = 'All' OR community = '')
			AND (LTRIM(series) = LTRIM(@series) OR series = 'All' OR series = '')
			AND LTRIM([plan]) = LTRIM(@plan_name) -- specifically look for items that are linked to the address specific plan.
			AND (LTRIM(elevation) = LTRIM(@elevation) OR elevation = 'All' OR elevation = '')
	END

	-- Now join the items we've identified in our table variable, with those in the catalog items table, and insert them into the catalog selections table
	-- for the new session.
	INSERT INTO dbo.catalog_selections (
		session_id,
		row_id,
		account_id,
		organization_id,
		community,
		series,
		[plan],
		[application],
		product,
		area,
		sub_area,
		item_no,
		item,
		vendor,
		[standard],
		qty,
		cost,
		price,
		selected,
		notes,
		option_pricing_display,
		mutually_exclusive,
		gpc,
		model,
		option_id,
		stage,
		author,
		create_date,
		modifier,
		modified_date,
		[source],
		is_package)
	SELECT
		@session_id,
		ci.row_id,
		ci.account_id,
		ci.organization_id,
		ci.community,
		ci.series,
		ci.[plan],
		ci.[application],
		product,
		area,
		sub_area,
		item_no,
		item,
		vendor,
		[standard],
		qty,
		cost,
		[dbo].[vdsf_VeoroundBySession](price, @session_id),
		selected,
		notes,
		option_pricing_display,
		mutually_exclusive,
		gpc,
		model,
		option_id,
		stage,
		@active_user_id,
		GETDATE(),
		@active_user_id,
		GETDATE(),
		'catalog' AS [source],
		is_package
	FROM
		@plan_items p
		JOIN dbo.catalog_items ci WITH (NOLOCK) ON ci.row_id = p.row_id
	ORDER BY
		option_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delAccountOrganizationDocument]...';


GO
CREATE PROCEDURE [dbo].[vds_delAccountOrganizationDocument]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@doc_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER = null
AS
/*
	Author: Roger Wang
	Date: 2/2/2022
	Description: Deletes a document under an account organization
*/
BEGIN
	DECLARE @edit_user_id VARCHAR(75)
	SET @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	IF (@edit_user_id IS NULL)
		BEGIN
			RAISERROR('Invalid credentials.',16,1)
			RETURN
		END

	UPDATE 
		account_organization_documents 
	SET 
		[modifier] = @edit_user_id,
		[modified_date] = GETDATE()
	WHERE
		[account_id] = @account_id 
		and [organization_id] = @organization_id
		and [doc_id] = @doc_id	 

	DELETE
		account_organization_documents
	WHERE
		[account_id] = @account_id
		and [organization_id] = @organization_id
		and [doc_id] = @doc_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delAccountOrganizationUserProfilePlan]...';


GO
CREATE PROCEDURE [dbo].[vds_delAccountOrganizationUserProfilePlan]
	@account_id uniqueidentifier,
    @organization_id uniqueidentifier,
    @user_id uniqueidentifier,
    @community varchar(50),
    @series varchar(50),
    @plan varchar(50),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 9/27/2017
	Description: Attempts to delete the specified profile plan. Cascading deletes should take care of related tables.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Get the user from the security token
	DECLARE @user_email VARCHAR(100) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	-- Update the modifier row with the security token's user, so we know who is deleting the profile plan
	UPDATE account_organization_user_profile_plan 
		SET 
			modifier = @user_email,
			modified_date = GETDATE()
		WHERE
			account_id = @account_id
			AND organization_id = @organization_id
			AND [user_id] = @user_id
			AND community_name = @community
			AND series = @series
			AND plan_name = @plan

	-- Delete the profile plan.
	DELETE FROM 
		account_organization_user_profile_plan
	WHERE
		account_id = @account_id
		AND organization_id = @organization_id
		AND [user_id] = @user_id
		AND community_name = @community
		AND series = @series
		AND plan_name = @plan
END
GO
PRINT N'Creating Procedure [dbo].[vds_delAccountOrganizationUserRole]...';


GO
CREATE PROCEDURE [dbo].[vds_delAccountOrganizationUserRole]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @user_id UNIQUEIDENTIFIER,
    @role_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
BEGIN
	DECLARE @edit_user_id VARCHAR(75)
	SET @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	IF (@edit_user_id IS NULL)
		BEGIN
			RAISERROR('Invalid credentials.',16,1)
			RETURN
		END

    UPDATE
        VeoSolutionsSecurity_account_organization_users_roles_legacy
    SET
        modifier = @edit_user_id,
        modified_date = GETDATE()
    WHERE
        account_id = @account_id
        AND organization_id = @organization_id
        AND [user_id] = @user_id

    DELETE
        VeoSolutionsSecurity_account_organization_users_roles_legacy
    WHERE
        account_id = @account_id
        AND organization_id = @organization_id
        AND [user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delApplicationIcon]...';


GO
CREATE PROCEDURE [dbo].[vds_delApplicationIcon]
	@application nvarchar(100),
	@security_token uniqueidentifier
AS

/*
	Author: Art deHoyos
	Create Date: 12/06/2019
	Description: Unassign application icon
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

		DELETE FROM application_icon
		WHERE [application] = @application
END
GO
PRINT N'Creating Procedure [dbo].[vds_delBuildBomLine]...';


GO
CREATE PROCEDURE [dbo].[vds_delBuildBomLine]
    @session_id UNIQUEIDENTIFIER,
    @application VARCHAR(100),
    @product VARCHAR(100), 
    @area VARCHAR(100),
    @sub_area VARCHAR(100),
    @item_type VARCHAR(20),
    @item_id VARCHAR(50),
    @security_token UNIQUEIDENTIFIER    
AS
/*
    Author: Shelby Mansker
    Date: 9/16/2015
    Description: Deletes a specific build's bom line. Due to database integrity, if the bom line
        has any options, they will also be deleted.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    DELETE FROM
        dbo.catalog_selections_area_details
    WHERE
        session_id = @session_id
        AND [application] = @application
        AND product = @product
        AND area = @area
        AND sub_area = @sub_area
        AND item_type = @item_type
        AND item_id = @item_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delBuildBomLineOption]...';


GO
CREATE PROCEDURE dbo.vds_delBuildBomLineOption
    @session_id UNIQUEIDENTIFIER,
    @application VARCHAR(100),
    @product VARCHAR(100), 
    @area VARCHAR(100),
    @sub_area VARCHAR(100),
    @item_type VARCHAR(20),
    @item_id VARCHAR(50),
    @option_id VARCHAR(50),
    @security_token UNIQUEIDENTIFIER       
AS
/*
    Author: Shelby Mansker
    Date: 9/16/2015
    Description: Deletes a specific build's bom line option.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    DELETE FROM
        dbo.catalog_selections_area_detail_options
    WHERE
        session_id = @session_id
        AND [application] = @application
        AND product = @product
        AND area = @area
        AND sub_area = @sub_area
        AND item_type = @item_type
        AND item_id = @item_id
        AND option_id = @option_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delBuildBomModification]...';


GO
CREATE PROCEDURE vds_delBuildBomModification 
    @session_id UNIQUEIDENTIFIER,
    @build_id BIGINT,
    @session_bom_modification_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 10/23/2015
    Description: Deletes the specified bom modification line from
        a specific session's build.
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Remove the bom modification from the build
    DELETE FROM
        dbo.catalog_selections_area_bom_modifications
    WHERE
        session_id = @session_id
        AND build_id = @build_id
        AND session_bom_modification_id = @session_bom_modification_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delBuilderBomModifications]...';


GO
CREATE PROCEDURE dbo.vds_delBuilderBomModifications
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 11/23/2015
	Description: Deletes all of the bom modifications for a builder
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Delete all of the bom modification records from this account and organization
	DELETE FROM
        dbo.builder_bom_modifications
    WHERE
        account_id = @account_id
        AND organization_id = @organization_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delBuilderCatalogItems]...';


GO
CREATE PROCEDURE [dbo].[vds_delBuilderCatalogItems]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER	
AS
/*
	Author: Shelby Mansker
	Date: 11/23/2015
	Description: Deletes all of the catalog items for a builder.
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Delete all of the catalog items from this builder
	DELETE
    FROM
        dbo.catalog_items
    WHERE
        account_id = @account_id
        AND organization_id = @organization_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delBuildProperty]...';


GO
CREATE PROCEDURE [dbo].[vds_delBuildProperty]
	@id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER	
AS
/*
	Author: Shelby Mansker
	Date: 5/22/2017
	Description: Delete a build property.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END
	
	-- Get the email address for the user associated with the security token passed in
    DECLARE @user_email VARCHAR(100) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	DELETE FROM catalog_selections_area_properties WHERE id = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delCatalogSelectionsAreaDetailsLayDirection]...';


GO
CREATE PROCEDURE [dbo].[vds_delCatalogSelectionsAreaDetailsLayDirection]
	@session_id UNIQUEIDENTIFIER,
	@application VARCHAR(100),
	@product VARCHAR(100),
	@area VARCHAR(100),
	@sub_area VARCHAR(100),
	@item_type VARCHAR(20),
	@item_id VARCHAR(50),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 3/28/2022
	Description: Deletes lay direction degree for a bom line
*/
BEGIN
	declare @edit_user_id varchar(75)
	set @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	if (@edit_user_id is null)
		begin
			raiserror('Invalid credentials.',16,1)
			return
		end

	DELETE
		[dbo].[catalog_selections_area_details_lay_directions]
	WHERE
		[session_id] = @session_id
		AND [application] = @application
		AND [product] = @product
		AND [area] = @area
		AND [sub_area] = @sub_area
		AND [item_type] = @item_type
		AND [item_id] = @item_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delCatalogSelectionsGroupDetail]...';


GO
CREATE PROCEDURE [dbo].[vds_delCatalogSelectionsGroupDetail]
	@session_id UNIQUEIDENTIFIER,
	@group_id INT,
	@item_type VARCHAR(10),
	@item VARCHAR(81),
	@security_token UNIQUEIDENTIFIER
AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DELETE
		catalog_selections_group_detail
	WHERE
		session_id = @session_id
		AND group_id = @group_id
		AND item_type = @item_type
		AND item = @item
END
GO
PRINT N'Creating Procedure [dbo].[vds_delDesignerAssignedApplications]...';


GO
CREATE PROCEDURE [dbo].[vds_delDesignerAssignedApplications]
	@user_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 2/14/2017
	Description: Deletes all of the selectable applications for a specific Vendor Designer user.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DELETE FROM 
		designer_assigned_applications
	WHERE
		[user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delete_icon]...';


GO
CREATE PROCEDURE [dbo].[vds_delete_icon]
	@id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS

/*
	Author: Eric Hickey
	Create Date: 11/04/2019
	Description: Deletes an icon using the provided id.

	Modifier: Roger Wang
	Modify Date: 08/20/2024
	Description: Removes icon from associated rooms/applications.
*/

BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	-- Set the icon_id to null in the rooms table
	UPDATE
		[rooms]
	SET
		[icon_id] = null
	WHERE
		icon_id = @id

	-- Set the icon_id to null in the application_icon table
	UPDATE
		[application_icon]
	SET
		[icon_id] = null
	WHERE
		icon_id = @id

	DELETE FROM
		[icon]
	WHERE
		id = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delete_icon_tag]...';


GO
CREATE PROCEDURE [dbo].[vds_delete_icon_tag]
	@id UNIQUEIDENTIFIER,
	@tag VARCHAR(25),
	@security_token UNIQUEIDENTIFIER
AS

/*
	Author: Eric Hickey
	Create Date: 11/04/2019
	Description: Deletes an icon tag for an icon.
*/

BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	DELETE FROM	[dbo].[icon_tags]
	WHERE
		[icon_id] = @id
		AND
		[tag] = @tag
END
GO
PRINT N'Creating Procedure [dbo].[vds_delete_restricted_application_product_by_organization]...';


GO
CREATE PROCEDURE [dbo].[vds_delete_restricted_application_product_by_organization]
@id UNIQUEIDENTIFIER,
@security_token UNIQUEIDENTIFIER

AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	DELETE FROM [restricted_application_product] 
	WHERE 
	[id] = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delFloorplan]...';


GO
CREATE PROCEDURE [dbo].[vds_delFloorplan]
	@id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Create Date: 10/26/2017
	Description: Deletes a floorplan record.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	DELETE FROM [dbo].[floorplans]
	WHERE
		[id] = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delHomebuyerCatalogEstimatedSelection]...';


GO
CREATE PROCEDURE [dbo].[vds_delHomebuyerCatalogEstimatedSelection]
	@session_id UNIQUEIDENTIFIER,
	@room_id UNIQUEIDENTIFIER,
	@application_id VARCHAR(10),
	@subarea_id VARCHAR(25),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 8/9/2019
	Description: Removes the selection for a specific room option in a homebuyer
		catalog.

	Author: Art deHoyos
	Date: 8/13/2019
	Description: Made @product_id optional, which is necessary for updating
		the selection when a different product is selected.

	Author: Chris Ragon
	Date: 3/23/2020
	Description: Update procedure to accept room_id instead of area_id and sub_area_id
		as part of the effort to switch to using room_id in VDS
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DELETE
		dbo.[homebuyer_catalog_estimated_selections]
	FROM 
		homebuyer_catalog_estimated_selections hces
	INNER JOIN dbo.[room_sections] rs ON rs.area_id = hces.area_id AND rs.sub_area_id = hces.sub_area_id
	WHERE 
		rs.room_id = @room_id
		AND hces.application_id = @application_id
		AND (hces.sub_area_id = @subarea_id OR @subarea_id IS NULL)
		AND hces.session_id = @session_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delHomebuyerCatalogNonestimatedSelection]...';


GO
CREATE PROCEDURE [dbo].[vds_delHomebuyerCatalogNonestimatedSelection]
	@session_id UNIQUEIDENTIFIER,
	@row_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 7/29/2019
	Description: Removes the specified homebuyer catalog estimated selection.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DELETE FROM
		homebuyer_catalog_nonestimated_selections
	WHERE
		session_id = @session_id
		AND row_id = @row_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delHomebuyerCatalogPriceLevelFilter]...';


GO
CREATE PROCEDURE [dbo].[vds_delHomebuyerCatalogPriceLevelFilter]
	@id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 4/18/2022
	Description: Deletes price level filter
*/
BEGIN
	DECLARE @edit_user_id VARCHAR(75)
	SET @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	IF (@edit_user_id IS NULL)
		BEGIN
			RAISERROR('Invalid credentials.',16,1)
			RETURN
		END

	UPDATE
		[dbo].[homebuyer_catalog_price_level_filters]
	SET
		[modifier] = @edit_user_id,
		[modified_date] = GETDATE()
	WHERE
		[id] = @id

	DELETE
		[dbo].[homebuyer_catalog_price_level_filters]
	WHERE
		[id] = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delPriceLevelBom]...';


GO
CREATE PROCEDURE dbo.vds_delPriceLevelBom
	@session_id UNIQUEIDENTIFIER,
	@catalog_selections_row_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER	
AS
/*
	Author: Shelby Mansker
	Date: 1/8/2016
	Description: Deletes the specified price level bom from the database.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DELETE FROM
		dbo.catalog_selections_price_level_boms
	WHERE
		session_id = @session_id
		AND catalog_selections_row_id = @catalog_selections_row_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delPrimaryPlanCatalog]...';


GO
CREATE PROCEDURE [dbo].[vds_delPrimaryPlanCatalog]
	@profile_plan_id uniqueidentifier,
	@security_token uniqueidentifier
AS
/*
	Author: Roger Wang
	Date: 4/1/2021
	Description: Unsets a session as primary for a profile plan
*/
BEGIN
	declare @edit_user_id varchar(75)
	set @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	if (@edit_user_id is null)
		begin
			raiserror('Invalid credentials.',16,1)
			return
		end

	delete
		primary_plan_catalogs
	where
		profile_plan_id = @profile_plan_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delRoom]...';


GO
CREATE PROCEDURE [dbo].[vds_delRoom]
@id UNIQUEIDENTIFIER,
@security_token UNIQUEIDENTIFIER

AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	DELETE FROM [rooms] WHERE [id] = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delSectionFromRoom]...';


GO
CREATE PROCEDURE [dbo].[vds_delSectionFromRoom]
	@id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS

BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	DELETE FROM [room_sections] WHERE [id] = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delSessionChange]...';


GO
CREATE PROCEDURE [dbo].[vds_delSessionChange]
	@change_id UNIQUEIDENTIFIER, 
	@security_token UNIQUEIDENTIFIER 
AS
/*
   Author:		Robert Hobbs
   Create date: 04/08/19
   Description:	Deletes a session_change record 
 */
BEGIN 
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DELETE FROM session_changes WHERE change_id = @change_id 
	
END
GO
PRINT N'Creating Procedure [dbo].[vds_delSessionChanges]...';


GO
CREATE PROCEDURE [dbo].[vds_delSessionChanges]
	@session_id UNIQUEIDENTIFIER, 
	@security_token UNIQUEIDENTIFIER 
AS
/*
   Author:		Robert Hobbs
   Create date: 04/08/19
   Description:	Deletes all session_changes for a @session_id
 */
BEGIN 
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DELETE FROM session_changes WHERE session_id = @session_id  
	
END
GO
PRINT N'Creating Procedure [dbo].[vds_delSessionDocument]...';


GO
CREATE PROCEDURE dbo.vds_delSessionDocument
	@session_id UNIQUEIDENTIFIER,
	@document_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 1/15/2016
	Description: Deletes a single session document
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DELETE FROM 
		account_organization_user_profile_plan_catalog_sessions_documents
	WHERE
		document_id = @document_id
		AND session_id = @session_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_delSessionDocuments]...';


GO
CREATE PROCEDURE dbo.vds_delSessionDocuments
	@session_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 1/15/2016
	Description: Deletes all of the documents for a given session.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DELETE FROM 
		account_organization_user_profile_plan_catalog_sessions_documents
	WHERE
		session_id = @session_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_delSessionNonEstimatedOption]...';


GO
CREATE PROCEDURE [dbo].[vds_delSessionNonEstimatedOption]
	@session_id UNIQUEIDENTIFIER,
    @row_id UNIQUEIDENTIFIER,
    @audit_user VARCHAR(50)
AS
/*
	Author: Shelby Mansker
	Date: 11/6/2018
	Description: Deletes a non-estimated item from the specified session's catalog.
*/
BEGIN
	IF (EXISTS(SELECT TOP(1) * FROM catalog_selections WHERE session_id = @session_id AND row_id = @row_id))
	BEGIN
		-- update the audit column of the row first
		UPDATE dbo.catalog_selections
		SET
			modifier = @audit_user,
			modified_date = GETDATE()
		WHERE
			session_id = @session_id
			AND row_id = @row_id

		-- then delete the row
		DELETE FROM 
			dbo.catalog_selections
		WHERE
			session_id = @session_id
			AND row_id = @row_id
	END
END
GO
PRINT N'Creating Procedure [dbo].[vds_delSessionNonEstimatedOptionDesignerImage]...';


GO
CREATE PROCEDURE [dbo].[vds_delSessionNonEstimatedOptionDesignerImage]
	@session_id UNIQUEIDENTIFIER,
    @row_id UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 11/6/2018
	Description: Deletes the designer image record for the specified session's non-estimated option.
*/
BEGIN
	DELETE FROM
		dbo.catalog_selections_designer_images
	WHERE
		session_id = @session_id
		AND row_id = @row_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delSessionNonEstimatedOptionPriceOverride]...';


GO
CREATE PROCEDURE [dbo].[vds_delSessionNonEstimatedOptionPriceOverride]
	@session_id UNIQUEIDENTIFIER,
	@row_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 1/21/2022
	Description: Deletes price override record for a session non-estimated item.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DELETE FROM 
		[catalog_selections_price_overrides]
	WHERE
		[session_id] = @session_id
		AND [row_id] = @row_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delSlab]...';


GO
CREATE PROCEDURE [dbo].[vds_delSlab]
@session_id uniqueidentifier, 
@build_id int, 
@slab_id varchar(100), 
@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Robert Hobbs
	Date: 5/10/2017
	Description: Deletes a slab selection record 
*/
BEGIN

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- select * from catalog_selections_area_slabs
	DECLARE @author VARCHAR(50) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	DELETE FROM 
	catalog_selections_area_slabs 
	WHERE 
		session_id = @session_id 
		AND build_id = @build_id 
		AND slab_id = @slab_id 
		
END
GO
PRINT N'Creating Procedure [dbo].[vds_delTemporaryPassword]...';


GO
CREATE PROCEDURE [dbo].[vds_delTemporaryPassword]
	@user_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Create Date: 04/10/2018
	Description: Deletes the encrypted temporary password.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	UPDATE VeoSolutionsSecurity_users
	SET
		temporary_password = NULL
	WHERE
		[user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_delUserCompletedOrientationSteps]...';


GO
CREATE PROCEDURE [dbo].[vds_delUserCompletedOrientationSteps]
	@user_id UNIQUEIDENTIFIER
AS
/*
	Author:			Roger Wang
	Date:			1/10/2019
	Description:	Delete the orientation steps completed by a user
*/

DELETE
FROM
	user_completed_orientation_steps
WHERE
	[user_id] = @user_id;
GO
PRINT N'Creating Procedure [dbo].[vds_editRoom]...';


GO
CREATE PROCEDURE [dbo].[vds_editRoom]
	@id UNIQUEIDENTIFIER,
	@name VARCHAR(100),
	@icon_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	UPDATE [rooms]
	SET 
		[name] = @name,
		[icon_id] = @icon_id
	WHERE
		[id] = @id

	SELECT 
		[rooms].[id],
		[rooms].[name],
		[rooms].[icon_id],
		[rooms].[author],
		[rooms].[create_date],
		[rooms].[modifier],
		[rooms].[modified_date]
	FROM 
		[rooms]
	WHERE 
		[id] = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_get_all_restricted_application_product_by_organization]...';


GO
CREATE PROCEDURE [dbo].[vds_get_all_restricted_application_product_by_organization]
	@organization_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		[RAP].[id],
		[RAP].[organization_id],
		[RAP].[application_id],
		[VA].[name] AS application_name,
		[RAP].[product_id],
		[VP].[name] AS product_name
	FROM
		[restricted_application_product] AS RAP
		LEFT JOIN [Veo_Applications] AS VA ON RAP.application_id = VA.application_id
		LEFT JOIN [Veo_Products] AS VP ON RAP.product_id = VP.product_id

	WHERE
		[RAP].[organization_id] = @organization_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_get_icon]...';


GO
CREATE PROCEDURE [dbo].[vds_get_icon]
	@id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS

/*
	Author: Eric Hickey
	Create Date: 11/04/2019
	Description: Returns two recordsets:
					1) the icon without the image field
					2) a list of all icon tags associated with requested icon. If the icon does not have any tags, the second recordset will be empty.
*/

BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	-- Return an icon
	SELECT
		[id],
		[name],
		[mime_type]
	FROM
		[dbo].[icon]
	WHERE
		[id] = @id

	-- Return a list of tags for the icon
	SELECT
		tags.[tag]
	FROM
		[dbo].[icon] AS icon
		INNER JOIN [dbo].[icon_tags] AS tags
			ON
				icon.id = tags.icon_id
			AND
				icon.id = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_get_icon_by_name]...';


GO
CREATE PROCEDURE [dbo].[vds_get_icon_by_name]
	@name VARCHAR(50),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Create Date: 08/20/2024
	Description: Returns two recordsets:
					1) the icon without the image field
					2) a list of all icon tags associated with requested icon. If the icon does not have any tags, the second recordset will be empty.
*/

BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	DECLARE @id UNIQUEIDENTIFIER

	-- Retrieve the icon id by name
	SELECT
		@id = [id]
	FROM
		[dbo].[icon]
	WHERE
		[name] = @name

	-- Return an icon
	SELECT
		[id],
		[name],
		[mime_type]
	FROM
		[dbo].[icon]
	WHERE
		[id] = @id

	-- Return a list of tags for the icon
	SELECT
		tags.[tag]
	FROM
		[dbo].[icon] AS icon
		INNER JOIN [dbo].[icon_tags] AS tags
			ON
				icon.id = tags.icon_id
			AND
				icon.id = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_get_icon_with_image]...';


GO
CREATE PROCEDURE [dbo].[vds_get_icon_with_image]
	@id UNIQUEIDENTIFIER
AS

/*
	Author: Eric Hickey
	Create Date: 11/04/2019
	Description: Returns the image data for an icon
*/

BEGIN
	SELECT
		[id],
		[image],
		[mime_type]
	FROM
		[dbo].[icon]
	WHERE
		[id] = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_get_icons]...';


GO
CREATE PROCEDURE [dbo].[vds_get_icons]
	@security_token UNIQUEIDENTIFIER
AS

/*
	Author: Eric Hickey
	Create Date: 11/04/2019
	Description: Returns two recordsets:
					1) a list of icons without the image field
					2) a list of all icon tags associated with requested icons. If all icons do not have any tags, the second recordset will be empty.
*/

BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	-- Return a list of icons
	SELECT
		[id],
		[name],
		[mime_type]
	FROM
		[dbo].[icon]

	-- Return a list of tags for the icons
	SELECT
		icon.[id],
		tags.[tag]
	FROM
		[dbo].[icon] AS icon
		INNER JOIN [dbo].[icon_tags] AS tags
			ON icon.id = tags.icon_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_get_restricted_application_product_by_ids]...';


GO
CREATE PROCEDURE [dbo].[vds_get_restricted_application_product_by_ids]
	@organization_id UNIQUEIDENTIFIER,
	@application_id VARCHAR(10),
	@product_id VARCHAR(5),
	@security_token UNIQUEIDENTIFIER
AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	SELECT
		[RAP].[id],
		[RAP].[organization_id],
		[RAP].[application_id],
		[VA].[name] AS application_name,
		[RAP].[product_id],
		[VP].[name] AS product_name
	FROM
		[restricted_application_product] AS RAP
		LEFT JOIN [Veo_Applications] AS VA ON RAP.application_id = VA.application_id
		LEFT JOIN [Veo_Products] AS VP ON RAP.product_id = VP.product_id
	WHERE
		[RAP].[application_id] = @application_id
		AND
		[RAP].[product_id] = @product_id
		AND
		[RAP].[organization_id] = @organization_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_getActiveSessionIDFromProfilePlan]...';


GO

CREATE procedure [dbo].[vds_getActiveSessionIDFromProfilePlan]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier,
@community varchar(50),
@series varchar(50),
@plan varchar(50), 
@security_token uniqueidentifier = null 

as

/*
Summary: 
fetches an active session id for the given community, series and plan if it exists 

vds_getActiveSessionIDFromProfilePlan 'bab32b7e-3ada-497c-862e-e5083971cc59', '49687f1f-dec8-484d-b7c3-c193da7c873d', '02af2453-7ad6-429c-908b-689618199b8c', 'LAKES IN BAY COLONY', 'Royce (101)', 'TP01'

Modified 10/24/2019 - Eric Hickey
	Including 'Prospective' as an available profile plan status when trying to locate a session, but only when the organization is using the Prospective Status Feature.
*/

declare @prospective_status_feature int
set @prospective_status_feature = 20
create table #available_profile_plan_statuses
( status varchar(15) )

insert into	#available_profile_plan_statuses
values ('Contracted', 'Complete')

-- also include 'prospective' if the Prospective Status Feature is on, otherwise include 'active' and 'inactive'
if ([dbo].vdsf_isOrganizationFeatureOn(@organization_id, @prospective_status_feature) = 1)
	begin
		insert into #available_profile_plan_statuses
		values ('Prospective')
	end
else
	begin
		insert into #available_profile_plan_statuses
		values ('Active', 'Inactive')
	end
	

select 
	top 1
	s.session_id
from account_organization_user_profile_plan p with (nolock)

left join account_organization_user_profile_plan_catalog_sessions s with (nolock) on
	s.account_id = p.account_id and
	s.organization_id = p.organization_id and
	s.user_id = p.user_id and
	s.community_name = p.community_name and
	s.series = p.series and
	s.plan_name = p.plan_name

where p.account_id = @account_id and
	p.organization_id = @organization_id and
	p.user_id = @user_id and 
	p.status in (select status from #available_profile_plan_statuses) and
	s.status in (1,2) -- only active or completed
order by s.status asc,s.completed_date desc
GO
PRINT N'Creating Procedure [dbo].[vds_getAllApplications]...';


GO
CREATE PROCEDURE [dbo].[vds_getAllApplications]
	 @security_token UNIQUEIDENTIFIER
AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT 
		[application_id],
		[name]
	FROM
		[Veo_Applications]
	WHERE [active] = 1
END
GO
PRINT N'Creating Procedure [dbo].[vds_getAllNonestimatedApplications]...';


GO
CREATE PROCEDURE [dbo].[vds_getAllNonestimatedApplications]
    @security_token UNIQUEIDENTIFIER
AS
/*
	Author: Art deHoyos
	Create Date: 12/06/2019
	Description: Fetches all unique nonestimated applications
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT DISTINCT 
		ci.[application],
		ai.icon_id
	FROM
		catalog_items ci
	LEFT JOIN application_icon ai ON ci.application = ai.[application]
	ORDER BY ci.[application] ASC
END
GO
PRINT N'Creating Procedure [dbo].[vds_getAllProducts]...';


GO
CREATE PROCEDURE [dbo].[vds_getAllProducts]
	 @security_token UNIQUEIDENTIFIER
AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT 
		[product_id],
		[name]
	FROM
		[Veo_Products]
	WHERE [active] = 1
END
GO
PRINT N'Creating Procedure [dbo].[vds_getAllRooms]...';


GO
CREATE PROCEDURE [dbo].[vds_getAllRooms]
@security_token UNIQUEIDENTIFIER

AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	SELECT 
		[rooms].[id],
		[rooms].[name],
		[rooms].[icon_id],
		[rooms].[author],
		[rooms].[create_date],
		[rooms].[modifier],
		[rooms].[modified_date]
	FROM [rooms]
END
GO
PRINT N'Creating Procedure [dbo].[vds_getAllRoomSections]...';


GO
CREATE PROCEDURE [dbo].[vds_getAllRoomSections]
@security_token UNIQUEIDENTIFIER

AS

/*
	Author: Reid Wilson
	Create Date: 6/14/2023
	Description: Returns all room sections (name and id for area and subarea)
*/

BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	SELECT
		asa.area_id,
		a.[name] AS area_name,
		asa.sub_area_id,
		sa.[name] AS sub_area_name
	FROM 
		veo_areas_sub_areas asa
	LEFT JOIN
		veo_areas a ON asa.area_id = a.area_id
	LEFT JOIN
		veo_sub_areas sa ON asa.sub_area_id = sa.sub_area_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_getApplicationIcon]...';


GO
CREATE PROCEDURE [dbo].[vds_getApplicationIcon]
	@application nvarchar(100),
	@security_token uniqueidentifier
AS

/*
	Author: Art deHoyos
	Create Date: 12/06/2019
	Description: Return application icon and tags
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	DECLARE @icon_id UNIQUEIDENTIFIER;

	-- Capture the icon id
	SELECT @icon_id = i.[id]
	FROM [dbo].[icon] i
	JOIN [dbo].[application_icon] ai
		ON ai.[icon_id] = i.[id]
	WHERE ai.[application] = @application

	-- Get the icon info
	SELECT
		i.[id],
		i.[name],
		i.[mime_type]
	FROM
		[dbo].[icon] i
	WHERE i.[id] = @icon_id

	-- Get the tags that match the icon id
	SELECT it.[tag]
	FROM [dbo].[icon_tags] it
	WHERE [icon_id] = @icon_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_getApplicationsByIconId]...';


GO
CREATE PROCEDURE [dbo].[vds_getApplicationsByIconId]
	@icon_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Create Date: 08/20/2024
	Description: Returns the list of applications that are associated with the icon id.
*/

BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	SELECT
		a.[application_id],
		a.[name]
	FROM
		[dbo].[application_icon] ai
	INNER JOIN
		[Veo_Applications] a ON a.[name] = ai.[application]
	WHERE
		ai.[icon_id] = @icon_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_getBuildSelectionsReportDisclaimer]...';


GO
CREATE PROCEDURE [dbo].[vds_getBuildSelectionsReportDisclaimer]
@session_id UNIQUEIDENTIFIER,
@security_token UNIQUEIDENTIFIER
AS
/*
    Author: Saul Sanchez
    Created: 10/29/2015
    Description: Returns the disclaimer for the Buyer Selections Report.
*/
BEGIN

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT TOP 1
        ISNULL(d.document_data, CONVERT(varbinary(max), '')) as document_data
    FROM
        account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
        LEFT JOIN VeoSolutionsSecurity_account_organization_documents d WITH (NOLOCK)
            ON d.account_id = ppcs.account_id
            AND d.organization_id = ppcs.organization_id
            AND d.document_type = 'Selections Disclaimer'
    WHERE
        ppcs.session_id = @session_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_getBuildSelectionsReportInfo]...';


GO
CREATE PROCEDURE [dbo].[vds_getBuildSelectionsReportInfo]
@session_id UNIQUEIDENTIFIER,
@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Created: 10/29/2015
	Description: Returns information for the Buyer Selections Report.
*/
BEGIN

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		ppcs.session_id,
		ppcs.[status],
		ppcs.create_date as catalog_create_date,
		ppcs.effective_date,
		ppcs.buyer_signature,
		ppcs.buyer_signature_date,
		ppcs.designer_id,
		ppcs.designer,
		pp.community_name,
		pp.series,
		pp.plan_name,
		pp.[address],
		pp.lot,
		pp.block,
		pp.job_no,
		pp.upgrades_incentive,
		pp.additional_design_deposit,
		pp.sales_price,
		pp.sales_options,
		pp.home_down_payment,
		pp.home_allowance,
		pp.elevation,
		ISNULL(u.first_name, '') as buyer_first_name,
		ISNULL(u .last_name, '') as buyer_last_name,
		o.name as builder_name,
		o.show_home_price_on_report
	FROM
		account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
		LEFT JOIN account_organization_user_profile_plan pp WITH (NOLOCK)
			ON pp.account_id = ppcs.account_id
			AND pp.organization_id = ppcs.organization_id
			AND pp.[user_id] = ppcs.[user_id]
			AND pp.community_name = ppcs.community_name
			AND pp.series = ppcs.series
			AND pp.plan_name = ppcs.plan_name
		LEFT JOIN account_organization_user_profile p WITH (NOLOCK)
			ON p.account_id = ppcs.account_id
			AND p.organization_id = ppcs.organization_id
			AND p.[user_id] = ppcs.[user_id]
		LEFT JOIN VeoSolutionsSecurity_users u WITH (NOLOCK)
			ON u.[user_id] = ppcs.[user_id]
		LEFT JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK)
			ON o.organization_id = ppcs.organization_id
	WHERE
		ppcs.session_id = @session_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_getBuildSelectionsReportSortRules]...';


GO
CREATE PROCEDURE [dbo].[vds_getBuildSelectionsReportSortRules]
@session_id UNIQUEIDENTIFIER,
@security_token UNIQUEIDENTIFIER
AS
/*
    Author: Saul Sanchez
    Created: 10/30/2015
    Description: Returns a list of sort rules for the account and organization
                 of the specified session.
*/
BEGIN

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    DECLARE @account_id UNIQUEIDENTIFIER
    DECLARE @organization_id UNIQUEIDENTIFIER

    SELECT
        @account_id = account_id,
        @organization_id = organization_id
    FROM
        account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
    WHERE
        ppcs.session_id = @session_id

    SELECT
        [application],
        product,
        ISNULL(sort_order, 9999999) as sort_order
    FROM
        account_organization_application_product_sort_order apso WITH (NOLOCK)
    WHERE   
        apso.account_id = @account_id
        AND apso.organization_id = @organization_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_getCurrentSystemMessage]...';


GO
CREATE PROCEDURE [dbo].[vds_getCurrentSystemMessage]
@current_date_time DATETIME
AS
/*
    Author: Saul Sanchez
    Created: 01/07/2016
    Description: Return the current system message.
*/
BEGIN

    SELECT
        start_date_time,
        end_date_time,
        [message]
    FROM
        system_messages WITH (NOLOCK)
    WHERE
        start_date_time < @current_date_time
        AND end_date_time > @current_date_time

END
GO
PRINT N'Creating Procedure [dbo].[vds_getDesignSessionWizardAccentPrompts]...';


GO
CREATE PROCEDURE [dbo].[vds_getDesignSessionWizardAccentPrompts]
    @security_token UNIQUEIDENTIFIER
AS

/*
	Procedure:		vds_getDesignSessionWizardAccentPrompts
	Author:			Saul Sanchez
	Date:			04/13/2015
	Purpose:		Specialized procedure for VEO Design Studio Selection Wizard Accent Prompt Selection
	Usages:			vds_getDesignSessionWizardAccentPrompts

*/

-- =====================
-- Authentication
-- =====================
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

SELECT
    source_uom,
    user_prompt,
    per_sqft
FROM
    Veo_accent_sqft_conversions WITH (NOLOCK)
GO
PRINT N'Creating Procedure [dbo].[vds_getEncryptedPassword]...';


GO
CREATE PROCEDURE [dbo].[vds_getEncryptedPassword]
	@user_id UNIQUEIDENTIFIER

AS
/*
	Author: Saul Sanchez
	Create Date: 04/10/2018
	Description: Gets the encrypted password.
*/
BEGIN
	SELECT
		[password],
		salt,
		hash_provider
	FROM
		VeoSolutionsSecurity_users
	WHERE
		[user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_getEncryptedTemporaryPassword]...';


GO
CREATE PROCEDURE [dbo].[vds_getEncryptedTemporaryPassword]
	@user_id UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Create Date: 04/10/2018
	Description: Gets the encrypted temporary password.
*/
BEGIN
	SELECT
		temporary_password AS [password],
		salt,
		hash_provider
	FROM
		VeoSolutionsSecurity_users
	WHERE
		[user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_getFloorplan]...';


GO
CREATE PROCEDURE [dbo].[vds_getFloorplan]
	@id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Create Date: 10/24/2017
	Description: Returns a floorplan for a given id.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	SELECT
		[id],
		[name],
		[background_image],
		[report_image],
		[serialized_data],
		[account_id],
		[organization_id],
		[user_id],
		[community],
		[series],
		[plan]
	FROM
		[dbo].[floorplans]
	WHERE
		id = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_getFloorplanBackgroundImage]...';


GO
CREATE PROCEDURE [dbo].[vds_getFloorplanBackgroundImage]
	@id UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Create Date: 10/24/2017
	Descrioption: Returns the background image for a floorplan.
*/
BEGIN
	SELECT
		[background_image]
	FROM
		[dbo].[floorplans]
	WHERE
		id = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_getFloorplanReportImage]...';


GO
CREATE PROCEDURE [dbo].[vds_getFloorplanReportImage]
	@id UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Create Date: 12/26/2017
	Description: Returns the report image for a floorplan.
*/
BEGIN
	SELECT
		[report_image]
	FROM
		[dbo].[floorplans]
	WHERE
		id = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_getFloorplanSequence]...';


GO
CREATE PROCEDURE [dbo].[vds_getFloorplanSequence]
	@profile_plan_id UNIQUEIDENTIFIER, 
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Robert Hobbs
	Create Date: 04/27/18
	Decription: Returns the sequence of floorplans for a profile plan id 
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	SELECT
		top 1 [sequence]
	FROM
		[dbo].[floorplans_sequence]
	WHERE
		profile_plan_id = @profile_plan_id
		
END
GO
PRINT N'Creating Procedure [dbo].[vds_getFloorplansForProfilePlan]...';


GO
CREATE PROCEDURE [dbo].[vds_getFloorplansForProfilePlan]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER, 
	@user_id UNIQUEIDENTIFIER,
	@community VARCHAR(50),
	@series VARCHAR(50),
	@plan VARCHAR(50),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Create Date: 10/24/2017
	Decription: Returns all of the floorplans for a given profile plan.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	SELECT
		[id],
		[name],
		[background_image],
		[report_image],
		[serialized_data],
		[account_id],
		[organization_id],
		[user_id],
		[community],
		[series],
		[plan], 
		[create_date]
	FROM
		[dbo].[floorplans]
	WHERE
		account_id = @account_id
		AND organization_id = @organization_id
		AND [user_id] = @user_id
		AND community = @community
		AND series = @series
		AND [plan] = @plan
END
GO
PRINT N'Creating Procedure [dbo].[vds_getFloorplansForProfilePlanById]...';


GO
CREATE PROCEDURE [dbo].[vds_getFloorplansForProfilePlanById]
	@profile_plan_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Robert Hobbs
	Create Date: 04/27/18
	Decription: Returns all of the floorplans for a given profile plan.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	SELECT
		f.[id],
		f.[name],
		f.[background_image],
		f.[report_image],
		f.[serialized_data],
		f.[account_id],
		f.[organization_id],
		f.[user_id],
		f.[community],
		f.[series],
		f.[plan], 
		f.[create_date]
	FROM
		[dbo].[floorplans] f
		JOIN account_organization_user_profile_plan p ON p.account_id = f.account_id
			AND p.organization_id = f.organization_id
			AND p.[user_id] = f.[user_id]
			AND p.community_name = f.community
			AND p.series = f.series
			AND p.plan_name = f.[plan]
	WHERE
		p.profile_id = @profile_plan_id
		
END
GO
PRINT N'Creating Procedure [dbo].[vds_getHomebuyerAggregate]...';


GO
CREATE PROCEDURE [dbo].[vds_getHomebuyerAggregate]
	@organization_id UNIQUEIDENTIFIER,
	@email VARCHAR(100),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Date:   4/14/2016
	Description: Returns multiple record sets.  Each record set returns information
			about the homebuyer, and the homebuyer's profile plans.

	Modified: Shelby Mansker
	Date: 7/2/2018
	Description: Removed External ID from the parameters. We are no longer using External User Id to uniquely identify a user.

	History: 
		04.22.16 modified to fetch user based on external id first, and removed 
			externa_user_id from final select WHERE clause  - RH 

		--testing (note: doesn't work if no external user id exists) 
		vds_getHomebuyerAggregate '8AAECC3A-2D9E-4500-B0CF-D79D947D33A7', 'ca359026-6d83-4eea-ab3a-94220f197f9d', 'ca359026-6d83-4eea-ab3a-94220f197f9d@postmancollection.com', '01234567-89AB-CDEF-0000-123456789ABC'
		vds_getHomebuyerAggregate '8AAECC3A-2D9E-4500-B0CF-D79D947D33A7', NULL, 'ca359026-6d83-4eea-ab3a-94220f197f9d@postmancollection.com', '01234567-89AB-CDEF-0000-123456789ABC'

*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	-- Get the Account Id.
	DECLARE @account_id UNIQUEIDENTIFIER
	SELECT
		@account_id = account_id
	FROM
		VeoSolutionsSecurity_account_organizations WITH (NOLOCK)
	WHERE
		organization_id = @organization_id

	IF (@account_id IS NULL)
	BEGIN
		RETURN
	END

	DECLARE @user_id UNIQUEIDENTIFIER

	-- Get the User Id using email 
	SELECT
		@user_id = [user_id]
	FROM
		VeoSolutionsSecurity_users WITH (NOLOCK)
	WHERE
		email = @email

	IF (@user_id IS NULL)
	BEGIN
		RETURN
	END

	-- Select the homebuyer information.
	SELECT
		aou.account_id,
		aou.organization_id,
		aou.[user_id],
		u.email,
		aou.external_id,
		aoup.profile_id,
		aou.first_name,
		aou.last_name,
		aou.active
	FROM
		VeoSolutionsSecurity_users u WITH (NOLOCK) 
		JOIN VeoSolutionsSecurity_account_organization_users aou WITH (NOLOCK) ON aou.user_id = u.user_id
		LEFT JOIN account_organization_user_profile aoup WITH (NOLOCK) ON aoup.account_id = aou.account_id AND aoup.organization_id = aou.organization_id AND aoup.[user_id] = aou.[user_id]
	WHERE
		u.user_id = @user_id 
		AND aou.account_id = @account_id
		AND aou.organization_id = @organization_id
       
	-- Select the homebuyer plan information.
	SELECT
		pp.account_id,
		pp.organization_id,
		pp.[user_id],
		u.email,
		aou.external_id,
		pp.profile_id,
		community_name,
		series,
		plan_name,
		elevation,
		[status],
		[address],
		lot,
		block,
		city,
		[state],
		zip_code,
		sales_price,
		contract_date,
		home_phone,
		work_phone,
		spouse_phone,
		job_no,
		upgrades_incentive,
		sales_options,
		additional_design_deposit,
		home_down_payment,
		home_allowance,
		stage
	FROM
		VeoSolutionsSecurity_users u WITH (NOLOCK) 
		JOIN VeoSolutionsSecurity_account_organization_users aou WITH (NOLOCK) ON aou.user_id = u.user_id
		JOIN account_organization_user_profile_plan pp WITH (NOLOCK) ON pp.account_id = aou.account_id AND pp.organization_id = aou.organization_id AND pp.user_id = aou.user_id 
	WHERE
		u.user_id = @user_id 
		AND aou.account_id = @account_id
		AND aou.organization_id = @organization_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_getJobStagesBySession]...';


GO
CREATE PROCEDURE [dbo].[vds_getJobStagesBySession]
	@session_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Date: 12/21/2016
	Description: Returns the job stages for the profile plan of the specified session.
*/
BEGIN
	-- Validate the security token.
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Get the data needed to find job stages.
	DECLARE @job_no VARCHAR(20)
	DECLARE @account_org_id UNIQUEIDENTIFIER

	SELECT
		@job_no = RTRIM(LTRIM(pp.job_no)),
		@account_org_id = ao.account_org_id
	FROM
		dbo.account_organization_user_profile_plan_catalog_sessions ppcs
		LEFT JOIN dbo.account_organization_user_profile_plan pp
			ON pp.account_id = ppcs.account_id
			AND pp.organization_id = ppcs.organization_id
			AND pp.[user_id] = ppcs.[user_id]
			AND pp.community_name = ppcs.community_name
			AND pp.series = ppcs.series
			AND pp.plan_name = ppcs.plan_name
		LEFT JOIN VeoSolutionsSecurity_account_organizations ao
			ON ao.account_id = ppcs.account_id
			AND ao.organization_id = ppcs.organization_id
	WHERE
		ppcs.session_id = @session_id

	-- Break out now if we don't have a job number.
	IF (@job_no IS NULL OR @job_no = '')
	BEGIN
		RETURN
	END

	-- Get the job stages.
	SELECT
		id,
		account_org_id,
		job_no,
		stage_id,
		stage_name,
		stage_date,
		stage_date_override,
		stage_date_override_author,
		author,
		create_date,
		modifier,
		modified_date
	FROM
		dbo.jobs_stages
	WHERE
		account_org_id = @account_org_id
		AND job_no = @job_no

END
GO
PRINT N'Creating Procedure [dbo].[vds_getLogins]...';


GO
CREATE PROCEDURE [dbo].[vds_getLogins]
	@user_id UNIQUEIDENTIFIER,
	@count INT
AS

/*
Author: Art deHoyos
Date: 1/3/2019
Description: Gets the most recent @count login dates for a given user
*/

BEGIN
	SELECT TOP (@count)
		vssu.email,
		vssuls.create_date
	FROM VeoSolutionsSecurity_users vssu
	JOIN VeoSolutionsSecurity_users_login_sessions vssuls
	ON vssu.[user_id] = vssuls.[user_id]
	WHERE vssu.[user_id] = @user_id
	ORDER BY vssuls.create_date DESC
END
GO
PRINT N'Creating Procedure [dbo].[vds_getOptionPricingSessionSelections]...';


GO
CREATE PROCEDURE [dbo].[vds_getOptionPricingSessionSelections]
@session_id UNIQUEIDENTIFIER,
@application_name VARCHAR(50) = '',
@product_name VARCHAR(50) = '',
@security_token UNIQUEIDENTIFIER
AS

SELECT 
	ISNULL(bs.contract_sort_order,9999999) AS sort_order,
	cs.*,
	ISNULL(rg.[description],'') AS room_group,
	ISNULL(rg.sort_order,9999999) AS room_group_sort_order,
    ISNULL(bs.contract_sort_order, 9999999) AS contract_sort_order,
	doc_count = (select count(*) from gpc_products_documents with (nolock) where gpc_id = try_convert(uniqueidentifier,cs.gpc) )
FROM 
	catalog_selections cs with (nolock)
	LEFT JOIN veo_areas va with (nolock) on va.area_id = cs.area_id
	LEFT JOIN veo_room_groups rg with (nolock) on rg.code = va.room_group
	LEFT JOIN Veo_applications a with (nolock) on a.name = cs.[application]
	LEFT JOIN Veo_products p with (nolock) on p.name = cs.product
	LEFT JOIN account_organization_user_profile_plan_catalog_sessions s with (nolock) on s.session_id = cs.session_id
	LEFT JOIN Veo_builder_styles bs with (nolock)
		ON bs.spec_id = s.spec_id 
		AND bs.application_id = a.application_id
		AND bs.product_id = p.product_id
		AND bs.item_type = cs.item_type
		AND bs.item = cs.item_no
		AND bs.effective_date = s.effective_date 
	LEFT JOIN catalog_selections_areas csa with (nolock)
		ON csa.session_id = cs.session_id
		AND csa.[application] = cs.[application]
		AND csa.product = cs.product
		AND csa.area = cs.area
		AND csa.sub_area = cs.sub_area
		AND csa.area_id = cs.area_id
		AND csa.sub_area_id = cs.sub_area_id
WHERE 
	cs.session_id = @session_id
    AND (@application_name = '' OR cs.[application] = @application_name)
    AND (@product_name = '' OR cs.product = @product_name)
	AND ((cs.[source] != 'Prices Landed') or (cs.[source] = 'Prices Landed' AND csa.area_selected = 1))
GO
PRINT N'Creating Procedure [dbo].[vds_getOrganizationFromSession]...';


GO

CREATE procedure [dbo].[vds_getOrganizationFromSession]
@session_id uniqueidentifier,
@security_token uniqueidentifier
as
/*
vds_getOrganizationFromSession '5b7a9ef9-6359-4830-b07f-47c4fdd91c51'
*/


-- Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

select 
	*
from account_organization_user_profile_plan_catalog_sessions s with (nolock)
left join vss_organizations o with (nolock) on o.organization_id = s.organization_id
where session_id = @session_id
GO
PRINT N'Creating Procedure [dbo].[vds_getPartAttributes]...';


GO
CREATE PROCEDURE dbo.vds_getPartAttributes
    @part_no VARCHAR(31),
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 01/29/2015
    Description: Returns all of the attributes for a given part number.

    EXEC dbo.vds_getPartAttributes @part_no = '3HR03/HR03HT1', @security_token = '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Return the Part Attributes
    SELECT DISTINCT
        pac.[description] AS attribute,
	    pav.[description] AS value
    FROM 
        Veo_colors c WITH (NOLOCK)
        LEFT JOIN Veo_colors_attributes ca WITH (NOLOCK) ON ca.product_id = c.product_id AND ca.color_id = c.color_id AND ca.style_id = c.style_id
        LEFT JOIN Veo_products_attributes pac WITH (NOLOCK) ON pac.product_id = c.product_id AND pac.attribute_id = ca.attribute_id
        LEFT JOIN Veo_products_attributes_values pav WITH (NOLOCK) ON pav.product_id = pac.product_id AND pav.attribute_id = pac.attribute_id AND pav.value_id = ca.value_id
    WHERE 
        c.part_no = @part_no
        AND pac.homebuyer_searchable = 1
	  
    UNION
	  
    SELECT DISTINCT
        pac.[description] AS attribute,
	    pav.[description] AS value
    FROM 
        Veo_colors c WITH (NOLOCK)
        LEFT JOIN Veo_styles_attributes sa WITH (NOLOCK) ON sa.product_id = c.product_id AND sa.style_id = c.style_id
        LEFT JOIN Veo_products_attributes pac WITH (NOLOCK) ON pac.product_id = c.product_id AND pac.attribute_id = sa.attribute_id
        LEFT JOIN Veo_products_attributes_values pav WITH (NOLOCK) ON pav.product_id = pac.product_id AND pav.attribute_id = pac.attribute_id AND pav.value_id = sa.value_id
    WHERE 
        c.part_no = @part_no
	    AND pac.homebuyer_searchable = 1
	    AND sa.value_id IS NOT NULL
END
GO
PRINT N'Creating Procedure [dbo].[vds_getRoleIdByName]...';


GO
-- ===============================================================
-- Author:		Saul Sanchez
-- Create date: 03/28/2016
-- Description:	This procedure gets the role id with the specified
--              role name.
-- Modified to use a new function (to share with other procs) 
-- 05.31.16 RH 
-- ===============================================================
CREATE PROCEDURE [dbo].[vds_getRoleIdByName]
    @role_name VARCHAR(50),
    @security_token UNIQUEIDENTIFIER
AS
BEGIN
	
	-- vds_getRoleIdByName 'Builder Sales Counselor', '01234567-89AB-CDEF-0000-123456789ABC'
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END
	
	DECLARE @role_id UNIQUEIDENTIFIER 
	SELECT @role_id = dbo.vdsf_selRoleIdByName(@role_name) 

	select @role_id as role_id 

    --SELECT
    --     role_id
    --FROM
    --    VeoSolutionsSecurity_roles WITH (NOLOCK)
    --WHERE
    --    name = @role_name

END
GO
PRINT N'Creating Procedure [dbo].[vds_getRoomsByIconId]...';


GO
CREATE PROCEDURE [dbo].[vds_getRoomsByIconId]
	@icon_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Create Date: 08/20/2024
	Description: Returns the list of rooms that are associated with the icon id.
*/

BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	SELECT
		r.[id],
		r.[name],
		r.[icon_id],
		r.[author],
		r.[create_date],
		r.[modifier],
		r.[modified_date]
	FROM
		[dbo].[rooms] r
	WHERE
		r.[icon_id] = @icon_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_getSalesCounselorUserSessions]...';


GO
CREATE procedure [dbo].[vds_getSalesCounselorUserSessions]
	@user_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
as
/*
	Author:      Adrian Garza
	Create date: 3/30/2015
	Description: Gets all completed,invoiced session for a user

	Usages: vds_getSalesCounselorUserSessions '424059bc-e4c9-4f21-bdc2-52e5a24bf9ae','22ddcb5a-81e4-4d91-92ce-d416d829f88c'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

select
s.session_id,
st.status,
p.community_name,
p.series,
p.plan_name,
p.address,
o.name as builder,
s.completed_date

from account_organization_user_profile_plan_catalog_sessions s with (nolock)
left join session_statuses st with (nolock) on st.status_id = s.status
left join account_organization_user_profile_plan p with (nolock) on 
	p.account_id = s.account_id
	and p.organization_id = s.organization_id
	and p.user_id = s.user_id
	and p.community_name = s.community_name
	and p.series = s.series
	and p.plan_name = s.plan_name
left join veosolutionssecurity_organizations o with (nolock) on 
	o.organization_id = p.organization_id

where s.user_id = @user_id
and s.status in (2,3) -- completed,invoiced

end
GO
PRINT N'Creating Procedure [dbo].[vds_getSectionsForRoom]...';


GO
CREATE PROCEDURE [dbo].[vds_getSectionsForRoom]
@room_id UNIQUEIDENTIFIER,
@security_token UNIQUEIDENTIFIER

AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	SELECT
		rs.id,
		rs.room_id,
		asa.area_id,
		a.[name] AS area_name,
		asa.sub_area_id,
		sa.[name] AS sub_area_name,
		rs.author,
		rs.create_date,
		rs.modifier,
		rs.modified_date
	FROM 
		veo_areas_sub_areas asa
	LEFT JOIN veo_areas a ON asa.area_id = a.area_id
	LEFT JOIN veo_sub_areas sa ON asa.sub_area_id = sa.sub_area_id
	LEFT JOIN room_sections rs ON rs.area_id = asa.area_id AND rs.sub_area_id = asa.sub_area_id
	WHERE rs.room_id = @room_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_getSelectedSlabs]...';


GO
CREATE PROCEDURE [dbo].[vds_getSelectedSlabs]
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Date: 05/04/2017
	Description: Returns the slabs that have been selected for a build for a session.
*/
BEGIN
	-- Validate the security token.
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		session_id,
		build_id,
		slab_id
	FROM
		dbo.catalog_selections_area_slabs
	WHERE
		session_id = @session_id
		AND build_id = @build_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_getSession]...';


GO
CREATE PROCEDURE [dbo].[vds_getSession]
	@session_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Create Date: 7/20/2015
    Description: Fetches the session record for the passed in session id.

	Modified: Shelby Mansker
	Date: 8/9/2018
	Description: Returns the status_change_reason field.

	Modified: Robert hobbs
	Date: 9/4/18
	Description: Return report_id now 

	Modified: Art deHoyos
	Date: 10/9/2018
	Description: Added show_report field.

    Modified by: Daniel Arwe
    Modified Date: 08/18/2025
    Description: Added precon_notes field to query.

*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Fetch the matching session record
	SELECT
        aouppcs.[account_id],
        aouppcs.[organization_id],
        aouppcs.[user_id],
        aouppcs.[community_id],
        aouppcs.[community_name],
		aos.[series_id],
        aouppcs.[series],
		aoupp.[profile_id] AS profile_plan_id,
        aop.[plan_id] AS base_plan_id,
        aop.[name] AS base_plan_name,
        aouppcs.[plan_name],
        aouppcs.[plan_version],
        aouppcs.[session_id],
        aouppcs.[status],
		aouppcs.[status_change_reason],
        aouppcs.[session_notes],
        aouppcs.[precon_notes],
        aouppcs.[deposit],
        aouppcs.[deposit_notes],
        aouppcs.[designer_id],
        aouppcs.[designer],
		aouppcs.[show_report],
        aouppcs.[spec_id],
        aouppcs.[effective_date],
        aouppcs.[completed_date],
        aouppcs.[first_completed_date],
        aouppcs.[export_date],
        aouppcs.[address_id],
        aouppcs.[rounding_type],
        aouppcs.[rounding_places],
        aouppcs.[builder_markup_hb_pricing],
        aouppcs.[buyer_signature],
        aouppcs.[buyer_signature_date],
        aouppcs.[pricing_generated],
        aouppcs.[pricing_published],
		aouppcs.[report_id],
        aouppcs.[author],
        aouppcs.[create_date],
        aouppcs.[modifier],
        aouppcs.[modified_date],
        aouppcs.[catalog_source]
    FROM
        dbo.account_organization_user_profile_plan_catalog_sessions aouppcs WITH (NOLOCK)
		JOIN account_organization_user_profile_plan aoupp WITH (NOLOCK)
			ON aouppcs.account_id = aoupp.account_id
			AND aouppcs.organization_id = aoupp.organization_id
			AND aouppcs.[user_id] = aoupp.[user_id]
			AND aouppcs.series = aoupp.series
			AND aouppcs.plan_name = aoupp.plan_name
			AND aouppcs.community_name = aoupp.community_name
		JOIN dbo.VeoSolutionsSecurity_account_organization_series aos WITH(NOLOCK)
			ON aos.account_id = aouppcs.account_id
			AND aos.organization_id = aouppcs.organization_id
			AND aos.[name] = aouppcs.series
		JOIN dbo.VeoSolutionsSecurity_account_organization_plans aop WITH(NOLOCK)
			ON aop.account_id = aouppcs.account_id
			AND aop.organization_id = aouppcs.organization_id
			AND aop.[name] = aoupp.base_plan_name
    WHERE
        session_id = @session_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_getSessionStatusName]...';


GO
CREATE PROCEDURE [dbo].[vds_getSessionStatusName]
    @status_id INT,
    @security_token UNIQUEIDENTIFIER
AS
/*
	Modified: Shelby Mansker
	Date: 8/9/2018
	Description: No longer returns the status id. Not necessary, since it is
		passed in as a parameter, and it makes the stored procedure easier to
		use with DbInsight.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT
        [status]
    FROM
        dbo.session_statuses WITH (NOLOCK)
    WHERE
        status_id = @status_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_getSlabReportDetails]...';


GO
CREATE PROCEDURE [dbo].[vds_getSlabReportDetails]
	@session_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Date: 06/02/2017
	Description: Returns the selected slabs for a session to be used in the Slab Report.
*/
BEGIN
	-- Validate the security token.
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		a.area,
		a.sub_area,
		s.slab_id,
		ISNULL(c.[name], '') AS color_name
	FROM
		dbo.catalog_selections_area_slabs s
		LEFT JOIN dbo.catalog_selections_areas a
			ON a.session_id = s.session_id
			AND a.build_id = s.build_id
		LEFT JOIN dbo.catalog_selections_area_details d
			ON d.session_id = s.session_id
			AND d.[application] = a.[application]
			AND d.product = a.product
			AND d.area = a.area
			AND d.sub_area = a.sub_area
			AND item_type = 'material'
			AND item_id = 'field'
		LEFT JOIN dbo.veo_colors c
			ON c.part_no = d.real_item_id
	WHERE
		s.session_id = @session_id
	ORDER BY
		a.area,
		a.sub_area
END
GO
PRINT N'Creating Procedure [dbo].[vds_getSpecAreaItemsBySessionBuild]...';


GO
CREATE procedure vds_getSpecAreaItemsBySessionBuild
@session_id uniqueidentifier,
@build_id int,
@security_token UNIQUEIDENTIFIER = NULL

as
/*

vds_getSpecAreaItemsBySessionBuild 'cc29a049-7efc-4323-8d4d-71cc34aa4406',10982871,'01234567-89AB-CDEF-0000-123456789ABC'

*/



IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

declare @spec_id int

select 
 @spec_id = spec_id
from account_organization_user_profile_plan_catalog_sessions s with (nolock)
where s.session_id = @session_id

print @spec_id



declare @area_id varchar(50)
declare @sub_area_id varchar(50)



select top 1 
	@area_id = area_id,
	@sub_area_id = sub_area_id
from catalog_selections
where session_id = @session_id and  build_id = @build_id

print @area_id
print @sub_area_id

select 
* 
from veo_spec_areas_items
where spec_id = @spec_id
and area_id = @area_id
and sub_area_id = @sub_area_id
GO
PRINT N'Creating Procedure [dbo].[vds_getTermsOfServiceAccepted]...';


GO
CREATE PROCEDURE [dbo].[vds_getTermsOfServiceAccepted]
    @user_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
	Modified: Saul Sanchez
	Date: 09/10/2019
	Description: Checks whether the user has accepted the terms of service, and returns a boolean.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DECLARE @result BIT = 0

	SELECT 
		@result = accepted
	FROM
		VeoSolutionsSecurity_users_terms_of_service
	WHERE
		[user_id] = @user_id

	SELECT @result
END
GO
PRINT N'Creating Procedure [dbo].[vds_getUnassignedRoomSections]...';


GO
CREATE PROCEDURE [dbo].[vds_getUnassignedRoomSections]
@security_token UNIQUEIDENTIFIER

AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	SELECT
		asa.area_id,
		a.[name] AS area_name,
		asa.sub_area_id,
		sa.[name] AS sub_area_name
	FROM 
		veo_areas_sub_areas asa
	LEFT JOIN veo_areas a ON asa.area_id = a.area_id
	LEFT JOIN veo_sub_areas sa ON asa.sub_area_id = sa.sub_area_id
	WHERE NOT EXISTS (
		SELECT 1 
		FROM room_sections rs 
		WHERE rs.area_id = asa.area_id
		AND rs.sub_area_id = asa.sub_area_id
	)
END
GO
PRINT N'Creating Procedure [dbo].[vds_importHomebuyerCatalogPriceLevelFilters]...';


GO
CREATE PROCEDURE [dbo].[vds_importHomebuyerCatalogPriceLevelFilters]
	@session_id UNIQUEIDENTIFIER,
	@security_token varchar(36)
AS
/*
	Author: Roger Wang
	Date: 4/19/2022
	Description: Imports price level filters from option budget items
*/
BEGIN
	DECLARE @edit_user_id VARCHAR(75)
	SET @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	IF (@edit_user_id IS NULL)
		BEGIN
			RAISERROR('Invalid credentials.',16,1)
			RETURN
		END

	INSERT INTO [dbo].[homebuyer_catalog_price_level_filters] (
		[id],
		[session_id],
		[room_id],
		[application_id],
		[product_id],
		[item_no],
		[author],
		[create_date],
		[modifier],
		[modified_date]
	)
	select
		NEWID() as [id],
		@session_id as [session_id],
		*,
		@edit_user_id as [author],
		GETDATE() as [create_date],
		@edit_user_id as [modifier],
		GETDATE() as [modified_date]
	from (
		select distinct
			rs.[room_id],
			a.[application_id],
			p.[product_id],
			bi.item_no
		from
			account_organization_user_profile_plan_catalog_sessions s with (nolock)
			inner join account_organization_user_profile_plan_options_budget_items bi with (nolock)
				on bi.account_id = s.account_id
				and bi.organization_id = s.organization_id
				and bi.[user_id] = s.[user_id]
				and bi.community = s.community_name
				and bi.series = s.series
				and bi.plan_name = s.plan_name
			inner join catalog_selections_areas csa with (nolock)
				on csa.session_id = s.session_id
				and csa.application = bi.application_name
				and csa.product = bi.product_name
				and csa.area = bi.area
			inner join room_sections rs with (nolock)
				on rs.area_id = csa.area_id
				and rs.sub_area_id = csa.sub_area_id
			inner join veo_applications a with (nolock) on a.[name] = csa.[application]
			inner join veo_products p with (nolock) on p.[name] = csa.[product]
		where
			s.session_id = @session_id
			and bi.source in ('Prices Landed', 'Contract')
	) a
END
GO
PRINT N'Creating Procedure [dbo].[vds_insAccountOrganizationCommunitySeriesPlan]...';


GO
CREATE PROCEDURE [dbo].[vds_insAccountOrganizationCommunitySeriesPlan]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@community_id UNIQUEIDENTIFIER,
	@series_id	UNIQUEIDENTIFIER,
	@plan_id	UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 7/16/2019
	Description: Adds a community series plan combo under an account organization

	Modifier: Shelby Mansker
	Date: 8/30/2019
	Description: A new community series combo must also be added, when adding a new community
		series plan combo, due to DB constraints.
*/
BEGIN
	DECLARE @edit_user_id VARCHAR(75)
	SET @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	IF (@edit_user_id IS NULL)
		BEGIN
			RAISERROR('Invalid credentials.',16,1)
			RETURN
		END

	-- Make sure that there is an entry in the account_organization_community_series table first.
	IF (NOT EXISTS (SELECT TOP(1) * FROM VeoSolutionsSecurity_account_organization_community_series WHERE account_id = @account_id AND organization_id = @organization_id AND community_id = @community_id AND series_id = @series_id))
	BEGIN
		INSERT INTO VeoSolutionsSecurity_account_organization_community_series (
			account_id,
			organization_id,
			community_id,
			series_id,
			[name],
			author,
			create_date,
			modifier,
			modified_date
		)
		(
			SELECT TOP(1)
				@account_id,
				@organization_id,
				@community_id,
				@series_id,
				[name],
				@edit_user_id,
				GETDATE(),
				@edit_user_id,
				GETDATE()
			FROM
				VeoSolutionsSecurity_account_organization_series
			WHERE
				account_id = @account_id
				AND organization_id = @organization_id
				AND series_id = @series_id
		)
	END

	-- Now add an entry to the account_organization_series_plan table
	INSERT INTO VeoSolutionsSecurity_account_org_community_series_plan (
		[account_id],
		[organization_id],
		[community_id],
		[series_id],
		[plan_id],
		[author],
		[create_date],
		[modifier],
		[modified_date] 
	)
	VALUES (
		@account_id,
		@organization_id,
		@community_id,
		@series_id,
		@plan_id,
		@edit_user_id,
		GETDATE(),
		@edit_user_id,
		GETDATE() 
	)
END
GO
PRINT N'Creating Procedure [dbo].[vds_insAccountOrganizationDocument]...';


GO
CREATE PROCEDURE [dbo].[vds_insAccountOrganizationDocument]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@doc_id UNIQUEIDENTIFIER,
	@application VARCHAR(100),
	@product VARCHAR(100),
	@description VARCHAR(255),
	@notes VARCHAR(255),
	@allow_inclusion_buyer_packet BIT,
	@size INT,
	@doc_data VARBINARY(MAX),
	@type VARCHAR(10),
	@url VARCHAR(MAX),
	@security_token UNIQUEIDENTIFIER = null
AS
/*
	Author: Roger Wang
	Date: 2/2/2022
	Description: Adds a document under an account organization
*/
BEGIN
	DECLARE @edit_user_id VARCHAR(75)
	SET @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	IF (@edit_user_id IS NULL)
		BEGIN
			RAISERROR('Invalid credentials.',16,1)
			RETURN
		END

	INSERT INTO account_organization_documents (
		[account_id],
		[organization_id],
		[doc_id],
		[application],
		[product],
		[description],
		[notes],
		[allow_inclusion_buyer_packet],
		[doc_data],
		[size],
		[type],
		[url],
		[author],
		[modifier]
	) VALUES (
		@account_id,
		@organization_id,
		@doc_id,
		@application,
		@product,
		@description,
		@notes,
		@allow_inclusion_buyer_packet,
		@doc_data,
		@size,
		@type,
		@url,
		@edit_user_id,
		@edit_user_id
	)
END
GO
PRINT N'Creating Procedure [dbo].[vds_insAccountOrganizationPlan]...';


GO
CREATE PROCEDURE [dbo].[vds_insAccountOrganizationPlan]
	@account_id uniqueidentifier,
	@organization_id uniqueidentifier,
	@plan_id uniqueidentifier = null output,
	@name varchar(50),
	@address_specific bit = 0,
	@archive bit = 0,
	@security_token uniqueidentifier
AS
/*
	Author: Roger Wang
	Date: 7/1/2019
	Description: Adds a plan under an account organization
*/
BEGIN
	declare @edit_user_id varchar(75)
	set @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	if (@edit_user_id is null)
		begin
			raiserror('Invalid credentials.',16,1)
			return
		end

	set @plan_id = NEWID();

	insert into VeoSolutionsSecurity_account_organization_plans (
		[account_id],
		[organization_id],
		[plan_id],
		[name],
		[address_specific],
		[archive],
		[author],
		[create_date],
		[modifier],
		[modified_date] )
	values (
		@account_id,
		@organization_id,
		@plan_id,
		@name,
		@address_specific,
		@archive,
		@edit_user_id,
		getdate(),
		@edit_user_id,
		getdate() )

	select @plan_id as plan_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_insAccountOrganizationUserProfile]...';


GO
CREATE PROCEDURE [dbo].[vds_insAccountOrganizationUserProfile]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @user_id UNIQUEIDENTIFIER,
    @interest_rate DECIMAL(18,6),
    @loan_term DECIMAL(18,6),
    @enable_homebuyer_access BIT,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Saul Sanchez
    Create Date: 07/19/2016
    Description: Inserts a new account organization user profile record.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    DECLARE @active_user_email varchar(100)
    SET @active_user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

    DECLARE @today DATETIME = GETDATE()

    INSERT INTO account_organization_user_profile (
        account_id,
        organization_id,
        [user_id],
        interest_rate,
        loan_term,
        enable_homebuyer_access,
        author,
        create_date,
        modifier,
        modified_date
    )
    VALUES (
        @account_id,
        @organization_id,
        @user_id,
        @interest_rate,
        @loan_term,
        @enable_homebuyer_access,
        @active_user_email,
        @today,
        @active_user_email,
        @today
    )
END
GO
PRINT N'Creating Procedure [dbo].[vds_insBuildBomLine]...';


GO
CREATE PROCEDURE [dbo].[vds_insBuildBomLine]
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
	@item_type VARCHAR(20),
	@item_id VARCHAR(50),
	@selectable BIT,
	@bom_real_item_id VARCHAR(50),
	@real_item_id VARCHAR(50),
	@bom_bill_qty DECIMAL(18,4),
	@bill_qty DECIMAL(18,4),
	@alloc_qty DECIMAL(18,4),
	@credit_qty DECIMAL(18,4),
	@bom_uom_id VARCHAR(9),
	@uom_id VARCHAR(9),
	@builder_price DECIMAL(18,4),
	@homeowner_price DECIMAL(18,4),
	@pattern_id INT,
	@is_pattern_item BIT,
	@pattern_percentage DECIMAL(18,4),
	@force_reprice BIT,
	@price_type VARCHAR(25),
	@price_source VARCHAR(25),
	@retail_percentage DECIMAL(18,4),
	@retail_percentage_type VARCHAR(10),
	@accent_prompt VARCHAR(20),
	@security_token UNIQUEIDENTIFIER = NULL
AS
/*
	Author:	Shelby Mansker
	Create date: 5/2/2014
	Description: Inserts a single BOM line for a build in a session.

	Updated 5/23/2014: Modified the security token code to be consistent
	with the rest of the stored procedures
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Get the application, product, area, and sub area for the specified build
	DECLARE @application VARCHAR(50)
	DECLARE @product VARCHAR(50)
	DECLARE @area VARCHAR(100)
	DECLARE @sub_area VARCHAR(50)
	
	SELECT
		@application = [application],
		@product = product,
		@area = area,
		@sub_area = sub_area
	FROM
		dbo.catalog_selections_areas WITH (NOLOCK)
	WHERE
		session_id = @session_id
		AND build_id = @build_id

	--Insert the Bom line
	INSERT INTO dbo.catalog_selections_area_details
	(
		session_id, 
		[application], 
		product, 
		area, 
		sub_area, 
		item_type, 
		item_id,
		bom_item_id,
		selectable,
		bom_real_item_id,
		real_item_id,
		bom_bill_qty,
		bill_qty,
		alloc_qty,
		credit_qty,
		bom_uom_id,
		uom_id,
		builder_price,
		homeowner_price,
		pattern_id,
		is_pattern_item,
		pattern_percentage,
		force_reprice,
		price_type,
		price_source,
		retail_percentage,
		retail_percentage_type,
		accent_prompt
	)
	VALUES
	(
		@session_id,
		@application,
		@product,
		@area,
		@sub_area,
		@item_type,
		@item_id,
		@item_id,
		@selectable,
		@bom_real_item_id,
		@real_item_id,
		@bom_bill_qty,
		@bill_qty,
		@alloc_qty,
		@credit_qty,
		@bom_uom_id,
		@uom_id,
		@builder_price,
		@homeowner_price,
		@pattern_id,
		@is_pattern_item,
		@pattern_percentage,
		@force_reprice,
		@price_type,
		@price_source,
		@retail_percentage,
		@retail_percentage_type,
		@accent_prompt
	)
END
GO
PRINT N'Creating Procedure [dbo].[vds_insBuildBomLineOption]...';


GO
CREATE procedure [dbo].[vds_insBuildBomLineOption]
@session_id uniqueidentifier,
@build_id int,
@item_type varchar(20),
@item_id varchar(50),
@option_id varchar(50),
@option_value varchar(50),
@option_source varchar(50),
@included bit,
@qty int,
@alloc_qty int,
@price decimal(18,2),
@price_retail decimal(18,2),
@retail_percentage decimal(18,2),
@retail_percentage_type varchar(10),
@price_type varchar(10),
@pricing_source varchar(50),
@error_message varchar(max) = '',
@security_token UNIQUEIDENTIFIER = NULL
as
/*
	Author:			Adrian Garza
	Create date:	12/4/2014
	Description:	Insert bom line option

*/

-- Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END


declare @application varchar(100),
@product varchar(100),
@area varchar(100),
@sub_area varchar(100)

select
	@application = application,
	@product = product,
	@area = area,
	@sub_area = sub_area
from catalog_selections with (nolock)
where session_id = @session_id and build_id = @build_id


--delete any existing 

delete from catalog_selections_area_detail_options
			where session_id = @session_id 
					and application = @application
					and product = @product
					and area = @area
					and sub_area = @sub_area
					and item_type = @item_type
					and item_id = @item_id
					and option_id = @option_id


	insert into catalog_selections_area_detail_options (
				session_id,application,product,area,sub_area,item_type,
				item_id,option_id,option_value,option_source,included,
				qty,alloc_qty,price,price_retail,retail_percentage,retail_percentage_type,
				price_type,pricing_source,error_message) 
			values(@session_id,@application ,@product ,@area ,@sub_area,@item_type,
				   @item_id ,@option_id,@option_value,@option_source,@included ,
				   @qty,@alloc_qty,@price,@price_retail,@retail_percentage,@retail_percentage_type,
				   @price_type,@pricing_source,@error_message)
GO
PRINT N'Creating Procedure [dbo].[vds_insBuildProperty]...';


GO
CREATE PROCEDURE [dbo].[vds_insBuildProperty]
	@id UNIQUEIDENTIFIER,
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
	@key VARCHAR(50),
	@value VARCHAR(MAX),
	@security_token UNIQUEIDENTIFIER
/*
	Author: Shelby Mansker
	Date: 5/22/2017
	Description: Inserts a build property
*/
AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END
	
    -- Get the email address for the user associated with the security token passed in
    DECLARE @user_email VARCHAR(100) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	INSERT INTO catalog_selections_area_properties (id, session_id, build_id, [key], [value], author, modifier)
	VALUES (@id, @session_id, @build_id, @key, @value, @user_email, @user_email)
END
GO
PRINT N'Creating Procedure [dbo].[vds_insCatalogSelectionGroupDetails]...';


GO
CREATE PROCEDURE [dbo].[vds_insCatalogSelectionGroupDetails]
    @session_id UNIQUEIDENTIFIER,
    @group_id INT = NULL,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 8/20/2015
    Description: Updates a session's group details. It first clears existing group details, before inserting new ones,
        for the session. If a group_id is passed in, it will only update that group's details. Group details are used
        to limit the selection options for specific groups in the session's selection wizard.

    Modified: Shelby Mansker
    Date: 8/21/2015
    Description: Modified the proc to handle all group details for a session, or a single group's details,
        based on the passed in group_id. If it is null, do all group details. Also, when group details are updated,
        we must check the group's price level bom to see if it has selected items, for selectable bom lines, that aren't
        in the group details. If it does, add those items automatically.
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Put this in a transaction and handle errors
    BEGIN TRANSACTION
    BEGIN TRY

        -- Grab today's date
        DECLARE @today_datetime DATETIME = GETDATE()
        DECLARE @today_date DATE = CONVERT(DATE, @today_datetime)

        -- Get the current user email from the security token
        DECLARE @current_user_email VARCHAR(100)
        SET @current_user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

        -- Make sure the passed in Group ID doesn't already exist. If it does, delete it
        IF (EXISTS(SELECT TOP 1 session_id FROM catalog_selections_group_detail WHERE session_id = @session_id AND (@group_id IS NULL OR group_id = @group_id)))
            BEGIN
                DELETE FROM catalog_selections_group_detail WHERE session_id = @session_id AND (@group_id IS NULL OR group_id = @group_id)
            END

		DECLARE @session_groups TABLE
		(
			session_id UNIQUEIDENTIFIER,
			item_no INT,
			external_organization_id VARCHAR(20)
		)

		INSERT INTO @session_groups
		SELECT DISTINCT
            cs.session_id,
			CAST(cs.item_no AS INT) AS item_no,
			o.external_organization_id
        FROM
            dbo.catalog_selections cs WITH (NOLOCK)
            JOIN dbo.account_organization_user_profile_plan_catalog_sessions aouppcs WITH (NOLOCK) ON aouppcs.session_id = cs.session_id
            JOIN dbo.VeoSolutionsSecurity_organizations o WITH (NOLOCK) ON o.organization_id = aouppcs.organization_id
        WHERE
            cs.session_id = @session_id
            AND cs.item_type = 'group'
            AND (@group_id IS NULL OR cs.item_no = @group_id)

        -- Obtain information so that we can search for non-published cabinet "group" cabinet spec items.
        DECLARE @spec_id INT
        DECLARE @external_organization_id VARCHAR(20)

        SELECT
            @spec_id = aouppcs.spec_id,
            @external_organization_id = o.external_organization_id
        FROM
            account_organization_user_profile_plan_catalog_sessions aouppcs WITH (NOLOCK)
            LEFT JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) ON o.organization_id = aouppcs.organization_id           
        WHERE
            session_id = @session_id

        -- Insert the group details from veo
        INSERT INTO catalog_selections_group_detail
        (
            session_id,
            group_id,
            item_type,
            item,
            author,
            create_date,
            modifier,
            modified_date,
            area_id,
            sub_area_id
        )
        SELECT DISTINCT
            cs.session_id,
            gd.group_id,
            gd.item_type,
            gd.item,
            @current_user_email AS author,
            @today_datetime AS create_date,
            @current_user_email AS modifier,
            @today_datetime AS modified_date,
            gd.area_id,
            gd.sub_area_id
        FROM
            @session_groups cs
            JOIN dbo.Veo_styles_groups_detail gd WITH (NOLOCK) on gd.group_id = cs.item_no AND gd.customer_id = cs.external_organization_id
        WHERE
            CONVERT(DATE, gd.effective_date) <= @today_date
            AND (gd.end_date IS NULL OR CONVERT(DATE, gd.end_date) >= @today_date)

        UNION

        -- Insert non-published cabinet "group" spec items.
        SELECT DISTINCT
            @session_id as session_id,
            sgd.group_id,
            sgd.item_type,
            sgd.item,
            @current_user_email AS author,
            @today_datetime AS create_date,
            @current_user_email AS modifier,
            @today_datetime AS modified_date,
            sgd.area_id,
            sgd.sub_area_id
        FROM
            veo_spec_items si WITH (NOLOCK)
            LEFT JOIN Veo_styles_groups sg WITH (NOLOCK) ON sg.group_id = si.item
            LEFT JOIN Veo_styles_groups_detail sgd WITH (NOLOCK) ON sgd.group_id = sg.group_id AND sgd.customer_id = @external_organization_id
        WHERE
            si.spec_id = @spec_id
            AND (@group_id IS NULL OR sgd.group_id = @group_id)
            AND si.application_id = '10'
            AND si.product_id = 'Y'
            AND si.item_type = 'group'
            AND si.exclude_contract_publication = 1
            AND CONVERT(DATE, sgd.effective_date) <= @today_date
            AND (sgd.end_date IS NULL OR CONVERT(DATE, sgd.end_date) >= @today_date)

        -- Now we must make sure that all of the default, selectable items from estimating items are in the group details. If they're not, add them.

    END TRY
    BEGIN CATCH
        -- Since an error occured, we need to rollback the transaction
        IF @@TRANCOUNT > 0
            ROLLBACK TRANSACTION

        -- Rethrow the error
        DECLARE
            @ErrorMessage    NVARCHAR(4000),
            @ErrorNumber     INT,
            @ErrorSeverity   INT,
            @ErrorState      INT,
            @ErrorLine       INT,
            @ErrorProcedure  NVARCHAR(200);

        -- Assign variables to error-handling functions that 
        -- capture information for RAISERROR.
        SELECT 
            @ErrorNumber = ERROR_NUMBER(),
            @ErrorSeverity = ERROR_SEVERITY(),
            @ErrorState = ERROR_STATE(),
            @ErrorLine = ERROR_LINE(),
            @ErrorProcedure = ISNULL(ERROR_PROCEDURE(), '-');

        -- Build the message string that will contain original
        -- error information.
        SELECT @ErrorMessage = N'Insert Catalog Selection Group Detail Failed: ' + ERROR_MESSAGE();

        -- Raise an error: msg_str parameter of RAISERROR will contain
        -- the original error information.
        RAISERROR 
            (
                @ErrorMessage, 
                @ErrorSeverity, 
                1,               
                @ErrorNumber,    -- parameter: original error number.
                @ErrorSeverity,  -- parameter: original error severity.
                @ErrorState,     -- parameter: original error state.
                @ErrorProcedure, -- parameter: original error procedure name.
                @ErrorLine       -- parameter: original error line number.
            );
    END CATCH

    -- If things went well, commit the transaction
    IF @@TRANCOUNT > 0
        COMMIT TRANSACTION
END
GO
PRINT N'Creating Procedure [dbo].[vds_insCatalogSelectionsAreaDetailsLayDirection]...';


GO
CREATE PROCEDURE [dbo].[vds_insCatalogSelectionsAreaDetailsLayDirection]
	@session_id UNIQUEIDENTIFIER,
	@application VARCHAR(100),
	@product VARCHAR(100),
	@area VARCHAR(100),
	@sub_area VARCHAR(100),
	@item_type VARCHAR(20),
	@item_id VARCHAR(50),
	@rotate_degree INT,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 3/28/2022
	Description: Adds lay direction degree for a bom line
*/
BEGIN
	declare @edit_user_id varchar(75)
	set @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	if (@edit_user_id is null)
		begin
			raiserror('Invalid credentials.',16,1)
			return
		end

	INSERT INTO [dbo].[catalog_selections_area_details_lay_directions] (
		[session_id],
		[application],
		[product],
		[area],
		[sub_area],
		[item_type],
		[item_id],
		[rotate_degree],
		[author],
		[create_date],
		[modifier],
		[modified_date]
	)
	VALUES (
		@session_id,
		@application,
		@product,
		@area,
		@sub_area,
		@item_type,
		@item_id,
		@rotate_degree,
		@edit_user_id,
		GETDATE(),
		@edit_user_id,
		GETDATE()
	)
END
GO
PRINT N'Creating Procedure [dbo].[vds_insCatalogSelectionsGroupDetail]...';


GO
CREATE PROCEDURE [dbo].[vds_insCatalogSelectionsGroupDetail]
	@session_id UNIQUEIDENTIFIER,
	@group_id INT,
	@item_type VARCHAR(10),
	@item VARCHAR(81),
	@area_id VARCHAR(10),
	@sub_area_id VARCHAR(10),
	@security_token UNIQUEIDENTIFIER
AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DECLARE @author VARCHAR(100) = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	DECLARE @date DATETIME = GETDATE()

	INSERT INTO catalog_selections_group_detail
	(
		session_id,
		group_id,
		item_type,
		item,
		area_id,
		sub_area_id,
		author,
		create_date,
		modifier,
		modified_date
	)
	SELECT
		@session_id,
		@group_id,
		@item_type,
		@item,
		@area_id,
		@sub_area_id,
		@author,
		@date,
		@author,
		@date
END
GO
PRINT N'Creating Procedure [dbo].[vds_insCatalogSelectionsHomebuyerCatalogNonestimatedSelection]...';


GO
CREATE PROCEDURE [dbo].[vds_insCatalogSelectionsHomebuyerCatalogNonestimatedSelection]
@session_id UNIQUEIDENTIFIER,
@security_token UNIQUEIDENTIFIER,
@application varchar(100),
@product varchar(100),
@area varchar(100),
@sub_area varchar(100), 
@item varchar(max),
@item_no varchar(100)
AS

BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END
	insert into [homebuyer_catalog_nonestimated_selections] (session_id, row_id)
	select cs.session_id, cs.row_id
	from catalog_selections cs
	left join [homebuyer_catalog_nonestimated_selections] s on s.session_id = cs.session_id and s.row_id = cs.row_id
	where cs.session_id = @session_id
	and cs.application = ISNULL(@application,'')
	and cs.product = ISNULL(@product,'')
	and cs.area = ISNULL(@area,'')
	and cs.sub_area = ISNULL(@sub_area,'')
	and cs.item_no = ISNULL(@item_no,'')
	and cs.item = ISNULL(@item,'')
	and s.session_id is null
END
GO
PRINT N'Creating Procedure [dbo].[vds_insDesignerAssignedApplication]...';


GO
CREATE PROCEDURE [dbo].[vds_insDesignerAssignedApplication]
	@user_id UNIQUEIDENTIFIER,
	@application VARCHAR(100),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 2/13/2017
	Description: This proc adds an application to a vendor designers selectable applications list.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Make sure the application isn't already in the vendor designer's applications list
	IF (NOT EXISTS(SELECT * FROM designer_assigned_applications WHERE [user_id] = @user_id AND [application] = @application))
	BEGIN
		DECLARE @author VARCHAR(50) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

		-- Add the application to the vendor designer's selectable application list
		INSERT INTO designer_assigned_applications ([user_id], [application], author, create_date, modifier, modified_date)
			VALUES
			(
				@user_id,
				@application,
				@author,
				GETDATE(),
				@author,
				GETDATE()
			)
	END
END
GO
PRINT N'Creating Procedure [dbo].[vds_insEmailEvent]...';


GO
CREATE PROCEDURE [dbo].[vds_insEmailEvent]
	@email VARCHAR(MAX),
	@timestamp INT,
	@event_type VARCHAR(50),
	@smtp_id VARCHAR(50),
	@useragent VARCHAR(MAX),
	@ip CHAR(15),
	@event_id VARCHAR(MAX),
	@message_id VARCHAR(MAX),
	@reason VARCHAR(MAX),
	@status CHAR(5),
	@response VARCHAR(MAX),
	@url VARCHAR(MAX),
	@category VARCHAR(MAX),
	@attempt INT,
	@type VARCHAR(50)
AS
/*
Author: Art deHoyos
Date: 1/3/2019
Description: Persist an email event
*/

	BEGIN

	INSERT INTO email_events (
		email,
		[timestamp],
		[event],
		smtp_id,
		useragent,
		[ip],
		event_id,
		message_id,
		reason,
		[status],
		response,
		[url],
		category,
		attempt,
		[type]
	)
	VALUES (
		@email,
		@timestamp,
		@event_type,
		@smtp_id,
		@useragent,
		@ip,
		@event_id,
		@message_id,
		@reason,
		@status,
		@response,
		@url,
		@category,
		@attempt,
		@type
	)

	END
GO
PRINT N'Creating Procedure [dbo].[vds_insert_icon]...';


GO
CREATE PROCEDURE [dbo].[vds_insert_icon]
	@id UNIQUEIDENTIFIER,
	@name NVARCHAR(50),
	@image VARBINARY(MAX),
	@mime_type VARCHAR(255),
	@security_token UNIQUEIDENTIFIER
AS

/*
	Author: Eric Hickey
	Create Date: 11/04/2019
	Description: Inserts an icon
*/

BEGIN
	-- Get the active user's email from the security token for auditing purposes
    DECLARE @active_user_email VARCHAR(100)
    SET @active_user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	IF @active_user_email IS NULL
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	INSERT INTO [dbo].[icon]
	(
		[id],
		[name],
		[image],
		[mime_type],
		[author],
		[create_date],
		[modifier],
		[modified_date]
	)
	VALUES
	(
		@id,
		@name,
		@image,
		@mime_type,
		@active_user_email,
		GETDATE(),
		@active_user_email,
		GETDATE()
	)
END
GO
PRINT N'Creating Procedure [dbo].[vds_insert_icon_tag]...';


GO
CREATE PROCEDURE [dbo].[vds_insert_icon_tag]
	@id UNIQUEIDENTIFIER,
	@tag VARCHAR(25),
	@security_token UNIQUEIDENTIFIER
AS

/*
	Author: Eric Hickey
	Create Date: 11/04/2019
	Description: Inserts a new icon tag for an icon.
*/

BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	INSERT INTO	[dbo].[icon_tags]
	(
		[icon_id],
		[tag]
	)
	VALUES
	(
		@id,
		@tag
	)
END
GO
PRINT N'Creating Procedure [dbo].[vds_insert_restricted_application_product]...';


GO
CREATE PROCEDURE [dbo].[vds_insert_restricted_application_product]
	@id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@application_id VARCHAR(10),
	@product_id VARCHAR(5),
	@security_token UNIQUEIDENTIFIER
AS
BEGIN
-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	INSERT INTO [restricted_application_product] (
		[id],
		[organization_id],
		[application_id],
		[product_id]
	)
	VALUES (
		@id,
		@organization_id,
		@application_id,
		@product_id
	)

	SELECT
		[RAP].[id],
		[RAP].[organization_id],
		[RAP].[application_id],
		[VA].[name] AS application_name,
		[RAP].[product_id],
		[VP].[name] AS product_name
	FROM
		[restricted_application_product] AS RAP
		LEFT JOIN [Veo_Applications] AS VA ON RAP.application_id = VA.application_id
		LEFT JOIN [Veo_Products] AS VP ON RAP.product_id = VP.product_id
	WHERE
		[RAP].[id] = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_insEventLog]...';


GO
CREATE PROCEDURE [dbo].[vds_insEventLog]
@user_id uniqueidentifier = null, 
@category nvarchar(50),
@action nvarchar(50),
@data_serializer_type nvarchar(50), 
@data nvarchar(max),
@organization_id uniqueidentifier = null
AS

INSERT INTO 
	event_log 
	(user_id,  event_log_date, category, [action], data_serializer_type, data, organization_id) 
VALUES 
	(@user_id, getdate(), @category, @action, @data_serializer_type, @data, @organization_id)

--select * from log 
GO
PRINT N'Creating Procedure [dbo].[vds_insFloorplanSequence]...';


GO
CREATE PROCEDURE [dbo].[vds_insFloorplanSequence]
	@profile_plan_id UNIQUEIDENTIFIER, 
	@sequence NVARCHAR(MAX), 
	@security_token UNIQUEIDENTIFIER
AS
BEGIN 
/*
	Author: Robert Hobbs
	Create Date: 04/26/2018
	Description: Save the sequence of floorplans for a profile plan 
*/

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DELETE FROM floorplans_sequence WHERE profile_plan_id = @profile_plan_id 

	INSERT INTO floorplans_sequence	
		(profile_plan_id, [sequence]) 
		VALUES
		(@profile_plan_id, @sequence) 


END
GO
PRINT N'Creating Procedure [dbo].[vds_insHomebuyerCatalogEstimatedSelection]...';


GO
CREATE PROCEDURE [dbo].[vds_insHomebuyerCatalogEstimatedSelection]
	@session_id UNIQUEIDENTIFIER,
	@application_id VARCHAR(10),
	@product_id VARCHAR(5),
	@area_id VARCHAR(25),
	@sub_area_id VARCHAR(25),
	@build_id INT,
	@price_level_type VARCHAR(50),
	@price_level_id VARCHAR(100),
	@selected_option_id VARCHAR(50),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 7/29/2019
	Description: Create an estimated selection record for a given homebuyer catalog. These selections
		are per build, and include price level information so we can quickly look up prices.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DECLARE @user_email VARCHAR(100)
	SET @user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	INSERT INTO homebuyer_catalog_estimated_selections 
		(
			session_id, 
			application_id, 
			product_id, 
			area_id, 
			sub_area_id,
			build_id,
			price_level_type,
			price_level_id,
			selected_option_id, 
			author, 
			create_date, 
			modifier, 
			modified_date
		)
	VALUES
		(
			@session_id,
			@application_id,
			@product_id,
			@area_id,
			@sub_area_id,
			@build_id,
			@price_level_type,
			@price_level_id,
			@selected_option_id,
			@user_email,
			GETDATE(),
			@user_email,
			GETDATE()
		)

	SELECT CAST(SCOPE_IDENTITY() AS BIGINT) AS new_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_insHomebuyerCatalogNonestimatedSelection]...';


GO
CREATE PROCEDURE [dbo].[vds_insHomebuyerCatalogNonestimatedSelection]
	@session_id UNIQUEIDENTIFIER,
	@row_id UNIQUEIDENTIFIER,
	@quantity INTEGER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 7/29/2019
	Description: Create a non-estimated selection record for a given homebuyer catalog.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	IF @quantity = 0
	BEGIN
		RAISERROR('Quantity must be greater than 0.', 16, 1)
		RETURN
	END

	DECLARE @user_email VARCHAR(100)
	SET @user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	INSERT INTO homebuyer_catalog_nonestimated_selections
	(
		session_id,
		row_id,
		quantity,
		author,
		create_date,
		modifier,
		modified_date
	)
	VALUES
	(
		@session_id,
		@row_id,
		@quantity,
		@user_email,
		GETDATE(),
		@user_email,
		GETDATE()
	)

	SELECT CAST(SCOPE_IDENTITY() AS BIGINT) AS new_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_insHomebuyerCatalogPriceLevelFilter]...';


GO
CREATE PROCEDURE [dbo].[vds_insHomebuyerCatalogPriceLevelFilter]
	@session_id UNIQUEIDENTIFIER,
	@room_id UNIQUEIDENTIFIER,
	@application_id VARCHAR(50),
	@product_id VARCHAR(50),
	@item_no VARCHAR(50),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 4/18/2022
	Description: Inserts price level filter
*/
BEGIN
	DECLARE @edit_user_id VARCHAR(75)
	SET @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	IF (@edit_user_id IS NULL)
		BEGIN
			RAISERROR('Invalid credentials.',16,1)
			RETURN
		END

	INSERT INTO [dbo].[homebuyer_catalog_price_level_filters] (
		[id],
		[session_id],
		[room_id],
		[application_id],
		[product_id],
		[item_no],
		[author],
		[modifier]
	) VALUES (
		NEWID(),
		@session_id,
		@room_id,
		@application_id,
		@product_id,
		@item_no,
		@edit_user_id,
		@edit_user_id
	)
END
GO
PRINT N'Creating Procedure [dbo].[vds_insPlanDocument]...';


GO
CREATE PROCEDURE [dbo].[vds_insPlanDocument]
	@id UNIQUEIDENTIFIER,
	@profile_plan_id UNIQUEIDENTIFIER,
	@doc_type nvarchar(50),
	@mime_type nvarchar(50),
	@session_id uniqueidentifier,
	@doc_data varbinary(max),
	@modifier varchar(50),
	@security_token UNIQUEIDENTIFIER
AS
BEGIN
/*
	Author: Robert Hobbs
	Create Date: 09/4/18
	Description: add a plan document

	Modifier: Roger Wang
	Modified Date: 4/29/2021
	Description: get author/modifier from security token when modifier is not supplied

	Modifier: Charles Moore
	Modified Date: 6/21/2021
	Description: RAISE ERROR message if plan document id already exists in table
*/
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	IF exists (select id from [dbo].[plan_documents] where id = @id)	
	BEGIN
		RAISERROR('Already Saved',16,1)
		RETURN
	END

	IF ISNULL(@modifier, '') = ''
	BEGIN
		SET @modifier = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	END

	INSERT INTO [dbo].[plan_documents]
           ([id]
           ,[profile_plan_id]
           ,[doc_type]
           ,[mime_type]
           ,[session_id]
           ,[doc_data]
           ,[author]
           ,[create_date]
           ,[modifier]
           ,[modified_date])
     VALUES
           ( @id,
			@profile_plan_id,
			@doc_type,
			@mime_type,
			@session_id,
			@doc_data,
			@modifier,
			GETDATE(),
			@modifier,
			GETDATE())
END
GO
PRINT N'Creating Procedure [dbo].[vds_insPrimaryPlanCatalog]...';


GO
CREATE PROCEDURE [dbo].[vds_insPrimaryPlanCatalog]
	@session_id uniqueidentifier,
	@profile_plan_id uniqueidentifier,
	@security_token uniqueidentifier
AS
/*
	Author: Roger Wang
	Date: 7/25/2019
	Description: Sets a session as primary for a profile plan
*/
BEGIN
	declare @edit_user_id varchar(75)
	set @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	if (@edit_user_id is null)
		begin
			raiserror('Invalid credentials.',16,1)
			return
		end

	insert into primary_plan_catalogs (
		[session_id],
		[profile_plan_id],
		[author],
		[create_date],
		[modifier],
		[modified_date] )
	values (
		@session_id,
		@profile_plan_id,
		@edit_user_id,
		getdate(),
		@edit_user_id,
		getdate() )
END
GO
PRINT N'Creating Procedure [dbo].[vds_insSession]...';


GO
CREATE PROCEDURE [dbo].[vds_insSession]
    @session_id UNIQUEIDENTIFIER,
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @user_id UNIQUEIDENTIFIER,
    @community_id INT,
    @spec_id INT,
    @effective_date DATETIME,
    @pricing_generated DATETIME,
    @pricing_published DATETIME,
    @completed_date DATETIME,
    @community_name VARCHAR(100),
    @series VARCHAR(100),
    @plan_name VARCHAR(100),
    @plan_version VARCHAR(50),
    @status INT,
	@status_change_reason VARCHAR(MAX) = NULL,
    @rounding_type INT,
    @rounding_places INT,
    @builder_markup_hb_pricing BIT,
    @designer_id UNIQUEIDENTIFIER,
    @designer VARCHAR(50),
	@show_report BIT = 1,
    @author VARCHAR(50) = NULL,
    @create_date DATETIME = NULL,
    @modifier VARCHAR(50) = NULL,
    @modified_date DATETIME = NULL,
    @security_token UNIQUEIDENTIFIER,
    @catalog_source VARCHAR(100)
AS
/*
    Author: Shelby Mansker
    Create Date: 7/20/2015
    Description: Create a new session record.

	Modified: Shelby Mansker
	Date: 8/9/2018
	Description: Includes the optional status_change_reason field.

	Modified: Art deHoyos
	Date: 10/9/2018
	Description: Added show_report field.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- If the author was not passed in, get it from the security token
    IF (@author = NULL)
    BEGIN
        SET @author = dbo.ef_getUserEmailFromSecurityToken(@security_token)
    END

    -- If the create date wasn't passed in, use the current time
    IF (@create_date = NULL)
    BEGIN
        SET @create_date = GETDATE()
    END

    -- If the modifier was not passed in, set it to the author
    IF (@modifier = NULL)
    BEGIN
  SET @modifier = @author
    END

    -- If the modified date was not passed in, set it to the create_date
    IF (@modified_date = NULL)
    BEGIN
  SET @modified_date = @create_date
    END

    -- make sure the passed in session id isn't already in use
    IF (EXISTS(SELECT * FROM account_organization_user_profile_plan_catalog_sessions WHERE session_id = @session_id))
    BEGIN
  DECLARE @error_msg VARCHAR(MAX) = 'A Session already exists with the id ' + CAST(@session_id AS VARCHAR(36)) + '.'
		RAISERROR(@error_msg,16,1)
		RETURN
	END

    -- create session
    INSERT INTO account_organization_user_profile_plan_catalog_sessions (
        account_id,
        organization_id,
        [user_id],
        community_id,
        spec_id,
        effective_date,
        pricing_generated,
        pricing_published,
        completed_date,
        community_name,
        series,
        plan_name,
        plan_version,
        session_id,
        [status],
        status_change_reason,
        rounding_type,
        rounding_places,
        builder_markup_hb_pricing,
        designer_id,
        designer,
        show_report,
        author,
        create_date,
        modifier,
        modified_date,
        catalog_source)
    VALUES (
        @account_id,
        @organization_id,
        @user_id,
        @community_id,
        @spec_id,
        @effective_date,
        @pricing_generated,
        @pricing_published,
        @completed_date,
        @community_name,
        @series,
        @plan_name,
        @plan_version,
        @session_id,
        @status,
	    @status_change_reason,
        @rounding_type,
        @rounding_places,
        @builder_markup_hb_pricing,
        @designer_id,
        @designer,
	    @show_report,
        @author,
        @create_date,
        @modifier,
        @modified_date,
        @catalog_source)
END
GO
PRINT N'Creating Procedure [dbo].[vds_insSessionChangeApplied]...';


GO
CREATE PROCEDURE [dbo].[vds_insSessionChangeApplied]
	@change_id UNIQUEIDENTIFIER,
	@session_id UNIQUEIDENTIFIER, 
	@change_version NVARCHAR(10), 
	@change_data NVARCHAR(MAX) ,
	@security_token UNIQUEIDENTIFIER 
AS
/*
   Author:		Robert Hobbs
   Create date: 04/12/19
   Description:	Inserts session_change_applied data. 
 */
BEGIN

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	 -- Get the email address for the user associated with the security token passed in
    DECLARE @user_email VARCHAR(100) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	INSERT INTO 
		session_changes_applied
		(session_id, change_id, change_version, change_data, author, create_date, modifier, modified_date) 
	VALUES
		(@session_id, @change_id, @change_version, @change_data, @user_email, GETDATE(), @user_email, GETDATE()) 

END
GO
PRINT N'Creating Procedure [dbo].[vds_insSessionNonEstimatedOption]...';


GO
CREATE PROCEDURE [dbo].[vds_insSessionNonEstimatedOption]
	@session_id UNIQUEIDENTIFIER,
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@community VARCHAR(100),
	@series VARCHAR(100),
	@plan VARCHAR(100),
	@application VARCHAR(100),
	@product VARCHAR(100),
	@area VARCHAR(100) = '',
	@sub_area VARCHAR(100) = '',
	@item_no VARCHAR(100) = '',
	@item VARCHAR(MAX),
	@vendor VARCHAR(100) = '',
	@standard VARCHAR(200) = '',
	@qty DECIMAL(18,4) = 0,
	@cost DECIMAL(18,2) = 0,
	@price DECIMAL(18,2) = 0,
	@selected BIT NULL,
	@notes VARCHAR(MAX) = '',
	@model VARCHAR(100) = '',
	@source VARCHAR(20),
	@gpc VARCHAR(MAX) NULL = NULL,
	@option_pricing_display BIT = 0,
	@audit_user VARCHAR(50)
AS
/*
	Author: Shelby Mansker
	Date: 11/6/2018
	Description: Creates a new non-estimated option in the specified session's catalog. Returns the new
		option's id (row_id)
*/
BEGIN
	DECLARE @row_id UNIQUEIDENTIFIER = NEWID()

	INSERT INTO dbo.catalog_selections 
	(
		session_id, 
		row_id, 
		account_id, 
		organization_id, 
		community, 
		series, 
		[plan], 
		[application], 
		product, 
		area, 
		area_id, 
		sub_area, 
		sub_area_id, 
		item_type, 
		item_no, 
		item,
		vendor,
		[standard],
		qty,
		cost,
		price,
		selected,
		notes,
		option_pricing_display,
		mutually_exclusive,
		[source],
		build_id,
		gpc,
		model,
		make_std,
		is_credit,
		stage,
		author,
		create_date,
		modifier,
		modified_date)
	VALUES 
	(
		@session_id, 
		@row_id, 
		@account_id, 
		@organization_id, 
		@community, 
		@series, 
		@plan, 
		@application, 
		@product, 
		@area, 
		'', -- area_id
		@sub_area, 
		'', -- sub_area_id
		'', -- item_type
		@item_no, 
		@item,
		@vendor,
		@standard,
		@qty,
		@cost,
		@price,
		@selected,
		@notes,
		@option_pricing_display,
		0, -- mutually_exclusive
		@source,
		0, -- build_id
		@gpc,
		@model,
		0, -- make_std
		0, -- is_credit
		'', -- stage
		@audit_user, -- author
		GETDATE(), -- create_date
		@audit_user, -- modifier
		GETDATE() -- modified_date
	)

	-- Returns the created option's id.
	SELECT @row_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_insSupportLog]...';


GO
CREATE procedure [dbo].[vds_insSupportLog]
@security_token uniqueidentifier,
@organization_id uniqueidentifier,
@session_id uniqueidentifier,
@entry_date datetime,
@cc_list varchar(max),
@problem_type varchar(max),
@body_message varchar(max),
@application varchar(10),
@product varchar(10)
as

-- Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)		
	RETURN
END

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)



insert into support_log (
	organization_id, 
	session_id,
	entry_date,
	cc_list,
	problem_type,
	body_message,
	application,
	product,
	author,
	create_date,
	modifier,
	modified_date )
values (
	@organization_id, 
	@session_id,
	@entry_date,
	@cc_list,
	@problem_type,
	@body_message,
	@application,
	@product,
	@active_user_id,
	getdate(),
	@active_user_id,
	getdate() )
GO
PRINT N'Creating Procedure [dbo].[vds_insTermsOfServiceAccepted]...';


GO
CREATE PROCEDURE [dbo].[vds_insTermsOfServiceAccepted]
    @user_id UNIQUEIDENTIFIER,
	@accepted BIT = 0,
    @security_token UNIQUEIDENTIFIER
AS
/*
	Modified: Saul Sanchez
	Date: 09/10/2019
	Description: Inserts a record into the terms of service table, and returns a boolean.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END	

	DECLARE @already_accepted BIT = 0

	SELECT 
		@already_accepted = accepted
	FROM 
		VeoSolutionsSecurity_users_terms_of_service 
	WHERE	
		[user_id] = @user_id

	IF NOT EXISTS (SELECT accepted FROM VeoSolutionsSecurity_users_terms_of_service WHERE [user_id] = @user_id)
	BEGIN
		INSERT INTO VeoSolutionsSecurity_users_terms_of_service
		(
			[user_id],
			accepted
		)
		VALUES
		(
			@user_id,
			@accepted
		)
	END

END
GO
PRINT N'Creating Procedure [dbo].[vds_insUpdSessionDesignerDocument]...';


GO
CREATE PROCEDURE [dbo].[vds_insUpdSessionDesignerDocument]
	@id UNIQUEIDENTIFIER,
	@session_id UNIQUEIDENTIFIER,
	@document_id UNIQUEIDENTIFIER,
	@is_checked BIT = 0,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Nirav Rana
	Date: 4/28/2022
	Description: Update / Insert designer document selections
*/
BEGIN
	-- Validate the security token
	declare @edit_user_id varchar(75)
	set @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	if (@edit_user_id is null)
		begin
			raiserror('Invalid credentials.',16,1)
			return
		end
	
	IF @is_checked = 0
	BEGIN
		UPDATE
			session_designer_documents
		SET
			modifier = @edit_user_id,
			modified_date = GETDATE()
		WHERE
			session_id = @session_id
			AND doc_id = @document_id

		DELETE
			session_designer_documents
		WHERE
			session_id = @session_id
			AND doc_id = @document_id
	END
	ELSE
	BEGIN
		--Check if document exist 
		--if exist then update
		IF NOT EXISTS (select 1 from session_designer_documents where session_id = @session_id AND doc_id = @document_id)
		BEGIN
			INSERT into session_designer_documents values
			(
				@id,
				@session_id,
				@document_id,
				@is_checked,
				@edit_user_id,
				getdate(),
				@edit_user_id,
				getdate()
			)
		END
	END
END
GO
PRINT N'Creating Procedure [dbo].[vds_insUser]...';


GO
CREATE PROCEDURE [dbo].[vds_insUser]
	@first_name VARCHAR(25),
	@last_name VARCHAR(25),
	@email VARCHAR(100),
	@image_data VARBINARY(MAX) = NULL,
	@active BIT = 1,
	@reset_id UNIQUEIDENTIFIER = NULL,
	@welcome_email_sent DATETIME = NULL,
	@welcome_email_validated DATETIME = NULL,
	@is_test_user BIT,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 7/18/2016
	Description: Attempts to create a new user, based on the parameters passed in

	Modified: Shelby Mansker
	Date: 8/1/2016
	Description: Added the new welcome email related columns to the procedure.

	Modified: Saul Sanchez
	Date: 4/10/2018
	Description: Removed the password fields.  Encrypted passwords are handled through another process.

	Modified: Roger Wang
	Date: 5/28/2021
	Description: Added is_test_user field
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END	

	IF (LEN(@email) = 0)
	BEGIN
		RAISERROR('E-mail Is Required', 16, 1)
		RETURN
	END

	IF (EXISTS(SELECT [user_id] FROM VeoSolutionsSecurity_users WHERE email = @email))
	BEGIN
		RAISERROR('E-mail Already Associated With A User', 16, 1)
		RETURN
	END

	DECLARE @generated_user_id UNIQUEIDENTIFIER = NEWID();
	WHILE (EXISTS(SELECT [user_id] FROM VeoSolutionsSecurity_users WHERE [user_id] = @generated_user_id))
	BEGIN
		SET @generated_user_id = NEWID();
	END

	DECLARE @author VARCHAR(100) = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	DECLARE @date DATETIME = GETDATE()

	INSERT INTO VeoSolutionsSecurity_users
	(
		[user_id],
		first_name,
		last_name,
		email,
		image_data,
		active,
		reset_id,
		welcome_email_sent,
		welcome_email_validated,
		author,
		create_date,
		modifier,
		modified_date,
		is_test_user
	)
	VALUES
	(
		@generated_user_id,
		@first_name,
		@last_name,
		@email,
		@image_data,
		@active,
		@reset_id,
		@welcome_email_sent,
		@welcome_email_validated,
		@author,
		@date,
		@author,
		@date,
		ISNULL(@is_test_user, 0)
	)

	SELECT @generated_user_id AS [user_id]
END
GO
PRINT N'Creating Procedure [dbo].[vds_insUserCompletedOrientationStep]...';


GO
CREATE PROCEDURE [dbo].[vds_insUserCompletedOrientationStep]
	@user_id UNIQUEIDENTIFIER,
	@step VARCHAR(50)
AS
/*
	Author:			Roger Wang
	Date:			1/10/2019
	Description:	Returns the ID of the newly created/existed for the step
*/

DECLARE @id UNIQUEIDENTIFIER

SELECT TOP 1
	@id = id
FROM
	user_completed_orientation_steps
WHERE
	[user_id] = @user_id AND [step] = @step

IF @id IS NULL
BEGIN
	SET @id = NEWID()

	INSERT INTO user_completed_orientation_steps (
		[id], [user_id], [step]
	) VALUES (
		@id, @user_id, @step
	)
END

SELECT @id
GO
PRINT N'Creating Procedure [dbo].[vds_insUserImpersonation]...';


GO
CREATE procedure [dbo].[vds_insUserImpersonation]

@impersonated_account_id uniqueidentifier,
@impersonated_organization_id uniqueidentifier,
@impersonated_user_id uniqueidentifier,
@security_token uniqueidentifier

as

/*
	Author:		Adrian Garza
	Create date: 2/9/2015
	Description: insert into user_impersonations table

	03.02.2015 - modified to check for an impersonation first, and if found 
	update the impersonation date rather than inserting a new record. 

*/

-- testing 
-- vds_insUserImpersonation 'bab32b7e-3ada-497c-862e-e5083971cc59', '8aaecc3a-2d9e-4500-b0cf-d79d947d33a7', '6dacb436-5124-40e5-92e9-1b8633c8f995', 'D0350A9B-7472-475C-BE44-1484B5E277A6'
--
-- select top 20 * from user_impersonations order by impersonation_date desc
--

IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

declare @user_id uniqueidentifier
select @user_id = dbo.vdsf_selUserIDFromToken(@security_token);

-- check for existing impersonation record, if found update impersonation_date 
IF EXISTS(SELECT TOP 1 * from user_impersonations with (nolock) WHERE user_id = @user_id AND impersonated_account_id = @impersonated_account_id AND impersonated_organization_id = @impersonated_organization_id AND impersonated_user_id = @impersonated_user_id) 
BEGIN 
	
	--print 'updating...' 
	UPDATE 
		user_impersonations
	SET
		impersonation_date = getdate() 
	WHERE 
		user_id = @user_id 
		AND impersonated_account_id = @impersonated_account_id AND impersonated_organization_id = @impersonated_organization_id AND impersonated_user_id = @impersonated_user_id
END 
ELSE
BEGIN 
	insert into user_impersonations(user_id,impersonation_date,impersonated_account_id,impersonated_organization_id,impersonated_user_id)
	values (@user_id,getdate(),@impersonated_account_id,@impersonated_organization_id,@impersonated_user_id)
END
GO
PRINT N'Creating Procedure [dbo].[vds_isUserSystemAdministrator]...';


GO
CREATE PROCEDURE [dbo].[vds_isUserSystemAdministrator]
    @user_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
	Author:      Shelby Mansker
	Create date: 11/18/2014
	Description: If the user passed in is a system administrator, this proc returns a 1,
                 otherwise it returns a 0.

	Modified: Shelby Mansker
	Date: 1/18/2016
	Description: In addition to returning the bit, I'm returing a result set with the bit.
		This is more consistent with other procs.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DECLARE @is_admin BIT = dbo.vdsf_isUserSysAdmin(@user_id);

	SELECT @is_admin AS is_admin

    RETURN @is_admin
END
GO
PRINT N'Creating Procedure [dbo].[vds_moveCatalogSelectionsGroupDetail]...';


GO
CREATE PROCEDURE [dbo].[vds_moveCatalogSelectionsGroupDetail]
	@session_id UNIQUEIDENTIFIER,
	@from_group_id INT,
	@from_item_type VARCHAR(10),
	@from_item VARCHAR(81),
	@to_group_id INT,
	@to_item_type VARCHAR(10),
	@to_item VARCHAR(81),
	@to_area VARCHAR(10),
	@to_sub_area VARCHAR(10),
	@security_token UNIQUEIDENTIFIER
AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	BEGIN TRANSACTION
	BEGIN TRY
		EXEC vds_delCatalogSelectionsGroupDetail @session_id, @from_group_id, @from_item_type, @from_item, @security_token
		EXEC vds_insCatalogSelectionsGroupDetail @session_id, @to_group_id, @to_item_type, @to_item, @to_area, @to_sub_area, @security_token
	END TRY
	BEGIN CATCH
		-- Since an error occured, we need to rollback the transaction
		IF @@TRANCOUNT > 0
			ROLLBACK TRANSACTION

		-- Rethrow the error
		DECLARE
			@ErrorMessage    NVARCHAR(4000),
			@ErrorNumber     INT,
			@ErrorSeverity   INT,
			@ErrorState      INT,
			@ErrorLine       INT,
			@ErrorProcedure  NVARCHAR(200);

		-- Assign variables to error-handling functions that 
		-- capture information for RAISERROR.
		SELECT 
			@ErrorNumber = ERROR_NUMBER(),
			@ErrorSeverity = ERROR_SEVERITY(),
			@ErrorState = ERROR_STATE(),
			@ErrorLine = ERROR_LINE(),
			@ErrorProcedure = ISNULL(ERROR_PROCEDURE(), '-');

		-- Build the message string that will contain original
		-- error information.
		SELECT @ErrorMessage = N'Move Catalog Selection Group Detail Failed: ' + ERROR_MESSAGE();

		-- Raise an error: msg_str parameter of RAISERROR will contain
		-- the original error information.
		RAISERROR 
			(
				@ErrorMessage, 
				@ErrorSeverity, 
				1,               
				@ErrorNumber,    -- parameter: original error number.
				@ErrorSeverity,  -- parameter: original error severity.
				@ErrorState,     -- parameter: original error state.
				@ErrorProcedure, -- parameter: original error procedure name.
				@ErrorLine       -- parameter: original error line number.
			);
	END CATCH

	-- If things went well, commit the transaction
	IF @@TRANCOUNT > 0
		COMMIT TRANSACTION
END
GO
PRINT N'Creating Procedure [dbo].[vds_optionPricingSessionMaxMinBuilds]...';


GO
CREATE procedure [dbo].[vds_optionPricingSessionMaxMinBuilds]
@session_id uniqueidentifier

as

/*

		Procedure:	vds_optionPricingSessionMaxMinBuilds
		Author:		Adrian Garza
		Date:		5/7/2015
		Purpose:	Retrieves max/min builds for a session
		Usage:	vds_optionPricingSessionMaxMinBuilds '68b905fa-42f2-46e1-b7ab-32f0b06afeda'

*/


--declare @plan_id int



--select @plan_id = plan_id 
--from plan_builds
--where spec_id = @spec_id 
--	  and plan_name = @plan_name
--	  and active = 1
--	  and (end_date >= getdate() or end_date is null)

----print @plan_id

declare @results table
( 
  application_id varchar(10),
  product_id varchar(10),
  area_id varchar(10),
  sub_area_id varchar(10),
  location_id int,
  max_build_id bigint,
  max_build_desc varchar(50),
  max_field_qty decimal(18,2),
  min_build_id bigint,
  min_build_desc varchar(50),
  min_field_qty decimal(18,2),
  std_build_id bigint,
  std_build_desc varchar(50),
  std_field_qty decimal(18,2)
 )


declare @build_id int,
		@application_id varchar(10),
		@product_id varchar(10),
		@area_id varchar(10),
		@sub_area_id varchar(10),
		@location_id int,
		@build_qty decimal(18,2),
		@build_desc varchar(50),
		@is_std bit

declare b cursor for

	select 
	distinct 
	pb.application_id,
	pb.product_id,
	cs.area_id,
	cs.sub_area_id,
	pb.location_id,
	cs.build_id,
	pb.is_std
	from catalog_selections cs with (nolock)
	LEFT JOIN catalog_selections_areas csa with (nolock)
		ON csa.session_id = cs.session_id
		AND csa.[application] = cs.[application]
		AND csa.product = cs.product
		AND csa.area = cs.area
		AND csa.sub_area = cs.sub_area
		AND csa.area_id = cs.area_id
		AND csa.sub_area_id = cs.sub_area_id

	left join veo_plan_builds pb with (nolock) on pb.build_id = cs.build_id
	where cs.session_id = @session_id 
	and source = 'prices landed'
	and csa.area_selected = 1

open b
fetch next from b into @application_id,@product_id,@area_id,@sub_area_id,@location_id, @build_id,@is_std
while @@fetch_status = 0
begin

	select 
		@build_qty=bill_qty,
		@build_desc = pb.build_desc
	from veo_plan_builds pb with (nolock)
	left join veo_plan_material pm with (nolock) on
		pm.plan_id = pb.plan_id
		and pm.application_id = pb.application_id
		and pm.product_id = pb.product_id
		and pm.area_id = pb.area_id
		and pm.sub_area_id = pb.sub_area_id
		and pm.location_id = pb.location_id
		and pm.build_id = pb.build_id
		and pm.item_id = 'field'
	where pb.build_id_num = @build_id

	if (not exists(select area_id from @results where application_id =  @application_id and product_id = @product_id and area_id = @area_id and sub_area_id = @sub_area_id and location_id = @location_id))
	begin
		insert into @results
		select @application_id,@product_id,@area_id,@sub_area_id,@location_id,
		       @build_id,@build_desc,@build_qty,
			   @build_id,@build_desc,@build_qty,
			   @build_id,@build_desc,@build_qty
	end
	else
	begin
		declare @min_field_qty decimal(18,2),@max_field_qty decimal(18,2)
		select 
			@min_field_qty = min_field_qty,
			@max_field_qty = max_field_qty
		from @results 
		where application_id =  @application_id and product_id = @product_id and area_id = @area_id and sub_area_id = @sub_area_id and location_id = @location_id

		if (@build_qty > @max_field_qty)
			update @results
			set max_field_qty = @build_qty,
			max_build_id = @build_id,
			max_build_desc = @build_desc
			where application_id =  @application_id and product_id = @product_id and area_id = @area_id and sub_area_id = @sub_area_id and location_id = @location_id
		    

		if (@build_qty < @min_field_qty)
			update @results
			set min_field_qty = @build_qty,
			min_build_id = @build_id,
			min_build_desc = @build_desc
			where application_id =  @application_id and product_id = @product_id and area_id = @area_id and sub_area_id = @sub_area_id and location_id = @location_id

		if (@is_std = 1)
		    update @results
			set std_field_qty = @build_qty,
			std_build_id = @build_id,
			std_build_desc = @build_desc
			where application_id =  @application_id and product_id = @product_id and area_id = @area_id and sub_area_id = @sub_area_id and location_id = @location_id


	end


	fetch next from b into @application_id,@product_id,@area_id,@sub_area_id,@location_id, @build_id,@is_std
end
close b
deallocate b


select * from @results
GO
PRINT N'Creating Procedure [dbo].[vds_overridePatternCharge]...';


GO

CREATE procedure [dbo].[vds_overridePatternCharge]
@session_id uniqueidentifier,
@build_id int,
@override_type varchar(10),
@security_token UNIQUEIDENTIFIER

as

--Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END   


if @override_type != 'restore'
begin
	declare @pattern_qty int

	if @override_type = 'area'
		set @pattern_qty = 1
	else
		set @pattern_qty = 0 -- no charge


	update catalog_selections_area_details

	set bill_qty = @pattern_qty

	from catalog_selections_areas ca
	left join catalog_selections_area_details cad on 
	cad.session_id = ca.session_id 
	and cad.application = ca.application
	and cad.product = ca.product
	and cad.area = ca.area
	and cad.sub_area = ca.sub_area

	left join veo_labor_codes l with (nolock) on l.code = cad.real_item_id

	where ca.session_id = @session_id 
	and ca.build_id = @build_id
	--and cad.real_item_id like 'pat%'
	and l.description like '%pattern%'
end
else
begin

	update catalog_selections_area_details
	set bill_qty = bom_bill_qty
	from catalog_selections_areas ca
	left join catalog_selections_area_details cad on 
	cad.session_id = ca.session_id 
	and cad.application = ca.application
	and cad.product = ca.product
	and cad.area = ca.area
	and cad.sub_area = ca.sub_area

	left join veo_labor_codes l with (nolock) on l.code = cad.real_item_id

	where ca.session_id = @session_id 
	and ca.build_id = @build_id
	--and cad.real_item_id like 'pat%'
	and l.description like '%pattern%'

end
GO
PRINT N'Creating Procedure [dbo].[vds_saveBuilderPlanBudgetValuesCommunityDefaults]...';


GO
CREATE PROCEDURE [dbo].[vds_saveBuilderPlanBudgetValuesCommunityDefaults]
	@builder_id UNIQUEIDENTIFIER,
	@community_id UNIQUEIDENTIFIER,
	@name_id INT,
	@value DECIMAL(18, 3),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 5/28/2019
	Description: Saves the community default of a plan budget value for a builder.
*/
BEGIN
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Get User from the security token
    DECLARE @current_user_email VARCHAR(100)
    SET @current_user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	-- Now update save the plan budget
	MERGE dbo.builder_plan_budget_values_community_defaults AS TGT
	USING
		(VALUES (@builder_id, @name_id, @community_id)) AS SRC ([builder_id], [name_id], [community_id])
	ON TGT.[builder_id] = SRC.[builder_id] AND TGT.[name_id] = SRC.[name_id] AND TGT.[community_id] = SRC.[community_id]
	WHEN MATCHED THEN UPDATE
		SET
			[value] = @value,
			modifier = @current_user_email,
			modified_date = GETDATE()
	WHEN NOT MATCHED BY TARGET THEN INSERT ([builder_id], [community_id], [name_id], [value], author, create_date, modifier, modified_date)
		VALUES
			(
				@builder_id,
				@community_id,
				@name_id,
				@value,
				@current_user_email,
				GETDATE(),
				@current_user_email,
				GETDATE()
			);
END
GO
PRINT N'Creating Procedure [dbo].[vds_saveBuilderPlanBudgetValuesSettings]...';


GO
CREATE PROCEDURE [dbo].[vds_saveBuilderPlanBudgetValuesSettings]
	@builder_id UNIQUEIDENTIFIER,
	@name_id INT,
	@enabled BIT,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 5/28/2019
	Description: Saves the availability of a plan budget value for a builder.
*/
BEGIN
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Get User from the security token
    DECLARE @current_user_email VARCHAR(100)
    SET @current_user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	-- Now update save the plan budget
	MERGE dbo.builder_plan_budget_values_settings AS TGT
	USING
		(VALUES (@builder_id, @name_id, @enabled)) AS SRC ([builder_id], [name_id], [enabled])
	ON TGT.[builder_id] = SRC.[builder_id] AND TGT.[name_id] = SRC.[name_id]
	WHEN MATCHED AND TGT.[enabled] <> ISNULL(@enabled, 0) THEN UPDATE
		SET
			[enabled] = ISNULL(@enabled, 0),
			modifier = @current_user_email,
			modified_date = GETDATE()
	WHEN NOT MATCHED BY TARGET THEN INSERT ([builder_id], [name_id], [enabled], author, create_date, modifier, modified_date)
		VALUES
			(
				@builder_id,
				@name_id,
				ISNULL(@enabled, 0),
				@current_user_email,
				GETDATE(),
				@current_user_email,
				GETDATE()
			);
END
GO
PRINT N'Creating Procedure [dbo].[vds_savePlanBudget]...';


GO
CREATE PROCEDURE [dbo].[vds_savePlanBudget]
	@user_id UNIQUEIDENTIFIER,
	@plan_id UNIQUEIDENTIFIER,
	@upgrade_budget DECIMAL(18,2) = NULL,
	@monthly_payment_home DECIMAL(18,2) = NULL,
	@monthly_payment_upgrades DECIMAL(18,2) = NULL,
	@monthly_payment_total DECIMAL(18,2) = NULL,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 5/17/2019
	Description: Saves a budget for a given user's plan. A plan can only have one budget, so if one already
		exists, this procedure will update it.
*/
BEGIN
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Get User from the security token
    DECLARE @current_user_email VARCHAR(100)
    SET @current_user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	-- Look for an already existing plan budget
	DECLARE @budget_id UNIQUEIDENTIFIER = NULL
	SELECT TOP (1) 
		@budget_id = id 
	FROM 
		dbo.plan_budget 
	WHERE 
		[user_id] = @user_id 
		AND plan_id = @plan_id

	-- Make sure we have a budget id to use
	SET @budget_id = ISNULL(@budget_id, NEWID())

	-- Now update save the plan budget
	MERGE dbo.plan_budget AS TGT
	USING
		(VALUES (@budget_id)) AS SRC ([id])
	ON TGT.id = SRC.id
	WHEN MATCHED THEN UPDATE
		SET
			upgrade_budget = ISNULL(@upgrade_budget, TGT.upgrade_budget),
			monthly_payment_home = ISNULL(@monthly_payment_home, TGT.monthly_payment_home),
			monthly_payment_upgrades = ISNULL(@monthly_payment_upgrades, TGT.monthly_payment_upgrades),
			monthly_payment_total = ISNULL(@monthly_payment_total, TGT.monthly_payment_total),
			modifier = @current_user_email,
			modified_date = GETDATE()
	WHEN NOT MATCHED BY TARGET THEN INSERT (id, [user_id], plan_id, upgrade_budget, monthly_payment_home, monthly_payment_upgrades, monthly_payment_total,	author, create_date, modifier, modified_date)
		VALUES
			(
				SRC.id, 
				@user_id, 
				@plan_id, 
				ISNULL(@upgrade_budget, 0),
				ISNULL(@monthly_payment_home, 0),
				ISNULL(@monthly_payment_upgrades, 0),
				ISNULL(@monthly_payment_total, 0),
				@current_user_email,
				GETDATE(),
				@current_user_email,
				GETDATE()
			);
		
	-- Return the id of the budget record that was inserted or updated.
	SELECT @budget_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_savePlanBudgetValue]...';


GO
CREATE PROCEDURE [dbo].[vds_savePlanBudgetValue]
	@user_id UNIQUEIDENTIFIER,
	@plan_id UNIQUEIDENTIFIER,
	@name_id INT,
	@value DECIMAL(18,2),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 5/17/2019
	Description: Adds, or updates, a value on a specific plan budget.
*/
BEGIN
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Get User from the security token
    DECLARE @current_user_email VARCHAR(100)
    SET @current_user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	-- Validate the plan budget
	DECLARE @plan_budget_id UNIQUEIDENTIFIER = NULL
	SELECT TOP (1) @plan_budget_id = id FROM dbo.plan_budget WHERE [user_id] = @user_id AND plan_id = @plan_id
	IF @plan_budget_id IS NULL
	BEGIN
		RAISERROR('Plan Budget not found',16,1)
		RETURN		
	END

	-- Insert the value if the budget doesn't already exist on the budget, otherwise add it
	MERGE dbo.plan_budget_values AS TGT
	USING
		(VALUES (@plan_budget_id, @name_id)) AS SRC ([plan_budget_id], [name_id])
	ON TGT.plan_budget_id = SRC.plan_budget_id AND TGT.name_id = SRC.name_id
	WHEN MATCHED AND TGT.[value] <> @value THEN UPDATE
		SET
			TGT.[value] = @value,
			TGT.modifier = @current_user_email,
			TGT.modified_date = GETDATE()
	WHEN NOT MATCHED BY TARGET THEN INSERT (plan_budget_id, name_id, [value], author, create_date, modifier, modified_date)
		VALUES 
			(src.plan_budget_id, src.name_id, @value, @current_user_email, GETDATE(), @current_user_email, GETDATE());	
END
GO
PRINT N'Creating Procedure [dbo].[vds_saveSessionDocument]...';


GO
CREATE PROCEDURE dbo.vds_saveSessionDocument
	@document_id UNIQUEIDENTIFIER,
	@session_id UNIQUEIDENTIFIER,
	@application_id VARCHAR(10) = 'ALL',
	@product_id VARCHAR(10) = 'ALL',
	@area_id VARCHAR(20) = 'ALLstd',
	@sub_area_id VARCHAR(20) = 'None',
	@location_id INT = 1,
	@document_type VARCHAR(50) = 'Session',
	@document_data VARBINARY(MAX),
	@security_token UNIQUEIDENTIFIER
AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DECLARE @active_user_email VARCHAR(50) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	MERGE INTO account_organization_user_profile_plan_catalog_sessions_documents AS T
	USING (VALUES(@document_id, @session_id, @application_id, @product_id, @area_id, @sub_area_id, @location_id, @document_type, @document_data))
		AS S (document_id, session_id, application_id, product_id, area_id, sub_area_id, location_id, document_type, document_data)
		ON (T.document_id = S.document_id AND T.session_id = S.session_id)
	WHEN MATCHED THEN UPDATE 
		SET
			T.application_id = S.application_id,
			T.product_id = S.product_id,
			T.area_id = S.area_id,
			T.sub_area_id = S.sub_area_id,
			T.location_id = S.location_id,
			T.document_type = S.document_type,
			T.document_data = S.document_data,
			T.modifier = @active_user_email,
			T.modified_date = GETDATE()
	WHEN NOT MATCHED THEN INSERT
		(document_id, session_id, application_id, product_id, area_id, sub_area_id, location_id, document_type, document_data, author, create_date, modifier, modified_date)
		VALUES(S.document_id, S.session_id, S.application_id, S.product_id, S.area_id, S.sub_area_id, S.location_id, S.document_type, S.document_data, @active_user_email, GETDATE(), @active_user_email, GETDATE());
END
GO
PRINT N'Creating Procedure [dbo].[vds_searchBuilderCatalogItems]...';


GO
CREATE PROCEDURE [dbo].[vds_searchBuilderCatalogItems]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@application VARCHAR(100) = NULL,
	@product VARCHAR(100) = NULL,
	@item_no VARCHAR(100) = NULL,
	@item VARCHAR(100) = NULL,
	@gpc UNIQUEIDENTIFIER = NULL,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 7/25/2023
	Description: Fetches all of the catalog items for the specified tenant
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- return all of the catalog items for this builder
	SELECT
		*
	FROM
		dbo.catalog_items ci WITH (NOLOCK)
	WHERE
		ci.account_id = @account_id
		AND ci.organization_id = @organization_id
		AND (@application IS NULL OR ci.application = @application)
		AND (@product IS NULL OR ci.product = @product)
		AND (@item_no IS NULL OR ci.item_no like '%' + @item_no + '%')
		AND (@item IS NULL OR ci.item = '%' + @item + '%')
		AND (@gpc IS NULL OR (LEN(ci.gpc) = 36 AND ci.gpc = CAST(@gpc AS VARCHAR(36))))
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationBySessionID]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationBySessionID]
	@session_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:		???
	Create date: ???
	Description:	???
	
	Updated 5/23/2014: Added this comment block and reformatted the
	proc a little. Updated the security token validation code to be
	consistent with other procs. -Shelby
	
	vds_selAccountOrganizationBySessionID '137e9031-51b1-436e-bf45-9fdd8a5bf007','fa4517f9-c9ac-4505-9130-94f68d6328d8'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT 
		aouppcs.account_id,
		aouppcs.organization_id,
		aouppcs.[user_id]
	FROM 
		dbo.account_organization_user_profile_plan_catalog_sessions aouppcs WITH (NOLOCK)
	WHERE 
		session_id = @session_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationCommunity]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationCommunity]
	@community_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 10/1/2019
	Description: Return the requested community, including its
		echelon community mappings, if it has them. it returns them
		in a separater result set. The first result set is the community,
		and the second is its mappings.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- First result set includes information about the community in VDS
	SELECT
		aoc.account_id,
		aoc.organization_id,
		aoc.community_id,
		aoc.[name],
		c.community_id AS echelon_community_id
	FROM
		VeoSolutionsSecurity_account_organization_communities aoc WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) ON o.organization_id = aoc.organization_id
		LEFT JOIN Veo_customers customers WITH (NOLOCK) ON customers.custnmbr = o.external_organization_id
		LEFT JOIN Veo_communities c WITH (NOLOCK) ON c.name = aoc.name AND c.region_id = customers.region_id
	WHERE
		aoc.community_id = @community_id

	-- Second result set includes any community mappings
	SELECT
		aoc.account_id,
		aoc.organization_id,
		aoc.community_id,
		aocm.mapped_name AS echelon_community_name,
		c.community_id AS echelon_community_id
	FROM
		VeoSolutionsSecurity_account_organization_communities aoc WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_account_organization_communities_mappings aocm WITH (NOLOCK) ON aocm.account_id = aoc.account_id AND aocm.organization_id = aoc.organization_id AND aocm.community_id = aoc.community_id
		JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) ON o.organization_id = aoc.organization_id
		LEFT JOIN Veo_customers customers WITH (NOLOCK) ON customers.custnmbr = o.external_organization_id
		LEFT JOIN Veo_communities c WITH (NOLOCK) ON c.name = aoc.name AND c.region_id = customers.region_id
	WHERE
		aoc.community_id = @community_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationCommunityByName]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationCommunityByName]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@community_name VARCHAR(50),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 9/30/2015
	Description: Loads information about the requested community, including its
		echelon community mappings, if it has them. It returns them in to
		separate results sets. The first result set is the community, the second
		is its mappings.

	vds_selAccountOrganizationCommunityByName 'BAB32B7E-3ADA-497C-862E-E5083971CC59', '41E2B9CA-9B05-4C7A-9994-8DBD48660FF9', 'EMERALD VALLEY', '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- First result set is the matching community
	SELECT
		aoc.account_id,
		aoc.organization_id,
		aoc.community_id,
		aoc.name,
		c.community_id AS echelon_community_id -- don't trust the echelon_community_id in the account_organization_communities table, it doesn't appear to get set. So we go look it up ourselves.
	FROM
		VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_account_organization_communities aoc WITH (NOLOCK) ON aoc.account_id = ao.account_id AND aoc.organization_id = ao.organization_id
		JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) on o.organization_id = ao.organization_id
		LEFT JOIN Veo_customers customer WITH (NOLOCK) ON customer.custnmbr = o.external_organization_id
		LEFT JOIN Veo_communities c WITH (NOLOCK) ON c.name = aoc.name AND c.region_id = customer.region_id
	WHERE
		ao.account_id = @account_id
		AND ao.organization_id = @organization_id
		AND aoc.name = @community_name

	-- Second result set includes any community mappings
	SELECT
		aoc.account_id,
		aoc.organization_id,
		aoc.community_id,
		aocm.mapped_name AS echelon_community_name,
		c.community_id AS echelon_community_id
	FROM
		VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_account_organization_communities aoc WITH (NOLOCK) ON aoc.account_id = ao.account_id AND aoc.organization_id = ao.organization_id
		JOIN VeoSolutionsSecurity_account_organization_communities_mappings aocm WITH (NOLOCK) ON aocm.account_id = aoc.account_id AND aocm.organization_id = aoc.organization_id AND aocm.community_id = aoc.community_id
		JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) on o.organization_id = ao.organization_id
		LEFT JOIN Veo_customers customer WITH (NOLOCK) ON customer.custnmbr = o.external_organization_id
		LEFT JOIN Veo_communities c WITH (NOLOCK) ON c.name = aocm.mapped_name AND c.region_id = customer.region_id
	WHERE
		ao.account_id = @account_id
		AND ao.organization_id = @organization_id
		AND aoc.name = @community_name
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationDocument]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationDocument]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@doc_id UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 7/11/2016
	Description: Returns the specified document for a specific account organization
*/
BEGIN
	-- Return the specified document, within the sepcified account organization
	SELECT TOP 1
		account_id,
		organization_id,
		doc_id,
		[application],
		product,
		[description],
		notes,
		allow_inclusion_buyer_packet,
		doc_data,
		size,
		[type],
		[url],
		author,
		create_date,
		modifier,
		modified_date
	FROM
		dbo.account_organization_documents WITH (NOLOCK)
	WHERE
		account_id = @account_id
		AND organization_id = @organization_id
		AND doc_id = @doc_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationDocuments]...';


GO
CREATE PROCEDURE dbo.vds_selAccountOrganizationDocuments
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 7/11/2016
	Description: Returns all of the documents for a specific account organization
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END
	
	-- Return all of the documents for the specified account organization
	SELECT
		account_id,
		organization_id,
		doc_id,
		[application],
		product,
		[description],
		notes,
		allow_inclusion_buyer_packet,
		doc_data,
		size,
		[type],
		url,
		author,
		create_date,
		modifier,
		modified_date
	FROM
		dbo.account_organization_documents WITH (NOLOCK)
	WHERE
		account_id = @account_id
		AND organization_id = @organization_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationDocumentsWithoutContent]...';


GO
CREATE PROCEDURE dbo.vds_selAccountOrganizationDocumentsWithoutContent
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@allow_inclusion_buyer_packet_only BIT = 0,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 5/6/2022
	Description: Returns all of the documents for a specific account organization without file content
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END
	
	-- Return all of the documents for the specified account organization
	SELECT
		d.account_id,
		d.organization_id,
		d.doc_id,
		d.[application],
		d.product,
		d.[description],
		d.notes,
		d.allow_inclusion_buyer_packet,
		d.size,
		d.[type],
		d.url,
		d.author,
		d.create_date,
		d.modifier,
		d.modified_date,
		u.first_name + ' ' + u.last_name as modifier_name
	FROM
		dbo.account_organization_documents d WITH (NOLOCK)
		LEFT JOIN VeoSolutionsSecurity_users u ON u.email = d.modifier
	WHERE
		d.account_id = @account_id
		AND d.organization_id = @organization_id
		AND (@allow_inclusion_buyer_packet_only = 0 OR d.allow_inclusion_buyer_packet = 1)
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationDocumentWithoutContent]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationDocumentWithoutContent]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@doc_id UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 5/16/2022
	Description: Returns the specified document for a specific account organization without document data
*/
BEGIN
	-- Return the specified document, within the sepcified account organization
	SELECT TOP 1
		account_id,
		organization_id,
		doc_id,
		[application],
		product,
		[description],
		notes,
		allow_inclusion_buyer_packet,
		size,
		[type],
		[url],
		author,
		create_date,
		modifier,
		modified_date
	FROM
		dbo.account_organization_documents WITH (NOLOCK)
	WHERE
		account_id = @account_id
		AND organization_id = @organization_id
		AND doc_id = @doc_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationMatchingSpecCommunities]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationMatchingSpecCommunities]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @community VARCHAR(50),
    @effective_date DATETIME,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 8/5/2015
    Description: Returns all of the spec communities, for a give account
                 organization, that are used in a spec that is valid for
                 the passed in effective date. The results will include
                 the echelon community id, the wisenbaker name of the community,
                 and the spec id it is linked with.

    Modified:    2016-07-05. Saul.
                 Include start date in the results, and order the results by descending start date.
                 When multiple valid specs exist, the spec with the most recent start date
                 should be considered the "correct" one. (Per Jim).

	Modified:    Shelby Mansker
	Date:        3/7/2017
	Description: Fixed an issue that was causing it to treat the spec end date incorrectly. The spec
				 end date is still a valid date for the spec to be used. The day after the end date is
				 no longer valid. Echelon stores just the date componet, so for the comparison checks to
				 work, we must remove the time component from the passed in effective date.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Start by fetching the builder id
    DECLARE @builder_id VARCHAR(50) = ''
    SELECT 
        @builder_id = external_organization_id 
    FROM 
        VeoSolutionsSecurity_organizations WITH (NOLOCK) 
    WHERE
        organization_id = @organization_id

    -- Remove the time component from the passed in effective date
	DECLARE @effective_date_no_time DATE = CONVERT(DATE, @effective_date)

    -- Now we will use a common table expression in order to fetch all of the
    -- possible community names, for the supplied account and organization. These
    -- include VDS community names and mapped names.
    ;WITH communities_cte (community_name)
    AS
    (
        -- Fetch VDS community names (builder names)
        SELECT
            aoc.name AS community_name
        FROM
            VeoSolutionsSecurity_account_organization_communities aoc WITH (NOLOCK)
        WHERE
            aoc.account_id = @account_id
            AND aoc.organization_id = @organization_id
            AND aoc.name = @community

        UNION

        -- Fetch mapped community names (Wisenbaker names)
        SELECT
            aocm.mapped_name AS community_name
        FROM
            VeoSolutionsSecurity_account_organization_communities aoc WITH (NOLOCK)
            JOIN VeoSolutionsSecurity_account_organization_communities_mappings aocm WITH (NOLOCK) ON aocm.account_id = aoc.account_id AND aocm.organization_id = aoc.organization_id AND aocm.community_id = aoc.community_id
        WHERE
            aoc.account_id = @account_id
            AND aoc.organization_id = @organization_id
            AND aoc.name = @community
    )
    -- From the possible community names, we will return only those that are used by
    -- this builder in specs that are valid for the passed in effective date.
    SELECT
        sm.spec_id,
        sm.[start_date],
        c.community_id,
        c.name
    FROM
        Veo_spec_communities sc
        JOIN Veo_spec_mstr sm ON sm.spec_id = sc.spec_id
        JOIN Veo_communities c ON c.community_id = sc.community_id
        JOIN communities_cte cte ON cte.community_name = c.name
    WHERE
        sm.builder_id = @builder_id
        AND sm.[start_date] <= @effective_date_no_time
        AND (sm.end_date >= @effective_date_no_time OR sm.end_date IS NULL) --end date can be null
        AND sm.active = 1
    ORDER BY
        sm.[start_date] DESC


END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationMatchingSpecSeries]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationMatchingSpecSeries]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @series VARCHAR(50),
    @effective_date DATETIME,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 8/6/2015
    Description: Returns all of the spec series, for a given account
                 organization, that are used in a spec that is valid for
                 the passed in effective date. The results will include
                 the wisenbaker name of the series
                 and the spec id it is linked with.

    Modified:    2016-07-05. Saul.
                 Include start date in the results, and order the results by descending start date.
                 When multiple valid specs exist, the spec with the most recent start date
                 should be considered the "correct" one. (Per Jim).

	Modified:    Shelby Mansker
	Date:        3/7/2017
	Description: Fixed an issue that was causing it to treat the spec end date incorrectly. The spec
				 end date is still a valid date for the spec to be used. The day after the end date is
				 no longer valid. Echelon stores just the date componet, so for the comparison checks to
				 work, we must remove the time component from the passed in effective date.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Start by fetching the builder id
    DECLARE @builder_id VARCHAR(50) = ''
    SELECT 
        @builder_id = external_organization_id 
    FROM 
        VeoSolutionsSecurity_organizations WITH (NOLOCK) 
    WHERE
        organization_id = @organization_id

    -- Remove the time component from the passed in effective date
	DECLARE @effective_date_no_time DATE = CONVERT(DATE, @effective_date)

    -- Now we will use a common table expression in order to fetch all of the
    -- possible series names, for the supplied account and organization. These
    -- include VDS series names and mapped names.
    ;WITH series_cte (series_name)
    AS
    (
        -- Fetch VDS series names (builder names)
        SELECT
            aos.name AS series_name
        FROM
            VeoSolutionsSecurity_account_organization_series aos WITH (NOLOCK)
        WHERE
            aos.account_id = @account_id
            AND aos.organization_id = @organization_id
            AND aos.name = @series

        UNION

        -- Fetch mapped series names (Wisenbaker names)
        SELECT
            aosm.mapped_name AS series_name
        FROM
            VeoSolutionsSecurity_account_organization_series aos WITH (NOLOCK)
            JOIN VeoSolutionsSecurity_account_organization_series_mappings aosm WITH (NOLOCK) ON aosm.account_id = aos.account_id AND aosm.organization_id = aos.organization_id AND aosm.series_id = aos.series_id
        WHERE
            aos.account_id = @account_id
            AND aos.organization_id = @organization_id
            AND aos.name = @series
    )
    -- From the possible community names, we will return only those that are used by
    -- this builder in specs that are valid for the passed in effective date.
    SELECT
        sm.spec_id,
        sm.[start_date],
        ss.series
    FROM
        Veo_spec_series ss
        JOIN Veo_spec_mstr sm ON sm.spec_id = ss.spec_id
        JOIN series_cte cte ON cte.series_name = ss.series
    WHERE
        sm.builder_id = @builder_id
        AND sm.[start_date] <= @effective_date_no_time
        AND (sm.end_date >= @effective_date_no_time OR sm.end_date IS NULL) --end date can be null
        AND sm.active = 1
    ORDER BY
        sm.[start_date] DESC
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationPlan]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationPlan]
	@plan_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 10/1/2019
	Description: Returns the request plan, including its mapped names, if it
		has any. It returns them in separate result sets. The first result set
		contains information about the plan, and the second contains its mappings
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- First result set is the matching plan
	SELECT
		account_id,
		organization_id,
		plan_id,
		[name],
		address_specific,
		archive
	FROM
		VeoSolutionsSecurity_account_organization_plans WITH (NOLOCK)
	WHERE
		plan_id = @plan_id

	-- Second result set includes any plan mappings
	SELECT
		aop.account_id,
		aop.organization_id,
		aop.plan_id,
		aopm.mapped_name,
		aopm.[source]
	FROM
		VeoSolutionsSecurity_account_organization_plans aop WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_account_organization_plans_mappings aopm WITH (NOLOCK) ON aopm.account_id = aop.account_id AND aopm.organization_id = aop.organization_id AND aopm.plan_id = aop.plan_id
	WHERE
		aop.plan_id = @plan_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationPlanByName]...';


GO
CREATE PROCEDURE dbo.vds_selAccountOrganizationPlanByName
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @plan_name VARCHAR(50),
    @security_token UNIQUEIDENTIFIER	
AS
/*
	Author: Shelby Mansker
	Date: 12/15/2015
	Description: Loads information about the requested plan, including its
		mapped names, if it has any. It returns them in two separate result sets.
		The first result set is the plan, and the second is its mappings.
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END	

	-- First result set is the matching plan
	SELECT
		aop.account_id,
		aop.organization_id,
		aop.plan_id,
		aop.name,
		aop.address_specific,
		aop.archive
	FROM
		VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_account_organization_plans aop WITH (NOLOCK) ON aop.account_id = ao.account_id AND aop.organization_id = ao.organization_id
	WHERE
		ao.account_id = @account_id
		AND ao.organization_id = @organization_id
		AND aop.name = @plan_name

	-- Second result includes any plan mappings
	SELECT
		aop.account_id,
		aop.organization_id,
		aop.plan_id,
		aopm.mapped_name,
		aopm.[source]
	FROM
		VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_account_organization_plans aop WITH (NOLOCK) ON aop.account_id = ao.account_id AND aop.organization_id = ao.organization_id
		JOIN VeoSolutionsSecurity_account_organization_plans_mappings aopm WITH (NOLOCK) ON aopm.account_id = aop.account_id AND aopm.organization_id = aop.organization_id AND aopm.plan_id = aop.plan_id
	WHERE
		ao.account_id = @account_id
		AND ao.organization_id = @organization_id
		AND aop.name = @plan_name
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationPlanItems]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationPlanItems]
    @organization_id UNIQUEIDENTIFIER,
    @build_id INT,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author:       Saul Sanchez
    Create date:  6/9/2014
    Description:  Returns the plan items for the specified organization.
                  If a build id is specified, then return plan items for the
                  specified organization, and application id and product id of the build.

    Modified On 6/22/2015 by Shelby Mansker
        Cleaned the proc up. There was an if check on the build id that would never really work. Basically,
        if the build_id was null, it would use the application_id and product_id variables. However, when build
        was null, those would be empty, which would return every plan item for the organization. I also changed
        the input parameters so that they can't be null.

    EXEC vds_selAccountOrganizationPlanItems @organization_id = '8aaecc3a-2d9e-4500-b0cf-d79d947d33a7', @build_id = 11874627, @security_token = '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
    --Validate the security token
    IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Declare variables
    DECLARE @application_id VARCHAR(10)
    DECLARE @product_id VARCHAR(10)

    -- Get the application id and product id from the build id
    SELECT
        @application_id = a.application_id,
        @product_id = p.product_id
    FROM
        dbo.catalog_selections_areas csa WITH (NOLOCK)
        left join Veo_applications a WITH (NOLOCK) ON a.name = csa.[application]
        left join Veo_products p WITH (NOLOCK) ON p.name = csa.product
    WHERE
        csa.build_id = @build_id

    -- Return plan items based on the organization id, application id, and product id
    SELECT
        *
    FROM
        dbo.VeoSolutionsSecurity_organization_plan_items WITH (NOLOCK)
    WHERE
        organization_id = @organization_id
        AND application_id = @application_id
        AND product_id = @product_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationSeries]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationSeries]
	@series_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 10/1/2019
	Description: Returns the requested series, including its echelon
		series mappings, if it has any. It returns them in separate result
		sets. The first result set contains information about the VDS
		series record, and the second is its mappings.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END	

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- First Result set is the VDS Series record
	SELECT
		account_id,
		organization_id,
		series_id,
		[name]
	FROM
		VeoSolutionsSecurity_account_organization_series WITH (NOLOCK)
	WHERE
		series_id = @series_id

	-- Second Result set includes any series mappings
	SELECT
		aos.account_id,
		aos.organization_id,
		aos.series_id,
		aosm.mapped_name
	FROM
		VeoSolutionsSecurity_account_organization_series aos WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_account_organization_series_mappings aosm WITH (NOLOCK) ON aosm.account_id = aos.account_id AND aosm.organization_id = aos.organization_id AND aosm.series_id = aos.series_id
	WHERE
		aos.series_id = @series_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationSeriesByName]...';


GO
CREATE PROCEDURE dbo.vds_selAccountOrganizationSeriesByName 
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @series VARCHAR(50),
    @security_token UNIQUEIDENTIFIER	
AS
/*
	Author: Shelby Mansker
	Date: 12/15/2015
	Description: Loads information about the request series, including its
		echelon series mappings, if it has them. It returns them in two separate 
		result sets. The first result set is the series, the second is its mappings.
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END	

	-- First Result set is the matching series
	SELECT
		aos.account_id,
		aos.organization_id,
		aos.series_id,
		aos.name
	FROM
		VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_account_organization_series aos WITH (NOLOCK) ON aos.account_id = ao.account_id AND aos.organization_id = ao.organization_id
	WHERE
		ao.account_id = @account_id
		AND ao.organization_id = @organization_id
		AND aos.name = @series

	-- Second Result set includes any series mappings
	SELECT
		aos.account_id,
		aos.organization_id,
		aos.series_id,
		aosm.mapped_name
	FROM
		VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_account_organization_series aos WITH (NOLOCK) ON aos.account_id = ao.account_id AND aos.organization_id = ao.organization_id
		JOIN VeoSolutionsSecurity_account_organization_series_mappings aosm WITH (NOLOCK) ON aosm.account_id = aos.account_id AND aosm.organization_id = aos.organization_id AND aosm.series_id = aos.series_id
	WHERE
		ao.account_id = @account_id
		AND ao.organization_id = @organization_id
		AND aos.name = @series

END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationSupportEmail]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationSupportEmail]
	@account_org_id UNIQUEIDENTIFIER,
	@problem_type VARCHAR(8000),
    @security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 02/25/2019
	Description: Returns the specified support email address
		for a specific account organization and problem type
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT TOP 1
		aose.*,
		pt.[name] as problem_type
	FROM
		dbo.account_organization_support_emails aose WITH (NOLOCK)
	INNER JOIN
		dbo.problem_types pt WITH (NOLOCK) ON pt.[type_id] = aose.problem_type_id
	WHERE
		aose.account_org_id = @account_org_id
		AND pt.[name] = @problem_type
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationSupportEmails]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationSupportEmails]
	@account_org_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 5/17/2023
	Description: Returns all support email address
		for a specific account organization
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		aose.*
	FROM
		dbo.account_organization_support_emails aose WITH (NOLOCK)
	WHERE
		aose.account_org_id = @account_org_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationUser]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationUser]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @user_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Saul Sanchez
    Create Date: 07/20/2016
    Description: Returns an account organization user.

	Modified: Shelby Mansker
	Date: 2/15/2017
	Description: Now returns to result sets. The first result is the user (with email added).
		The second result set contains all of the user's roles in the specified organization
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- The First Result set is the user information
    SELECT
        aou.account_id,
        aou.organization_id,
        aou.[user_id],
        aou.first_name,
        aou.last_name,
		u.email,
        aou.active,
        aou.external_id,
        aou.is_designer,
        aou.author,
        aou.create_date,
        aou.modifier,
        aou.modified_date,
        aou.stamp,
		ISNULL(u.is_test_user, 0) AS is_test_user
    FROM
        VeoSolutionsSecurity_account_organization_users aou WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_users u WITH (NOLOCK) ON u.[user_id] = aou.[user_id]
    WHERE
        aou.account_id = @account_id
        AND aou.organization_id = @organization_id
        AND aou.[user_id] = @user_id

	-- The second result set contains the user's roles in the specified organization
	SELECT
		aour.account_id,
		aour.organization_id,
		aour.[user_id],
		r.role_id,
		r.name,
		r.numeric_role_id,
		r.alpha_role_id,
		aour.author,
		aour.create_date,
		aour.modifier,
		aour.modified_date,
		aour.stamp
	FROM
		VeoSolutionsSecurity_account_organization_users_roles_legacy aour WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_roles_legacy r WITH (NOLOCK) ON r.role_id = aour.role_id
	WHERE
		aour.account_id = @account_id
		AND aour.organization_id = @organization_id
		AND aour.[user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationUserById]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationUserById]
    @user_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Nirav Rana
    Create Date: 11/02/2021
    Description: Returns an account organization user by ID.

*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- The First Result set is the user information
    SELECT
        aou.account_id,
        aou.organization_id,
        aou.[user_id],
        aou.first_name,
        aou.last_name,
		u.email,
        aou.active,
        aou.external_id,
        aou.is_designer,
        aou.author,
        aou.create_date,
        aou.modifier,
        aou.modified_date,
        aou.stamp
    FROM
        VeoSolutionsSecurity_account_organization_users aou WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_users u WITH (NOLOCK) ON u.[user_id] = aou.[user_id]
    WHERE
        aou.[user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationUserDesigners]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationUserDesigners] 
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 10/2/2015
    Description: Returns all of the active designers for a 
        given account organization.

	Modified: Shelby Mansker
	Date: 7/18/2016
	Description: Changed query to return all columns from the users table,
		instead of specific columns.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    SELECT
        u.*      
    FROM
        VeoSolutionsSecurity_users u WITH (NOLOCK)
        JOIN VeoSolutionsSecurity_account_organization_users aou WITH (NOLOCK) ON aou.[user_id] = u.[user_id]
    WHERE
        aou.account_id = @account_id
        AND aou.organization_id = @organization_id
        AND aou.active = 1
        AND u.active = 1
        AND aou.is_designer = 1
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationUserProfile]...';


GO
CREATE PROCEDURE dbo.vds_selAccountOrganizationUserProfile
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@user_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:			Shelby Mansker
	Create date:	11/25/2014
	Description:	Searches for a specific account organization user profile and returns it.

	Modified:		Roger Wang
	Create date:	5/30/2019
	Description:	Includes account_org_id.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT TOP 1
		p.account_id,
		p.organization_id,
		ao.account_org_id,
		p.[user_id],
		p.profile_id,
		p.interest_rate,
		p.loan_term,
		p.completed_steps,
		p.enable_homebuyer_access,
		p.author,
		p.create_date,
		p.modifier,
		p.modified_date,
		p.stamp
	FROM
		dbo.account_organization_user_profile p WITH (NOLOCK)
	INNER JOIN
		dbo.VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK) ON ao.account_id = p.account_id AND ao.organization_id = p.organization_id
	WHERE
		p.account_id = @account_id
		AND p.organization_id = @organization_id
		AND p.[user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationUserProfilePlans]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationUserProfilePlans]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@user_id UNIQUEIDENTIFIER
AS
/*
	Author: ???
	Date: 4/13/2015
	Description: Fetches all of the profiles plans for a specific user. 

	Modified: Shelby Mansker
	Date: 9/27/2017
	Description: Cleaned up proc. Also changed the community,
		series, and plan name LIKE statements to TRIMS. Like could potentially have false positives,
		if one name is a subpart of another name. Trimming will make sure spaces are ignored in the
		profile plan versions of the names.

	Modified: Saul Sanchez
	Date: 02/06/2018
	Description: Reverted how we get the the community, series, and plan guids, but kept the trim logic.

	Modified: Shelby Mansker
	Date: 6/2/2020
	Description: Added the account_org_id to the output, in order to consolidate all of the procs that
		return information about Profile Plans. Also, changed the name of the community, series, and plan
		id fields being returned to be more consistent with our field naming conventions. Also added the 
		plan's address_specific flag to the output.
*/
BEGIN
	SELECT 
		pp.*,
		ao.account_org_id,
		up.profile_id AS user_profile_id,
		o.property_desc_1_label,
		o.property_desc_2_label,
		(select top 1 community_id from [dbo].[VeoSolutionsSecurity_account_organization_communities] where account_id = pp.account_id and organization_id = pp.organization_id and name = LTRIM(RTRIM(pp.community_name))) as community_id,
		(select top 1 series_id from [dbo].[VeoSolutionsSecurity_account_organization_series] where account_id = pp.account_id and organization_id = pp.organization_id and name = LTRIM(RTRIM(pp.series))) as series_id,
		(select top 1 plan_id from [dbo].[VeoSolutionsSecurity_account_organization_plans] where account_id = pp.account_id and organization_id = pp.organization_id and name = LTRIM(RTRIM(pp.plan_name))) as plan_id,
		(select top 1 address_specific from [dbo].[VeoSolutionsSecurity_account_organization_plans] where account_id = pp.account_id and organization_id = pp.organization_id and name = LTRIM(RTRIM(pp.plan_name))) as address_specific,
		(select top 1 plan_id from [dbo].[VeoSolutionsSecurity_account_organization_plans] where account_id = pp.account_id and organization_id = pp.organization_id and name = LTRIM(RTRIM(pp.base_plan_name))) as base_plan_id
	FROM 
		account_organization_user_profile_plan pp
		JOIN account_organization_user_profile up ON up.account_id = pp.account_id AND up.organization_id = pp.organization_id AND up.[user_id] = pp.[user_id]
		JOIN dbo.VeoSolutionsSecurity_account_organizations ao ON ao.account_id = pp.account_id AND ao.organization_id = pp.organization_id
		JOIN veosolutionssecurity_organizations o ON o.organization_id = ao.organization_id
	WHERE
		pp.account_id = @account_id
		AND pp.organization_id = @organization_id
		AND pp.[user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationUserRole]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrganizationUserRole]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @user_id UNIQUEIDENTIFIER,
    @role_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Saul Sanchez
    Create Date: 07/20/2016
    Description: Returns an account organization user role
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT
        account_id,
        organization_id,
        [user_id],
        role_id,
        author,
        create_date,
        modifier,
        modified_date,
        stamp
    FROM
        VeoSolutionsSecurity_account_organization_users_roles_legacy WITH (NOLOCK)
    WHERE
        account_id = @account_id
        AND organization_id = @organization_id
        AND [user_id] = @user_id
        AND role_id = @role_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationUserRoles]...';


GO
CREATE PROCEDURE dbo.vds_selAccountOrganizationUserRoles
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@user_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 1/14/2016
	Description: Returns all of the roles that a user has in a given account's organization.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		aour.account_id,
		aour.organization_id,
		aour.[user_id],
		aour.role_id,
		r.name,
		r.numeric_role_id,
		r.alpha_role_id
	FROM
		dbo.VeoSolutionsSecurity_account_organization_users_roles_legacy aour WITH (NOLOCK)
		JOIN dbo.VeoSolutionsSecurity_roles_legacy r WITH (NOLOCK) ON r.role_id = aour.role_id
	WHERE
		aour.account_id = @account_id
		AND aour.organization_id = @organization_id
		AND aour.[user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrganizationUserWishListItems]...';


GO
CREATE PROCEDURE dbo.vds_selAccountOrganizationUserWishListItems
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @user_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 01/26/2015
    Description: Returns all of the wish list items for a particular 
                 accountOrganizationUser. Does NOT include the image_data.

    EXEC dbo.vds_selAccountOrganizationUserWishListItems 
        @account_id = 'bab32b7e-3ada-497c-862e-e5083971cc59', 
        @organization_id = '78d12721-c3d5-4067-9e89-9b4c32a8cda2', 
        @user_id = 'f15ac710-cdf1-4933-966c-4f28a7c2edc8', 
        @security_token = '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT
        account_id,
        organization_id,
        [user_id],
        wishlist_item_id,
        item_type,
        item_no,
        [description],
        notes,
        author,
        create_date,
        modifier,
        modified_date,
        stamp,
        gpc_id
    FROM
        dbo.account_organization_user_wishlist_items WITH (NOLOCK)
    WHERE
        account_id = @account_id
        AND organization_id = @organization_id
        AND [user_id] = @user_id
    ORDER BY
        create_date
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrgPlanKeyElements]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrgPlanKeyElements]
	@account_id UNIQUEIDENTIFIER, 
	@org_id UNIQUEIDENTIFIER, 
	@security_token UNIQUEIDENTIFIER
AS
/*
    Author: Rob Hobbs
	Date: 5/11/16
    Description: 
				 - all communities, series, plans and elevations 
				 The element_type column will contain PLAN, COMMUNITY or SERIES. 

	Modified: Shelby Mansker
	Date: 6/18/2020
	Description: This proc was returning all of the community, series, plan combinations for this 
		account organization, in a second result set. However, that result set was never being used.
		I removed it, and cleaned up the proc a bit. Also, made the Security token mandatory with a
		check on it.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END	

	-- COMMUNITIES 
	SELECT
		'COMMUNITY' as element_type, 
		t1.community_id as element_id, 
		t1.name as element_name
	FROM 
		VeoSolutionsSecurity_account_organization_communities t1 WITH (NOLOCK) 
	WHERE 
		t1.account_id = @account_id
        AND t1.organization_id = @org_id
		
	UNION 

	-- SERIES 
	select 
		'SERIES' as element_type, 
		t1.series_id as element_id, 
		t1.name as element_name
	FROM 
		VeoSolutionsSecurity_account_organization_series t1 WITH (NOLOCK) 
	WHERE 
		t1.account_id = @account_id
        AND t1.organization_id = @org_id
		
	UNION 

	-- PLANS 
	select 
		'PLAN' as element_type, 
		aop.plan_id as element_id, 
		aop.name as element_name
	FROM 
		VeoSolutionsSecurity_account_organization_plans aop WITH (NOLOCK) 
	WHERE 
		aop.account_id = @account_id
        AND aop.organization_id = @org_id

	UNION 

	-- ELEVATIONS 
	SELECT 
		'ELEVATION' as element_type, 
		NEWID() as element_id, 
		e.elevation as element_name 
	FROM 
		VeoSolutionsSecurity_organization_elevations e WITH (NOLOCK) 
	WHERE 
		e.organization_id = @org_id 
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAccountOrgPlanKeys]...';


GO
CREATE PROCEDURE [dbo].[vds_selAccountOrgPlanKeys]
	@account_id UNIQUEIDENTIFIER, 
	@org_id UNIQUEIDENTIFIER, 
	@security_token UNIQUEIDENTIFIER
AS
/*
    Author: Rob Hobbs
	Date: 5/13/16
    Description: fetches the combinations of community, series and plan 

	Modified: Shelby Mansker
	Date: 9/15/2017
	Description: Cleaned up proc, added security token check, and added additional information
		to the Plan Key mapping (address specific flag and archive flag)
				 
	Modified: Shelby Mansker
	Date: 6/19/2018
	Description: Added community and series archive flags to results. renamed the plan archive result accordingly.
				 Also removed the default null value for the @security_token parameter

	Modified: Shelby Mansker
	Date: 6/18/2020
	Description: Added community, series, and plan ids to the results.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END	

	-- GET COMMUNITY SERIES PLAN COMBINATIONS 
	SELECT 
		t.account_id, 
		t.organization_id, 
		t.is_archived AS is_tenant_plan_archived,
		c.[name] AS community,
		c.community_id,
		c.archive AS community_archived,
		s.[name] AS series, 
		s.series_id,
		s.archive AS series_archived,
		p.[name] AS [plan],
		p.plan_id,
		p.address_specific,
		p.archive AS plan_archived
	FROM 
		VeoSolutionsSecurity_account_org_community_series_plan t WITH (NOLOCK) 
		JOIN VeoSolutionsSecurity_account_organization_communities c WITH (NOLOCK) ON c.community_id = t.community_id
		JOIN VeoSolutionsSecurity_account_organization_series s WITH (NOLOCK) ON s.series_id = t.series_id 
		JOIN VeoSolutionsSecurity_account_organization_plans p WITH (NOLOCK) ON p.plan_id = t.plan_id 
	WHERE
		t.organization_id = @org_id
		AND t.account_id = @account_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAllCatalogOptionPricingItemsForNonSession]...';


GO
CREATE PROCEDURE [dbo].[vds_selAllCatalogOptionPricingItemsForNonSession]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@community_name VARCHAR(50) = 'All',
	@series_name VARCHAR(50) = 'All',
	@plan_name VARCHAR(50) = 'All',
	@base_plan_name VARCHAR(50) = 'All',
	@application VARCHAR(100) = '',
	@product VARCHAR(100) = '',
	@security_token UNIQUEIDENTIFIER
AS 
/*
	Author: ???

	Modifier: Shelby Mansker
	Date: 11/19/2019
	Description: Modified this proc so that it considers base plans, as well as mappings for communities, series, and plans. Also,
		added optional application and product filtering.

	Modifier: Eric Hickey
	Date: 12/06/2019
	Description: Added a statement that removed duplicate plan names from @valid_plan_names before that list was used in the join.
		If there are duplicate plan names, then we get duplicate options in some areas of the system.
*/
BEGIN
	-- Fetch Catalog Items that match our valid communities, series, and plans (including base plans)
	SELECT
		a.application_id,
		LTRIM(RTRIM(ci.[application])) AS [application],
		p.product_id,
		LTRIM(RTRIM(ci.product)) AS [product],
		'Catalog' AS [source],
		ISNULL(ci.area, 'All') AS area,
		ISNULL(ci.sub_area, 'All') AS sub_area,
		'Catalog' AS item_type,
		ci.item_no,
		ci.item,
		ci.qty,
		ci.price,
		ci.gpc,
		(SELECT COUNT(*) FROM gpc_products_documents WITH (NOLOCK) WHERE gpc_id = TRY_CONVERT(UNIQUEIDENTIFIER,ci.gpc) ) AS gpc_doc_count,
		ci.option_pricing_display,
		GETDATE() AS effective_date
	FROM
		catalog_items ci
		LEFT JOIN Veo_applications a WITH (NOLOCK) ON a.[name] = ci.[application]
		LEFT JOIN Veo_products p WITH (NOLOCK) ON p.[name] = ci.product
	WHERE
		ci.account_id = @account_id
		AND ci.organization_id = @organization_id
		AND ci.option_pricing_display = 1
		AND (@community_name IS NULL OR community in ('All', @community_name))
		AND (@series_name IS NULL OR series in ('All', @series_name))
		AND (@plan_name IS NULL OR [plan] in ('All', @plan_name) OR ([plan] = @base_plan_name AND @base_plan_name IS NOT NULL))
		AND (@application = '' OR @application IS NULL OR ci.[application] = @application)
		AND (@product = '' OR @product IS NULL OR ci.product = @product)
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAllOptionPricingItemsForSession]...';


GO
CREATE PROCEDURE [dbo].[vds_selAllOptionPricingItemsForSession]
@session_id UNIQUEIDENTIFIER,
@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Create Date: 8/19/2015
	Description: Fetches all option pricing items for the specified session.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT 
		a.application_id,
		RTRIM(LTRIM(cs.[application])) as [application],
		p.product_id,
		RTRIM(LTRIM(cs.product)) as product,
		cs.[source],
		cs.area,
		cs.sub_area,
		0 as location_id,
		cs.item_type,
		cs.item_no,
		cs.item,
		ISNULL(cs.price, 0) as price,
		cs.gpc,
		gpc_doc_count = (select count(*) from gpc_products_documents with (nolock) where gpc_id = try_convert(uniqueidentifier,cs.gpc)),
		cs.option_pricing_display,
		s.spec_id,
		s.effective_date,
		ISNULL(bs.contract_sort_order, 9999999) AS contract_sort_order
	FROM 
		catalog_selections cs with (nolock)
		LEFT JOIN veo_areas va with (nolock) on va.area_id = cs.area_id
		LEFT JOIN Veo_applications a with (nolock) on a.name = cs.[application]
		LEFT JOIN Veo_products p with (nolock) on p.name = cs.product
		LEFT JOIN account_organization_user_profile_plan_catalog_sessions s with (nolock) on s.session_id = cs.session_id
		LEFT JOIN Veo_builder_styles bs with (nolock)
			ON bs.spec_id = s.spec_id 
			AND bs.application_id = a.application_id
			AND bs.product_id = p.product_id
			AND bs.item_type = cs.item_type
			AND bs.item = cs.item_no
			AND bs.effective_date = s.effective_date 
		LEFT JOIN catalog_selections_areas csa with (nolock)
			ON csa.session_id = cs.session_id
			AND csa.[application] = cs.[application]
			AND csa.product = cs.product
			AND csa.area = cs.area
			AND csa.sub_area = cs.sub_area
			AND csa.area_id = cs.area_id
			AND csa.sub_area_id = cs.sub_area_id
	WHERE 
		cs.session_id = @session_id
		AND (cs.is_credit = 0)
		AND (cs.item != 'User')
		AND ((cs.[source] != 'Catalog') or (cs.[source] = 'Catalog' AND cs.option_pricing_display = 1))
		AND ((cs.[source] != 'Prices Landed') or (cs.[source] = 'Prices Landed' AND csa.area_selected = 1))
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAllPatterns]...';


GO
CREATE PROCEDURE dbo.vds_selAllPatterns
    @security_token UNIQUEIDENTIFIER	
AS
/*
	Author: Reid Wilson
	Date: 4/5/2022
	Description: Returns all of the patterns without regard to account/organization
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Generate the customer's allowable pattern list
	DECLARE @customerPatterns TABLE 
	(
		pattern_id INT 
	)

	INSERT INTO @customerPatterns
		SELECT pattern_id FROM Veo_product_patterns

	-- The first result set contains all of the patterns
	SELECT DISTINCT
		pp.pattern_id,
	    pp.pattern_name,
		pp.active,
        pp.application_id,
        pp.product_id
	FROM
		@customerPatterns cp
		JOIN Veo_product_patterns pp WITH (NOLOCK) ON pp.pattern_id = cp.pattern_id

	-- The second result set contains all of the areas and sub areas that each pattern is used in (can be empty for some patterns)
	SELECT DISTINCT
		cp.pattern_id,
		ppa.area_id,
		ppa.sub_area_id
	FROM
		@customerPatterns cp
		JOIN Veo_product_patterns_areas ppa WITH (NOLOCK) ON ppa.pattern_id = cp.pattern_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAllSelectedAreas]...';


GO
CREATE PROCEDURE [dbo].[vds_selAllSelectedAreas] 
	@session_id uniqueidentifier,
	@security_token uniqueidentifier
AS
/* 
	Author:		Robert Hobbs
	Create date: July 28, 2014
	Description: Return list of all selected Builds (Estimated Areas) 
  
	-- Examples
	-- old proc, not really what we want: 
	[vds_selOtherAreas] '436c7112-8bbb-4d54-becf-90b45d78a054', 9797544, null

	-- new product (for comparison) 
	vds_selAllSelectedAreas '436c7112-8bbb-4d54-becf-90b45d78a054', null
	select * from catalog_selections_areas where session_id = '436c7112-8bbb-4d54-becf-90b45d78a054' and build_id = 9797544
	select * from catalog_selections_areas where session_id = '436c7112-8bbb-4d54-becf-90b45d78a054' and selected > 0 and build_id != 9797544 and application = 'Flooring' and product ='wood'
	
*/
BEGIN

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT  
		areas.[application],
		areas.product,
		areas.area,
		areas.sub_area,
		areas.build_id,
		areas.notes, 
		areas.selected,
        (SELECT TOP 1
            is_credit
         FROM
            dbo.catalog_selections WITH (NOLOCK)
         WHERE
            session_id = @session_id
            and [application] = areas.[application]
            and product = areas.product
            and area = areas.area
            and sub_area = areas.sub_area
            and rtrim(item) <> 'custom'
            and item not like '%pad%'
        ) AS is_credit
	FROM 
		dbo.catalog_selections_areas areas WITH (NOLOCK)

	WHERE 
		areas.session_id = @session_id
		AND areas.area_selected = 1 -- 'AREA' IS 'SELECTED' 
		AND areas.selected > 0 -- HAS A SELECTION (AT LEAST PRODUCT) 
		
	ORDER BY 
		areas.area, 
		areas.sub_area, 
		areas.application

END
GO
PRINT N'Creating Procedure [dbo].[vds_selAllSessionsForPlan]...';


GO
CREATE PROCEDURE [dbo].[vds_selAllSessionsForPlan]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @user_id UNIQUEIDENTIFIER,
    @community_name VARCHAR(50),
    @series_name VARCHAR(50),
    @plan_name VARCHAR(50),
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Saul Sanchez
    Create Date: 8/13/2015
    Description: Returns a list of sessions for a given plan.

	Modified by: Art deHoyos
	Modified Date: 02/21/2019
	Description: Use deposit field from aoupp instead of the one in aouppcs since it doesn't get updated.

    Modified by: Daniel Arwe
    Modified Date: 08/18/2025
    Description: Added precon_notes field to query.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT
      aouppcs.[account_id],
      aouppcs.[organization_id],
      aouppcs.[user_id],
      aouppcs.[community_id],
      aouppcs.[community_name],
      aouppcs.[series],
      aouppcs.[plan_name],
      aouppcs.[plan_version],
      aouppcs.[session_id],
      aouppcs.[status],
      aouppcs.[status_change_reason],
      aouppcs.[session_notes],
      aouppcs.[precon_notes],
      aoupp.[additional_design_deposit],
      aoupp.[deposit_notes],
      aouppcs.[designer_id],
      aouppcs.[designer],
      aouppcs.[show_report],
      aouppcs.[spec_id],
      aouppcs.[effective_date],
      aouppcs.[completed_date],
      aouppcs.[first_completed_date],
      aouppcs.[export_date],
      aouppcs.[address_id],
      aouppcs.[rounding_type],
      aouppcs.[rounding_places],
      aouppcs.[builder_markup_hb_pricing],
      aouppcs.[buyer_signature],
      aouppcs.[buyer_signature_date],
      aouppcs.[pricing_generated],
      aouppcs.[pricing_published],
      aouppcs.[report_id],
      aouppcs.[author],
      aouppcs.[create_date],
      aouppcs.[modifier],
      aouppcs.[modified_date],
      aouppcs.[stamp],
      aouppcs.[catalog_source]
    FROM
        account_organization_user_profile_plan_catalog_sessions aouppcs
		JOIN account_organization_user_profile_plan aoupp on
			aoupp.account_id = aouppcs.account_id
			AND aoupp.organization_id = aouppcs.organization_id
			AND aoupp.[user_id] = aouppcs.[user_id]
			AND aoupp.community_name = aouppcs.community_name
			AND aoupp.series = aouppcs.series
			AND aoupp.plan_name = aouppcs.plan_name

    WHERE
        aouppcs.account_id = @account_id
        AND aouppcs.organization_id = @organization_id
        AND aouppcs.[user_id] = @user_id
        AND aouppcs.community_name = @community_name
        AND aouppcs.series = @series_name
        AND aouppcs.plan_name = @plan_name
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAllUserActiveAccountOrganizations]...';


GO
CREATE PROCEDURE [dbo].[vds_selAllUserActiveAccountOrganizations]
	@user_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Robert Hobbs
	Date: 4/17/2017
	Description: Returns all of the account organizations for a user.
	Testing: vds_selAllUserActiveAccountOrganizations 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', '01234567-89AB-CDEF-0000-123456789ABC'

	Modified By: Shelby Mansker
	Date: 6/10/2020
	Description: Added additional information about the account organization, for consistency in VDS.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		a.account_id,
		a.[name] AS account_name,
		o.organization_id,
		o.[name] AS organization_name,
		ao.account_org_id,
		ao.active
	FROM
		VeoSolutionsSecurity_account_organization_users aou WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK) ON ao.account_id = aou.account_id AND ao.organization_id = aou.organization_id
		JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) ON o.organization_id = ao.organization_id
		JOIN VeoSolutionsSecurity_accounts a WITH (NOLOCK) ON a.account_id = ao.account_id
	WHERE
		aou.[user_id] = @user_id
		AND aou.active = 1
		AND ao.active = 1
		AND o.active = 1
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAreaPriceLevels]...';


GO
CREATE PROCEDURE [dbo].[vds_selAreaPriceLevels]
	@session_id UNIQUEIDENTIFIER,
	@application VARCHAR(50),
	@product VARCHAR(50),
	@area VARCHAR(100),
	@sub_area VARCHAR(50),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:      Shelby Mansker
	Create date: 05/01/2014
	Description: Returns all of the pricing levels for a specific area.
	
	Updated 05/01/2014: Refactored this procedure a bit. It returns specific
	        columns now. Also reformatted it to be easier to read, with comments.
	        Finally, I added the security token. Shelby Mansker.

    Updated 06/13/2014: Updated so prices are returned according to the sort order
            used by Veo Solutions in vs_getUserCatalogSelections. Saul Sanchez.
	
    Updated 8/6/2015: Added session_id to the results. Also cleaned up the query a bit by removing the unecessary subquery syntax. Shelby Mansker

	vds_selAreaPriceLevels 'a32ce288-a203-4c7a-ba69-36eea2686a21','Flooring','Tile','Bedroom 3','', '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
    --DECLARE @session_id UNIQUEIDENTIFIER
    --DECLARE @application VARCHAR(50)
    --DECLARE @product VARCHAR(50)
    --DECLARE @area VARCHAR(50)
    --DECLARE @sub_area VARCHAR(50)
    --DECLARE @security_token UNIQUEIDENTIFIER

    --SET @session_id = '3e54ec71-3520-498a-ac57-92009a9451df'
    --SET @application = 'Window Coverings'
    --SET @product = 'Blinds & Shutters'
    --SET @area = 'Family'
    --SET @sub_area =  ''
    --set @security_token = '01234567-89AB-CDEF-0000-123456789ABC'

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT 
        cs.session_id,
		cs.row_id,
		cs.item_no,
		cs.item,
		cs.qty,
		cs.price,
		cs.selected,
		cs.make_std,
        ISNULL(bs.contract_sort_order, 99999) AS sort_order
	FROM 
		dbo.catalog_selections cs WITH (NOLOCK)
        LEFT JOIN Veo_applications a WITH (NOLOCK) ON a.name = cs.[application]
        LEFT JOIN Veo_products p WITH (NOLOCK) ON p.name = cs.product
        LEFT JOIN dbo.account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
            ON ppcs.session_id = cs.session_id
        LEFT JOIN Veo_builder_styles bs WITH (NOLOCK)
            ON bs.spec_id = ppcs.spec_id
            AND bs.application_id = a.application_id
            AND bs.product_id = p.product_id
            AND bs.item_type = cs.item_type
            AND bs.item = cs.item_no
            AND bs.effective_date = ppcs.effective_date
	WHERE
		cs.session_id = @session_id
		AND cs.[application] = @application
		AND cs.product = @product
		AND cs.area = @area
		AND cs.sub_area = @sub_area
		AND cs.[source] = 'Prices Landed'
    ORDER BY sort_order
END
GO
PRINT N'Creating Procedure [dbo].[vds_selAvailableCabinetPartsBySessionGroup]...';


GO
CREATE PROCEDURE [dbo].[vds_selAvailableCabinetPartsBySessionGroup]
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
	@group_id INT,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:      Shelby Mansker
	Create date: 6/9/2015
	Description: Returns all of the selectable parts for cabinets in the group located in the specified session. Each part corresponds to a cabinet color, door style, species, and optional door look.

	Modified: Shelby Mansker
	Date: 6/23/2016
	Description: Redesigned this proc so that it no longer parses the part number to look up cabinet parts.

	Modified:		Roger Wang
	Date:			8/9/2022
	Description:	Include area/sub area when fetching items from group detail.

	dbo.vds_selAvailableCabinetPartsBySessionGroup @session_id = '362F003A-2DBC-4326-B41F-2E166AD081CE', @group_id = 5186, @security_token = '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	declare @area_id varchar(50)
	declare @sub_area_id varchar(50)

	select
		@area_id = area_id,
		@sub_area_id = sub_area_id
	from
		veo_plan_builds vpb with (nolock)
		left join veo_plan_mstr vpm with (nolock) on vpm.plan_id = vpb.plan_id
		left join veo_spec_mstr vsm with (nolock) on vsm.spec_id = vpm.spec_id
	where
		vpb.build_id_num = @build_id

	DECLARE @cabinet_parts TABLE
	(
		part_no VARCHAR(81) NOT NULL, -- comes from catalog_selections_group_detail
		color_id VARCHAR(50) NULL, -- comes from colors
		color_name VARCHAR(50) NULL, -- comes from cabinet_colors
		door_style_id VARCHAR(50) NULL, -- comes from cabinet_door_styles
		door_style_name VARCHAR(50) NULL, -- comes from styles_attributes
		species_id VARCHAR(50) NULL, -- comes from cabinet_species
		species_name VARCHAR(50) NULL, -- comes from styles_attributes
		door_panel_id VARCHAR(50) NULL, -- comes from cabinet_door_panels
		door_panel_name VARCHAR(50) NULL -- comes from styles_attributes
	);

	INSERT INTO
		@cabinet_parts (part_no, color_id)
	SELECT
		c.part_no,
		c.color_id
	FROM
		catalog_selections_group_detail csgd WITH (NOLOCK)
		JOIN VEO_colors c WITH (NOLOCK) ON c.part_no = csgd.item
	WHERE
		csgd.session_id = @session_id
		AND csgd.group_id = @group_id
		AND ISNULL(csgd.area_id, '') in (@area_id, '')
		AND ISNULL(csgd.sub_area_id, '') in (@sub_area_id, '')

	UNION

	SELECT
		c.part_no,
		c.color_id
	FROM
		catalog_selections_group_detail csgd WITH (NOLOCK)
		JOIN VEO_styles_groups sg WITH (NOLOCK) ON sg.group_id = csgd.group_id
		JOIN VEO_styles s WITH (NOLOCK) ON s.product_id = sg.product_id AND s.style_id = csgd.item
		JOIN VEO_colors c WITH (NOLOCK) ON c.product_id = s.product_id AND c.style_id = s.style_id
		JOIN VEO_stocking_codes sc WITH (NOLOCK) ON sc.code = c.stocking_code
	WHERE
		csgd.session_id = @session_id
		AND csgd.group_id = @group_id
		AND ISNULL(csgd.area_id, '') in (@area_id, '')
		AND ISNULL(csgd.sub_area_id, '') in (@sub_area_id, '')
		AND sc.designer_selectable = 1;

	-- grab the color name for each part
	MERGE INTO @cabinet_parts T
	USING VEO_cabinet_colors S
		ON T.color_id = S.color_id
	WHEN MATCHED THEN
		UPDATE SET color_name = S.color_name;

	-- now find the door style name for each part from the styles_attributes
	UPDATE @cabinet_parts
	SET
		door_style_name = T.door_style_name
	FROM (
		SELECT
			c.part_no AS part,
			sa.value_id AS door_style_name
		FROM
			@cabinet_parts cp
			JOIN VEO_colors c WITH (NOLOCK) ON c.part_no = cp.part_no
			LEFT JOIN VEO_styles s WITH (NOLOCK) ON s.style_id = c.style_id
			LEFT JOIN VEO_styles_attributes sa WITH (NOLOCK) ON sa.style_id = s.style_id
		WHERE
			c.product_id = 'Y'
			AND sa.attribute_id = 'DOOR_STYLE'
		) T
	WHERE
		part_no = T.part;

	-- now find the species name for each part from the styles_attributes
	UPDATE @cabinet_parts
	SET
		species_name = T.species_name
	FROM (
		SELECT
			c.part_no AS part,
			sa.value_id AS species_name
		FROM
			@cabinet_parts cp
			JOIN VEO_colors c WITH (NOLOCK) ON c.part_no = cp.part_no
			LEFT JOIN VEO_styles s WITH (NOLOCK) ON s.style_id = c.style_id
			LEFT JOIN VEO_styles_attributes sa WITH (NOLOCK) ON sa.style_id = s.style_id
		WHERE
			c.product_id = 'Y'
			AND sa.attribute_id = 'SPECIES'
		) T
	WHERE
		part_no = T.part;

	-- now find the optional door look name for each part from the styles_attributes
	UPDATE @cabinet_parts
	SET
		door_panel_name = T.door_panel_name
	FROM (
		SELECT
			c.part_no AS part,
			sa.value_id AS door_panel_name
		FROM
			@cabinet_parts cp
			JOIN VEO_colors c WITH (NOLOCK) ON c.part_no = cp.part_no
			LEFT JOIN VEO_styles s WITH (NOLOCK) ON s.style_id = c.style_id
			LEFT JOIN VEO_styles_attributes sa WITH (NOLOCK) ON sa.style_id = s.style_id
		WHERE
			c.product_id = 'Y'
			AND sa.attribute_id = 'OPTIONAL_DOOR_LOOK'
		) T
	WHERE
		part_no = T.part;

	-- now look up the ids for the door styles
	MERGE INTO @cabinet_parts T
	USING VEO_cabinet_door_styles S
		ON T.door_style_name = S.name
	WHEN MATCHED THEN
		UPDATE SET door_style_id = S.style_id;

	-- now look up the ids for the door species
	MERGE INTO @cabinet_parts T
	USING VEO_cabinet_species S
		ON T.species_name = S.species_name
	WHEN MATCHED THEN
		UPDATE SET species_id = S.species_id;

	-- now look up the ids for the door styles
	MERGE INTO @cabinet_parts T
	USING VEO_cabinet_door_panels S
		ON T.door_panel_name = S.name
	WHEN MATCHED THEN
		UPDATE SET door_panel_id = S.panel_id;

	SELECT * FROM @cabinet_parts;

END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuildAvailableBomModifications]...';


GO
CREATE PROCEDURE [dbo].[vds_selBuildAvailableBomModifications]
    @session_id UNIQUEIDENTIFIER,
    @build_id INT,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 10/20/2015
    Description: Fetches all of the available bom modifications for the specified build, in
        a given session. 

    Modified: Shelby Mansker
    Date: 10/21/2015
    Desription: If the build already has one of the available bom modifications selected, the results
        will include that modifications quantity, price, cost, and notes. Thus, the results have been
        updated to not only include the available bom modifications for a specific build, but also
        that builds current selections.

    Modified: Shelby Mansker
    Date: 10/23/2015
    Description: Price and Cost are no longer modifiable within an area, so we won't be storing them at the
        area level. Instead, they'll just be returned from the session bom modification snapshot record.
    
    dbo.vds_selSessionBomLineModifications @session_id = '9ae38f7d-8a0f-4ccf-afd4-5a8f83761eee', @build_id = 12229774, @security_token = '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Fetch the application id, product id, area id, and sub area id, for the passed in build
    DECLARE @application_id VARCHAR(10),
            @product_id VARCHAR(10),
            @area_id VARCHAR(10),
            @sub_area_id VARCHAR(10)

    SELECT
        @application_id = a.application_id,
        @product_id = p.product_id,
        @area_id = csa.area_id,
        @sub_area_id = csa.sub_area_id
    FROM
        dbo.catalog_selections_areas csa WITH (NOLOCK)
        JOIN dbo.Veo_applications a WITH (NOLOCK) ON a.name = csa.[application]
        JOIN dbo.Veo_products p WITH (NOLOCK) ON p.name = csa.product
    WHERE
        csa.session_id = @session_id
        AND csa.build_id = @build_id

    -- Now grab the bom modifications for this build
    SELECT
        csbm.id,
        csbm.session_id,
        @build_id AS build_id,
        csbm.application_id,
        csbm.product_id,
        csbm.area_id,
        csbm.sub_area_id,
        csbm.item_code,
        csbm.item,
        csbm.vendor,
        bbmt.id AS modification_type_id,
        bbmt.name AS modification_type_name,
        ISNULL(csabm.quantity, csbm.quantity) AS quantity,
        ISNULL(csabm.price, csbm.price) AS price,
        csbm.cost,
        ISNULL(csabm.notes, csbm.notes) AS notes,
        csbm.gpc,
        csbm.option_pricing_display,
        csbm.author,
        csbm.create_date,
        csbm.modifier,
        csbm.modified_date
    FROM
        dbo.catalog_selections_bom_modifications csbm WITH (NOLOCK)
        JOIN dbo.builder_bom_modification_types bbmt WITH (NOLOCK) ON bbmt.id = csbm.modification_type
        LEFT JOIN dbo.catalog_selections_area_bom_modifications csabm WITH (NOLOCK) ON csabm.session_id = csbm.session_id AND csabm.build_id = @build_id AND csabm.session_bom_modification_id = csbm.id
    WHERE
        csbm.session_id = @session_id
        AND ((csbm.application_id IS NULL) OR csbm.application_id = @application_id)
        AND ((csbm.product_id IS NULL) OR csbm.product_id = @product_id)
        AND ((csbm.area_id IS NULL) OR csbm.area_id = @area_id)
        AND ((csbm.sub_area_id IS NULL) OR csbm.sub_area_id = @sub_area_id)
    ORDER BY
        item
    
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuildBom]...';


GO
CREATE PROCEDURE dbo.vds_selBuildBom
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
	@security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 8/10/2015
    Description: Fetches the selected catalog_selections record for a specific build. 
        To determine the selected catalog_selections for a build, we must look for the
        selected field group in catalog_selections_areas.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Get the selected field group
    DECLARE @selected_field_group UNIQUEIDENTIFIER
    SELECT
        @selected_field_group = selected_field_group
    FROM
        dbo.catalog_selections_areas WITH (NOLOCK)
    WHERE
        session_id = @session_id
        AND build_id = @build_id

    -- Now fetch the catalog_selection record for this build and selected field group
    SELECT
        *
    FROM
        dbo.catalog_selections WITH (NOLOCK)
    WHERE
        session_id = @session_id
        AND row_id = @selected_field_group
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuildBomDetailOptions]...';


GO
CREATE PROCEDURE dbo.vds_selBuildBomDetailOptions
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
    @item_type VARCHAR(20),
    @item_id VARCHAR(50),
	@security_token UNIQUEIDENTIFIER    
AS
/*
    Author: Shelby Mansker
    Date: 8/10/2015
    Description: Returns all of the detail options for a specific detail line in a build's bom
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- First, we need to get the application, product, area, sub_area for this build.
    -- These values are part of the primary key for details.
    DECLARE @application VARCHAR(100)
    DECLARE @product VARCHAR(100)
    DECLARE @area VARCHAR(100)
    DECLARE @sub_area VARCHAR(100)
    SELECT
        @application = [application],
        @product = product,
        @area = area,
        @sub_area = sub_area
    FROM
        dbo.catalog_selections_areas WITH (NOLOCK)
    WHERE
        session_id = @session_id
        AND build_id = @build_id
        
    -- Fetch all of the detail options
    SELECT
        *
    FROM
        dbo.catalog_selections_area_detail_options WITH (NOLOCK)
    WHERE
        session_id = @session_id
        AND [application] = @application
        AND product = @product
        AND area = @area
        AND sub_area = @sub_area
        AND item_type = @item_type
        AND item_id = @item_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuildBomDetails]...';


GO
CREATE PROCEDURE dbo.vds_selBuildBomDetails
    @session_id UNIQUEIDENTIFIER,
    @build_id INT,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 8/10/2015
    Description: Fetches all of the bom details for a specific build.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- First, we need to get the application, product, area, sub_area for this build.
    -- These values are part of the primary key for details.
    DECLARE @application VARCHAR(100)
    DECLARE @product VARCHAR(100)
    DECLARE @area VARCHAR(100)
    DECLARE @sub_area VARCHAR(100)
    SELECT
        @application = [application],
        @product = product,
        @area = area,
        @sub_area = sub_area
    FROM
        dbo.catalog_selections_areas WITH (NOLOCK)
    WHERE
        session_id = @session_id
        AND build_id = @build_id

    -- Now fetch the details
    SELECT
        *
    FROM
        dbo.catalog_selections_area_details
    WHERE
        session_id = @session_id
        AND [application] = @application
        AND product = @product
        AND area = @area
        AND sub_area = @sub_area
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuildBomLines]...';


GO
CREATE PROCEDURE [dbo].[vds_selBuildBomLines]
    @session_id UNIQUEIDENTIFIER,
    @build_id INT,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 9/15/2015
    Description: Fetches all of the Bom lines and bom line options. It returns to result sets. The first result set
        is all of the bom lines. The second result set is all of the bom line options.

    EXEC vds_selBuildBomLines @session_id = 'af53226d-cf57-407b-9671-cc31103dab79', @build_id = 12229776, @security_token = '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- First, we need to get the application, product, area, sub_area for this build.
    -- These values are part of the primary key for details.
    DECLARE @application VARCHAR(100)
    DECLARE @product VARCHAR(100)
    DECLARE @area VARCHAR(100)
    DECLARE @sub_area VARCHAR(100)
    SELECT
        @application = [application],
        @product = product,
        @area = area,
        @sub_area = sub_area
    FROM
        dbo.catalog_selections_areas WITH (NOLOCK)
    WHERE
        session_id = @session_id
        AND build_id = @build_id

    -- Now return the details into the first result set
    SELECT
        *
    FROM
        dbo.catalog_selections_area_details WITH (NOLOCK)
    WHERE
        session_id = @session_id
        AND [application] = @application
        AND product = @product
        AND area = @area
        AND sub_area = @sub_area

    -- Next, return all of the options in the second result set
    SELECT
        *
    FROM
        dbo.catalog_selections_area_detail_options WITH (NOLOCK)
    WHERE
        session_id = @session_id
        AND [application] = @application
        AND product = @product
        AND area = @area
        AND sub_area = @sub_area

END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuilderBomModifications]...';


GO
CREATE PROCEDURE [dbo].[vds_selBuilderBomModifications]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 11/20/2015
    Description: Returns all of the bom modifications for a specific builder.
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Fetch all of the bom modification records for this account and organization
    SELECT
        bbm.id,
        bbm.account_id,
        bbm.organization_id,
        bbm.community,
        bbm.series,
        bbm.[plan],
        bbm.elevation,
        bbm.application_id,
        bbm.[application],
        bbm.product_id,
        bbm.product,
        bbm.area_id,
        bbm.area,
        bbm.sub_area_id,
        bbm.sub_area,
        bbm.item_code,
        bbm.item,
        bbm.vendor,
        bbm.quantity,
        bbm.price,
        bbm.cost,
        bbm.notes,
        bbm.gpc,
        bbm.option_pricing_display,
        bbm.author,
        bbm.create_date,
        bbm.modifier,
        bbm.modified_date,
        bbm.modification_type,
        bbmt.name AS modification_type_name
    FROM
        dbo.builder_bom_modifications bbm WITH (NOLOCK)
        JOIN dbo.builder_bom_modification_types bbmt WITH (NOLOCK) ON bbmt.id = bbm.modification_type
    WHERE
        bbm.account_id = @account_id
        AND bbm.organization_id = @organization_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuilderCatalogItems]...';


GO
CREATE PROCEDURE [dbo].[vds_selBuilderCatalogItems]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@community VARCHAR(100) = NULL,
	@series VARCHAR(100) = NULL,
	@plan VARCHAR(100) = NULL,
	@base_plan VARCHAR(100) = NULL,
	@application VARCHAR(100) = NULL,
	@product VARCHAR(100) = NULL,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 11/20/2015
	Description: Fetches all of the catalog items for the 

	Modifier: Roger Wang
	Date: 3/26/2019
	Description: Joins products from gpc to get finish

	Modifier: Shelby Mansker
	Date: 7/23/2020
	Description: Added Optional filters, in order to reduce the catalog items
		returned. Results can be filtered by Application and/or Product.

	Modifier: Roger Wang
	Date: 12/14/2020
	Description: Added Optional filters (community/series/plan), in order to reduce the catalog items
		returned. Results can be filtered by Application and/or Product.

	Modifier: Roger Wang
	Date: 6/3/2021
	Description: Improved performance by modifying the way to join to gpc to get finish.

	Modifier: Reid Wilson
	Date: 4/18/2023
	Description: Address-specific plans now return items from their base plan as well
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- return all of the catalog items for this builder
	SELECT
		*
		, CONVERT(VARCHAR(100), '') as finish
		, CAST(
			case when TRY_CONVERT(UNIQUEIDENTIFIER, gpc) IS NOT NULL
				then 1
				else 0
			end as bit
		) as has_valid_gpc
	INTO
		#catalog_items
	FROM
		dbo.catalog_items WITH (NOLOCK)
	WHERE
		account_id = @account_id
		AND organization_id = @organization_id
		AND (@community IS NULL OR community in ('All', @community))
		AND (@series IS NULL OR series in ('All', @series))
		AND (@plan IS NULL OR [plan] in ('All', @plan) OR ([plan] = @base_plan AND @base_plan IS NOT NULL))
		AND (@application IS NULL OR [application] = @application)
		AND (@product IS NULL OR product = @product)

	UPDATE
		ci
	SET
		finish = ISNULL(gp.finish, '')
	FROM
		#catalog_items ci
	INNER JOIN
		gpc_products gp ON gp.gpc_id = ci.gpc
	WHERE
		has_valid_gpc = 1

	ALTER TABLE #catalog_items DROP COLUMN has_valid_gpc

	SELECT * FROM #catalog_items

	IF OBJECT_ID('tempdb.dbo.#catalog_items') IS NOT NULL DROP TABLE #catalog_items
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuilderFeatureAudit]...';


GO
CREATE PROCEDURE [dbo].[vds_selBuilderFeatureAudit]
	@security_token UNIQUEIDENTIFIER,
	@feature_id int
AS
/*
	Modified: Roger Wang
	Date: 6/28/2021
	Description: Replaced the function that returns all builder features stored in organizations table with a view
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		o.organization_id,
		o.[name] AS [organization_name],
		f.[name] AS [feature_name],
		ISNULL(bf.[value], 0) AS [enabled]
	FROM
		VeoSolutionsSecurity_organizations o WITH (NOLOCK)
		LEFT JOIN builder_features bf ON bf.feature_id = @feature_id AND bf.organization_id = o.organization_id
		LEFT JOIN features f ON f.id = @feature_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuilderFeaturesForAllBuilders]...';


GO
CREATE PROCEDURE [dbo].[vds_selBuilderFeaturesForAllBuilders]
AS
/*
	Author: Roger Wang
	Create Date: 2/18/2019
	Description: Returns a list of builder features for all builders.
		If a feature has not been set it will default to 0.
*/
BEGIN
	declare @organizations table
	(
		account_id uniqueidentifier,
		account varchar(50),
		organization_id uniqueidentifier,
		builder_name varchar(50)
	)

	insert into
		@organizations
	select distinct
		ao.account_id,
		a.[name] as account,
		ao.organization_id,
		o.[name] as builder_name
	from
		VeoSolutionsSecurity_account_organizations ao
	inner join
		VeoSolutionsSecurity_accounts a on a.account_id = ao.account_id
	inner join
		VeoSolutionsSecurity_organizations o on o.organization_id = ao.organization_id

	select
		ao.account,
		ao.builder_name,
		f.[name] as feature,
		f.[description],
		ISNULL(bf.[value], 0) as selected
	from
		@organizations ao
		inner join features f on 1 = 1
		left join builder_features bf on bf.organization_id = ao.organization_id and bf.feature_id = f.id
	order by
		account, builder_name, feature
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuilderPatterns]...';


GO
CREATE PROCEDURE dbo.vds_selBuilderPatterns
	@account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER	
AS
/*
	Author: Shelby Mansker
	Date: 9/20/2016
	Description: Returns all of the patterns for a specific builder

	EXEC dbo.vds_selBuilderPatterns 'BAB32B7E-3ADA-497C-862E-E5083971CC59', '8AAECC3A-2D9E-4500-B0CF-D79D947D33A7', '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Fetch the Organization's external id
	DECLARE @external_organization_id VARCHAR(50)
	SELECT
		@external_organization_id = external_organization_id
	FROM
		VeoSolutionsSecurity_organizations
	WHERE
		organization_id = @organization_id

	-- Generate the customer's allowable pattern list
	DECLARE @customerPatterns TABLE 
	(
		pattern_id INT 
	)

	-- The patterns in the Veo_product_patterns_customers table represents patterns that the customer does NOT have access to
	INSERT INTO @customerPatterns
		SELECT pattern_id FROM Veo_product_patterns
		EXCEPT
		SELECT pattern_id FROM Veo_product_patterns_customers WHERE custnmbr = @external_organization_id

	-- The first result set contains all of the patterns
	SELECT DISTINCT
		pp.pattern_id,
	    pp.pattern_name,
		pp.active,
        pp.application_id,
        pp.product_id,
		( SELECT
			  COUNT(pav.line_no)
		  FROM
			  dbo.Veo_photo_attributes_values pav WITH (NOLOCK)
		  WHERE
			  pav.attribute_id = 6
			  AND LTRIM(pav.value) = LTRIM(STR(pp.pattern_id))
		) AS photo_count
	FROM
		@customerPatterns cp
		JOIN Veo_product_patterns pp WITH (NOLOCK) ON pp.pattern_id = cp.pattern_id

	-- The second result set contains all of the areas and sub areas that each pattern is used in (can be empty for some patterns)
	SELECT DISTINCT
		cp.pattern_id,
		ppa.area_id,
		ppa.sub_area_id
	FROM
		@customerPatterns cp
		JOIN Veo_product_patterns_areas ppa WITH (NOLOCK) ON ppa.pattern_id = cp.pattern_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuilderPlanBudgetValuesCommunityDefaults]...';


GO
CREATE PROCEDURE [dbo].[vds_selBuilderPlanBudgetValuesCommunityDefaults]
	@builder_id UNIQUEIDENTIFIER,
	@community_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 5/24/2019
	Description: Returns all of the community defaults for a specific builder and community
		that populate Monthly Payment Calculator.
*/
BEGIN
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		cd.*,
		n.[name]
	FROM
		[dbo].[builder_plan_budget_values_community_defaults] cd
	INNER JOIN
		[dbo].[plan_budget_values_names] n ON n.[id] = cd.[name_id]
	WHERE
		cd.[builder_id] = @builder_id
		AND cd.[community_id] = @community_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuilderPlanBudgetValuesSettings]...';


GO
CREATE PROCEDURE [dbo].[vds_selBuilderPlanBudgetValuesSettings]
	@builder_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 5/24/2019
	Description: Returns all of the available budget values for a specific builder
		that populate Monthly Payment Calculator.
*/
BEGIN
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		@builder_id as builder_id,
		n.[id] as name_id,
		n.[name],
		n.[data_type],
		n.[required],
		ISNULL(s.[enabled], n.[enabled_by_default]) as [enabled],
		n.[community_default],
		s.[author],
		s.[create_date],
		s.[modifier],
		s.[modified_date]
	FROM
		[dbo].[plan_budget_values_names] n
	LEFT JOIN
		[dbo].[builder_plan_budget_values_settings] s ON s.[name_id] = n.[id] AND s.[builder_id] = @builder_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuilders]...';


GO
CREATE PROCEDURE [dbo].[vds_selBuilders]
	@include_inactive BIT = 0,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:	Roger Wang
	Date:	05/30/2019
	Usage:	Retrieve all builders (account organizations)
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END	

	DECLARE @account_organizations TABLE
	(
		account_id UNIQUEIDENTIFIER,
		account_name VARCHAR(50),
		organization_id UNIQUEIDENTIFIER,
		organization_name VARCHAR(50),
		account_org_id UNIQUEIDENTIFIER,
		active BIT
	)

	INSERT INTO
		@account_organizations
	SELECT
		ao.account_id,
		a.[name] AS account_name,
		ao.organization_id,
		o.[name] AS organization_name,
		ao.account_org_id,
		active = CASE WHEN a.active = 1 AND o.active = 1 AND ao.active = 1 THEN 1 ELSE 0 END
	FROM
		VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK)
	INNER JOIN
		VeoSolutionsSecurity_accounts a WITH (NOLOCK) ON a.account_id = ao.account_id
	INNER JOIN
		VeoSolutionsSecurity_organizations o WITH (NOLOCK) ON o.organization_id = ao.organization_id

	IF @include_inactive = 0
	BEGIN
		DELETE FROM @account_organizations WHERE active = 0
	END

	SELECT * FROM @account_organizations
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuilderSelectionsPatternsReport]...';


GO
CREATE PROCEDURE [dbo].[vds_selBuilderSelectionsPatternsReport]
	@session_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS

/*
	Author:			Saul Sanchez
	Date:			02/16/2017
	Description:	Gets a session's selected patterns to display in the
					Build Selections Patterns Report.  This proc is based off
					of vs_rptSelectionsPatterns.

	Modifier:		Roger Wang
	Date:			5/18/2021
	Description:	Increase column length
*/

BEGIN

 -- Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

DECLARE @pattern_table TABLE
(
	[application] VARCHAR(100),
	area VARCHAR(100),
	sub_area VARCHAR(100),
	item_id_or_description VARCHAR(100),
	pattern_id INT,
	name VARCHAR(200),
	image_data VARBINARY(MAX),
	notes VARCHAR(MAX),
	sort_order INT,
	areas VARCHAR(MAX),
	area_sub_area VARCHAR(210),
	item_id VARCHAR(100),
	bom VARCHAR(MAX)
)

INSERT INTO @pattern_table (
	[application],
	area,
	sub_area,
	item_id_or_description,
	pattern_id,
	name,
	image_data,
	notes,
	sort_order,
	area_sub_area,
	item_id
	)
SELECT
	csa.[application],
	csa.area,
	csa.sub_area,
	'Pattern' AS item_id_or_description,
	csa.pattern_id,
	'' AS name,
	pp.[image_data],
	csa.notes,
	0 AS sort_order,
	csa.area +
		CASE LEN(RTRIM(csa.sub_area))
			WHEN 0 THEN ''
			ELSE ' / '
		END +
		csa.sub_area AS area_sub_area,
	'Pattern' as item_id
FROM
	catalog_selections_areas csa
	LEFT JOIN Veo_product_patterns pp
		ON pp.pattern_id = csa.pattern_id
WHERE
	csa.session_id = @session_id
	AND csa.area_selected = 1
	AND csa.selected != 0
	AND csa.pattern_id > 0
	AND csa.product <> 'CARPET'

UNION

SELECT
	csad.[application],
	csad.area,
	csad.sub_area,
	ISNULL(vpi.[description], csad.[item_id]) AS item_id_or_description,
	csa.pattern_id,
	ISNULL(col.name,'NO SELECTION !!! ') AS name,
	ppm.[image_data] AS material_image_data,
	ISNULL(csa.notes,'') +
		CASE LEN(ISNULL(csa.notes,''))
			WHEN 0 THEN ''
			ELSE CHAR(13) + CHAR(10)
		END +
		CASE LEN(ISNULL(csad.accent_prompt,''))
			WHEN 0 THEN ''
			ELSE 'Accent Size: ' + csad.accent_prompt
		END AS notes,
	CASE csad.item_id
		WHEN 'field' THEN 1
		WHEN 'grout' THEN 999
		ELSE 2
	END AS sort_order,
	csa.area +
		CASE LEN(RTRIM(csa.sub_area) )
			WHEN 0 THEN ''
			ELSE ' / '
		END +
		csa.sub_area AS area_sub_area,
	csad.item_id AS item_id
FROM
	catalog_selections_areas csa
	LEFT JOIN catalog_selections_area_details csad
		ON csa.session_id = csad.session_id
		AND csa.area = csad.area
		AND csa.[application] = csad.[application]
		AND csa.product = csad.product
	LEFT JOIN veo_applications va
		ON va.name = csad.[application]
	LEFT JOIN veo_products vp
		ON vp.name = csad.product
	LEFT JOIN Veo_product_patterns_material ppm
		ON csa.pattern_id = ppm.pattern_id
		AND csad.item_id = ppm.[item_id]
	LEFT JOIN Veo_colors col
		ON csad.real_item_id = col.part_no
	LEFT JOIN Veo_plan_items vpi
		ON vpi.application_id = va.application_id
		AND vpi.product_id = vp.product_id
		AND vpi.item_type = csad.item_type
		AND vpi.item_id = csad.item_id
WHERE
	csad.session_id = @session_id
	AND csa.area_selected = 1
	AND csa.selected != 0
	AND csad.selectable != 0
	AND csa.pattern_id > 0
	AND csa.product <> 'CARPET'


DECLARE @done BIT = 0

DECLARE @area_sub_area VARCHAR(MAX)
DECLARE @bom VARCHAR(MAX) = ''

-- first, build the selected BOM for an unprocessed area / sub area
WHILE @done = 0
BEGIN
	SELECT TOP 1
		@area_sub_area = area_sub_area
	FROM
		@pattern_table
	WHERE
		bom IS NULL

	SET @bom = ''

	SELECT
		@bom = @bom +
			CAST(pattern_id AS VARCHAR(10)) +
			item_id +
			name
	FROM
		@pattern_table
	WHERE
		area_sub_area = @area_sub_area
	ORDER BY
		item_id

	UPDATE @pattern_table
	SET
		bom = @bom
	WHERE
		area_sub_area = @area_sub_area

	IF EXISTS ( SELECT name FROM @pattern_table WHERE bom IS NULL)
		SET @done = 0
	ELSE
		SET @done = 1
end

-- now there is a basis for comparison between area/sub areas (+ notes)
-- select a concatenation of the area_sub_area where the BOMs are the same
SET @done = 0
WHILE @done = 0
BEGIN
	SELECT TOP 1
		@bom = bom
	FROM
		@pattern_table
	WHERE
		areas IS NULL

	SET @area_sub_area = ''

	SELECT
		@area_sub_area = @area_sub_area + area_sub_area + '; '
	FROM
		@pattern_table
	WHERE
		bom = @bom
		AND item_id = 'pattern'

	UPDATE
		@pattern_table
	SET
		areas = @area_sub_area
	WHERE
		bom = @bom

	IF EXISTS (SELECT name FROM @pattern_table WHERE areas IS NULL)
		SET @done = 0
	ELSE
		SET @done = 1
END


-- final select
SELECT
	[application],
	area,
	sub_area,
	item_id_or_description,
	pattern_id,
	name,
	image_data,
	notes,
	sort_order,
	CASE
		WHEN LEN(areas) > 0
		THEN SUBSTRING(areas, 1, LEN(areas)-1)
		ELSE ''
	END AS areas
FROM
	@pattern_table
WHERE
	areas LIKE area + ';%'
	AND image_data IS NOT NULL
ORDER BY
	area,
	sub_area,
	sort_order

END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuilderUsers]...';


GO
CREATE PROCEDURE [dbo].[vds_selBuilderUsers]
@account_id uniqueidentifier, 
@organization_id uniqueidentifier, 
@security_token uniqueidentifier 
AS

/*
    Author: Rob Hobbs
    Date: 09/28/16
    Description: Returns two result sets: 
	- all users for the account/org 
	- all roles for each user 

	Modified: Shelby Mansker
	Date: 2/15/2017
	Description: Instead of returning fields from the user table, it now returns fields from the builders user table.
		This is to make it consistent with the other stored procedures that return account organization users. I also
		expanded the fields used, so that I had more control over what gets returned. For example, the audit fields
		being returned in the second result set are for the user role, instead of the roles (as was the case previously).
*/

/* 
	TESTING 
	
	vds_selBuilderUsers 'BAB32B7E-3ADA-497C-862E-E5083971CC59', '8AAECC3A-2D9E-4500-B0CF-D79D947D33A7', '01234567-89AB-CDEF-0000-123456789ABC'  
	vds_selBuilderUsers 'bab32b7e-3ada-497c-862e-e5083971cc59','8AAECC3A-2D9E-4500-B0CF-D79D947D33A7', '74daf1f0-9c52-4e02-8a95-235bf42e3f4e'
*/

BEGIN 
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- USERS 
	SELECT
        org_users.account_id,
		org_users.organization_id,
		org_users.[user_id],
		org_users.first_name,
		org_users.last_name,
		u.email,
		org_users.active,
		org_users.external_id,
		org_users.author,
		org_users.create_date,
		org_users.modifier,
		org_users.modified_date,
		org_users.stamp      
    FROM
        VeoSolutionsSecurity_users u WITH (NOLOCK)
        JOIN VeoSolutionsSecurity_account_organization_users org_users WITH (NOLOCK) ON org_users.[user_id] = u.[user_id]
		JOIN VeoSolutionsSecurity_account_organization_users_roles_legacy user_roles ON user_roles.account_id = org_users.account_id AND user_roles.organization_id = org_users.organization_id AND user_roles.[user_id] = org_users.[user_id]
		JOIN VeoSolutionsSecurity_roles_legacy roles on roles.role_id = user_roles.role_id 
    WHERE
        org_users.account_id = @account_id
        AND org_users.organization_id = @organization_id
        AND org_users.active = 1
        AND u.active = 1
		      
	-- USER ROLES 
	SELECT
		org_users.account_id,
		org_users.organization_id,
        u.[user_id], 
		roles.role_id,
		roles.name,
		roles.numeric_role_id,
		roles.alpha_role_id,
		user_roles.author,
		user_roles.create_date,
		user_roles.modifier,
		user_roles.modified_date,
		user_roles.stamp
    FROM
		VeoSolutionsSecurity_users u WITH (NOLOCK)
        JOIN VeoSolutionsSecurity_account_organization_users org_users WITH (NOLOCK) ON org_users.[user_id] = u.[user_id]
		JOIN VeoSolutionsSecurity_account_organization_users_roles_legacy user_roles ON user_roles.account_id = org_users.account_id AND user_roles.organization_id = org_users.organization_id AND user_roles.[user_id] = org_users.[user_id]
		JOIN VeoSolutionsSecurity_roles_legacy roles on roles.role_id = user_roles.role_id 
      WHERE
        org_users.account_id = @account_id
        AND org_users.organization_id = @organization_id
        AND org_users.active = 1
        AND u.active = 1

END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuildFieldsForCopy]...';


GO
CREATE proc [dbo].[vds_selBuildFieldsForCopy]
	@session_id uniqueidentifier,
	@build_id int,
	@security_token uniqueidentifier
as

/* 
	Author:		Scott Friend
	Create date: May 28, 2013
	Description:	Get fields needed for copy (or apply to other areas) logic that is managed in respository
  
*/

BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	select 
		csa.selected_field_group,
		cs.item_no,
		csa.selected,
		csa.pattern_id,
		aocs.organization_id,
		o.rounding_places,
		o.rounding_type

	from catalog_selections cs with (nolock)
	join catalog_selections_areas csa with (nolock)
		on cs.session_id = csa.session_id
		and cs.row_id = csa.selected_field_group
	join account_organization_user_profile_plan_catalog_sessions aocs with (nolock) on aocs.session_id = cs.session_id
	join vss_organizations o with (nolock) on o.organization_id = aocs.organization_id

	where cs.session_id = @session_id
		and csa.build_id =	@build_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuildInformation]...';


GO
CREATE PROCEDURE [dbo].[vds_selBuildInformation]
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
	@security_token UNIQUEIDENTIFIER = NULL
AS
/*
	Author:		Shelby Mansker
	Create date: 5/2/2014
	Description:	Returns information about the requested build.

    Updated 12/18/2014 Return the selected field item type, item number, and item description
            that correspond with the selected field group. Saul.
*/
BEGIN
    --DECLARE @session_id UNIQUEIDENTIFIER = '4dd71a5a-9ea3-4d91-8a2b-e5a33da5b401'
    --DECLARE @build_id INT = 11875062

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		csa.[application],
		csa.product,
		csa.area,
		csa.sub_area,
		csa.area_id,
		csa.sub_area_id,
		csa.selected,
		csa.notes,
		csa.selection_total,
		csa.selected_field_group,
		csa.pattern_id,
		csa.area_selected,
        (SELECT TOP 1
            is_credit
         FROM
            dbo.catalog_selections WITH (NOLOCK)
         WHERE
            session_id = @session_id
            AND [application] = csa.[application]
            AND product = csa.product
            AND area = csa.area
            AND sub_area = csa.sub_area
            AND RTRIM(item) <> 'custom'
            AND item NOT LIKE '%pad%'
        ) AS is_credit,
        cs.item_type AS selected_field_item_type,
        cs.item_no AS selected_field_item_no,
        cs.item AS selected_field_item
	FROM
		dbo.catalog_selections_areas csa WITH (NOLOCK)
        left join dbo.catalog_selections cs WITH (NOLOCK) on cs.session_id = csa.session_id and cs.row_id = csa.selected_field_group
	WHERE
		csa.session_id = @session_id
		AND csa.build_id = @build_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuildItemClass]...';


GO
CREATE PROCEDURE dbo.vds_selBuildItemClass
    @session_id UNIQUEIDENTIFIER,
    @build_id INT,
    @item_type VARCHAR(20),
    @item_id VARCHAR(50),
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 8/21/2015
    Description: Fetches the item class for a specific item in a build, based
        on its item type and item id.

    vds_selBuildItemClass 'a73ce653-cd78-4a91-9d43-d195cfd0ad0f', 12039590, 'material', 'grout', 'c9916383-3887-456e-b81b-fe12e15e322a'
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    --Validate the security token
    IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Now fetch the passed in item_id's item class from plan items
    SELECT TOP 1
        [pi].class_id AS item_class
    FROM
        catalog_selections_areas cs WITH (NOLOCK)
        JOIN Veo_applications a WITH (NOLOCK) ON a.name = cs.[application]
        JOIN Veo_products p WITH (NOLOCK) ON p.name = cs.product
        JOIN Veo_plan_items [pi] WITH (NOLOCK) ON [pi].application_id = a.application_id AND [pi].product_id = p.product_id AND [pi].item_type = @item_type AND [pi].item_id = @item_id
    WHERE
        cs.session_id = @session_id
        AND cs.build_id = @build_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuildPatternBomLines]...';


GO
CREATE PROCEDURE dbo.vds_selBuildPatternBomLines
	@pattern_id INT,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 9/20/2015
    Description: Fetches all of the related material and labor lines for the specified pattern id.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Fetch all of the material and labor lines for this pattern
    SELECT 
		ppm.item_type,
		ppm.item_id,
		ppm.area_percentage AS pattern_percentage, 
        '' AS real_item_id,
		[pi].hb_selection_display AS selectable,
		[pi].uom_id,
		[pi].class_id
	FROM 
		Veo_plan_items [pi] WITH (NOLOCK)
	    JOIN Veo_product_patterns_material ppm WITH (NOLOCK) ON ppm.application_id = [pi].application_id AND ppm.product_id = [pi].product_id AND ppm.item_type = [pi].item_type AND ppm.item_id = [pi].item_id
    WHERE
		ppm.pattern_id = @pattern_id

    UNION

	SELECT 
		ppl.item_type,
		ppl.item_id,
		1 AS pattern_percentage, 
		ppl.labor_code AS real_item_id,
		[pi].hb_selection_display AS selectable,
		[pi].uom_id,
		[pi].class_id
	FROM 
		Veo_plan_items [pi] WITH (NOLOCK)
	    JOIN Veo_product_patterns_labor ppl WITH (NOLOCK) ON ppl.application_id = [pi].application_id AND ppl.product_id = [pi].product_id AND ppl.item_type = [pi].item_type AND ppl.item_id = [pi].item_id
	WHERE
        ppl.pattern_id = @pattern_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuildPatternCharge]...';


GO


CREATE procedure [dbo].[vds_selBuildPatternCharge]
@session_id uniqueidentifier,
@build_id int,
@security_token UNIQUEIDENTIFIER
as

/*



*/

--Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END  


declare @has_pattern_charge int
declare @restore_pattern int


select @has_pattern_charge =  count(*)

from catalog_selections_areas ca with (nolock)
left join catalog_selections_area_details cad with (nolock) on 
	cad.session_id = ca.session_id 
	and cad.application = ca.application
	and cad.product = ca.product
	and cad.area = ca.area
	and cad.sub_area = ca.sub_area

left join veo_labor_codes lc with (nolock) on lc.code = cad.real_item_id

where ca.session_id = @session_id 
and ca.build_id = @build_id
--and cad.real_item_id like 'pat%'
and lc.description like '%pattern%'
and cad.homeowner_price > 0



select @restore_pattern = count(*)

from catalog_selections_areas ca
left join catalog_selections_area_details cad on 
cad.session_id = ca.session_id 
and cad.application = ca.application
and cad.product = ca.product
and cad.area = ca.area
and cad.sub_area = ca.sub_area
left join veo_labor_codes lc with (nolock) on lc.code = cad.real_item_id

where ca.session_id = @session_id 
and ca.build_id = @build_id
--and cad.real_item_id like 'pat%'
and lc.description like '%pattern%'
and bill_qty <> bom_bill_qty


select  @has_pattern_charge as has_pattern_charge, @restore_pattern as restore_pattern
GO
PRINT N'Creating Procedure [dbo].[vds_selBuildPriceLevel]...';


GO
CREATE PROCEDURE [dbo].[vds_selBuildPriceLevel]
    @session_id UNIQUEIDENTIFIER,
    @build_id INT,
    @price_level_id VARCHAR(100),
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 8/10/2015
    Description: Fetches a build's price level header record from the catalog_selections
        table.

    Modified: Shelby Mansker
    Date: 8/25/2015
    Description: Removed item type check for 'group'. Price Level item types can be 'group',
        'custom', 'style', or 'color'. Therefore, we should only limit the search to 
        catalog selections with a source of prices landed.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Fetch the matching catalog selection record
    SELECT TOP 1
        *
    FROM
        dbo.catalog_selections WITH (NOLOCK)
    WHERE
        session_id = @session_id
        AND build_id = @build_id
        AND [source] = 'Prices Landed'
        AND item_no = @price_level_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuildPriceLevelBom]...';


GO
CREATE PROCEDURE [dbo].[vds_selBuildPriceLevelBom]
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
	@item_no VARCHAR(100),
	@security_token UNIQUEIDENTIFIER = NULL
AS
/*
	Author:		Shelby Mansker
	Create date: 5/2/2014
	Description:	Returns the encoded BOM for the specified build's pricing level.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Get the application, product, area, and sub area for the specified build
	DECLARE @application VARCHAR(50)
	DECLARE @product VARCHAR(50)
	DECLARE @area VARCHAR(100)
	DECLARE @sub_area VARCHAR(50)
	
	-- Determine the application, product, area, and subarea from the session id and build id
	SELECT
		@application = [application],
		@product = product,
		@area = area,
		@sub_area = sub_area
	FROM
		dbo.catalog_selections_areas WITH (NOLOCK)
	WHERE
		session_id = @session_id
		AND build_id = @build_id

	-- Return the encoded bom data
	SELECT
		build_data
	FROM
		dbo.catalog_selections WITH (NOLOCK)
	WHERE
		session_id = @session_id
		AND [application] = @application
		AND product = @product
		AND area = @area
		AND sub_area = @sub_area
		AND item_no = @item_no
		AND [source] = 'Prices Landed'	
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuilds]...';


GO
CREATE PROCEDURE vds_selBuilds
	@session_id UNIQUEIDENTIFIER,
	@area VARCHAR(100) = '',
	@sub_area VARCHAR(100) = '',
	@application VARCHAR(100) = '',
	@build_id INT = 0,
	@only_with_selections BIT = 0,
	@builder_overrides_enabled BIT = 0,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 9/12/2017
	Description: Returns multiple result sets, representing one or more builds. There are several optional
		parameters, which can be used to filter the results down. Also, added the name of the person to
		last modify each bom line.

	Modified: Shelby Mansker
	Date: 9/29/2017
	Description: Fixed an issue where the query was running slow on SQL Server 2016. The color join was causing the
		second result set to run really slow. It was asking for an index to be added to the VEO.dbo.colors table, which
		was based off the part_no and included the name. When I moved the colors join to the top of the LEFT JOINs, it worked instead.

	Modified: Saul Sanchez
	Date: 07/18/2018
	Description: Added a parameter for returning only builds that have selections.

	Modified: Shelby Mansker
	Date: 10/19/2018
	Description: Added area and sub-area information to the first result set. This area information is essentially the area and sub-area ids and their 
		names, from veo. The build and bom both contain area and sub-area, but these are actually a mix between build descriptions and area/subAreas.
		While a build always has the area and sub area ids, they didn't always have the area and sub-area names, so this change adds those values.
		The new result columns are positioned so that they can be lumped together into a separate object, using Insight DB. Basically, the first
		result set now represents the data for three objects: The Build, the Area Information for the Build, and a Price Level.

	Modified: Reid Wilson
	Date: 9/25/2023
	Description: Return builder override part name for bomlines.
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- grab the external organization id for use in picking up builder part overrides
	declare @external_organization_id varchar(20)

	select
		@external_organization_id = external_organization_id
	from
		account_organization_user_profile_plan_catalog_sessions aouppcs WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) ON o.organization_id = aouppcs.organization_id
	where
		aouppcs.session_id = @session_id

	-- Fetch all of the Builds and their selected price level, if they have one
	SELECT
		csa.*,
		a.application_id,
		p.product_id,
		dbo.vdsf_isCreditArea(csa.session_id, csa.[application], csa.product, csa.area, csa.sub_area) AS is_credit_build,
		ISNULL(pa.is_std_product, 0) AS is_standard_product,
		areas.area_id,
		areas.[name] AS area_name,
		sub_areas.sub_area_id,
		sub_areas.[name] AS sub_area_name,
		cs.*
	FROM
		dbo.catalog_selections_areas csa WITH (NOLOCK)
		JOIN dbo.Veo_applications a WITH (NOLOCK) ON a.name = csa.[application]
		JOIN dbo.Veo_products p WITH (NOLOCK) ON p.name = csa.product
		LEFT JOIN dbo.Veo_areas areas WITH (NOLOCK) ON areas.area_id = csa.area_id
		LEFT JOIN dbo.Veo_sub_areas sub_areas WITH (NOLOCK) ON sub_areas.sub_area_id = csa.sub_area_id
		LEFT JOIN dbo.Veo_plan_builds pb WITH (NOLOCK) ON pb.build_id_num = csa.build_id
		LEFT JOIN dbo.Veo_plan_areas pa WITH (NOLOCK) ON 
			pa.plan_id = pb.plan_id 
			AND pa.application_id = pb.application_id 
			AND pa.product_id = pb.product_id 
			AND pa.area_id = pb.area_id 
			AND pa.sub_area_id = pb.sub_area_id 
			AND pa.location_id = pb.location_id
			AND pa.is_std_area = pb.is_std_area
		LEFT JOIN dbo.catalog_selections cs WITH (NOLOCK) ON cs.session_id = csa.session_id AND cs.row_id = csa.selected_field_group
	WHERE 
		csa.session_id = @session_id
		AND ((@area = '') OR (csa.area = @area))
		AND ((@sub_area = '') OR (csa.sub_area = @sub_area))
		AND ((@application = '') OR (csa.[application] = @application))
		AND ((@build_id = 0) OR (csa.build_id = @build_id))
		AND ((@only_with_selections = 0) OR (csa.selected > 0))
	ORDER BY
		csa.[application],
		csa.product,
		csa.area,
		csa.sub_area,
		csa.build_id

	-- Fetch all of the bom lines for each build's bom
	SELECT
		csad.*,
		ISNULL(vpi.[description], '') as item_description,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else ISNULL(ISNULL(c.name, lc.[description]), '')
		end as real_item_description,
		c.color_id as real_item_color_id,
		vpi.class_id AS item_class, 
		patterns.pattern_name,
		CONCAT(u.first_name, ' ', u.last_name) AS last_modified_by,
		csadl.rotate_degree,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.customer_reference_no) > 0)
				then (cco.customer_reference_no)
			else NULL
		end as builder_override_part_id
	FROM
		dbo.catalog_selections_areas csa WITH (NOLOCK)
		JOIN dbo.catalog_selections_area_details csad WITH (NOLOCK) ON csad.session_id = csa.session_id AND csad.[application] = csa.[application] AND csad.product = csa.product AND csad.area = csa.area AND csad.sub_area = csa.sub_area
		LEFT JOIN dbo.catalog_selections_area_details_lay_directions csadl WITH (NOLOCK)
			ON csadl.session_id = csad.session_id
			AND csadl.[application] = csad.[application]
			AND csadl.product = csad.product
			AND csadl.area = csad.area
			AND csadl.sub_area = csad.sub_area
			AND csadl.[item_type] = csad.[item_type]
			AND csadl.[item_id] = csad.[item_id]
		LEFT JOIN Veo_colors c WITH (NOLOCK)
			ON c.part_no = csad.real_item_id
		LEFT JOIN Veo_labor_codes lc WITH (NOLOCK)
			ON lc.code = csad.real_item_id
		LEFT JOIN veo_product_patterns patterns WITH (NOLOCK) 
			ON patterns.pattern_id = csad.pattern_id
		LEFT JOIN VeoSolutionsSecurity_users u WITH (NOLOCK)
			ON u.email = csad.modifier
		LEFT JOIN Veo_applications a WITH (NOLOCK)
			ON a.[name] = csad.[application]
		LEFT JOIN Veo_products p WITH (NOLOCK)
			ON p.[name] = csad.product
		LEFT JOIN Veo_plan_items vpi WITH (NOLOCK)
			ON vpi.application_id = a.application_id
			AND vpi.product_id = p.product_id
			AND vpi.item_type = csad.item_type
			AND vpi.item_id = csad.item_id
		LEFT JOIN veo_colors_customer_overrides cco WITH (NOLOCK)
			ON cco.part_no = c.part_no
			AND cco.customer_id = @external_organization_id
	WHERE 
		csa.session_id = @session_id
		AND ((@area = '') OR (csa.area = @area))
		AND ((@sub_area = '') OR (csa.sub_area = @sub_area))
		AND ((@application = '') OR (csa.[application] = @application))
		AND ((@build_id = 0) OR (csa.build_id = @build_id))
		AND ((@only_with_selections = 0) OR (csa.selected > 0))
	ORDER BY
		csa.[application],
		csa.product,
		csa.area,
		csa.sub_area,
		csa.build_id

	-- Fetch all of the bom line options for each bom line
	SELECT
		csado.*
	FROM
		dbo.catalog_selections_areas csa WITH (NOLOCK)
		JOIN dbo.catalog_selections_area_detail_options csado WITH (NOLOCK) ON csado.session_id = csa.session_id AND csado.[application] = csa.[application] AND csado.product = csa.product AND csado.area = csa.area AND csado.sub_area = csa.sub_area
	WHERE 
		csa.session_id = @session_id
		AND ((@area = '') OR (csa.area = @area))
		AND ((@sub_area = '') OR (csa.sub_area = @sub_area))
		AND ((@application = '') OR (csa.[application] = @application))
		AND ((@build_id = 0) OR (csa.build_id = @build_id))
		AND ((@only_with_selections = 0) OR (csa.selected > 0))
	ORDER BY
		csa.[application],
		csa.product,
		csa.area,
		csa.sub_area,
		csa.build_id

	-- Now fetch all of the bom modifications for this build
	SELECT
		csbm.id,
		csbm.session_id,
		csabm.build_id,
		csbm.application_id,
		csbm.product_id,
		csbm.area_id,
		csbm.sub_area_id,
		csbm.item_code,
		csbm.item,
		csbm.vendor,
		bbmt.id AS modification_type_id,
		bbmt.name AS modification_type_name,
		csabm.quantity,
		csabm.price,
		csbm.cost,
		csabm.notes,
		csbm.gpc,
		csbm.option_pricing_display,
		csabm.author,
		csabm.create_date,
		csabm.modifier,
		csabm.modified_date
	FROM
		dbo.catalog_selections_areas csa WITH (NOLOCK)
		JOIN dbo.catalog_selections_area_bom_modifications csabm WITH (NOLOCK) ON csabm.build_id = csa.build_id
		JOIN dbo.catalog_selections_bom_modifications csbm WITH (NOLOCK) ON csbm.id = csabm.session_bom_modification_id
		JOIN dbo.builder_bom_modification_types bbmt WITh (NOLOCK) ON bbmt.id = csbm.modification_type 
	WHERE
		csa.session_id = @session_id
		AND ((@area = '') OR (csa.area = @area))
		AND ((@sub_area = '') OR (csa.sub_area = @sub_area))
		AND ((@application = '') OR (csa.[application] = @application))
		AND ((@build_id = 0) OR (csa.build_id = @build_id))
		AND ((@only_with_selections = 0) OR (csa.selected > 0))
	ORDER BY
		csa.[application],
		csa.product,
		csa.area,
		csa.sub_area,
		csa.build_id

	-- Now Fetch all of the Selected Slabs for the Builds in this session
	SELECT
		csas.row_id,
		csas.session_id,
		csas.build_id,
		csas.slab_id
	FROM
		dbo.catalog_selections_areas csa WITH (NOLOCK)
		JOIN dbo.catalog_selections_area_slabs csas WITH (NOLOCK) ON csas.session_id = csa.session_id AND csas.build_id = csa.build_id
	WHERE
		csa.session_id = @session_id
		AND ((@area = '') OR (csa.area = @area))
		AND ((@sub_area = '') OR (csa.sub_area = @sub_area))
		AND ((@application = '') OR (csa.[application] = @application))
		AND ((@build_id = 0) OR (csa.build_id = @build_id))
		AND ((@only_with_selections = 0) OR (csa.selected > 0))
	ORDER BY
		csa.[application],
		csa.product,
		csa.area,
		csa.sub_area,
		csa.build_id

	-- Fetch all of the price levels
	SELECT
		cs.*,
		a.application_id,
		p.product_id,
		areas.area_id,
		areas.[name] AS area_name,
		sub_areas.sub_area_id,
		sub_areas.[name] AS sub_area_name
	FROM
		dbo.catalog_selections cs WITH (NOLOCK)
		JOIN dbo.Veo_applications a WITH (NOLOCK) ON a.name = cs.[application]
		JOIN dbo.Veo_products p WITH (NOLOCK) ON p.name = cs.product
		LEFT JOIN dbo.Veo_areas areas WITH (NOLOCK) ON areas.area_id = cs.area_id
		LEFT JOIN dbo.Veo_sub_areas sub_areas WITH (NOLOCK) ON sub_areas.sub_area_id = cs.sub_area_id
		LEFT JOIN dbo.Veo_plan_builds pb WITH (NOLOCK) ON pb.build_id_num = cs.build_id
	WHERE 
		cs.session_id = @session_id
		AND cs.source = 'Prices Landed'
		AND ((@area = '') OR (cs.area = @area))
		AND ((@sub_area = '') OR (cs.sub_area = @sub_area))
		AND ((@application = '') OR (cs.[application] = @application))
		AND ((@build_id = 0) OR (cs.build_id = @build_id))
	ORDER BY
		cs.[application],
		cs.product,
		cs.area,
		cs.sub_area,
		cs.build_id

	-- Fetch the area properties
	SELECT 
		csap.[id],
		csap.[session_id], 
		csap.[build_id], 
		csap.[key], 
		csap.[value], 
		csap.[author] ,
		csap.[create_date],
		csap.[modifier],
		csap.[modified_date]
	FROM
		catalog_selections_area_properties csap WITH (NOLOCK)
		JOIN dbo.catalog_selections_areas csa WITH (NOLOCK) ON csa.session_id = csap.session_id AND csa.build_id = csap.build_id
	WHERE
		csa.session_id = @session_id
		AND ((@area = '') OR (csa.area = @area))
		AND ((@sub_area = '') OR (csa.sub_area = @sub_area))
		AND ((@application = '') OR (csa.[application] = @application))
		AND ((@build_id = 0) OR (csa.build_id = @build_id))
		AND ((@only_with_selections = 0) OR (csa.selected > 0))
	ORDER BY
		csa.[application],
		csa.product,
		csa.area,
		csa.sub_area,
		csa.build_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selBuildSelectedInOtherArea]...';


GO
CREATE PROCEDURE [dbo].[vds_selBuildSelectedInOtherArea]
	@session_id UNIQUEIDENTIFIER,
	@application VARCHAR(100),
    @product VARCHAR(100),
    @area VARCHAR(100) = '',
    @sub_area VARCHAR(100) = '',
    @is_credit BIT,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:		 Saul Sanchez
	Create date: 08/15/2014
	Description: Returns information about the build selected in the other area.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	SELECT
		csa.[application],
		csa.product,
		csa.area,
		csa.sub_area,
		csa.area_id,
		csa.sub_area_id,
        csa.build_id,
		csa.selected,
		csa.notes,
		csa.selection_total,
		csa.selected_field_group,
		csa.pattern_id,
		csa.area_selected,
        dbo.vdsf_isCreditArea(@session_id, csa.[application], csa.product, csa.area, csa.sub_area) as is_credit
	FROM
		dbo.catalog_selections_areas csa WITH (NOLOCK)
	WHERE
		session_id = @session_id
		AND csa.[application] = @application
        AND csa.area = @area
        AND csa.sub_area = @sub_area
        AND dbo.vdsf_isCreditArea(@session_id, csa.[application], csa.product, csa.area, csa.sub_area) = @is_credit
        AND csa.selected > 0

END
GO
PRINT N'Creating Procedure [dbo].[vds_selCabinetColorsImage]...';


GO
CREATE PROCEDURE [dbo].[vds_selCabinetColorsImage]
	@color_id VARCHAR(10)
AS
BEGIN
    SELECT
        image_data
    FROM
        dbo.Veo_cabinet_colors
    WHERE
        color_id = @color_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selCabinetDoorPanelsImage]...';


GO
CREATE PROCEDURE [dbo].[vds_selCabinetDoorPanelsImage]
	@panel_id VARCHAR(10)
AS
BEGIN
    SELECT
        image_data
    FROM
        dbo.Veo_cabinet_door_panels
    WHERE
        panel_id = @panel_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selCabinetDoorStylesImage]...';


GO
CREATE PROCEDURE [dbo].[vds_selCabinetDoorStylesImage]
	@style_id VARCHAR(10)
AS
BEGIN
    SELECT
        image_data
    FROM
        dbo.Veo_cabinet_door_styles
    WHERE
        style_id = @style_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selCabinetSpeciesImage]...';


GO
CREATE PROCEDURE [dbo].[vds_selCabinetSpeciesImage]
	@species_id VARCHAR(10)
AS
BEGIN
    SELECT
        image_data
    FROM
        dbo.Veo_cabinet_species
    WHERE
        species_id = @species_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selCatalogAreasBySessionID]...';


GO

create procedure [dbo].[vds_selCatalogAreasBySessionID]
@session_id uniqueidentifier,
@security_token UNIQUEIDENTIFIER

as

-- Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

select 
	*,
	a.name as area_name,
	sa.name as sub_area_name
from catalog_selections_areas csa with (nolock) 
left join veo_areas a with (nolock) on a.area_id = csa.area_id
left join veo_sub_areas sa with (nolock) on sa.sub_area_id = csa.sub_area_id

where csa.session_id = @session_id

order by area_name,sub_area_name,application,product
GO
PRINT N'Creating Procedure [dbo].[vds_selCatalogItemDocs]...';


GO
CREATE procedure [dbo].[vds_selCatalogItemDocs]
@security_token uniqueidentifier,
@gpc_id	uniqueidentifier

as

/* 
	
	Show a list of GPC documents related to the GPC Product ID 
	
	History: 
	added is_default to the select for catalog product documents - RH 

	[vds_selCatalogItemDocs]
	select top 10 * from gpc_products_documents
	"4797ac82-d299-4d98-a0dd-ae47fa3c29db"

*/

IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

select 
	gpc.doc_id, 
	gpc.doc_type, 
	gpc.doc_name, 
	gpc.is_default
from 
	gpc_products_documents gpc with (nolock)
where 
	gpc_id = @gpc_id
GO
PRINT N'Creating Procedure [dbo].[vds_selCatalogItemsByType]...';


GO
create procedure vds_selCatalogItemsByType

@session_id uniqueidentifier,
@catalog_type varchar(40),
@security_token UNIQUEIDENTIFIER


as

/*
	Author:			Adrian Garza
	Create date:	3/4/2015
	Description:	select bom line options
		

*/

-- Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END


if @catalog_type = 'catalog'
begin
	SELECT * FROM dbo.catalog_selections WITH (NOLOCK) WHERE session_id = @session_id AND source <> 'Prices Landed'
end
else
begin
	SELECT * FROM dbo.catalog_selections WITH (NOLOCK) WHERE session_id = @session_id AND source = 'Prices Landed'
end
GO
PRINT N'Creating Procedure [dbo].[vds_selCatalogOptionPricingItemsForSession]...';


GO
CREATE PROCEDURE [dbo].[vds_selCatalogOptionPricingItemsForSession]
@session_id UNIQUEIDENTIFIER,
@application VARCHAR(100),
@product VARCHAR(100) = '',
@security_token UNIQUEIDENTIFIER
AS
/*
    Author: Saul Sanchez
    Create Date: 8/20/2015
    Description: Fetches catalog option pricing items for the specified session.

	Modified: 12/12/2016 by Saul Sanchez
		Return quantity with the rest of the data.

	Modified: 09/12/2017 by Robert Hobbs 
		Added Distinct to deal with duplicate data in dev. 

	Modified: 02/21/2019 by Roger Wang
		Modified the parameter length to match the table

*/
BEGIN
    -- Validate the security token
    IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
    BEGIN
	    RAISERROR('Access Denied.',16,1)
	    RETURN
    END

    SELECT
		DISTINCT 
        a.application_id,
        RTRIM(LTRIM(cs.[application])) as [application],
        p.product_id,
        RTRIM(LTRIM(cs.product)) as product,
        cs.[source],
        cs.area,
        cs.sub_area,
        0 as location_id,
        cs.item_type,
        cs.item_no,
        cs.item,
		cs.qty,
        ISNULL(cs.price, 0) as price,
        cs.gpc, 
        gpc_doc_count = (select count(*) from gpc_products_documents with (nolock) where gpc_id = try_convert(uniqueidentifier,cs.gpc)),
        cs.option_pricing_display,
        s.spec_id,
        s.effective_date,
        ISNULL(bs.contract_sort_order, 9999999) AS contract_sort_order
    FROM 
	    catalog_selections cs with (nolock)
	    LEFT JOIN veo_areas va with (nolock) on va.area_id = cs.area_id
	    LEFT JOIN Veo_applications a with (nolock) on a.name = cs.[application]
	    LEFT JOIN Veo_products p with (nolock) on p.name = cs.product
	    LEFT JOIN account_organization_user_profile_plan_catalog_sessions s with (nolock) on s.session_id = cs.session_id
	    LEFT JOIN Veo_builder_styles bs with (nolock)
		    ON bs.spec_id = s.spec_id 
		    AND bs.application_id = a.application_id
		    AND bs.product_id = p.product_id
		    AND bs.item_type = cs.item_type
		    AND bs.item = cs.item_no
		    AND bs.effective_date = s.effective_date 
	    LEFT JOIN catalog_selections_areas csa with (nolock)
		    ON csa.session_id = cs.session_id
		    AND csa.[application] = cs.[application]
		    AND csa.product = cs.product
		    AND csa.area = cs.area
		    AND csa.sub_area = cs.sub_area
		    AND csa.area_id = cs.area_id
		    AND csa.sub_area_id = cs.sub_area_id
    WHERE 
	    cs.session_id = @session_id
        AND (cs.[application] = @application)
        AND ((@product = '') OR (cs.product = @product))
        AND (cs.is_credit = 0)
        AND (cs.item != 'User')
        AND (cs.[source] = 'Catalog' AND cs.option_pricing_display = 1)
	    AND ((cs.[source] != 'Prices Landed') or (cs.[source] = 'Prices Landed' AND csa.area_selected = 1))
END
GO
PRINT N'Creating Procedure [dbo].[vds_selCatalogSelectionArea]...';


GO
CREATE PROCEDURE dbo.[vds_selCatalogSelectionArea]
    @session_id UNIQUEIDENTIFIER,
    @build_id INT,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 8/6/2015
    Description: Returns a design session build.
        A build represents an application and product in a given area/subarea,
        within a session. A build does not have an exact table in the database.
        Instead, it contains most of the information from the catalog_selections_areas
        table, with additional information.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Return the build information
    SELECT
        csa.*,
        a.application_id,
        p.product_id
    FROM
        dbo.catalog_selections_areas csa WITH (NOLOCK)
        LEFT JOIN VEO_applications a WITH (NOLOCK) ON a.name = csa.[application]
        LEFT JOIN Veo_products p WITH (NOLOCK) ON p.name = csa.product
    WHERE
        session_id = @session_id
        AND build_id = @build_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selCatalogSelectionAreaDetailOptions]...';


GO

create procedure [dbo].[vds_selCatalogSelectionAreaDetailOptions]

@session_id uniqueidentifier,
@application varchar(100),
@product varchar(100),
@area varchar(100),
@sub_area varchar(100),
@item_type varchar(20),
@item_id varchar(50),
@security_token UNIQUEIDENTIFIER


as

/*
	Author:			Adrian Garza
	Create date:	12/4/2014
	Description:	select bom line options

*/

-- Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

select
*
from catalog_selections_area_detail_options with (nolock)
where session_id = @session_id
	and application = @application
	and product = @product
	and area = @area
	and sub_area = @sub_area
	and item_type = @item_type
	and item_id = @item_id
GO
PRINT N'Creating Procedure [dbo].[vds_selCatalogSelectionAreaDetails]...';


GO
CREATE PROCEDURE [dbo].[vds_selCatalogSelectionAreaDetails] 
	@session_id UNIQUEIDENTIFIER, 
	@build_id INT,
	@security_token UNIQUEIDENTIFIER = null
AS
/*
	Author:		Adrian Garza
	Create date: 3/10/2015

*/
BEGIN
	-- Validate the security token
	--IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	--BEGIN
	--	RAISERROR('Access Denied.',16,1)
	--	RETURN
	--END

	SELECT	
		*
	FROM 
		catalog_selections_areas csa WITH (NOLOCK)
		JOIN [catalog_selections_area_details] ad WITH (NOLOCK) ON ad.session_id = csa.session_id AND ad.[application] = csa.[application] AND ad.product = csa.product AND ad.area = csa.area AND ad.sub_area = csa.sub_area

	WHERE
		csa.session_id = @session_id 
		AND csa.build_id = @build_id 

END
GO
PRINT N'Creating Procedure [dbo].[vds_selCatalogSelectionsAreaDetail]...';


GO
CREATE PROCEDURE [dbo].[vds_selCatalogSelectionsAreaDetail]
    @session_id UNIQUEIDENTIFIER,
    @build_id INT,
    @item_type VARCHAR(20),
    @item_id VARCHAR(50),
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author:      Saul Sanchez
    Create date: 07/15/2014
    Description: This stored procedure returns data for a single
        catalog selections area detail.
*/
BEGIN
    --=================================================================
    -- Test variables.
    --=================================================================
    --DECLARE @session_id UNIQUEIDENTIFIER
    --DECLARE @build_id INT
    --DECLARE @item_type VARCHAR(20)
    --DECLARE @item_id VARCHAR(50)
    --DECLARE @security_token UNIQUEIDENTIFIER

    --SET @session_id = '5b7a9ef9-6359-4830-b07f-47c4fdd91c51'
    --SET @build_id = 9797568
    --SET @item_type = 'material'
    --SET @item_id = 'grout'

    -- Execute either of the following select statements to find a valid security token.
    -- Adrian -- SELECT * FROM VEOSolutionsSecurity_users_login_sessions WHERE user_id = '424059BC-E4C9-4F21-BDC2-52E5A24BF9AE' ORDER BY modified_date DESC
    -- Phil   -- SELECT * FROM VEOSolutionsSecurity_users_login_sessions WHERE user_id = '0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B' ORDER BY modified_date DESC
    --SET @security_token = '2EEAE56E-0B63-45FC-854D-EBD41B78F1E6'

    --=================================================================
    -- Validate the security token.
    --=================================================================
    IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
    BEGIN
	    RAISERROR('Access Denied.',16,1)
	    RETURN
    END

    --=================================================================
    -- Declare variables.
    --=================================================================
    DECLARE @application VARCHAR(100)
    DECLARE @product VARCHAR(100)
    DECLARE @area VARCHAR(100)
    DECLARE @sub_area VARCHAR(100)

    --=================================================================
    -- Use the session id to get the application id, product id, area,
    -- and sub area.
    --=================================================================
    SELECT
        @application = [application],
        @product = product,
        @area = area,
        @sub_area = sub_area
    FROM
        dbo.catalog_selections_areas WITH (NOLOCK)
    WHERE
        session_id = @session_id
        AND build_id = @build_id

    SELECT
        *
    FROM
        catalog_selections_area_details WITH (NOLOCK)
    WHERE
        session_id = @session_id
        AND [application] = @application
        AND product = @product
        AND area = @area
        AND sub_area = @sub_area
        AND item_type = @item_type
        AND item_id = @item_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_selCatalogSelectionsGroupDetail]...';


GO
CREATE PROCEDURE [dbo].[vds_selCatalogSelectionsGroupDetail]
	@session_id UNIQUEIDENTIFIER = NULL,
	@include_styles_colors BIT = 0,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Modified By: Shelby Mansker
	Date: 4/15/2019
	Description: Added an optional second result set that contains all of the colors

	Modified By: Roger Wang
	Date: 6/13/2019
	Description: Removed the OR condition from second result set
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		csgd.session_id,
		csgd.group_id,
		ISNULL(cs.item, sg.group_name) as group_name,
		sg.application_id,
		a.[name] as application_name,
		sg.product_id,
		p.[name] as product_name,
		csgd.item_type,
		csgd.item,
		csgd.author,
		csgd.create_date,
		csgd.modifier,
		csgd.modified_date,
		csgd.stamp,
		ISNULL(csgd.area_id, '') as area_id,
		ISNULL(csgd.sub_area_id, '') as sub_area_id
	FROM
		catalog_selections_group_detail csgd WITH (NOLOCK)
		INNER JOIN Veo_styles_groups sg WITH (NOLOCK) ON sg.group_id = csgd.group_id
		INNER JOIN Veo_applications a WITH (NOLOCK) ON a.application_id = sg.application_id
		INNER JOIN Veo_products p WITH (NOLOCK) ON p.product_id = sg.product_id
		LEFT JOIN (
			SELECT DISTINCT
				session_id, item_no, item
			FROM
				catalog_selections WITH (NOLOCK)
			WHERE
				source = 'Prices Landed'
				and item_type = 'group'
		) cs ON cs.session_id = csgd.session_id and cs.item_no = csgd.group_id
	WHERE
		csgd.session_id = @session_id

	IF (@include_styles_colors = 1 AND @session_id IS NOT NULL)
	BEGIN
		SELECT
			sgd.session_id,
			sgd.group_id,
			sgd.item_type,
			sgd.item,
			ISNULL(sgd.area_id, '') as area_id,
			ISNULL(sgd.sub_area_id, '') as sub_area_id,
			c.part_no
		FROM
			catalog_selections_group_detail sgd WITH (NOLOCK)
			JOIN veo_styles_groups sg WITH (NOLOCK) ON sg.group_id = sgd.group_id
			JOIN veo_styles s WITH (NOLOCK) ON s.product_id = sg.product_id AND s.style_id = sgd.item
			JOIN veo_colors c WITH (NOLOCK) ON c.product_id = s.product_id AND c.style_id = s.style_id
		WHERE
			sgd.session_id = @session_id
			AND sgd.item_type = 'style'
	END
END
GO
PRINT N'Creating Procedure [dbo].[vds_selCatalogSession]...';


GO
CREATE PROCEDURE dbo.vds_selCatalogSession
	@session_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
	Author:      Shelby Mansker
	Create date: 2/4/2015
	Description: Returns the catalog session record for the specified session id
*/
BEGIN
    -- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Return Session record
    SELECT
        account_id,
        organization_id,
        [user_id],
        community_id,
        community_name,
        series,
        plan_name,
        plan_version,
        session_id,
        [status],
        session_notes,
        deposit,
        deposit_notes,
        designer_id,
        designer,
        spec_id,
        effective_date,
        completed_date,
        first_completed_date,
        export_date,
        address_id,
        rounding_type,
        rounding_places,
        builder_markup_hb_pricing,
        buyer_signature,
        buyer_signature_date,
        pricing_generated,
        pricing_published,
        author,
        create_date,
        modifier,
        modified_date,
        stamp,
        catalog_source
    FROM
        dbo.account_organization_user_profile_plan_catalog_sessions WITH (NOLOCK)
    WHERE
        session_id = @session_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selCatalogSnapshotCount]...';


GO
CREATE procedure vds_selCatalogSnapshotCount
@session_id uniqueidentifier
as
/*

vds_selCatalogSnapshotCount '6776a726-7006-4a06-af34-31a22b91c538'

*/
select count(*) as price_count
from catalog_prices_published with (nolock)
where session_id = @session_id
GO
PRINT N'Creating Procedure [dbo].[vds_selColor]...';


GO
CREATE PROCEDURE [dbo].[vds_selColor]
	@part_no varchar(50),
	@security_token varchar(36)
AS
/*
	Author: Roger Wang
	Create date: 7/25/2023
	Description: Returns information about a color from Echelon.

	Modified: Daniel Arwe
	Date: 12/14/2023
	Description: Return customer_color_override image_id to support overriding part image.

	Modified: Roger Wang
	Date: 8/28/2024
	Description: Return a list of customer_color_overrides as a part of the object instead of single image_id.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	select
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name as part_name,
		s.description as style_description,
		c.color as color_description,
		s.labor_code,
		s.generic_part_id,
		c.global_product_id
	from
		veo_colors c with (nolock)
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
	where 
		c.part_no = @part_no

	select
		cco.*
	from
		veo_colors c with (nolock)
		inner join Veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no
	where
		c.part_no = @part_no
END
GO
PRINT N'Creating Procedure [dbo].[vds_selColorsBySessionAndBuild]...';


GO
CREATE PROCEDURE [dbo].[vds_selColorsBySessionAndBuild]
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
	@bom_item_type VARCHAR(20) = 'material',
	@bom_item_id VARCHAR(50)= 'FIELD',
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:		Scott Friend
	Create date: ???
	Description:	???

	Updated 5/23/2014: Added this comment block AND reformatted the
	proc a little. Updated the security token validation code to be
	consistent with other procs. -Shelby

	Updated 5/30/2014: Cindy reworked and then Scott rewroted it too - goal to match the results in VeoSolutions
    
    Updated 07/02/2014: Updated to use synonyms to reference other databases.
                        Removed default value for security token from the parameters.
                        Styling changes. Saul.

	vds_selColorsBySessionAndBuild '83b5e473-5062-4373-a5d7-54225d50f1ca', 9797534
	vds_selColorsBySessionAndBuild '83b5e473-5062-4373-a5d7-54225d50f1ca', 10812259
	vds_selColorsBySessionAndBuild 'DB7CF331-E8EC-4469-96EE-951881124EEC', 9797565, 'material', 'FIELD', '01234567-89AB-CDEF-0000-123456789ABC'
*/

BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT 
		--csa.area, cs.item, row_id, 
		c.part_no AS [item],
		CONCAT(s.[description], ' - ', c.color) AS colorDescription, 
		CASE WHEN (csad.real_item_id = c.part_no) THEN 1 ELSE 0 END AS selected,
		c.*
	FROM catalog_selections cs WITH (NOLOCK) --Snapshot of Priceset
	    JOIN catalog_selections_areas csa WITH (NOLOCK) -- Estimated areas
		    ON cs.session_id = csa.session_id
		    AND cs.row_id = csa.selected_field_group
	    LEFT JOIN catalog_selections_group_detail csgd WITH (NOLOCK) --Mapping of Groups to Styles within each Group (use to get styles from a group id)
		    ON cs.session_id = csgd.session_id
		    AND cs.item_type = 'group'
		    AND cs.item_no = CAST(csgd.group_id AS VARCHAR(20))
		    AND cs.[source] = 'Prices Landed'
	    JOIN catalog_selections_area_details csad WITH (NOLOCK) --BOM Lines
		    ON csa.session_id = csad.session_id
		    and csa.[application] = csad.[application]
		    and csa.product = csad.product
		    and csa.area = csad.area
		    and csa.sub_area = csad.sub_area
	    JOIN Veo_products p WITH (NOLOCK) -- Echelon Products
		    ON cs.product = p.name
	    JOIN Veo_colors c WITH (NOLOCK) -- Echelon Colors
		    ON c.product_id = p.product_id 
		    AND ((c.style_id = ISNULL(csgd.item,cs.item_no) AND ISNULL(csgd.item_type,cs.item_type) = 'style') 
			      OR (c.part_no = ISNULL(csgd.item,cs.item_no) AND ISNULL(csgd.item_type,cs.item_type) = 'color'))
	    JOIN veo_styles s WITH (NOLOCK) -- Echelon Styles
		    ON s.product_id = p.product_id and s.style_id = c.style_id
		    AND csad.item_id = s.class
	    JOIN Veo_stocking_codes sc WITH (NOLOCK) -- Ecehlon Stocking Codes
		    ON c.stocking_code = sc.code
	WHERE cs.session_id = @session_id
		AND csa.build_id = @build_id
		AND csad.item_type = @bom_item_type
		AND csad.item_id = @bom_item_id
		AND sc.include_in_search = 1
END
GO
PRINT N'Creating Procedure [dbo].[vds_selCustomerCommunityExteriorPhotos]...';


GO
CREATE PROCEDURE dbo.vds_selCustomerCommunityExteriorPhotos 
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @echelon_community_id INT,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 9/30/2015
    Description: Fetches all of the exterior photos for a given
        builder's community. It just returns the photo id for
        each exterior photo.

    vds_selCustomerCommunityExteriorPhotos 'BAB32B7E-3ADA-497C-862E-E5083971CC59', '41E2B9CA-9B05-4C7A-9994-8DBD48660FF9', 1860, '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Get the echelon customer id for the account organization
    DECLARE @customer_id VARCHAR(15)
    SELECT
        @customer_id = custnmbr
    FROM
        VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK)
        JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) on o.organization_id = ao.organization_id
        JOIN Veo_customers customer WITH (NOLOCK) ON customer.custnmbr = o.external_organization_id
    WHERE
        ao.account_id = @account_id
        AND ao.organization_id = @organization_id
        

    -- Get exterior photos
    SELECT
        p.photo_id
    FROM
        dbo.Veo_photos p WITH (NOLOCK)
        CROSS APPLY
        (
            SELECT
                value AS id
            FROM
                dbo.Veo_photo_attributes_values WITH (NOLOCK)
            WHERE
                photo_id = p.photo_id
                AND attribute_id = 1 -- Customer Attribute
        ) customer
        CROSS APPLY 
        (
            SELECT
                CAST(value AS INT) AS id
            FROM
                dbo.Veo_photo_attributes_values WITH (NOLOCK)
            WHERE
                photo_id = p.photo_id
                AND attribute_id = 2 -- Community Attribute
        ) community
        CROSS APPLY
        (
            SELECT
                value AS id
            FROM
                dbo.Veo_photo_attributes_values WITH (NOLOCK)
            WHERE
                photo_id = p.photo_id
                AND attribute_id = 12 -- Category Attribute
        ) category
    WHERE
        customer.id = @customer_id
        AND community.id = @echelon_community_id
        AND category.id = '4' -- Exterior Photo Category
END
GO
PRINT N'Creating Procedure [dbo].[vds_selCustomerLogo]...';


GO
/*
================================================================================================
author: 		n/a
create date: 	n/a
descrition: 	Store Procedure to get customer logo
================================================================================================
modifier: 		Justin Pope
modified on: 	2024-12-05
description: 	looking at organization images instead of customer table
================================================================================================
test:
select top 5 organization_id from veosolutionssecurity_organizations
exec [dbo].[vds_selCustomerLogo] '3bf05014-1588-4942-94fd-7706ecb2cee2'
================================================================================================
*/
create procedure [dbo].[vds_selCustomerLogo]
-- declare @account_id uniqueidentifier = 'BAB32B7E-3ADA-497C-862E-E5083971CC59'
@organization_id uniqueidentifier = '3bf05014-1588-4942-94fd-7706ecb2cee2'
as

select 
	oi.image_data
from 
	[VeoSolutionsSecurity_organizations] o
	inner join [VeoSolutionsSecurity_organization_images] oi on o.organization_id = oi.organization_id
	inner join [VeoSolutionsSecurity_organization_images_categories] oic on oi.category = oic.category
																		AND oic.category = 'PRIMARY_LOGO'
where 
	o.organization_id = @organization_id
GO
PRINT N'Creating Procedure [dbo].[vds_selDefaultSupportEmails]...';


GO
CREATE PROCEDURE [dbo].[vds_selDefaultSupportEmails]
AS
/*
	Author: Roger Wang
	Date: 02/25/2019
	Description: Fetches Default Support Emails
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	SELECT
		[email_key],
		[email]
	FROM
		dbo.default_support_emails WITH (NOLOCK)
END
GO
PRINT N'Creating Procedure [dbo].[vds_selDesignerAssignedApplications]...';


GO
CREATE PROCEDURE [dbo].[vds_selDesignerAssignedApplications]
	@user_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 2/13/2017
	Description: This proc is used to return the applications that a vendor designer can
		select during a homebuyer session.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		[id],
		[user_id],
		[application],
		author,
		create_date,
		modifier,
		modified_date
	FROM
		designer_assigned_applications WITH (NOLOCK)
	WHERE
		[user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selDesignerAvailableApplications]...';


GO
CREATE PROCEDURE [dbo].[vds_selDesignerAvailableApplications]
	@organization_id UNIQUEIDENTIFIER,
	@user_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 2/13/2017
	Description: This proc is used to return all of the applications that can be assigned to
		a vendor designer as selectable, regardless if they are already assigned to a vendor designer as selectable.
		It gathers applications from the following locations:
		1. From the VEO.applications table, where active is true
		2. From VeoSolutions.catalog_items. Returns all uploaded catalog applications for all organizations that the user is in.
		3. From VeoSolutions.designer_selectable_applications, where custom entered vendor designer applications may exist
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT DISTINCT
		name AS [application]
	FROM
		Veo_applications
	WHERE
		active = 1

	UNION

	SELECT DISTINCT
		ci.[application]
	FROM
		catalog_items ci
		JOIN VeoSolutionsSecurity_account_organization_users aou ON aou.account_id = ci.account_id AND aou.organization_id = ci.organization_id
	WHERE
		aou.[user_id] = @user_id
		AND aou.active = 1
		AND ci.[application] <> ''
		and aou.organization_id = @organization_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_selDesignSessionEstimatedAreaApplicationsProducts]...';


GO
CREATE PROCEDURE [dbo].[vds_selDesignSessionEstimatedAreaApplicationsProducts]
	@session_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Create Date: 2/23/2017
	Description: Returns the Applications and Products for a session, that are used in selectable Estimated Areas.
		It returns two result sets, designed for use with Insight Database. The first result set contains all of the
		applications. The second result set contains the products that belong to each application.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Create a holding tank for the applicaiton and product combos, so we only need to search for them once
	DECLARE @applications TABLE (
		[application] VARCHAR(100),
		product VARCHAR(100)
	)

	-- Find all of the application and product combos that are selectable, and belong to estimated areas in our session
	INSERT INTO @applications ([application], product)
	SELECT DISTINCT
		RTRIM(LTRIM([application])) AS [application],
		RTRIM(LTRIM(product)) AS product
	FROM
		dbo.catalog_selections_areas WITH (NOLOCK)
	WHERE
		area_selected = 1
		AND session_id = @session_id

	-- Return the applications in the first result set
	SELECT DISTINCT
		[application]
	FROM
		@applications

	-- Return the Application and Product combos in the second result set
	SELECT
		[application],
		product
	FROM
		@applications

END
GO
PRINT N'Creating Procedure [dbo].[vds_selDesignSessionIsValid]...';


GO
CREATE procedure vds_selDesignSessionIsValid 
	@session_id uniqueidentifier,
	@security_token UNIQUEIDENTIFIER = NULL
as
/* Summary 

Written to verify that a session exists. Named more generically so that 
we may add more code to verify a session later if needed

TESTING 
vds_selDesignSessionIsValid '8C2FF8A7-3A81-44FC-97A6-BE1A6F1645DE' 
vds_selDesignSessionIsValid '00000000-3A81-44FC-97A6-BE1A6F1645DE' 

select top 10 * from account_organization_user_profile_plan_catalog_sessions order by create_date desc

*/

declare @is_valid bit 

set @is_valid = 0

if exists(SELECT 
			session_id 
			FROM
			account_organization_user_profile_plan_catalog_sessions s with (nolock) 
			WHERE 
				s.session_id = @session_id) 
begin 
	set @is_valid = 1  
end 

select 
	@is_valid as is_valid
GO
PRINT N'Creating Procedure [dbo].[vds_selDesignSessionNonEstimatedApplicationsProducts]...';


GO
CREATE PROCEDURE [dbo].[vds_selDesignSessionNonEstimatedApplicationsProducts]
	@session_id UNIQUEIDENTIFIER,
	@exclude_options_with_area BIT = 0
AS
/*
	Author: Shelby Mansker
	Date: 11/5/2018
	Description: Returns the Applications and Products for a session, that are used in selectable Non-Estimated Areas.
		It returns two result sets, designed for use with Insight Database. The first result set contains all of the
		applications. The second result set contains the products that belong to each application.

	Author: Roger Wang
	Date: 9/6/2024
	Description: Added a flag to exclude options with area from the result set.
*/
BEGIN
	-- Return unique applications first
	SELECT DISTINCT
		[application]
	FROM
		catalog_selections
	WHERE
		session_id = @session_id
		AND [source] <> 'Prices Landed'
		AND (@exclude_options_with_area = 0 OR (LEN(ISNULL(area, '')) = 0 AND LEN(ISNULL(sub_area, '')) = 0))
	ORDER BY
		[application]

	-- Then return a list of unique application and product combos
	SELECT DISTINCT
		[application],
		product
	FROM
		catalog_selections
	WHERE
		session_id = @session_id
		AND [source] <> 'Prices Landed'
		AND (@exclude_options_with_area = 0 OR (LEN(ISNULL(area, '')) = 0 AND LEN(ISNULL(sub_area, '')) = 0))
	ORDER BY
		[application],
		product
END
GO
PRINT N'Creating Procedure [dbo].[vds_selDesignSessions]...';


GO
CREATE PROCEDURE [dbo].[vds_selDesignSessions]
    @page_index INT = 0,
    @page_size INT = 8,
    @order_by VARCHAR(MAX) = '',
    @order_by_direction VARCHAR(4) = 'asc',
	@name VARCHAR(101) = '',
	@address VARCHAR(50) = '',
	@block VARCHAR(10) = '',
	@lot VARCHAR(10) = '',
	@session_id UNIQUEIDENTIFIER = NULL,
	@job_number VARCHAR(10) = '',
	@security_token UNIQUEIDENTIFIER = NULL
AS
/*
	Author:		Shelby Mansker
	Create date: 9/29/2014
	Description:	Returns all of the design sessions that match the passed in filters, that belong
      to organizations of the user calling the function, per the security token passed in. This proc
      is designed to page the results. Pass in the page index (0 based) and the page size to control
      the size of the results. It also supports a custom, single column, bidirectional sort, for specific
      columns. The order_by parameter indicates what to order by, but it uses custom column names in order
      to match the UI (bleh). 

    Modified on 11/14/2014 by Shelby Mansker
      Restricted the results to only organizations that the user is active in.

	Modified on 03/30/2018 by Saul Sanchez
	  Added session_id as a search parameter.

	Modified 05/18/2018 by Art deHoyos
	  Added job_number as a search parameter.

	Modified 05/31/2018 by Art deHoyos
		Added job_no to returned results.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Get the current user id from the security token
	DECLARE @user_id UNIQUEIDENTIFIER = dbo.ef_getUserIdFromSecurityToken(@security_token)

    -- next, fetch the requested page of design sessions, for the current user, based on filters, using page index and page size.
	SELECT 
        aouppcs.session_id,
		aoupp.job_no,
        ss.[status] AS session_status,
		u.first_name + ' ' + u.last_name AS homebuyer_fullname,
		u.email AS homebuyer_email,
        aoupp.profile_id,
        o.name AS builder_name,
        aoupp.[address] AS street_address,
        aoupp.lot,
		aoupp.block,
		aoupp.job_no,
        aouppcs.community_name,
        aouppcs.series,
        aouppcs.plan_name,
        overall_count = COUNT(*) OVER()
	FROM
        VeoSolutionsSecurity_account_organization_users aou WITH (NOLOCK)
		JOIN veosolutionssecurity_organizations o WITH (NOLOCK) ON aou.organization_id = o.organization_id
		JOIN dbo.account_organization_user_profile_plan aoupp WITH (NOLOCK) ON aou.account_id = aoupp.account_id AND aou.organization_id = aoupp.organization_id
		JOIN dbo.account_organization_user_profile_plan_catalog_sessions aouppcs ON aoupp.account_id = aouppcs.account_id AND aoupp.organization_id = aouppcs.organization_id AND aoupp.[user_id] = aouppcs.[user_id] AND aoupp.community_name = aouppcs.community_name AND aoupp.series = aouppcs.series AND aoupp.plan_name = aouppcs.plan_name
        LEFT JOIN VeoSolutionsSecurity_users u WITH (NOLOCK) ON u.[user_id] = aoupp.[user_id]
		LEFT JOIN dbo.session_statuses ss WITH (NOLOCK) ON ss.status_id = aouppcs.[status]
	WHERE
        aou.[user_id] = @user_id
        AND aou.active = 1
		AND (@name = '' OR @name IS NULL OR PATINDEX('%'+@name+'%', u.first_name + ' ' + u.last_name) > 0 OR PATINDEX('%'+@name+'%', u.email) > 0)
		AND (@address = '' OR @address IS NULL OR PATINDEX('%'+@address+'%', aoupp.[address]) > 0)
		AND (@block = '' OR @block IS NULL OR PATINDEX('%'+@block+'%', aoupp.block) > 0)
		AND (@lot = '' OR @lot IS NULL OR PATINDEX('%'+@lot+'%', CAST(aoupp.lot AS VARCHAR(10))) > 0)
		AND (aouppcs.session_id = CASE WHEN @session_id IS NULL THEN aouppcs.session_id ELSE @session_id END)
		AND (@job_number = '' OR @job_number IS NULL OR PATINDEX('%'+@job_number+'%', aoupp.job_no) > 0)
	ORDER BY
        CASE WHEN @order_by = 'UserFullName' AND @order_by_direction = 'desc' THEN u.first_name END DESC,
        CASE WHEN @order_by = 'UserFullName' AND @order_by_direction = 'desc' THEN u.last_name END DESC,
        CASE WHEN @order_by = 'UserFullName' AND @order_by_direction <> 'desc' THEN u.first_name END,
        CASE WHEN @order_by = 'UserFullName' AND @order_by_direction <> 'desc' THEN u.last_name END,
        CASE WHEN @order_by = 'BuilderName' AND @order_by_direction = 'desc' THEN o.name END DESC,
        CASE WHEN @order_by = 'BuilderName' AND @order_by_direction <> 'desc' THEN o.name END,
        CASE WHEN @order_by = 'UserEmail' AND @order_by_direction = 'desc' THEN u.email END DESC,
        CASE WHEN @order_by = 'UserEmail' AND @order_by_direction <> 'desc' THEN u.email END,
        CASE WHEN @order_by = 'StreetAddress' AND @order_by_direction = 'desc' THEN aoupp.[address] END DESC,
        CASE WHEN @order_by = 'StreetAddress' AND @order_by_direction <> 'desc' THEN aoupp.[address] END,
        CASE WHEN @order_by = 'Lot' AND @order_by_direction = 'desc' THEN aoupp.lot END DESC,
        CASE WHEN @order_by = 'Lot' AND @order_by_direction <> 'desc' THEN aoupp.lot END,
        CASE WHEN @order_by = 'Block' AND @order_by_direction = 'desc' THEN aoupp.block END DESC,
        CASE WHEN @order_by = 'Block' AND @order_by_direction <> 'desc' THEN aoupp.block END,
        CASE WHEN @order_by = 'Status' AND @order_by_direction = 'desc' THEN ss.[status] END DESC,
        CASE WHEN @order_by = 'Status' AND @order_by_direction <> 'desc' THEN ss.[status] END
    OFFSET @page_index * @page_size ROWS
    FETCH NEXT @page_size ROWS ONLY
END
GO
PRINT N'Creating Procedure [dbo].[vds_selEchelonAreas]...';


GO
CREATE PROCEDURE [dbo].[vds_selEchelonAreas]
	@include_inactive BIT = 0,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Create Date: 6/19/2023
	Description: Fetches a list of areas from Echelon.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT
        *
	FROM
		Veo_areas WITH (NOLOCK)
	WHERE
		@include_inactive = 1 OR active = 1
END
GO
PRINT N'Creating Procedure [dbo].[vds_selEchelonGroupDetail]...';


GO
CREATE PROCEDURE [dbo].[vds_selEchelonGroupDetail]
	@spec_id INT,
	@external_organization_id VARCHAR(20),
	@effective_date DATE,
	@security_token UNIQUEIDENTIFIER
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT gd.*,
		case gd.item_type
			when 'style' then s.[description]
			when 'color' then c.[name]
			else ''
		end as item_description
	FROM (
		SELECT DISTINCT
			gd.group_id,
			gd.item_type,
			gd.item
		FROM
			dbo.Veo_styles_groups_detail gd WITH (NOLOCK)
		WHERE
			gd.customer_id = @external_organization_id
			AND CONVERT(DATE, gd.effective_date) <= @effective_date
			AND (gd.end_date IS NULL OR CONVERT(DATE, gd.end_date) >= @effective_date)

		UNION

		SELECT DISTINCT
			sgd.group_id,
			sgd.item_type,
			sgd.item
		FROM
			veo_spec_items si WITH (NOLOCK)
			LEFT JOIN Veo_styles_groups sg WITH (NOLOCK) ON sg.group_id = si.item
			LEFT JOIN Veo_styles_groups_detail sgd WITH (NOLOCK) ON sgd.group_id = sg.group_id AND sgd.customer_id = @external_organization_id
		WHERE
			si.spec_id = @spec_id
			AND si.application_id = '10'
			AND si.product_id = 'Y'
			AND si.item_type = 'group'
			AND si.exclude_contract_publication = 1
	) gd
	INNER JOIN Veo_styles_groups sg on sg.group_id = gd.group_id
	LEFT JOIN Veo_styles s on gd.item_type = 'style' and s.product_id = sg.product_id and s.style_id = gd.item
	LEFT JOIN veo_colors c on gd.item_type = 'color' and c.part_no = gd.item
END
GO
PRINT N'Creating Procedure [dbo].[vds_selEchelonPlanFromBuildID]...';


GO
CREATE PROCEDURE [dbo].[vds_selEchelonPlanFromBuildID]
    @build_id VARCHAR(50),
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Create Date: 7/27/2015
    Description: Fetches echelon plan information by looking up one of its builds.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Fetch the plan that contains the specified build. A build should only ever belong to one and only one plan.
    SELECT
        plan_id,
        elevation,
        spec_id,
        plan_name,
        active,
        [status],
        comments,
        end_date,
        author,
        create_date,
        modifier,
        modified_date
    FROM 
        VEO_plan_mstr WITH (NOLOCK)
    WHERE
        plan_id = (SELECT TOP 1 
                        plan_id 
                    FROM 
                        VEO_plan_builds 
                    WHERE 
                        build_id = @build_id)
END
GO
PRINT N'Creating Procedure [dbo].[vds_selEchelonPlansFromSpecID]...';


GO
CREATE PROCEDURE [dbo].[vds_selEchelonPlansFromSpecID]
	@spec_id int,
    @security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Create Date: 6/27/2019
	Description: Fetches echelon plan information by looking up one of its specs.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT
        plan_id,
        elevation,
        spec_id,
        plan_name,
        active,
        [status],
        comments,
        end_date,
        author,
        create_date,
        modifier,
        modified_date,
		address_specific
	FROM
		Veo_plan_mstr WITH (NOLOCK)
	WHERE
		spec_id = @spec_id
		AND active = 1
END
GO
PRINT N'Creating Procedure [dbo].[vds_selEchelonSubAreas]...';


GO
CREATE PROCEDURE [dbo].[vds_selEchelonSubAreas]
	@include_inactive BIT = 0,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Create Date: 5/11/2023
	Description: Fetches a list of sub areas from Echelon.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT
        *
	FROM
		Veo_sub_areas WITH (NOLOCK)
	WHERE
		@include_inactive = 1 OR active = 1
END
GO
PRINT N'Creating Procedure [dbo].[vds_selEmailEvents]...';


GO
CREATE PROCEDURE [dbo].[vds_selEmailEvents]
	@user_id UNIQUEIDENTIFIER
AS
/*
Author: Art deHoyos
Date: 1/3/2019
Description: Get all email events for a user
*/
BEGIN
	SELECT * FROM email_events
	JOIN VeoSolutionsSecurity_users vssu 
		ON vssu.email = email_events.email
	WHERE vssu.user_id = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selEstimatedOptionPricingItemsForSession]...';


GO
CREATE PROCEDURE [dbo].[vds_selEstimatedOptionPricingItemsForSession]
@session_id UNIQUEIDENTIFIER,
@application VARCHAR(50),
@product VARCHAR(50) = '',
@security_token UNIQUEIDENTIFIER
AS
/*
    Author: Saul Sanchez
    Create Date: 8/20/2015
    Description: Fetches estimated option pricing items for the specified session.
*/
BEGIN
    -- Validate the security token
    IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
    BEGIN
	    RAISERROR('Access Denied.',16,1)
	    RETURN
    END

    SELECT 
        a.application_id,
        RTRIM(LTRIM(cs.[application])) as [application],
        p.product_id,
        RTRIM(LTRIM(cs.product)) as product,
        cs.[source],
        cs.area,
        cs.sub_area,
        0 as location_id,
        cs.item_type,
        cs.item_no,
        cs.item,
        ISNULL(cs.price, 0) as price,
        cs.gpc, 
        gpc_doc_count = (select count(*) from gpc_products_documents with (nolock) where gpc_id = try_convert(uniqueidentifier,cs.gpc)),
        cs.option_pricing_display,
        s.spec_id,
        s.effective_date,
		s.plan_version,
        ISNULL(bs.contract_sort_order, 9999999) AS contract_sort_order
    FROM 
	    catalog_selections cs with (nolock)
	    LEFT JOIN veo_areas va with (nolock) on va.area_id = cs.area_id
	    LEFT JOIN Veo_applications a with (nolock) on a.name = cs.[application]
	    LEFT JOIN Veo_products p with (nolock) on p.name = cs.product
	    LEFT JOIN account_organization_user_profile_plan_catalog_sessions s with (nolock) on s.session_id = cs.session_id
	    LEFT JOIN Veo_builder_styles bs with (nolock)
		    ON bs.spec_id = s.spec_id 
		    AND bs.application_id = a.application_id
		    AND bs.product_id = p.product_id
		    AND bs.item_type = cs.item_type
		    AND bs.item = cs.item_no
		    AND bs.effective_date = s.effective_date 
	    LEFT JOIN catalog_selections_areas csa with (nolock)
		    ON csa.session_id = cs.session_id
		    AND csa.[application] = cs.[application]
		    AND csa.product = cs.product
		    AND csa.area = cs.area
		    AND csa.sub_area = cs.sub_area
		    AND csa.area_id = cs.area_id
		    AND csa.sub_area_id = cs.sub_area_id
    WHERE 
	    cs.session_id = @session_id
        AND (cs.[application] = @application)
        AND ((@product = '') OR (cs.product = @product))
        AND (cs.is_credit = 0)
        AND (cs.item != 'User')
        AND (cs.[source] != 'Catalog')
	    AND ((cs.[source] != 'Prices Landed') OR (cs.[source] = 'Prices Landed' AND csa.area_selected = 1))
END
GO
PRINT N'Creating Procedure [dbo].[vds_selFeature]...';


GO
CREATE PROCEDURE [dbo].[vds_selFeature]
	@id INT,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Modified: Roger Wang
	Date: 4/28/2023
	Description: Returns a feature by ID
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		*
	FROM
		features WITH (NOLOCK)
	WHERE
		id = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selFeatures]...';


GO
CREATE PROCEDURE [dbo].[vds_selFeatures]
	@security_token UNIQUEIDENTIFIER
AS
/*
	Modified: Roger Wang
	Date: 6/28/2021
	Description: Replaced the function that returns all builder features stored in organizations table with a view
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		id,
		lookup_key,
		name,
		description,
		group_name
	FROM
		features
END
GO
PRINT N'Creating Procedure [dbo].[vds_selFieldItemsForAllBuildPriceLevels]...';


GO
CREATE PROCEDURE [dbo].[vds_selFieldItemsForAllBuildPriceLevels]
	@page_index INT OUTPUT,
	@page_size INT = 12,
	@session_id UNIQUEIDENTIFIER,
	@build_id BIGINT,
	@search_criteria VARCHAR(100),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 6/1/2018
	Description: Searches for all of the matching parts within the selectable field items
				 for a build. Returns the part AND its associated price level.

	Modified: Shelby Mansker
	Date: 8/29/2019
	Description: Fixed a bug where colors were being removed when any group was excluded from the area/sub_area for this build, in spec_area_items.

	Modified:		Roger Wang
	Date:			5/13/2021
	Description:	Replaced the use of stocking_codes.homebuyer_selectable with stocking_codes.designer_selectable.

	Modified:		Roger Wang
	Date:			8/9/2022
	Description:	Include area/sub area when fetching items from group detail.

	Modified:		Roger Wang
	Date:			7/11/2023
	Description:	Filter styles/colors based on plan item in spec_areas_items.

	Modified:       Reid Wilson
	Date:           9/11/2023
	Description:    Allow searching by and returning builder override part id and name.

	Modified:		Roger Wang
	Date:			10/4/2023
	Description:	Honor Support Builder Overrides feature flag.
*/
BEGIN
	-- =====================
	-- Authentication
	-- =====================
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- ============================
	-- Variable Declaration
	-- ============================
	DECLARE @item_class VARCHAR(50) = 'field'
	DECLARE @spec_id INT
	DECLARE @application_id VARCHAR(10)
	DECLARE @product_id VARCHAR(10)
	DECLARE @area_id VARCHAR(50)
	DECLARE @sub_area_id VARCHAR(50)
	DECLARE @location_id INT
	DECLARE @effective_date DATETIME
	DECLARE @external_organization_id VARCHAR(20)
	DECLARE @organization_id UNIQUEIDENTIFIER
	DECLARE @builder_overrides_enabled BIT = 0

	SELECT
		@spec_id = vpm.spec_id,
		@application_id = application_id,
		@product_id = product_id,
		@area_id = area_id,
		@sub_area_id = sub_area_id,
		@location_id = location_id,
		@external_organization_id = builder_id
	FROM
		veo_plan_builds vpb WITH (NOLOCK)
		LEFT JOIN veo_plan_mstr vpm WITH (NOLOCK) ON vpm.plan_id = vpb.plan_id
		LEFT JOIN veo_spec_mstr vsm WITH (NOLOCK) ON vsm.spec_id = vpm.spec_id
	WHERE
		vpb.build_id_num = @build_id

	SELECT
		@effective_date = cs.effective_date,
		@organization_id = cs.organization_id
	FROM
		account_organization_user_profile_plan_catalog_sessions cs WITH (NOLOCK)
	WHERE
		cs.session_id = @session_id

	SELECT
		@builder_overrides_enabled = dbo.vdsf_isOrganizationFeatureOn(@organization_id, f.id)
	FROM
		features f WITH (NOLOCK)
	WHERE
		f.lookup_key = 'builder_overrides'

	-- ============================
	-- Fetch Price Levels for Build
	-- ============================
	DECLARE @price_levels TABLE
	(
		price_level_name VARCHAR(100),
		price_level_type VARCHAR(50),
		price_level_id VARCHAR(81),
		price_level_price DECIMAL(18,2),
		price_level_sort_order INT
	)

	INSERT INTO @price_levels (price_level_name, price_level_type, price_level_id, price_level_price, price_level_sort_order)
	SELECT
		cs.item,
		cs.item_type,
		cs.item_no,
		cs.price,
		ISNULL(bs.contract_sort_order, 99999) AS price_level_sort_order
	FROM
		catalog_selections cs WITH (NOLOCK)
		LEFT JOIN Veo_builder_styles bs WITH (NOLOCK) ON bs.spec_id = @spec_id AND bs.application_id = @application_id AND bs.product_id = @product_id AND bs.item_type = cs.item_type AND bs.item = cs.item_no AND bs.effective_date = @effective_date
	WHERE
		cs.session_id = @session_id
		AND cs.build_id = @build_id
		AND cs.item_type <> 'custom'

	-- ============================
	-- Initialize Colors Table
	-- ============================
	DECLARE @colors TABLE
	(
		price_level_name VARCHAR(100),
		price_level_type VARCHAR(50),
		price_level_id VARCHAR(81),
		price_level_price DECIMAL(18,2),
		price_level_sort_order INT,
		product_id VARCHAR(10),
		style_id VARCHAR(50),
		color_id VARCHAR(50),
		part_name VARCHAR(100),
		part_no VARCHAR(100),
		part_no_override VARCHAR(100),
		part_name_official VARCHAR(150)
	)

	-- =========================================
	-- spec_items --> groups -> styles -> colors
	-- =========================================
	MERGE @colors AS TARGET
	USING
	(
		SELECT DISTINCT
			pl.price_level_name,
			pl.price_level_type,
			pl.price_level_id,
			pl.price_level_price,
			pl.price_level_sort_order,
			c.product_id,
			c.style_id,
			c.color_id,
			c.[name],
			c.part_no,
			cco.customer_reference_no,
			case
				when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
					then (cco.color_private_label)
				else c.name
			end as part_name_official
		FROM
			@price_levels pl
			JOIN veo_spec_items si WITH (NOLOCK) ON si.item_type = pl.price_level_type AND si.item = pl.price_level_id
			LEFT JOIN Veo_styles_groups sg WITH (NOLOCK) ON sg.group_id = si.item
			LEFT JOIN catalog_selections_group_detail sgd WITH (NOLOCK) ON sgd.group_id = sg.group_id
			LEFT JOIN Veo_styles s WITH (NOLOCK) ON s.product_id = sg.product_id AND s.style_id = sgd.item
			LEFT JOIN veo_colors c WITH (NOLOCK) ON c.product_id = s.product_id AND c.style_id = s.style_id
			LEFT JOIN veo_colors_customer_overrides cco WITH (NOLOCK) ON cco.part_no = c.part_no AND cco.customer_id = @external_organization_id
		WHERE
			pl.price_level_type = 'group'
			AND si.spec_id = @spec_id
			AND si.application_id = @application_id
			AND si.product_id = @product_id
			AND sgd.session_id = @session_id
			AND sgd.item_type = 'style'
			AND ISNULL(sgd.area_id, '') in ('', @area_id)
			AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
			AND s.class = @item_class
	) AS SOURCE
	ON TARGET.price_level_id = SOURCE.price_level_id AND TARGET.part_no = SOURCE.part_no
	WHEN NOT MATCHED THEN
		INSERT
			(price_level_name, price_level_type, price_level_id, price_level_price, price_level_sort_order, product_id, style_id, color_id, part_name, part_no, part_no_override, part_name_official)
		VALUES
			(SOURCE.price_level_name, SOURCE.price_level_type, SOURCE.price_level_id, SOURCE.price_level_price, SOURCE.price_level_sort_order, SOURCE.product_id, SOURCE.style_id, SOURCE.color_id, SOURCE.[name], SOURCE.part_no, SOURCE.customer_reference_no, SOURCE.part_name_official);

	-- =========================================
	-- spec_items --> groups -> colors
	-- =========================================
	MERGE @colors AS TARGET
	USING
	(
		SELECT DISTINCT
			pl.price_level_name,
			pl.price_level_type,
			pl.price_level_id,
			pl.price_level_price,
			pl.price_level_sort_order,
			c.product_id,
			c.style_id,
			c.color_id,
			c.[name],
			c.part_no,
			cco.customer_reference_no,
			case
				when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
					then (cco.color_private_label)
				else c.name
			end as part_name_official
		FROM
			@price_levels pl
			JOIN veo_spec_items si WITH (NOLOCK) ON si.item_type = pl.price_level_type AND si.item = pl.price_level_id
			LEFT JOIN veo_styles_groups sg WITH (NOLOCK) ON sg.group_id = si.item
			LEFT JOIN catalog_selections_group_detail sgd WITH (NOLOCK) ON sgd.group_id = sg.group_id
			LEFT JOIN veo_colors c WITH (NOLOCK) ON c.part_no = sgd.item
			LEFT JOIN veo_styles s WITH (NOLOCK) ON s.product_id = c.product_id AND s.style_id = c.style_id
			LEFT JOIN veo_colors_customer_overrides cco WITH (NOLOCK) ON cco.part_no = c.part_no AND cco.customer_id = @external_organization_id
		WHERE
			pl.price_level_type = 'group'
			AND si.spec_id = @spec_id
			AND si.application_id = @application_id
			AND si.product_id = @product_id
			AND sgd.session_id = @session_id
			AND sgd.item_type = 'color'
			AND ISNULL(sgd.area_id, '') in ('', @area_id)
			AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
			AND s.class = @item_class
	) AS SOURCE
	ON TARGET.price_level_id = SOURCE.price_level_id AND TARGET.part_no = SOURCE.part_no
	WHEN NOT MATCHED THEN
		INSERT
			(price_level_name, price_level_type, price_level_id, price_level_price, price_level_sort_order, product_id, style_id, color_id, part_name, part_no, part_no_override, part_name_official)
		VALUES
			(SOURCE.price_level_name, SOURCE.price_level_type, SOURCE.price_level_id, SOURCE.price_level_price, SOURCE.price_level_sort_order, SOURCE.product_id, SOURCE.style_id, SOURCE.color_id, SOURCE.[name], SOURCE.part_no, SOURCE.customer_reference_no, SOURCE.part_name_official);

	-- =========================================
	-- spec_items --> styles -> colors
	-- =========================================
	MERGE @colors AS TARGET
	USING
	(
		SELECT DISTINCT
			pl.price_level_name,
			pl.price_level_type,
			pl.price_level_id,
			pl.price_level_price,
			pl.price_level_sort_order,
			c.product_id,
			c.style_id,
			c.color_id,
			c.[name],
			c.part_no,
			cco.customer_reference_no,
			case
				when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
					then (cco.color_private_label)
				else c.name
			end as part_name_official
		FROM
			@price_levels pl
			JOIN veo_spec_items si WITH (NOLOCK) ON si.item_type = pl.price_level_type AND si.item = pl.price_level_id
			LEFT JOIN veo_colors c WITH (NOLOCK) ON c.product_id = si.product_id AND c.style_id = si.item
			LEFT JOIN veo_styles s WITH (NOLOCK) ON s.product_id = c.product_id AND s.style_id = c.style_id
			LEFT JOIN veo_colors_customer_overrides cco WITH (NOLOCK) ON cco.part_no = c.part_no AND cco.customer_id = @external_organization_id
		WHERE
			pl.price_level_type = 'style'
			AND si.spec_id = @spec_id
			AND si.application_id = @application_id
			AND si.product_id = @product_id
			AND s.class = @item_class
	) AS SOURCE
	ON TARGET.price_level_id = SOURCE.price_level_id AND TARGET.part_no = SOURCE.part_no
	WHEN NOT MATCHED THEN
		INSERT
			(price_level_name, price_level_type, price_level_id, price_level_price, price_level_sort_order, product_id, style_id, color_id, part_name, part_no, part_no_override, part_name_official)
		VALUES
			(SOURCE.price_level_name, SOURCE.price_level_type, SOURCE.price_level_id, SOURCE.price_level_price, SOURCE.price_level_sort_order, SOURCE.product_id, SOURCE.style_id, SOURCE.color_id, SOURCE.[name], SOURCE.part_no, SOURCE.customer_reference_no, SOURCE.part_name_official);

	-- =========================================
	-- spec_items --> colors
	-- =========================================
	MERGE @colors AS TARGET
	USING
	(
		SELECT DISTINCT
			pl.price_level_name,
			pl.price_level_type,
			pl.price_level_id,
			pl.price_level_price,
			pl.price_level_sort_order,
			c.product_id,
			c.style_id,
			c.color_id,
			c.[name],
			c.part_no,
			cco.customer_reference_no,
			case
				when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
					then (cco.color_private_label)
				else c.name
			end as part_name_official
		FROM
			@price_levels pl
			JOIN veo_spec_items si WITH (NOLOCK) ON si.item_type = pl.price_level_type AND si.item = pl.price_level_id
			LEFT JOIN veo_colors c WITH (NOLOCK) ON c.part_no = si.item
			LEFT JOIN veo_styles s WITH (NOLOCK) ON s.product_id = c.product_id AND s.style_id = c.style_id
			LEFT JOIN veo_colors_customer_overrides cco WITH (NOLOCK) ON cco.part_no = c.part_no AND cco.customer_id = @external_organization_id
		WHERE
			pl.price_level_type = 'color'
			AND si.spec_id = @spec_id
			and si.application_id = @application_id
			and si.product_id = @product_id
			and s.class = @item_class
	) AS SOURCE
	ON TARGET.price_level_id = SOURCE.price_level_id AND TARGET.part_no = SOURCE.part_no
	WHEN NOT MATCHED THEN
		INSERT
			(price_level_name, price_level_type, price_level_id, price_level_price, price_level_sort_order, product_id, style_id, color_id, part_name, part_no, part_no_override, part_name_official)
		VALUES
			(SOURCE.price_level_name, SOURCE.price_level_type, SOURCE.price_level_id, SOURCE.price_level_price, SOURCE.price_level_sort_order, SOURCE.product_id, SOURCE.style_id, SOURCE.color_id, SOURCE.[name], SOURCE.part_no, SOURCE.customer_reference_no, SOURCE.part_name_official);


	-- =======================================================
	-- remove parts explicitly excluded from spec area
	-- =======================================================
	IF @spec_id <> 0 AND EXISTS( SELECT TOP 1 line_no FROM veo_spec_areas_items WHERE spec_id = @spec_id)
	BEGIN
		DELETE
			c
		FROM
			@colors c
			INNER JOIN dbo.vdsf_selSpecAreaExcludedParts(@session_id, @spec_id, @application_id, @product_id, @area_id, @sub_area_id, @location_id, 'field') saep ON saep.part_no = c.part_no
	END

	-- =======================================================
	-- remove not designer_selectable parts --> colors
	-- =======================================================
	delete
		c
	from
		@colors c
		inner join veo_colors c1 with (nolock) on c1.part_no = c.part_no
		inner join veo_stocking_codes vsc with (nolock) on vsc.code = c1.stocking_code
	where
		vsc.designer_selectable = 0

	-- =======================================================
	-- Build Paged Results and Sort
	-- =======================================================
	DECLARE @results TABLE
	(
		price_level_name VARCHAR(100),
		price_level_type VARCHAR(50),
		price_level_id VARCHAR(81),
		price_level_price DECIMAL (18,2),
		price_level_sort_order INT,
		product_id VARCHAR(10),
		style_id VARCHAR(50),
		color_id VARCHAR(50),
		part_name VARCHAR(100),
		part_no VARCHAR(100),
		part_no_override VARCHAR(100),
		part_name_official VARCHAR(150),
		[row_number] INT,
		[row_count] INT
	)

	INSERT INTO @results
	SELECT DISTINCT
		c.*,
		ROW_NUMBER() OVER (ORDER BY
			c.price_level_sort_order,
			c.price_level_name,
			c.part_name_official) as [row_number],
		COUNT(c.part_no) over() as row_count
	FROM
		@colors c
	WHERE
		(@search_criteria = ''
			OR c.part_name LIKE '%' + @search_criteria + '%'
			OR c.part_no LIKE '%' + @search_criteria + '%'
			OR (
				@builder_overrides_enabled = 1
				AND (
					c.part_name_official like '%' + @search_criteria + '%'
					OR c.part_no_override like '%' + @search_criteria + '%'
				)
			)
		)
	ORDER BY
		c.price_level_sort_order,
		c.price_level_name,
		c.part_name_official
	OFFSET @page_index * @page_size ROWS
	FETCH NEXT @page_size ROWS ONLY

	-- =======================================================
	-- Returns Results
	-- =======================================================
	SELECT * FROM @results ORDER BY row_number
END
GO
PRINT N'Creating Procedure [dbo].[vds_selHasUserMadeSelections]...';


GO
CREATE PROCEDURE [dbo].[vds_selHasUserMadeSelections]
    @session_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
	Modified: Shelby Mansker
	Date: 1/18/2016
	Description: I am now also returning the results as a result set, as well
		as in the return value. This is more in line with how we use our stored 
		procedures.
*/
BEGIN
    --=================================================================
    -- Validate the security token
    --=================================================================
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    --=================================================================
    -- Initialize the return value to false.
    --=================================================================
    DECLARE @result BIT = 0

    --=================================================================
    -- Check if any estimated areas have begun selections.
    --=================================================================
    IF EXISTS (SELECT TOP 1
                   session_id
               FROM
                   catalog_selections_areas WITH (NOLOCK)
               WHERE
                   session_id = @session_id
                   AND selected <> 0
              )
    BEGIN
        SET @result = 1
    END

    --=================================================================
    -- If we still haven't found any selections, then check if any
    -- catalog items have been selected.
    --=================================================================
    IF (@result = 0)
    BEGIN
        IF EXISTS (SELECT TOP 1
                       session_id
                   FROM
                       catalog_selections WITH (NOLOCK)
                   WHERE
                       session_id = @session_id
                       AND [source] != 'Prices Landed'
                       AND selected <> 0
                  )
        BEGIN
            SET @result = 1
        END
    END

	SELECT @result AS session_has_selections

    RETURN @result
END
GO
PRINT N'Creating Procedure [dbo].[vds_selHomebuyerCatalogBuilds]...';


GO
CREATE PROCEDURE [dbo].[vds_selHomebuyerCatalogBuilds]
	@session_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 8/13/2019
	Description: Returns all of the builds that are considered "valid" for a homebuyer's catalog.
		Valid homebuyer catalog builds are those that contain a standard build. This should represent
		the builds that come with the house. This will include credit builds.

	Modified: Yaxu Li
	Date: 9/6/2019
	Description: Added hasFreePriceLevel in result

	Modified: Shelby Mansker
	Date: 11/12/2019
	Description: Added functionality to filter out builds that have sub areas that have been identified
		as sub areas to ignore.

	Modified: Art deHoyos
	Date: 11/19/2019
	Description: Added icon id to result

	Modified: Shelby Mansker
	Date: 12/16/2019
	Description: Removed the logic that would filter out builds with certain sub areas. We are going a different direction with
		this.

	Modified: Saul Sanchez
	Date: 3/16/2020
	Description: Include room id and room name in the return data, and only return those builds that have been set up in rooms.

	Modified: Eric Hickey
	Date: 3/20/2020
	Description: The icon_id from [room] is now being returned instead of from [area_icon].  Also, [area_icon] has been removed from the join as it is no longer used.

	Modified: Roger Wang
	Date: 10/23/2020
	Description: Include plan mapping when fetching for builds.

	Modified: Charles Moore
	Date: 10/04/2021
	Description: only include default builds that have Plan Areas.

	Modified: Roger Wang
	Date: 10/28/2021
	Description: For any plan_areas that are marked with base_area,
		return all default builds under it and not just the default application/product

	Modified: Roger Wang
	Date: 11/22/2021
	Description: Include credit builds (if a build is a credit build and price is negative)
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END	

	DECLARE @base_areas TABLE
	(
		plan_id INT,
		area_id VARCHAR(50),
		sub_area_id VARCHAR(50)
	)

	DECLARE @plan_name VARCHAR(50),
		@plan_version VARCHAR(50),
		@echelon_plan_id INT

	INSERT INTO
		@base_areas
	SELECT
		pm.plan_id,
		pa.area_id,
		pa.sub_area_id
	FROM
		account_organization_user_profile_plan_catalog_sessions cs WITH (NOLOCK)
		JOIN account_organization_user_profile_plan pp WITH (NOLOCK) ON
			pp.account_id = cs.account_id
			AND pp.organization_id = cs.organization_id
			AND pp.[user_id] = cs.[user_id]
			AND pp.community_name = cs.community_name
			AND pp.series = cs.series
			AND pp.plan_name = cs.plan_name
		JOIN VeoSolutionsSecurity_account_organization_plans op WITH (NOLOCK) ON
			op.account_id = pp.account_id
			AND op.organization_id = pp.organization_id
			AND op.name = pp.plan_name
		LEFT JOIN VeoSolutionsSecurity_account_organization_plans_mappings opm WITH (NOLOCK) ON
			opm.account_id = op.account_id
			AND opm.organization_id = op.organization_id
			AND opm.plan_id = op.plan_id
		JOIN Veo_plan_mstr pm WITH (NOLOCK) ON
			pm.spec_id = cs.spec_id
			AND pm.plan_name = ISNULL(opm.mapped_name, cs.plan_name)
			AND pm.elevation = cs.plan_version
		JOIN Veo_plan_areas pa WITH (NOLOCK) ON pa.plan_id = pm.plan_id
	WHERE
		cs.session_id = @session_id
		AND pa.base_area = 1 

	INSERT INTO
		@base_areas
	SELECT DISTINCT
		(SELECT TOP 1 plan_id FROM @base_areas)
		, cs.area_id, cs.sub_area_id
	FROM
		catalog_selections cs WITH (NOLOCK)
	WHERE
		cs.session_id = @session_id
		AND cs.source = 'prices landed'
		AND cs.is_credit = 1
		AND cs.price < 0

	SELECT DISTINCT
		pb.build_id,
		pb.build_desc,
		pa.application_id,
		app.[name] AS [application],
		pa.product_id,
		pa.is_std_product,
		p.[name] AS product,
		pa.area_id,
		a.[name] AS area,
		pa.sub_area_id,
		sa.[name] AS sub_area,
		r.icon_id,
		dbo.vdsf_buildHasFreePriceLevel(csa.session_id, csa.build_id) AS has_free_price_level,
		dbo.vdsf_isCreditArea(csa.session_id, csa.[application], csa.product, csa.area, csa.sub_area) AS is_credit_area,
		r.id AS room_id,
		r.[name] AS room_name
	FROM
		@base_areas pat
		JOIN Veo_plan_areas pa WITH (NOLOCK) ON
			pat.plan_id = pa.plan_id
			AND pat.area_id = pa.area_id
			AND pat.sub_area_id = pa.sub_area_id
		JOIN Veo_plan_builds pb WITH (NOLOCK) ON
			pb.plan_id = pa.plan_id 
			AND pb.application_id = pa.application_id 
			AND pb.product_id = pa.product_id
			AND pb.area_id = pa.area_id
			AND pb.sub_area_id = pa.sub_area_id
			AND pb.location_id = pa.location_id
		JOIN Veo_applications app WITH (NOLOCK) ON app.application_id = pb.application_id
		JOIN Veo_products p WITH (NOLOCK) ON p.product_id = pb.product_id
		JOIN Veo_areas a WITH (NOLOCK) ON a.area_id = pb.area_id
		JOIN Veo_sub_areas sa WITH (NOLOCK) ON sa.sub_area_id = pb.sub_area_id
		JOIN catalog_selections_areas csa WITH (NOLOCK) ON 
			csa.session_id = @session_id
			AND csa.[application] = app.[name]
			AND csa.product = p.[name]
			AND csa.area_id = pa.area_id
			AND csa.sub_area_id = pa.sub_area_id
			AND csa.build_id = pb.build_id
		LEFT JOIN room_sections rs WITH (NOLOCK) ON rs.area_id = pa.area_id AND rs.sub_area_id = pa.sub_area_id
		LEFT JOIN rooms r WITH (NOLOCK) ON r.id = rs.room_id
	WHERE
		pb.is_std = 1
	ORDER BY
		pb.build_desc,
		app.[name],
		p.[name]
END
GO
PRINT N'Creating Procedure [dbo].[vds_selHomebuyerCatalogEstimatedSelections]...';


GO
CREATE PROCEDURE [dbo].[vds_selHomebuyerCatalogEstimatedSelections]
	@session_id UNIQUEIDENTIFIER,
	@builder_overrides_enabled BIT = 0,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 7/29/2019
	Description: Fetches all of the estimated selections, for a homebuyer's catalog. Catalog's
		are identified by a session id.

	Modified: Shelby Mansker
	Date: 11/12/2019
	Description: Don't include existing selections that are linked to sub areas that have been intentionally
		ignored.

	Modified: Shelby Mansker
	Date: 12/17/2019
	Description: Removed the logic for ignoring sub areas.

	Modified: Chris Ragon
	Date: 3/24/2020
	Description: Added JOIN to include room_sections

	Modified: Reid Wilson
	Date: 10/31/2023
	Description: Allow returning builder override part name.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- grab the external organization id for use in picking up builder part overrides
	DECLARE @external_organization_id VARCHAR(20)

	SELECT
		@external_organization_id = external_organization_id
	FROM
		account_organization_user_profile_plan_catalog_sessions aouppcs WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) ON o.organization_id = aouppcs.organization_id
	WHERE
		aouppcs.session_id = @session_id

	SELECT
		selections.*,
		c.[name] AS selected_option_name,
		cs.price AS selected_option_price,
		rs.room_id AS room_id,
		CASE
			WHEN (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				THEN (cco.color_private_label)
			ELSE c.[name]
		END AS selected_option_name_official
	FROM
		homebuyer_catalog_estimated_selections selections WITH (NOLOCK)
		LEFT JOIN Veo_colors c WITH (NOLOCK) ON c.part_no = selections.selected_option_id
		LEFT JOIN catalog_selections cs WITH (NOLOCK) ON cs.session_id = selections.session_id AND cs.build_id = selections.build_id AND cs.item_type = selections.price_level_type AND cs.item_no = selections.price_level_id
		LEFT JOIN room_sections rs WITH (NOLOCK) ON selections.area_id = rs.area_id AND selections.sub_area_id = rs.sub_area_id
		LEFT JOIN veo_colors_customer_overrides cco WITH (NOLOCK) ON cco.part_no = c.part_no AND cco.customer_id = @external_organization_id
	WHERE
		selections.session_id = @session_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selHomebuyerCatalogFieldColorsForBuild]...';


GO
CREATE PROCEDURE [dbo].[vds_selHomebuyerCatalogFieldColorsForBuild]
	@session_id UNIQUEIDENTIFIER,
	@build_id BIGINT,
	@builder_overrides_enabled BIT = 0,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 8/2/2019
	Description: Fetches all of the field colors, across all price levels, in a build.

	Modified:		Roger Wang
	Date:			8/9/2022
	Description:	Include area/sub area when fetching items from group detail.

	Modified:		Roger Wang
	Date:			7/11/2023
	Description:	Filter styles/colors based on plan item in spec_areas_items.

	Modified:		Reid Wilson
	Date:			10/30/2023
	Description:	Allow returning builder override part name.
*/
BEGIN
	-- =====================
	-- Authentication
	-- =====================
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- ============================
	-- Variable Declaration
	-- ============================
	DECLARE @item_class VARCHAR(50) = 'field'
	DECLARE @spec_id INT
	DECLARE @account_id UNIQUEIDENTIFIER
	DECLARE @organization_id UNIQUEIDENTIFIER
	DECLARE @user_id UNIQUEIDENTIFIER
	DECLARE @application_id VARCHAR(10)
	DECLARE @product_id VARCHAR(10)
	DECLARE @area_id VARCHAR(50)
	DECLARE @sub_area_id VARCHAR(50)
	DECLARE @location_id INT
	DECLARE @effective_date DATETIME
	DECLARE @external_organization_id varchar(20)

	SELECT
		@spec_id = vpm.spec_id,
		@application_id = application_id,
		@product_id = product_id,
		@area_id = area_id,
		@sub_area_id = sub_area_id,
		@location_id = location_id,
		@external_organization_id = vsm.builder_id
	FROM
		veo_plan_builds vpb WITH (NOLOCK)
		LEFT JOIN veo_plan_mstr vpm WITH (NOLOCK) ON vpm.plan_id = vpb.plan_id
		LEFT JOIN veo_spec_mstr vsm WITH (NOLOCK) ON vsm.spec_id = vpm.spec_id
	WHERE
		vpb.build_id_num = @build_id

	SELECT
		@account_id = account_id,
		@organization_id = organization_id,
		@user_id = [user_id],
		@effective_date = effective_date
	FROM
		account_organization_user_profile_plan_catalog_sessions
	WHERE
		session_id = @session_id

	-- ============================
	-- Fetch Price Levels for Build
	-- ============================
	DECLARE @price_levels TABLE
	(
		price_level_name VARCHAR(100),
		price_level_type VARCHAR(50),
		price_level_id VARCHAR(81),
		price_level_price DECIMAL(18,2),
		application varchar(100),
		product varchar(100),
		area varchar(100),
		sub_area varchar(100),
		contract_sort_order INT
	)

	INSERT INTO @price_levels (price_level_name, price_level_type, price_level_id, price_level_price, application, product, area, sub_area, contract_sort_order)
	SELECT
		cs.item,
		cs.item_type,
		cs.item_no,
		cs.price,
		cs.application,
		cs.product,
		cs.area,
		cs.sub_area,
		ISNULL(bs.contract_sort_order, 9999999) AS contract_sort_order
	FROM
		catalog_selections cs WITH (NOLOCK)
		LEFT JOIN veo_areas va with (nolock) on va.area_id = cs.area_id
		LEFT JOIN veo_room_groups rg with (nolock) on rg.code = va.room_group
		LEFT JOIN Veo_applications a with (nolock) on a.name = cs.[application]
		LEFT JOIN Veo_products p with (nolock) on p.name = cs.product
		LEFT JOIN account_organization_user_profile_plan_catalog_sessions s with (nolock) on s.session_id = cs.session_id
		LEFT JOIN Veo_builder_styles bs with (nolock)
		ON bs.spec_id = s.spec_id
		AND bs.application_id = a.application_id
		AND bs.product_id = p.product_id
		AND bs.item_type = cs.item_type
		AND bs.item = cs.item_no
		AND bs.effective_date = s.effective_date
	WHERE
		cs.session_id = @session_id
		AND cs.build_id = @build_id
		AND cs.item_type <> 'custom'

	-- ============================
	-- Initialize Colors Table
	-- ============================
	IF OBJECT_ID('tempdb.dbo.#colors') IS NOT NULL DROP TABLE #colors

	CREATE TABLE #colors
	(
		price_level_name VARCHAR(100),
		price_level_type VARCHAR(50),
		price_level_id VARCHAR(81),
		price_level_price DECIMAL(18,2),
		application varchar(100),
		product varchar(100),
		area varchar(100),
		sub_area varchar(100),
		contract_sort_order INT,
		product_id VARCHAR(10),
		style_id VARCHAR(50),
		color_id VARCHAR(50),
		part_name VARCHAR(100),
		part_no VARCHAR(100),
		stocking_code VARCHAR(10),
		global_product_id UNIQUEIDENTIFIER,
		part_name_official varchar(150)
	)

	-- =========================================
	-- spec_items --> groups -> styles -> colors
	-- =========================================
	MERGE #colors AS TARGET
	USING
	(
		SELECT DISTINCT
			pl.price_level_name,
			pl.price_level_type,
			pl.price_level_id,
			pl.price_level_price,
			pl.application,
			pl.product,
			pl.area,
			pl.sub_area,
			pl.contract_sort_order,
			c.product_id,
			c.style_id,
			c.color_id,
			c.[name],
			c.part_no,
			c.stocking_code,
			c.global_product_id,
			case
				when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
					then (cco.color_private_label)
				else c.[name]
			end as part_name_official
		FROM
			@price_levels pl
			JOIN veo_spec_items si WITH (NOLOCK) ON si.item_type = pl.price_level_type AND si.item = pl.price_level_id
			LEFT JOIN Veo_styles_groups sg WITH (NOLOCK) ON sg.group_id = si.item
			LEFT JOIN catalog_selections_group_detail sgd WITH (NOLOCK) ON sgd.group_id = sg.group_id
			LEFT JOIN Veo_styles s WITH (NOLOCK) ON s.product_id = sg.product_id AND s.style_id = sgd.item
			LEFT JOIN veo_colors c WITH (NOLOCK) ON c.product_id = s.product_id AND c.style_id = s.style_id
			LEFT JOIN veo_colors_customer_overrides cco WITH (NOLOCK) ON cco.part_no = c.part_no AND cco.customer_id = @external_organization_id
		WHERE
			pl.price_level_type = 'group'
			AND si.spec_id = @spec_id
			AND si.application_id = @application_id
			AND si.product_id = @product_id
			AND sgd.session_id = @session_id
			AND sgd.item_type = 'style'
			AND ISNULL(sgd.area_id, '') in ('', @area_id)
			AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
			AND s.class = @item_class
	) AS SOURCE
	ON TARGET.price_level_id = SOURCE.price_level_id AND TARGET.part_no = SOURCE.part_no
	WHEN NOT MATCHED THEN
		INSERT
			(price_level_name, price_level_type, price_level_id, price_level_price, application, product, area, sub_area, contract_sort_order, product_id, style_id, color_id, part_name, part_no, stocking_code, global_product_id, part_name_official)
		VALUES
			(SOURCE.price_level_name, SOURCE.price_level_type, SOURCE.price_level_id, SOURCE.price_level_price, SOURCE.application, SOURCE.product, SOURCE.area, SOURCE.sub_area, SOURCE.contract_sort_order, SOURCE.product_id, SOURCE.style_id, SOURCE.color_id, SOURCE.[name], SOURCE.part_no, SOURCE.stocking_code, SOURCE.global_product_id, SOURCE.part_name_official);

	-- =========================================
	-- spec_items --> groups -> colors
	-- =========================================
	MERGE #colors AS TARGET
	USING
	(
		SELECT DISTINCT
			pl.price_level_name,
			pl.price_level_type,
			pl.price_level_id,
			pl.price_level_price,
			pl.application,
			pl.product,
			pl.area,
			pl.sub_area,
			pl.contract_sort_order,
			c.product_id,
			c.style_id,
			c.color_id,
			c.[name],
			c.part_no,
			c.stocking_code,
			c.global_product_id,
			case
				when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
					then (cco.color_private_label)
				else c.[name]
			end as part_name_official
		FROM
			@price_levels pl
			JOIN veo_spec_items si WITH (NOLOCK) ON si.item_type = pl.price_level_type AND si.item = pl.price_level_id
			LEFT JOIN veo_styles_groups sg WITH (NOLOCK) ON sg.group_id = si.item
			LEFT JOIN catalog_selections_group_detail sgd WITH (NOLOCK) ON sgd.group_id = sg.group_id
			LEFT JOIN veo_colors c WITH (NOLOCK) ON c.part_no = sgd.item
			LEFT JOIN veo_styles s WITH (NOLOCK) ON s.product_id = c.product_id AND s.style_id = c.style_id
			LEFT JOIN veo_colors_customer_overrides cco WITH (NOLOCK) ON cco.part_no = c.part_no AND cco.customer_id = @external_organization_id
		WHERE
			pl.price_level_type = 'group'
			AND si.spec_id = @spec_id
			AND si.application_id = @application_id
			AND si.product_id = @product_id
			AND sgd.session_id = @session_id
			AND sgd.item_type = 'color'
			AND ISNULL(sgd.area_id, '') in ('', @area_id)
			AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
			AND s.class = @item_class
	) AS SOURCE
	ON TARGET.price_level_id = SOURCE.price_level_id AND TARGET.part_no = SOURCE.part_no
	WHEN NOT MATCHED THEN
		INSERT
			(price_level_name, price_level_type, price_level_id, price_level_price, application, product, area, sub_area, contract_sort_order, product_id, style_id, color_id, part_name, part_no, stocking_code, global_product_id, part_name_official)
		VALUES
			(SOURCE.price_level_name, SOURCE.price_level_type, SOURCE.price_level_id, SOURCE.price_level_price,SOURCE.application, SOURCE.product, SOURCE.area, SOURCE.sub_area, SOURCE.contract_sort_order, SOURCE.product_id, SOURCE.style_id, SOURCE.color_id, SOURCE.[name], SOURCE.part_no, SOURCE.stocking_code, SOURCE.global_product_id, SOURCE.part_name_official);

	-- =========================================
	-- spec_items --> styles -> colors
	-- =========================================
	MERGE #colors AS TARGET
	USING
	(
		SELECT DISTINCT
			pl.price_level_name,
			pl.price_level_type,
			pl.price_level_id,
			pl.price_level_price,
			pl.application,
			pl.product,
			pl.area,
			pl.sub_area,
			pl.contract_sort_order,
			c.product_id,
			c.style_id,
			c.color_id,
			c.[name],
			c.part_no,
			c.stocking_code,
			c.global_product_id,
			case
				when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
					then (cco.color_private_label)
				else c.[name]
			end as part_name_official
		FROM
			@price_levels pl
			JOIN veo_spec_items si WITH (NOLOCK) ON si.item_type = pl.price_level_type AND si.item = pl.price_level_id
			LEFT JOIN veo_colors c WITH (NOLOCK) ON c.product_id = si.product_id AND c.style_id = si.item
			LEFT JOIN veo_styles s WITH (NOLOCK) ON s.product_id = c.product_id AND s.style_id = c.style_id
			LEFT JOIN veo_colors_customer_overrides cco WITH (NOLOCK) ON cco.part_no = c.part_no AND cco.customer_id = @external_organization_id
		WHERE
			pl.price_level_type = 'style'
			AND si.spec_id = @spec_id
			AND si.application_id = @application_id
			AND si.product_id = @product_id
			AND s.class = @item_class
	) AS SOURCE
	ON TARGET.price_level_id = SOURCE.price_level_id AND TARGET.part_no = SOURCE.part_no
	WHEN NOT MATCHED THEN
		INSERT
			(price_level_name, price_level_type, price_level_id, price_level_price, application, product, area, sub_area, contract_sort_order, product_id, style_id, color_id, part_name, part_no, stocking_code, global_product_id, part_name_official)
		VALUES
			(SOURCE.price_level_name, SOURCE.price_level_type, SOURCE.price_level_id, SOURCE.price_level_price, SOURCE.application, SOURCE.product, SOURCE.area, SOURCE.sub_area, SOURCE.contract_sort_order, SOURCE.product_id, SOURCE.style_id, SOURCE.color_id, SOURCE.[name], SOURCE.part_no, SOURCE.stocking_code, SOURCE.global_product_id, SOURCE.part_name_official);

	-- =========================================
	-- spec_items --> colors
	-- =========================================
	MERGE #colors AS TARGET
	USING
	(
		SELECT DISTINCT
			pl.price_level_name,
			pl.price_level_type,
			pl.price_level_id,
			pl.price_level_price,
			pl.application,
			pl.product,
			pl.area,
			pl.sub_area,
			pl.contract_sort_order,
			c.product_id,
			c.style_id,
			c.color_id,
			c.[name],
			c.part_no,
			c.stocking_code,
			c.global_product_id,
			case
				when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
					then (cco.color_private_label)
				else c.[name]
			end as part_name_official
		FROM
			@price_levels pl
			JOIN veo_spec_items si WITH (NOLOCK) ON si.item_type = pl.price_level_type AND si.item = pl.price_level_id
			LEFT JOIN veo_colors c WITH (NOLOCK) ON c.part_no = si.item
			LEFT JOIN veo_styles s WITH (NOLOCK) ON s.product_id = c.product_id AND s.style_id = c.style_id
			LEFT JOIN veo_colors_customer_overrides cco WITH (NOLOCK) ON cco.part_no = c.part_no AND cco.customer_id = @external_organization_id
		WHERE
			pl.price_level_type = 'color'
			AND si.spec_id = @spec_id
			and si.application_id = @application_id
			and si.product_id = @product_id
			and s.class = @item_class
	) AS SOURCE
	ON TARGET.price_level_id = SOURCE.price_level_id AND TARGET.part_no = SOURCE.part_no
	WHEN NOT MATCHED THEN
		INSERT
			(price_level_name, price_level_type, price_level_id, price_level_price, application, product, area, sub_area, contract_sort_order, product_id, style_id, color_id, part_name, part_no, stocking_code, global_product_id, part_name_official)
		VALUES
			(SOURCE.price_level_name, SOURCE.price_level_type, SOURCE.price_level_id, SOURCE.price_level_price, SOURCE.application, SOURCE.product, SOURCE.area, SOURCE.sub_area, SOURCE.contract_sort_order, SOURCE.product_id, SOURCE.style_id, SOURCE.color_id, SOURCE.[name], SOURCE.part_no, SOURCE.stocking_code, SOURCE.global_product_id, SOURCE.part_name_official);


	-- =======================================================
	-- remove parts explicitly excluded from spec area
	-- =======================================================
	IF @spec_id <> 0 AND EXISTS( SELECT TOP 1 line_no FROM veo_spec_areas_items WHERE spec_id = @spec_id)
	BEGIN
		DELETE
			c
		FROM
			#colors c
		inner join
			dbo.vdsf_selSpecAreaExcludedParts(@session_id, @spec_id, @application_id, @product_id, @area_id, @sub_area_id, @location_id, 'field') e on e.part_no = c.part_no
	END

	SELECT
		c.*,
		IIF(wl.wishlist_item_id IS NULL, 0, 1) is_wish_listed,	
		IIF((SELECT COUNT(*) FROM Veo_photo_attributes_values WHERE attribute_id = 7 AND value = c.part_no) > 0, 1, 0) AS has_installation_photos
	FROM
		#colors c
		LEFT JOIN Veo_stocking_codes vsc WITH (NOLOCK) ON vsc.code = c.stocking_code
		LEFT JOIN account_organization_user_wishlist_items wl ON wl.account_id = @account_id AND wl.organization_id = @organization_id AND wl.[user_id] = @user_id AND wl.item_type = 'PART' AND wl.item_no = c.part_no
	WHERE
		vsc.homebuyer_selectable = 1
	ORDER BY
		has_installation_photos DESC
END
GO
PRINT N'Creating Procedure [dbo].[vds_selHomebuyerCatalogGeneralOptions]...';


GO
CREATE PROCEDURE [dbo].[vds_selHomebuyerCatalogGeneralOptions]
	@session_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Create Date: 8/7/2019
	Description: Fetches all general options for the specified session.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT DISTINCT
		RTRIM(LTRIM(cs.[application])) as [application],
		RTRIM(LTRIM(cs.product)) as product,
		ai.icon_id
	FROM 
		catalog_selections cs with (nolock)
	LEFT JOIN application_icon ai ON cs.[application] = ai.[application]
	WHERE 
		cs.session_id = @session_id
		AND (cs.is_credit = 0)
		AND (cs.item != 'User')
		AND cs.[source] = 'Catalog'
		AND cs.option_pricing_display = 1
END
GO
PRINT N'Creating Procedure [dbo].[vds_selHomebuyerCatalogGeneralOptionsForRooms]...';


GO
CREATE PROCEDURE [dbo].[vds_selHomebuyerCatalogGeneralOptionsForRooms]
	@session_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Create Date: 9/1/2022
	Description: Fetches general options for the specified session that has room information.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT DISTINCT
		RTRIM(LTRIM(cs.[application])) as [application],
		RTRIM(LTRIM(cs.product)) as product,
		r.id AS room_id,
		r.[name] AS room_name,
		a.[name] AS veo_area,
		sa.[name] AS veo_sub_area
	FROM 
		catalog_selections cs with (nolock)
		INNER JOIN room_sections rs WITH (NOLOCK) ON rs.area_id = cs.area AND rs.sub_area_id = cs.sub_area
		INNER JOIN rooms r WITH (NOLOCK) ON r.id = rs.room_id
		LEFT JOIN veo_areas a WITH (NOLOCK) ON a.area_id = cs.area
		LEFT JOIN veo_sub_areas sa WITH (NOLOCK) ON sa.sub_area_id = cs.sub_area
	WHERE 
		cs.session_id = @session_id
		AND (cs.is_credit = 0)
		AND (cs.item != 'User')
		AND cs.[source] = 'Catalog'
		AND cs.option_pricing_display = 1
END
GO
PRINT N'Creating Procedure [dbo].[vds_selHomebuyerCatalogNonestimatedSelections]...';


GO
CREATE PROCEDURE [dbo].[vds_selHomebuyerCatalogNonestimatedSelections]
	@session_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 7/29/2019
	Description: Fetches all of the non-estimated selections, for a homebuyer's catalog. Catalog's
		are identified by a session id.

	Modified: Roger Wang
	Date: 9/1/2022
	Description: Included room information in the response.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		s.*,
		c.[application],
		c.product,
		c.price AS total,
		c.item AS item_description,
		c.gpc,
		c.option_id,
		c.is_package,
		r.id AS room_id,
		r.[name] AS room_name,
		a.[name] AS veo_area,
		sa.[name] AS veo_sub_area
	FROM
		homebuyer_catalog_nonestimated_selections s
	INNER JOIN
		catalog_selections c ON c.session_id = s.session_id AND c.row_id = s.row_id
	LEFT JOIN
		room_sections rs WITH (NOLOCK) ON rs.area_id = c.area AND rs.sub_area_id = c.sub_area
	LEFT JOIN
		rooms r WITH (NOLOCK) ON r.id = rs.room_id
	LEFT JOIN
		veo_areas a WITH (NOLOCK) ON a.area_id = c.area
	LEFT JOIN
		veo_sub_areas sa WITH (NOLOCK) ON sa.sub_area_id = c.sub_area
	WHERE
		s.session_id = @session_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selHomebuyerCatalogPriceLevelFilters]...';


GO
CREATE PROCEDURE [dbo].[vds_selHomebuyerCatalogPriceLevelFilters]
	@session_id UNIQUEIDENTIFIER,
	@room_id UNIQUEIDENTIFIER,
	@application_id VARCHAR(50),
	@product_id VARCHAR(50),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 4/18/2022
	Description: Gets price level filters by session/room/application/product
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		*
	FROM
		[dbo].[homebuyer_catalog_price_level_filters] hcplf WITH (NOLOCK)
	WHERE
		hcplf.[session_id] = @session_id
		AND hcplf.[room_id] = @room_id
		AND hcplf.[application_id] = @application_id
		AND hcplf.[product_id] = @product_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selHomebuyerOrientation]...';


GO
CREATE PROCEDURE [dbo].[vds_selHomebuyerOrientation]
	@user_id UNIQUEIDENTIFIER, 
	@object_type NVARCHAR(100),
	@security_token UNIQUEIDENTIFIER 
AS
/*
   Author:		Robert Hobbs
   Create date: 04/09/18
   Description:	fetches homebuyer orientation data. The data in @object_data 
   is JSON data, and it's meta data is @object_type and version in @schema_version. 
 */
 BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END
	SELECT * FROM 
		homebuyer_orientation
	WHERE 
		[user_id] = @user_id 
		AND object_type = @object_type 

END
GO
PRINT N'Creating Procedure [dbo].[vds_selIncompleteHomebuyersWithPagingAndSorting]...';


GO
CREATE PROCEDURE [dbo].[vds_selIncompleteHomebuyersWithPagingAndSorting]
    @page_index INT = 0,
    @page_size INT = 8,
    @order_by VARCHAR(MAX),
    @order_by_direction VARCHAR(4),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:	 Shelby Mansker
	Create date: 5/27/2014
	Description: Returns all of the incomplete homebuyer sessions based ON
	    the passed in user id

    Modified ON 11/14/2014 by Shelby Mansker
        No longer using the legacy proc vs_selMyIncompleteHomebuyers. Moved the code
        into this proc so that we can modify it without messing up VeoSolutions.
        The new code is designed to return information similar to vds_selDesignSessions
        proc. It also only returns information for organizations where the user has
        an active account. Finally, it no longer requires both a user id and a security token,
        since the user id can be fetched from the token.

    Modified 01/29/2014.
        Implemented server side paging and sorting. Saul.

    Modified 02/17/2015
        Fixed a bug that where it wouldn't return a designers sessions properly. - Shelby

	Modified 10/25/2019 - Eric Hickey
		No longer return profile plans that are 'Active', as that status has been merged with 'Contracted'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Get the current user id from the security token
	DECLARE @user_id UNIQUEIDENTIFIER = dbo.ef_getUserIdFromSecurityToken(@security_token)
	DECLARE @prospective_status_feature INT
	SET @prospective_status_feature = 20

    -- Get the current user full name
    DECLARE @active_user_fullname VARCHAR(101)
    SELECT
        @active_user_fullname = first_name + ' ' + last_name
    FROM
        VeoSolutionsSecurity_users WITH (NOLOCK)
    WHERE
        [user_id] = @user_id

    -- Determine if user is sysadmin
    DECLARE @is_sysadmin BIT = 0
    SELECT 
        @is_sysadmin = COUNT(*)
    FROM 
        VeoSolutionsSecurity_users vssu WITH (NOLOCK)
        LEFT JOIN VeoSolutionsSecurity_account_organization_users aou WITH (NOLOCK) ON aou.[user_id] = vssu.[user_id]
        LEFT JOIN VeoSolutionsSecurity_account_organization_users_roles_legacy aour WITH (NOLOCK) ON aour.account_id = aou.account_id AND aour.organization_id = aou.organization_id AND aour.[user_id] = @user_id
        LEFT JOIN VeoSolutionsSecurity_roles_legacy r WITH (NOLOCK) ON r.role_id = aour.role_id
    WHERE 
	    vssu.[user_id] = @user_id 
        AND r.name = 'System Administrator'

    -- Locate the incomplete sessions
	SELECT 
        aouppcs.session_id,
        ss.[status] AS session_status,
		u.first_name + ' ' + u.last_name AS homebuyer_fullname,
		u.email AS homebuyer_email,
        aoupp.profile_id,
        o.name AS builder_name,
        aoupp.[address] AS street_address,
        aoupp.lot,
		aoupp.block,
        aouppcs.community_name,
        aouppcs.series,
        aouppcs.plan_name,
        overall_count = COUNT(*) OVER()
	FROM
        VeoSolutionsSecurity_account_organization_users aou WITH (NOLOCK)
		JOIN veosolutionssecurity_organizations o WITH (NOLOCK) ON aou.organization_id = o.organization_id
		JOIN dbo.account_organization_user_profile_plan aoupp WITH (NOLOCK) ON aou.account_id = aoupp.account_id AND aou.organization_id = aoupp.organization_id
		JOIN dbo.account_organization_user_profile_plan_catalog_sessions aouppcs ON aoupp.account_id = aouppcs.account_id AND aoupp.organization_id = aouppcs.organization_id AND aoupp.[user_id] = aouppcs.[user_id] AND aoupp.community_name = aouppcs.community_name AND aoupp.series = aouppcs.series AND aoupp.plan_name = aouppcs.plan_name
        LEFT JOIN VeoSolutionsSecurity_users u WITH (NOLOCK) ON u.[user_id] = aoupp.[user_id]
		LEFT JOIN dbo.session_statuses ss WITH (NOLOCK) ON ss.status_id = aouppcs.[status]
	WHERE
        aou.[user_id] = @user_id
        AND aou.active = 1
        AND aouppcs.[status] in (1,4)-- 'active,pending'
	    AND (
				aoupp.[status] = 'Contracted'
				OR
				(aoupp.[status] = 'Active' AND [dbo].vdsf_isOrganizationFeatureOn(aou.organization_id, @prospective_status_feature) = 0) -- include 'active' if the organization is not using the Prospective Status Feature
			)
	    AND ((aouppcs.designer = @active_user_fullname) OR (@is_sysadmin = 1)) -- only show sessions that are assigned this designer or any session if sysadmin
    ORDER BY
        CASE WHEN @order_by = 'UserFullName' AND @order_by_direction = 'desc' THEN u.first_name END DESC,
        CASE WHEN @order_by = 'UserFullName' AND @order_by_direction = 'desc' THEN u.last_name END DESC,
        CASE WHEN @order_by = 'UserFullName' AND @order_by_direction <> 'desc' THEN u.first_name END,
        CASE WHEN @order_by = 'UserFullName' AND @order_by_direction <> 'desc' THEN u.last_name END,
        CASE WHEN @order_by = 'BuilderName' AND @order_by_direction = 'desc' THEN o.name END DESC,
        CASE WHEN @order_by = 'BuilderName' AND @order_by_direction <> 'desc' THEN o.name END,
        CASE WHEN @order_by = 'UserEmail' AND @order_by_direction = 'desc' THEN u.email END DESC,
        CASE WHEN @order_by = 'UserEmail' AND @order_by_direction <> 'desc' THEN u.email END,
        CASE WHEN @order_by = 'StreetAddress' AND @order_by_direction = 'desc' THEN aoupp.[address] END DESC,
        CASE WHEN @order_by = 'StreetAddress' AND @order_by_direction <> 'desc' THEN aoupp.[address] END,
        CASE WHEN @order_by = 'Lot' AND @order_by_direction = 'desc' THEN aoupp.lot END DESC,
        CASE WHEN @order_by = 'Lot' AND @order_by_direction <> 'desc' THEN aoupp.lot END,
        CASE WHEN @order_by = 'Block' AND @order_by_direction = 'desc' THEN aoupp.block END DESC,
        CASE WHEN @order_by = 'Block' AND @order_by_direction <> 'desc' THEN aoupp.block END,
        CASE WHEN @order_by = 'Status' AND @order_by_direction = 'desc' THEN ss.[status] END DESC,
        CASE WHEN @order_by = 'Status' AND @order_by_direction <> 'desc' THEN ss.[status] END
    OFFSET @page_index * @page_size ROWS
    FETCH NEXT @page_size ROWS ONLY
END
GO
PRINT N'Creating Procedure [dbo].[vds_selInstalledProductPhotoAreas]...';


GO
CREATE PROCEDURE [dbo].[vds_selInstalledProductPhotoAreas] 
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @product_id VARCHAR(20) = 'ALL', 
	@security_token UNIQUEIDENTIFIER 
AS
/*
    Author: Robert Hobbs
    Date: 08/09/18
    Description: 
	Fetches distinct Area attributes for photos for the builder + product.
	
	TESTING 
	vds_selInstalledProductPhotoAreas  '1EEAA9A3-CD2A-43B2-A727-37F5ACBCB7AC', '49687F1F-DEC8-484D-B7C3-C193DA7C873D', '6', '01234567-89AB-CDEF-0000-123456789ABC'

   */
BEGIN

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Get the echelon customer id for the account organization
    DECLARE @customer_id VARCHAR(15)
    SELECT
        @customer_id = custnmbr
    FROM
        VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK)
        JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) on o.organization_id = ao.organization_id
        JOIN Veo_customers customer WITH (NOLOCK) ON customer.custnmbr = o.external_organization_id
    WHERE
        ao.account_id = @account_id
        AND ao.organization_id = @organization_id

    IF (@customer_id is NULL)
	BEGIN
		RAISERROR('Could not find Customer Id',16,1)
		RETURN
	END

	-- customer 'program' is all styles, colors defined for a builder with no end date 
	DECLARE @customer_program TABLE
	( 
		item_type VARCHAR(10), 
		item VARCHAR(81)
	)

	INSERT INTO 
		@customer_program 
	SELECT
		item_type, 
		item 
	FROM 
		Veo_styles_groups_detail 
	WHERE 
		customer_id = @customer_id 
		AND end_date is NULL 

	DECLARE @photo_areas TABLE
	( 
		area_id NVARCHAR(20)
	)

	
	INSERT INTO 
		@photo_areas 
	SELECT 
		DISTINCT 
		photo_areas.area_id
	FROM
		dbo.Veo_photos p WITH (NOLOCK) 
		CROSS APPLY
        (
            SELECT
                value AS part_no
            FROM
                dbo.Veo_photo_attributes_values WITH (NOLOCK)
            WHERE
                photo_id = p.photo_id
                AND attribute_id = 7 -- Part No
        ) photo_parts
		CROSS APPLY 
		(
			SELECT 
				item
			FROM
				dbo.Veo_colors c
				JOIN @customer_program cp ON cp.item_type = 'color' AND cp.item = c.part_no
			WHERE 
				c.part_no = photo_parts.part_no 
				AND (c.product_id = @product_id OR @product_id = 'ALL') 
		) items
		CROSS APPLY
        (
            SELECT
                value AS area_id
            FROM
                dbo.Veo_photo_attributes_values WITH (NOLOCK)
            WHERE
                photo_id = p.photo_id
                AND attribute_id = 5
        ) photo_areas
	WHERE
		items.item IS NOT NULL
		AND photo_areas.area_id IS NOT NULL 

	INSERT INTO 
		@photo_areas 
	SELECT DISTINCT 
		photo_areas.area_id
	FROM
		dbo.Veo_photos p WITH (NOLOCK) 
		CROSS APPLY
        (
            SELECT
                value AS part_no
            FROM
                dbo.Veo_photo_attributes_values WITH (NOLOCK)
            WHERE
                photo_id = p.photo_id
                AND attribute_id = 7 -- Part No
        ) photo_parts
		CROSS APPLY 
		(
			SELECT 
				item
			FROM
				dbo.Veo_colors c
				JOIN @customer_program cp ON cp.item_type = 'style' AND cp.item = c.style_id
			WHERE 
				(c.product_id = @product_id OR @product_id = 'ALL')
				AND c.part_no = photo_parts.part_no 
		) items
		CROSS APPLY
        (
            SELECT
                value AS area_id
            FROM
                dbo.Veo_photo_attributes_values WITH (NOLOCK)
            WHERE
                photo_id = p.photo_id
                AND attribute_id = 5 
        ) photo_areas
	WHERE
		items.item IS NOT NULL 
		AND photo_areas.area_id IS NOT NULL

	--SELECT * FROM @photo_areas 

	-- for each area, get atttribute details 
	SELECT 
	DISTINCT 
		pa.attribute_id as PhotoAttributeId, 
		pa.description as AttributeType, 
		a.area_id as AttributeValueId, 
		ISNULL(va.name, a.area_id) as AttributeValueDescription
	FROM 
		@photo_areas a 
		LEFT JOIN dbo.veo_areas va ON va.area_id = a.area_id 
		JOIN dbo.veo_photo_attributes pa ON pa.attribute_id = 5 

END
GO
PRINT N'Creating Procedure [dbo].[vds_selInstalledProductPhotoProducts]...';


GO
CREATE PROCEDURE [dbo].[vds_selInstalledProductPhotoProducts]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Get the echelon customer id for the account organization
    DECLARE @customer_id VARCHAR(15)
    SELECT
        @customer_id = custnmbr
    FROM
        VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK)
        JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) on o.organization_id = ao.organization_id
        JOIN Veo_customers customer WITH (NOLOCK) ON customer.custnmbr = o.external_organization_id
    WHERE
        ao.account_id = @account_id
        AND ao.organization_id = @organization_id

    IF (@customer_id is NULL)
	BEGIN
		RAISERROR('Could not find Customer Id',16,1)
		RETURN
	END

	DECLARE @customer_program TABLE
	(
		item_type VARCHAR(10),
		item VARCHAR(81)
	)

	INSERT INTO
		@customer_program
	SELECT
		item_type,
		item
	FROM
		Veo_styles_groups_detail
	WHERE
		customer_id = @customer_id
		AND end_date is NULL

	-- fetch photos with parts matching the program values
	SELECT
		vp.product_id,
		vp.name as product_name
	FROM (
		SELECT
			items.product_id
		FROM
			dbo.Veo_photos p WITH (NOLOCK)
			CROSS APPLY
			(
				SELECT
					value AS part_no
				FROM
					dbo.Veo_photo_attributes_values WITH (NOLOCK)
				WHERE
					photo_id = p.photo_id
					AND attribute_id = 7 -- Part No
			) photo_parts
			CROSS APPLY
			(
				SELECT
					c.product_id, item
				FROM
					dbo.Veo_colors c
					JOIN @customer_program cp ON cp.item_type = 'color' AND cp.item = c.part_no
				WHERE
					c.part_no = photo_parts.part_no
			) items
		WHERE
			items.item IS NOT NULL
	
		UNION

		SELECT
			items.product_id
		FROM
			dbo.Veo_photos p WITH (NOLOCK)
			CROSS APPLY
			(
				SELECT
					value AS part_no
				FROM
					dbo.Veo_photo_attributes_values WITH (NOLOCK)
				WHERE
					photo_id = p.photo_id
					AND attribute_id = 7 -- Part No
			) photo_parts
			CROSS APPLY 
			(
				SELECT
					c.product_id, item
				FROM
					dbo.Veo_colors c
					JOIN @customer_program cp ON cp.item_type = 'style' AND cp.item = c.style_id
				WHERE
					c.part_no = photo_parts.part_no
			) items
		WHERE
			items.item IS NOT NULL
	) ph
	INNER JOIN
		dbo.Veo_products vp ON vp.product_id = ph.product_id
	ORDER BY
		vp.name
END
GO
PRINT N'Creating Procedure [dbo].[vds_selInstalledProductPhotos]...';


GO
CREATE PROCEDURE [dbo].[vds_selInstalledProductPhotos] 
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @product_id VARCHAR(20) = 'ALL', 
	@area_id VARCHAR(20) = '', 
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Robert Hobbs
    Date: 07/18/18
    Description: Fetches photo IDs for any photos tagged with parts that are: 
	- in the builder's program (styles_group_detail)
	- with a product that matches the product passed (optional) 
	- with an area attribute matching the area passed (optional) 
	
	TESTING 
	vds_selInstalledProductPhotos  '1EEAA9A3-CD2A-43B2-A727-37F5ACBCB7AC', '49687F1F-DEC8-484D-B7C3-C193DA7C873D', '', '', '01234567-89AB-CDEF-0000-123456789ABC'
   */
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Get the echelon customer id for the account organization
    DECLARE @customer_id VARCHAR(15)
    SELECT
        @customer_id = custnmbr
    FROM
        VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK)
        JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) on o.organization_id = ao.organization_id
        JOIN Veo_customers customer WITH (NOLOCK) ON customer.custnmbr = o.external_organization_id
    WHERE
        ao.account_id = @account_id
        AND ao.organization_id = @organization_id

    IF (@customer_id is NULL)
	BEGIN
		RAISERROR('Could not find Customer Id',16,1)
		RETURN
	END

	DECLARE @customer_program TABLE
	( 
		item_type VARCHAR(10), 
		item VARCHAR(81)
	)

	INSERT INTO 
		@customer_program 
	SELECT
		item_type, 
		item 
	FROM 
		Veo_styles_groups_detail 
	WHERE 
		customer_id = @customer_id 
		AND end_date is NULL 

	-- fetch photos with parts matching the program values
	SELECT 
		p.photo_id
	FROM
		dbo.Veo_photos p WITH (NOLOCK) 
		CROSS APPLY
        (
            SELECT
                value AS part_no
            FROM
                dbo.Veo_photo_attributes_values WITH (NOLOCK)
            WHERE
                photo_id = p.photo_id
                AND attribute_id = 7 -- Part No
        ) photo_parts
		CROSS APPLY 
		(
			SELECT 
				item
			FROM
				dbo.Veo_colors c
				JOIN @customer_program cp ON cp.item_type = 'color' AND cp.item = c.part_no
			WHERE 
				c.part_no = photo_parts.part_no 
				AND (c.product_id = @product_id OR @product_id = 'ALL') 
		) items
		CROSS APPLY
        (
            SELECT
                value AS area_id
            FROM
                dbo.Veo_photo_attributes_values WITH (NOLOCK)
            WHERE
                photo_id = p.photo_id
                AND (attribute_id = 5 OR @area_id = '') -- area
        ) photo_areas
	WHERE
		items.item IS NOT NULL
		AND (photo_areas.area_id = @area_id OR @area_id = '')
	
	UNION 

	SELECT 
		p.photo_id
	FROM
		dbo.Veo_photos p WITH (NOLOCK) 
		CROSS APPLY
        (
            SELECT
                value AS part_no
            FROM
                dbo.Veo_photo_attributes_values WITH (NOLOCK)
            WHERE
                photo_id = p.photo_id
                AND attribute_id = 7 -- Part No
        ) photo_parts
		CROSS APPLY 
		(
			SELECT 
				item
			FROM
				dbo.Veo_colors c
				JOIN @customer_program cp ON cp.item_type = 'style' AND cp.item = c.style_id
			WHERE 
				(c.product_id = @product_id OR @product_id = 'ALL')
				AND c.part_no = photo_parts.part_no 
		) items
			CROSS APPLY
        (
            SELECT
                value AS area_id
            FROM
                dbo.Veo_photo_attributes_values WITH (NOLOCK)
            WHERE
                photo_id = p.photo_id
                AND (attribute_id = 5 OR @area_id = '') -- area
        ) photo_areas
	WHERE
		items.item IS NOT NULL 
		AND (photo_areas.area_id = @area_id OR @area_id = '')

END
GO
PRINT N'Creating Procedure [dbo].[vds_selItemPricingData]...';


GO
CREATE PROCEDURE [dbo].[vds_selItemPricingData]
    @create_date DATETIME,
    @external_organization_id VARCHAR(20),
    @application_id VARCHAR(10),
    @product_id VARCHAR(10),
    @area_id VARCHAR(10),
    @sub_area_id VARCHAR(10),
    @spec_id INT,
    @plan_name VARCHAR(50),
    @build_id INT,
    @item_type VARCHAR(20),
    @real_item_id VARCHAR(81),
    @uom VARCHAR(9),
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author:      Saul Sanchez
    Create date: 07/15/2014
    Description: This stored procedure returns pricing data for a
        single part item.
*/
BEGIN
    --=================================================================
    -- Validate the security token.
    --=================================================================
    IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
    BEGIN
	    RAISERROR('Access Denied.',16,1)
	    RETURN
    END

    --=================================================================
    -- Declare variables.
    --=================================================================
    DECLARE @pricing_data TABLE (
    item_price DECIMAL(18,2),
    item_price_retail DECIMAL(18,2),
    price_type VARCHAR(10),
    pricing_layer VARCHAR(200),
    retail_percentage DECIMAL(18,2),
    retail_percentage_type VARCHAR(20)
    )

    INSERT INTO @pricing_data
        EXEC Veo_vs_selItemPrice @create_date, @external_organization_id, @application_id, @product_id, @area_id, @sub_area_id, @spec_id, @plan_name, @build_id, @item_type, '', @real_item_id, @uom

    --=================================================================
    -- Return the pricing data.
    --=================================================================
    SELECT
        *
    FROM
        @pricing_data

END
GO
PRINT N'Creating Procedure [dbo].[vds_selLaborImageData]...';


GO
CREATE PROCEDURE [dbo].[vds_selLaborImageData]
	@labor_code VARCHAR(10)
AS
/*
    Author: Saul Sanchez
    Date: 5/27/2015
    Description: Returns the image data for the specified labor code from the labor_codes table in Veo.
                 This method is not secured intentionally, as it may be called
                 without access to a security token.
*/
BEGIN
	SELECT
        image_data
    FROM
        dbo.Veo_labor_codes
    WHERE
        code = @labor_code
END
GO
PRINT N'Creating Procedure [dbo].[vds_selLargePhoto]...';


GO
CREATE procedure [dbo].[vds_selLargePhoto]
@photo_id as int
as

-- HISTORY 
-- created: 10.03.14 - RH 

-- TESTING 
-- vds_selLargePhoto 55

SELECT 
	photo_data  
FROM
	Veo_photos with (nolock)  
WHERE 
	photo_id = @photo_id
GO
PRINT N'Creating Procedure [dbo].[vds_selLastImpersonatedUsers]...';


GO
/*
	Modified 10/25/2019 - Eric Hickey
		No longer return profile plans that are 'Active', as that status has been merged with 'Contracted'
*/

CREATE procedure [dbo].[vds_selLastImpersonatedUsers]

@number_of_impersonations int = 3,
@security_token uniqueidentifier

as

-- testing: 
-- simulate a login to generate a new security token for: 
-- michelle@designer.com: 23DEC263-C2FE-4A85-B955-5B397984065A
-- veosolutionssecurity.dbo.vds_authenticate_user 'michelle@designer.com','zz'
--
-- test the proc (paste new security token as 2nd param):  
-- vds_selLastImpersonatedUsers 5, 'D0350A9B-7472-475C-BE44-1484B5E277A6'

IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

declare @user_id uniqueidentifier
select @user_id = dbo.vdsf_selUserIDFromToken(@security_token);

DECLARE @prospective_status_feature INT
SET @prospective_status_feature = 20

select 
top (@number_of_impersonations)
ui.impersonated_account_id,
ui.impersonated_organization_id,
o.name as organization_name,
ui.impersonated_user_id,
u.first_name,
u.last_name,
u.email,
isnull(pln.community_name,'') as community,
pln.status, 
ui.impersonation_date 
from user_impersonations ui with (nolock)
left join vss_organizations o with (nolock) on o.organization_id = ui.impersonated_organization_id
left join vss_users u with (nolock) on u.user_id = ui.impersonated_user_id
left join account_organization_user_profile_plan pln with (nolock) on pln.account_id = ui.impersonated_account_id and pln.organization_id = ui.impersonated_organization_id and pln.user_id = ui.impersonated_user_id and (pln.status = 'Contracted' OR (pln.status = 'Active' AND [dbo].vdsf_isOrganizationFeatureOn(pln.organization_id, @prospective_status_feature) = 0))
where ui.user_id = @user_id
order by ui.user_id, ui.impersonation_date desc
GO
PRINT N'Creating Procedure [dbo].[vds_selLegacyRoles]...';


GO
CREATE PROCEDURE [dbo].[vds_selLegacyRoles]
    @search_criteria varchar(50),
    @security_token varchar(36)
AS
/*
	Author:			BK
	Create date:	10/19/2021
	Description:	Gets legacy roles based on search critesria.

	Modifier:		Roger
	Date:			11/16/2021
	Description:	Allow wild cards to return all legacy roles
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	SELECT
		role_id,
		name,
		numeric_role_id,
		alpha_role_id,
		author,
		create_date,
		modifier,
		modified_date
	FROM
		VeoSolutionsSecurity_roles_legacy WITH (NOLOCK)
	WHERE
		ISNULL(@search_criteria, '') = '' OR name LIKE '%' + @search_criteria + '%'
END
GO
PRINT N'Creating Procedure [dbo].[vds_selLegacyUserAccountOrganizationStructure]...';


GO
CREATE PROCEDURE [dbo].[vds_selLegacyUserAccountOrganizationStructure]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@user_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 7/20/2016
	Description: Returns all of the account organization user records
		required by the legacy VDS login process. It isn't ideal for
		using in any other situation, and will eventually be deprecated.

	Modified: Shelby Mansker
	Date: 2/5/2019
	Description: Added profile plan id to the results.

	Modified: Saul Sanchez
	Date: 3/19/2020
	Description: Return expiration date in the profile plan result set.

	Modified:		Roger Wang
	Date:			6/8/2021
	Description:	Fixed the issue of duplicated profile plans being returned
					by joining to the first account organization plan created for the same name.

	Modified:		BK
	Date:			7/7/2021
	Description:	Fixes the proc to return valid and distinct results

	EXEC vds_selLegacyUserAccountOrganizationStructure
		@account_id = 'BAB32B7E-3ADA-497C-862E-E5083971CC59',
		@organization_id = '8AAECC3A-2D9E-4500-B0CF-D79D947D33A7',
		@user_id = 'F15AC710-CDF1-4933-966C-4F28A7C2EDC8',
		@security_token = '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Get a list of distinct plans because plan names can be duplicated. Plan record that was created first gets precedence
	IF OBJECT_ID('tempdb.dbo.#account_organization_community_series_plans') IS NOT NULL DROP TABLE #account_organization_community_series_plans

	SELECT DISTINCT
		csp.community_id,
		c.name as community_name,
		csp.series_id,
		s.name as series_name,
		csp.plan_id,
		p.name as plan_name
	INTO
		#account_organization_community_series_plans
	FROM
		VeoSolutionsSecurity_account_org_community_series_plan csp
		LEFT JOIN VeoSolutionsSecurity_account_organization_communities c WITH (NOLOCK) ON c.account_id = csp.account_id AND c.organization_id = csp.organization_id AND c.community_id = csp.community_id
		LEFT JOIN VeoSolutionsSecurity_account_organization_series s WITH (NOLOCK) ON s.account_id = csp.account_id AND s.organization_id = csp.organization_id AND s.series_id = csp.series_id
		LEFT JOIN VeoSolutionsSecurity_account_organization_plans p WITH (NOLOCK) ON p.account_id = csp.account_id AND p.organization_id = csp.organization_id AND p.plan_id = csp.plan_id
	WHERE
		csp.account_id = @account_id
		AND csp.organization_id = @organization_id


	-- Return the first result set: Account Organization User Information, which includes profile information
	SELECT TOP 1
		aou.account_id,
		aou.organization_id,
		aou.[user_id],
		aou.active,
		ao.account_org_id,
		u.first_name,
		u.last_name,
		u.email,
		u.is_test_user,
		p.profile_id,
		p.interest_rate,
		p.loan_term,
		p.enable_homebuyer_access
	FROM
		VeoSolutionsSecurity_account_organization_users aou WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK) ON ao.account_id = aou.account_id AND ao.organization_id = aou.organization_id
		JOIN VeoSolutionsSecurity_users u WITH (NOLOCK) ON u.[user_id] = aou.[user_id]
		LEFT JOIN account_organization_user_profile p WITH (NOLOCK) ON p.account_id = aou.account_id AND p.organization_id = aou.organization_id AND p.[user_id] = aou.[user_id]
	WHERE
		aou.account_id = @account_id
		AND aou.organization_id = @organization_id
		AND aou.[user_id] = @user_id

	-- Return the second result set: The user's roles in this account organization
	SELECT
		ur.account_id,
		ur.organization_id,
		ur.[user_id],
		r.role_id,
		r.numeric_role_id,
		r.alpha_role_id,
		r.name
	FROM
		VeoSolutionsSecurity_account_organization_users_roles_legacy ur WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_roles_legacy r WITH (NOLOCK) ON r.role_id = ur.role_id
	WHERE
		ur.account_id = @account_id
		AND ur.organization_id = @organization_id
		AND ur.[user_id] = @user_id

	-- Return the third result set: The user's profile plans
	SELECT *
	FROM (
		SELECT
			p.account_id,
			p.organization_id,
			p.[user_id],
			p.profile_id AS user_profile_id,
			pp.profile_id AS profile_plan_id,
			pp.community_name,
			pp.series,
			pp.plan_name,
			pp.base_plan_name,
			pp.catalog_session_id,
			pp.catalog_session_date,
			pp.spec_id,
			pp.sales_price,
			pp.sales_options,
			pp.upgrades_incentive,
			pp.additional_design_deposit,
			pp.deposit_notes,
			pp.home_down_payment,
			pp.home_allowance,
			pp.job_no,
			pp.[address],
			pp.property_desc_1,
			o.property_desc_1_label,
			pp.property_desc_2,
			o.property_desc_2_label,
			pp.block,
			pp.lot,
			pp.city,
			pp.[state],
			pp.zip_code,
			pp.sales_counselor,
			pp.contract_date,
			pp.receipt_date,
			pp.country_home_phone,
			pp.home_phone,
			pp.country_work_phone,
			pp.work_phone,
			pp.spouse_first_name,
			pp.spouse_last_name,
			pp.country_spouse_phone,
			pp.spouse_phone,
			pp.dc_job_id,
			pp.[status],
			pp.echelon_exported,
			pp.spec_home,
			pp.job_type,
			pp.elevation,
			pp.stage,
			pp.superintendent,
			pp.expiration_date,
			pp.upgrade_deposit_percentage,
			-- The following guids are used by option pricing only
			csp.community_id AS community_guid,
			csp.series_id AS series_guid,
			csp.plan_id AS plan_guid,
			csp.plan_id as base_plan_guid,
			ROW_NUMBER() OVER (PARTITION BY pp.profile_id ORDER BY pp.plan_name) as count
		FROM
			account_organization_user_profile p WITH (NOLOCK)
			JOIN account_organization_user_profile_plan pp WITH (NOLOCK) ON pp.account_id = p.account_id AND pp.organization_id = p.organization_id AND pp.[user_id] = p.[user_id]
			JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) ON o.organization_id = p.organization_id
			LEFT JOIN #account_organization_community_series_plans AS csp WITH (NOLOCK) ON csp.plan_name = pp.plan_name AND csp.community_name = pp.community_name AND csp.series_name = pp.series
		WHERE
			p.account_id = @account_id
			AND p.organization_id = @organization_id
			AND p.[user_id] = @user_id
	) d
	WHERE d.count = 1

	-- Return the fourth result set: Per Profile Plan budge items
	SELECT
		p.account_id,
		p.organization_id,
		p.[user_id],
		p.profile_id AS user_profile_id,
		pp.community_name,
		pp.series,
		pp.plan_name,
		bi.application_name,
		bi.product_name,
		bi.area,
		bi.sub_area,
		bi.item_no,
		bi.item_name,
		bi.[source],
		bi.price
	FROM
		dbo.account_organization_user_profile p WITH (NOLOCK)
		JOIN dbo.account_organization_user_profile_plan pp WITH (NOLOCK) ON pp.account_id = p.account_id AND pp.organization_id = p.organization_id AND pp.[user_id] = p.[user_id]
		JOIN dbo.account_organization_user_profile_plan_options_budget_items bi WITH (NOLOCK) ON bi.account_id = pp.account_id AND bi.organization_id = pp.organization_id AND bi.[user_id] = pp.[user_id] AND bi.community = pp.community_name AND bi.series = pp.series AND bi.plan_name = pp.plan_name
	WHERE
		p.account_id = @account_id
		AND p.organization_id = @organization_id
		AND p.[user_id] = @user_id

	-- Return the fith result set: Per Profile Plan documents
	SELECT
		p.account_id,
		p.organization_id,
		p.[user_id],
		p.profile_id AS user_profile_id,
		pp.community_name,
		pp.series,
		pp.plan_name,
		d.doc_id,
		d.doc_name,
		d.doc_type,
		DATALENGTH(doc_data) AS doc_size,
		d.doc_notes
	FROM
		dbo.account_organization_user_profile p WITH (NOLOCK)
		JOIN dbo.account_organization_user_profile_plan pp WITH (NOLOCK) ON pp.account_id = p.account_id AND pp.organization_id = p.organization_id AND pp.[user_id] = p.[user_id]
		JOIN dbo.account_organization_user_profile_plan_documents d WITH (NOLOCK) ON d.account_id = pp.account_id AND d.organization_id = pp.organization_id AND d.[user_id] = pp.[user_id] AND d.community_name = pp.community_name AND d.series = pp.series AND d.plan_name = pp.plan_name
	WHERE
		p.account_id = @account_id
		AND p.organization_id = @organization_id
		AND p.[user_id] = @user_id

	IF OBJECT_ID('tempdb.dbo.#account_organization_community_series_plans') IS NOT NULL DROP TABLE #account_organization_community_series_plans
END
GO
PRINT N'Creating Procedure [dbo].[vds_selLegacyUserAccountStructure]...';


GO
CREATE PROCEDURE [dbo].[vds_selLegacyUserAccountStructure]
	@user_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 7/19/2016
	Description: Returns all of a user's accounts, and their organizations. Returns multiple
		result sets. The first result set is for each account. The second contains all of
		the organizations in each account, that the user belongs to. The third contains
		all of the plan item records for each of the user's organizations. The fourth
		returns all of the elevations for each of the user's organizations.

	EXEC vds_selLegacyUserAccountStructure 
		@user_id = 'F15AC710-CDF1-4933-966C-4F28A7C2EDC8', 
		@security_token = '01234567-89AB-CDEF-0000-123456789ABC'

	Modifier: Daniel Arwe
	Date: 09/02/2025
	Description: Added lifestyle_snapshot_id field
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END
	
	-- create a table variable for the account organizations that belong to this user
	DECLARE @account_organizations TABLE
	(
		account_id UNIQUEIDENTIFIER NOT NULL,
		organization_id UNIQUEIDENTIFIER NOT NULL
	)

	-- Populate the table variable with the user's account organizations
	INSERT INTO @account_organizations (account_id, organization_id)
	SELECT DISTINCT
		aou.account_id,
		aou.organization_id
	FROM
		VeoSolutionsSecurity_account_organization_users aou WITH (NOLOCK)
		--LEFT JOIN VeoSolutionsSecurity_accounts a WITH (NOLOCK) ON a.account_id = aou.account_id
	WHERE
		[user_id] = @user_id
		AND aou.active = 1

	-- Return the first result set: The user's active accounts
	SELECT DISTINCT
		a.account_id,
		a.name,
		a.[address],
		a.city,
		a.[state],
		a.zip,
		a.phone,
		a.active
	FROM 
		@account_organizations temp
		JOIN VeoSolutionsSecurity_accounts a WITH (NOLOCK) ON a.account_id = temp.account_id
	ORDER BY
		a.account_id

	-- Return the second result set: The user's active account organizations
	SELECT
		ao.account_id,
		ao.organization_id,
		o.external_organization_id,
		o.dc_billing_id,
		ao.active,
		o.send_email_notifications,
		o.name,	
		o.organization_type,
		o.color_website,
		o.set_pattern_qty_to_one,
		o.no_charge_pattern,
		o.show_home_price_on_report,	
		o.session_option_pricing,
		o.registration_session,
		o.questionnaire_id,
		o.builder_markup_hb_pricing, 
		o.is_premium,
		isnull(o.rounding_type,2) as rounding_type,
		isnull(o.rounding_places,2) as rounding_places,
		o.upgrade_deposit_percentage,
		o.theme_id,
		o.theme_version_number,
		o.lifestyle_snapshot_id,
		o.homebuyer_congratulations_message,
		o.homebuyer_welcome_message,
		o.use_theme_dmh_room_product_images
	FROM
		@account_organizations temp
		JOIN VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK) ON ao.account_id = temp.account_id AND ao.organization_id = temp.organization_id
		JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) ON o.organization_id = temp.organization_id
	WHERE
		ao.active = 1
		AND o.active = 1
	ORDER BY
		temp.account_id,
		o.name

	-- Return the third result set: The plan items for each of the user's account organization
	SELECT
		plan_items.organization_id,
		plan_items.application_id,
		plan_items.product_id,
		plan_items.item_type,
		plan_items.item_id,
		plan_items.[description],
		plan_items.hb_selection_display
	FROM
		@account_organizations temp
		JOIN VeoSolutionsSecurity_organization_plan_items plan_items WITH (NOLOCK) ON plan_items.organization_id = temp.organization_id

	-- Return the fourth result set: The elevations for each of the user's account organization
	SELECT
		e.organization_id,
		e.elevation
	FROM
		@account_organizations temp
		JOIN VeoSolutionsSecurity_organization_elevations e WITH (NOLOCK) ON e.organization_id = temp.organization_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selMediumPhoto]...';


GO
CREATE procedure [dbo].[vds_selMediumPhoto]
@photo_id as int
as

-- HISTORY 
-- created: 10.03.14 - RH 

-- TESTING 
-- [vds_selMediumPhoto] 55
-- select top 1 * from Veo_photos
SELECT 
	enlarged_photo_data as photo_data 
FROM
	Veo_photos with (nolock)  
WHERE 
	photo_id = @photo_id
GO
PRINT N'Creating Procedure [dbo].[vds_selNextDesignAppointment]...';


GO
CREATE PROCEDURE [dbo].[vds_selNextDesignAppointment]
	@user_id UNIQUEIDENTIFIER, 
	@security_token UNIQUEIDENTIFIER = null 
AS
/*
	Author:		 Rob Hobbs
	Create date: 02/09/2015
	Description: Fetches the NEXT scheduled appointment for a designer user id, based on today's date and time NOW. 

	Modifier:    Saul Sanchez
	Modify date: 03/16/2017
	Description: Return the profile plan address as plan_address.

	-- LOCAL TESTING 
	-- vds_selNextDesignAppointment '23DEC263-C2FE-4A85-B955-5B397984065A'
	-- vds_selNextDesignAppointment '0e4c3d85-5acf-4d8c-af40-a5e33715ed8b'

	-- fetch some appointments for today 
	-- SELECT * FROM scheduling_appointments WHERE appointment_date = CONVERT(date, SYSDATETIME())  
	-- SELECT TOP 100 * FROM scheduling_appointments with (nolock) ORDER BY appointment_date DESC

	-- testing if admin 

	SELECT dbo.vds_isUserSysAdmin('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B')

	-- Finding users....

	SELECT * FROM VeoSolutionSecurity_users
	SELECT * FROM VeoSolutionSecurity_locations
	SELECT * FROM scheduling_buyers
	SELECT TOP 100 * FROM account_organization_user_profile 
	SELECT TOP 100 * FROM account_organization_user_profile_plan
	SELECT TOP 100 * FROM account_organization_user_profile_plan_catalog_sessions WHERE status = 1
	SELECT TOP 100 * FROM VeoSolutionSecurity_account_organization_users
*/

BEGIN

    --DECLARE	@user_id UNIQUEIDENTIFIER
    --DECLARE @date DATETIME

    --SET @user_id = '0e4c3d85-5acf-4d8c-af40-a5e33715ed8b'
    --SET @date = '06/26/2014'

	-- Validate the security token
	--IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	--BEGIN
	--	RAISERROR('Access Denied.',16,1)
	--	RETURN
	--END

	-- determine if user is an admin 
	DECLARE @is_sysadmin BIT
	SET @is_sysadmin = dbo.vdsf_isUserSysAdmin(@user_id)

	-- test time 
	--declare @test_time time 
	--set @test_time = '09:10:00' 

	SELECT 
	TOP 1 
		CAST(a.start_time AS TIME) AS start_time,
		o.display_name AS org_name, 
		sb.buyer_name, 
		CASE 
			WHEN LEN(sbc.mobile_phone) > 0 THEN sbc.mobile_phone
			WHEN LEN(sbc.home_phone) > 0 THEN sbc.home_phone
			ELSE sbc.work_phone
		END AS phone_number,
		upplans.[address] AS plan_address, 
		upplans.lot,
		upplans.[block],
		upplans.community_name, 
        upplans.series,
		upplans.plan_name, 
		upplans.account_id,
		upplans.organization_id,
        upplans.[user_id],
		su.first_name + ' ' + su.last_name as designer_name, 
		(   SELECT TOP 1
				ppcs.session_id
			FROM
				account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
			WHERE
				ppcs.account_id = upplans.account_id
				AND ppcs.organization_id = upplans.organization_id
				AND ppcs.[user_id] = upplans.[user_id]
				AND ppcs.community_name = upplans.community_name
				AND ppcs.series = upplans.series
				AND ppcs.plan_name = upplans.plan_name
				AND ppcs.[status] IN (0, 1, 4)  
		) AS selection_session_id,
		CASE
            -- If no sessions exist, then return 'No Sessions'
            WHEN (  SELECT
                        COUNT(*)
                    FROM
  			  	        account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
			        WHERE
				        ppcs.account_id = upplans.account_id
				        AND ppcs.organization_id = upplans.organization_id
				        AND ppcs.[user_id] = upplans.[user_id]
				        AND ppcs.community_name = upplans.community_name
				        AND ppcs.series = upplans.series
				        AND ppcs.plan_name = upplans.plan_name
                 ) = 0 THEN 'no sessions'

            -- If any of the sessions have an Active status, then return 'Active'.
            WHEN (  SELECT
                        COUNT(*)
                    FROM
  			  	        account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
			        WHERE
				        ppcs.account_id = upplans.account_id
				        AND ppcs.organization_id = upplans.organization_id
				        AND ppcs.[user_id] = upplans.[user_id]
				        AND ppcs.community_name = upplans.community_name
				        AND ppcs.series = upplans.series
				        AND ppcs.plan_name = upplans.plan_name
                        AND ppcs.[status] = 1
                 ) > 0 THEN 'active'

            -- If any of the sessions have a Pending status, then return  'Pending'.
            WHEN (  SELECT
                        COUNT(*)
                    FROM
  			  	        account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
			        WHERE
				        ppcs.account_id = upplans.account_id
				        AND ppcs.organization_id = upplans.organization_id
				        AND ppcs.[user_id] = upplans.[user_id]
				        AND ppcs.community_name = upplans.community_name
				        AND ppcs.series = upplans.series
				        AND ppcs.plan_name = upplans.plan_name
                        AND ppcs.[status] = 4
                 ) > 0 THEN 'pending'

            -- If all sessions are inactive, then return 'Inactive'
            WHEN (  SELECT
                        COUNT(*)
                    FROM
  			  	        account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
			        WHERE
				        ppcs.account_id = upplans.account_id
				        AND ppcs.organization_id = upplans.organization_id
				        AND ppcs.[user_id] = upplans.[user_id]
				        AND ppcs.community_name = upplans.community_name
				        AND ppcs.series = upplans.series
				        AND ppcs.plan_name = upplans.plan_name
                        AND ppcs.[status] = 0
                 ) = (  SELECT
                            COUNT(*)
                        FROM
  			  	            account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
			            WHERE
				            ppcs.account_id = upplans.account_id
				            AND ppcs.organization_id = upplans.organization_id
				            AND ppcs.[user_id] = upplans.[user_id]
				            AND ppcs.community_name = upplans.community_name
				            AND ppcs.series = upplans.series
				            AND ppcs.plan_name = upplans.plan_name
                     ) THEN 'inactive'
            
            -- All other cases will not be shown.
            ELSE 'do not show'

        END AS [status]
	FROM 
		scheduling_appointments a with (nolock) 
		LEFT JOIN scheduling_organizations o WITH (NOLOCK) on o.account_org_id = a.account_org_id 
		join scheduling_user_organizations suo with (nolock) on suo.account_org_id = a.account_org_id and suo.user_id = @user_id
		JOIN account_organization_user_profile_plan upplans WITH (NOLOCK) on upplans.profile_id = dbo.ef_selSchedulingBuyerActiveProfilePlan(a.buyer_profile_id)
		JOIN scheduling_buyers sb WITH (NOLOCK) on sb.profile_id = a.buyer_profile_id
		JOIN scheduling_buyers_contacts sbc with (nolock) on sbc.profile_id = sb.profile_id and is_buyer = 1
		JOIN scheduling_users su with (nolock) on su.user_id = a.schedule_user_id 
	WHERE
		a.schedule_user_id = @user_id 
		AND a.appointment_date = CONVERT (date, SYSDATETIME())
		AND a.start_time >= CONVERT (time, SYSDATETIME()) 
	ORDER BY a.start_time asc


	-- REFERENCE CODE FROM OTHER selSchedulingDesignerAppointmentsByDate

	--SELECT 
	--	CAST(a.start_time AS TIME) AS start_time,
	--	o.display_name AS org_name, 
	--	sb.buyer_name, 
	--	CASE 
	--		WHEN LEN(sbc.mobile_phone) > 0 THEN sbc.mobile_phone
	--		WHEN LEN(sbc.home_phone) > 0 THEN sbc.home_phone
	--		ELSE sbc.work_phone
	--	END AS phone_number,
	--	upplans.[address], 
	--	upplans.lot,
	--	upplans.block,
	--	upplans.community_name, 
 --       upplans.series,
	--	upplans.plan_name, 
	--	upplans.account_id,
	--	upplans.organization_id,
 --       upplans.[user_id],
	--	su.first_name + ' ' + su.last_name as designer_name, 
	--	(   SELECT TOP 1
	--			ppcs.session_id
	--		FROM
	--			account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
	--		WHERE
	--			ppcs.account_id = upplans.account_id
	--			AND ppcs.organization_id = upplans.organization_id
	--			AND ppcs.[user_id] = upplans.[user_id]
	--			AND ppcs.community_name = upplans.community_name
	--			AND ppcs.series = upplans.series
	--			AND ppcs.plan_name = upplans.plan_name
	--			AND ppcs.[status] IN (0, 1, 4)  
	--	) AS selection_session_id,
 --       CASE
 --           -- If no sessions exist, then return 'No Sessions'
 --           WHEN (  SELECT
 --                       COUNT(*)
 --                   FROM
 -- 			  	        account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
	--		        WHERE
	--			        ppcs.account_id = upplans.account_id
	--			        AND ppcs.organization_id = upplans.organization_id
	--			        AND ppcs.[user_id] = upplans.[user_id]
	--			        AND ppcs.community_name = upplans.community_name
	--			        AND ppcs.series = upplans.series
	--			        AND ppcs.plan_name = upplans.plan_name
 --                ) = 0 THEN 'no sessions'

 --           -- If any of the sessions have an Active status, then return 'Active'.
 --           WHEN (  SELECT
 --                       COUNT(*)
 --                   FROM
 -- 			  	        account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
	--		        WHERE
	--			        ppcs.account_id = upplans.account_id
	--			        AND ppcs.organization_id = upplans.organization_id
	--			        AND ppcs.[user_id] = upplans.[user_id]
	--			        AND ppcs.community_name = upplans.community_name
	--			        AND ppcs.series = upplans.series
	--			        AND ppcs.plan_name = upplans.plan_name
 --                       AND ppcs.[status] = 1
 --                ) > 0 THEN 'active'

 --           -- If any of the sessions have a Pending status, then return  'Pending'.
 --           WHEN (  SELECT
 --                       COUNT(*)
 --                   FROM
 -- 			  	        account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
	--		        WHERE
	--			        ppcs.account_id = upplans.account_id
	--			        AND ppcs.organization_id = upplans.organization_id
	--			        AND ppcs.[user_id] = upplans.[user_id]
	--			        AND ppcs.community_name = upplans.community_name
	--			        AND ppcs.series = upplans.series
	--			        AND ppcs.plan_name = upplans.plan_name
 --                       AND ppcs.[status] = 4
 --                ) > 0 THEN 'pending'

 --           -- If all sessions are inactive, then return 'Inactive'
 --           WHEN (  SELECT
 --                       COUNT(*)
 --                   FROM
 -- 			  	        account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
	--		        WHERE
	--			        ppcs.account_id = upplans.account_id
	--			        AND ppcs.organization_id = upplans.organization_id
	--			        AND ppcs.[user_id] = upplans.[user_id]
	--			        AND ppcs.community_name = upplans.community_name
	--			        AND ppcs.series = upplans.series
	--			        AND ppcs.plan_name = upplans.plan_name
 --                       AND ppcs.[status] = 0
 --                ) = (  SELECT
 --                           COUNT(*)
 --                       FROM
 -- 			  	            account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
	--		            WHERE
	--			            ppcs.account_id = upplans.account_id
	--			            AND ppcs.organization_id = upplans.organization_id
	--			            AND ppcs.[user_id] = upplans.[user_id]
	--			            AND ppcs.community_name = upplans.community_name
	--			            AND ppcs.series = upplans.series
	--			            AND ppcs.plan_name = upplans.plan_name
 --                    ) THEN 'inactive'
            
 --           -- All other cases will not be shown.
 --           ELSE 'do not show'

 --       END AS [status]
	--FROM 
	--	scheduling_appointments a WITH (NOLOCK)
	--	LEFT JOIN scheduling_organizations o WITH (NOLOCK) on o.account_org_id = a.account_org_id 
	--	join scheduling_user_organizations suo with (nolock) on suo.account_org_id = a.account_org_id and suo.user_id = @user_id
	--	JOIN account_organization_user_profile_plan upplans WITH (NOLOCK) on upplans.profile_id = dbo.ef_selSchedulingBuyerActiveProfilePlan(a.buyer_profile_id)
	--	JOIN scheduling_buyers sb WITH (NOLOCK) on sb.profile_id = a.buyer_profile_id
	--	JOIN scheduling_buyers_contacts sbc with (nolock) on sbc.profile_id = sb.profile_id and is_buyer = 1
	--	JOIN scheduling_users su with (nolock) on su.user_id = a.schedule_user_id 
	--WHERE
	--	a.appointment_date = getdate() 
	--	and 
	--	--AND (a.schedule_user_id = @user_id OR @is_sysadmin = 1) 
	--ORDER BY 
	--	a.start_time
END
GO
PRINT N'Creating Procedure [dbo].[vds_selNumberOfTenantProfilePlans]...';


GO
CREATE PROCEDURE [dbo].[vds_selNumberOfTenantProfilePlans]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@community_name VARCHAR(50) = NULL,
	@series_name VARCHAR(50) = NULL,
	@plan_name VARCHAR(50) = NULL
AS
/*
	Author: Shelby Mansker
	Date: 11/5/2020
	Description: Returns the number of Profile Plans that exist for a given Tenant (Account Id and Org Id).
		The results can be filtered to those Profile Plans that are linked to a specific Community, Series, or Plan.
*/
BEGIN
	SELECT 
		COUNT(*) number_of_profile_plans
	FROM 
		account_organization_user_profile_plan 
	WHERE 
		account_id = @account_id 
		AND organization_id = @organization_id 
		AND (@community_name IS NULL OR community_name = @community_name)
		AND (@series_name IS NULL OR series = @series_name)
		AND (@plan_name IS NULL OR plan_name = @plan_name)
END
GO
PRINT N'Creating Procedure [dbo].[vds_selOptionBudgetItemCounts]...';


GO
CREATE PROCEDURE [dbo].[vds_selOptionBudgetItemCounts]
@account_id AS uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier,
@community varchar(50),
@series varchar(50),
@plan_name varchar(50),
@security_token varchar(36)
As

BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
		BEGIN
			RAISERROR('Access Denied.',16,1)
			RETURN
		END

	declare @price_level_count int
		, @catalog_item_count int

	select @price_level_count = Count([SOURCE]) from 
		account_organization_user_profile_plan_options_budget_items
	where
		account_id = @account_id
		and organization_id = @organization_id
		and [user_id] = @user_id
		and community = @community
		and series = @series
		and plan_name = @plan_name
		and Source IN ('Prices Landed', 'Contract')
	GROUP BY [SOURCE];

	select @catalog_item_count = Count([SOURCE]) from 
		account_organization_user_profile_plan_options_budget_items
	where
		account_id = @account_id
		and organization_id = @organization_id
		and [user_id] = @user_id
		and community = @community
		and series = @series
		and plan_name = @plan_name
		and Source IN ('Catalog')
	GROUP BY [SOURCE]

	select @price_level_count as price_level_count, @catalog_item_count as catalog_item_count
END
GO
PRINT N'Creating Procedure [dbo].[vds_selOptionQtyByItemNumber]...';


GO

CREATE procedure [dbo].[vds_selOptionQtyByItemNumber]
    @item_number VARCHAR(81),
    @option_id VARCHAR(10),
    @security_token VARCHAR(36)
AS
/*
		Author:			Adrian Garza
		Purpose:		Retrive qty for an option
		Usage:
						vds_selOptionQtyByItemNumber 'YBLASB30/AWT','GLZ'

        Modified: Shelby Mansker
        Date: 11/5/2015
        Description: The original version of this query was not joining on styles properly, and wasn't
            limiting the products_options_materials table join by the material_id. I have cleaned up
            the query quite a bit, added the security token validation, and fixed the join issues.

        Modified: Shelby Mansker
        Date: 11/9/2015
        Description: Moved this proc to the VeoSolutions database, from the Veo database.

        vds_selOptionQtyByItemNumber 'YOSCRB/CVL', 'LINE', '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT 
        ISNULL(sa.value_id, 1) AS qty
    FROM
        Veo_colors c WITH (NOLOCK)
        JOIN Veo_products_options po WITH (NOLOCK) ON po.product_id = c.product_id
        JOIN Veo_styles s WITH (NOLOCK) ON s.product_id = po.product_id AND s.style_id = c.style_id
        JOIN Veo_products_options_materials pom WITH (NOLOCK) ON pom.product_id = po.product_id AND pom.option_id = po.option_id AND pom.material_id = s.material
        LEFT JOIN Veo_styles_attributes sa WITH (NOLOCK) ON sa.product_id = s.product_id AND sa.style_id = s.style_id AND sa.attribute_id = po.quantity_style_attribute_id
    WHERE
        c.part_no = @item_number
        AND po.option_id = @option_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selOrganization]...';


GO
CREATE PROCEDURE [dbo].[vds_selOrganization]
	@organization_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Create Date: 7/20/2015
	Description: Returns the organization from the veo solutions security organizations table

	Modified: Shelby Mansker
	Date: 8/1/2016
	Description: Added the organization's flags as a second result set

	Modified: Shelby Mansker
	Date: 8/3/2016
	Description: Modified the builder features section, second result set, so that it returns ALL
		features from the features table, regardless if the builder has a setting for the feature in
		builder_features. If they are missing a builder_feature, the feature is defaulted to "off", or 0.

	Modified: Roger Wang
	Date: 2/18/2019
	Description: Use a function to return builder flags from organizations table that are also maintainable in VDS.

	Modified: Shelby Mansker
	Date: 6/1/2020
	Description: Added a third result set that includes all of the elevations that belong to this organization.

	Modified: Roger Wang
	Date: 6/28/2021
	Description: Replaced the function that returns all builder features stored in organizations table with a view
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Fetch the organization by id, in the first result set
	SELECT TOP 1
		*
	FROM
		VeoSolutionsSecurity_organizations WITH (NOLOCK)
	WHERE
		organization_id = @organization_id

	-- Fetch the organization's features in a second result set.
	SELECT
		@organization_id AS organization_id,
		f.id AS feature_id,
		f.lookup_key,
		f.[description],
		f.[name],
		f.[group_name],
		ISNULL(bf.value, 0) AS [value]
	FROM
		features f WITH (NOLOCK)
		LEFT JOIN builder_features bf WITH (NOLOCK) ON bf.feature_id = f.id AND bf.organization_id = @organization_id

	-- Fetch the Organization's Elevations in the Third Result Set
	SELECT
		*
	FROM
		[dbo].[VeoSolutionsSecurity_organization_elevations]
END
GO
PRINT N'Creating Procedure [dbo].[vds_selOrganizationCustomProperties]...';


GO
CREATE PROCEDURE dbo.vds_selOrganizationCustomProperties
    @organization_id uniqueidentifier,
	@security_token UNIQUEIDENTIFIER
AS
/*
    =============================================
    Author:		Shelby Mansker
    Create date: 10/23/2014
    Description:	Returns the custom property labels for the specified organization
    =============================================
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT TOP 1
        property_desc_1_label,
        property_desc_2_label
    FROM
        veosolutionssecurity_organizations WITH (NOLOCK)
    WHERE
        organization_id = @organization_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selOtherActiveSessionsExist]...';


GO
CREATE PROCEDURE [dbo].[vds_selOtherActiveSessionsExist]
    @session_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
	Author:      Saul Sanchez
	Create date: ??
	Description: Checks to see if there are any other active sessions, besides
      the one passed in, for a given profile plan.

    Modified 11/18/2014 by Shelby Mansker
        Added a check for Pending as well. Jim asked that we limit it so that there
        is only ever one Pending/Active session in a profile plan at a time.
*/
BEGIN
    --=================================================================
    -- Validate the security token
    --=================================================================
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    --=================================================================
    -- Get the primary key values for the current session.
    --=================================================================
    DECLARE @account_id UNIQUEIDENTIFIER
    DECLARE @organization_id UNIQUEIDENTIFIER
    DECLARE @user_id UNIQUEIDENTIFIER
    DECLARE @community_name VARCHAR(50)
    DECLARE @series VARCHAR(50)
    DECLARE @plan_name VARCHAR(50)

    SELECT
        @account_id = account_id,
        @organization_id = organization_id,
        @user_id = [user_id],
        @community_name = community_name,
        @series = series,
        @plan_name = plan_name
    FROM
        account_organization_user_profile_plan_catalog_sessions WITH (NOLOCK)
    WHERE
        session_id = @session_id

    --=================================================================
    -- Select the first other session with an Active or Pending status.
    --=================================================================
    SELECT TOP 1
        session_id
    FROM
        account_organization_user_profile_plan_catalog_sessions WITH (NOLOCK)
    WHERE
        account_id = @account_id
        AND organization_id = @organization_id
        AND [user_id] = @user_id
        AND community_name = @community_name
        AND series = @series
        AND plan_name = @plan_name
        AND session_id <> @session_id
        AND ([status] = 1 OR [status] = 4)

END
GO
PRINT N'Creating Procedure [dbo].[vds_selOtherAreas]...';


GO
CREATE PROCEDURE [dbo].[vds_selOtherAreas] 
	@session_id uniqueidentifier,
	@build_id int,
	@security_token uniqueidentifier
AS
/* 
	Author:		Scott Friend
	Create date: May 27, 2013
	Description:	Return list of Builds (Estimated Areas) that will accept the same level selection as what was passed in
	exckuding the build that was passed in
  
	-- Examples
	vds_selOtherAreas '83b5e473-5062-4373-a5d7-54225d50f1ca', 9797606
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END



	-- pattern check.

	declare @pattern_areas table (area_id varchar(50),sub_area_id varchar(50))
	declare @pattern_id int
	declare @pattern_area_count int

	set @pattern_area_count = 0

	SELECT 
		top 1 @pattern_id = detail.pattern_id
	FROM 
		dbo.catalog_selections_areas cas WITH (NOLOCK)
	left join [catalog_selections_area_details] detail with (nolock) on 
	
		detail.[session_id] = cas.session_id
		AND detail.[application] =cas.application
		AND detail.[product] = cas.product
		AND detail.[area] = cas.area
		AND detail.[sub_area] = cas.sub_area

	WHERE 
		cas.session_id = @session_id
		AND cas.build_id = @build_id
		and detail.pattern_id > 0

	--print @pattern_id

	if @pattern_id > 0
	begin
	
		insert into @pattern_areas
		SELECT ppa.area_id,ppa.sub_area_id
		FROM
			dbo.Veo_product_patterns pp WITH (NOLOCK)
			LEFT JOIN dbo.Veo_product_patterns_areas ppa WITH (NOLOCK) ON ppa.pattern_id = pp.pattern_id
		where pp.pattern_id = @pattern_id and ppa.pattern_id is not null

		select @pattern_area_count = count(*) from @pattern_areas

	end

	--print @pattern_area_count

	SELECT 
		areas.[application],
		areas.product,
		areas.area,
		areas.sub_area,
		areas.build_id,
		areas.notes,
        (select top 1
            is_credit
         from
            dbo.catalog_selections with (nolock)
         where
            session_id = @session_id
            and [application] = areas.[application]
            and product = areas.product
            and area = areas.area
            and sub_area = areas.sub_area
            and rtrim(item) <> 'custom'
            and item not like '%pad%'
        ) as is_credit,
		options.price
		--,pareas.*
	FROM 
		dbo.catalog_selections_areas original WITH (NOLOCK)
		JOIN dbo.catalog_selections_areas areas WITH (NOLOCK) ON 
			original.session_id = areas.session_id	
			AND original.[application] = areas.[application] 
			AND original.product = areas.product 
			AND original.build_id != areas.build_id 
			AND areas.area_selected = 1
		JOIN dbo.catalog_selections area_sel WITH (NOLOCK) ON 
			original.session_id = area_sel.session_id 
			AND original.selected_field_group = area_sel.row_id
		JOIN dbo.catalog_selections options WITH (NOLOCK) ON 
			original.session_id = options.session_id 
			AND options.[application] = areas.[application]
			and options.product = areas.product
			and options.area = areas.area
			and options.sub_area = areas.sub_area
			and options.item_no = area_sel.item_no

		left join @pattern_areas pareas on 
			pareas.area_id = areas.area_id
			and pareas.sub_area_id = areas.sub_area_id
	WHERE 
		original.session_id = @session_id
		AND original.build_id = @build_id
	    and (pareas.area_id is not null or @pattern_area_count = 0)
	ORDER BY 
		areas.area, 
		areas.sub_area

END
GO
PRINT N'Creating Procedure [dbo].[vds_selOtherSelectedAreas]...';


GO
CREATE PROCEDURE [dbo].[vds_selOtherSelectedAreas] 
	@session_id uniqueidentifier,
	@build_id int,
	@security_token uniqueidentifier
AS
/* 
	Author:		Robert Hobbs
	Create date: July 21, 2014
	Description:	Return list of Builds (Estimated Areas) that are selected, matching the current build's application.
  
	-- Examples
	-- old proc, not really what we want: 
	[vds_selOtherAreas] '436c7112-8bbb-4d54-becf-90b45d78a054', 9797544, null
	-- new product (for comparison) 
	[vds_selOtherSelectedAreas] '436c7112-8bbb-4d54-becf-90b45d78a054', 9797544, null
	select * from catalog_selections_areas where session_id = '436c7112-8bbb-4d54-becf-90b45d78a054' and build_id = 9797544
	select * from catalog_selections_areas where session_id = '436c7112-8bbb-4d54-becf-90b45d78a054' and selected > 0 and build_id != 9797544 and application = 'Flooring' and product ='wood'
	
*/
BEGIN

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- KEEPING IT SIMPLE 
	declare @application varchar(100) 
	declare @product varchar(100) 
	select @application = application, @product = product from catalog_selections_areas where session_id = @session_id and build_id = @build_id 


	SELECT  
		areas.[application],
		areas.product,
		areas.area,
		areas.sub_area,
		areas.build_id,
		areas.notes,
		areas.selected,
        (SELECT TOP 1
            is_credit
         FROM
            dbo.catalog_selections WITH (NOLOCK)
         WHERE
            session_id = @session_id
            and [application] = areas.[application]
            and product = areas.product
            and area = areas.area
            and sub_area = areas.sub_area
            and rtrim(item) <> 'custom'
            and item not like '%pad%'
        ) AS is_credit
	FROM 
		dbo.catalog_selections_areas areas WITH (NOLOCK)

	WHERE 
		areas.session_id = @session_id
		AND areas.build_id != @build_id -- NOT THIS BUILD ID 
		AND areas.area_selected = 1 -- 'AREA' IS 'SELECTED' 
		AND areas.selected > 0 -- HAS A SELECTION (AT LEAST PRODUCT) 
		AND areas.application = @application 
		AND areas.product = @product 

	ORDER BY 
		areas.area, 
        is_credit asc,
		areas.sub_area

END
GO
PRINT N'Creating Procedure [dbo].[vds_selPartImageData]...';


GO

CREATE PROCEDURE [dbo].[vds_selPartImageData]
	@part_no VARCHAR(31)
AS
/*
    Author: Shelby Mansker
    Date: 01/29/2015
    Description: Returns the image data for the specified part from the colors table in Veo.
                 This method is not secured intentionally, as it may be called
                 without access to a security token.

    Modified 09/22/2015: Updated to pull cabinet colors for cabinet products. Saul.

    Modified 02/15/2016: Some cabinet items (like hardware) have their image data stored in the
                 colors table.  Pull image data from the colors table if it doesn't exist in the
                 cabinet colors table.  Saul.

    Modified 09/14/2016: Now that colorized, composite cabinet images (door and drawer) have been
                 created and added to the Veo_colors table, there is no need to join on the
                 Veo_cabinet_colors table for the part image.
*/
BEGIN
    SELECT
        image_data
    FROM
        dbo.Veo_colors
    WHERE
        part_no = @part_no

END
GO
PRINT N'Creating Procedure [dbo].[vds_selPartLaborCode]...';


GO
CREATE PROCEDURE [dbo].[vds_selPartLaborCode]
    @part_no VARCHAR(31),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:	Shelby Mansker
	Create date: 6/26/2015
	Description: Returns the labor code, if it is set, for the specified part number.

    EXEC dbo.vds_selPartLaborCode @part_no = '6891/RCBEI', @security_token = '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    DECLARE @style_id VARCHAR(20)
    DECLARE @product_id VARCHAR(10)

    -- Fetch the style id and product id from the colors table, using the part number
    SELECT
        @style_id = style_id,
        @product_id = product_id
    FROM
        dbo.Veo_colors WITH (NOLOCK)
    WHERE
        part_no = @part_no

    -- Use the style id and product id of the part number to look up its labor code in the styles table, and return it
    SELECT
        labor_code
    FROM
        dbo.Veo_styles WITH (NOLOCK)
    WHERE
        style_id = @style_id
        AND product_id = @product_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPattern]...';


GO
CREATE PROCEDURE [dbo].[vds_selPattern]
	@pattern_id INT,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Create Date: 03/20/2018
	Description: Returns a pattern.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	SELECT
		pp.pattern_id,
		pp.pattern_name,
		pp.active,
		pp.application_id,
		pp.product_id,
		( SELECT
			COUNT(pav.line_no)
		  FROM
			Veo_photo_attributes_values pav
		  WHERE
		    pav.attribute_id = 6
			AND LTRIM(pav.value) = LTRIM(STR(pp.pattern_id))
		) AS photo_count
	FROM
		Veo_product_patterns pp
	WHERE
		pattern_id = @pattern_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPatternAccentImage]...';


GO
CREATE PROCEDURE [dbo].[vds_selPatternAccentImage]
    @pattern_ID INT,
    @item_type VARCHAR(20),
    @item_id VARCHAR(50)
AS
/*
    Author: Saul Sanchez
    Date: 06/25/2015
    Description: Returns the image data for the specified pattern accent.
                 This method is not secured with a security token.
*/
BEGIN
    SELECT
        image_data
    FROM
        Veo_product_patterns_material
    WHERE
        pattern_id = @pattern_ID
        AND item_type = @item_type
        AND item_id = @item_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_selPatternImage]...';


GO
CREATE PROCEDURE dbo.vds_selPatternImage 
    @pattern_id INT
AS
/*
    Author: Shelby Mansker
    Date: 01/29/2015
    Description: Returns the image data for the specified pattern. This method is not secured, since the image can be requested
                 without a security token.
*/
BEGIN
	SELECT
        image_data
    FROM
        Veo_product_patterns
    WHERE
        pattern_id = @pattern_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPatterns]...';


GO
CREATE PROCEDURE [dbo].[vds_selPatterns]
    @pattern_type VARCHAR(50),
	@account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author:			Shelby Mansker
    Date:			01/30/2015
    Description:	Returns all of the patterns that match the specified type.
	History:		20151016 RIG Modified to require account_org_id
    History:        20151019 SLM Replaced account_org_id with two parameters: account_id and organization_id. 

    EXEC dbo.vds_selPatterns @pattern_type = 'Floors', @security_token = '01234567-89AB-CDEF-0000-123456789ABC'
    EXEC dbo.vds_selPatterns @pattern_type = 'BackSplashes', @security_token = '01234567-89AB-CDEF-0000-123456789ABC'
    EXEC dbo.vds_selPatterns @pattern_type = 'Showers', @security_token = '01234567-89AB-CDEF-0000-123456789ABC'
    EXEC dbo.vds_selPatterns @pattern_type = 'Tubs', @security_token = '01234567-89AB-CDEF-0000-123456789ABC'

	select * from account_organization_user_profile_plan_catalog_sessions where session_id = '6857F2CF-0415-4BED-B5AE-E7C641CD9F47'
	select * from account_organization_user_profile_plan where user_id = 'BC33A710-C06F-4ECE-BC9A-B4EA165F50E3'
	select * from account_organization_user_profile where user_id = 'BC33A710-C06F-4ECE-BC9A-B4EA165F50E3'
	select * from veosolutionssecurity.dbo.account_organizations where account_id = 'BAB32B7E-3ADA-497C-862E-E5083971CC59' and organization_id = '8AAECC3A-2D9E-4500-B0CF-D79D947D33A7'
	EXEC dbo.vds_selPatterns @pattern_type = 'Floors', @security_token = '01234567-89AB-CDEF-0000-123456789ABC', @account_id = 'BAB32B7E-3ADA-497C-862E-E5083971CC59', @organization_id = '8AAECC3A-2D9E-4500-B0CF-D79D947D33A7'


*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Fetch the external_organization_id
	declare @external_organization_id varchar(50)
	select 
		@external_organization_id = external_organization_id 
	from 
		VeoSolutionsSecurity_account_organizations vssao with (nolock)
		join VeoSolutionsSecurity_organizations vsso with (nolock) on vsso.organization_id = vssao.organization_id
	where 
		vssao.account_id = @account_id
        AND vssao.organization_id = @organization_id

	-- Generate the customer's allowable pattern list
	DECLARE @customerPatterns TABLE 
	(
		pattern_id INT 
	)

	INSERT INTO @customerPatterns 
	SELECT
		pp.pattern_id
	FROM
		Veo_product_patterns pp WITH (NOLOCK)
		LEFT JOIN Veo_product_patterns_customers ppc WITH (NOLOCK) ON ppc.pattern_id = pp.pattern_id and ppc.custnmbr = @external_organization_id
	WHERE
		ppc.pattern_id IS NULL
		or ppc.custnmbr <> @external_organization_id

    -- Fetch the patterns based on the pattern type passed IN
    IF (@pattern_type = 'Floors')
        BEGIN
	        SELECT DISTINCT 
	            pp.pattern_id,
	            pattern_name,
                application_id,
                product_id
	        FROM 
				@customerPatterns cp
                join Veo_product_patterns pp WITH (NOLOCK) on pp.pattern_id = cp.pattern_id
	            LEFT JOIN Veo_product_patterns_areas ppa WITH (NOLOCK) ON ppa.pattern_id = pp.pattern_id
	        WHERE 
                pp.active = 1 
                AND pp.application_id = 1
        END
    ELSE IF (@pattern_type = 'BackSplashes')
        BEGIN 
	        SELECT DISTINCT 
	            pp.pattern_id,
	            pattern_name,
                application_id,
                product_id
	        FROM 
				@customerPatterns cp
                join Veo_product_patterns pp WITH (NOLOCK) on pp.pattern_id = cp.pattern_id
	            LEFT JOIN Veo_product_patterns_areas ppa WITH (NOLOCK) ON ppa.pattern_id = pp.pattern_id 
	        WHERE 
                pp.active = 1 
                AND application_id = 3 
                AND sub_area_id IN ('BP','BS')
        END
    ELSE IF (@pattern_type = 'Showers')
        BEGIN 
	        SELECT DISTINCT 
	            pp.pattern_id,
	            pattern_name,
                application_id,
                product_id
	        FROM 
				@customerPatterns cp
                join Veo_product_patterns pp WITH (NOLOCK) on pp.pattern_id = cp.pattern_id
	            LEFT JOIN Veo_product_patterns_areas ppa WITH (NOLOCK) ON ppa.pattern_id = pp.pattern_id 
	        WHERE 
                pp.active = 1 
                AND application_id = 3 
                AND sub_area_id IN ('SS')
        END
    ELSE IF (@pattern_type = 'Tubs')
        BEGIN 
	        SELECT DISTINCT 
	            pp.pattern_id,
	            pattern_name,
                application_id,
                product_id
	        FROM 
				@customerPatterns cp
                join Veo_product_patterns pp WITH (NOLOCK) on pp.pattern_id = cp.pattern_id
	            LEFT JOIN Veo_product_patterns_areas ppa on ppa.pattern_id = pp.pattern_id 
	        WHERE 
                pp.active = 1 
                AND application_id = 3 
                AND sub_area_id IN ('GardenTub','TS')
        END
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPatternsBySessionBuildOrganizationAndCriteria]...';


GO
CREATE PROCEDURE [dbo].[vds_selPatternsBySessionBuildOrganizationAndCriteria]
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
	@organization_id UNIQUEIDENTIFIER,
    @criteria VARCHAR(MAX) = '',
	@security_token UNIQUEIDENTIFIER = NULL
AS
/*
	Author:		???
	Create date: ???
	Description:	???

	Note:			RIG 20150409
					This stored procedure is being replaced by vds_selSpecPatternItems and should be discarded 
					when the new stored procedure is put into use
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DECLARE @hold_application_id VARCHAR(10) = ''
	DECLARE @hold_product_id VARCHAR(10) = ''
	DECLARE @hold_area_id VARCHAR(10) = ''
	DECLARE @hold_sub_area_id VARCHAR(10) = ''
	DECLARE @hold_external_organization_id VARCHAR(20) = ''

	--=====================================================================
	-- Convert the build ID into the application, product, area, and 
	-- sub area IDs.
	--=====================================================================
	SELECT
		@hold_application_id = vap.application_id,
		@hold_product_id = vp.product_id,
		@hold_area_id = csa.area_id,
		@hold_sub_area_id = csa.sub_area_id
	FROM
		dbo.catalog_selections_areas csa WITH (NOLOCK)
		LEFT JOIN dbo.Veo_applications vap WITH (NOLOCK) ON vap.name = csa.[application]
		LEFT JOIN dbo.Veo_products vp WITH (NOLOCK) ON vp.name = csa.product
	WHERE
		csa.session_id = @session_id
		AND csa.build_id = @build_id

	--=====================================================================
	-- Convert the organization id into the external organization ID.
	--=====================================================================
	SELECT
		@hold_external_organization_id = org.external_organization_id
	FROM
		dbo.VeoSolutionsSecurity_organizations org WITH (NOLOCK)
	WHERE
		org.organization_id = @organization_id

	--=====================================================================
	-- Find all the patterns for this customer.
	--=====================================================================
	DECLARE @customerPatterns TABLE (
	pattern_id INT )

	INSERT INTO @customerPatterns (
		pattern_id )
	SELECT
		pp.pattern_id
	FROM
		dbo.Veo_product_patterns pp WITH (NOLOCK)
		LEFT JOIN dbo.Veo_product_patterns_customers ppc WITH (NOLOCK) ON ppc.pattern_id = pp.pattern_id
	WHERE
		ppc.pattern_id IS NULL

	--=====================================================================
	-- Find all patterns that satisfy the criteria.
	--=====================================================================
	SELECT DISTINCT
		pp.application_id,
		pp.product_id,
		pp.pattern_id,
		pp.pattern_name,
		pp.image_data,
		( SELECT
			  COUNT(pav.line_no)
		  FROM
			  dbo.Veo_photo_attributes_values pav WITH (NOLOCK)
		  WHERE
			  pav.attribute_id = 6
			  AND LTRIM(pav.value) = LTRIM(STR(pp.pattern_id))
		) AS photo_count
	FROM
		dbo.Veo_product_patterns pp WITH (NOLOCK)
		LEFT JOIN dbo.Veo_product_patterns_areas ppa WITH (NOLOCK) ON ppa.pattern_id = pp.pattern_id
		LEFT JOIN dbo.Veo_product_patterns_customers ppc WITH (NOLOCK) ON ppc.pattern_id = pp.pattern_id AND ppc.custnmbr = @hold_external_organization_id
		LEFT JOIN @customerPatterns cp ON cp.pattern_id = pp.pattern_id
	WHERE
		pp.active = 1
		AND pp.application_id = @hold_application_id
		AND pp.product_id = @hold_product_id
		AND ppa.area_id = @hold_area_id
		AND ppa.sub_area_id = @hold_sub_area_id
		AND ((ppc.pattern_id IS NOT NULL)
			  OR (cp.pattern_id IS NOT NULL) )
        AND ((@criteria = '')
              OR (PATINDEX('%'+@criteria+'%', pp.pattern_name) > 0))

	UNION

	SELECT DISTINCT
		pp.application_id,
		pp.product_id,
		pp.pattern_id,
		pp.pattern_name,
		pp.image_data,
		( SELECT
			  COUNT(pav.line_no)
		  FROM
			  dbo.Veo_photo_attributes_values pav WITH (NOLOCK)
		  WHERE
			  pav.attribute_id = 6
			  AND LTRIM(pav.value) = LTRIM(STR(pp.pattern_id))
		) AS photo_count
	FROM
		dbo.Veo_product_patterns pp WITH (NOLOCK)
		LEFT JOIN dbo.Veo_product_patterns_areas ppa WITH (NOLOCK) ON ppa.pattern_id = pp.pattern_id
		LEFT JOIN dbo.Veo_product_patterns_customers ppc WITH (NOLOCK) ON ppc.pattern_id = pp.pattern_id AND ppc.custnmbr = @hold_external_organization_id
		LEFT JOIN @customerPatterns cp ON cp.pattern_id = pp.pattern_id
	WHERE
		pp.active = 1
		AND pp.application_id = @hold_application_id
		AND pp.product_id = @hold_product_id
		AND ppa.area_id IS NULL
		AND ((ppc.pattern_id IS NOT NULL)
			  OR (cp.pattern_id IS NOT NULL) )
        AND ((@criteria = '')
              OR (PATINDEX('%'+@criteria+'%', pp.pattern_name) > 0))

END
GO
PRINT N'Creating Procedure [dbo].[vds_selPhotoAttributes]...';


GO
CREATE PROCEDURE [dbo].[vds_selPhotoAttributes]
	@photo_id INT,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 01/27/2015
	Description: Returns all of the attributes for a given photo. It also includes the
				 actual community name and address description, not just the ids.

	Modified: Shelby Mansker
	Date: 9/15/2016
	Description: If a plan name mapping exists for the photo then we will replace it with the VDS plan name.

	EXEC dbo.vds_selPhotoAttributes @photo_id = 44, @security_token = '01234567-89AB-CDEF-0000-123456789ABC' -- Front Elevation
	EXEC dbo.vds_selPhotoAttributes @photo_id = 42, @security_token = '01234567-89AB-CDEF-0000-123456789ABC' -- Contains Parts
	EXEC dbo.vds_selPhotoAttributes @photo_id = 27, @security_token = '01234567-89AB-CDEF-0000-123456789ABC' -- Contains Pattern
	EXEC dbo.vds_selPhotoAttributes @photo_id = 72, @security_token = '01234567-89AB-CDEF-0000-123456789ABC' -- Contains Product Items
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Create an attributes table variable to temporarily store the attributes, allowing us to manipulate them before sending them back
	DECLARE @attributes TABLE
	(
		attribute_id INT,
		attribute VARCHAR(MAX),
		value VARCHAR(MAX),
		sort_order INT
	)

	-- Populate the attributes with the base values
	INSERT INTO @attributes (attribute_id, attribute, value, sort_order)
	SELECT
		pa.attribute_id,
		pa.[description] AS attribute,
		pav.value,
		pa.sort_order
	FROM
		dbo.Veo_photo_attributes_values pav WITH (NOLOCK)
		LEFT JOIN dbo.Veo_photo_attributes pa WITH (NOLOCK) ON pa.attribute_id = pav.attribute_id
	WHERE
		pav.photo_id = @photo_id
		AND pav.attribute_id NOT IN (8, 11, 12, 13) --don't include Key Phrase (8), Photo Quality (11), Category (12), or Product Item (13)

	-- If there is an area attribute, we need to replace it with the human readable version
	UPDATE
		@attributes
	SET
		value = ar.[name]
	FROM
		@attributes a
		JOIN dbo.Veo_areas ar WITH (NOLOCK) ON ar.area_id = a.value
	WHERE
		a.attribute_id = 5

	-- If there are pattern attributes, we need to replace the pattern id with a human readable name
	UPDATE
		@attributes
	SET
		value = p.pattern_name
	FROM
		@attributes a
		JOIN dbo.Veo_product_patterns p WITH (NOLOCK) ON CAST(p.pattern_id AS VARCHAR(50)) = a.value
	WHERE
		a.attribute_id = 6
		AND p.pattern_name NOT LIKE '%no pattern%'

	-- If there are any colors (parts), we need to replace them with human readable names
	UPDATE
		@attributes
	SET
		attribute = dbo.Veo_of_selProductName(dbo.Veo_of_getProductFromItemNumber(value)),
		value = dbo.Veo_of_selPartName(value)
	from
		@attributes
	where
		attribute_id = 7

	-- If there are any product items, we need to replace them with human readable names
	UPDATE
		@attributes
	SET
		attribute = dbo.Veo_of_selCustomerItemProductName(cast(value as xml).value('(//item/item_product)[1]', 'varchar(10)')),
		value = cast(value as xml).value('(//item/manufacturer)[1]', 'varchar(max)') + ' ' + cast(value as xml).value('(//item/description)[1]', 'varchar(max)')
	FROM
		@attributes
	WHERE
		attribute_id = 14

	-- If there is a community, we must replace it with a human readable version
	UPDATE
		@attributes
	SET
		value = c.name
	FROM
		@attributes a
		JOIN dbo.Veo_communities c WITH (NOLOCK) ON c.community_id = a.value
	WHERE
		a.attribute_id = 2

	-- We need to convert the customer plan id to a spec plan id
	DECLARE @builder_id VARCHAR(MAX) = ''
	DECLARE @plan_id VARCHAR(MAX) = ''
	DECLARE @echelon_plan_name VARCHAR(MAX) = NULL
	DECLARE @vds_plan_name VARCHAR(MAX) = NULL

	SELECT
		@builder_id = value
	FROM
		@attributes
	WHERE
		attribute_id = 1

	SELECT
		@plan_id = value
	FROM
		@attributes
	WHERE
		attribute_id = 3

	SELECT
		@echelon_plan_name = plan_no
	FROM
		Veo_customers_plans sp WITH (NOLOCK)
	WHERE
		sp.customer_id = @builder_id
		AND sp.plan_id = @plan_id

	SELECT
		@vds_plan_name = aop.NAME
	FROM
		VeoSolutionsSecurity_account_organization_plans aop
		JOIN VeoSolutionsSecurity_account_organization_plans_mappings aopm ON aop.plan_id = aopm.plan_id
	WHERE
		aopm.mapped_name = @echelon_plan_name

	UPDATE
		@attributes
	SET
		value = ISNULL(@vds_plan_name, @echelon_plan_name)
	FROM
		@attributes
	WHERE
		attribute_id = 3

	-- Return all of the attributes, sorted by sort_order, except for the customer attribute
	SELECT
		attribute_id,
		attribute,
		value
	FROM
		@attributes
	WHERE
		attribute_id <> 1
	ORDER BY sort_order
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPhotoIDsBySingleAttribute]...';


GO
CREATE PROCEDURE dbo.[vds_selPhotoIDsBySingleAttribute]
	@attribute_id int,
	@attribute_value varchar(200),
	@community_id int = 0,
	@builder_id varchar(50) = '',
    @security_token uniqueidentifier
AS
/*
    Author: Shelby Mansker
    Create Date: 01/20/2015
    Description: Returns a list of photos, ids only, that match the passed
      in parameters. The attribute id and value are used to return all photos that contain
      that attribute. The community_id and builder_id are used to further filter the results, 
      and are not required. The photo ids can be used to fetch specific image data and/or attributes.

    vds_selPhotosBySingleAttribute
        @attribute_id = 12,
        @attribute_value = '4',
        @community_id = 4764,
        @builder_id = 'MHI1957',
        @security_token = '01234567-89AB-CDEF-0000-123456789ABC'

    VEO.dbo.vsp_selThumbnailPhotosBySingleAttribute
        @attribute_id = 12,
        @attribute_value = '4',
        @community_id = 4764,
        @builder_id = 'MHI1957',
        @security_token = '00000000-0000-0000-0000-000000000000'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Return the Photo IDs that match the parameters passed in
	SELECT DISTINCT
		p.photo_id
	FROM 
		Veo_photos p with (nolock) 		
		left join Veo_photo_attributes_values pavPhoto with (nolock) on p.photo_id = pavPhoto.photo_id 
		left join Veo_photo_attributes_values pavCommunity with (nolock) on p.photo_id = pavCommunity.photo_id AND pavCommunity.attribute_id = 2
		left join Veo_photo_attributes_values pavBuilder with (nolock) on p.photo_id = pavBuilder.photo_id AND pavBuilder.attribute_id = 1
	WHERE 
		 pavPhoto.attribute_id = @attribute_id 
         AND pavPhoto.value = @attribute_value
   		 AND (@community_id = 0 OR pavCommunity.value = @community_id)
   		 AND (@builder_id = '' OR pavBuilder.value = @builder_id)
	     AND p.photo_data IS NOT NULL
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPlanBudget]...';


GO
CREATE PROCEDURE [dbo].[vds_selPlanBudget]
	@user_id UNIQUEIDENTIFIER,
	@plan_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 5/17/2019
	Description: Fetches the budget information for a specific plan, if it exists.
		The first result set contains the plan budget header record. The second
		result set returns the current data values for the budget.
*/
BEGIN
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Returns the plan budget that matches the specified user and plan.
	SELECT TOP (1)
		* 
	FROM
		dbo.plan_budget WITH (NOLOCK)
	WHERE
		[user_id] = @user_id
		AND plan_id = @plan_id

	-- Returns all of the data values for the plan budget.
	SELECT
		pbv.*,
		pbvn.[name]
	FROM
		dbo.plan_budget pb WITH (NOLOCK)
		LEFT JOIN dbo.plan_budget_values pbv WITH (NOLOCK) ON pbv.plan_budget_id = pb.id
		LEFT JOIN dbo.plan_budget_values_names pbvn WITH (NOLOCK) ON pbvn.id = pbv.name_id
	WHERE
		pb.[user_id] = @user_id
		AND pb.[plan_id] = @plan_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPlanBudgetValueNames]...';


GO
CREATE PROCEDURE [dbo].[vds_selPlanBudgetValueNames]
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 5/17/2019
	Description: Returns all of the available Plan Budget Value Names.
*/
BEGIN
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT * FROM dbo.plan_budget_values_names;
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPlanDocument]...';


GO
CREATE PROCEDURE vds_selPlanDocument
@id UNIQUEIDENTIFIER
AS
BEGIN 
/*
	Author: Robert Hobbs
	Create Date: 09/4/18
	Description: Get a single plan document (with binary data) 

*/

SELECT
	id, 
	profile_plan_id, 
	doc_type, 
	mime_type, 
	session_id, 
	doc_data, 
	author, 
	create_date 
FROM 
	plan_documents 
WHERE
	id = @id

END
GO
PRINT N'Creating Procedure [dbo].[vds_selPlanDocuments]...';


GO
CREATE PROCEDURE vds_selPlanDocuments 
@profile_plan_id UNIQUEIDENTIFIER, 
@include_doc_data bit = 0 
AS
BEGIN 
/*
	Author: Robert Hobbs
	Create Date: 09/3/18
	Description: Get all plan documents for given profile plan 
	Pass 0 for @include_doc_data to exclude that and make it more performant 

	Modified: Art deHoyos
	Modified Date: 10/10/18
	Description: join on sessions to filter by show_report.

	Testing: 
	select * from plan_documents 
	vds_selPlanDocuments '7B6E5C4D-B9AD-41F2-AD54-04C7FD2C3844', 0 
	
*/

SELECT
	id, 
	profile_plan_id, 
	doc_type, 
	mime_type, 
	session_id, 
	CASE @include_doc_data
	WHEN 0 THEN NULL 
	ELSE doc_data 
	END as doc_data,  
	author, 
	create_date
FROM 
	plan_documents
WHERE
	profile_plan_id = @profile_plan_id 
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPlanDocumentWithoutBinaryData]...';


GO
CREATE PROCEDURE [dbo].[vds_selPlanDocumentWithoutBinaryData]
	@id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 9/30/2021
	Description: Get a single plan document (without binary data)
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		id,
		profile_plan_id,
		doc_type,
		mime_type,
		session_id,
		author,
		create_date
	FROM
		dbo.plan_documents WITH (NOLOCK)
	WHERE
		id = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPlanItemsSort]...';


GO
CREATE PROCEDURE [dbo].[vds_selPlanItemsSort]
@security_token UNIQUEIDENTIFIER
AS
/*
    Author: Saul Sanchez
    Created: 03/02/2017
    Description: Returns the plan items sort table
*/
BEGIN

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT *
    FROM
        Veo_plan_items_sort
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPlanSelectionsReports]...';


GO
CREATE PROCEDURE [dbo].[vds_selPlanSelectionsReports]
@profile_plan_id UNIQUEIDENTIFIER, 
@include_doc_data bit = 0 
AS
BEGIN 
/*
	Author: Art deHoyos
	Create Date: 10/22/18
	Description: Get completed session selections reports for given profile plan 
	Pass 0 for @include_doc_data to exclude that and make it more performant 

	Testing: 
	select * from plan_documents 
	vds_selPlanDocuments '7B6E5C4D-B9AD-41F2-AD54-04C7FD2C3844', 0 
	
*/

SELECT
	id, 
	profile_plan_id, 
	doc_type, 
	mime_type, 
	pd.session_id, 
	CASE @include_doc_data
	WHEN 0 THEN NULL 
	ELSE doc_data 
	END as doc_data,  
	pd.author, 
	pd.create_date,
	aouppcs.show_report,
	aouppcs.designer,
	ss.status as session_status
FROM 
	plan_documents  pd
JOIN account_organization_user_profile_plan_catalog_sessions aouppcs
	ON pd.session_id = aouppcs.session_id
JOIN session_statuses ss 
	ON aouppcs.status = ss.status_id
WHERE
	profile_plan_id = @profile_plan_id
	AND doc_type = 'SESSION_SELECTIONS'
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPriceLevelBom]...';


GO
CREATE PROCEDURE dbo.vds_selPriceLevelBom 
	@session_id UNIQUEIDENTIFIER,
	@catalog_selections_row_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 1/8/2016
	Description: Returns the serialized, and compressed, bom for 
		a price level. The session_id helps us in the index search,
		making it a bit faster to locate. The catalog_selections_row_id
		is the id of the price level (row_id) in the catalog_selections table.
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		*
	FROM
		catalog_selections_price_level_boms WITH (NOLOCK)
	WHERE
		session_id = @session_id
		AND catalog_selections_row_id = @catalog_selections_row_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPriceLevelHeader]...';


GO
CREATE PROCEDURE dbo.vds_selPriceLevelHeader
    @session_id UNIQUEIDENTIFIER,
    @build_id INT,
    @group_id VARCHAR(100),
    @security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 1/11/2016
	Description: Returns the price level record for a specific price level,
		from the catalog_selections table.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT TOP 1
        *
    FROM
        dbo.catalog_selections WITH (NOLOCK)
    WHERE
        session_id = @session_id
        AND build_id = @build_id
        AND [source] = 'Prices Landed'
        AND item_no = @group_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPriceLevelsByBuild]...';


GO
CREATE PROCEDURE [dbo].[vds_selPriceLevelsByBuild]
    @session_id UNIQUEIDENTIFIER,
    @build_id INT,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 8/7/2015
    Description: Returns all of the pricing levels for a session's build.
        A build represents a specific application and product, in a given area.
        Ignore price levels that contain the word 'pad' or 'edge'

    Modified: Shelby Mansker
    Date: 8/25/2015
    Description: Now returns all catalog_selections fields.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT 
        cs.*,
        ISNULL(bs.contract_sort_order, 99999) AS sort_order
	FROM 
		dbo.catalog_selections cs WITH (NOLOCK)
        LEFT JOIN Veo_applications a WITH (NOLOCK) ON a.name = cs.[application]
        LEFT JOIN Veo_products p WITH (NOLOCK) ON p.name = cs.product
        LEFT JOIN dbo.account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
            ON ppcs.session_id = cs.session_id
        LEFT JOIN Veo_builder_styles bs WITH (NOLOCK)
            ON bs.spec_id = ppcs.spec_id
            AND bs.application_id = a.application_id
            AND bs.product_id = p.product_id
            AND bs.item_type = cs.item_type
            AND bs.item = cs.item_no
            AND bs.effective_date = ppcs.effective_date
	WHERE
		cs.session_id = @session_id
		AND cs.build_id = @build_id
        AND cs.item NOT LIKE '%pad%'
        AND cs.item NOT LIKE '%edge%'
		AND cs.[source] = 'Prices Landed'
    ORDER BY sort_order    
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPriceLevelsThatContainColorForSession]...';


GO
CREATE PROCEDURE [dbo].[vds_selPriceLevelsThatContainColorForSession]
	@session_id UNIQUEIDENTIFIER,
	@part_no VARCHAR(31),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 8/14/2019
	Description: This proc will return a list of price levels where the specified color
		may be selected. It traverses the style and group structures, honors homebuyer
		visibility per the stocking codes table, and honors exclusions as defined in
		the spec_area_items table.

		We do not explicitly check for group exclusions from areas, because the echelon
		price generation routine, which populates prices landed, won't generate a price
		level for an area, if that price level's group has been excluded from an area.


*/
BEGIN
	-- =============================================================================
	-- Authentication
	-- =============================================================================
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR(N'Access Denied.',16,1)
		RETURN
	END

	-- =============================================================================
	-- Get and Validate information about the color. make sure this color can be
	-- selected by homebuyers, per the flag in the stocking_codes table.
	-- =============================================================================
	DECLARE @style_id VARCHAR(25)

	SELECT
		@style_id = c.style_id
	FROM
		Veo_colors c WITH (NOLOCK)
		JOIN Veo_stocking_codes vsc WITH (NOLOCK) ON vsc.code = c.stocking_code
	WHERE
		c.part_no = @part_no
		AND vsc.homebuyer_selectable = 1

	IF (@style_id IS NULL)
	BEGIN
		RAISERROR(N'The color "%s" is not a valid, homebuyer selectable color',16,1,@part_no)
		RETURN
	END

	-- =============================================================================
	-- We will create a temporary table to store the matching price levels that we
	-- find, containing the color, along with their build information.
	-- =============================================================================
	CREATE TABLE #matching_price_levels
	(
		build_id INT,
		build_description VARCHAR(100),
		area VARCHAR(100),
		area_id VARCHAR(25),
		sub_area VARCHAR(100),
		sub_area_id VARCHAR(25),
		[application] VARCHAR(100),
		application_id VARCHAR(100),
		product VARCHAR(100),
		product_id VARCHAR(100),
		price_level_type VARCHAR(50),
		price_level_id VARCHAR(100),
		price_level_price DECIMAL(18,2)
	)

	-- =============================================================================
	-- Since some price levels can be styles or colors, we need to check those first.
	-- The item_type column of the catalog_selections table indicates if a row is for
	-- a group, color, style, or something else. The item_no column will contain the
	-- group, color, or style id.
	-- =============================================================================
	INSERT #matching_price_levels
		SELECT
			csa.build_id,
			csa.area AS build_description,
			areas.[name] as area,
			csa.area_id,
			sub_areas.[name] AS sub_area,
			csa.sub_area_id,
			a.[name] AS [application],
			a.application_id,
			p.[name] AS [product],
			p.product_id,
			cs.item_type,
			cs.item_no,
			cs.price
		FROM
			catalog_selections_areas csa WITH (NOLOCK)
			JOIN Veo_areas areas WITH (NOLOCK) ON areas.area_id = csa.area_id
			JOIN Veo_sub_areas sub_areas WITH (NOLOCK) ON sub_areas.sub_area_id = csa.sub_area_id
			JOIN catalog_selections cs WITH (NOLOCK) ON cs.session_id = csa.session_id AND cs.build_id = csa.build_id
			JOIN VEO_applications a WITH (NOLOCK) ON a.[name] = cs.[application]
			JOIN VEO_products p WITH (NOLOCK) ON p.[name] = cs.product
		WHERE
			csa.session_id = @session_id
			AND ((cs.item_type = 'color' AND cs.item_no = @part_no) OR (cs.item_type = 'style' AND cs.item_no = @style_id))

	-- =============================================================================
	-- Now handle all of the price levels that are groups. We store all of the styles
	-- and colors that belong in a group, in the catalog_selections_group_detail
	-- table. So, we join that table with the catalog_selections records that have
	-- an item_type of 'group', and then look for any with a matching color or style id.
	-- =============================================================================
	INSERT #matching_price_levels
		SELECT
			csa.build_id,
			csa.area AS build_description,
			areas.[name] as area,
			csa.area_id,
			sub_areas.[name] AS sub_area,
			csa.sub_area_id,
			a.[name] AS [application],
			a.application_id,
			p.[name] AS [product],
			p.product_id,
			cs.item_type,
			cs.item_no,
			cs.price
		FROM
			catalog_selections_areas csa WITH (NOLOCK)
			JOIN Veo_areas areas WITH (NOLOCK) ON areas.area_id = csa.area_id
			JOIN Veo_sub_areas sub_areas WITH (NOLOCK) ON sub_areas.sub_area_id = csa.sub_area_id
			JOIN catalog_selections cs WITH (NOLOCK) ON cs.session_id = csa.session_id AND cs.build_id = csa.build_id
			JOIN catalog_selections_group_detail gd WITH (NOLOCK) ON gd.session_id = cs.session_id AND gd.group_id = cs.item_no AND cs.item_type = 'group'
			JOIN VEO_applications a WITH (NOLOCK) ON a.[name] = cs.[application]
			JOIN VEO_products p WITH (NOLOCK) ON p.[name] = cs.product
		WHERE
			csa.session_id = @session_id
			AND ((gd.item_type = 'color' AND gd.item = @part_no) OR (gd.item_type = 'style' AND gd.item = @style_id))

	-- =============================================================================
	-- Groups/Colors/Styles can be excluded from certain areas, so we need to take
	-- care of that now. First, we'll need the spec id.
	-- =============================================================================
	DECLARE @spec_id INT

	SELECT
		@spec_id = spec_id
	FROM
		account_organization_user_profile_plan_catalog_sessions cs WITH (NOLOCK)
	WHERE
		session_id = @session_id

	DELETE
		#matching_price_levels
	FROM
		#matching_price_levels  src
		JOIN VEO_plan_builds vpb WITH (NOLOCK) ON vpb.build_id_num = src.build_id
		JOIN VEO_spec_areas_items sai WITH (NOLOCK)
			ON sai.application_id = src.application_id
			AND sai.product_id = src.product_id
			AND sai.area_id = src.area_id
			AND sai.sub_area_id = src.sub_area_id
			AND (sai.location_id = vpb.location_id OR sai.location_id = 0)
	WHERE
		sai.spec_id = @spec_id
		AND sai.excluded = 1
		AND ((sai.item_type = 'color' AND sai.item = @part_no) OR (sai.item_type = 'style' AND sai.item = @style_id))

	-- =============================================================================
	-- Return all of the price levels that can contain the specified color.
	-- =============================================================================
	SELECT
		*
	FROM
		#matching_price_levels
	ORDER BY
		build_description
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPrimaryPlanCatalogBySession]...';


GO
CREATE PROCEDURE [dbo].[vds_selPrimaryPlanCatalogBySession]
	@session_id uniqueidentifier,
	@security_token uniqueidentifier
AS
/*
	Author: Roger Wang
	Date: 3/31/2023
	Description: Returns the primary plan catalog information for session
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	select
		p.*
	from
		primary_plan_catalogs p
	where
		p.session_id = @session_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selPrimaryPlanCatalogForProfilePlan]...';


GO
CREATE PROCEDURE [dbo].[vds_selPrimaryPlanCatalogForProfilePlan]
	@profile_plan_id uniqueidentifier,
	@security_token uniqueidentifier
AS
/*
	Author: Roger Wang
	Date: 7/26/2019
	Description: Returns the primary plan catalog information
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	select
		p.*
	from
		primary_plan_catalogs p
	where
		p.profile_plan_id = @profile_plan_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selProblemTypes]...';


GO
CREATE PROCEDURE [dbo].[vds_selProblemTypes]
    @security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 02/25/2019
	Description: Fetches Problem Types
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	SELECT
		[type_id],
		[name]
	FROM
		dbo.problem_types WITH (NOLOCK)
END
GO
PRINT N'Creating Procedure [dbo].[vds_selProfilePlan]...';


GO
CREATE PROCEDURE dbo.vds_selProfilePlan 
    @account_id uniqueidentifier,
    @organization_id uniqueidentifier,
    @user_id uniqueidentifier,
    @community varchar(50),
    @series varchar(50),
    @plan varchar(50),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:		Shelby Mansker
	Create date: 10/17/2014
	Description:	Returns the account organization user profile plan record
				that matches the parameters passed in.

	Modified: Shelby Mansker
	Date: 9/27/2017
	Description: Simplified query, returning all profile plan columns, rather than listing them individually.

	Modified: Shelby Mansker
	Date: 6/3/2020
	Description: Modified the results to match the other stored procedures that return Profile Plan information.
		Also added the plan's address_specific flag to the output.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END
    
	SELECT 
		pp.*,
		ao.account_org_id,
		up.profile_id AS user_profile_id,
		o.property_desc_1_label,
		o.property_desc_2_label,
		(select top 1 community_id from [dbo].[VeoSolutionsSecurity_account_organization_communities] where account_id = pp.account_id and organization_id = pp.organization_id and name = LTRIM(RTRIM(pp.community_name))) as community_id,
		(select top 1 series_id from [dbo].[VeoSolutionsSecurity_account_organization_series] where account_id = pp.account_id and organization_id = pp.organization_id and name = LTRIM(RTRIM(pp.series))) as series_id,
		(select top 1 plan_id from [dbo].[VeoSolutionsSecurity_account_organization_plans] where account_id = pp.account_id and organization_id = pp.organization_id and name = LTRIM(RTRIM(pp.plan_name))) as plan_id,
		(select top 1 address_specific from [dbo].[VeoSolutionsSecurity_account_organization_plans] where account_id = pp.account_id and organization_id = pp.organization_id and name = LTRIM(RTRIM(pp.plan_name))) as address_specific,
		(select top 1 plan_id from [dbo].[VeoSolutionsSecurity_account_organization_plans] where account_id = pp.account_id and organization_id = pp.organization_id and name = LTRIM(RTRIM(pp.base_plan_name))) as base_plan_id
	FROM 
		account_organization_user_profile_plan pp
		JOIN account_organization_user_profile up ON up.account_id = pp.account_id AND up.organization_id = pp.organization_id AND up.[user_id] = pp.[user_id]
		JOIN dbo.VeoSolutionsSecurity_account_organizations ao ON ao.account_id = pp.account_id AND ao.organization_id = pp.organization_id
		JOIN veosolutionssecurity_organizations o ON o.organization_id = ao.organization_id
	WHERE
		pp.account_id = @account_id
		AND pp.organization_id = @organization_id
		AND pp.[user_id] = @user_id
		AND pp.community_name = @community
		AND pp.series = @series
		AND pp.plan_name = @plan
END
GO
PRINT N'Creating Procedure [dbo].[vds_selProfilePlanById]...';


GO
CREATE PROCEDURE dbo.vds_selProfilePlanById
    @profile_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:			Art deHoyos
	Create date:	3/11/2019
	Description:	Returns the account organization user profile plan record
					that matches the id passed in.

	Modified:		Roger Wang
	Create date:	5/30/2019
	Description:	Includes account_org_id.

	Modified: Shelby Mansker
	Date: 6/3/2020
	Description: Modified the results to match the other stored procedures that return Profile Plan information.
		Also added the plan's address_specific flag to the output.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT 
		pp.*,
		ao.account_org_id,
		up.profile_id AS user_profile_id,
		o.property_desc_1_label,
		o.property_desc_2_label,
		(select top 1 community_id from [dbo].[VeoSolutionsSecurity_account_organization_communities] where account_id = pp.account_id and organization_id = pp.organization_id and name = LTRIM(RTRIM(pp.community_name))) as community_id,
		(select top 1 series_id from [dbo].[VeoSolutionsSecurity_account_organization_series] where account_id = pp.account_id and organization_id = pp.organization_id and name = LTRIM(RTRIM(pp.series))) as series_id,
		(select top 1 plan_id from [dbo].[VeoSolutionsSecurity_account_organization_plans] where account_id = pp.account_id and organization_id = pp.organization_id and name = LTRIM(RTRIM(pp.plan_name))) as plan_id,
		(select top 1 address_specific from [dbo].[VeoSolutionsSecurity_account_organization_plans] where account_id = pp.account_id and organization_id = pp.organization_id and name = LTRIM(RTRIM(pp.plan_name))) as address_specific,
		(select top 1 plan_id from [dbo].[VeoSolutionsSecurity_account_organization_plans] where account_id = pp.account_id and organization_id = pp.organization_id and name = LTRIM(RTRIM(pp.base_plan_name))) as base_plan_id
	FROM 
		account_organization_user_profile_plan pp
		JOIN account_organization_user_profile up ON up.account_id = pp.account_id AND up.organization_id = pp.organization_id AND up.[user_id] = pp.[user_id]
		JOIN dbo.VeoSolutionsSecurity_account_organizations ao ON ao.account_id = pp.account_id AND ao.organization_id = pp.organization_id
		JOIN veosolutionssecurity_organizations o ON o.organization_id = ao.organization_id
	WHERE
		pp.profile_id = @profile_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selProfilePlanCommunitySeriesPlan]...';


GO
CREATE PROCEDURE [dbo].[vds_selProfilePlanCommunitySeriesPlan] 
    @profile_id UNIQUEIDENTIFIER
AS
/*
   Author:		Art deHoyos
   Create date: 3/8/2019
   Description:	Gets the community, series, and plan for a given profile plan id
*/
BEGIN    
    SELECT
        profile_id,
		community_name,
		series,
		plan_name
    FROM
        dbo.account_organization_user_profile_plan pp WITH (NOLOCK)
	WHERE
		profile_id = @profile_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selProfilePlanSessionHistory]...';


GO
CREATE PROCEDURE [dbo].[vds_selProfilePlanSessionHistory]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@user_id UNIQUEIDENTIFIER,
	@community_name VARCHAR(50),
	@series VARCHAR(50),
	@plan_name VARCHAR(50),
	@security_token UNIQUEIDENTIFIER
/*
	Author: Shelby Mansker
	Date: 7/12/2018
	Description: Returns all of the z_table records for sessions that belong to, or were deleted from,
			the specified profile plan.
*/
AS
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END
	
	SELECT
		*
	FROM
		z_account_organization_user_profile_plan_catalog_sessions WITH (NOLOCK)
	WHERE
		account_id = @account_id
		AND organization_id = @organization_id
		AND [user_id] = @user_id
		AND community_name = @community_name
		AND series = @series
		AND plan_name = @plan_name
	ORDER BY
		z_time DESC
END
GO
PRINT N'Creating Procedure [dbo].[vds_selProfilePlanSessions]...';


GO
CREATE PROCEDURE [dbo].[vds_selProfilePlanSessions]
    @account_id uniqueidentifier,
    @organization_id uniqueidentifier,
    @user_id uniqueidentifier,
    @community varchar(50),
    @series varchar(50),
    @plan varchar(50),
	@security_token UNIQUEIDENTIFIER
AS
/*
   =============================================
   Author:		Shelby Mansker
   Create date: 10/15/2014
   Description:	Returns all of the sessions that belong to a 
                particular account organization user profile plan

   Modified: 12/18/2014 - Shelby Mansker
             Returns more information now than just session IDs. Also renamed this proc,
             it used to be vds_selProfilePlanSessionIDs.
   =============================================
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT
        aouppcs.account_id,
        aouppcs.organization_id,
        aouppcs.[user_id],
        aouppcs.community_id,
        aouppcs.community_name,
        aouppcs.series,
        aouppcs.plan_name,
        aouppcs.plan_version,
        aouppcs.session_id,
        aouppcs.[status],
        ss.[status] AS status_name,
        aouppcs.session_notes,
        aouppcs.deposit,
        aouppcs.deposit_notes,
        aouppcs.designer_id,
        aouppcs.designer,
        aouppcs.spec_id,
        aouppcs.effective_date,
        aouppcs.completed_date,
        aouppcs.first_completed_date,
        aouppcs.export_date,
        aouppcs.address_id,
        aouppcs.rounding_type,
        aouppcs.rounding_places,
        aouppcs.builder_markup_hb_pricing
    FROM
        dbo.account_organization_user_profile_plan_catalog_sessions aouppcs WITH (NOLOCK)
        LEFT JOIN dbo.session_statuses ss WITH (NOLOCK) ON ss.status_id = aouppcs.[status]
    WHERE
        account_id = @account_id
        AND organization_id = @organization_id
        AND [user_id] = @user_id
        AND community_name = @community
        AND series = @series
        AND plan_name = @plan

END
GO
PRINT N'Creating Procedure [dbo].[vds_selSchedulingAppointmentsForBuyer]...';


GO
CREATE PROCEDURE [dbo].[vds_selSchedulingAppointmentsForBuyer]
@buyer_profile_id uniqueidentifier, 
@security_token uniqueidentifier =  null 
as 

/*
	Author:		 Unknown
	Create date: Unknown
	Description: Fetches the scheduled appointments for a homebuyer. 

	Modifier:    Saul Sanchez
	Modify date: 03/16/2017
	Description: Return the address for the appointment location.

	Modifier:    Roger Wang
	Modify date: 01/31/2019
	Description: Return the phone number for the appointment location.
*/

-- TESTING 
-- vds_selSchedulingAppointmentsForBuyer 'AE3B77D8-A23B-4549-B430-075BA4B68BA4'
-- select * from scheduling_buyers where profile_id = 'AE3B77D8-A23B-4549-B430-075BA4B68BA4'
-- select * from account_organization_user_profile
-- select top 10 * from scheduling_appointments

SELECT 
	a.appointment_id, 
	a.buyer_profile_id, 
	a.account_org_id, 
	a.appointment_date, 
	CAST(a.start_time AS TIME) AS start_time,
	CAST(a.end_time AS TIME) as end_time, 
	a.appointment_duration,
	a.is_scheduled, 
	a.appointment_type, 
	su.first_name + ' ' + su.last_name as designer_name,
	sl.[address] AS appointment_address,
	sl.[phone_number]
FROM 
	scheduling_appointments a with (nolock) 
	LEFT JOIN scheduling_users su with (nolock) on su.user_id = a.schedule_user_id 
	LEFT JOIN VeoSolutionsSecurity_locations sl ON sl.location_id = a.location_id
WHERE
	a.buyer_profile_id = @buyer_profile_id 
ORDER BY appointment_type asc
GO
PRINT N'Creating Procedure [dbo].[vds_selSchedulingDesignCenterForBuyer]...';


GO
CREATE procedure [dbo].[vds_selSchedulingDesignCenterForBuyer]
@account_org_id uniqueidentifier, 
@user_id uniqueidentifier, 
@security_token uniqueidentifier = null
as



-- todo: add security token check here 
--SUMMARY 
--Returns info for the Design Center based on the session id 
--
--TESTING / RESEARCH
-- select top 10 * from catalog_selections where session_id = '246897EF-3F2C-45AD-8C5A-29CFD7798C9A'
-- select top 10 * from account_organization_user_profile_plan_catalog_sessions where session_id = '246897EF-3F2C-45AD-8C5A-29CFD7798C9A' 
-- select top 10 * from VeoSolutionsSecurity_account_organizations where organization_id = '8AAECC3A-2D9E-4500-B0CF-D79D947D33A7'
-- select top 10 * from VeoSolutionsSecurity_organizations where organization_id = '8AAECC3A-2D9E-4500-B0CF-D79D947D33A7'  
-- select * from VeoSolutionsSecurity_account_organization_locations
-- select top 10 * from catalog_selections order by create_date desc
-- vds_selSchedulingDesignCenterForBuyer '573E9081-BC15-4F1C-805B-1688ABF317C7', 'F15AC710-CDF1-4933-966C-4F28A7C2EDC8'

-- Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

-- fetch the first "Design Center" location for the org. 
-- todo: when scheduling is ported we need to add address id to the scheduling_appointments table...
SELECT 
	TOP 1 a.*, oa.address_name 
FROM 
	addresses a 
	JOIN account_organization_addresses oa with (nolock) on oa.address_id = a.address_id 
	JOIN VeoSolutionsSecurity_account_organizations o with (nolock) on  o.account_org_id = oa.account_org_id
WHERE 
	o.account_org_id = @account_org_id 
	AND 
	a.address_type = 'Design Center'
GO
PRINT N'Creating Procedure [dbo].[vds_selSchedulingDesignerAppointmentsByDate]...';


GO
CREATE PROCEDURE [dbo].[vds_selSchedulingDesignerAppointmentsByDate]
	@user_id UNIQUEIDENTIFIER, 
	@date DATETIME,
	@security_token UNIQUEIDENTIFIER = null	
AS
/*
	Author:		???
	Create date: 4/17/2014
	Description:	???

	Updated 02/02/15: added Designer Name to results. 

	Updated 09/06/14: Modified to join on scheduling orgs. It now ONLY returns appointments for the date if the user id is 
	associated with the organization on the appointment in SCHEDULING. - RH 

	Modified: 04.17.14 to check if the user is also a system administrator 
	AND return ALL appointments for any scheduling orgs for that admin.
	
	Modified: 04.22.14 to also include status 4 (pending complete) 
	
	Updated 5/23/2014: Added this comment block AND reformatted the
	proc a little. Updated the security token validation code to be
	consistent with other procs. -Shelby

    Updated 06/20/2014: Modified the logic for determining statuses per Richard's design. Saul.

    Updated 06/27/2014: Reordered the when statements in the case statement so we check for "no sessions"
                        before the other statuses.  Statuses that should have been "no sessions" were
                        coming back as "inactive".

    Updated 08/25/2014: Split out "active" and "pending" status, rather than lumping them both under active.

    UPdated 01/16/2015: Added [series] and [user_id] to the results.

	Modifier:    Saul Sanchez
	Modify date: 03/16/2017
	Description: Return the profile plan address as plan_address.

	-- LOCAL TESTING 
	-- fetch for phil! 

	SELECT TOP 100 * FROM VeoSolutionsSecurity_account_organization_users WHERE first_name = 'phil'
	select top 100 * from veosolutionssecurity_users where first_name = 'phil' 
	select top 100 * from scheduling_users  where first_name = 'phil' 
	[vds_selSchedulingDesignerAppointmentsByDate] 'F5352E11-1A3A-4E69-A11F-1EE17F2BD4BB', '02/02/2015', '01234567-89AB-CDEF-0000-123456789ABC'
	[vds_selSchedulingDesignerAppointmentsByDate] '0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', '02/02/2015', '01234567-89AB-CDEF-0000-123456789ABC'
	 
	-- Find some appointments 
	
	SELECT * FROM scheduling_appointments WHERE schedule_user_id = '0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B'
	SELECT * FROM scheduling_appointments WHERE appointment_date > '01/01/14'

	-- testing if admin 

	SELECT dbo.vds_isUserSysAdmin('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B')

	-- Finding users....

	SELECT * FROM VeoSolutionSecurity_users
	SELECT * FROM VeoSolutionSecurity_locations
	SELECT * FROM scheduling_buyers
	SELECT TOP 100 * FROM account_organization_user_profile 
	SELECT TOP 100 * FROM account_organization_user_profile_plan
	SELECT TOP 100 * FROM account_organization_user_profile_plan_catalog_sessions WHERE status = 1
	SELECT TOP 100 * FROM VeoSolutionSecurity_account_organization_users
*/

BEGIN

    --DECLARE	@user_id UNIQUEIDENTIFIER
    --DECLARE @date DATETIME

    --SET @user_id = '0e4c3d85-5acf-4d8c-af40-a5e33715ed8b'
    --SET @date = '06/26/2014'

	-- Validate the security token
	--IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	--BEGIN
	--	RAISERROR('Access Denied.',16,1)
	--	RETURN
	--END

	-- determine if user is an admin 
	DECLARE @is_sysadmin BIT
	SET @is_sysadmin = dbo.vdsf_isUserSysAdmin(@user_id)

	SELECT 
		CAST(a.start_time AS TIME) AS start_time,
		o.display_name AS org_name, 
		sb.buyer_name, 
		CASE 
			WHEN LEN(sbc.mobile_phone) > 0 THEN sbc.mobile_phone
			WHEN LEN(sbc.home_phone) > 0 THEN sbc.home_phone
			ELSE sbc.work_phone
		END AS phone_number,
		upplans.[address] as plan_address, 
		upplans.lot,
		upplans.[block],
		upplans.community_name, 
        upplans.series,
		upplans.plan_name, 
		upplans.account_id,
		upplans.organization_id,
        upplans.[user_id],
		su.first_name + ' ' + su.last_name as designer_name, 
		(   SELECT TOP 1
				ppcs.session_id
			FROM
				account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
			WHERE
				ppcs.account_id = upplans.account_id
				AND ppcs.organization_id = upplans.organization_id
				AND ppcs.[user_id] = upplans.[user_id]
				AND ppcs.community_name = upplans.community_name
				AND ppcs.series = upplans.series
				AND ppcs.plan_name = upplans.plan_name
				AND ppcs.[status] IN (0, 1, 4)  
		) AS selection_session_id,
        CASE
            -- If no sessions exist, then return 'No Sessions'
            WHEN (  SELECT
                        COUNT(*)
                    FROM
  			  	        account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
			        WHERE
				        ppcs.account_id = upplans.account_id
				        AND ppcs.organization_id = upplans.organization_id
				        AND ppcs.[user_id] = upplans.[user_id]
				        AND ppcs.community_name = upplans.community_name
				        AND ppcs.series = upplans.series
				        AND ppcs.plan_name = upplans.plan_name
                 ) = 0 THEN 'no sessions'

            -- If any of the sessions have an Active status, then return 'Active'.
            WHEN (  SELECT
                        COUNT(*)
                    FROM
  			  	        account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
			        WHERE
				        ppcs.account_id = upplans.account_id
				        AND ppcs.organization_id = upplans.organization_id
				        AND ppcs.[user_id] = upplans.[user_id]
				        AND ppcs.community_name = upplans.community_name
				        AND ppcs.series = upplans.series
				        AND ppcs.plan_name = upplans.plan_name
                        AND ppcs.[status] = 1
                 ) > 0 THEN 'active'

            -- If any of the sessions have a Pending status, then return  'Pending'.
            WHEN (  SELECT
                        COUNT(*)
                    FROM
  			  	        account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
			        WHERE
				        ppcs.account_id = upplans.account_id
				        AND ppcs.organization_id = upplans.organization_id
				        AND ppcs.[user_id] = upplans.[user_id]
				        AND ppcs.community_name = upplans.community_name
				        AND ppcs.series = upplans.series
				        AND ppcs.plan_name = upplans.plan_name
                        AND ppcs.[status] = 4
                 ) > 0 THEN 'pending'

            -- If all sessions are inactive, then return 'Inactive'
            WHEN (  SELECT
                        COUNT(*)
                    FROM
  			  	        account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
			        WHERE
				        ppcs.account_id = upplans.account_id
				        AND ppcs.organization_id = upplans.organization_id
				        AND ppcs.[user_id] = upplans.[user_id]
				        AND ppcs.community_name = upplans.community_name
				        AND ppcs.series = upplans.series
				        AND ppcs.plan_name = upplans.plan_name
                        AND ppcs.[status] = 0
                 ) = (  SELECT
                            COUNT(*)
                        FROM
  			  	            account_organization_user_profile_plan_catalog_sessions ppcs WITH (NOLOCK)
			            WHERE
				            ppcs.account_id = upplans.account_id
				            AND ppcs.organization_id = upplans.organization_id
				            AND ppcs.[user_id] = upplans.[user_id]
				            AND ppcs.community_name = upplans.community_name
				            AND ppcs.series = upplans.series
				            AND ppcs.plan_name = upplans.plan_name
                     ) THEN 'inactive'
            
            -- All other cases will not be shown.
            ELSE 'do not show'

        END AS [status]
	FROM 
		scheduling_appointments a WITH (NOLOCK)
		LEFT JOIN scheduling_organizations o WITH (NOLOCK) on o.account_org_id = a.account_org_id 
		join scheduling_user_organizations suo with (nolock) on suo.account_org_id = a.account_org_id and suo.user_id = @user_id
		JOIN account_organization_user_profile_plan upplans WITH (NOLOCK) on upplans.profile_id = dbo.ef_selSchedulingBuyerActiveProfilePlan(a.buyer_profile_id)
		JOIN scheduling_buyers sb WITH (NOLOCK) on sb.profile_id = a.buyer_profile_id
		JOIN scheduling_buyers_contacts sbc with (nolock) on sbc.profile_id = sb.profile_id and is_buyer = 1
		JOIN scheduling_users su with (nolock) on su.user_id = a.schedule_user_id 
	WHERE
		a.appointment_date = @date 
		--AND (a.schedule_user_id = @user_id OR @is_sysadmin = 1) 
	ORDER BY 
		a.start_time
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSelectedPatternBySessionAndBuild]...';


GO
CREATE PROCEDURE [dbo].[vds_selSelectedPatternBySessionAndBuild]
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
	@security_token UNIQUEIDENTIFIER = NULL	
AS
/*
	Author:		???
	Create date: ???
	Description:	???

	Updated 5/23/2014: Added this comment block AND reformatted the
	proc a little. Updated the security token validation code to be
	consistent with other procs. -Shelby
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		pp.application_id,
		pp.product_id,
		pp.pattern_id,
		pp.pattern_name,
		pp.image_data,
		( SELECT
			  COUNT(pav.line_no)
		  FROM
			  dbo.Veo_photo_attributes_values pav WITH (NOLOCK)
		  WHERE
			  pav.attribute_id = 6
			  AND LTRIM(pav.value) = LTRIM(STR(pp.pattern_id))
		) AS photo_count
	FROM
		dbo.catalog_selections_areas csa WITH (NOLOCK)
		LEFT JOIN Veo_product_patterns pp WITH (NOLOCK) ON pp.pattern_id = csa.pattern_id
	WHERE
		csa.session_id = @session_id
		AND csa.build_id = @build_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSelectionSessionInfo]...';


GO
CREATE PROCEDURE [dbo].[vds_selSelectionSessionInfo]
	@session_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:      Robert Hobbs
	Create date: 7/7/2014
	Description: Returns summary information for a selection session.
	
	Updated 2014-10-10: added new fields for session details popup 

	Updated 2014-08-19: added WITH (NOLOCK) AND also added user profile id to results 

    Updated 2014-07-23: Changed joins to left joins, AND use synonymns to access other databases.
	
    Updated 2014-09-04: Added homebuyer e-mail to results. -Shelby

    Updated 2014-10-03: Modified results to only return only one plan. The order of the plans is set to 'Active', 'Contracted',
        and then everything else. We should always return the active (or completed) plan for a profile. However,
        if none are active, you'll still get the inactive one.

    Updated 2015-02-12: Added account_id, organization_id, and user_id to the results. -Shelby

	Updated 2019-10-25 - Eric Hickey
		No longer return profile plans that are 'Active', as that status has been merged with 'Contracted'

	Modified: Daniel Arwe
	Date: 8/18/2025
	Description: Added precon_notes field to selection info query.

	TESTING: 
	select top 10 * from account_organization_user_profile_plan_catalog_sessions order by create_date desc
	select top 10 * from account_organization_user_profile_plan
	select top 10 * from account_organization_user_profile order by create_date desc

	vds_selSelectionSessionInfo '81EB6354-A0D6-485D-92AC-4202DDA44BFE', null

*/
BEGIN

    --=================================================================
    --Test Variables
    --=================================================================
    --DECLARE @session_id UNIQUEIDENTIFIER = 'ca54692f-70a2-42e4-be0c-a9ba62e930ea'
   
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Get the user email for the user tied to the security token passed in
    DECLARE @current_user_email VARCHAR(100) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

    -- Get the user ID for the user tied to the security token passed in
    DECLARE @current_user_id UNIQUEIDENTIFIER = dbo.ef_getUserIdFromSecurityToken(@security_token)

    -- Get the current user's name
    DECLARE @current_user_name VARCHAR(51) = ''
    SELECT 
        @current_user_name = first_name + ' ' + last_name
    FROM
        VeoSolutionsSecurity_users
    WHERE
        [user_id] = @current_user_id

    -- Now return the session information
    SELECT TOP 1
       s.account_id,
       s.organization_id,
       s.[user_id],
       s.session_id, 
	   b.name AS builder_name, 
	   aou.first_name AS buyer_first_name, 
	   aou.last_name AS buyer_last_name, 
       u.email AS buyer_email,
       @current_user_id AS current_user_id,
       @current_user_email AS current_user_email,
       @current_user_name AS current_user_name,
	   s.community_name, 
	   s.series, 
	   s.plan_name, 
	   s.[status], 
	   CASE ISNULL(ss.[status], '')
	     WHEN '' THEN 'Unknown'
	     ELSE ss.[status]
	   END AS status_name, 
	   s.session_notes, 
	   s.precon_notes, 
	   s.spec_id, 
	   s.effective_date,
	   p.spouse_first_name, 
	   p.spouse_last_name, 
	   p.[address],
	   p.address_lot_block, 
	   p.city,
	   p.[state], 
	   p.zip_code, 
	   p.[status] AS plan_status, 
	   p.elevation, 
	   up.profile_id AS buyer_profile_id, 
	   -- new fields 
	   s.plan_version, 
	   s.designer_id,  
	   s.designer,  
	   s.completed_date, 
	   s.create_date, 
	   s.modified_date, 
	   s.export_date, 
	   s.address_id as export_id, 
	   s.deposit, 
	   s.deposit_notes, 
	   s.rounding_type, 
	   s.rounding_places, 
	   s.builder_markup_hb_pricing,
	   p.profile_id
    FROM        
		account_organization_user_profile_plan_catalog_sessions s WITH (NOLOCK)
		LEFT JOIN account_organization_user_profile_plan p WITH (NOLOCK)
            ON p.account_id = s.account_id
            AND p.organization_id = s.organization_id
            AND p.[user_id] = s.[user_id] 
            AND p.community_name = s.community_name 
            AND p.series = s.series 
            AND p.plan_name = s.plan_name 
		LEFT JOIN account_organization_user_profile up WITH (NOLOCK) 
			ON up.account_id = s.account_id 
			AND up.organization_id = s.organization_id 
			AND up.[user_id] = s.[user_id]
		LEFT JOIN VeoSolutionsSecurity_account_organization_users aou WITH (NOLOCK)
            ON aou.account_id = s.account_id 
            AND aou.organization_id = s.organization_id 
            AND aou.[user_id] = s.[user_id]
        LEFT JOIN VeoSolutionsSecurity_users u WITH (NOLOCK)
            ON u.[user_id] = aou.[user_id]
		LEFT JOIN VeoSolutionsSecurity_organizations b WITH (NOLOCK)
            ON b.organization_id = s.organization_id
        LEFT JOIN session_statuses ss WITH (NOLOCK)
            ON ss.status_id = s.[status]
	WHERE 
		s.session_id = @session_id
    ORDER BY
        CASE
			-- we can still sort by active first here (until we completely remove it) because an organization using the Prospective Status Feature should not have any profile plans with a status of active.
            WHEN p.[status] = 'Active' THEN 1
            WHEN p.[status] = 'Contracted' THEN 2
            ELSE 3
        END ASC
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSessionAreaApplicationBuilds]...';


GO
CREATE PROCEDURE [dbo].[vds_selSessionAreaApplicationBuilds]
    @session_id UNIQUEIDENTIFIER,
    @application VARCHAR(100),
    @area VARCHAR(100),
    @sub_area VARCHAR(100) = '',
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Create Date: 3/27/2015
    Description: Returns a list of builds that are available to the given area, in a specific 
                 design session, and for a specific application. Available builds are builds that
                 the builder has flagged as selectable in that area for that application. Also,
                 if the build contains a zero dollar price level, the is_standard flag will be set for
                 that build. We also indicate whether or not a build is currently selected in that area
                 
                 For example, if an area can have Tile and Wood for its flooring, this
                 proc will return the build id for each of these products.

    Modified By Shelby Mansker on 4/15/2015:
        Added the is_credit field to the results.

    Modified By Shelby Mansker on 6/4/2015:
        Fixed an issue where selected custom prices levels were causing the custom builds to be returned with the results.

    -- Tests --
    EXEC dbo.vds_selSessionAreaApplicationBuilds
        @session_id = '983c2357-6a4f-453f-bcb1-44c11fc8bddc',
        @application = 'Flooring',
        @area = 'Living',
        @sub_area = '',
        @security_token = '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Fetch the builds for this application, but only the ones with area_selected flag set to 1
    SELECT DISTINCT
        csa.session_id,
        csa.area,
        csa.sub_area,
        csa.[application],
        csa.product,
        cs.build_id,
        dbo.vdsf_buildHasFreePriceLevel(cs.session_id, cs.build_id) AS is_standard,
        CAST(IIF(Exists(SELECT row_id FROM dbo.catalog_selections WITH (NOLOCK) WHERE session_id = csa.session_id AND [application] = csa.[application] AND product = csa.product AND area = csa.area AND sub_area = csa.sub_area AND row_id = csa.selected_field_group), 1, 0) AS BIT) AS is_selected,
        dbo.vdsf_isCreditArea(csa.session_id, csa.[application], csa.product, csa.area, csa.sub_area) AS is_credit
    FROM
        dbo.catalog_selections_areas csa WITH (NOLOCK)
        JOIN dbo.catalog_selections cs WITH (NOLOCK) ON cs.session_id = csa.session_id AND cs.[application] = csa.[application] AND cs.product = csa.product AND cs.area = csa.area AND cs.sub_area = csa.sub_area
    WHERE
        csa.session_id = @session_id
        AND csa.area_selected = 1
        AND cs.[source] = 'Prices Landed'
        AND csa.[application] = @application
        AND csa.area = @area
        AND csa.sub_area = @sub_area
        AND cs.item_type <> 'custom'
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSessionCabinetAreaPriceLevels]...';


GO
CREATE PROCEDURE dbo.vds_selSessionCabinetAreaPriceLevels
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
    @door_style VARCHAR(50),
    @species VARCHAR(50),
    @door_option VARCHAR(50),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:      Shelby Mansker
	Create date: 12/02/2014
	Description: Returns all of the price levels for cabinets, using style attribute filters, for a session and build.
		
	dbo.vds_selSessionCabinetAreaPriceLevels @session_id = 'e0b8e288-a211-4f8b-af8c-a89ad9862c4a', @security_token = '01234567-89AB-CDEF-0000-123456789ABC', @build_id = 11875062, @door_style = 'BELAIRE', @species = 'MAPLE', @door_option = 'Arch'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Now fetch all of the catalog selection records that belong to the specified session and build id and have matching style attributes
    SELECT
	    cs.row_id,
	    cs.item_no,
	    cs.item,
	    cs.qty,
	    cs.price,
	    cs.selected,
	    cs.make_std
    FROM
        dbo.catalog_selections cs WITH (NOLOCK)
        JOIN dbo.Veo_colors c WITH (NOLOCK) on c.part_no = cs.item_no
        LEFT JOIN dbo.Veo_styles_attributes sa1 WITH (NOLOCK) ON sa1.product_id = c.product_id AND sa1.style_id = c.style_id AND sa1.attribute_id = 'DOOR_STYLE' AND sa1.value_id = @door_style
        LEFT JOIN dbo.Veo_styles_attributes sa2 WITH (NOLOCK) ON sa2.product_id = c.product_id AND sa2.style_id = c.style_id AND sa2.attribute_id = 'SPECIES' AND sa2.value_id = @species
        LEFT JOIN dbo.Veo_styles_attributes sa3 WITH (NOLOCK) ON sa3.product_id = c.product_id AND sa3.style_id = c.style_id AND sa3.attribute_id = 'OPTIONAL_DOOR_LOOK' AND sa3.value_id = @door_option
    WHERE
        cs.session_id = @session_id
        AND cs.build_id = @build_id
        AND cs.source = 'Prices Landed'
        AND cs.item_type = 'color'
        AND sa2.value_id IS NOT NULL
        AND sa3.value_id IS NOT NULL
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSessionCatalogItems]...';


GO
CREATE PROCEDURE dbo.vds_selSessionCatalogItems
	@session_id UNIQUEIDENTIFIER, 
	@security_token UNIQUEIDENTIFIER,
	@application VARCHAR(100) = NULL,
	@product VARCHAR(100) = NULL,
	@area VARCHAR(100) = NULL,
	@sub_area VARCHAR(100) = NULL,
	@only_with_selections BIT = 0
AS
/*
	Author: Shelby Mansker
	Date: 10/1/2015
	Description: Returns all of the catalog items, both builder
		and user created, for a given session

	Modifier: Saul Sanchez
	Date: 07/18/2018
	Description: Added a parameter to return only the catalog items that have been selected

	Modifier: Shelby Mansker
	Date: 10/24/2018
	Description: Modified the proc to accept more optional filters. It also returns additional information.

	Modifier: Shelby Mansker
	Date: 9/20/2019
	Description: Added GPC Long Description to the results. Also cleaned up the proc a bit, simplifying it, I think.

	Modifier: Shelby Mansker
	Date: 10/15/2019
	Description: Removed GPC Long Description from the results. This really isn't the proper place to include GPC specific
		information. Instead, systems should go directly to the GPC API. I did not remove Finish from the results, because
		it will require more design to remove it.

	Modifier: Roger Wang
	Date: 01/24/2022
	Description: Include original price in the response.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	SELECT
		cs.*,
		ISNULL(gp.finish, '') AS finish,
		doc_count = (SELECT COUNT(*) FROM gpc_products_documents WITH (NOLOCK) WHERE gpc_id = TRY_CONVERT(UNIQUEIDENTIFIER,cs.gpc) ),
		cs.modified_date AS last_modified_date,
		IIF(u.[user_id] IS NULL, cs.modifier, CONCAT(u.first_name, ' ', u.last_name)) AS last_modified_by,
		po.orig_price,
		r.id AS room_id,
		r.[name] AS room_name,
		a.[name] AS veo_area,
		sa.[name] AS veo_sub_area
	FROM
		dbo.catalog_selections cs WITH (NOLOCK)
		LEFT JOIN VeoSolutionsSecurity_users u WITH (NOLOCK) ON u.email = cs.modifier
		LEFT JOIN gpc_products gp WITH (NOLOCK) ON gp.gpc_id = TRY_CONVERT(UNIQUEIDENTIFIER,cs.gpc)
		LEFT JOIN dbo.catalog_selections_price_overrides po WITH (NOLOCK) ON po.session_id = cs.session_id AND po.row_id = cs.row_id
		LEFT JOIN room_sections rs WITH (NOLOCK) ON rs.area_id = cs.area AND rs.sub_area_id = cs.sub_area
		LEFT JOIN rooms r WITH (NOLOCK) ON r.id = rs.room_id
		LEFT JOIN veo_areas a WITH (NOLOCK) ON a.area_id = cs.area
		LEFT JOIN veo_sub_areas sa WITH (NOLOCK) ON sa.sub_area_id = cs.sub_area
	WHERE
		cs.session_id = @session_id
		AND (@application IS NULL OR @application = '' OR cs.[application] = @application)
		AND (@product IS NULL OR @product = '' OR cs.product = @product)
		AND (@area IS NULL OR @area = '' OR cs.area = @area OR a.[name] = @area)
		AND (@sub_area IS NULL OR @sub_area = '' OR cs.sub_area = @sub_area)
		AND ([source] = 'catalog' OR [source] = 'user')
		AND ((@only_with_selections = 0) OR (cs.selected = 1))
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSessionChanges]...';


GO
CREATE PROCEDURE [dbo].[vds_selSessionChanges]
	@session_id UNIQUEIDENTIFIER, 
	@security_token UNIQUEIDENTIFIER 
AS

/*
   Author:		Robert Hobbs
   Create date: 04/8/2019
   Description:	fetches session changes for a session. 
   The data in object_data is JSON data. 
 */
 BEGIN

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT 
		* 
	FROM 
		session_changes 
	WHERE
		session_id = @session_id 
	
 END
GO
PRINT N'Creating Procedure [dbo].[vds_selSessionChangesApplied]...';


GO
CREATE PROCEDURE [dbo].[vds_selSessionChangesApplied]
	@session_id UNIQUEIDENTIFIER, 
	@security_token UNIQUEIDENTIFIER 
AS
/*
   Author:		Robert Hobbs
   Create date: 04/12/2019
   Description:	fetches applied session changes for a session. 
 */
 BEGIN

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT 
		* 
	FROM 
		session_changes_applied
	WHERE
		session_id = @session_id 
	
 END
GO
PRINT N'Creating Procedure [dbo].[vds_selSessionDesignerDocument]...';


GO
CREATE PROCEDURE dbo.vds_selSessionDesignerDocument
	@session_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Reid Wilson
	Date: 5/2/2022
	Description: Returns all of the designer document selections for a session
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END
	
	-- Return the desired selections
	SELECT
		* 
	FROM 
		dbo.session_designer_documents WITH (NOLOCK)
	WHERE
		session_id = @session_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSessionDocument]...';


GO
CREATE PROCEDURE dbo.vds_selSessionDocument
	@session_id UNIQUEIDENTIFIER,
	@document_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 1/15/2016
	Description: Returns a single session document
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		*
	FROM
		dbo.account_organization_user_profile_plan_catalog_sessions_documents WITH (NOLOCK)
	WHERE
		document_id = @document_id
		AND session_id = @session_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSessionDocuments]...';


GO
CREATE PROCEDURE dbo.vds_selSessionDocuments
	@session_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 1/15/2016
	Description: Returns all of the documents for a session
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		*
	FROM
		dbo.account_organization_user_profile_plan_catalog_sessions_documents WITH (NOLOCK)
	WHERE
		session_id = @session_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSessionNonEstimatedOption]...';


GO
CREATE PROCEDURE [dbo].[vds_selSessionNonEstimatedOption]
	@session_id UNIQUEIDENTIFIER,
	@row_id UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 11/6/2018
	Description: Returns a single, non-estimated option for a session.
*/
BEGIN
    SELECT
        cs.*,
		doc_count = (select count(*) from gpc_products_documents with (nolock) where gpc_id = try_convert(uniqueidentifier,cs.gpc) ),
		cs.modified_date AS last_modified_date,
		IIF(u.[user_id] IS NULL, cs.modifier, CONCAT(u.first_name, ' ', u.last_name)) AS last_modified_by
    FROM
        dbo.catalog_selections cs WITH (NOLOCK)
		LEFT JOIN dbo.VeoSolutionsSecurity_users u WITH (NOLOCK) ON u.email = cs.modifier
    WHERE
        session_id = @session_id
		AND row_id = @row_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSessionNonEstimatedOptionDesignerImage]...';


GO
CREATE PROCEDURE [dbo].[vds_selSessionNonEstimatedOptionDesignerImage]
	@session_id UNIQUEIDENTIFIER,
	@row_id UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 11/6/2018
	Description: Returns the designer image, for a non-estimated option,
		if it exists.
*/
BEGIN
	SELECT
		*
	FROM
		catalog_selections_designer_images
	WHERE
		session_id = @session_id
		AND row_id = @row_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSessionStructuralOptions]...';


GO
CREATE PROCEDURE [dbo].[vds_selSessionStructuralOptions]
    @session_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 9/25/2015
    Description: Returns all of the structural options for a session. Structural
        options are the builds available within the session for selection, broken
        out by application, product, area, and sub area.

    Modified By: Shelby Mansker
    Date: 9/28/2015
    Notes: Modified the query to use CROSS APPLY, rather than a CTE, to fetch the results. I'm also including
        a representative price level id with each structural option, which indicates the price level bom
        where the bill quantity is being pulled from. Also, if the session uses the new price level bom storage
        technique (catalog_selections_bom_details) then it will include the bill quantity from that price level's
        material field bom line. Otherwise, bill_qty will be null. For more information on CROSS APPLY see:
        http://sqlserverplanet.com/sql-2005/cross-apply-explained

    Modified By: Saul Sanchez
    Date: 9/28/2016
    Description: Removed references to bill_qty in the catalog_selections_bom_details (deprecated).

    vds_selSessionStructuralOptions '7c044e05-8d43-460e-848f-16fab66b84e6', '01234567-89AB-CDEF-0000-123456789ABC'
    vds_selSessionStructuralOptions '5ed27d32-771e-4e06-bc6a-3fa85c86124d', '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    SELECT
        a.name AS area, -- we must fetch the area and sub area names from the veo table, since we only store the ids in veosolutions.
        sa.name AS sub_area,
        csa.[application],
        csa.product,
        csa.build_id,
        csa.area AS build_description,  -- Currently, when a session is created the build description is stored in the area column
        csa.area_selected, -- indicates whether or not this structural option is available for selections to the homebuyer.
        pl.representative_price_level_id
    FROM
        catalog_selections_areas csa WITH (NOLOCK)
        JOIN Veo_areas a WITH (NOLOCK) ON a.area_id = csa.area_id
        JOIN Veo_sub_areas sa WITH (NOLOCK) ON sa.sub_area_id = csa.sub_area_id
        CROSS APPLY
        (
            SELECT TOP 1 -- only choose one of the valid price levels, as all price levels have the same bom structure
                cs.item_no AS representative_price_level_id
            FROM 
                catalog_selections cs WITH (NOLOCK) 
            WHERE 
                cs.session_id = csa.session_id 
                AND cs.build_id = csa.build_id
                AND cs.item_no <> '0' -- don't process custom price levels
        ) pl
    WHERE
        csa.session_id = @session_id
    ORDER BY
        area, sub_area, [application], product

END
GO
PRINT N'Creating Procedure [dbo].[vds_selSharedOrganizationsBetweenTwoUsers]...';


GO
CREATE PROCEDURE [dbo].[vds_selSharedOrganizationsBetweenTwoUsers]
    @account_id UNIQUEIDENTIFIER,
    @user1_id UNIQUEIDENTIFIER,
    @user2_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Create Date: 3/31/2015
    Description: Returns the organizations that two users, in the same account, share.

    Modified 4/3/2015: Added missing security token check. -Shelby

    Modified 9/21/2015: Only look at active account organization users. -Saul

    -- Tests --
    EXEC dbo.vds_selSharedOrganizationsBetweenTwoUsers
        @account_id = 'bab32b7e-3ada-497c-862e-e5083971cc59',
        @user1_id = 'b4544b42-8738-42ef-b873-022d7630ceaf',
        @user2_id = '6dacb436-5124-40e5-92e9-1b8633c8f995',
        @security_token = '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- find the intersection of user 1's organizations to user 2's organizations
    SELECT
        o.organization_id,
        o.name
    FROM
        dbo.VeoSolutionsSecurity_organizations o WITH (NOLOCK)
        JOIN dbo.VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK) ON ao.organization_id=o.organization_id
        JOIN dbo.VeoSolutionsSecurity_account_organization_users aou WITH (NOLOCK) ON aou.account_id = ao.account_id AND aou.organization_id = ao.organization_id
    WHERE
        o.active = 1
        AND ao.account_id = @account_id
        AND ao.active = 1
        AND aou.[user_id] = @user1_id
        AND aou.active = 1
    INTERSECT
    SELECT
        o.organization_id,
        o.name
    FROM
        dbo.VeoSolutionsSecurity_organizations o WITH (NOLOCK)
        JOIN dbo.VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK) ON ao.organization_id=o.organization_id
        JOIN dbo.VeoSolutionsSecurity_account_organization_users aou WITH (NOLOCK) ON aou.account_id = ao.account_id AND aou.organization_id = ao.organization_id
    WHERE
        o.active = 1
        AND ao.account_id = @account_id
        AND ao.active = 1
        AND aou.[user_id] = @user2_id
        AND aou.active = 1
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSpecAccentItems]...';


GO
CREATE procedure [dbo].[vds_selSpecAccentItems]
	@page_index int OUTPUT,
	@page_size int = 12,
	@session_id uniqueidentifier,
	@build_id bigint,
	@item_type varchar(20),
	@item_id varchar(50),
	@search_criteria varchar(100) = '',
	@selected_part_no varchar(81) = '',
	@builder_overrides_enabled bit = 0,
	@security_token uniqueidentifier
as

/*
	Procedure:		vds_selSpecAccentItems
	Author:			Richard Gladstone
	Date:			04/07/2015
	Purpose:		Specialized procedure for VEO Design Studio Selection Wizard FIELD Selection
	History:		8/18/2015 Added in spec_items groups joined to veo styles groups to bring
								in listello's which are not published. ADG

    Modified: Shelby Mansker
	Date: 1/5/2017
	Description: Replaced the use of stocking_codes.include_in_search with stocking_codes.homebuyer_selectable.

	Modified: Shelby Mansker
	Date: 8/29/2019
	Description: Fixed issues with joins, when removing colors due to spec_areas_items exclusions.

	Modified:		Roger Wang
	Date:			5/13/2021
	Description:	Replaced the use of stocking_codes.homebuyer_selectable with stocking_codes.designer_selectable.

	Modified:		Roger Wang
	Date:			9/27/2021
	Description:	Make accents pulled from spec_items respect effective_date.

	Modified:		Roger Wang
	Date:			8/9/2022
	Description:	Include area/sub area when fetching items from group detail.

	Modified:		Roger Wang
	Date:			7/11/2023
	Description:	Filter styles/colors based on plan item in spec_areas_items.

	Modified:		Reid Wilson
	Date:			9/19/2023
	Description:	Allow searching by and returning builder override part id and name.

	Modified:		Daniel Arwe
	Date: 			12/18/2023
	Description:	Added image_id column, using join on veo.colors_customer_overrides table, to support builder override part images.
*/

-- =====================
-- Authentication
-- =====================
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

-- =========================
-- Parameter Cleanup
-- =========================
if len(@selected_part_no) > 0
	set @search_criteria = ''

-- ============================
-- Variable Declaration
-- ============================
declare @item_class varchar(50) = 'field'
declare @spec_id int
declare @application_id varchar(10)
declare @product_id varchar(10)
declare @area_id varchar(50)
declare @sub_area_id varchar(50)
declare @location_id int
declare @effective_date datetime
declare @uom_id varchar(9)
declare @external_organization_id varchar(20)

select
	@application_id = application_id,
	@product_id = product_id,
	@area_id = area_id,
	@sub_area_id = sub_area_id,
	@location_id = location_id,
	@spec_id = vpm.spec_id,
	@external_organization_id = vsm.builder_id
from
	veo_plan_builds vpb with (nolock)
	left join veo_plan_mstr vpm with (nolock) on vpm.plan_id = vpb.plan_id
	left join veo_spec_mstr vsm with (nolock) on vsm.spec_id = vpm.spec_id
where
	vpb.build_id_num = @build_id


	print @spec_id
select
	@effective_date = effective_date,
	@uom_id = csad.bom_uom_id
from
	catalog_selections_areas csa with (nolock)
	left join catalog_selections_area_details csad with (nolock) on csad.session_id = csa.session_id and csad.[application] = csa.[application] and csad.product = csa.product and csad.area = csa.area and csad.sub_area = csa.sub_area
	left join catalog_selections cs with (nolock) on csa.session_id = cs.session_id and csa.selected_field_group = cs.row_id
	left join account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock) on aouppcs.session_id = cs.session_id
where
	csa.session_id = @session_id
	and csa.build_id = @build_id
	and csad.item_type = @item_type
	and csad.item_id = @item_id

declare @colors table
(
	product_id varchar(10),
	style_id varchar(50),
	color_id varchar(50),
	part_no varchar(100),
	name varchar(100),
	part_no_override varchar(100),
	part_name_official varchar(150),
	image_id int null
)

-- =========================================
-- spec_items --> groups -> styles -> colors
-- =========================================
insert into @colors
select distinct
	c.product_id,
	c.style_id,
	c.color_id,
	c.part_no,
	c.name,
	cco.customer_reference_no,
	case
		when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
			then (cco.color_private_label)
		else c.name
	end as part_name_official,
	cco.image_id
from
	veo_spec_items si with (nolock)
	left join veo_styles_groups sg with (nolock) on sg.group_id = si.item
	left join catalog_selections_group_detail sgd with (nolock) on session_id = @session_id and sgd.group_id = sg.group_id
	left join veo_styles s with (nolock) on s.product_id = sg.product_id and s.style_id = sgd.item
	left join veo_colors c with (nolock) on c.product_id = s.product_id and c.style_id = s.style_id
	left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
where
	spec_id = @spec_id
	and sgd.item_type = 'style'
	AND ISNULL(sgd.area_id, '') in ('', @area_id)
	AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
	and si.application_id = @application_id
	and si.product_id = @product_id
	and si.item_type = 'group'
	and s.class = @item_class

-- =========================================
-- spec_items --> groups -> colors
-- =========================================
MERGE @colors AS target
USING
(
	--insert into @colors
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_styles_groups sg with (nolock) on sg.group_id = si.item
		left join catalog_selections_group_detail sgd with (nolock) on session_id = @session_id and sgd.group_id = sg.group_id
		left join veo_colors c with (nolock) on c.part_no = sgd.item
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and sgd.item_type = 'color'
		AND ISNULL(sgd.area_id, '') in ('', @area_id)
		AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'group'
		and s.class = @item_class
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

-- =========================================
-- spec_items --> styles -> colors
-- =========================================
MERGE @colors AS target
USING
(
	--insert into @colors
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_colors c with (nolock) on c.product_id = si.product_id and c.style_id = si.item
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'style'
		and s.class = @item_class
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

-- =========================================
-- spec_items --> colors
-- =========================================
MERGE @colors AS target
USING
(
	--insert into @colors
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_colors c with (nolock) on c.part_no = si.item
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'color'
		and s.class = @item_class
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

--===================== 8/18/2015 Manual add in spec items that are not published====================================

-- =========================================
-- spec_items --> groups -> styles -> colors
-- =========================================

MERGE @colors AS target
USING
(
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_styles_groups sg with (nolock) on sg.group_id = si.item
		left join veo_styles_groups_detail sgd with (nolock) on customer_id = @external_organization_id and sgd.group_id = sg.group_id
		left join veo_styles s with (nolock) on s.product_id = sg.product_id and s.style_id = sgd.item
		left join veo_colors c with (nolock) on c.product_id = s.product_id and c.style_id = s.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and sgd.item_type = 'style'
		and sgd.area_id in ('', @area_id)
		and sgd.sub_area_id in ('', @sub_area_id)
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'group'
		and si.exclude_contract_publication = 1
		and s.class = @item_class
		and (sgd.end_date is null or sgd.end_date >= @effective_date)
) as source

ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

-- =========================================
-- spec_items --> groups -> colors
-- =========================================
MERGE @colors AS target
USING
(
	--insert into @colors
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_styles_groups sg with (nolock) on sg.group_id = si.item
		left join veo_styles_groups_detail sgd with (nolock) on customer_id = @external_organization_id and sgd.group_id = sg.group_id
		left join veo_colors c with (nolock) on c.part_no = sgd.item
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and sgd.item_type = 'color'
		and sgd.area_id in ('', @area_id)
		and sgd.sub_area_id in ('', @sub_area_id)
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'group'
		and si.exclude_contract_publication = 1
		and s.class = @item_class
		and (sgd.end_date is null or sgd.end_date >= @effective_date)
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

--====================== 8/18/2015 =====================================

-- =======================================================
-- remove parts explicitly excluded from spec area
-- =======================================================
IF @spec_id <> 0 AND EXISTS( SELECT TOP 1 line_no FROM veo_spec_areas_items WHERE spec_id = @spec_id)
BEGIN
	DELETE
		c
	FROM
		@colors c
		INNER JOIN dbo.vdsf_selSpecAreaExcludedParts(@session_id, @spec_id, @application_id, @product_id, @area_id, @sub_area_id, @location_id, @item_id) saep ON saep.part_no = c.part_no
END

-- =======================================================
-- remove not designer_selectable parts --> colors
-- =======================================================
delete
	c
from
	@colors c
	inner join veo_colors c1 with (nolock) on c1.part_no = c.part_no
	inner join veo_stocking_codes vsc with (nolock) on vsc.code = c1.stocking_code
where
	vsc.designer_selectable = 0

-- ===================
-- return paged values
-- ===================
declare @results table
(
	product_id varchar(10),
	style_id varchar(50),
	color_id varchar(50),
	part_no varchar(100),
	name varchar(100),
	part_no_override varchar(100),
	part_name_official varchar(150),
	image_id int null,
	bom_uom varchar(9),
	ivt_uom varchar(9),
	[row_number] int,
	[row_count] int
)

insert into @results
select distinct
	c.*,
	@uom_id as bom_uom,
	s.ivt_uom,
	ROW_NUMBER() over (order by part_name_official) as [row_number],
	COUNT(c.part_no) over() as row_count
from
	@colors c
	left join veo_colors c2 with (nolock) on c2.part_no = c.part_no
	left join veo_styles s with (nolock) on s.product_id = c2.product_id and s.style_id = c2.style_id
where
	c.part_no is not null
	and (
		@search_criteria = ''
		or c.name like '%' + @search_criteria + '%'
		or c.part_no like '%' + @search_criteria + '%'
		or (
			@builder_overrides_enabled = 1
			and (
				c.part_name_official like '%' + @search_criteria + '%'
				or c.part_no_override like '%' + @search_criteria + '%'
			)
		)
	)
order by
	part_name_official

-- if a particular part is requested, return the page with that part by calculating a new value for @page_index
if len(@selected_part_no) > 0
begin
	-- determine the row of the part no
	DECLARE @row_no INT = null
	SELECT @row_no = [row_number] FROM @results WHERE part_no = @selected_part_no

	IF @row_no IS NULL
		SELECT @page_index = 0
	else
		SELECT @page_index = ((@row_no -1) / @page_size)
end

DELETE FROM @results
WHERE [row_number] <= @page_index * @page_size
	OR [row_number] > (@page_index + 1) * @page_size

select
	r.*,
	case
		when (@builder_overrides_enabled = 1 AND r.image_id IS NOT NULL)
			then (NULL)
			else (c.image_data)
		end as image_data
from
	@results r
	left join veo_colors c with (nolock) on c.part_no = r.part_no
order by
	r.part_name_official
GO
PRINT N'Creating Procedure [dbo].[vds_selSpecCabinetHardwareItems]...';


GO
CREATE PROCEDURE [dbo].[vds_selSpecCabinetHardwareItems]
	@page_index int OUTPUT,
	@page_size int = 12,
	@session_id uniqueidentifier,
	@build_id bigint,
	@item_id varchar(50),
	@search_criteria varchar(100) = '',
	@selected_part_no varchar(81) = '',
	@builder_overrides_enabled BIT = 0,
	@security_token uniqueidentifier
AS
/*
	Author: Shelby Mansker
	Date: 1/26/2016
	Description: Returns a page worth of available cabinet hardware items for selection in the specified session and build.

    Modified: 02/12/2016 Always return the "No Hardware" part. Saul.

	Modified: Shelby Mansker
	Date: 1/5/2017
	Description: Replaced the use of stocking_codes.include_in_search with stocking_codes.homebuyer_selectable.

	Modified: Shelby Mansker
	Date: 8/29/2019
	Description: Fixed issues with joins, when removing colors due to spec_areas_items exclusions.

	Modified:		Roger Wang
	Date:			5/13/2021
	Description:	Replaced the use of stocking_codes.homebuyer_selectable with stocking_codes.designer_selectable.

	Modified:		Roger Wang
	Date:			8/9/2022
	Description:	Include area/sub area when fetching items from group detail.

	Modified:		Roger Wang
	Date:			7/11/2023
	Description:	Filter styles/colors based on plan item in spec_areas_items.

	Modified:		Reid Wilson
	Date:			9/14/2023
	Description:	Allow searching by and returning builder override part id and name.

	Modified:		Daniel Arwe
	Date: 			12/18/2023
	Description:	Added image_id column, using join on veo.colors_customer_overrides table, to support builder override part images.
*/
BEGIN
-- =====================
-- Authentication
-- =====================
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

-- ============================
-- Variable Declaration
-- ============================
declare @item_class varchar(50) = 'cabinet hardware'
declare @spec_id int
declare @application_id varchar(10)
declare @product_id varchar(10)
declare @area_id varchar(50)
declare @sub_area_id varchar(50)
declare @location_id int
declare @effective_date datetime
declare @external_organization_id varchar(20)

select
	@application_id = application_id,
	@product_id = product_id,
	@area_id = area_id,
	@sub_area_id = sub_area_id,
	@location_id = location_id,
	@spec_id = vpm.spec_id,
	@external_organization_id = builder_id
from
	veo_plan_builds vpb with (nolock)
	left join veo_plan_mstr vpm with (nolock) on vpm.plan_id = vpb.plan_id
	left join veo_spec_mstr vsm with (nolock) on vsm.spec_id = vpm.spec_id
where
	vpb.build_id_num = @build_id

select
	@effective_date = effective_date
from
	account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock)
where
	session_id = @session_id

declare @colors table
(
	product_id varchar(10),
	style_id varchar(50),
	color_id varchar(50),
	part_no varchar(100),
	name varchar(100),
	part_no_override varchar(100),
	part_name_official varchar(150),
	image_id int null
)

-- =========================================
-- Always include the "No Hardware" color.
-- =========================================
insert into @colors
select
    c.product_id,
    c.style_id,
    c.color_id,
    c.part_no,
    c.name,
	cco.customer_reference_no,
	case
		when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
			then (cco.color_private_label)
		else c.name
	end as part_name_official,
	cco.image_id
from
    veo_colors c with (nolock)
	left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
where
    c.part_no = 'YNHDW/NHDW'

-- =========================================
-- spec_items --> groups -> styles -> colors
-- =========================================
insert into @colors
select distinct
	c.product_id,
	c.style_id,
	c.color_id,
	c.part_no,
	c.name,
	cco.customer_reference_no,
	case
		when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
			then (cco.color_private_label)
		else c.name
	end as part_name_official,
	cco.image_id
from
	veo_spec_items si with (nolock)
	left join veo_styles_groups sg with (nolock) on sg.group_id = si.item
	left join catalog_selections_group_detail sgd with (nolock) on session_id = @session_id and sgd.group_id = sg.group_id
	left join veo_styles s with (nolock) on s.product_id = sg.product_id and s.style_id = sgd.item
	left join veo_colors c with (nolock) on c.product_id = s.product_id and c.style_id = s.style_id
	left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
where
	spec_id = @spec_id
	and sgd.item_type = 'style'
	AND ISNULL(sgd.area_id, '') in ('', @area_id)
	AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
	and si.application_id = @application_id
	and si.product_id = @product_id
	and si.item_type = 'group'
	and s.class = @item_class

-- =========================================
-- spec_items --> groups -> colors
-- =========================================
MERGE @colors AS target
USING
(
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_styles_groups sg with (nolock) on sg.group_id = si.item
		left join catalog_selections_group_detail sgd with (nolock) on session_id = @session_id and sgd.group_id = sg.group_id
		left join veo_colors c with (nolock) on c.part_no = sgd.item
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and sgd.item_type = 'color'
		AND ISNULL(sgd.area_id, '') in ('', @area_id)
		AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'group'
		and s.class = @item_class
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);


-- =========================================
-- spec_items --> styles -> colors
-- =========================================
MERGE @colors AS target
USING
(
	--insert into @colors
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_colors c with (nolock) on c.product_id = si.product_id and c.style_id = si.item
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'style'
		and s.class = @item_class
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

-- =========================================
-- spec_items --> colors
-- =========================================
MERGE @colors AS target
USING
(
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_colors c with (nolock) on c.part_no = si.item
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'color'
		and s.class = @item_class
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

-- =======================================================
-- remove parts explicitly excluded from spec area
-- =======================================================
IF @spec_id <> 0 AND EXISTS( SELECT TOP 1 line_no FROM veo_spec_areas_items WHERE spec_id = @spec_id)
BEGIN
	DELETE
		c
	FROM
		@colors c
		INNER JOIN dbo.vdsf_selSpecAreaExcludedParts(@session_id, @spec_id, @application_id, @product_id, @area_id, @sub_area_id, @location_id, @item_id) saep ON saep.part_no = c.part_no
END

-- =======================================================
-- remove not designer_selectable parts --> colors
-- =======================================================
delete
	c
from
	@colors c
	inner join veo_colors c1 with (nolock) on c1.part_no = c.part_no
	inner join veo_stocking_codes vsc with (nolock) on vsc.code = c1.stocking_code
where
	vsc.designer_selectable = 0

-- ===================
-- return paged values
-- ===================
declare @results table
(
	product_id varchar(10),
	style_id varchar(50),
	color_id varchar(50),
	part_no varchar(100),
	name varchar(100),
	part_no_override varchar(100),
	part_name_official VARCHAR(150),
	image_id int null,
	[row_number] int,
	[row_count] int
)

insert into @results
select distinct
	c.*,
	ROW_NUMBER() over (order by part_name_official) as [row_number],
	COUNT(part_no) over() as row_count
from
	@colors c
where
	c.part_no is not null
	and (
		@search_criteria = ''
		or c.name like '%' + @search_criteria + '%'
		or c.part_no like '%' + @search_criteria + '%'
		or (
			@builder_overrides_enabled = 1
			and (
				c.part_name_official like '%' + @search_criteria + '%'
				or c.part_no_override like '%' + @search_criteria + '%'
			)
		)
	)
order by
	part_name_official

-- if a particular part is requested, return the page with that part by calculating a new value for @page_index
if len(@selected_part_no) > 0
begin
	-- determine the row of the part no
	DECLARE @row_no INT = null
	SELECT @row_no = [row_number] FROM @results WHERE part_no = @selected_part_no

	IF @row_no IS NULL
		SELECT @page_index = 0
	else
		SELECT @page_index = ((@row_no -1) / @page_size)
end

DELETE FROM @results
WHERE [row_number] <= @page_index * @page_size
	OR [row_number] > (@page_index + 1) * @page_size

select
	r.*,
	case
	when (@builder_overrides_enabled = 1 AND r.image_id IS NOT NULL)
		then (NULL)
		else (c.image_data)
	end as image_data
from
	@results r
	left join veo_colors c with (nolock) on c.part_no = r.part_no
order by
	r.part_name_official
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSpecEdgeItems]...';


GO
CREATE procedure [dbo].[vds_selSpecEdgeItems]
	@page_index int OUTPUT,
	@page_size int = 12,
	@session_id uniqueidentifier,
	@build_id bigint,
	@search_criteria varchar(100) = '',
	@selected_labor_code varchar(50) = '',
	@security_token uniqueidentifier
as

/*
	Procedure:		vds_selSpecEdgeItems
	Author:			Richard Gladstone
	Date:			04/08/2015
	Purpose:		Specialized procedure for VEO Design Studio Selection Wizard FIELD Selection

	Modified:       Shelby Mansker
	Date:           5/19/2015
	Description:    Added distinct keyword to prices_global_labor results, in order to remove duplicate records.

	Modified:       Roger Wang
	Date:           5/5/2021
	Description:    Per Jim, only labor codes that are specified in spec items should be returned, not because of the fact that they are priced out.
					Also if an edge labor code does not have material assigned then it is available for all countertops.

	Usages:			vds_selSpecEdgeItems 0, 3, 'b7e5087f-6844-4d2c-9581-47f4eaade95a',11874904,'','','01234567-89AB-CDEF-0000-123456789ABC'
					vds_selSpecEdgeItems 0, 3, 'b7e5087f-6844-4d2c-9581-47f4eaade95a',11874904,'','','01234567-89AB-CDEF-0000-123456789ABC'
					vds_selSpecEdgeItems 0, 3, 'b7e5087f-6844-4d2c-9581-47f4eaade95a',11874904,'','','01234567-89AB-CDEF-0000-123456789ABC'
					vds_selSpecEdgeItems 1, 3, 'b7e5087f-6844-4d2c-9581-47f4eaade95a',11874904,'','E114TP','01234567-89AB-CDEF-0000-123456789ABC'
	
					select * from catalog_selections_areas where session_id = 'C5EFB49D-826E-4631-9056-109CC3AA5DA4'
					select * from catalog_selections_area_details where real_item_id like 'O%'-- session_id = 'cb9df5ee-8cab-4a94-9f1d-e8988159dd72'
*/

-- =====================
-- Authentication
-- =====================
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

-- =========================
-- Parameter Cleanup
-- =========================
if len(@selected_labor_code) > 0
	set @search_criteria = ''

-- ============================
-- Variable Declaration
-- ============================
declare @application_id varchar(10) = '2'
declare @product_id varchar(10) = 'O'
declare @item_type varchar(10) = 'labor'
declare @item_class varchar(50) = 'edge'
declare @cust_id varchar(15)
declare @region_id varchar(10)
declare @spec_id int
declare @plan_id int
declare @area_id varchar(50)
declare @sub_area_id varchar(50)
declare @location_id int
declare @material varchar(50)
declare @effective_date datetime
declare	@field_part_no varchar(81)

declare @edges table
(
	product_id varchar(10),
	code varchar(50),
	name varchar(100)
)

-- =============================
-- variable population
-- =============================

select
	@area_id = vpb.area_id,
	@sub_area_id = vpb.sub_area_id,
	@location_id = vpb.location_id,
	@spec_id = vpm.spec_id,
	@cust_id = vsm.builder_id,
	@region_id = vc.region_id,
	@plan_id = vpm.plan_id
from
	veo_plan_builds vpb with (nolock)
	left join veo_plan_mstr vpm with (nolock) on vpm.plan_id = vpb.plan_id
	left join veo_spec_mstr vsm with (nolock) on vsm.spec_id = vpm.spec_id
	left join veo_customers vc with (nolock) on vc.custnmbr = vsm.builder_id
where
	vpb.build_id_num = @build_id

select
	@effective_date = effective_date
from
	catalog_selections_areas csa with (nolock)
	left join catalog_selections cs with (nolock) on csa.session_id = cs.session_id and csa.selected_field_group = cs.row_id
	left join account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock) on aouppcs.session_id = cs.session_id
where
	csa.session_id = @session_id
	and csa.build_id = @build_id

select
	@field_part_no = real_item_id
from
	catalog_selections_areas csa with (nolock)
	left join catalog_selections_area_details csad with (nolock) on
		csad.session_id = csa.session_id
		and csad.application = csa.[application]
		and csad.product = csa.product
		and csad.area = csa.area
		and csad.sub_area = csa.sub_area
where
	csa.session_id = @session_id
	and csa.build_id = @build_id
	and csad.item_type = 'material'
	and csad.item_id = 'field'

select
	@material = material
from
	Veo_colors c with (nolock)
	left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
where
	c.part_no = @field_part_no

-- ==============================
-- record selection
-- ==============================
insert into @edges (product_id, code, name)
select
	si.product_id, lc.code, lc.[description]
from
	veo_spec_items si with (nolock)
	left join veo_labor_codes lc with (nolock) on lc.code = si.item
where
	si.spec_id = @spec_id
	and si.item_type = 'labor'
	and si.application_id = @application_id
	and si.product_id = @product_id
	and lc.material in ('', @material)
	and lc.class = @item_class
	and lc.active = 1

-- =============================
-- return paged values
-- =============================
-- if a particular part is requested, return the page with that part by calculating a new value for @PAGE_INDEX
if len(@selected_labor_code) > 0
begin

	declare @edges_page table
	(
		row_no bigint,
		product_id varchar(10),
		code varchar(50),
		name varchar(100)
	)
	insert into @edges_page
	select distinct
		ROW_NUMBER() OVER (ORDER BY name, code), *
	from
		@edges
	where
		(@search_criteria = '' or name like '%' + @search_criteria + '%' or code like '%' + @search_criteria + '%')
	
	-- determine the row of the part no
	DECLARE @row_no INT = null
	SELECT @row_no = row_no FROM @edges_page WHERE code = @selected_labor_code

	IF @row_no IS NULL
		SELECT @page_index = 0
	else
		SELECT @page_index = ((@row_no -1) / @page_size)

END

declare @results table
(
	product_id varchar(10),
	code varchar(50),
	name varchar(100),
	[row_number] int,
	[row_count] int
)
insert into @results
select
	* , row_number() over (order by name), count(code) over() as row_count
from
	@edges
where
	(@search_criteria = '' or name like '%' + @search_criteria + '%' or code like '%' + @search_criteria + '%')
order by
	name
OFFSET @page_index * @page_size ROWS
FETCH NEXT @page_size ROWS ONLY

select
	r.*, c.image_data
from
	@results r
	left join veo_labor_codes c with (nolock) on c.code = r.code
order by
	r.name
GO
PRINT N'Creating Procedure [dbo].[vds_selSpecFieldItems]...';


GO
CREATE procedure [dbo].[vds_selSpecFieldItems]
	@page_index int OUTPUT,
	@page_size int = 12,
	@session_id uniqueidentifier,
	@build_id bigint,
	@search_criteria varchar(100) = '',
	@selected_part_no varchar(81) = '',
	@security_token uniqueidentifier,
	@price_level_id VARCHAR(100) = NULL,
	@include_image_data BIT = 1,
	@builder_overrides_enabled BIT = 0,
	@debug bit = 0
as

/*
	Procedure:		vds_selSpecFieldItems
	Author:			Richard Gladstone
	Date:			04/07/2015
	Purpose:		Specialized procedure for VEO Design Studio Selection Wizard FIELD Selection

	Modified: Shelby Mansker
	Date: 1/5/2017
	Description: Replaced the use of stocking_codes.include_in_search with stocking_codes.homebuyer_selectable.

	Modified: Shelby Mansker
	Date: 1/29/2018
	Description: The price level id can now be optionally passed in. If it is, then the results will be based off of that price level.
			     If it isn't passed in, then the results will be based off of the currently selected price level for the passed in build.
				 Also added flag for not returning image data.

	Modified: Robert Hobbs
	Date: 6/6/2018
	Description:Changed the join on veo plan builds

	Modified: Shelby Mansker
	Date: 8/29/2019
	Description: Fixed a bug where colors were being removed when any group was excluded from the area/sub_area for this build, in spec_area_items.

	Modified:		Roger Wang
	Date:			5/13/2021
	Description:	Replaced the use of stocking_codes.homebuyer_selectable with stocking_codes.designer_selectable.

	Modified:		Roger Wang
	Date:			8/9/2022
	Description:	Include area/sub area when fetching items from group detail.

	Modified:		Roger Wang
	Date:			7/11/2023
	Description:	Filter styles/colors based on plan item in spec_areas_items.

	Modified:		Reid Wilson
	Date:			9/15/2023
	Description:	Allow searching by and returning builder override part id and name.

	Modified:		Daniel Arwe
	Date: 			12/18/2023
	Description:	Added image_id column, using join on veo.colors_customer_overrides table, to support builder override part images.
*/

-- =====================
-- Authentication
-- =====================
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

-- =========================
-- Parameter Cleanup
-- =========================
if len(@selected_part_no) > 0
	set @search_criteria = ''

-- ============================
-- Variable Declaration
-- ============================
-- declare @debug bit = 1
declare @item_class varchar(50) = 'field'
declare @spec_id int
declare @application_id varchar(10)
declare @product_id varchar(10)
declare @area_id varchar(50)
declare @sub_area_id varchar(50)
declare @location_id int
declare @item_type varchar(50)
declare @item_no varchar(81)
declare @external_organization_id varchar(20)

select
	@application_id = application_id,
	@product_id = product_id,
	@area_id = area_id,
	@sub_area_id = sub_area_id,
	@location_id = location_id,
	@spec_id = vpm.spec_id,
	@external_organization_id = builder_id
from
	veo_plan_builds vpb with (nolock)
	left join veo_plan_mstr vpm with (nolock) on vpm.plan_id = vpb.plan_id
	left join veo_spec_mstr vsm with (nolock) on vsm.spec_id = vpm.spec_id
where
	vpb.build_id_num = @build_id

-- =========================================
-- Fetch the price level information
-- =========================================
IF (@price_level_id IS NULL)
BEGIN
	SELECT
		@item_type = item_type,
		@item_no = item_no
	FROM
		catalog_selections_areas csa WITH (NOLOCK)
		LEFT JOIN catalog_selections cs WITH (NOLOCK) ON csa.session_id = cs.session_id AND csa.selected_field_group = cs.row_id
	WHERE
		csa.session_id = @session_id
		AND csa.build_id = @build_id
END
ELSE
BEGIN
	SELECT
		@item_type = item_type,
		@item_no = item_no
	FROM
		catalog_selections WITH (NOLOCK)
	WHERE
		session_id = @session_id
		AND build_id = @build_id
		AND item_no = @price_level_id
END

if @item_type is null
begin
	raiserror('No price level has been selected.',16,1)
	return
end

--print @session_id
--print @build_id

if @debug = 1 select 'item_no,spec' as selection,@item_no as item,@spec_id as spec
if @debug = 1
	select * from catalog_selections_group_detail sgd with (nolock) left join veo_colors c with (nolock) on c.part_no = sgd.item where session_id = @session_id and group_id = @item_no

declare @colors table
(
	product_id varchar(10),
	style_id varchar(50),
	color_id varchar(50),
	part_no varchar(100),
	name varchar(100),
	part_no_override varchar(100),
	part_name_official varchar(150),
	image_id int null
)

-- =========================================
-- spec_items --> groups -> styles -> colors
-- =========================================
if @item_type = 'group'
	insert into @colors
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_styles_groups sg with (nolock) on sg.group_id = si.item
		left join catalog_selections_group_detail sgd with (nolock) on sgd.session_id = @session_id and sgd.group_id = sg.group_id
		left join veo_styles s with (nolock) on s.product_id = sg.product_id and s.style_id = sgd.item
		left join veo_colors c with (nolock) on c.product_id = s.product_id and c.style_id = s.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and sgd.item_type = 'style'
		AND ISNULL(sgd.area_id, '') in ('', @area_id)
		AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'group'
		and s.class = @item_class
		and si.item = @item_no

if @debug = 1 select 'group->styles->colors' as selection,* from @colors c left join veo_colors c2 with (nolock) on c2.part_no = c.part_no

-- =========================================
-- spec_items --> groups -> colors
-- =========================================
if @item_type = 'group'
	MERGE @colors AS target
	USING
	(
		--insert into @colors
		select distinct
			c.product_id,
			c.style_id,
			c.color_id,
			c.part_no,
			c.name,
			cco.customer_reference_no,
			case
				when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
					then (cco.color_private_label)
				else c.name
			end as part_name_official,
			cco.image_id
		from
			veo_spec_items si with (nolock)
			left join veo_styles_groups sg with (nolock) on sg.group_id = si.item
			left join catalog_selections_group_detail sgd with (nolock) on session_id = @session_id and sgd.group_id = sg.group_id
			left join veo_colors c with (nolock) on c.part_no = sgd.item
			left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
			left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
		where
			spec_id = @spec_id
			and sgd.item_type = 'color'
			AND ISNULL(sgd.area_id, '') in ('', @area_id)
			AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
			and si.application_id = @application_id
			and si.product_id = @product_id
			and si.item_type = 'group'
			and s.class = @item_class
			and si.item = @item_no
	) as source
	ON target.part_no = source.part_no
	WHEN NOT MATCHED THEN
		INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

if @debug = 1 select 'group->colors' as selection,* from @colors

-- =========================================
-- spec_items --> styles -> colors
-- =========================================
if @item_type = 'style'
	MERGE @colors AS target
	USING
	(
		--insert into @colors
		select distinct
			c.product_id,
			c.style_id,
			c.color_id,
			c.part_no,
			c.name,
			cco.customer_reference_no,
			case
				when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
					then (cco.color_private_label)
				else c.name
			end as part_name_official,
			cco.image_id
		from
			veo_spec_items si with (nolock)
			left join veo_colors c with (nolock) on c.product_id = si.product_id and c.style_id = si.item
			left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
			left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
		where
			spec_id = @spec_id
			and si.application_id = @application_id
			and si.product_id = @product_id
			and si.item_type = 'style'
			and s.class = @item_class
			and si.item = @item_no
	) as source
	ON target.part_no = source.part_no
	WHEN NOT MATCHED THEN
		INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

if @debug = 1 select 'group->colors' as selection,* from @colors

-- =========================================
-- spec_items --> colors
-- =========================================
if @item_type = 'color'
	MERGE @colors AS target
	USING
	(
		select distinct
			c.product_id,
			c.style_id,
			c.color_id,
			c.part_no,
			c.name,
			cco.customer_reference_no,
			case
				when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
					then (cco.color_private_label)
				else c.name
			end as part_name_official,
			cco.image_id
		from
			veo_spec_items si with (nolock)
			left join veo_colors c with (nolock) on c.part_no = si.item
			left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
			left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
		where
			spec_id = @spec_id
			and si.application_id = @application_id
			and si.product_id = @product_id
			and si.item_type = 'color'
			and s.class = @item_class
			and si.item = @item_no
	) as source
	ON target.part_no = source.part_no
	WHEN NOT MATCHED THEN
		INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

if @debug = 1 select 'spec_areas_items->all' as selection,* from veo_spec_areas_items where spec_id = 3520

-- =======================================================
-- remove parts explicitly excluded from spec area
-- =======================================================
DELETE
	c
FROM
	@colors c
	INNER JOIN dbo.vdsf_selSpecAreaExcludedParts(@session_id, @spec_id, @application_id, @product_id, @area_id, @sub_area_id, @location_id, 'field') saep ON saep.part_no = c.part_no

-- =======================================================
-- remove not designer_selectable parts --> colors
-- =======================================================
delete
	c
from
	@colors c
	inner join veo_colors c1 with (nolock) on c1.part_no = c.part_no
	inner join veo_stocking_codes vsc with (nolock) on vsc.code = c1.stocking_code
where
	vsc.designer_selectable = 0

if @debug = 1 select 'spec_areas_items->colors' as selection,* from @colors

-- ===================
-- return paged values
-- ===================
declare @results table
(
	product_id varchar(10),
	style_id varchar(50),
	color_id varchar(50),
	part_no varchar(100),
	name varchar(100),
	part_no_override varchar(100),
	part_name_official VARCHAR(150),
	image_id int null,
	[row_number] int,
	[row_count] int
)

insert into @results
select distinct
	c.*,
	ROW_NUMBER() over (order by part_name_official) as [row_number],
	COUNT(part_no) over() as row_count
from
	@colors c
where
	c.part_no is not null
	and (
		@search_criteria = ''
		or c.name like '%' + @search_criteria + '%'
		or c.part_no like '%' + @search_criteria + '%'
		or (
			@builder_overrides_enabled = 1
			and (
				c.part_name_official like '%' + @search_criteria + '%'
				or c.part_no_override like '%' + @search_criteria + '%'
			)
		)
	)
order by
	part_name_official

-- if a particular part is requested, return the page with that part by calculating a new value for @page_index
if len(@selected_part_no) > 0
begin
	-- determine the row of the part no
	DECLARE @row_no INT = null
	SELECT @row_no = [row_number] FROM @results WHERE part_no = @selected_part_no

	IF @row_no IS NULL
		SELECT @page_index = 0
	else
		SELECT @page_index = ((@row_no -1) / @page_size)
end

DELETE FROM @results
WHERE [row_number] <= @page_index * @page_size
	OR [row_number] > (@page_index + 1) * @page_size

if @debug = 1 select 'paging & stocking code filter' as selection,* from @results

-- ============================================================================
-- Check include_image_data flag to see if images should be returned with data.
-- ============================================================================
IF (@include_image_data = 1)
BEGIN
	SELECT
		r.*,
	case
	when (@builder_overrides_enabled = 1 AND r.image_id IS NOT NULL)
		then (NULL)
		else (c.image_data)
	end as image_data
from
	@results r
	left join veo_colors c with (nolock) on c.part_no = r.part_no
ORDER BY
	r.part_name_official
END
ELSE
BEGIN
	SELECT
		*
	FROM
		@results
	ORDER BY
		part_name_official
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSpecGroutItems]...';


GO
CREATE procedure [dbo].[vds_selSpecGroutItems]
	@page_index int OUTPUT,
	@page_size int = 12,
	@session_id uniqueidentifier,
	@build_id bigint,
	@search_criteria varchar(100) = '',
	@selected_part_no varchar(81) = '',
	@builder_overrides_enabled BIT = 0,
	@security_token uniqueidentifier
as

/*
	Procedure:		vds_selSpecGroutItems
	Author:			Richard Gladstone
	Date:			04/07/2015
	Purpose:		Specialized procedure for VEO Design Studio Selection Wizard FIELD Selection

	Modified: Shelby Mansker
	Date: 1/5/2017
	Description: Replaced the use of stocking_codes.include_in_search with stocking_codes.homebuyer_selectable.

	Modified: Shelby Mansker
	Date: 8/29/2019
	Description: Fixed issues with joins, when removing colors due to spec_areas_items exclusions.

	Modified:		Roger Wang
	Date:			5/13/2021
	Description:	Replaced the use of stocking_codes.homebuyer_selectable with stocking_codes.designer_selectable.

	Modified:		Roger Wang
	Date:			8/9/2022
	Description:	Include area/sub area when fetching items from group detail.

	Modified:		Reid Wilson
	Date:			9/19/2023
	Description:	Allow searching by and returning builder override part id and name.

	Modified:		Daniel Arwe
	Date: 			12/18/2023
	Description:	Added image_id column, using join on veo.colors_customer_overrides table, to support builder override part images.
*/

-- =====================
-- Authentication
-- =====================
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

-- =========================
-- Parameter Cleanup
-- =========================
if len(@selected_part_no) > 0
	set @search_criteria = ''

-- ============================
-- Variable Declaration
-- ============================
-- declare @application_id varchar(10) = '2'
declare @product_id varchar(10) = 'T'
declare @item_class varchar(50) = 'grout'
declare @spec_id int
declare @application_id varchar(10)
declare @area_id varchar(50)
declare @sub_area_id varchar(50)
declare @location_id int
declare @effective_date datetime
declare @external_organization_id varchar(20)

select
	@application_id = application_id,
	@area_id = area_id,
	@sub_area_id = sub_area_id,
	@location_id = location_id,
	@spec_id = vpm.spec_id,
	@external_organization_id = builder_id
from
	veo_plan_builds vpb with (nolock)
	left join veo_plan_mstr vpm with (nolock) on vpm.plan_id = vpb.plan_id
	left join veo_spec_mstr vsm with (nolock) on vsm.spec_id = vpm.spec_id
where
	vpb.build_id_num = @build_id

select
	@effective_date = effective_date
from
	catalog_selections_areas csa with (nolock)
	left join catalog_selections cs with (nolock) on csa.session_id = cs.session_id and csa.selected_field_group = cs.row_id
	left join account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock) on aouppcs.session_id = cs.session_id
where
	csa.session_id = @session_id
	and csa.build_id = @build_id

declare @colors table
(
	product_id varchar(10),
	style_id varchar(50),
	color_id varchar(50),
	part_no varchar(100),
	name varchar(100),
	part_no_override varchar(100),
	part_name_official varchar(150),
	image_id int null
)

-- =========================================
-- spec_items --> groups -> styles -> colors
-- =========================================
insert into @colors
select distinct
	c.product_id,
	c.style_id,
	c.color_id,
	c.part_no,
	c.name,
	cco.customer_reference_no,
	case
		when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
			then (cco.color_private_label)
		else c.name
	end as part_name_official,
	cco.image_id
from
	veo_spec_items si with (nolock)
	left join veo_styles_groups sg with (nolock) on sg.group_id = si.item
	left join catalog_selections_group_detail sgd with (nolock) on session_id = @session_id and sgd.group_id = sg.group_id
	left join veo_styles s with (nolock) on s.product_id = sg.product_id and s.style_id = sgd.item
	left join veo_colors c with (nolock) on c.product_id = s.product_id and c.style_id = s.style_id
	left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
where
	spec_id = @spec_id
	and sgd.item_type = 'style'
	AND ISNULL(sgd.area_id, '') in ('', @area_id)
	AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
	and si.application_id = @application_id
	and si.product_id = @product_id
	and si.item_type = 'group'
	and s.class = @item_class

-- =========================================
-- spec_items --> groups -> colors
-- =========================================
MERGE @colors AS target
USING
(
	--insert into @colors
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_styles_groups sg with (nolock) on sg.group_id = si.item
		left join catalog_selections_group_detail sgd with (nolock) on session_id = @session_id and sgd.group_id = sg.group_id
		left join veo_colors c with (nolock) on c.part_no = sgd.item
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and sgd.item_type = 'color'
		AND ISNULL(sgd.area_id, '') in ('', @area_id)
		AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'group'
		and s.class = @item_class
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

-- =========================================
-- spec_items --> styles -> colors
-- =========================================
MERGE @colors AS target
USING
(
	--insert into @colors
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_styles s with (nolock) on s.product_id = si.product_id and s.style_id = si.item
		left join veo_colors c with (nolock) on c.product_id = s.product_id and c.style_id = s.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'style'
		and s.class = @item_class
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

-- =========================================
-- spec_items --> colors
-- =========================================
MERGE @colors AS target
USING
(
	--insert into @colors
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_colors c with (nolock) on c.part_no = si.item
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'color'
		and s.class = @item_class
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

-- =======================================================
-- remove spec_area_items --> group --> styles --> colors
-- =======================================================
delete
	@colors
from
	veo_spec_areas_items sai with (nolock)
	join veo_styles_groups sg with (nolock) on sg.application_id = sai.application_id and sg.product_id = sai.product_id and sg.group_id = sai.item
	join catalog_selections_group_detail sgd with (nolock) on session_id = @session_id and sgd.group_id = sg.group_id
	join @colors c on c.product_id = sg.product_id and c.style_id = sgd.item
where
	spec_id = @spec_id
	and sgd.item_type = 'style'
	and sai.application_id = @application_id
	and sai.product_id = @product_id
	and sai.area_id = @area_id
	and sai.sub_area_id = @sub_area_id
	and (sai.location_id = @location_id or sai.location_id = 0)
	and sai.item_type = 'group'
	and sai.excluded = 1

-- =======================================================
-- remove spec_area_items --> group --> colors
-- =======================================================
delete
	@colors
from
	veo_spec_areas_items sai with (nolock)
	join veo_styles_groups sg with (nolock) on sg.application_id = sai.application_id and sg.product_id = sai.product_id and sg.group_id = sai.item
	join catalog_selections_group_detail sgd with (nolock) on session_id = @session_id and sgd.group_id = sg.group_id
	join @colors c on c.part_no = sgd.item
where
	spec_id = @spec_id
	and sgd.item_type = 'color'
	and sai.application_id = @application_id
	and sai.product_id = @product_id
	and sai.area_id = @area_id
	and sai.sub_area_id = @sub_area_id
	and (sai.location_id = @location_id or sai.location_id = 0)
	and sai.item_type = 'group'
	and sai.excluded = 1

-- =======================================================
-- remove spec_area_items --> styles --> colors
-- =======================================================
delete
	@colors
from
	veo_spec_areas_items sai with (nolock)
	join veo_styles s with (nolock) on s.product_id = sai.product_id and s.style_id = sai.item
	join @colors c on c.product_id = s.product_id and c.style_id = s.style_id
where
	sai.spec_id = @spec_id
	and	sai.application_id = @application_id
	and sai.area_id = @area_id
	and sai.sub_area_id = @sub_area_id
	and (sai.location_id = @location_id or sai.location_id = 0)
	and sai.item_type = 'style'
	and sai.excluded = 1

-- =======================================================
-- remove spec_area_items --> colors
-- =======================================================
delete
	@colors
from
	veo_spec_areas_items sai with (nolock)
	join @colors c on c.part_no = sai.item
where
	sai.spec_id = @spec_id
	and	sai.application_id = @application_id
	and sai.area_id = @area_id
	and sai.sub_area_id = @sub_area_id
	and (sai.location_id = @location_id or sai.location_id = 0)
	and sai.item_type = 'color'
	and sai.excluded = 1

-- =======================================================
-- remove not designer_selectable parts --> colors
-- =======================================================
delete
	c
from
	@colors c
	inner join veo_colors c1 with (nolock) on c1.part_no = c.part_no
	inner join veo_stocking_codes vsc with (nolock) on vsc.code = c1.stocking_code
where
	vsc.designer_selectable = 0

-- ====================================
-- return paged values
-- ====================================
declare @results table
(
	product_id varchar(10),
	style_id varchar(50),
	color_id varchar(50),
	part_no varchar(100),
	name varchar(100),
	part_no_override varchar(100),
	part_name_official VARCHAR(150),
	image_id int null,
	[row_number] int,
	[row_count] int
)

insert into @results
select distinct
	c.*,
	ROW_NUMBER() over (order by part_name_official) as [row_number],
	COUNT(part_no) over() as row_count
from
	@colors c
where
	c.part_no is not null
	and (
		@search_criteria = ''
		or c.name like '%' + @search_criteria + '%'
		or c.part_no like '%' + @search_criteria + '%'
		or (
			@builder_overrides_enabled = 1
			and (
				c.part_name_official like '%' + @search_criteria + '%'
				or c.part_no_override like '%' + @search_criteria + '%'
			)
		)
	)
order by
	part_name_official

-- if a particular part is requested, return the page with that part by calculating a new value for @page_index
if len(@selected_part_no) > 0
begin
	-- determine the row of the part no
	DECLARE @row_no INT = null
	SELECT @row_no = [row_number] FROM @results WHERE part_no = @selected_part_no

	IF @row_no IS NULL
		SELECT @page_index = 0
	else
		SELECT @page_index = ((@row_no -1) / @page_size)
end

DELETE FROM @results
WHERE [row_number] <= @page_index * @page_size
	OR [row_number] > (@page_index + 1) * @page_size

select
	r.*,
	case
	when (@builder_overrides_enabled = 1 AND r.image_id IS NOT NULL)
		then (NULL)
		else (c.image_data)
	end as image_data
from
	@results r
	left join veo_colors c with (nolock) on c.part_no = r.part_no
order by
	r.part_name_official
GO
PRINT N'Creating Procedure [dbo].[vds_selSpecItemExcludedOnSessionBuild]...';


GO
CREATE PROCEDURE [dbo].[vds_selSpecItemExcludedOnSessionBuild]
    @session_id UNIQUEIDENTIFIER,
    @build_id INT,
    @real_item_id VARCHAR(31),
    @security_token UNIQUEIDENTIFIER
AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    DECLARE @result BIT

    SET @result = dbo.vdsf_isSpecItemExcludedOnSessionBuild(@session_id, @build_id, @real_item_id, '', '', '', '')

    RETURN @result

END
GO
PRINT N'Creating Procedure [dbo].[vds_selSpecItems]...';


GO
CREATE procedure [dbo].[vds_selSpecItems]
	@page_index int OUTPUT,
	@page_size int = 12,
	@session_id uniqueidentifier,
	@build_id bigint,
	@item_class VARCHAR(50),
	@item_id VARCHAR(50),
	@search_criteria varchar(100) = '',
	@selected_part_no varchar(81) = '',
	@builder_overrides_enabled bit = 0,
	@security_token uniqueidentifier
as

/*
	Author: Shelby Mansker
	Date: 3/1/2017
	Description: This is a copy of Richard's original vds_selSpecUnderlaymentItems stored procedure, with the exception that it has been made
		generic by allowing the item_class to be passed into it.

	Modified: Shelby Mansker
	Date: 1/5/2017
	Description: Replaced the use of stocking_codes.include_in_search with stocking_codes.homebuyer_selectable.

	Modified: Shelby Mansker
	Date: 8/29/2019
	Description: Fixed issues with joins, when removing colors due to spec_areas_items exclusions.

	Modified:		Roger Wang
	Date:			5/13/2021
	Description:	Replaced the use of stocking_codes.homebuyer_selectable with stocking_codes.designer_selectable.

	Modified:		Roger Wang
	Date:			8/9/2022
	Description:	Include area/sub area when fetching items from group detail.

	Modified:		Roger Wang
	Date:			7/11/2023
	Description:	Filter styles/colors based on plan item in spec_areas_items.

	Modified:		Reid Wilson
	Date:			9/20/2023
	Description:	Allow searching by and returning builder override part id and name.

	Modified:		Daniel Arwe
	Date: 			12/18/2023
	Description:	Added image_id column, using join on veo.colors_customer_overrides table, to support builder override part images.
*/

-- =====================
-- Authentication
-- =====================
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

-- =========================
-- Parameter Cleanup
-- =========================
if len(@selected_part_no) > 0
	set @search_criteria = ''

-- ============================
-- Variable Declaration
-- ============================
declare @spec_id int
declare @application_id varchar(10)
declare @product_id varchar(10)
declare @area_id varchar(50)
declare @sub_area_id varchar(50)
declare @location_id int
declare @effective_date datetime
declare @external_organization_id varchar(20)

select
	@application_id = application_id,
	@product_id = product_id,
	@area_id = area_id,
	@sub_area_id = sub_area_id,
	@location_id = location_id,
	@spec_id = vpm.spec_id,
	@external_organization_id = builder_id
from
	veo_plan_builds vpb with (nolock)
	left join veo_plan_mstr vpm with (nolock) on vpm.plan_id = vpb.plan_id
	left join veo_spec_mstr vsm with (nolock) on vsm.spec_id = vpm.spec_id
where
	vpb.build_id_num = @build_id

select
	@effective_date = effective_date
from
	catalog_selections_areas csa with (nolock)
	left join catalog_selections cs with (nolock) on csa.session_id = cs.session_id and csa.selected_field_group = cs.row_id
	left join account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock) on aouppcs.session_id = cs.session_id
where
	csa.session_id = @session_id
	and csa.build_id = @build_id

declare @colors table
(
	product_id varchar(10),
	style_id varchar(50),
	color_id varchar(50),
	part_no varchar(100),
	name varchar(100),
	part_no_override varchar(100),
	part_name_official varchar(150),
	image_id int null
)

-- =========================================
-- spec_items --> groups -> styles -> colors
-- =========================================
insert into @colors
select distinct
	c.product_id,
	c.style_id,
	c.color_id,
	c.part_no,
	c.name,
	cco.customer_reference_no,
	case
		when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
			then (cco.color_private_label)
		else c.name
	end as part_name_official,
	cco.image_id
from
	veo_spec_items si with (nolock)
	left join veo_styles_groups sg with (nolock) on sg.group_id = si.item
	left join catalog_selections_group_detail sgd with (nolock) on session_id = @session_id and sgd.group_id = sg.group_id
	left join veo_styles s with (nolock) on s.product_id = sg.product_id and s.style_id = sgd.item
	left join veo_colors c with (nolock) on c.product_id = s.product_id and c.style_id = s.style_id
	left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
where
	spec_id = @spec_id
	and sgd.item_type = 'style'
	AND ISNULL(sgd.area_id, '') in ('', @area_id)
	AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
	and si.application_id = @application_id
	and si.product_id = @product_id
	and si.item_type = 'group'
	and s.class = @item_class

-- =========================================
-- spec_items --> groups -> colors
-- =========================================
MERGE @colors AS target
USING
(
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_styles_groups sg with (nolock) on sg.group_id = si.item
		left join catalog_selections_group_detail sgd with (nolock) on session_id = @session_id and sgd.group_id = sg.group_id
		left join veo_colors c with (nolock) on c.part_no = sgd.item
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and sgd.item_type = 'color'
		AND ISNULL(sgd.area_id, '') in ('', @area_id)
		AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'group'
		and s.class = @item_class
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);


-- =========================================
-- spec_items --> styles -> colors
-- =========================================
MERGE @colors AS target
USING
(
	--insert into @colors
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_colors c with (nolock) on c.product_id = si.product_id and c.style_id = si.item
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'style'
		and s.class = @item_class
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

-- =========================================
-- spec_items --> colors
-- =========================================
MERGE @colors AS target
USING
(
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_colors c with (nolock) on c.part_no = si.item
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'color'
		and s.class = @item_class
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

-- =======================================================
-- remove parts explicitly excluded from spec area
-- =======================================================
IF @spec_id <> 0 AND EXISTS( SELECT TOP 1 line_no FROM veo_spec_areas_items WHERE spec_id = @spec_id)
BEGIN
	DELETE
		c
	FROM
		@colors c
		INNER JOIN dbo.vdsf_selSpecAreaExcludedParts(@session_id, @spec_id, @application_id, @product_id, @area_id, @sub_area_id, @location_id, @item_id) saep ON saep.part_no = c.part_no
END

-- =======================================================
-- remove not designer_selectable parts --> colors
-- =======================================================
delete
	c
from
	@colors c
	inner join veo_colors c1 with (nolock) on c1.part_no = c.part_no
	inner join veo_stocking_codes vsc with (nolock) on vsc.code = c1.stocking_code
where
	vsc.designer_selectable = 0

-- ===================
-- return paged values
-- ===================
declare @results table
(
	product_id varchar(10),
	style_id varchar(50),
	color_id varchar(50),
	part_no varchar(100),
	name varchar(100),
	part_no_override varchar(100),
	part_name_official VARCHAR(150),
	image_id int null,
	[row_number] int,
	[row_count] int
)

insert into @results
select distinct
	c.*,
	ROW_NUMBER() over (order by part_name_official) as [row_number],
	COUNT(part_no) over() as row_count
from
	@colors c
where
	c.part_no is not null
	and (
		@search_criteria = ''
		or c.name like '%' + @search_criteria + '%'
		or c.part_no like '%' + @search_criteria + '%'
		or (
			@builder_overrides_enabled = 1
			and (
				c.part_name_official like '%' + @search_criteria + '%'
				or c.part_no_override like '%' + @search_criteria + '%'
			)
		)
	)
order by
	part_name_official

-- if a particular part is requested, return the page with that part by calculating a new value for @page_index
if len(@selected_part_no) > 0
begin
	-- determine the row of the part no
	DECLARE @row_no INT = null
	SELECT @row_no = [row_number] FROM @results WHERE part_no = @selected_part_no

	IF @row_no IS NULL
		SELECT @page_index = 0
	else
		SELECT @page_index = ((@row_no -1) / @page_size)
end

DELETE FROM @results
WHERE [row_number] <= @page_index * @page_size
	OR [row_number] > (@page_index + 1) * @page_size

select
	r.*,
	case
	when (@builder_overrides_enabled = 1 AND r.image_id IS NOT NULL)
		then (NULL)
		else (c.image_data)
	end as image_data
from
	@results r
	left join veo_colors c with (nolock) on c.part_no = r.part_no
order by
	r.part_name_official
GO
PRINT N'Creating Procedure [dbo].[vds_selSpecPatternItems]...';


GO
CREATE PROCEDURE [dbo].[vds_selSpecPatternItems]
	@page_index int OUTPUT,
	@page_size int = 12,
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
    @search_criteria VARCHAR(MAX) = '',
	@selected_pattern_id int = 0,
	@security_token UNIQUEIDENTIFIER = NULL,
	@debug bit = 0
AS
/*
	Procedure:		vds_selSpecPatternItems
	Author:			Richard Gladstone
	Date:			04/09/2015
	Purpose:		Design Selections Wizard Pattern Selections
	Usages:			

					vds_selSpecPatternItems 0, 6, 'cb9df5ee-8cab-4a94-9f1d-e8988159dd72', 11874621,'',0,'01234567-89AB-CDEF-0000-123456789ABC'
					vds_selSpecPatternItems 1, 6, 'cb9df5ee-8cab-4a94-9f1d-e8988159dd72', 11874621,'',0,'01234567-89AB-CDEF-0000-123456789ABC'
					vds_selSpecPatternItems 2, 6, 'cb9df5ee-8cab-4a94-9f1d-e8988159dd72', 11874621,'',0,'01234567-89AB-CDEF-0000-123456789ABC'
					vds_selSpecPatternItems 3, 6, 'cb9df5ee-8cab-4a94-9f1d-e8988159dd72', 11874621,'',0,'01234567-89AB-CDEF-0000-123456789ABC'
					vds_selSpecPatternItems 4, 6, 'cb9df5ee-8cab-4a94-9f1d-e8988159dd72', 11874621,'',0,'01234567-89AB-CDEF-0000-123456789ABC'
					vds_selSpecPatternItems 5, 6, 'cb9df5ee-8cab-4a94-9f1d-e8988159dd72', 11874621,'',0,'01234567-89AB-CDEF-0000-123456789ABC'
					vds_selSpecPatternItems 0, 6, 'cb9df5ee-8cab-4a94-9f1d-e8988159dd72', 11874621,'',722,'01234567-89AB-CDEF-0000-123456789ABC'
					vds_selSpecPatternItems 0, 6, 'cb9df5ee-8cab-4a94-9f1d-e8988159dd72', 11874621,'Horizontal',0,'01234567-89AB-CDEF-0000-123456789ABC'
					vds_selSpecPatternItems 0, 6, 'cb9df5ee-8cab-4a94-9f1d-e8988159dd72', 11874621,'24',0,'01234567-89AB-CDEF-0000-123456789ABC',1

	History:		20151016 RIG Use product_patterns_customers as an exclusion filter rather than an exclusive filter

					STAG2014 on epp_sql2012_dev.veosolutions
					vds_selSpecPatternItems 0, 6, '6857F2CF-0415-4BED-B5AE-E7C641CD9F47',12039593,'',0,'01234567-89AB-CDEF-0000-123456789ABC',0
					vds_selSpecPatternItems 1, 6, '6857F2CF-0415-4BED-B5AE-E7C641CD9F47',12039593,'',0,'01234567-89AB-CDEF-0000-123456789ABC',0
					vds_selSpecPatternItems 2, 6, '6857F2CF-0415-4BED-B5AE-E7C641CD9F47',12039593,'',0,'01234567-89AB-CDEF-0000-123456789ABC',0
					vds_selSpecPatternItems 3, 6, '6857F2CF-0415-4BED-B5AE-E7C641CD9F47',12039593,'',0,'01234567-89AB-CDEF-0000-123456789ABC',0

					NONS2014 on epp_sql2012_dev.veosolutions
					vds_selSpecPatternItems 0, 6, '546412a8-82ae-4200-852f-e570ec8e9046',12228825,'',0,'01234567-89AB-CDEF-0000-123456789ABC',0
					vds_selSpecPatternItems 1, 6, '546412a8-82ae-4200-852f-e570ec8e9046',12228825,'',0,'01234567-89AB-CDEF-0000-123456789ABC',0
					vds_selSpecPatternItems 2, 6, '546412a8-82ae-4200-852f-e570ec8e9046',12228825,'',0,'01234567-89AB-CDEF-0000-123456789ABC',0
					vds_selSpecPatternItems 3, 6, '546412a8-82ae-4200-852f-e570ec8e9046',12228825,'',0,'01234567-89AB-CDEF-0000-123456789ABC',0
					vds_selSpecPatternItems 4, 6, '546412a8-82ae-4200-852f-e570ec8e9046',12228825,'',0,'01234567-89AB-CDEF-0000-123456789ABC',0
					select * from catalog_selections where session_id = '546412a8-82ae-4200-852f-e570ec8e9046' and application = 'Flooring' and product = 'Tile' and area = 'Bath 2'

*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- =========================
	-- Parameter Cleanup
	-- =========================
	if @selected_pattern_id > 0
		set @search_criteria = ''

	-- ==========================
	-- Variable Declaration
	-- ==========================
	DECLARE @hold_application_id VARCHAR(10) = ''
	DECLARE @hold_product_id VARCHAR(10) = ''
	DECLARE @hold_area_id VARCHAR(10) = ''
	DECLARE @hold_sub_area_id VARCHAR(10) = ''
	DECLARE @hold_external_organization_id VARCHAR(20) = ''
	declare @organization_id uniqueidentifier

	--=====================================================================
	-- Convert the build ID into the application, product, area, and 
	-- sub area IDs.
	--=====================================================================
	SELECT
		@hold_application_id = vap.application_id,
		@hold_product_id = vp.product_id,
		@hold_area_id = csa.area_id,
		@hold_sub_area_id = csa.sub_area_id
	FROM
		dbo.catalog_selections_areas csa WITH (NOLOCK)
		LEFT JOIN dbo.Veo_applications vap WITH (NOLOCK) ON vap.name = csa.[application]
		LEFT JOIN dbo.Veo_products vp WITH (NOLOCK) ON vp.name = csa.product
	WHERE
		csa.session_id = @session_id
		AND csa.build_id = @build_id

	--=====================================================================
	-- Convert the organization id into the external organization ID.
	--=====================================================================
	select 
		@organization_id = organization_id
	from
		account_organization_user_profile_plan_catalog_sessions 
	where
		session_id = @session_id

	SELECT
		@hold_external_organization_id = org.external_organization_id
	FROM
		dbo.VeoSolutionsSecurity_organizations org WITH (NOLOCK)
	WHERE
		org.organization_id = @organization_id

	--=====================================================================
	-- Find all the patterns for this customer.
	--=====================================================================
	DECLARE @customerPatterns TABLE 
	(
		pattern_id INT 
	)

	INSERT INTO @customerPatterns 
	SELECT
		pp.pattern_id
	FROM
		dbo.Veo_product_patterns pp WITH (NOLOCK)
		LEFT JOIN dbo.Veo_product_patterns_customers ppc WITH (NOLOCK) ON ppc.pattern_id = pp.pattern_id and ppc.custnmbr = @hold_external_organization_id
	WHERE
		ppc.pattern_id IS NULL
		or ppc.custnmbr <> @hold_external_organization_id

	--=====================================================================
	-- Find all patterns that satisfy the criteria.
	--=====================================================================
	declare @patterns table
	(
		pattern_id int,
		pattern_name varchar(max)
	)

	insert into @patterns
	SELECT DISTINCT
		pp.pattern_id,
		pp.pattern_name
	FROM
		@customerPatterns cp
		left join dbo.Veo_product_patterns pp WITH (NOLOCK) on pp.pattern_id = cp.pattern_id
		LEFT JOIN dbo.Veo_product_patterns_areas ppa WITH (NOLOCK) ON ppa.pattern_id = pp.pattern_id
		-- LEFT JOIN dbo.Veo_product_patterns_customers ppc WITH (NOLOCK) ON ppc.pattern_id = pp.pattern_id AND ppc.custnmbr = @hold_external_organization_id
	WHERE
		pp.active = 1
		AND pp.application_id = @hold_application_id
		AND pp.product_id = @hold_product_id
		AND ((ppa.area_id = @hold_area_id AND ppa.sub_area_id = @hold_sub_area_id) or (ppa.area_id is null))
		-- AND ((ppc.pattern_id IS NOT NULL) OR (cp.pattern_id IS NOT NULL) )
		AND cp.pattern_id IS NOT NULL
		AND ((@search_criteria = '') OR (PATINDEX('%'+@search_criteria+'%', pp.pattern_name) > 0) OR (PATINDEX('%'+@search_criteria+'%', cast(pp.pattern_id as varchar(max))) > 0) OR (pp.pattern_id = @selected_pattern_id))

if @debug = 1 select * from @patterns

-- ===================
-- return paged values
-- ===================
-- if a particular part is requested, return the page with that part by calculating a new value for @PAGE_INDEX
if @selected_pattern_id > 0
begin

	declare @patterns_page table
	(
		row_no BIGINT,
		pattern_id int,
		pattern_name varchar(max)
	)

	insert into @patterns_page
	select distinct 
		ROW_NUMBER() OVER (ORDER BY p.pattern_name, p.pattern_id), p.*
	from 
		@patterns p
		left join veo_product_patterns p2 with (nolock) on p2.pattern_id = p.pattern_id
	where 
		p.pattern_id is not null 
		and ((@search_criteria = '') OR (PATINDEX('%'+@search_criteria+'%', p2.pattern_name) > 0) OR (PATINDEX('%'+@search_criteria+'%', cast(p2.pattern_id as varchar(max))) > 0) OR (p2.pattern_id = @selected_pattern_id))
	
	-- determine the row of the part no
	DECLARE @row_no INT = null
	SELECT @row_no = row_no FROM @patterns_page WHERE pattern_id = @selected_pattern_id

	IF @row_no IS NULL 
		SELECT @page_index = 0
	else
		SELECT @page_index = ((@row_no -1) / @page_size) 

end

declare @results table
(
	pattern_id int,
	pattern_name varchar(100),
	[row_number] int,
	[row_count] int
)

if @debug = 1 select * from @patterns

insert into @results
select distinct p.*, row_number() over(ORDER BY p.pattern_name) as row_number , count(p.pattern_id) over() as row_count
from 
	@patterns p
	left join veo_product_patterns p2 with (nolock) on p2.pattern_id = p.pattern_id
where 
	p.pattern_id is not null 
	and ((@search_criteria = '') or (p.pattern_name like '%' + @search_criteria + '%') or (PATINDEX('%'+@search_criteria+'%', cast(p2.pattern_id as varchar(max))) > 0) OR  (p.pattern_id = @selected_pattern_id))
order by 
	pattern_name
OFFSET @page_index * @page_size ROWS
FETCH NEXT @page_size ROWS ONLY

select 
	r.*, p.image_data
from
	@results r
	left join veo_product_patterns p with (nolock) on p.pattern_id = r.pattern_id
order by
	r.pattern_name
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSpecSinkItems]...';


GO
CREATE procedure [dbo].[vds_selSpecSinkItems]
	@page_index int OUTPUT,
	@page_size int = 12,
	@session_id uniqueidentifier,
	@build_id bigint,
	@item_id VARCHAR(50),
	@search_criteria varchar(100) = '',
	@selected_part_no varchar(81) = '',
	@builder_overrides_enabled BIT = 0,
	@security_token uniqueidentifier,
	@debug bit = 0
as

/*
	Procedure:		vds_selSpecSinkItems
	Author:			Richard Gladstone
	Date:			04/07/2015
	Purpose:		Specialized procedure for VEO Design Studio Selection Wizard FIELD Selection

	Modified:		Shelby Mansker
	Date:			4/5/2016
	Description:	Added Debug flag with debug selects for testing purposes.

	Modified: Shelby Mansker
	Date: 1/5/2017
	Description: Replaced the use of stocking_codes.include_in_search with stocking_codes.homebuyer_selectable.

	Modified: Shelby Mansker
	Date: 8/29/2019
	Description: Fixed issues with joins, when removing colors due to spec_areas_items exclusions.

	Modified:		Roger Wang
	Date:			5/13/2021
	Description:	Replaced the use of stocking_codes.homebuyer_selectable with stocking_codes.designer_selectable.

	Modified:		Roger Wang
	Date:			8/9/2022
	Description:	Include area/sub area when fetching items from group detail.

	Modified:		Roger Wang
	Date:			7/11/2023
	Description:	Filter styles/colors based on plan item in spec_areas_items.

	Modified:		Reid Wilson
	Date:			9/20/2023
	Description:	Allow searching by and returning builder override part id and name.

	Modified:		Daniel Arwe
	Date: 			12/18/2023
	Description:	Added image_id column, using join on veo.colors_customer_overrides table, to support builder override part images.
*/

-- =====================
-- Authentication
-- =====================
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

-- =========================
-- Parameter Cleanup
-- =========================
if len(@selected_part_no) > 0
	set @search_criteria = ''

-- ============================
-- Variable Declaration
-- ============================
declare @application_id varchar(10) = '2'
declare @product_id varchar(10) = 'O'
declare @item_class varchar(50) = 'sink'
declare @spec_id int
declare @area_id varchar(50)
declare @sub_area_id varchar(50)
declare @location_id int
declare @effective_date datetime
declare @external_organization_id varchar(20)

select
	@area_id = area_id,
	@sub_area_id = sub_area_id,
	@location_id = location_id,
	@spec_id = vpm.spec_id,
	@external_organization_id = builder_id
from
	veo_plan_builds vpb with (nolock)
	left join veo_plan_mstr vpm with (nolock) on vpm.plan_id = vpb.plan_id
	left join veo_spec_mstr vsm with (nolock) on vsm.spec_id = vpm.spec_id
where
	vpb.build_id_num = @build_id

select
	@effective_date = effective_date
from
	catalog_selections_areas csa with (nolock)
	left join catalog_selections cs with (nolock) on csa.session_id = cs.session_id and csa.selected_field_group = cs.row_id
	left join account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock) on aouppcs.session_id = cs.session_id
where
	csa.session_id = @session_id
	and csa.build_id = @build_id

declare @colors table
(
	product_id varchar(10),
	style_id varchar(50),
	color_id varchar(50),
	part_no varchar(100),
	name varchar(100),
	part_no_override varchar(100),
	part_name_official varchar(150),
	image_id int null
)

-- =========================================
-- spec_items --> groups -> styles -> colors
-- =========================================
insert into @colors
select distinct
	c.product_id,
	c.style_id,
	c.color_id,
	c.part_no,
	c.name,
	cco.customer_reference_no,
	case
		when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
			then (cco.color_private_label)
		else c.name
	end as part_name_official,
	cco.image_id
from
	veo_spec_items si with (nolock)
	left join veo_styles_groups sg with (nolock) on sg.group_id = si.item
	left join catalog_selections_group_detail sgd with (nolock) on session_id = @session_id and sgd.group_id = sg.group_id
	left join veo_styles s with (nolock) on s.product_id = sg.product_id and s.style_id = sgd.item
	left join veo_colors c with (nolock) on c.product_id = s.product_id and c.style_id = s.style_id
	left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
where
	spec_id = @spec_id
	and sgd.item_type = 'style'
	AND ISNULL(sgd.area_id, '') in ('', @area_id)
	AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
	and si.application_id = @application_id
	and si.product_id = @product_id
	and si.item_type = 'group'
	and s.class = @item_class

if @debug = 1
	SELECT 'spec_items -> groups -> styles -> colors' as selection, * FROM @colors

-- =========================================
-- spec_items --> groups -> colors
-- =========================================
MERGE @colors AS target
USING
(
	--insert into @colors
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_styles_groups sg with (nolock) on sg.group_id = si.item
		left join catalog_selections_group_detail sgd with (nolock) on session_id = @session_id and sgd.group_id = sg.group_id
		left join veo_colors c with (nolock) on c.part_no = sgd.item
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and sgd.item_type = 'color'
		AND ISNULL(sgd.area_id, '') in ('', @area_id)
		AND ISNULL(sgd.sub_area_id, '') in ('', @sub_area_id)
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'group'
		and s.class = @item_class
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

if @debug = 1
	SELECT 'spec_items -> groups -> colors' as selection, * FROM @colors

-- =========================================
-- spec_items --> styles -> colors
-- =========================================
MERGE @colors AS target
USING
(
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_colors c with (nolock) on c.product_id = si.product_id and c.style_id = si.item
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'style'
		and s.class = @item_class
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

if @debug = 1
	SELECT 'spec_items -> styles -> colors' as selection, * FROM @colors

-- =========================================
-- spec_items --> colors
-- =========================================
MERGE @colors AS target
USING
(
	--insert into @colors
	select distinct
		c.product_id,
		c.style_id,
		c.color_id,
		c.part_no,
		c.name,
		cco.customer_reference_no,
		case
			when (@builder_overrides_enabled = 1 and DATALENGTH(cco.color_private_label) > 0)
				then (cco.color_private_label)
			else c.name
		end as part_name_official,
		cco.image_id
	from
		veo_spec_items si with (nolock)
		left join veo_colors c with (nolock) on c.part_no = si.item
		left join veo_styles s with (nolock) on s.product_id = c.product_id and s.style_id = c.style_id
		left join veo_colors_customer_overrides cco with (nolock) on cco.part_no = c.part_no and cco.customer_id = @external_organization_id
	where
		spec_id = @spec_id
		and si.application_id = @application_id
		and si.product_id = @product_id
		and si.item_type = 'color'
		and s.class = @item_class
) as source
ON target.part_no = source.part_no
WHEN NOT MATCHED THEN
	INSERT (product_id, style_id, color_id, part_no, name, part_no_override, part_name_official, image_id) VALUES (source.product_id, source.style_id, source.color_id, source.part_no, source.name, source.customer_reference_no, source.part_name_official, source.image_id);

if @debug = 1
	SELECT 'spec_items -> colors' as selection, * FROM @colors

-- =======================================================
-- remove parts explicitly excluded from spec area
-- =======================================================
DELETE
	c
FROM
	@colors c
	INNER JOIN dbo.vdsf_selSpecAreaExcludedParts(@session_id, @spec_id, @application_id, @product_id, @area_id, @sub_area_id, @location_id, @item_id) saep ON saep.part_no = c.part_no

-- =======================================================
-- remove not designer_selectable parts --> colors
-- =======================================================
delete
	c
from
	@colors c
	inner join veo_colors c1 with (nolock) on c1.part_no = c.part_no
	inner join veo_stocking_codes vsc with (nolock) on vsc.code = c1.stocking_code
where
	vsc.designer_selectable = 0

-- ===================
-- return paged values
-- ===================
declare @results table
(
	product_id varchar(10),
	style_id varchar(50),
	color_id varchar(50),
	part_no varchar(100),
	name varchar(100),
	part_no_override varchar(100),
	part_name_official VARCHAR(150),
	image_id int null,
	[row_number] int,
	[row_count] int
)

insert into @results
select distinct
	c.*,
	ROW_NUMBER() over (order by part_name_official) as [row_number],
	COUNT(part_no) over() as row_count
from
	@colors c
where
	c.part_no is not null
	and (
		@search_criteria = ''
		or c.name like '%' + @search_criteria + '%'
		or c.part_no like '%' + @search_criteria + '%'
		or (
			@builder_overrides_enabled = 1
			and (
				c.part_name_official like '%' + @search_criteria + '%'
				or c.part_no_override like '%' + @search_criteria + '%'
			)
		)
	)
order by
	part_name_official

-- if a particular part is requested, return the page with that part by calculating a new value for @page_index
if len(@selected_part_no) > 0
begin
	-- determine the row of the part no
	DECLARE @row_no INT = null
	SELECT @row_no = [row_number] FROM @results WHERE part_no = @selected_part_no

	IF @row_no IS NULL
		SELECT @page_index = 0
	else
		SELECT @page_index = ((@row_no -1) / @page_size)
end

DELETE FROM @results
WHERE [row_number] <= @page_index * @page_size
	OR [row_number] > (@page_index + 1) * @page_size

select
	r.*,
	case
	when (@builder_overrides_enabled = 1 AND r.image_id IS NOT NULL)
		then (NULL)
		else (c.image_data)
	end as image_data
from
	@results r
	left join veo_colors c with (nolock) on c.part_no = r.part_no
order by
	r.part_name_official
GO
PRINT N'Creating Procedure [dbo].[vds_selSupportLogEntries]...';


GO

CREATE procedure [dbo].[vds_selSupportLogEntries]
    @security_token uniqueidentifier,
    @organization_id uniqueidentifier = null,
    @problem_type varchar(max) = null,
    @problem_status bit = null,
    @start_date date = null,
    @end_date date = null, 
	@partial_address varchar(max) = null
AS

/*
	Author:      Adrian Garza
	Create date: 9/5/2014
	Description: Returns a list of support log entries, filtered by the search criteria passed in

	Modified: Shelby Mansker
	Date: 5/26/2016
	Description: Query was using direct link to database, rather than synonym, for VeoSolutionsSecurity.dbo.Organizations.
		It now uses the synonym, so it should work in all of our development environments.

	History: 
		01.08.16 - added partial address search, and profile plan address to search results 
		08.05.15 - changed join to use organization_id added to the support_log table instead of session 

	TESTING: 
	select top 100 * from support_log order by create_date desc
	-- search on Type	
	[vds_selSupportLogEntries] '01234567-89AB-CDEF-0000-123456789ABC', '8AAECC3A-2D9E-4500-B0CF-D79D947D33A7', 'Cabinet Swap Price Override', null, null, null, '' 
	-- search on address 
	[vds_selSupportLogEntries] '01234567-89AB-CDEF-0000-123456789ABC', '8AAECC3A-2D9E-4500-B0CF-D79D947D33A7', 'Cabinet Swap Price Override', null, null, null, '123 Spring' 

*/
BEGIN

    --Validate the security token
    IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
    BEGIN
	    RAISERROR('Access Denied.',16,1)		
	    RETURN
    END


    SELECT 
        sl.entry_id,
        sl.session_id,
		isnull(pp.address, '') as [address],  
        sl.entry_date,
        sl.cc_list,
        sl.problem_type,
        sl.body_message,
        sl.[application],
        sl.product,
        sl.problem_source AS problem_source_id,
        sps.name AS problem_source,
        sl.problem_status,
        sl.problem_resolution AS problem_resolution_id,
        spr.name AS problem_resolution,
        sl.resolution_date,
        sl.resolved_by,
        sl.notes,
		sl.organization_id,
        sl.stamp
    FROM dbo.support_log sl WITH (NOLOCK)
        LEFT JOIN dbo.support_problem_resolutions spr WITH (NOLOCK) ON spr.resolution_id = sl.problem_resolution
        LEFT JOIN dbo.support_problem_sources sps WITH (NOLOCK) ON sps.source_id = sl.problem_source
        LEFT JOIN account_organization_user_profile_plan_catalog_sessions s WITH (NOLOCK) ON sl.session_id = s.session_id
		LEFT JOIN account_organization_user_profile_plan pp WITH (NOLOCK) on pp.account_id = s.account_id AND pp.organization_id = s.organization_id AND pp.user_id = s.user_id 
					AND pp.community_name = s.community_name AND pp.series = s.series AND pp.plan_name = s.plan_name  -- used to filter on address 
		LEFT JOIN dbo.VeoSolutionsSecurity_organizations o WITH (NOLOCK) on o.organization_id = sl.organization_id 
    WHERE  
	    (sl.organization_id = @organization_id OR @organization_id IS NULL)
	    AND (sl.problem_type = @problem_type OR @problem_type = '' OR @problem_type IS NULL)
	    AND (sl.problem_status = @problem_status OR @problem_status IS NULL)
        AND (@start_date IS NULL OR (DATEDIFF(day, @start_date, sl.entry_date) >= 0))
        AND (@end_date IS NULL OR (DATEDIFF (day, sl.entry_date, @end_date) >= 0))

		--only show logs from orgs where user is a member of
		AND sl.organization_id in (  select organization_id from  dbo.vdsf_selUserOrganizationsFromToken(@security_token) )
		
		-- filter by address if exists 
		AND (@partial_address IS NULL OR @partial_address = '' OR pp.address like '%' + @partial_address + '%') 
END
GO
PRINT N'Creating Procedure [dbo].[vds_selSupportProblemTypes]...';


GO
CREATE PROCEDURE [dbo].[vds_selSupportProblemTypes]
@security_token UNIQUEIDENTIFIER,
@organization_id uniqueidentifier = null
AS

-- Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

select distinct
	problem_type
from
	support_log sl with (nolock)
	left join account_organization_user_profile_plan_catalog_sessions s with (nolock) on sl.session_id = s.session_id
where
	(@organization_id is null or sl.organization_id = @organization_id)
	--only show logs from orgs where user is a member of
	and sl.organization_id in ( select organization_id from  dbo.vdsf_selUserOrganizationsFromToken(@security_token) )
GO
PRINT N'Creating Procedure [dbo].[vds_selSupportResolutions]...';


GO
create procedure vds_selSupportResolutions

@security_token UNIQUEIDENTIFIER 

as

-- Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

select
*
from support_problem_resolutions with (nolock)
GO
PRINT N'Creating Procedure [dbo].[vds_selSupportSources]...';


GO
create procedure vds_selSupportSources

@security_token UNIQUEIDENTIFIER 

as

-- Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

select
*
from support_problem_sources with (nolock)
GO
PRINT N'Creating Procedure [dbo].[vds_selThumbnailPhoto]...';


GO
CREATE PROCEDURE dbo.vds_selThumbnailPhoto 
	@photo_id AS INT
AS
/*
    Author: Shelby Mansker
    Created On: 1/23/2015
    Description: Fetches the thumbnail version of the photo's data.
                 This method is intentionally not secured, 
                 so it can be called without a token.
*/
BEGIN
    SELECT
        thumbnail_photo_data AS photo_data
    FROM
        Veo_photos WITH (NOLOCK)
    WHERE
        photo_id = @photo_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_selUnmappedAccountOrganizationPlans]...';


GO
CREATE PROCEDURE [dbo].[vds_selUnmappedAccountOrganizationPlans]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @plan_name VARCHAR(50),
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Saul Sanchez
    Create Date: 8/27/2015
    Description: Returns the unmapped account organization plan for the specified plan name.
                 The rules for unmapping are as follows:
                 1. If the specified plan name is found in the account_organization_plans table,
                    and a mapped name is found in the account_organization_plans_mappings table,
                    then return any the mapped names (since plan name is not a primary key in the account_organization_plans table).
                 2. If the specified plan name is found in the account_organization_plans_table,
                    but a mapped name is not found in the account_organization_plans_mappings table,
                    then return the specified plan name.
                 3. If the specified plan name is not found in either table,
                    then return an empty string as the mapped name.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT
        aopm.account_id,
        aopm.organization_id,
        aopm.plan_id,
        ISNULL(ISNULL(aopm.mapped_name, aop.name), '') as plan_name,
        ISNULL(aopm.[source], '') as [source]
    FROM
        VeoSolutionsSecurity_account_organization_plans aop WITH (NOLOCK)
        LEFT JOIN VeoSolutionsSecurity_account_organization_plans_mappings aopm WITH (NOLOCK)
            ON aopm.account_id = aop.account_id
            AND aopm.organization_id = aop.organization_id
            AND aopm.plan_id = aop.plan_id
    WHERE
        aop.account_id = @account_id
        AND aop.organization_id = @organization_id
        AND aop.name = @plan_name COLLATE SQL_Latin1_General_CP1_CS_AS
END
GO
PRINT N'Creating Procedure [dbo].[vds_selUnmappedProfilePlanName]...';


GO
CREATE PROCEDURE [dbo].[vds_selUnmappedProfilePlanName]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@user_id UNIQUEIDENTIFIER,
	@community VARCHAR(50),
	@series VARCHAR(50),
	@plan VARCHAR(50),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Create Date: 7/24/2015
	Desription: Returns the unmapped plan name for a given account organization user profile plan.
				An unmapped name refers to the plan's name in Echelon (plan_mstr table). The rules for
				unmapping are as follows:
				1. If the profile plan name, has a mapping in the plan mappings table, then get the unmapped name from it.
				3. If the profile plan name, doesn't have a mapping in the plan mappings table, then it is the unmapped name.

	Modified: Shelby Mansker
	Date: 10/27/2015
	Description: This method no longer attempts to return the base plan name, if the profile plan has one. Instead,
		it simply returns either the plan name, or its mapping (if it has one). Currently it will resolve a plan based on a base plan name,
		if a base plan was passed as the @plan parameter. This is because the creation session code currently passes in the base plan name
		to this method. In the future, the code will be modified to not do this, at which point the check for a base plan match can be removed.

	Modified: Roger Wang
	Date: 05/13/2019
	Description: Take out base plan name matching

	-- TESTS --

	-- A profile plan with no entry in the mapping table
	EXEC dev_selUnmappedProfilePlanName_shelby
		@account_id = 'BAB32B7E-3ADA-497C-862E-E5083971CC59',
		@organization_id = '41E2B9CA-9B05-4C7A-9994-8DBD48660FF9',
		@user_id = '813B279C-6BDD-4B0D-8385-0930FFA1FF78',
		@community = 'CHADWICK FARMS',
		@plan = 'ASH',
		@series = 'Series A',
		@security_token = '01234567-89AB-CDEF-0000-123456789ABC'

	-- A profile plan with an entry in the mapping table
	EXEC dev_selUnmappedProfilePlanName_shelby
		@account_id = 'BAB32B7E-3ADA-497C-862E-E5083971CC59',
		@organization_id = '41E2B9CA-9B05-4C7A-9994-8DBD48660FF9',
		@user_id = 'AE1E0638-5552-4FA6-88CE-BBF71D5536FA',
		@community = 'SAVANNAH',
		@plan = 'ATWOOD',
		@series = 'Series A',
		@security_token = '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- First, determine if we are using a base plan or not
	DECLARE @vds_plan_name VARCHAR(50)
	SELECT
		@vds_plan_name = plan_name
	FROM
		account_organization_user_profile_plan pp WITH (NOLOCK)
	WHERE
		account_id = @account_id
		AND organization_id = @organization_id
		AND [user_id] = @user_id
		AND community_name = @community
		AND series = @series
		AND plan_name = @plan

	-- Next, check to see if there is a mapping, if there is then grab it, otherwise use the vds_plan_name as is
	SELECT
		ISNULL(map.mapped_name, @vds_plan_name) AS unmapped_plan_name
	FROM
		VeoSolutionsSecurity_account_organization_plans p WITH (NOLOCK)
		LEFT JOIN VeoSolutionsSecurity_account_organization_plans_mappings map WITH (NOLOCK) ON map.account_id = p.account_id AND map.organization_id = p.organization_id AND map.plan_id = p.plan_id
	WHERE
		p.account_id = @account_id
		AND p.organization_id = @organization_id
		AND p.name = @vds_plan_name 
END
GO
PRINT N'Creating Procedure [dbo].[vds_selUser]...';


GO
CREATE PROCEDURE dbo.vds_selUser
    @user_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 11/13/2015
    Description: Fetches a user by their id.
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT
        *
    FROM
        VeoSolutionsSecurity_users WITH (NOLOCK)
    WHERE
        [user_id] = @user_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_selUserActiveAccountOrganizations]...';


GO
CREATE PROCEDURE [dbo].[vds_selUserActiveAccountOrganizations]
	@account_id UNIQUEIDENTIFIER,
	@user_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 2/14/2017
	Description: Returns all of the organizations that a user belongs to, in a given account.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SELECT
		aou.account_id,
		aou.organization_id,
		ao.account_org_id
	FROM
		VeoSolutionsSecurity_account_organization_users aou WITH (NOLOCK)
		JOIN VeoSolutionsSecurity_account_organizations ao WITH (NOLOCK) ON ao.account_id = aou.account_id AND ao.organization_id = aou.organization_id
		JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) ON o.organization_id = ao.organization_id
	WHERE
		aou.account_id = @account_id
		AND aou.[user_id] = @user_id
		AND aou.active = 1
		AND ao.active = 1
		AND o.active = 1
END
GO
PRINT N'Creating Procedure [dbo].[vds_selUserByEmail]...';


GO
CREATE PROCEDURE [dbo].[vds_selUserByEmail]
    @email nvarchar(100)
AS
/*
    Author: Robert Hobbs
    Date: 05/20/16
    Description: Fetches a user by email

	Modified: Shelby Mansker
	Date: 7/18/2016
	Description: Removed Security Token requirement, since this
		method will be used during login.
*/
/* TESTING 
	vds_selUserByEmail 'roberthobbs.mail@gmail.com', '01234567-89AB-CDEF-0000-123456789ABC'
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    SELECT TOP 1
        *
    FROM
        VeoSolutionsSecurity_users WITH (NOLOCK)
    WHERE
        email = @email 

END
GO
PRINT N'Creating Procedure [dbo].[vds_selUserBySecurityToken]...';


GO
CREATE PROCEDURE [dbo].[vds_selUserBySecurityToken]
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Create Date: 8/4/2015
    Description: Fetches a user based on a security token. Security tokens represent
		a specific user's login session.

	Modified: Shelby Mansker
	Date: 7/18/2016
	Description: Now returns all fields from the users table, rather than specific ones.
*/
BEGIN
    DECLARE @user_id UNIQUEIDENTIFIER

    SELECT
        @user_id = [user_id]
    FROM
        VeoSolutionsSecurity_users_login_sessions WITH (NOLOCK)
    WHERE
        security_token = @security_token

    SELECT
        *
    FROM
        VeoSolutionsSecurity_users WITH (NOLOCK)
    WHERE
        [user_id] = @user_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_selUserCompletedOrientationSteps]...';


GO
CREATE PROCEDURE [dbo].[vds_selUserCompletedOrientationSteps]
	@user_id UNIQUEIDENTIFIER
AS
/*
	Author:			Roger Wang
	Date:			1/10/2019
	Description:	Returns a list of orientation steps completed by a user
*/

SELECT
	*
FROM
	user_completed_orientation_steps
WHERE
	[user_id] = @user_id;
GO
PRINT N'Creating Procedure [dbo].[vds_selUserEventLog]...';


GO
CREATE PROCEDURE [dbo].[vds_selUserEventLog]
	@user_id uniqueidentifier = null, 
	@category nvarchar(50) = null, 
	@action nvarchar(50) = null,
	@start_date datetime = null,
	@end_date datetime = null,
	@organization_id uniqueidentifier = null,
	@include_test_users bit = 0
AS
/*
	Modified: Daniel Arwe
		Date: 05/10/2024
		Description: Changed from querying by days previous to querying by date range.  Also added the ability to filter by category and action.

	Modified: Daniel Arwe
		Date: 07/12/2024
		Description: Added organization_id parameter to filter by organization.

	Modified: Roger Wang
		Date: 09/04/2024
		Description: Added include_test_users parameter to indicate if test users should be included in the result.
*/
BEGIN
	SELECT
		el.*, u.first_name, u.last_name, u.email
	FROM
		event_log el WITH (NOLOCK)
		LEFT JOIN VeoSolutionsSecurity_users u ON u.user_id = el.user_id
	WHERE
		(el.user_id = @user_id OR @user_id IS NULL)
		AND (el.category = @category OR @category IS NULL)
		AND (el.action = @action OR @action IS NULL)
		AND (@start_date IS NULL OR el.event_log_date >= @start_date)
		AND (@end_date IS NULL OR el.event_log_date <= @end_date)
		AND (el.organization_id = @organization_id OR @organization_id IS NULL)
		AND (ISNULL(u.is_test_user, 0) = 0 OR @include_test_users = 1)
	ORDER BY
		el.event_log_date DESC
END
GO
PRINT N'Creating Procedure [dbo].[vds_selUsersByFullName]...';


GO
CREATE PROCEDURE [dbo].[vds_selUsersByFullName]
	@user_full_name VARCHAR(51)
AS
/*
	Author: Shelby Mansker
	Date: 4/28/2020
	Description: This proc returns all users that match the full name passed in.
		It does this by concatenating the first and last names of every user, with a
		space in between, and comparing them to the passed in full name value.
*/
BEGIN
	SELECT
		*
	FROM
		VeoSolutionsSecurity_users
	WHERE
		CONCAT(first_name, ' ', last_name) = @user_full_name
END
GO
PRINT N'Creating Procedure [dbo].[vds_selValidPatternsForBuild]...';


GO
CREATE PROCEDURE [dbo].[vds_selValidPatternsForBuild]
    @session_id UNIQUEIDENTIFIER,
    @build_id INT,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 10/5/2015
    Description: Fetches all of the valid product patterns for a given
        build.

    vds_selValidPatternsForBuild 'fb79f781-42fe-4ad1-b746-efa4f051b2ce', 12292947, '01234567-89AB-CDEF-0000-123456789ABC'
	vds_selValidPatternsForBuild '546412a8-82ae-4200-852f-e570ec8e9046', 12228825, '01234567-89AB-CDEF-0000-123456789ABC' -- non-staggered
	vds_selValidPatternsForBuild '6857F2CF-0415-4BED-B5AE-E7C641CD9F47', 12039593, '01234567-89AB-CDEF-0000-123456789ABC' 
	select * from veo.dbo.product_patterns_customers
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Get the echelon customer id from the organization record, based on the session
    DECLARE @customer_id VARCHAR(15)
    DECLARE @application_id VARCHAR(10)
    DECLARE @product_id VARCHAR(10)
    DECLARE @area_id VARCHAR(10)
    DECLARE @sub_area_id VARCHAR(10)

    SELECT
        @customer_id = o.external_organization_id,
		@application_id = vap.application_id,
		@product_id = vp.product_id,
		@area_id = csa.area_id,
		@sub_area_id = csa.sub_area_id
    FROM
        dbo.account_organization_user_profile_plan_catalog_sessions cs WITH (NOLOCK)
        JOIN dbo.VeoSolutionsSecurity_organizations o WITH (NOLOCK) ON o.organization_id = cs.organization_id
        JOIN dbo.catalog_selections_areas csa WITH (NOLOCK) ON csa.session_id = cs.session_id
		JOIN dbo.Veo_applications vap WITH (NOLOCK) ON vap.name = csa.[application]
		JOIN dbo.Veo_products vp WITH (NOLOCK) ON vp.name = csa.product
    WHERE
        cs.session_id = @session_id
        AND csa.build_id = @build_id

    -- Now fetch all of the valid product patterns for the build's customer, application, product, area and subarea
    SELECT 
        pp.pattern_id,
        pp.pattern_name
    FROM
        (  -- this except statement will return all of the patterns that aren't associated to any customer, and the ones associated with the build's customer
            SELECT pattern_id FROM Veo_product_patterns WITH (NOLOCK)
            EXCEPT
            SELECT pattern_id FROM Veo_product_patterns_customers WITH (NOLOCK) WHERE custnmbr = @customer_id
        ) customerPatterns
        JOIN Veo_product_patterns pp WITH (NOLOCK) ON pp.pattern_id = customerPatterns.pattern_id
        LEFT JOIN veo_product_patterns_areas ppa WITH (NOLOCK) ON ppa.pattern_id = pp.pattern_id
    WHERE
        pp.active = 1
        AND pp.application_id = @application_id
        AND pp.product_id = @product_id
        AND ((ppa.area_id = @area_id AND ppa.sub_area_id = @sub_area_id) OR ppa.area_id IS NULL) 
    ORDER BY
        pp.pattern_name   
END
GO
PRINT N'Creating Procedure [dbo].[vds_selWishListItem]...';


GO
CREATE PROCEDURE dbo.vds_selWishListItem
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
	@user_id UNIQUEIDENTIFIER,
    @wishlist_item_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
/*
	Author:      Shelby Mansker
	Create date: 11/25/2014
	Description: Returns the specified wish list item, if it can be found.
*/
BEGIN
    -- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT TOP 1
        account_id,
        organization_id,
        [user_id],
        wishlist_item_id,
        item_type,
        item_no,
        [description],
        image_data,
        notes,
        author,
        create_date,
        modifier,
        modified_date,
        stamp,
        gpc_id
    FROM
        dbo.account_organization_user_wishlist_items WITH (NOLOCK)
    WHERE
        account_id = @account_id
        AND organization_id = @organization_id
        AND [user_id] = @user_id
        AND wishlist_item_id = @wishlist_item_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_selWishListItemByItemTypeAndID]...';


GO
CREATE PROCEDURE dbo.vds_selWishListItemByItemTypeAndID
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
	@user_id UNIQUEIDENTIFIER, 
    @item_type VARCHAR(50),
    @item_no VARCHAR(81),
    @security_token UNIQUEIDENTIFIER
AS
/*
	Author:      Shelby Mansker
	Create date: 11/26/2014
	Description: Returns the specified wish list item, if it can be found,
      looking it up by the item type and item id, rather than wish list item id.
*/
BEGIN
    -- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    SELECT TOP 1
        account_id,
        organization_id,
        [user_id],
        wishlist_item_id,
        item_type,
        item_no,
        [description],
        image_data,
        notes,
        author,
        create_date,
        modifier,
        modified_date,
        stamp,
        gpc_id
    FROM
        dbo.account_organization_user_wishlist_items WITH (NOLOCK)
    WHERE
        account_id = @account_id
        AND organization_id = @organization_id
        AND [user_id] = @user_id
        AND item_type = @item_type
        AND item_no = @item_no
END
GO
PRINT N'Creating Procedure [dbo].[vds_selWishListItemImageData]...';


GO
CREATE PROCEDURE [dbo].[vds_selWishListItemImageData] 
	@wishlist_item_id UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 1/26/2015
    Description: Returns the image data for the specified wishlist item.
                 This method is not secured intentionally, as it may be called
                 without access to a security token.

    Modified 1/29/2015 - Shelby Mansker
        This method no longer requires account_id, organization_id, or user_id. Wish list item id
        should be enough to find the wish list item.

    EXEC dbo.vds_selWishListItemImageData @wishlist_item_id = 'EA691E55-6F2E-4A53-A050-40758903A3DA'
*/
BEGIN
    -- fetch and return the image data for the specified wish list item
    SELECT
        image_data
    FROM
        dbo.account_organization_user_wishlist_items WITH (NOLOCK)
    WHERE
        wishlist_item_id = @wishlist_item_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_sessionHasSelectedSlabs]...';


GO
CREATE PROCEDURE [dbo].[vds_sessionHasSelectedSlabs]
@session_id UNIQUEIDENTIFIER,
@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Art deHoyos
	Date: 11/7/2018
	Description: Returns true if a session has selected slabs, else false 
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DECLARE @result BIT = 0

	IF EXISTS ( SELECT TOP(1) row_id FROM catalog_selections_area_slabs WHERE session_id = @session_id )
	BEGIN
		SET @result = 1
	END

	SELECT @result
END
GO
PRINT N'Creating Procedure [dbo].[vds_sessionSelectionsXMLExport]...';


GO
CREATE PROCEDURE [dbo].[vds_sessionSelectionsXMLExport]
	@session_id	UNIQUEIDENTIFIER,
	@xml XML = NULL OUT
AS
/*
	Author: Shelby Mansker
	Date: 10/18/2019
	Description: Creates an XML structure, containing all of the selections for a session.
		If the @set_export_date flag is set, it will also set the export_date on the session record.

	Modified By: Shelby Mansker
	Date: 10/22/2019
	Description: This proc no longer updates the export date on the session record. Cindy asked that we
		allow that to happen on the Echelon side, because they may encounter an error after exporting, in
		which case, they wouldn't want the export date to be set.

	Modified By: Justin Pope
	Date: 1/14/2020
	Description: This proc did not include the credit_qty of each area item coming from catalog_selections_area_details.
		This change will match what was originally in vs_selVeoSolutionsSelectionSetDataExport.
	
	Modified By: Charles Moore
	Date: 9/10/2021
	Description: Convert Lot to string values

	Modified By: Justin Pope
	Date: 1/16/2025
	Description: Including new fields to the export
		completed_date & first_completed_date

	-- Example test for this proc
	DECLARE @xml XML
	EXEC vds_shelbyTestSelectionsExport @session_id = 'e9656bba-c9ff-4a0b-99df-e8751e244b69', @xml = @xml OUT
	SELECT @xml

	-- Example test for original proc
	DECLARE @xml XML
	EXEC vs_selVeoSolutionsSelectionSetDataExport @session_id_orig = 'e9656bba-c9ff-4a0b-99df-e8751e244b69', @xml = @xml OUT
	SELECT @xml
*/
BEGIN
	DECLARE @appointment_date DATETIME,
			@plan_id INT,
			@plan_name VARCHAR(50),
			@community_id INT;

	-- Get the user's first appointment date if they have one
	SELECT TOP(1)
		@appointment_date = sa.appointment_date
	FROM
		account_organization_user_profile_plan_catalog_sessions cs WITH (NOLOCK)
		JOIN account_organization_user_profile p WITH (NOLOCK) ON
			p.account_id = cs.account_id
			AND p.organization_id = cs.organization_id
			AND p.[user_id] = cs.[user_id]
		JOIN scheduling_appointments sa ON 
			sa.buyer_profile_id = p.profile_id
	WHERE
		cs.session_id = @session_id
	ORDER BY
		sa.appointment_date

	SET @appointment_date = ISNULL(@appointment_date, '1/1/1900')

	-- Figure out the echelon plan id
	SELECT TOP(1)
		@plan_id = vpb.plan_id,
		@plan_name = pm.plan_name
	FROM 
		account_organization_user_profile_plan_catalog_sessions cs WITH (NOLOCK)
		JOIN catalog_selections_areas csa WITH (NOLOCK) ON csa.session_id = cs.session_id
		JOIN veo_plan_builds vpb ON vpb.build_id_num = csa.build_id
		JOIN Veo_plan_mstr pm ON pm.plan_id = vpb.plan_id
	WHERE
		cs.session_id = @session_id

	-- Figure out the Echelon community id
	SELECT @community_id = dbo.getSessionWBSCommunityID(@session_id)

	-- Build the XML Output
	SET @xml = (SELECT
		@session_id AS '@user_plan_id',
		@session_id AS '@estimated_id',
		u.[user_id] AS '@user_id',
		@plan_id AS '@plan_id',
		cs.spec_id AS '@spec_id',
		cs.create_date AS '@effective_date',
		cs.completed_date as '@completed_date',
		cs.first_completed_date as '@first_completed_date',
		cs.designer AS '@designer',
		pp.job_type AS '@job_type',
		CONVERT(VARCHAR, @appointment_date, 101) AS '@appointment_date',
		pp.[address] AS 'address/@address',
		IIF(pp.lot in('0',''), '', CONCAT(pp.lot, ' ', pp.[block])) AS 'address/@lot_block',
		pp.city AS 'address/@city',
		pp.[state] AS 'address/@state',
		pp.zip_code AS 'address/@zipcode',
		ISNULL(o.external_organization_id, '') AS 'address/@builder_id',
		ISNULL(cs.spec_id, 0) AS 'address/@spec_id',
		cs.community_id AS 'address/@community_id',	
		ISNULL(cs.series, '') AS 'address/@series',
		@plan_name AS 'address/@plan_name',
		pp.elevation AS 'address/@elevation',
		CONCAT(u.first_name, ' ', u.last_name) AS 'contact/@contact_name',
		pp.home_phone AS 'contact/@home_phone',
		pp.work_phone AS 'contact/@work_phone',
		u.email AS 'contact/@email',
		(
			SELECT
				a.application_id AS '@application_id',
				p.product_id AS '@product_id',
				CONCAT(csa.area_id, '|', csa.sub_area_id) AS '@area_group_id',
				csa.area AS '@area_desc',
				csa.area_id AS '@area_id',
				csa.sub_area_id AS '@sub_area_id',
				csa.location_id AS '@location_id',
				csa.build_id AS '@build_id',
				dbo.vdsf_sanitizeStringForXml(
					CASE
						WHEN csa.notes <> '' and dbo.vdsf_getBomModificationNotes(@session_id,csa.build_id) <> '' THEN 	'Area Notes: '+csa.notes + ' Bom Mod Notes: '+ dbo.vdsf_getBomModificationNotes(@session_id,csa.build_id)
						WHEN csa.notes <> '' THEN 'Area Notes: '+csa.notes
						WHEN dbo.vdsf_getBomModificationNotes(@session_id,csa.build_id) <> '' THEN ' Bom Mod Notes: '+ dbo.vdsf_getBomModificationNotes(@session_id,csa.build_id)
						ELSE ''
					END
				) AS '@area_notes',
				(
					SELECT
						details.item_type AS '@item_type',
						details.item_id AS '@item_id',
						details.real_item_id AS '@item_number',
						details.uom_id AS '@uom_id',
						CASE
							WHEN details.price_type = 'area' THEN 1
							ELSE details.bill_qty
						END AS '@bill_qty',
						details.homeowner_price AS '@homeowner_price',
						details.alloc_qty AS '@alloc_qty',
						details.pattern_id AS '@pattern_id',
						details.credit_qty as '@credit_qty',
						pp.pattern_name AS '@pattern_name',
						(
							SELECT
								options.option_id AS '@option_id',
								options.option_value AS '@option_value',
								options.option_source AS '@option_source',
								options.included AS '@included',
								options.qty AS '@qty',
								options.alloc_qty AS '@alloc_qty',
								options.price AS '@price',
								options.price_retail AS '@price_retail',
								options.retail_percentage AS '@retail_percentage',
								options.price_type AS '@price_type',
								options.pricing_source AS '@pricing_source'
							FROM
								catalog_selections_area_detail_options options WITH (NOLOCK)
							WHERE
								options.session_id = details.session_id
								AND options.[application] = details.[application]
								AND options.product = details.product
								AND options.area = details.area
								AND options.sub_area = details.sub_area
								AND options.item_type = details.item_type
								AND options.item_id = details.item_id
							FOR XML PATH ('option'), ROOT ('options'), TYPE
						)
					FROM
						catalog_selections_area_details details WITH (NOLOCK)
						LEFT JOIN Veo_product_patterns pp WITH (NOLOCK) ON pp.pattern_id = details.pattern_id
					WHERE
						details.session_id = csa.session_id
						AND details.item_id NOT IN ('promo_credit','override_credit','incorrect_price_credit','credit','sold_at_contract_credit')
						AND details.[application] = csa.[application]
						AND details.product = csa.product
						AND details.area = csa.area
						AND details.sub_area = csa.sub_area
					FOR XML PATH ('item'), ROOT ('items'), TYPE
				),
				(
					SELECT
						line_no,
						pricing_source,
						price_type,
						item_type,
						item_id,
						item_class,
						item_description,
						selectable,
						real_item_id,
						real_item_description,
						bill_qty,
						alloc_qty,
						credit_qty,
						uom,
						builder_price,
						homeowner_price,
						force_reprice,
						retail_percentage,
						retail_percentage_type,
						(
							SELECT
								*
							FROM
								OPENJSON(options_json)
							WITH (
								option_id VARCHAR(25) '$.OptionID',
								option_value VARCHAR(100) '$.OptionValue',
								option_source VARCHAR(50) '$.OptionSource',
								included BIT '$.Included',
								qty INT '$.Qty',
								price DECIMAL(18,2) '$.Price',
								price_retail DECIMAL(18,2) '$.PriceRetail',
								price_type VARCHAR(25) '$.PriceType',
								pricing_source VARCHAR(50) '$.PricingSource',
								retail_percentage DECIMAL(18,2) '$.RetailPercentage',
								retail_percentage_type VARCHAR(50) '$.RetailPercentageType'
							)
							FOR XML RAW ('option'), ROOT ('options'), TYPE
						)
					FROM
						OPENJSON
						(
							(
							SELECT
								CAST(DECOMPRESS(serialized_bom_data) AS VARCHAR(MAX))
							FROM
								catalog_selections_price_level_boms WITH (NOLOCK)
							WHERE
								session_id = csa.session_id
								AND catalog_selections_row_id = csa.selected_field_group
							)
						)
						WITH 
						(
							line_no INT '$.LineNo',
							pricing_source VARCHAR(25) '$.PricingSource',
							price_type VARCHAR(50) '$.PriceType',
							item_type VARCHAR(50) '$.ItemType',
							item_id VARCHAR(50) '$.ItemID',
							item_class VARCHAR(50) '$.ItemClass',
							item_description VARCHAR(100) '$.ItemDescription',
							selectable BIT '$.Selectable',
							real_item_id VARCHAR(100) '$.RealItemID',
							real_item_description VARCHAR(200) '$.RealItemDescription',
							bill_qty DECIMAL(18,4) '$.BillQty',
							alloc_qty DECIMAL(18,4) '$.AllocQty',
							credit_qty DECIMAL(18,4) '$.CreditQty',
							uom VARCHAR(10) '$.UOM',
							builder_price DECIMAL(18,2) '$.BuilderPrice',
							homeowner_price DECIMAL(18,2) '$.HomeownerPrice',
							force_reprice BIT '$.ForceReprice',
							retail_percentage DECIMAL(18,2) '$.RetailPercentage',
							retail_percentage_type VARCHAR(50) '$.RetailPercentageType',
							options_json NVARCHAR(MAX) '$.Options' AS JSON
						)
					FOR XML RAW ('item'), ROOT ('original_items'), TYPE
				)
			FROM
				catalog_selections_areas csa WITH (NOLOCK)
				LEFT JOIN Veo_applications a WITH (NOLOCK) ON a.[name] = rtrim(ltrim(csa.[application]))
				LEFT JOIN Veo_products p WITH (NOLOCK) ON p.[name] = rtrim(ltrim(csa.product))
			WHERE 
				csa.session_id = cs.session_id
				AND csa.area_selected = 1
				AND csa.selected > 0
			FOR XML PATH ('area_group'), TYPE
		),
		(
			SELECT
				document_type AS 'image/@document_type',
				application_id AS 'image/@application_id',
				product_id AS 'image/@product_id',
				area_id AS 'image/@area_id',
				sub_area_id AS 'image/@sub_area_id',
				location_id AS 'image/@location_id',
				document_data AS 'image'
			FROM
				account_organization_user_profile_plan_catalog_sessions_documents docs WITH (NOLOCK)
			WHERE
				docs.session_id = cs.session_id
			FOR XML PATH ('images'), TYPE, BINARY BASE64
		)
	FROM
		account_organization_user_profile_plan_catalog_sessions cs WITH (NOLOCK)
		JOIN account_organization_user_profile_plan pp WITH (NOLOCK) ON
			pp.account_id = cs.account_id
			AND pp.organization_id = cs.organization_id
			AND pp.[user_id] = cs.[user_id]
			AND pp.community_name = cs.community_name
			AND pp.series = cs.series
			AND pp.plan_name = cs.plan_name
		JOIN VeoSolutionsSecurity_organizations o WITH (NOLOCK) ON o.organization_id = pp.organization_id
		JOIN VeoSolutionsSecurity_users u WITH (NOLOCK) ON u.[user_id] = pp.[user_id]
	WHERE
		cs.session_id = @session_id
	FOR XML PATH ('ConciergeSelectionSet'))
END
GO
PRINT N'Creating Procedure [dbo].[vds_setEncryptedPassword]...';


GO
CREATE PROCEDURE [dbo].[vds_setEncryptedPassword]
	@user_id UNIQUEIDENTIFIER,
	@password VARCHAR(MAX),
	@hash_provider NVARCHAR(100),
	@salt VARBINARY(MAX),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Create Date: 04/10/2018
	Description: Sets the encrypted password.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	UPDATE VeoSolutionsSecurity_users
	SET
		[password] = @password,
		salt = @salt,
		hash_provider = @hash_provider
	WHERE
		[user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_setEncryptedTemporaryPassword]...';


GO
CREATE PROCEDURE [dbo].[vds_setEncryptedTemporaryPassword]
	@user_id UNIQUEIDENTIFIER,
	@temporary_password VARCHAR(MAX),
	@hash_provider NVARCHAR(100),
	@salt VARBINARY(MAX),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Create Date: 04/10/2018
	Description: Sets the encrypted temporary password.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	UPDATE VeoSolutionsSecurity_users
	SET
		temporary_password = @temporary_password,
		salt = @salt,
		hash_provider = @hash_provider
	WHERE
		[user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_startUserSecuritySession]...';


GO
CREATE procedure [dbo].[vds_startUserSecuritySession]
@user_id UNIQUEIDENTIFIER
AS
/*
	Author: Robert Hobbs 
	Generates a security token, logs it and returns it 
*/

DECLARE @token UNIQUEIDENTIFIER
SET @token = NEWID()

IF EXISTS(SELECT [user_id] FROM VeoSolutionsSecurity_users WITH (NOLOCK) WHERE [user_id] = @user_id)
BEGIN

	-- INSERT THE TOKEN
	INSERT INTO VeoSolutionsSecurity_users_login_sessions ([user_id], security_token ) 
		SELECT @user_id, @token 

	-- CLEAN UP OLD TOKENS
	--if @@ROWCOUNT > 0
	--begin
	--	select @user_id = [USER_ID] from users where email = @email and [password] = @password
	--	delete users_login_sessions 
	--	where [user_id] = @user_id and [security_token] <> @id and create_date < DATEADD(DAY,-1000,GETDATE())
	--end
	---- BRING BACK THE USER RECORD
	--select [user_id], first_name, last_name, email, [image_data], @id as [security_token] from users 
	--	where [email] = @email and [password] = @password
		
	SELECT @token AS security_token 
	RETURN
END
ELSE
	BEGIN
		RAISERROR('User not found.',16,1)
		RETURN
	END
GO
PRINT N'Creating Procedure [dbo].[vds_updAccountOrganizationDocument]...';


GO
CREATE PROCEDURE [dbo].[vds_updAccountOrganizationDocument]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@doc_id UNIQUEIDENTIFIER,
	@application VARCHAR(100),
	@product VARCHAR(100),
	@description VARCHAR(255),
	@notes VARCHAR(255),
	@allow_inclusion_buyer_packet BIT,
	@security_token UNIQUEIDENTIFIER = null
AS
/*
	Author: Roger Wang
	Date: 2/2/2022
	Description: Updates a document under an account organization
*/
BEGIN
	DECLARE @edit_user_id VARCHAR(75)
	SET @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	IF (@edit_user_id IS NULL)
		BEGIN
			RAISERROR('Invalid credentials.',16,1)
			RETURN
		END

	UPDATE
		account_organization_documents
	SET 
		[application] = @application,
		[product] = @product,
		[description] = @description,
		[notes] = @notes,
		[allow_inclusion_buyer_packet] = @allow_inclusion_buyer_packet,
		[modifier] = @edit_user_id,
		[modified_date] = GETDATE()
	WHERE
		[account_id] = @account_id 
		and	[organization_id] = @organization_id 
		and [doc_id] = @doc_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updAccountOrganizationDocumentWithFile]...';


GO
CREATE PROCEDURE [dbo].[vds_updAccountOrganizationDocumentWithFile]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@doc_id UNIQUEIDENTIFIER,
	@application VARCHAR(100),
	@product VARCHAR(100),
	@description VARCHAR(255),
	@notes VARCHAR(255),
	@allow_inclusion_buyer_packet BIT,
	@size INT,
	@doc_data VARBINARY(MAX),
	@type VARCHAR(10),
	@security_token UNIQUEIDENTIFIER = null
AS
/*
	Author: Roger Wang
	Date: 8/17/2022
	Description: Updates a document with file content under an account organization
*/
BEGIN
	DECLARE @edit_user_id VARCHAR(75)
	SET @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	IF (@edit_user_id IS NULL)
		BEGIN
			RAISERROR('Invalid credentials.',16,1)
			RETURN
		END

	UPDATE
		account_organization_documents
	SET 
		[application] = @application,
		[product] = @product,
		[description] = @description,
		[notes] = @notes,
		[allow_inclusion_buyer_packet] = @allow_inclusion_buyer_packet,
		[doc_data] = @doc_data,
		[size] = @size,
		[type] = @type,
		[modifier] = @edit_user_id,
		[modified_date] = GETDATE()
	WHERE
		[account_id] = @account_id 
		and	[organization_id] = @organization_id 
		and [doc_id] = @doc_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updAccountOrganizationSupportEmail]...';


GO
CREATE PROCEDURE [dbo].[vds_updAccountOrganizationSupportEmail]
	@account_org_id UNIQUEIDENTIFIER,
	@problem_type_id INT,
	@email VARCHAR(100),
	@should_send_notifications BIT,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 5/16/2023
	Description: Updates a account organization support email by the passed in value.
*/
BEGIN
	-- Validate the security token
	DECLARE @edit_user_id VARCHAR(100)
	DECLARE @modified_date DATETIME

	SET @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	IF (@edit_user_id IS NULL)
		BEGIN
			RAISERROR('Invalid credentials.',16,1)
			RETURN
		END

	-- Make sure that it is a valid problem type
	IF (NOT EXISTS(SELECT TOP 1 * FROM [dbo].[problem_types] WHERE [type_id] = @problem_type_id))
	BEGIN
		RAISERROR('Invalid Problem Type ID.',16,1)
		RETURN
	END

	SET @modified_date = GETDATE()

	MERGE INTO
		[dbo].[account_organization_support_emails] AS TGT
	USING (
		SELECT @account_org_id AS account_org_id,
			@problem_type_id AS problem_type_id,
			@email AS email,
			@should_send_notifications AS should_send_notifications
	) AS SRC
	ON TGT.account_org_id = SRC.account_org_id AND TGT.problem_type_id = SRC.problem_type_id
	WHEN MATCHED AND (TGT.email <> SRC.email OR TGT.should_send_notifications <> SRC.should_send_notifications) THEN
		UPDATE SET
			TGT.email = SRC.email,
			TGT.should_send_notifications = SRC.should_send_notifications,
			TGT.modifier = @edit_user_id,
			TGT.modified_date = @modified_date
	WHEN NOT MATCHED THEN
		INSERT (account_org_id, problem_type_id, email, should_send_notifications, author, create_date, modifier, modified_date)
		VALUES (SRC.account_org_id, SRC.problem_type_id, SRC.email, SRC.should_send_notifications, @edit_user_id, @modified_date, @edit_user_id, @modified_date);
END
GO
PRINT N'Creating Procedure [dbo].[vds_updAccountOrganizationUser]...';


GO
CREATE PROCEDURE [dbo].[vds_updAccountOrganizationUser]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @user_id UNIQUEIDENTIFIER,
    @first_name VARCHAR(50),
    @last_name VARCHAR(50),
    @active BIT,
    @external_id VARCHAR(50),
    @is_designer BIT,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Saul Sanchez
    Create Date: 07/19/2016
    Description: Updates an account organization user record.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    DECLARE @active_user_email varchar(100)
    SET @active_user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

    DECLARE @today DATETIME = GETDATE()

    UPDATE
        VeoSolutionsSecurity_account_organization_users
    SET
        first_name = @first_name,
        last_name = @last_name,
        active = @active,
        external_id = @external_id,
        is_designer = @is_designer
    WHERE
        account_id = @account_id
        AND organization_id = @organization_id
        AND [user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updAccountOrganizationUserProfile]...';


GO
CREATE PROCEDURE [dbo].[vds_updAccountOrganizationUserProfile]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @user_id UNIQUEIDENTIFIER,
    @interest_rate DECIMAL(18,6),
    @loan_term DECIMAL(18,6),
    @enable_homebuyer_access BIT,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Saul Sanchez
    Create Date: 07/19/2016
    Description: Updates an account organization user profile record.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    DECLARE @active_user_email varchar(100)
    SET @active_user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

    DECLARE @today DATETIME = GETDATE()

    UPDATE
        account_organization_user_profile
    SET 
        interest_rate = @interest_rate,
        loan_term = @loan_term,
        enable_homebuyer_access = @enable_homebuyer_access,
        modifier = @active_user_email,
        modified_date = @today
    WHERE
        account_id = @account_id
        AND organization_id = @organization_id
        AND [user_id] = @user_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_updAccountOrganizationUserRole]...';


GO
-- ===============================================================
-- Author:		BK
-- Create date: 10/15/2021
-- Description:	This procedure updates an existing account organization user
--              role.
-- ===============================================================

CREATE PROCEDURE [dbo].[vds_updAccountOrganizationUserRole]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @user_id UNIQUEIDENTIFIER,
    @role_id UNIQUEIDENTIFIER,
    @security_token UNIQUEIDENTIFIER
AS
BEGIN
	DECLARE @edit_user_id VARCHAR(75)
	SET @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	IF (@edit_user_id IS NULL)
		BEGIN
			RAISERROR('Invalid credentials.',16,1)
			RETURN
		END

    UPDATE
        VeoSolutionsSecurity_account_organization_users_roles_legacy
    SET
        role_id = @role_id,
        modifier = @edit_user_id,
        modified_date = GETDATE()
    WHERE
        account_id = @account_id
        AND organization_id = @organization_id
        AND [user_id] = @user_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_updApplicationIcon]...';


GO
CREATE PROCEDURE [dbo].[vds_updApplicationIcon]
	@application nvarchar(100),
	@icon_id uniqueidentifier,
	@security_token uniqueidentifier
AS

/*
	Author: Art deHoyos
	Create Date: 12/06/2019
	Description: Upsert application icon
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

		UPDATE application_icon 
		SET icon_id = @icon_id 
		WHERE [application] = @application
		
		IF @@ROWCOUNT = 0
		BEGIN
			INSERT INTO application_icon ([application], icon_id) VALUES(@application, @icon_id)
		END
END
GO
PRINT N'Creating Procedure [dbo].[vds_update_icon]...';


GO
CREATE PROCEDURE [dbo].[vds_update_icon]
	@id UNIQUEIDENTIFIER,
	@name NVARCHAR(100),
	@image VARBINARY(MAX),
	@mime_type VARCHAR(255),
	@security_token UNIQUEIDENTIFIER
AS

/*
	Author: Eric Hickey
	Create Date: 11/04/2019
	Description: Updates an icon using the provided fields.  All fields must be provided, even if the data hasn't changed.  Id will not be updated.
*/

BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	-- Get the active user's email from the security token for auditing purposes
    DECLARE @active_user_email VARCHAR(100)
    SET @active_user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	UPDATE [dbo].[icon]
	SET
		[name] = @name,
		[image] = @image,
		[mime_type] = @mime_type,
		[modifier] = @active_user_email,
		[modified_date] = GETDATE()
	WHERE [id] = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updateBuildStatus]...';


GO
CREATE PROCEDURE [dbo].[vds_updateBuildStatus]
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
    @security_token UNIQUEIDENTIFIER
AS

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DECLARE 
		@application VARCHAR(100),
		@product VARCHAR(100), 
		@area VARCHAR(100),
		@sub_area VARCHAR(100)

	SELECT 
		@application = cas.[application],
		@product = cas.product,
		@area = cas.area,
		@sub_area = sub_area
	FROM 
		dbo.catalog_selections_areas cas WITH (NOLOCK)
	WHERE 
		cas.session_id = @session_id
		AND cas.build_id = @build_id


    --update selection status of build added 6/3/2014 ADG
	-- added check for pattern selected 6/6/14 ADG
    -- added check for accent prompts.  modified check for pattern 06/30/2014 SS.
	DECLARE
        @selectableBomCount int,
	    @selectedBomCount int,
        @selectablePatternCount int,
        @selectedPatternCount int,
        @selectableAccentPromptCount int,
        @selectedAccentPromptCount int,
        @selectedStatus int,
		@unPricedItems int

	SELECT
        @selectableBomCount = COUNT(*)
	FROM 
		dbo.catalog_selections_area_details WITH (NOLOCK)
	WHERE
		session_id = @session_id
		AND [application] = @application
		AND product = @product
		AND area = @area
		AND sub_area = @sub_area
		AND selectable = 1	

	SELECT
        @selectedBomCount = COUNT(*)
	FROM 
		dbo.catalog_selections_area_details WITH (NOLOCK)
	WHERE
		session_id = @session_id
		AND [application] = @application
		AND product = @product
		AND area = @area
		AND sub_area = @sub_area
		AND selectable = 1	
		AND real_item_id <> ''

    SELECT
        @selectablePatternCount = COUNT(*)
    FROM
        dbo.catalog_selections_areas csa WITH (NOLOCK)
        LEFT JOIN dbo.Veo_products p WITH (NOLOCK) ON p.name = csa.product
    WHERE
        csa.session_id = @session_id
        AND csa.build_id = @build_id
        AND ((p.product_id = '6')
             OR (p.product_id = '3'))

    SELECT
        @selectedPatternCount = COUNT(*)
    FROM
        dbo.catalog_selections_areas csa WITH (NOLOCK)
        left join dbo.Veo_products p WITH (NOLOCK) ON p.name = csa.product
    WHERE
        csa.session_id = @session_id
        AND csa.build_id = @build_id
        AND ((p.product_id = '6')
             OR (p.product_id = '3'))
        AND csa.pattern_id > 0

    SELECT
        @selectableAccentPromptCount = COUNT(*)
    FROM
        dbo.catalog_selections_area_details sad WITH (NOLOCK)
        LEFT JOIN dbo.Veo_colors vc WITH (NOLOCK) ON vc.part_no = sad.real_item_id
        LEFT JOIN dbo.Veo_styles vs WITH (NOLOCK) ON vs.product_id = vc.product_id AND vs.style_id = vc.style_id
    WHERE
        sad.session_id = @session_id
        AND sad.[application] = @application
        AND sad.product = @product
        AND sad.area = @area
        AND sad.sub_area = @sub_area
        AND sad.selectable = 1
        AND sad.real_item_id <> ''
        AND ((sad.bom_uom_id = 'deco')
             OR (sad.bom_uom_id = 'linft'))
        AND vs.ivt_uom = 'sqft'

    SELECT
        @selectedAccentPromptCount = COUNT(*)
    FROM
        dbo.catalog_selections_area_details sad WITH (NOLOCK)
        LEFT JOIN dbo.Veo_colors vc WITH (NOLOCK) ON vc.part_no = sad.real_item_id
        LEFT JOIN dbo.Veo_styles vs WITH (NOLOCK) ON vs.product_id = vc.product_id AND vs.style_id = vc.style_id
    WHERE
        sad.session_id = @session_id
        AND sad.[application] = @application
        AND sad.product = @product
        AND sad.area = @area
        AND sad.sub_area = @sub_area
        AND sad.selectable = 1
        AND sad.real_item_id <> ''
        AND ((sad.bom_uom_id = 'deco')
             OR (sad.bom_uom_id = 'linft'))
        AND vs.ivt_uom = 'sqft'
        AND sad.accent_prompt <> ''

    --added 7/16/14 ADG
    SELECT
        @unPricedItems = COUNT(*)
    FROM
        dbo.catalog_selections_area_details sad WITH (NOLOCK)
    WHERE
        sad.session_id = @session_id
        AND sad.[application] = @application
        AND sad.product = @product
        AND sad.area = @area
        AND sad.sub_area = @sub_area
		and sad.force_reprice =1
		and sad.priced = 0


print @unPricedItems

    SET @selectedStatus = 0

    IF (@selectableBomCount > 0)
    BEGIN
        IF (
			(@selectableBomCount = @selectedBomCount) AND 
		    (@selectablePatternCount = @selectedPatternCount) and 
			(@selectableAccentPromptCount = @selectedAccentPromptCount) 
			--and (@unPricedItems = 0)
			)
        BEGIN
            SET @selectedStatus = 2
        END
        ELSE
        BEGIN
            SET @selectedStatus = 1
        END
    END

print @selectedStatus

    IF NOT EXISTS (SELECT TOP 1
                       selected
                   FROM
                       dbo.catalog_selections_areas WITH (NOLOCK)
                   WHERE
                       session_id = @session_id
                       AND build_id = @build_id
                       AND selected = @selectedStatus )
    BEGIN

        DECLARE @active_user_email VARCHAR(100)
        SET @active_user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

        UPDATE catalog_selections_areas
        SET
            selected = @selectedStatus,
            modifier = @active_user_email,
            modified_date = GETDATE()
        WHERE
            session_id = @session_id
            AND build_id = @build_id
    END
GO
PRINT N'Creating Procedure [dbo].[vds_updatePriceLevelMakeStd]...';


GO
CREATE procedure [dbo].[vds_updatePriceLevelMakeStd]
	@session_id UNIQUEIDENTIFIER,
	@build_id int,
	@item_no varchar(50),
	@make_std bit,
	@security_token UNIQUEIDENTIFIER
AS

BEGIN

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	update catalog_selections
	set make_std = @make_std
	where session_id = @session_id 
		  and build_id = @build_id
		  and item_no = @item_no


END
GO
PRINT N'Creating Procedure [dbo].[vds_updBuild]...';


GO
CREATE PROCEDURE dbo.vds_updBuild
    @session_id UNIQUEIDENTIFIER,
    @application VARCHAR(100),
    @product VARCHAR(100), 
    @area VARCHAR(100),
    @sub_area VARCHAR(100),
    @selected INT,
    @notes VARCHAR(MAX),
    @selection_total DECIMAL(18,2),
    @selected_field_group UNIQUEIDENTIFIER,
    @pattern_id INT,
    @area_selected INT,
    @build_id INT,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 8/10/2015
    Description: Updates a given build record, in the catalog_selections_areas table.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Get the email address for the user associated with the security token passed in
    DECLARE @user_email VARCHAR(100) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

    -- Update the record with the passed in information
    UPDATE 
        dbo.catalog_selections_areas
    SET
        selected = @selected,
        notes = @notes,
        selection_total = @selection_total,
        selected_field_group = @selected_field_group,
        pattern_id = @pattern_id,
        area_selected = @area_selected,
        build_id = @build_id,
        modifier = @user_email,
        modified_date = GETDATE()
    WHERE
        session_id = @session_id
        AND [application] = @application
        AND product = @product
        AND area = @area
        AND sub_area = @sub_area
END
GO
PRINT N'Creating Procedure [dbo].[vds_updBuildBomModification]...';


GO
CREATE PROCEDURE [dbo].[vds_updBuildBomModification]
    @session_id UNIQUEIDENTIFIER,
    @build_id BIGINT,
    @session_bom_modification_id UNIQUEIDENTIFIER,
    @quantity DECIMAL(18,4),
    @price DECIMAL(18,2),
    @notes VARCHAR(MAX),
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 10/23/2015
    Description: Updates the specified build bom modification, if it exists. If it doesn't already exist
        in the specified session's build, a new bom modification record is created.
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Get the user that is making this change
    DECLARE @user_email VARCHAR(100)
    SET @user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

    IF (EXISTS(SELECT TOP 1 * FROM dbo.catalog_selections_area_bom_modifications WITH (NOLOCK) WHERE session_id = @session_id AND build_id = @build_id AND session_bom_modification_id = @session_bom_modification_id))
        BEGIN
            -- Update the record
            UPDATE 
                dbo.catalog_selections_area_bom_modifications
            SET 
                quantity = @quantity,
                price = @price,
                notes = @notes,
                modifier = @user_email,
                modified_date = GETDATE()
            WHERE
                session_id = @session_id
                AND build_id = @build_id
                AND session_bom_modification_id = @session_bom_modification_id
        END
    ELSE
        BEGIN
            INSERT INTO dbo.catalog_selections_area_bom_modifications
            (
                session_id,
                build_id,
                session_bom_modification_id,
                quantity,
                price,
                notes,
                author,
                create_date,
                modifier,
                modified_date
            )
            VALUES
            (
                @session_id,
                @build_id,
                @session_bom_modification_id,
                @quantity,
                @price,
                @notes,
                @user_email,
                GETDATE(),
                @user_email,
                GETDATE()
            )
        END
END
GO
PRINT N'Creating Procedure [dbo].[vds_updBuilderFeature]...';


GO
CREATE PROCEDURE [dbo].[vds_updBuilderFeature]
	@organization_id UNIQUEIDENTIFIER,
	@id INT,
	@value BIT,
	@security_token UNIQUEIDENTIFIER
AS
BEGIN
/*
	Author: Shelby Mansker
	Date: 8/4/2016
	Description: Updates a builder's feature by the passed in value.

	Modified: Roger Wang
	Date: 3/11/2022
	Description: Removed all functionality for synchronizing builder flags from organizations table
*/
	-- Validate the security token
	DECLARE @edit_user_id VARCHAR(100)
	DECLARE @modified_date DATETIME

	SET @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	IF (@edit_user_id IS NULL)
		BEGIN
			RAISERROR('Invalid credentials.',16,1)
			RETURN
		END
	
	IF NOT EXISTS(SELECT TOP 1 * FROM VeoSolutionsSecurity_organizations WHERE organization_id = @organization_id)
	BEGIN
		RAISERROR('Invalid Organization Id.',16,1)
		RETURN
	END

	-- Make sure that it is a valid feature
	IF (NOT EXISTS(SELECT TOP 1 * FROM dbo.features WHERE id = @id))
	BEGIN
		RAISERROR('Invalid Feature.',16,1)
		RETURN
	END
	
	-- Update the builder feature, or insert it if it doesn't already exist
	SET @modified_date = GETDATE()

	MERGE INTO dbo.builder_features tgt
	USING (
		VALUES (@organization_id, @id, @value, @edit_user_id, @modified_date)
	) AS src (organization_id, id, value, modifier, modified_date )
	ON src.organization_id = tgt.organization_id AND src.id = tgt.feature_id
	WHEN MATCHED AND tgt.value <> src.value THEN 
		UPDATE SET tgt.value = src.value , tgt.modifier = src.modifier, tgt.modified_date = src.modified_date
	WHEN NOT MATCHED THEN
		INSERT (organization_id, feature_id, [value], author, create_date, modifier ,modified_date) 
		VALUES (src.organization_id, src.id, src.[value], @edit_user_id, @modified_date, @edit_user_id, @modified_date);
END
GO
PRINT N'Creating Procedure [dbo].[vds_updBuildPriceLevel]...';


GO
CREATE PROCEDURE dbo.vds_updBuildPriceLevel
    @session_id UNIQUEIDENTIFIER,
    @row_id UNIQUEIDENTIFIER,
    @item_type VARCHAR(50),
    @item_no VARCHAR(100),
    @item VARCHAR(MAX),
    @price DECIMAL(18,2),
    @selected BIT,
    @make_std BIT,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 8/13/2015
    Description: Updates an existing price level. Price levels live in the catalog_selections
        table, sharing it with catalog items. However, only some of the columns are relevant
        to a price level. To find the price level, we use just the session_id and row_id to
        look it up.
*/    
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Get the user email from the security token
    DECLARE @user_email VARCHAR(100)
    SET @user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

    IF (EXISTS(SELECT TOP 1 * FROM dbo.catalog_selections WITH (NOLOCK) WHERE session_id = @session_id AND row_id = @row_id))
        BEGIN
            UPDATE dbo.catalog_selections
            SET
                item_type = @item_type,
                item_no = @item_no,
                item = @item,
                price = @price,
                selected = @selected,
                make_std = @make_std,
                modifier = @user_email,
                modified_date = GETDATE()
            WHERE
                session_id = @session_id
                AND row_id = @row_id
        END
END
GO
PRINT N'Creating Procedure [dbo].[vds_updBuildPriceLevelBom]...';


GO
CREATE PROCEDURE [dbo].[vds_updBuildPriceLevelBom]
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
	@item_no VARCHAR(100),
	@build_data VARBINARY(MAX),
	@security_token UNIQUEIDENTIFIER = NULL	
AS
/*
	Author: Shelby Mansker
	Create date: 5/20/2014
	Description: Saves the encoded bom, build data, for the specified build level.

	Updated 5/23/2014: Added this comment block AND reformatted the
	proc a little. Updated the security token validation code to be
	consistent with other procs. -Shelby
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Get the application, product, area, and sub area for the specified build
	DECLARE @application VARCHAR(50)
	DECLARE @product VARCHAR(50)
	DECLARE @area VARCHAR(100)
	DECLARE @sub_area VARCHAR(50)
	
	SELECT
		@application = [application],
		@product = product,
		@area = area,
		@sub_area = sub_area
	FROM
		dbo.catalog_selections_areas WITH (NOLOCK)
	WHERE
		session_id = @session_id
		AND build_id = @build_id

	-- Insert the build data into the correct build level
	UPDATE 
		dbo.catalog_selections
	SET
		build_data = @build_data
	WHERE
		session_id = @session_id
		AND [application] = @application
		AND product = @product
		AND area = @area
		AND sub_area = @sub_area
		AND item_no = @item_no
		AND [source] = 'Prices Landed'	
		
END
GO
PRINT N'Creating Procedure [dbo].[vds_updBuildPriceLevelPrice]...';


GO
CREATE PROCEDURE [dbo].[vds_updBuildPriceLevelPrice]
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
	@item_no VARCHAR(100),
	@price DECIMAL(18,2),
	@security_token UNIQUEIDENTIFIER = NULL
AS
/*
	Author:		Shelby Mansker
	Create date: 5/20/2014
	Description:	Updates the price for a specified price level in a build
	
	Updated 5/23/2014: Added this comment block AND reformatted the
	proc a little. Updated the security token validation code to be
	consistent with other procs. -Shelby
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Get the application, product, area, and sub area for the specified build
	DECLARE @application VARCHAR(50)
	DECLARE @product VARCHAR(50)
	DECLARE @area VARCHAR(100)
	DECLARE @sub_area VARCHAR(50)
	
	SELECT
		@application = [application],
		@product = product,
		@area = area,
		@sub_area = sub_area
	FROM
		dbo.catalog_selections_areas WITH (NOLOCK)
	WHERE
		session_id = @session_id
		AND build_id = @build_id

	-- Update the Price amount for the specified price level
	UPDATE
		dbo.catalog_selections
	SET
		price = @price
	WHERE
		session_id = @session_id
		AND [application] = @application
		AND product = @product
		AND area = @area
		AND sub_area = @sub_area
		AND item_no = @item_no
		AND [source] = 'Prices Landed'	
END
GO
PRINT N'Creating Procedure [dbo].[vds_updBuildProperty]...';


GO
CREATE PROCEDURE [dbo].[vds_updBuildProperty]
	@id UNIQUEIDENTIFIER,
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
	@key VARCHAR(50),
	@value VARCHAR(MAX),
	@security_token UNIQUEIDENTIFIER
/*
	Author: Shelby Mansker
	Date: 5/22/2017
	Description: Updates a build property
*/
AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END
	
    -- Get the email address for the user associated with the security token passed in
    DECLARE @user_email VARCHAR(100) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	UPDATE catalog_selections_area_properties
	SET 
		session_id = @session_id,
		build_id = @build_id,
		[key] = @key, 
		[value] = @value, 
		modifier = @user_email, 
		modified_date = GETDATE()
	WHERE 
		id = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updCatalogBuyerSignature]...';


GO
CREATE PROCEDURE [dbo].[vds_updCatalogBuyerSignature]
	@session_id UNIQUEIDENTIFIER,
	@signature varbinary(max),
	@security_token UNIQUEIDENTIFIER = NULL	
AS
/*
	Author: Robert Hobbs
	Create date: 6/24/2014
	Description: Saves the captured signature image for a buyer. 

*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	UPDATE 
		dbo.account_organization_user_profile_plan_catalog_sessions
	SET
		buyer_signature = @signature ,
		buyer_signature_date = getdate() 
	WHERE
		session_id = @session_id 

END
GO
PRINT N'Creating Procedure [dbo].[vds_updCatalogSelection]...';


GO
CREATE  procedure [dbo].[vds_updCatalogSelection]
	@security_token uniqueidentifier = null,
	@session_id uniqueidentifier,
	@row_id uniqueidentifier,
	@selected bit
AS
/*
	Author:		???
	Create date: ???
	Description:	???

	Updated 5/23/2014: Added this comment block AND reformatted the
	proc a little. Updated the security token validation code to be
	consistent with other procs. -Shelby

	Update: Shelby Mansker
	Date: 9/8/2017
	Description: Ensure that the modifier and modified_date fields are getting set properly.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DECLARE @user_email VARCHAR(100) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	UPDATE
		catalog_selections
	SET
		selected = @selected,
		modifier = @user_email,
		modified_date = GETDATE()
	WHERE
		session_id = @session_id
		AND row_id = @row_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updCatalogSelectionAreaDetailOption]...';


GO
CREATE PROCEDURE dbo.vds_updCatalogSelectionAreaDetailOption
    @session_id UNIQUEIDENTIFIER,
    @application VARCHAR(100),
    @product VARCHAR(100),
    @area VARCHAR(100),
    @sub_area VARCHAR(100),
    @item_type VARCHAR(20),
    @item_id VARCHAR(50),
    @option_id VARCHAR(50),
    @option_value VARCHAR(50),
    @option_source VARCHAR(50),
    @included BIT,
    @qty INT = NULL,
    @alloc_qty INT = NULL,
    @price DECIMAL(18,2) = NULL,
    @price_retail DECIMAL(18,2) = NULL,
    @retail_percentage DECIMAL(18,4) = NULL,
    @retail_percentage_type VARCHAR(10) = NULL,
    @price_type VARCHAR(10) = NULL,
    @pricing_source VARCHAR(50) = NULL,
    @error_message VARCHAR(50) = NULL,
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 9/16/2015
    Description: Updates the specified bom line option with the values passed in. If the option
        doesn't exist, it will create it instead.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Get the user email from the security token
    DECLARE @user_email VARCHAR(100)
    SET @user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

    IF (EXISTS(SELECT option_id FROM dbo.catalog_selections_area_detail_options WITH (NOLOCK) WHERE session_id = @session_id AND [application] = @application AND product = @product AND area = @area AND sub_area = @sub_area AND item_type = @item_type AND item_id = @item_id AND option_id = @option_id))
        BEGIN
            UPDATE dbo.catalog_selections_area_detail_options
            SET
                option_value = @option_value,
                option_source = @option_source,
                included = @included,
                qty = @qty,
                alloc_qty = @alloc_qty,
                price = @price,
                price_retail = @price_retail,
                retail_percentage = @retail_percentage,
                retail_percentage_type = @retail_percentage_type,
                price_type = @price_type,
                pricing_source = @pricing_source,
                [error_message] = @error_message
            WHERE 
                session_id = @session_id 
                AND [application] = @application 
                AND product = @product 
                AND area = @area 
                AND sub_area = @sub_area 
                AND item_type = @item_type 
                AND item_id = @item_id 
                AND option_id = @option_id
        END
    ELSE
        BEGIN
            INSERT INTO dbo.catalog_selections_area_detail_options
            (
                session_id,
                [application],
                product,
                area,
                sub_area,
                item_type,
                item_id,
                option_id,
                option_value,
                option_source,
                included,
                qty,
                alloc_qty,
                price,
                price_retail,
                retail_percentage,
                retail_percentage_type,
                price_type,
                pricing_source,
                [error_message]
            )
            VALUES
            (
                @session_id,
                @application,
                @product,
                @area,
                @sub_area,
                @item_type,
                @item_id,
                @option_id,
                @option_value,
                @option_source,
                @included,
                @qty,
                @alloc_qty,
                @price,
                @price_retail,
                @retail_percentage,
                @retail_percentage_type,
                @price_type,
                @pricing_source,
                @error_message
            )
        END
END
GO
PRINT N'Creating Procedure [dbo].[vds_updCatalogSelectionAreaNotes]...';


GO
create procedure vds_updCatalogSelectionAreaNotes
@session_id uniqueidentifier,
@build_id int,
@notes varchar(max),
@security_token UNIQUEIDENTIFIER = NULL	

as



--=====================================================================
-- Validate the security token.
--=====================================================================
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END



update catalog_selections_areas
set notes = @notes
where session_id = @session_id 
	and build_id = @build_id
GO
PRINT N'Creating Procedure [dbo].[vds_updCatalogSelectionAreaStatus]...';


GO


CREATE procedure [dbo].[vds_updCatalogSelectionAreaStatus]
@session_id uniqueidentifier,
@build_id int,
@status int,
@security_token uniqueidentifier = null
as

-- Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END

DECLARE @application VARCHAR(100) = ''
DECLARE @product VARCHAR(100) = ''
DECLARE @area VARCHAR(100) = ''
DECLARE @sub_area VARCHAR(100) = ''

SELECT
	@application = [application],
	@product = product,
	@area = area,
	@sub_area = sub_area
FROM
	dbo.catalog_selections_areas WITH (NOLOCK)
WHERE
	session_id = @session_id
	AND build_id = @build_id



if (exists(select session_id from catalog_selections_areas 
			WHERE
				[session_id] = @session_id
				and [application] = @application
				and [product] = @product
				and [area] = @area
				and [sub_area] = @sub_area))
begin				

	UPDATE
		[catalog_selections_areas]
	SET

		[selected] = @status
	WHERE
		[session_id] = @session_id
		and [application] = @application
		and [product] = @product
		and [area] = @area
		and [sub_area] = @sub_area
end
GO
PRINT N'Creating Procedure [dbo].[vds_updCatalogSelectionDetail]...';


GO
CREATE procedure [dbo].[vds_updCatalogSelectionDetail]
	@security_token UNIQUEIDENTIFIER = null,
	@session_id UNIQUEIDENTIFIER,
	@row_id UNIQUEIDENTIFIER,
	@quantity DECIMAL(18,4),
	@price DECIMAL(18,2),
	@notes VARCHAR(max)
AS
/*
	Author:		???
	Create date: ???
	Description:	???

	Updated 5/23/2014: Added this comment block AND reformatted the
	proc a little. Updated the security token validation code to be
	consistent with other procs. -Shelby

	Update: Shelby Mansker
	Date: 9/8/2017
	Description: Ensure that the modifier and modified_date fields are getting set properly.

	Author: Roger Wang
	Date: 1/21/2022
	Description: Tracks original price when overriding price.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DECLARE @user_email VARCHAR(100) = dbo.ef_getUserEmailFromSecurityToken(@security_token),
			@orig_price DECIMAL(18, 2)

	IF NOT EXISTS (
		SELECT 1
		FROM
			catalog_selections_price_overrides WITH (NOLOCK)
		WHERE
			session_id = @session_id
			AND row_id = @row_id
	)
	BEGIN
		SELECT
			@orig_price = price
		FROM
			catalog_selections WITH (NOLOCK)
		WHERE
			session_id = @session_id
			AND row_id = @row_id

		IF @orig_price <> @price
		BEGIN
			INSERT INTO
				catalog_selections_price_overrides (session_id, row_id, orig_price)
			VALUES
				(@session_id, @row_id, @orig_price)
		END
	END

	UPDATE catalog_selections
	SET
		qty = @quantity,
		price = @price,
		notes = @notes,
		modifier = @user_email,
		modified_date = GETDATE()
	WHERE
		session_id = @session_id
		AND row_id = @row_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updCatalogSelectionsAreaDetailsLayDirection]...';


GO
CREATE PROCEDURE [dbo].[vds_updCatalogSelectionsAreaDetailsLayDirection]
	@session_id UNIQUEIDENTIFIER,
	@application VARCHAR(100),
	@product VARCHAR(100),
	@area VARCHAR(100),
	@sub_area VARCHAR(100),
	@item_type VARCHAR(20),
	@item_id VARCHAR(50),
	@rotate_degree INT,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 3/28/2022
	Description: Updates lay direction degree for a bom line
*/
BEGIN
	declare @edit_user_id varchar(75)
	set @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	if (@edit_user_id is null)
		begin
			raiserror('Invalid credentials.',16,1)
			return
		end

	UPDATE
		[dbo].[catalog_selections_area_details_lay_directions]
	SET
		[rotate_degree] = @rotate_degree,
		[modifier] = @edit_user_id,
		[modified_date] = GETDATE()
	WHERE
		[session_id] = @session_id
		AND [application] = @application
		AND [product] = @product
		AND [area] = @area
		AND [sub_area] = @sub_area
		AND [item_type] = @item_type
		AND [item_id] = @item_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updCatalogSelectionsAreasSelectedStatus]...';


GO
CREATE PROCEDURE [dbo].[vds_updCatalogSelectionsAreasSelectedStatus]
	@session_id UNIQUEIDENTIFIER,
	@build_id INT = 0,
	@application VARCHAR(100) = '',
	@product VARCHAR(100) = '',
	@area VARCHAR(100) = '',
	@sub_area VARCHAR(100) = '',
	@security_token UNIQUEIDENTIFIER = NULL	
AS
/*
	Author:		???
	Create date: ???
	Description:	???

	Updated 5/23/2014: Added this comment block AND reformatted the
	proc a little. Updated the security token validation code to be
	consistent with other procs. -Shelby
*/
BEGIN
--=====================================================================
-- Validate the security token.
--=====================================================================
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	--=====================================================================
	-- Validate the parameter values.  The calling program can either pass
	-- in the build_id, or the application, product, area, and sub_area.
	--=====================================================================
	DECLARE @hold_application VARCHAR(100) = ''
	DECLARE @hold_product VARCHAR(100) = ''
	DECLARE @hold_area VARCHAR(100) = ''
	DECLARE @hold_sub_area VARCHAR(100) = ''
	DECLARE @hold_selected_status INT = 0

	IF @build_id > 0
		BEGIN
			IF EXISTS ( SELECT TOP 1
							session_id
						FROM
							dbo.catalog_selections_areas WITH (NOLOCK)
						WHERE
							session_id = @session_id
							AND build_id = @build_id )
				BEGIN
					SELECT
						@hold_application = [application],
						@hold_product = product,
						@hold_area = area,
						@hold_sub_area = sub_area,
						@hold_selected_status = selected
					FROM
						dbo.catalog_selections_areas WITH (NOLOCK)
					WHERE
						session_id = @session_id
						AND build_id = @build_id
				END
			ELSE
				BEGIN
					RAISERROR('Invalid session requested for update', 16, 1)
				END
		END
	ELSE
		BEGIN
			IF EXISTS ( SELECT TOP 1
							session_id
						FROM
							dbo.catalog_selections_areas WITH (NOLOCK)
						WHERE
							session_id = @session_id
							AND [application] = @application
							AND product = @product
							AND area = @area
							AND sub_area = @sub_area )
				BEGIN
					SELECT
						@hold_application = [application],
						@hold_product = product,
						@hold_area = area,
						@hold_sub_area = sub_area,
						@hold_selected_status = selected
					FROM
						dbo.catalog_selections_areas WITH (NOLOCK)
					WHERE
						session_id = @session_id
						AND [application] = @application
						AND product = @product
						AND area = @area
						AND sub_area = @sub_area
				END
			ELSE
				BEGIN
					RAISERROR('Invalid session requested for update', 16, 1)
				END
		END

	--=====================================================================
	-- Get the total number of selectable details, and the number of
	-- selected details.
	--=====================================================================
	DECLARE @selectable_detail_total INT
	DECLARE @selected_detail_count INT

	SELECT
		@selectable_detail_total = COUNT(session_id)
	FROM
		dbo.catalog_selections_area_details WITH (NOLOCK)
	WHERE
		session_id = @session_id
		AND [application] = @hold_application
		AND product = @hold_product
		AND area = @hold_area
		AND sub_area = @hold_sub_area
		AND selectable = 1

	SELECT
		@selected_detail_count = COUNT(session_id)
	FROM
		dbo.catalog_selections_area_details WITH (NOLOCK)
	WHERE
		session_id = @session_id
		AND [application] = @hold_application
		AND product = @hold_product
		AND area = @hold_area
		AND sub_area = @hold_sub_area
		AND selectable = 1
		AND LEN(real_item_id) > 0

	--=====================================================================
	-- Determine what the selected status should be.
	-- Update the selected status in the catalog_selections_areas table
	-- only if the selected status has changed.
	--=====================================================================
	DECLARE @new_selected_status INT = 0

	IF @selectable_detail_total > 0
		BEGIN
			IF @selected_detail_count = @selectable_detail_total
				BEGIN
					SET @new_selected_status = 2
				END
			ELSE
				BEGIN
					SET @new_selected_status = 1
				END
		END

    --added pricing check 7/16/14 ADG
	declare @unPricedItems int
    SELECT
        @unPricedItems = COUNT(*)
    FROM
        dbo.catalog_selections_area_details sad WITH (NOLOCK)
		INNER JOIN dbo.account_organization_user_profile_plan_catalog_sessions s WITH (NOLOCK) ON s.session_id = sad.session_id
    WHERE
        sad.session_id = @session_id
        AND sad.[application] = @hold_application
        AND sad.product = @hold_product
        AND sad.area = @hold_area
        AND sad.sub_area = @hold_sub_area
		and (sad.pattern_id > 0 or sad.force_reprice = 1 or s.builder_markup_hb_pricing = 1) 
		and sad.item_id <> 'credit'
		and sad.price_source != 'manual'
		and sad.priced = 0
    print @unPricedItems
	if @unPricedItems > 0
		set @new_selected_status = 1


	IF @new_selected_status <> @hold_selected_status
		BEGIN
			UPDATE
				dbo.catalog_selections_areas
			SET
				selected = @new_selected_status
			WHERE
				session_id = @session_id
				AND [application] = @hold_application
				AND product = @hold_product
				AND area = @hold_area
				AND sub_area = @hold_sub_area
		END
END
GO
PRINT N'Creating Procedure [dbo].[vds_updDefaultSupportEmail]...';


GO
CREATE PROCEDURE [dbo].[vds_updDefaultSupportEmail]
	@email_key VARCHAR(50),
	@email VARCHAR(200),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 5/16/2023
	Description: Updates a default support email by the passed in value.
*/
BEGIN
	-- Validate the security token
	DECLARE @edit_user_id VARCHAR(100)
	DECLARE @modified_date DATETIME

	SET @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	IF (@edit_user_id IS NULL)
		BEGIN
			RAISERROR('Invalid credentials.',16,1)
			RETURN
		END

	-- Make sure that it is a valid default support email
	IF (NOT EXISTS(SELECT TOP 1 * FROM [dbo].[default_support_emails] WHERE email_key = @email_key))
	BEGIN
		RAISERROR('Invalid Email Key.',16,1)
		RETURN
	END

	SET @modified_date = GETDATE()

	UPDATE
		[dbo].[default_support_emails]
	SET
		[email] = @email,
		[modifier] = @edit_user_id,
		[modified_date] = @modified_date
	WHERE
		email_key = @email_key
END
GO
PRINT N'Creating Procedure [dbo].[vds_updEditUserProfileInfo]...';


GO
CREATE PROCEDURE [dbo].[vds_updEditUserProfileInfo]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @user_id UNIQUEIDENTIFIER,
    @first_name VARCHAR(25),
    @last_name VARCHAR(25),
    @email VARCHAR(100),
    @interest_rate DECIMAL(18,6),
    @loan_term DECIMAL(18,6),
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author:      Saul Sanchez
    Created:     10/03/2014
    Description: This stored procedure updates user information for the
                 Edit User Profile screen in VEO Design Studio.

    Modified: 11/25/2014 by Shelby Mansker
              Added check to see if the profile exists. If it doesn't, the proc performs an insert 
              rather than an update.

    Modified: 4/6/2015 by Shelby Mansker
              Removed enable_homebuyer_access flag from the parameters and the update/insert calls. It is no longer used.

    Modified: 10/15/2015 by Saul Sanchez
              Set the modifier and modified date when updating records.
*/
BEGIN
    -- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Get the email of the logged in user.
    DECLARE @current_user_email VARCHAR(100) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

    -- Since we are updating two tables in the same update process, begin a transaction.
    BEGIN TRANSACTION

    -- Update the first name, last name, and email in the users table.
    UPDATE VeoSolutionsSecurity_users
    SET
        first_name = @first_name,
        last_name = @last_name,
        email = @email,
        modifier = @current_user_email,
        modified_date = GETDATE()
    WHERE
        [user_id] = @user_id

    IF @@ROWCOUNT = 0
    BEGIN
        ROLLBACK TRANSACTION
        RETURN
    END

    -- Update the first name and last name in the account organization users table.
    -- Update the first name and last name across all accounts and organizations for this user.
    UPDATE VeoSolutionsSecurity_account_organization_users
    SET
        first_name = @first_name,
        last_name = @last_name,
        modifier = @current_user_email,
        modified_date = GETDATE()
    WHERE
        [user_id] = @user_id

    IF @@ROWCOUNT = 0
    BEGIN
        ROLLBACK TRANSACTION
        RETURN
    END

    --It is possible for the profile to not exist at this point. If it doesn't insert it rather than updating it
    IF (NOT EXISTS(SELECT * FROM dbo.account_organization_user_profile WITH (NOLOCK) WHERE account_id = @account_id AND organization_id = @organization_id AND [user_id] = @user_id))
        BEGIN
            -- Insert the user's profile
            INSERT INTO dbo.account_organization_user_profile
                (account_id, organization_id, [user_id], interest_rate, loan_term)
            VALUES
                (@account_id, @organization_id, @user_id, @interest_rate, @loan_term)
        END
        ELSE
        BEGIN
            -- Update the interest rate, loan term, and enable homebuyer access flag in the account organization user profile table.
            UPDATE account_organization_user_profile
            SET
                interest_rate = @interest_rate,
                loan_term = @loan_term
            WHERE
                account_id = @account_id
                AND organization_id = @organization_id
                AND [user_id] = @user_id
        END

    IF @@ROWCOUNT = 0
    BEGIN
        ROLLBACK TRANSACTION
        RETURN
    END

    COMMIT TRANSACTION

END
GO
PRINT N'Creating Procedure [dbo].[vds_updFeature]...';


GO
CREATE PROCEDURE [dbo].[vds_updFeature]
	@id INT,
	@lookup_key VARCHAR(50),
	@name VARCHAR(200),
	@description VARCHAR(3000),
	@group_name VARCHAR(50),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Roger Wang
	Date: 4/28/2023
	Description: Updates a feature by the passed in value.
*/
BEGIN
	-- Validate the security token
	DECLARE @edit_user_id VARCHAR(100)
	DECLARE @modified_date DATETIME

	SET @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
	IF (@edit_user_id IS NULL)
		BEGIN
			RAISERROR('Invalid credentials.',16,1)
			RETURN
		END

	-- Make sure that it is a valid feature
	IF (NOT EXISTS(SELECT TOP 1 * FROM dbo.features WHERE id = @id))
	BEGIN
		RAISERROR('Invalid Feature.',16,1)
		RETURN
	END

	SET @modified_date = GETDATE()

	UPDATE
		features
	SET
		[lookup_key] = @lookup_key,
		[name] = @name,
		[description] = @description,
		[group_name] = @group_name,
		[modifier] = @edit_user_id,
		[modified_date] = @modified_date
	WHERE
		id = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updFloorplan]...';


GO
CREATE PROCEDURE [dbo].[vds_updFloorplan]
	@id UNIQUEIDENTIFIER,
	@name VARCHAR(100),
	@data VARCHAR(MAX) = NULL,
	@report_image VARBINARY(MAX) = NULL,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Crate Date: 10/26/2017
	Description: Updates a floorplan record.

	Modifier: Saul Sanchez
	Modified Date: 12/14/2017
	Description: Pass in and save the report image.
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	UPDATE [dbo].[floorplans]
	SET
		[name] = @name,
		[serialized_data] = @data,
		[report_image] = @report_image
	WHERE
		[id] = @id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updHomebuyerCatalogNonestimatedSelection]...';


GO
CREATE PROCEDURE [dbo].[vds_updHomebuyerCatalogNonestimatedSelection]
	@session_id UNIQUEIDENTIFIER,
	@row_id UNIQUEIDENTIFIER,
	@quantity INTEGER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Reid Wilson
	Date: 8/12/2022
	Description: Update (the quantity of) a homebuyer's non-estimated selection
*/
BEGIN

	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DECLARE @user_email VARCHAR(100)
	SET @user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	IF (EXISTS(SELECT TOP(1) * FROM homebuyer_catalog_nonestimated_selections WHERE session_id = @session_id AND row_id = @row_id))
	BEGIN
		UPDATE homebuyer_catalog_nonestimated_selections
		SET
			quantity = @quantity,
			modifier = @user_email,
			modified_date = GETDATE()
		WHERE
			session_id = @session_id
			AND row_id = @row_id
	END
END
GO
PRINT N'Creating Procedure [dbo].[vds_updHomebuyerOrientation]...';


GO
CREATE PROCEDURE [dbo].[vds_updHomebuyerOrientation]
	@row_id UNIQUEIDENTIFIER = NULL, 
	@user_id UNIQUEIDENTIFIER, 
	@object_type NVARCHAR(100), 
	@schema_version NVARCHAR(10), 
	@object_data NVARCHAR(MAX) ,
	@security_token UNIQUEIDENTIFIER 
AS
/*
   Author:		Robert Hobbs
   Create date: 04/09/18
   Description:	Updates/Inserts homebuyer orientation data. The data in @object_data 
   is JSON data, and it's meta data is @object_type and version in @schema_version. 
 */
BEGIN

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	 -- Get the email address for the user associated with the security token passed in
    DECLARE @user_email VARCHAR(100) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	DELETE FROM homebuyer_orientation WHERE 
		user_id = @user_id
		AND object_type = @object_type 
		AND schema_version = @schema_version 

	INSERT INTO homebuyer_orientation
		([user_id], object_type, schema_version, object_data, author, create_date, modifier, modified_date)
	VALUES 
		( @user_id, 
		@object_type, 
		@schema_version, 
		@object_data, 
		@user_email, 
		GETDATE(), 
		@user_email,
        GETDATE()) 

END
GO
PRINT N'Creating Procedure [dbo].[vds_updPriceLevelBom]...';


GO
CREATE PROCEDURE dbo.vds_updPriceLevelBom
	@session_id UNIQUEIDENTIFIER,
	@catalog_selections_row_id UNIQUEIDENTIFIER,
	@serialized_bom_data VARBINARY(MAX),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 1/8/2016
	Description: Updates the serialized bom data for the specified
		session and price level. If the record doesn't exist yet,
		it will insert it instead.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Get the active user's email from the security token
    DECLARE @active_user_email VARCHAR(100)
    SET @active_user_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	IF (EXISTS(SELECT TOP 1 * FROM dbo.catalog_selections_price_level_boms WITH (NOLOCK) WHERE session_id = @session_id AND catalog_selections_row_id = @catalog_selections_row_id))
	BEGIN
		UPDATE
			dbo.catalog_selections_price_level_boms
		SET
			serialized_bom_data = @serialized_bom_data,
			modifier = @active_user_email,
			modified_date = GETDATE()
		WHERE
			session_id = @session_id
			AND catalog_selections_row_id = @catalog_selections_row_id
	END
	ELSE
	BEGIN
		INSERT INTO
			dbo.catalog_selections_price_level_boms
		(
			session_id,
			catalog_selections_row_id,
			serialized_bom_data,
			author,
			create_date,
			modifier,
			modified_date
		)
		VALUES
		(
			@session_id,
			@catalog_selections_row_id,
			@serialized_bom_data,
			@active_user_email,
			GETDATE(),
			@active_user_email,
			GETDATE()
		)
	END
END
GO
PRINT N'Creating Procedure [dbo].[vds_updPrimaryPlanCatalog]...';


GO
CREATE PROCEDURE [dbo].[vds_updPrimaryPlanCatalog]
	@session_id uniqueidentifier,
	@profile_plan_id uniqueidentifier,
	@modifier varchar(50),
	@first_visit_to_dmh bit,
	@security_token uniqueidentifier
AS
	/*
	Author: Nirav Rana
	Date: 2/22/2022
	Description: Update Primary_Plan_Catalog table
*/

BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	-- Validate the profile plan
	IF (NOT EXISTS(SELECT TOP(1) * FROM primary_plan_catalogs  WHERE profile_plan_id = @profile_plan_id))
	BEGIN
		RAISERROR('The specified profile plan does not exist',16,1)
		RETURN
	END

	-- Update the first_visit_to_dmh
	UPDATE primary_plan_catalogs 
	SET
		session_id = @session_id, 
		profile_plan_id = @profile_plan_id, 
		modifier = @modifier, 
		modified_date = GETDATE(),
		first_visit_to_dmh = @first_visit_to_dmh
	WHERE
		profile_plan_id = @profile_plan_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updProfilePlanChangePlan]...';


GO
CREATE PROCEDURE [dbo].[vds_updProfilePlanChangePlan]
	@profile_id UNIQUEIDENTIFIER,
	@plan_id UNIQUEIDENTIFIER,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Create Date: 9/27/2019
	Description: Attempts to change an existing profile plan's plan. 
		If there are existing sessions, in the profile plan, this can't
		be done. This work should ultimately be replaced once we clean up
		profile plan stuff.

	Modifier: Roger Wang
	Modified Date: 6/13/2023
	Description: Added a check to make sure the new Address Specific Variation is not already
		being used in another profile plan.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DECLARE @account_id UNIQUEIDENTIFIER = NULL;
	DECLARE @organization_id UNIQUEIDENTIFIER = NULL;
	DECLARE @user_id UNIQUEIDENTIFIER = NULL;
	DECLARE @community VARCHAR(50) = NULL;
	DECLARE @series VARCHAR(50) = NULL;
	DECLARE @plan VARCHAR(50) = NULL;

	-- Get information about the profile plan, so we can look for related sessions
	SELECT
		@account_id = account_id,
		@organization_id = organization_id,
		@user_id = [user_id],
		@community = community_name,
		@series = series,
		@plan = plan_name
	FROM
		account_organization_user_profile_plan
	WHERE
		profile_id = @profile_id

	-- Validate plan
	IF (NOT EXISTS(SELECT TOP(1) * FROM VeoSolutionsSecurity_account_organization_plans WHERE account_id = @account_id AND organization_id = @organization_id AND plan_id = @plan_id))
	BEGIN
		RAISERROR('The specified plan does not exist',16,1)
		RETURN
	END

	-- Verify that there are no Sessions created for the profile plan
	IF (EXISTS (SELECT TOP(1) * FROM account_organization_user_profile_plan_catalog_sessions WHERE account_id = @account_id AND organization_id = @organization_id AND [user_id] = @user_id AND community_name = @community AND series = @series AND plan_name = @plan))
	BEGIN
		RAISERROR('Changing a plan is not allowed when there are Sessions created for it.',16,1)
		RETURN
	END

	-- Fetch the address specific plan name
	DECLARE @plan_name VARCHAR(50);

	SELECT
		@plan_name = [name]
	FROM
		VeoSolutionsSecurity_account_organization_plans
	WHERE
		account_id = @account_id 
		AND organization_id = @organization_id 
		AND plan_id = @plan_id

	IF EXISTS (
		SELECT TOP(1)
			*
		FROM
			account_organization_user_profile_plan
		WHERE account_id = @account_id
			AND organization_id = @organization_id
			AND user_id = @user_id
			AND community_name = @community
			AND series = @series
			AND [plan_name] = @plan_name
	)
	BEGIN
		RAISERROR('The specified Address Specific Variation ''%s'' is already being used in another Profile Plan.', 16, 1, @plan_name)
		RETURN
	END

	-- Update the profile plan
	UPDATE account_organization_user_profile_plan
	SET
		plan_name = @plan_name
	WHERE
		profile_id = @profile_id
		
END
GO
PRINT N'Creating Procedure [dbo].[vds_updProfilePlanExpirationDate]...';


GO
CREATE PROCEDURE [dbo].[vds_updProfilePlanExpirationDate]
	@profile_id UNIQUEIDENTIFIER,
	@expiration_date DATETIME,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Create Date: 3/24/2020
	Description: Attempts to upddate the expiration date of a profile plan.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Validate the profile plan
	IF (NOT EXISTS(SELECT TOP(1) * FROM account_organization_user_profile_plan WHERE profile_id = @profile_id))
	BEGIN
		RAISERROR('The specified profile plan does not exist',16,1)
		RETURN
	END

	-- Update the expiration date
	UPDATE account_organization_user_profile_plan
	SET
		expiration_date = @expiration_date
	WHERE
		profile_id = @profile_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updProfilePlanStatus]...';


GO
CREATE PROCEDURE [dbo].[vds_updProfilePlanStatus]
	@profile_id UNIQUEIDENTIFIER,
	@status VARCHAR(15),
	@previous_status VARCHAR(15),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Chris Ragon
	Create Date: 1/28/2020
	Description: Attempts to set the status of a profile plan.

	Modified: Chris Ragon
	Date: 2/25/2020
	Description: update proc to set previous_status when status changes
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Validate profile plan
	IF (NOT EXISTS(SELECT TOP(1) * FROM account_organization_user_profile_plan WHERE profile_id = @profile_id))
	BEGIN
		RAISERROR('The specified profile plan does not exist',16,1)
		RETURN
	END

	-- Update the profile plan
	UPDATE account_organization_user_profile_plan
	SET
		status = @status,
		previous_status = @previous_status
	WHERE
		profile_id = @profile_id
		
END
GO
PRINT N'Creating Procedure [dbo].[vds_updResolveSupportLog]...';


GO

CREATE procedure [dbo].[vds_updResolveSupportLog]
@security_token uniqueidentifier,
@entry_id int,
@problem_source int,
@problem_status bit,
@problem_resolution int = 0,
@resolution_date datetime = null,
@notes varchar(max)
as

-- Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)		
	RETURN
END

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)



update support_log 
	set problem_source = @problem_source,
	problem_status = @problem_status,
	problem_resolution = @problem_resolution,
	resolution_date = @resolution_date,
    resolved_by = @active_user_id,
	notes = @notes,
	modifier = @active_user_id,
	modified_date = getdate()

where entry_id = @entry_id
GO
PRINT N'Creating Procedure [dbo].[vds_updSchedulingAppointmentsConfirmationStatus]...';


GO
CREATE PROCEDURE [dbo].[vds_updSchedulingAppointmentsConfirmationStatus]
@appointment_id UNIQUEIDENTIFIER,
@confirmation_status INT
AS
/* confirmation status values
	-1 = default,
	 1 = confirmed
	 2 = reschedule
	 3 = pending
	 4 = not-optedin
*/
BEGIN
    UPDATE
		scheduling_appointments  
    SET
		confirmation_status= @confirmation_status
    WHERE [appointment_id] = @appointment_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updSelectedBuildPriceLevel]...';


GO
CREATE PROCEDURE [dbo].[vds_updSelectedBuildPriceLevel] 
	@session_id UNIQUEIDENTIFIER,
	@build_id INT,
	@item_no VARCHAR(100) = NULL,
	@selected_field_group_id UNIQUEIDENTIFIER = NULL,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:		Shelby Mansker
	Create date: 5/1/2014
	Description:	updates the price level specified by setting the 
	selected property to 1. It also deselects any previously 
	selected price levels.

	Updated 5/6/2014 - Original version was using an incorrect method
	of tracking selection. Proc has been modified to set the selected
	price level's row_id into the build's selected_field_group column. - Shelby

	Updated 5/20/2014 - Passing in a null item_no will clear the selection - Shelby

	Updated 5/23/2014: Added this comment block AND reformatted the
	proc a little. Updated the security token validation code to be
	consistent with other procs. -Shelby

	Updated 5/29/2014: Clear selection for same Application/Area/Sub-Area when setting level to an estiamted area - Scott
	Updated 5/29/2014: Added optional parameter for selected Field Group ID if it is passed it, avoid call out to look it up -Scott
    Updated 06/09/2014: Also clear the pattern id when clearing the selection for the same Application/Area/SubArea - Saul
    Updated 06/10/2014: Moved deleting of area details and resetting of area values to other proc. Saul.
    Updated 03/27/2015: Removed NULL default setting for @security_token parameter.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Get the application, product, area, and sub area for the specified build
	DECLARE @application VARCHAR(50)
	DECLARE @product VARCHAR(50)
	DECLARE @area VARCHAR(100)
	DECLARE @sub_area VARCHAR(50)
	
	SELECT
		@application = [application],
		@product = product,
		@area = area,
		@sub_area = sub_area
	FROM
		dbo.catalog_selections_areas WITH (NOLOCK)
	WHERE
		session_id = @session_id
		AND build_id = @build_id

	-- initialize the selected field group to an empty GUID
	DECLARE @selected_field_group UNIQUEIDENTIFIER = '00000000-0000-0000-0000-000000000000'

	IF (@selected_field_group_id IS NOT NULL)
	BEGIN
		SET @selected_field_group = @selected_field_group_id
	END
	ELSE
	BEGIN
		-- if the item_no passed in is not null, find the specified price level and store its row_id
		IF (@item_no IS NOT NULL)
		BEGIN
			SELECT
				@selected_field_group = row_id 
			FROM
				dbo.catalog_selections WITH (NOLOCK)
			WHERE
				session_id = @session_id
				AND [application] = @application
				AND product = @product
				AND area = @area
				AND sub_area = @sub_area
				AND item_no = @item_no
				AND [source] = 'Prices Landed'	

		END
	END

	--Now update the build's selected_field_group field
	UPDATE
		dbo.catalog_selections_areas
	SET
		selected_field_group = @selected_field_group
	WHERE
		session_id = @session_id
		AND build_id = @build_id			
END
GO
PRINT N'Creating Procedure [dbo].[vds_updSession]...';


GO
CREATE PROCEDURE dbo.vds_updSession
    @session_id UNIQUEIDENTIFIER,
	@status INT,
	@status_change_reason VARCHAR(MAX) = NULL,
	@session_notes VARCHAR(MAX),
	@precon_notes VARCHAR(250),
	@deposit DECIMAL(18,2),
	@deposit_notes VARCHAR(255),
	@designer_id UNIQUEIDENTIFIER,
	@designer VARCHAR(50),
	@show_report BIT,
    @completed_date DATETIME,
	@first_completed_date DATETIME,
    @export_date DATETIME,
    @address_id INT,
	@rounding_type INT,
	@rounding_places INT,
	@builder_markup_hb_pricing BIT,
	@modifier VARCHAR(MAX),
    @security_token UNIQUEIDENTIFIER,
	@catalog_source VARCHAR(100)
AS
/*
	Author: Shelby Mansker
	Date: 1/15/2016
	Description: This method will update the specified session with the field values passed. Not all fields
		are updatable in the session record.

	Modified: Shelby Mansker
	Date: 8/9/2018
	Description: Added the optional status_change_reason field

	Modified: Art deHoyos
	Date: 10/9/2018
	Description: Added show_report field.

	Modified: Daniel Arwe
	Date: 8/18/2025
	Description: Added precon_notes field to update.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	DECLARE @active_user_email VARCHAR(50) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

    IF (NOT EXISTS(SELECT * FROM account_organization_user_profile_plan_catalog_sessions WHERE session_id = @session_id))
    BEGIN
        DECLARE @error_msg VARCHAR(MAX) = 'Update Failed. The Session ' + CAST(@session_id AS VARCHAR(36)) + ' does not exist.'
		RAISERROR(@error_msg,16,1)
		RETURN
	END

	UPDATE account_organization_user_profile_plan_catalog_sessions
	SET
		[status] = @status,
		status_change_reason = @status_change_reason,
		session_notes = @session_notes,
		precon_notes = @precon_notes,
		deposit = @deposit,
		deposit_notes = @deposit_notes,
		designer_id = @designer_id,
		designer = @designer,
		show_report = @show_report,
		completed_date = @completed_date,
		first_completed_date = @first_completed_date,
		export_date = @export_date,
		address_id = @address_id,
		rounding_type = @rounding_type,
		rounding_places = @rounding_places,
		builder_markup_hb_pricing = @builder_markup_hb_pricing,
		modifier = @modifier,
		catalog_source = @catalog_source
	WHERE
		session_id = @session_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updSessionChange]...';


GO
CREATE PROCEDURE [dbo].[vds_updSessionChange]
	@change_id UNIQUEIDENTIFIER = NULL,
	@session_id UNIQUEIDENTIFIER, 
	@change_version NVARCHAR(10), 
	@change_data NVARCHAR(MAX) ,
	@security_token UNIQUEIDENTIFIER 
AS
/*
   Author:		Robert Hobbs
   Create date: 04/08/19
   Description:	Updates/Inserts session change data. 
   The data in @@change_data is JSON serialized data.
   The object version is @change_version. 
 */
BEGIN

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	 -- Get the email address for the user associated with the security token passed in
    DECLARE @user_email VARCHAR(100) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	IF (@change_id IS NOT NULL) AND EXISTS (SELECT change_id FROM session_changes WHERE change_id = @change_id) 
	BEGIN

		UPDATE 
			session_changes 
		SET
			change_version = @change_version, 
			change_data = @change_data,
			modifier = @user_email, 
			modified_date = GETDATE() 
		WHERE
			change_id = @change_id 
	END 
	ELSE
	BEGIN 
		DECLARE @new_change_id UNIQUEIDENTIFIER = COALESCE(@change_id, NEWID())

		INSERT INTO 
			session_changes 
			(session_id, change_id, change_version, change_data, author, create_date, modifier, modified_date) 
		VALUES
			(@session_id, @new_change_id, @change_version, @change_data, @user_email, GETDATE(), @user_email, GETDATE()) 

	END 

END
GO
PRINT N'Creating Procedure [dbo].[vds_updSessionNonEstimatedOption]...';


GO
CREATE PROCEDURE [dbo].[vds_updSessionNonEstimatedOption]
	@session_id UNIQUEIDENTIFIER,
	@row_id UNIQUEIDENTIFIER,
    @application VARCHAR(100),
    @product VARCHAR(100),
    @area VARCHAR(100) = '',
    @sub_area VARCHAR(100) = '',
    @item_no VARCHAR(100) = '',
    @item VARCHAR(MAX),
    @vendor VARCHAR(100) = '',
    @standard VARCHAR(200) = '',
    @qty DECIMAL(18,4) = 0,
    @cost DECIMAL(18,2) = 0,
    @price DECIMAL(18,2) = 0,
    @selected BIT NULL,
    @notes VARCHAR(MAX) = '',
    @model VARCHAR(100) = '',
    @source VARCHAR(20),
    @gpc VARCHAR(MAX) NULL = NULL,
    @option_pricing_display BIT = 0,
	@is_package BIT = 0,
    @audit_user VARCHAR(50)
AS
/*
	Author: Shelby Mansker
	Date: 11/6/2018
	Description: Updates the specified session's option
*/
BEGIN
	IF (EXISTS(SELECT TOP(1) * FROM catalog_selections WHERE session_id = @session_id AND row_id = @row_id))
	BEGIN
		UPDATE catalog_selections
		SET
			[application] = @application,
			product = @product,
			area = @area,
			sub_area = @sub_area,
			item_no = @item_no,
			item = @item,
			vendor = @vendor,
			[standard] = @standard,
			qty = @qty,
			cost = @cost,
			price = @price,
			selected = @selected,
			notes = @notes,
			model = @model,
			[source] = @source,
			gpc = @gpc,
			option_pricing_display = @option_pricing_display,
			is_package = @is_package,
			modifier = @audit_user,
			modified_date = GETDATE()
		WHERE
			session_id = @session_id
			AND row_id = @row_id
	END
END
GO
PRINT N'Creating Procedure [dbo].[vds_updSessionNotes]...';


GO

CREATE PROCEDURE [dbo].[vds_updSessionNotes]
	@session_id UNIQUEIDENTIFIER,
    @session_notes VARCHAR(MAX),
    @security_token UNIQUEIDENTIFIER
AS
/*
	Author:      Shelby Mansker
	Create date: 2/4/2015
	Description: Updates the specified session's notes

    Modified: 5/26/2015 by Shelby Mansker - Increased session notes allowable length from 255 characters to varchar(max)
*/
BEGIN
    -- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Store the notes
    UPDATE 
        dbo.account_organization_user_profile_plan_catalog_sessions
    SET
        session_notes = @session_notes
    WHERE
        session_id = @session_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updSessionReportId]...';


GO
CREATE PROCEDURE dbo.vds_updSessionReportId
    @session_id UNIQUEIDENTIFIER,
	@report_id UNIQUEIDENTIFIER, 
	@modifier NVARCHAR(50)
AS
/*
	Author: Robert Hobbs
	Date: 8/31/18
	Description: Updates the report id field of the session header. 

*/
BEGIN
	
    IF (NOT EXISTS(SELECT * FROM account_organization_user_profile_plan_catalog_sessions WHERE session_id = @session_id))
    BEGIN
        DECLARE @error_msg VARCHAR(MAX) = 'Update Failed. The Session ' + CAST(@session_id AS VARCHAR(36)) + ' does not exist.'
		RAISERROR(@error_msg,16,1)
		RETURN
	END

	UPDATE account_organization_user_profile_plan_catalog_sessions
	SET
		report_id = @report_id, 
		modifier = @modifier, 
		modified_date = GETDATE() 
	WHERE
		session_id = @session_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updSlab]...';


GO

CREATE PROCEDURE vds_updSlab
@session_id uniqueidentifier, 
@build_id int, 
@slab_id varchar(100), 
@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Robert Hobbs
	Date: 4/28/2017
	Description: Creates a slab selections record. 
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- select * from catalog_selections_area_slabs
	DECLARE @author VARCHAR(50) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	INSERT INTO 
	catalog_selections_area_slabs 
	(session_id, build_id, slab_id, author, create_date, modifier, modified_date) 
	VALUES
	(	@session_id, 
		@build_id, 
		@slab_id, 
		@author, 
		GETDATE(), 
		@author, 
		GETDATE()
	) 

END
GO
PRINT N'Creating Procedure [dbo].[vds_updSnapshotSessionBomModifications]...';


GO
CREATE PROCEDURE [dbo].[vds_updSnapshotSessionBomModifications]
    @session_id UNIQUEIDENTIFIER,
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @community VARCHAR(100),
    @series VARCHAR(100),
    @plan_name VARCHAR(100),
    @base_plan_name VARCHAR(100),
    @unmapped_plan_name VARCHAR(100),
    @elevation VARCHAR(50),
    @security_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Date: 10/19/2015
    Description: Copies all of the bom modifications for the specified build to the the specified
                 session. The reason we accept three different plans is that the Importer may not
                 know which plan will be used by the session, due to mapping and or base plans,
                 at the time when they are importing the bom modifications. In which case, we must
                 copy over the modifications that match any of the three plans.
*/
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    -- Get the user id from the security token
    DECLARE @active_user_id VARCHAR(100)
    SET @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token) 

    -- Start by clearing any existing records for this session's bom modifications
    DELETE FROM dbo.catalog_selections_bom_modifications WHERE session_id = @session_id

    -- Copy over the matching bom modifications
    INSERT INTO dbo.catalog_selections_bom_modifications
    (
        id,
        session_id,
        application_id,
        product_id,
        area_id,
        sub_area_id,
        item_code,
        item,
        vendor,
        modification_type,
        quantity,
        price,
        cost,
        notes,
        gpc,
        option_pricing_display,
        author,
        create_date,
        modifier,
        modified_date
    )
    SELECT
        NEWID(),
        @session_id,
        application_id,
        product_id,
        area_id,
        sub_area_id,
        item_code,
        item,
        vendor,
        modification_type,
        0, -- default the bom modification to 0 for now - RH 
        price,
        cost,
        notes,
        gpc,
        option_pricing_display,
        @active_user_id,
        GETDATE(),
        @active_user_id,
        GETDATE()
    FROM
        dbo.builder_bom_modifications WITH (NOLOCK)
    WHERE
        account_id = @account_id
        AND organization_id = @organization_id
        AND (LTRIM(community) = LTRIM(@community) OR community IS NULL OR community = 'all' OR community = '')
        AND (LTRIM(series) = LTRIM(@series) OR series IS NULL or series = 'all' or series = '')
        AND ( (LTRIM([plan]) = LTRIM(@plan_name) OR
	           LTRIM([plan]) = LTRIM(@base_plan_name) OR
	           LTRIM([plan]) = LTRIM(@unmapped_plan_name) OR 
			   [plan] IS NULL OR [plan] = 'all' OR [plan] = '') )
        AND (LTRIM(elevation) = LTRIM(@elevation) OR elevation IS NULL OR elevation = 'all' OR elevation = '')
END
GO
PRINT N'Creating Procedure [dbo].[vds_updUser]...';


GO
CREATE PROCEDURE [dbo].[vds_updUser]
	@user_id UNIQUEIDENTIFIER,
	@first_name VARCHAR(25),
	@last_name VARCHAR(25),
	@email VARCHAR(100),
	@image_data VARBINARY(MAX) = NULL,
	@active BIT = 1,
	@reset_id UNIQUEIDENTIFIER = NULL,
	@welcome_email_sent DATETIME = NULL,
	@welcome_email_validated DATETIME = NULL,
	@is_test_user BIT,
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Shelby Mansker
	Date: 7/18/2016
	Description: Updates an existing user

	Modified: Shelby Mansker
	Date: 8/1/2016
	Description: Added the new welcome email related columns to the procedure.

	Modified: Saul Sanchez
	Date: 4/10/2018
	Description: Removed the password fields.  Encrypted passwords are handled through another process.

	Modified: Roger Wang
	Date: 5/28/2021
	Description: Added is_test_user field
*/
BEGIN
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END	

	IF (LEN(@email) = 0)
	BEGIN
		RAISERROR('E-mail Is Required', 16, 1)
		RETURN
	END

	IF (EXISTS(SELECT [user_id] FROM VeoSolutionsSecurity_users WHERE email = @email AND [user_id] <> @user_id))
	BEGIN
		RAISERROR('E-mail Already Associated With A User', 16, 1)
		RETURN
	END

	DECLARE @modifier VARCHAR(100) = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	UPDATE VeoSolutionsSecurity_users
	SET
		first_name = @first_name,
		last_name = @last_name,
		email = @email,
		image_data = @image_data,
		active = @active,
		reset_id = @reset_id,
		welcome_email_sent = @welcome_email_sent,
		welcome_email_validated = @welcome_email_validated,
		is_test_user = @is_test_user,
		modifier = @modifier,
		modified_date = GETDATE()
	WHERE
		[user_id] = @user_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_updUserResetId]...';


GO
CREATE procedure [dbo].[vds_updUserResetId]
@email varchar(100),
@reset_id uniqueidentifier, 
@security_token uniqueidentifier 
as

if (not exists(select * from veosolutionssecurity_users where email = @email))
	begin
		raiserror('Unable to reset password. Email is not registered.',16,1)
		return
	end


update 
	veosolutionssecurity_users
set reset_id = @reset_id
where email = @email
GO
PRINT N'Creating Procedure [dbo].[vds_updUserTemporaryPassword]...';


GO
CREATE PROCEDURE [dbo].[vds_updUserTemporaryPassword]
    @user_id UNIQUEIDENTIFIER,
    @temporary_password VARCHAR(MAX),
    @hash_provider NVARCHAR(1000)
AS
/*
    Author: Saul Sanchez
    Date:   07/28/2016
    Description: Updates the temporary password for an existing user,
                 then returns the user.  This procedure is called
                 when a user forgots their password.
*/
BEGIN
    UPDATE VeoSolutionsSecurity_users
    SET
        temporary_password = @temporary_password,
        hash_provider = @hash_provider
    WHERE
        [user_id] = @user_id

    SELECT
        *
    FROM
        VeoSolutionsSecurity_users
    WHERE
        [user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_updWishListItemNotes]...';


GO
CREATE PROCEDURE [dbo].[vds_updWishListItemNotes]
	@account_id UNIQUEIDENTIFIER,
	@organization_id UNIQUEIDENTIFIER,
	@user_id UNIQUEIDENTIFIER,
	@wishlist_item_id UNIQUEIDENTIFIER,
	@notes VARCHAR(MAX),
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author: Saul Sanchez
	Create Date: 03/28/2018
	Description: Updates notes for a wishlist item.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	UPDATE
		[dbo].[account_organization_user_wishlist_items]
	SET
		notes = @notes
	WHERE
		account_id = @account_id
		AND organization_id = @organization_id
		AND [user_id] = @user_id
		AND wishlist_item_id = @wishlist_item_id
END
GO
PRINT N'Creating Procedure [dbo].[vds_validateRefreshToken]...';


GO
CREATE PROCEDURE [dbo].[vds_validateRefreshToken]
    @refresh_token UNIQUEIDENTIFIER
AS
/*
    Author: Shelby Mansker
    Create Date: 5/23/2018
    Description: A refresh token is a mechanism that allows us to re-issue an authentication token to a user, for vds,
				 for a period of time after their authentication token has expried, without requiring them to re-login.
				 We are currently using the existing database security token mechanism (an old mainstay of VeoSolutions 
				 and early vds) to double as refresh tokens. If a refresh token is valid, this proc returns the user
				 associated with the token. If it is not valid, an error is returned.

*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@refresh_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

    DECLARE @user_id UNIQUEIDENTIFIER

    SELECT
        @user_id = [user_id]
    FROM
        VeoSolutionsSecurity_users_login_sessions WITH (NOLOCK)
    WHERE
        security_token = @refresh_token

    SELECT
        *
    FROM
        VeoSolutionsSecurity_users WITH (NOLOCK)
    WHERE
        [user_id] = @user_id

END
GO
PRINT N'Creating Procedure [dbo].[vds_vs_selItemPrice]...';


GO
CREATE PROCEDURE [dbo].[vds_vs_selItemPrice]
@effective_date datetime,  
@customer_id varchar(15),   
@application_id varchar(10),   
@product_id varchar(10),  
@area_id varchar(10),  
@sub_area_id varchar(10),  
@spec_id int = 0,  
@plan_id varchar(20) = '',  
@build_id varchar(50) = '',  
@generic_item_type varchar(20),  
@generic_item_id varchar(50) = '', 
@item varchar(81),   
@uom varchar(9) = '',  
@pattern_id varchar(50) = '0',                        
@security_token varchar(36) = null,
@suppress_errors bit = 0  
AS  
/*
	Author: Charles Moore
	Date: 12/06/2021
	Description: Executes vs_selItemPrice SYNONYM on the VDS side to avoid cross datbase connection transaction 
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END	
                      
EXEC Veo_vs_selItemPrice @effective_date,@customer_id,@application_id,@product_id,@area_id,@sub_area_id,@spec_id,@plan_id,@build_id,
					  @generic_item_type,@generic_item_id,@item,@uom,@pattern_id,@security_token,@suppress_errors					  	  	  

END
GO
PRINT N'Creating Procedure [dbo].[vs_blockUnblockSchedulingBuyersContact]...';


GO
CREATE procedure [dbo].[vs_blockUnblockSchedulingBuyersContact]
@profile_id uniqueIdentifier,
@phone nvarchar(20),
@flag nvarchar(20)
as

if(@flag = 'block')
Begin
	--Home phone 
	update scheduling_buyers_contacts 
			 SET home_phone_send_message = 0
			 where home_phone = @phone and is_buyer = 1

	-- Work phone 
	update scheduling_buyers_contacts 
			 SET work_phone_send_message = 0
			 where work_phone = @phone and is_buyer = 1

	-- Mobile phone 
	update scheduling_buyers_contacts 
			 SET mobile_phone_send_message = 0
			 where mobile_phone = @phone and is_buyer = 1
End
ELSE If(@flag = 'unblock')
Begin
--Home phone 
	update scheduling_buyers_contacts 
			 SET home_phone_send_message = 1
			 where home_phone = @phone and is_buyer = 1

	-- Work phone
	update scheduling_buyers_contacts 
			 SET work_phone_send_message = 1
			 where work_phone = @phone and is_buyer = 1

	-- Mobile phone
	update scheduling_buyers_contacts 
			 SET mobile_phone_send_message = 1
			 where mobile_phone = @phone and is_buyer = 1
END
GO
PRINT N'Creating Procedure [dbo].[vs_CheckAreaCredit]...';


GO


CREATE procedure [dbo].[vs_CheckAreaCredit]
@session_id uniqueidentifier,
@application varchar(max),
@product varchar(max),
@area varchar(max),
@sub_area varchar(max)

as

/*

vs_CheckAreaCredit '73614f38-e41b-4a3c-8d66-a9eb07021611','Walls','Tile','Opt Bath 3 Tub Splash w/Floor Tile',''


> 1 = credit area
0 = 
*/

select count(*) as has_credit_area
from catalog_selections
where 
	session_id = @session_id
	and application = @application
	and product = @product
	and area = @area
	and sub_area = @sub_area
	and price < 0
GO
PRINT N'Creating Procedure [dbo].[vs_CheckSessionForManualPricing]...';


GO
CREATE procedure vs_CheckSessionForManualPricing
@session_id uniqueidentifier

as
/*
vs_CheckSessionForManualPricing 'b827e131-0509-4d2d-911f-e62cbc21f0e2'
*/
select 
	csad.application+' '+ csad.product + ', '+ 
	csad.area + ' '+ csad.sub_area + ', ' + 
	item_type + ' '+ item_id + 
	--' homebuyer price = '+ ltrim( str( convert(decimal(10,2),csad.bill_qty*csad.homeowner_price)) ),
	--' bill qty = '+ cast( cast(csad.bill_qty as decimal(18,2)) as varchar) +
	' bill unit price = '+ cast( cast(csad.homeowner_price as decimal(18,2)) as varchar)

	as manual_price_area,
	csad.bill_qty,
	convert(decimal(10,2),csad.bill_qty*csad.homeowner_price) as price
	--csad.*
from catalog_selections_areas csa with (nolock)
left join catalog_selections_area_details csad with (nolock) on
	csad.session_id = csa.session_id
	and csad.application = csa.application
	and csad.product = csa.product
	and csad.area = csa.area
	and csad.sub_area = csa.sub_area

where csa.session_id = @session_id
	and csad.price_source = 'Manual'
GO
PRINT N'Creating Procedure [dbo].[vs_CheckSessionForNegativePricing]...';


GO

create procedure [dbo].[vs_CheckSessionForNegativePricing]

@session_id uniqueidentifier

as
/*
vs_CheckSessionForNegativePricing '703857da-8e94-405f-9e5b-e29997273486'
*/

select 
	'Estimated' as source,
	csa.application+' '+ csa.product + ', '+ 
	csa.area + ' '+ csa.sub_area as item_description,
	csa.selection_total
from catalog_selections_areas csa with (nolock)

where csa.session_id = @session_id
	and csa.selection_total < 0
union

select
	source = 
	case
		when source = 'user' then 'User'
		when source = 'catalog' then 'Catalog'
		else source
	end,
	cs.application+' '+ cs.product + ', '+ 
	cs.area + ' '+ cs.sub_area as item_description,
	cs.qty*cs.price as selection_total

from catalog_selections cs with (nolock)

where cs.session_id = @session_id
	and cs.qty*cs.price < 0
	and selected = 1
	and  source <> 'Prices Landed'
GO
PRINT N'Creating Procedure [dbo].[vs_createCatalog]...';


GO

CREATE procedure [dbo].[vs_createCatalog]      
    @session_id uniqueidentifier,      
    @account_id uniqueidentifier,      
    @organization_id uniqueidentifier,      
    @user_id uniqueidentifier,      
    @community_id int,  
    @community varchar(100)='',      
    @series varchar(100)='',      
    @plan varchar(100)= '',   
    @base_plan varchar(100)= '',
    @plan_version varchar(50),     
    @designer varchar(50) = '',    
    @security_token uniqueidentifier = null    
AS
/*
    Author: Adrian?
    Date: ???
    Description: This method creates a new session and copies over the appropriate catalog items.

    Modified by Adrian Garza on 1/2/2014
    Description: added elevation check

    Modified by Adrian Garza on 2/14/2015
    Description: Added base plan

    Modified by Rob Hobbs on 5/20/2013
    Description: Added gpc

    Modified by Shelby Mansker on 7/17/2015
    Description: I Cleaned up this method a bit, reformatting the code. Also, when a session is created, it now tracks
                 the most recent catalog item modified date, from catalog_items, and saves it in the session. This is intended to
                 be used internally by the catalog item team, in order to troubleshoot issues with sessions having out of date
                 catalog items.

    TESTS: 
    vs_createCatalog '5DD2EC4F-FFCC-4F16-B0C9-02189945CF8D', 'BAB32B7E-3ADA-497C-862E-E5083971CC59','78D12721-C3D5-4067-9E89-9B4C32A8CDA2','Lakes of Pine Forest','Plantation-Elite','Delfina V (5950)'      
*/      
      
-- Get the user id from the security token
DECLARE @active_user_id varchar(100)
SET @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)       
      
-- Fetch the mapped plan. According to Nick, we should only use plan mapping for the catalog, ignoring community and series mapping.
DECLARE @mapped_plan varchar(50)
SELECT
	@mapped_plan = mapped_name         
FROM
	VeoSolutionsSecurity_account_organization_plans aop WITH (NOLOCK)
	LEFT JOIN VeoSolutionsSecurity_account_organization_plans_mappings aopm with(nolock) on aopm.account_id = aop.account_id  and aopm.organization_id = aop.organization_id and aopm.plan_id = aop.plan_id      
WHERE
	aop.account_id = @account_id       
	AND aop.organization_id = @organization_id      
	AND aop.name = @plan      
       
-- create session      
INSERT INTO account_organization_user_profile_plan_catalog_sessions (
    account_id,
    organization_id,
    [user_id],
    community_id, 
    community_name,
    series,
    plan_name,
    plan_version,
    session_id,
    [status],
    designer,
    author,
    modifier)      
VALUES (
    @account_id,
    @organization_id,
    @user_id,
    @community_id, 
    @community,
    @series,
    @plan,
    @plan_version, 
    @session_id,
    1,
    @designer,
    @active_user_id, 
    @active_user_id)      

--locate elevation selected from session
DECLARE @elevation varchar(50) = ''
SELECT 
    @elevation = isnull(elevation ,'')
FROM 
    account_organization_user_profile_plan with (nolock)
WHERE
    account_id = @account_id 
	AND organization_id = @organization_id
	AND [user_id] = @user_id
	AND community_name = @community
	AND series = @series
	AND plan_name = @plan

-- Copy the catalog items into the session's catalog_selections table
INSERT INTO catalog_selections (
    session_id,      
    row_id,      
    account_id,      
    organization_id,      
    community,      
    series,      
    [plan],      
    [application],
    product,      
    area,      
    sub_area,      
    item_no,      
    item,      
    vendor,      
    [standard],
    qty,
    cost,      
    price,      
    selected,      
    notes,      
    option_pricing_display,      
    mutually_exclusive,
    gpc,   
    model,  
    author,      
    create_date,      
    modifier,      
    modified_date,      
    [source])      
SELECT       
    @session_id,      
    row_id,      
    account_id,      
    organization_id,      
    community,      
    series,      
    [plan],      
    [application],
    product,      
    area,      
    sub_area,      
    item_no,      
    item,      
    vendor,      
    [standard],
    qty,     
    cost, 
    price,      
    selected,      
    notes,      
    option_pricing_display,      
    mutually_exclusive, 
    gpc,     
    model, 
    @active_user_id,      
    create_date,      
    @active_user_id,      
    modified_date,      
    'catalog' AS [source]
 FROM
    catalog_items WITH (NOLOCK)
 WHERE
    account_id = @account_id      
    AND organization_id = @organization_id       
    AND (LTRIM(community) = LTRIM(@community) or community= 'All')      
    AND (LTRIM(series) = LTRIM(@series) OR series = 'All')      
    AND (LTRIM([plan]) = LTRIM(@plan) OR
	     LTRIM([plan]) = LTRIM(@base_plan) OR
	     LTRIM([plan]) = LTRIM(@mapped_plan) OR 
	     [plan] = 'All')
    AND (LTRIM(elevation) = LTRIM(@elevation) OR elevation = 'All')
GO
PRINT N'Creating Procedure [dbo].[vs_CreateCatalogSelectionGroups]...';


GO
CREATE procedure [dbo].[vs_CreateCatalogSelectionGroups]
@session_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
/*

vs_CreateCatalogSelectionGroups '2c349003-32c4-47a9-b67d-bb1a3c63cac0'

	Note: Modified to use spec instead of catalog_selection to get groups since not all group are published and won't all be in catalog_selection 
		  specifically T groups (i.e. accents).  8/10/2015 ADG

	8/17/2015 modified , fixed timeout issue, forgot to use session id in new query. ADG

*/


delete from catalog_selections_group_detail where session_id = @session_id

insert into catalog_selections_group_detail (session_id, group_id, item_type, item, author, create_date, modifier, modified_date, area_id, sub_area_id)

-- 8/10/2015

select distinct
 @session_id as session_id,
 vsgd.group_id as group_id,
 vsgd.item_type as item_type,
 vsgd.item as item,
 @active_user_id as author,
 GETDATE() as create_date,
 @active_user_id as modifier,
 GETDATE() as modified_date,
 vsgd.area_id,
 vsgd.sub_area_id
 --vsg.*
from 
	catalog_selections cs with (nolock)
	--left join account_organization_user_profile_plan aoupp with (nolock) on aoupp.catalog_session_id = cs.session_id -- session id no longer kept in profile plan 9/26/2012
	left join account_organization_user_profile_plan_catalog_sessions aoupp with (nolock) on aoupp.session_id = cs.session_id
	left join vss_organizations vsso with (nolock) on vsso.organization_id = aoupp.organization_id
--left join veo_styles_groups vsg with (nolock) on vsg.group_id = cs.item_no
	left join veo_styles_groups_detail vsgd with (nolock) on vsgd.group_id = cs.item_no and vsgd.customer_id = vsso.external_organization_id
where cs.session_id = @session_id
	and cs.item_type = 'group'
	and convert(date,vsgd.effective_date) <= convert(date,getdate())
	and ( convert(date,vsgd.end_date) >= CONVERT(DATE,GETDATE()) or vsgd.end_date is null)
	



/*
-- removed not working correclty 8/17/2015 ADG
select distinct
 @session_id as session_id,
 vsgd.group_id as group_id,
 vsgd.item_type as item_type,
 vsgd.item as item,
 @active_user_id as author,
 GETDATE() as create_date,
 @active_user_id as modifier,
 GETDATE() as modified_date 
 --vsg.*
from 
	account_organization_user_profile_plan_catalog_sessions aoupp with (nolock)
	left join veo_spec_items si with (nolock) on si.spec_id = aoupp.spec_id
	left join vss_organizations vsso with (nolock) on vsso.organization_id = aoupp.organization_id
	left join veo_styles_groups_detail vsgd with (nolock) on vsgd.customer_id = vsso.external_organization_id and vsgd.group_id = si.item
where si.item_type = 'group'
	and aoupp.session_id = @session_id
	and convert(date,vsgd.effective_date) <= convert(date,getdate())
	and ( convert(date,vsgd.end_date) >= CONVERT(DATE,GETDATE()) or vsgd.end_date is null)

	*/
GO
PRINT N'Creating Procedure [dbo].[vs_createSessionPricingSnapshot]...';


GO
CREATE procedure [dbo].[vs_createSessionPricingSnapshot]

@session_id uniqueidentifier

as
/*


vs_createSessionPricingSnapshot  '42da08c5-f3f3-42db-b42d-1c8d963b89fc'

declare @session_id uniqueidentifier
set @session_id = '42da08c5-f3f3-42db-b42d-1c8d963b89fc'

*/

declare @spec_id int
declare @effective_date datetime
declare @publish_date date
declare @customer_id varchar(20)
declare @session_create_date datetime

select 
	@publish_date = cast(pricing_generated as date),
	@spec_id = spec_id,
	@effective_date = effective_date,
	@customer_id = external_organization_id,
	@session_create_date =s.create_date

from account_organization_user_profile_plan_catalog_sessions s with (nolock)
left join vss_organizations o with (nolock) on o.organization_id = s.organization_id
where session_id = @session_id

print @publish_date
print @spec_id
print @effective_date
print @customer_id
print @session_create_date

--delete in case a refresh is happening
delete from catalog_prices_published
where session_id = @session_id


insert into catalog_prices_published (
							session_id,
							published,
						    table_name,
							customer_id,
							region_id,
							custclas,					
							spec_id,
							effective_date,
							application_id,
							product_id,
							area_id,
							sub_area_id,
							plan_id,
							build_id,
							item_type,
							item,
							price_type,
							price,
							uom,
							retail_percentage_type,
							retail_percentage,
							retail_unit_price,
							author,
							create_date,
							modifier,
							modified_date)
select 
	@session_id as session_id,
	published,
	table_name,
	customer_id,
	region_id,
	custclas,					
	spec_id,
	effective_date,
	application_id,
	product_id,
	area_id,
	sub_area_id,
	plan_id,
	build_id,
	item_type,
	item,
	price_type,
	price,
	uom,
	retail_percentage_type,
	retail_percentage,
	retail_unit_price,
	author,
	create_date,
	modifier,
	modified_date
from veo_prices_published
where (spec_id = @spec_id or spec_id = 0)
and cast(effective_date as date) <= cast(@session_create_date as date)
and published = @publish_date


--select * from catalog_prices_published


--delete in case a refresh is happening
delete catalog_prices_published_groups_detail
where session_id = @session_id

insert catalog_prices_published_groups_detail (
					session_id,
					published,
					group_id,
					customer_id,
					effective_date,
					item_type,
					item,
					end_date,
					author,
					create_date,
					modifier,
					modified_date)

select 
   @session_id as session_id,
   published, 
   group_id,
   customer_id,
   effective_date,
   item_type,
   item,
   end_date,
   author,
   create_date,
   modifier,
   modified_date

from veo_prices_published_groups_detail
where published = @publish_date 
and customer_id = @customer_id


--select * from catalog_prices_published_groups_detail
GO
PRINT N'Creating Procedure [dbo].[vs_createTableProceduresWithAuditing]...';


GO
CREATE procedure [dbo].[vs_createTableProceduresWithAuditing]
@table_name varchar(100)
as
-- vs_createTableProceduresWithAuditing account_organization_brick_communities
--=========================================================================
-- Check if the table exists
--=========================================================================
if not exists	(	select
									so.id
								from
									sysobjects so
								where
									so.name = @table_name )
	begin
		raiserror ('The table does not exist on this database', 16, 1)
		return
	end

--=========================================================================
-- Check to see if the table has a primary key
--=========================================================================
if not exists	( select
									si.id
								from
									sysindexes si
								join sysobjects so on
									so.id = si.id
								join sysindexkeys sik on
									sik.id = so.id
									and sik.indid = si.indid
								join syscolumns sc on
									sc.id = so.id
									and sc.colid = sik.colid
								join systypes st on
									sc.xtype = st.xtype
								where
									so.name = @table_name
									and si.name like 'PK_%')
	begin
		raiserror ('The table does not have a primary key.', 16, 1)
		return
	end

--=========================================================================
-- Table must have author, create_date, modifier, and modified_date columns
--=========================================================================
if not exists	( select
									sc.name
								from
									syscolumns sc
								join sysobjects so on
									so.id = sc.id
								join systypes st on
									sc.xtype = st.xtype
								where
									so.name = @table_name
									and so.type = 'u'
									and sc.name = 'author')
	begin
		raiserror ('The table does not have an ''author'' column.', 16, 1)
		return
	end

if not exists	( select
									sc.name
								from
									syscolumns sc
								join sysobjects so on
									so.id = sc.id
								join systypes st on
									sc.xtype = st.xtype
								where
									so.name = @table_name
									and so.type = 'u'
									and sc.name = 'create_date')
	begin
		raiserror ('The table does not have an ''create_date'' column.', 16, 1)
		return
	end

if not exists	( select
									sc.name
								from
									syscolumns sc
								join sysobjects so on
									so.id = sc.id
								join systypes st on
									sc.xtype = st.xtype
								where
									so.name = @table_name
									and so.type = 'u'
									and sc.name = 'modifier')
	begin
		raiserror ('The table does not have an ''modifier'' column.', 16, 1)
		return
	end

if not exists	( select
									sc.name
								from
									syscolumns sc
								join sysobjects so on
									so.id = sc.id
								join systypes st on
									sc.xtype = st.xtype
								where
									so.name = @table_name
									and so.type = 'u'
									and sc.name = 'modified_date')
	begin
		raiserror ('The table does not have an ''modified_date'' column.', 16, 1)
		return
	end

--=========================================================================
-- Get the table name in the correct case
--=========================================================================
declare @proc_table_name varchar(100)
declare @underscore_position int

set @proc_table_name = ''
set @underscore_position = 0

set @proc_table_name = upper(left(@table_name,1)) + right(@table_name, len(@table_name) - 1)
set @underscore_position = charindex('_', @proc_table_name)

while @underscore_position > 0
	begin
		set @proc_table_name = left(@proc_table_name, @underscore_position - 1) + 
														upper(substring(@proc_table_name, @underscore_position + 1, 1))	+
														right(@proc_table_name, len(@proc_table_name) - @underscore_position - 1)
		set @underscore_position = charindex('_', @proc_table_name)
	end

--=========================================================================
-- Get list of columns with types
--=========================================================================
declare @column_list_with_types varchar(7000)
set @column_list_with_types = ''

select
	@column_list_with_types = @column_list_with_types 
		+ '	[' + sc.name + '] ' 
		+ st.name 
		+ case 
			when sc.xtype = 165 then '(' + case when sc.length = -1 then 'MAX' else cast( sc.length as varchar(10)) end + ')'
			when sc.xtype = 167 then '(' + case when sc.length = -1 then 'MAX' else cast( sc.length as varchar(10)) end + ')' 
			when sc.xtype = 106 then '(' + cast(sc.xprec as varchar(10)) + ',' + cast(sc.xscale as varchar(10)) + ')' 
			else '' end + ' ' 
		+ case when sc.isnullable = 1 then 'NULL' else 'NOT NULL' end + ',
'
from
	syscolumns sc
join sysobjects so on
	so.id = sc.id
join systypes st on
	sc.xtype = st.xtype
where
	so.name = @table_name
	and so.type = 'u'
order by
	sc.colid

set @column_list_with_types = left(@column_list_with_types, len(@column_list_with_types) - 3)
set @column_list_with_types = replace(@column_list_with_types, 'timestamp', 'varchar(50)')

--=========================================================================
-- Create z table
--=========================================================================
declare @z_table_sql varchar(8000)
set @z_table_sql = ''

set @z_table_sql = '
create table z_' + @table_name + ' (
	[z_user_name] varchar(50) NOT NULL,
	[z_action] varchar(10) NOT NULL,
	[z_time] datetime NOT NULL,
' + @column_list_with_types + ',
	[auto_number] int IDENTITY (1, 1) NOT NULL,
	CONSTRAINT [PK_z_' + @table_name + '] PRIMARY KEY CLUSTERED ([auto_number]))'

print(@z_table_sql)
print '


'
print('GO')
print '


'

--=========================================================================
-- Get primary key parameter list and primary key where clause
--=========================================================================
declare @primary_key_parameter_list varchar(2000)
declare @primary_key_where_clause varchar(2000)

set @primary_key_parameter_list = ''
set @primary_key_where_clause = ''

select
	@primary_key_parameter_list = @primary_key_parameter_list + '@' + sc.name + ' ' +
			case when st.name = 'char' then 'varchar' else st.name end +
			case
				when sc.xtype = 165 then '(' + case when sc.length = -1 then 'MAX' else cast( sc.length as varchar(10)) end + ')'
				when sc.xtype = 167 then '(' + case when sc.length = -1 then 'MAX' else cast( sc.length as varchar(10)) end + ')'
				when sc.xtype = 175 then '(' + cast(sc.length as varchar(10)) + ')'
				when sc.xtype = 106 then '(' + cast(sc.xprec as varchar(10)) + ',' + cast(sc.xscale as varchar(10)) + ')'
				else ''
			end + ',
',
	@primary_key_where_clause = @primary_key_where_clause + '	and ' + sc.name + ' = @' + sc.name + '
'
from
	sysindexes si
	join sysobjects so on	so.id = si.id
	join sysindexkeys sik on 	sik.id = so.id and sik.indid = si.indid join syscolumns sc on	sc.id = so.id 	and sc.colid = sik.colid
	join systypes st on 	sc.xtype = st.xtype
where
	so.name = @table_name
	and si.name like 'PK_%'

set @primary_key_parameter_list = left(@primary_key_parameter_list, len(@primary_key_parameter_list) - 3)
set @primary_key_where_clause = '	' + right(@primary_key_where_clause, len(@primary_key_where_clause) - 5)

--=========================================================================
-- Get primary key where clause for insert audit
--=========================================================================
declare @primary_key_where_clause_for_insert_audit varchar(2000)
set @primary_key_where_clause_for_insert_audit = ''

select
	@primary_key_where_clause_for_insert_audit = @primary_key_where_clause_for_insert_audit + '	and ' + sc.name + ' = ' + case when sc.autoval is null then '@' + sc.name else 'scope_identity()' end + '
'
from
	sysindexes si
	join sysobjects so on 	so.id = si.id
	join sysindexkeys sik on 	sik.id = so.id and sik.indid = si.indid
	join syscolumns sc on 	sc.id = so.id 	and sc.colid = sik.colid
	join systypes st on 	sc.xtype = st.xtype
where
	so.name = @table_name
	and si.name like 'PK_%'

set @primary_key_where_clause_for_insert_audit = '	' + right(@primary_key_where_clause_for_insert_audit, len(@primary_key_where_clause_for_insert_audit) - 5)

--=======================
-- Get autonumber column
--=======================
declare @autonumber_column varchar(255)
set @autonumber_column = ''

select
	@autonumber_column = sc.name
from
	syscolumns sc
join sysobjects so on
	so.id = sc.id
where
	so.name = @table_name
	and not sc.autoval is null

--==============================================================================
-- Get list of table columns minus author, create_date, modifier, modified_date 
--==============================================================================
declare @column_list varchar(2000)
declare @include_audit_fields_in_select bit

set @column_list = ''
set @include_audit_fields_in_select = 1

select
	@column_list = @column_list + '	' + sc.name + ',
'
from
	syscolumns sc
join sysobjects so on
	so.id = sc.id
where
	so.name = @table_name
	and so.type = 'u'
	and (sc.name <> 'author' or @include_audit_fields_in_select = 1)
	and (sc.name <> 'create_date' or @include_audit_fields_in_select = 1)
	and (sc.name <> 'modifier' or @include_audit_fields_in_select = 1)
	and (sc.name <> 'modified_date' or @include_audit_fields_in_select = 1) 
order by
	sc.colid

set @column_list = left(@column_list, len(@column_list) - 3)


--=========================================================================
-- Select stored procedure
--=========================================================================
declare @proc_action varchar(20)

declare @select_sql varchar(8000)
set @select_sql = ''

if exists (select name from sysobjects where name = 'vs_sel' + @proc_table_name)
	set @proc_action = 'alter'
else
	set @proc_action = 'create'

set @select_sql = '
' + @proc_action + ' procedure vs_sel' + @proc_table_name + '
' + @primary_key_parameter_list + ',
@security_token uniqueidentifier
as

declare @edit_user_id varchar(75)
set @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
if (@edit_user_id is null)
	begin
		raiserror(''Invalid credentials.'',16,1)
		return
	end

select
' + @column_list + ',
	@edit_user_id as edit_user_id
from
	' + @table_name + ' with (nolock)
where
' + @primary_key_where_clause

print(@select_sql)
print '


'
print('GO')
print '


'

--=========================================================================
-- Get insert parameter list, column names, and column values
--=========================================================================
declare @insert_parameter_list varchar(4000)
declare @insert_column_list varchar(4000)
declare @insert_column_values varchar(2000)

set @insert_parameter_list = ''
set @insert_column_list = ''
set @insert_column_values = ''

select
	@insert_parameter_list = @insert_parameter_list + '@' + sc.name + ' ' +
			case when st.name = 'char' then 'varchar' else st.name end +
			case
				when sc.xtype = 165 then '(' + case when sc.length = -1 then 'MAX' else cast( sc.length as varchar(10)) end + ')'
				when sc.xtype = 167 then '(' + case when sc.length = -1 then 'MAX' else cast( sc.length as varchar(10)) end + ')'
				when sc.xtype = 175 then '(' + cast(sc.length as varchar(10)) + ')'
				when sc.xtype = 106 then '(' + cast(sc.xprec as varchar(10)) + ',' + cast(sc.xscale as varchar(10)) + ')'
				else ''
			end + ',
',
	@insert_column_list = @insert_column_list + '	' +	sc.name + ',
',
	@insert_column_values = @insert_column_values + '	@' + sc.name + ',
'
from
	syscolumns sc
join sysobjects so on
	so.id = sc.id
join systypes st on
	sc.xtype = st.xtype
where
	so.name = @table_name
	and so.type = 'u'
	and sc.name <> 'author'
	and sc.name <> 'create_date'
	and sc.name <> 'modifier'
	and sc.name <> 'modified_date'
	and sc.name <> 'stamp'
	and sc.autoval is null
order by
	sc.colid

set @insert_parameter_list = left(@insert_parameter_list, len(@insert_parameter_list) - 3)
set @insert_column_list = left(@insert_column_list, len(@insert_column_list) - 3)
set @insert_column_values = left(@insert_column_values, len(@insert_column_values) - 3)

--=========================================================================
-- Insert stored procedure
--=========================================================================
declare @insert_sql varchar(8000)
set @insert_sql = ''

if right(@proc_table_name, 1) = 's' and right(@proc_table_name, 2) <> 'ss'
	set @proc_table_name = left(@proc_table_name, len(@proc_table_name) - 1)

set @insert_sql = '
' + @proc_action + ' procedure vs_ins' + @proc_table_name + '
' + @insert_parameter_list + ',
@security_token uniqueidentifier
as

declare @edit_user_id varchar(75)
set @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
if (@edit_user_id is null)
	begin
		raiserror(''Invalid credentials.'',16,1)
		return
	end

insert into ' + @table_name + ' (
' + @insert_column_list + ',
	author,
	create_date,
	modifier,
	modified_date )
values (
' + @insert_column_values + ',
	@edit_user_id,
	getdate(),
	@edit_user_id,
	getdate() )

if @@error <> 0
	begin
		return
	end
'

if @autonumber_column <> ''
	begin
		set @insert_sql = @insert_sql + char(13) + 'select scope_identity() as ' + @autonumber_column + char(13)
	end

--set @insert_sql = @insert_sql + '
----=======================
---- Insert z table record
----=======================
--insert into 
--	z_' + @table_name + '
--select 
--	@edit_user_id as z_user_name, 
--	''insert'' as z_action, 
--	getdate() as z_time, 
--	*
--from 
--	' + @table_name + '
--where
--' + @primary_key_where_clause_for_insert_audit

print(@insert_sql)
print '


'
print('GO')
print '


'

--=========================================================================
-- Build stamp strings for use in update/delete procedures
--=========================================================================
declare @stamp_parameter varchar(100)
declare @stamp_where_clause varchar(100)

set @stamp_parameter = ''
set @stamp_where_clause = ''

select
	@stamp_parameter = ',
@' + sc.name + ' ' + st.name,
	@stamp_where_clause = '	and ' + sc.name + ' = @' + sc.name
from
	syscolumns sc
join sysobjects so on
	so.id = sc.id
join systypes st on
	sc.xtype = st.xtype
where
	so.name = @table_name
	and so.type = 'u'
	and sc.name = 'stamp'

--=========================================================================
-- Get update parameter list and column set list
--=========================================================================
declare @update_parameter_list varchar(4000)
declare @update_column_set_list varchar(4000)

set @update_parameter_list = ''
set @update_column_set_list = ''

select
	@update_parameter_list = @update_parameter_list + '@' + sc.name + ' ' +
			case when st.name = 'char' then 'varchar' else st.name end  +
			case
				when sc.xtype = 165 then '(' + case when sc.length = -1 then 'MAX' else cast( sc.length as varchar(10)) end + ')'
				when sc.xtype = 167 then '(' + case when sc.length = -1 then 'MAX' else cast( sc.length as varchar(10)) end + ')'
				when sc.xtype = 175 then '(' + cast(sc.length as varchar(10)) + ')'
				when sc.xtype = 106 then '(' + cast(sc.xprec as varchar(10)) + ',' + cast(sc.xscale as varchar(10)) + ')'
				else ''
			end + ',
'
from
	syscolumns sc
	join sysobjects so on 	so.id = sc.id
	join systypes st on 	sc.xtype = st.xtype
where
	so.name = @table_name
	and so.type = 'u'
	and sc.name <> 'author'
	and sc.name <> 'create_date'
	and sc.name <> 'modifier'
	and sc.name <> 'modified_date'
	and sc.name <> 'stamp'
order by
	sc.colid

select
	@update_column_set_list = @update_column_set_list + '	' + sc.name + ' = @' + sc.name + ',
'
from
	syscolumns sc
	join sysobjects so on 	so.id = sc.id
	join systypes st on 	sc.xtype = st.xtype
where
	so.name = @table_name
	and so.type = 'u'
	and sc.name <> 'author'
	and sc.name <> 'create_date'
	and sc.name <> 'modifier'
	and sc.name <> 'modified_date'
	and sc.name <> 'stamp'
	and sc.name not in (	select
												sc.name
											from
												sysindexes si
												join sysobjects so on so.id = si.id
												join sysindexkeys sik on sik.id = so.id and sik.indid = si.indid
												join syscolumns sc on sc.id = so.id and sc.colid = sik.colid
												join systypes st on sc.xtype = st.xtype
											where
												so.name = @table_name
												and si.name like 'PK_%'	)
order by
	sc.colid

set @update_parameter_list = left(@update_parameter_list, len(@update_parameter_list) - 3)


if @update_column_set_list <> ''
	begin
		set @update_column_set_list = left(@update_column_set_list, len(@update_column_set_list) - 3)
		
		--=========================================================================
		-- Update stored procedure
		--=========================================================================
declare @update_sql varchar(8000)
set @update_sql = ''

set @update_sql = '
' + @proc_action + ' procedure vs_upd' + @proc_table_name + '
' + @update_parameter_list + @stamp_parameter + ',
@security_token uniqueidentifier
as

declare @edit_user_id varchar(75)
set @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
if (@edit_user_id is null)
	begin
		raiserror(''Invalid credentials.'',16,1)
		return
	end

update
	' + @table_name + '
set
' + @update_column_set_list + ',
	modifier = @edit_user_id,
	modified_date = getdate()
where
' + @primary_key_where_clause + @stamp_where_clause + '

if @@error <> 0
	begin
		return
	end
'
		----=======================
		---- Insert z table record
		----=======================
		--insert into 
		--	z_' + @table_name + '
		--select 
		--	@edit_user_id as z_user_name, 
		--	''update'' as z_action, 
		--	getdate() as z_time, 
		--	*
		--from
		--	' + @table_name + '
		--where
		--' + @primary_key_where_clause 

		print(@update_sql)
		print '


		'
		print('GO')
		print '


		'

	end

--=========================================================================
-- Delete stored procedure
--=========================================================================
declare @delete_sql varchar(8000)
set @delete_sql = ''

set @delete_sql = '
' + @proc_action + ' procedure vs_del' + @proc_table_name + '
' + @primary_key_parameter_list + @stamp_parameter + ',
@security_token uniqueidentifier
as

declare @edit_user_id varchar(75)
set @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
if (@edit_user_id is null)
	begin
		raiserror(''Invalid credentials.'',16,1)
		return
	end
'
----=======================
---- Insert z table record
----=======================
--insert into 
--	z_' + @table_name + '
--select 
--	@edit_user_id as z_user_name, 
--	''delete'' as z_action, 
--	getdate() as z_time, 
--	*
--from 
--	' + @table_name + '
--where
--' + @primary_key_where_clause + '
--
--if @@error <> 0
--	begin
--		return
--	end
set @delete_sql = @delete_sql + 
'delete from
	' + @table_name + '
where
' + @primary_key_where_clause + @stamp_where_clause


print(@delete_sql)
print '


'
print('GO')
print '


'
GO
PRINT N'Creating Procedure [dbo].[vs_delAccountOrganizationDocument]...';


GO

CREATE procedure [dbo].[vs_delAccountOrganizationDocument]
	@account_id uniqueidentifier,
	@organization_id uniqueidentifier,
	@doc_id uniqueidentifier,
	@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)	

-- update before the delete so that the delete user can be known
update 
	account_organization_documents 
set 
	modifier = @active_user_id,
	modified_date = GETDATE()
where
	account_id = @account_id 
	and organization_id = @organization_id
	and doc_id = @doc_id	 

delete
	account_organization_documents
where
	account_id = @account_id
	and organization_id = @organization_id
	and doc_id = @doc_id
GO
PRINT N'Creating Procedure [dbo].[vs_delAccountOrganizationUserProfilePlan]...';


GO
CREATE procedure [dbo].[vs_delAccountOrganizationUserProfilePlan]
	@account_id uniqueidentifier,
	@organization_id uniqueidentifier,
	@user_id uniqueidentifier,
	@community_name varchar(50),
	@series varchar(50),
	@plan_name varchar(50),
	@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)	

-- update first to track the delete user
update 
	account_organization_user_profile_plan
set 
	modifier = @active_user_id,
	modified_date = GETDATE()
where
	account_id = @account_id
	and organization_id = @organization_id
	and [USER_ID] = @user_id
	and community_name = @community_name
	and series = @series
	and plan_name = @plan_name

delete
	account_organization_user_profile_plan
where
	account_id = @account_id
	and organization_id = @organization_id
	and [user_id] = @user_id
	and community_name = @community_name
	and series = @series
	and plan_name = @plan_name
GO
PRINT N'Creating Procedure [dbo].[vs_delAccountOrganizationUserProfilePlanCatalogSessionsDocuments]...';


GO
CREATE procedure [dbo].[vs_delAccountOrganizationUserProfilePlanCatalogSessionsDocuments]
@session_id uniqueidentifier,
@security_token uniqueidentifier

/*
vs_delAccountOrganizationUserProfilePlanCatalogSessionsDocuments '3E5AD6BE-3A82-4F45-96EA-083259E0D3CA'
*/

as

--validate token?

delete from [account_organization_user_profile_plan_catalog_sessions_documents]
           
where session_id = @session_id
GO
PRINT N'Creating Procedure [dbo].[vs_delAccountOrganizationUserProfilePlanOptionsBudgetItem]...';


GO
CREATE procedure [dbo].[vs_delAccountOrganizationUserProfilePlanOptionsBudgetItem]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier,
@community varchar(50),
@series varchar(50),
@plan_name varchar(50),
@application_name varchar(50),
@product_name varchar(50),
@area varchar(100),
@sub_area varchar(50),
@item_no varchar(100),
@item_name varchar(1200),
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update
	account_organization_user_profile_plan_options_budget_items
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	account_id = @account_id
	and organization_id = @organization_id
	and [user_id] = @user_id
	and [community] = @community
	and series = @series
	and plan_name = @plan_name
	and application_name = @application_name
	and product_name = @product_name
	and area = @area
	and sub_area = @sub_area
	and item_no = @item_no
	and item_name = @item_name
	
delete account_organization_user_profile_plan_options_budget_items
where 
	account_id = @account_id
	and organization_id = @organization_id
	and [user_id] = @user_id
	and [community] = @community
	and series = @series
	and plan_name = @plan_name
	and application_name = @application_name
	and product_name = @product_name
	and area = @area
	and sub_area = @sub_area
	and item_no = @item_no
	and item_name = @item_name
GO
PRINT N'Creating Procedure [dbo].[vs_delAccountOrganizationUserProfilePlanOptionsBudgetItemsAll]...';


GO

CREATE procedure [dbo].[vs_delAccountOrganizationUserProfilePlanOptionsBudgetItemsAll]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier,
@community varchar(50),
@series varchar(50),
@plan_name varchar(50),
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

--update first to track delete user
update 
	account_organization_user_profile_plan_options_budget_items
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	account_id = @account_id
	and organization_id = @organization_id
	and [user_id] = @user_id
	and [community] = @community
	and series = @series
	and plan_name = @plan_name

delete account_organization_user_profile_plan_options_budget_items
where 
	account_id = @account_id
	and organization_id = @organization_id
	and [user_id] = @user_id
	and [community] = @community
	and series = @series
	and plan_name = @plan_name
GO
PRINT N'Creating Procedure [dbo].[vs_delAccountOrganizationUserWishListItem]...';


GO
CREATE procedure [dbo].[vs_delAccountOrganizationUserWishListItem]

@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier,
@wishlist_item_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update 
	account_organization_user_wishlist_items 
set
	modifier = @active_user_id,
	modified_date = getdate()
where 
	account_id = @account_id
	and organization_id = @organization_id
	and [user_id] = @user_id
	and wishlist_item_id = @wishlist_item_id
	
delete account_organization_user_wishlist_items 
where 
	account_id = @account_id
	and organization_id = @organization_id
	and [user_id] = @user_id
	and wishlist_item_id = @wishlist_item_id
GO
PRINT N'Creating Procedure [dbo].[vs_delCatalogItem]...';


GO

CREATE procedure [dbo].[vs_delCatalogItem]
@row_id uniqueidentifier,
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update 
	catalog_items 
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	account_id = @account_id 
	and organization_id = @organization_id 
	and row_id = @row_id

delete  
	catalog_items 
where 
	account_id = @account_id 
	and organization_id = @organization_id
	and row_id = @row_id
GO
PRINT N'Creating Procedure [dbo].[vs_delCatalogItems]...';


GO
CREATE procedure [dbo].[vs_delCatalogItems]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@email varchar(100),
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update
	catalog_items
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where
	account_id = @account_id
	and organization_id = @organization_id
	
--========================
-- Delete data
--========================
delete from
	catalog_items
where
	account_id = @account_id
	and organization_id = @organization_id
GO
PRINT N'Creating Procedure [dbo].[vs_delCatalogSelectionAreaDetail]...';


GO

CREATE procedure [dbo].[vs_delCatalogSelectionAreaDetail]
@session_id uniqueidentifier,
@application varchar(100),
@product varchar(100), 
@area varchar(100) = '',
@sub_area varchar(100) = '',
@item_type varchar(20),
@item_id varchar(50),
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update
	[catalog_selections_area_details]
set
	modifier = @active_user_id,
	modified_date = GETDATE()
WHERE
	[session_id] = @session_id
	and [application] = @application
	and [product] = @product
	and [area] = @area
	and [sub_area] = @sub_area
	and [item_type] = @item_type
	and [item_id] = @item_id

delete
	[catalog_selections_area_details]
WHERE
	[session_id] = @session_id
	and [application] = @application
	and [product] = @product
	and [area] = @area
	and [sub_area] = @sub_area
	and [item_type] = @item_type
	and [item_id] = @item_id


--delete options added 12/17/2014 -ADG
delete
	[catalog_selections_area_detail_options]
WHERE
	[session_id] = @session_id
	and [application] = @application
	and [product] = @product
	and [area] = @area
	and [sub_area] = @sub_area
	and [item_type] = @item_type
	and [item_id] = @item_id
GO
PRINT N'Creating Procedure [dbo].[vs_delCatalogSelectionAreaDetails]...';


GO


CREATE procedure [dbo].[vs_delCatalogSelectionAreaDetails]
@session_id uniqueidentifier,
@application varchar(100),
@product varchar(100), 
@area varchar(100) = '',
@sub_area varchar(100) = '',
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update
	[catalog_selections_area_details]
set
	modifier = @active_user_id,
	modified_date = GETDATE()
WHERE
	[session_id] = @session_id
	and [application] = @application
	and [product] = @product
	and [area] = @area
	and [sub_area] = @sub_area
	
delete
	[catalog_selections_area_details]
WHERE
	[session_id] = @session_id
	and [application] = @application
	and [product] = @product
	and [area] = @area
	and [sub_area] = @sub_area
GO
PRINT N'Creating Procedure [dbo].[vs_delCatalogSelections]...';


GO
CREATE procedure [dbo].[vs_delCatalogSelections]
@session_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user 

update 
	catalog_selections_area_details
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where
	session_id = @session_id

delete 
	catalog_selections_area_details
where
	session_id = @session_id


update 
	catalog_selections_areas
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where
	session_id = @session_id

delete catalog_selections_areas
where
	session_id = @session_id


update 
	catalog_selections_group_detail 
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	session_id = @session_id

delete from catalog_selections_group_detail 
where 
	session_id = @session_id
	

update
	catalog_selections 
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where
	session_id = @session_id
	
delete
	catalog_selections 
where
	session_id = @session_id


update
	account_organization_user_profile_plan_catalog_sessions
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where
	session_id = @session_id
	
delete 	
	account_organization_user_profile_plan_catalog_sessions
where
	session_id = @session_id
GO
PRINT N'Creating Procedure [dbo].[vs_delInvoice]...';


GO

CREATE procedure [dbo].[vs_delInvoice]
@invoice_id int,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update
	invoice_lines
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	invoice_id = @invoice_id

delete invoice_lines
where invoice_id = @invoice_id

update
	invoices 
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	invoice_id = @invoice_id

delete invoices 
where invoice_id = @invoice_id
GO
PRINT N'Creating Procedure [dbo].[vs_delProfilePlanDoc]...';


GO
CREATE procedure [dbo].[vs_delProfilePlanDoc]
    @account_id uniqueidentifier,
    @organization_id uniqueidentifier,
    @user_id uniqueidentifier,
    @community_id int = 0,
    @community_name varchar(50),
    @series varchar(50),
    @plan_name varchar(50),
    @doc_id uniqueidentifier,
    @security_token uniqueidentifier = null
as
/* 
    ========================================================
    Updated by Shelby Mansker on 10/21/2014 
        - community_id is no longer used to look up and store the documents.
        instead, it needs to use community_name. The DataAccessCommon function
        was already sending out community_name and not community_id, which
        was causing an error all the way up to production.
    ========================================================
*/


declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update 
	account_organization_user_profile_plan_documents
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	account_id = @account_id
	and organization_id = @organization_id
	and [user_id] = @user_id
	and community_name = @community_name
	and series = @series
	and plan_name = @plan_name
	and doc_id = @doc_id
	  
delete 
    account_organization_user_profile_plan_documents
where 
    account_id = @account_id
	and organization_id = @organization_id
	and [user_id] = @user_id
	and community_name = @community_name
	and series = @series
	and plan_name = @plan_name
	and doc_id = @doc_id
GO
PRINT N'Creating Procedure [dbo].[vs_delReport]...';


GO
CREATE procedure [dbo].[vs_delReport]
@storage_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update 
	report_storage 
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	storage_id = @storage_id

delete report_storage where storage_id = @storage_id
GO
PRINT N'Creating Procedure [dbo].[vs_delSchedulingAppointmentTemplate]...';


GO
CREATE PROCEDURE [dbo].[vs_delSchedulingAppointmentTemplate]
@account_org_id uniqueidentifier,
@template_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id =  dbo.ef_getUserEmailFromSecurityToken(@security_token)

--remove child records first

-- update first to track delete user
update 
	scheduling_appointment_templates_detail 
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	template_appointment_id = @template_id 

-- remove records
delete from scheduling_appointment_templates_detail 
where template_id = @template_id

--remove parent records

--update first to track delete user
update 
	scheduling_appointment_templates 
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	template_id = @template_id 

-- remove records
delete from scheduling_appointment_templates 
where template_id = @template_id
and account_org_id = @account_org_id
GO
PRINT N'Creating Procedure [dbo].[vs_delSchedulingAppointmentTemplateDetail]...';


GO
CREATE procedure [dbo].[vs_delSchedulingAppointmentTemplateDetail]
@template_appointment_id uniqueidentifier ,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update 
	scheduling_appointment_templates_detail 
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	template_appointment_id = @template_appointment_id 

-- select * from scheduling_organization_appointment_templates
-- testing: 
-- vs_delSchedulingAppointmentTemplateAppointment 
delete from scheduling_appointment_templates_detail 
where template_appointment_id = @template_appointment_id
GO
PRINT N'Creating Procedure [dbo].[vs_delSchedulingBuyerContact]...';


GO
CREATE PROCEDURE [dbo].[vs_delSchedulingBuyerContact]
    @contact_id uniqueidentifier,
    @security_token uniqueidentifier = null
as
/* 
    ========================================================
    Delete scheduling buyers contact information
    ========================================================
*/


declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete contact
update 
    scheduling_buyers_contacts
    set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	contact_id = @contact_id

-- delete scheduling buyer contact
delete from 
scheduling_buyers_contacts 
where contact_id = @contact_id
GO
PRINT N'Creating Procedure [dbo].[vs_delSchedulingOrganizationLocation]...';


GO
CREATE procedure [dbo].[vs_delSchedulingOrganizationLocation] 
@account_org_id uniqueidentifier, 
@location_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update
	VeoSolutionsSecurity_account_organization_locations 
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	account_org_id = @account_org_id 
	and location_id = @location_id
	
delete 
	VeoSolutionsSecurity_account_organization_locations 
where 
	account_org_id = @account_org_id 
	and location_id = @location_id
GO
PRINT N'Creating Procedure [dbo].[vs_delSchedulingUserLanguage]...';


GO
CREATE procedure [dbo].[vs_delSchedulingUserLanguage]
@user_id uniqueidentifier, 
@language varchar(100),
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update 
	veosolutionssecurity_users_languages
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where
	user_id = @user_id 
	and language = @language	
-- vs_selSchedulingUserLanguages '0e4c3d85-5acf-4d8c-af40-a5e33715ed8b'

delete from  
veosolutionssecurity_users_languages
where
user_id = @user_id 
and 
language = @language
GO
PRINT N'Creating Procedure [dbo].[vs_delSchedulingUserLocation]...';


GO
CREATE procedure [dbo].[vs_delSchedulingUserLocation]
@user_id uniqueidentifier, 
@location_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update
	scheduling_user_locations 
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	user_id = @user_id and location_id = @location_id 

-- testing 
-- select * from  veosolutionssecurity.dbo.locations
-- vs_selSchedulingUserLocations
delete from 
scheduling_user_locations 
where user_id = @user_id and location_id = @location_id
GO
PRINT N'Creating Procedure [dbo].[vs_delSchedulingUserOrganization]...';


GO
CREATE procedure [dbo].[vs_delSchedulingUserOrganization] 
@user_id uniqueidentifier, 
@account_org_id uniqueidentifier ,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update
	scheduling_user_organizations 
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	user_id = @user_id 
	and account_org_id = @account_org_id 

delete 
from 
scheduling_user_organizations 
where 
user_id = @user_id 
and 
account_org_id = @account_org_id
GO
PRINT N'Creating Procedure [dbo].[vs_delSchedulingUserRole]...';


GO
CREATE procedure [dbo].[vs_delSchedulingUserRole]
@user_id uniqueidentifier, 
@role_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update
	scheduling_user_roles
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	user_id = @user_id 
	and role_id = @role_id  
	

-- select * from scheduling_user_work_schedules
delete from 
scheduling_user_roles
where 
user_id = @user_id 
and role_id = @role_id
GO
PRINT N'Creating Procedure [dbo].[vs_delSchedulingUserWorkSchedules]...';


GO
CREATE procedure [dbo].[vs_delSchedulingUserWorkSchedules]
@user_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update
	scheduling_user_work_schedules
set
	modifier = @active_user_id,
	modified_date = GETDATE()	
where 
	user_id = @user_id 

-- select * from scheduling_user_work_schedules
delete from 
scheduling_user_work_schedules
where user_id = @user_id
GO
PRINT N'Creating Procedure [dbo].[vs_devUpdateCompletedPlans]...';


GO
CREATE procedure [dbo].[vs_devUpdateCompletedPlans] 
@account_id uniqueidentifier = null, 
@org_id uniqueidentifier = null, 
@select_only bit = 1
as

-- manually update all profile plan records where CONTRACTED, having at least 1 catalog session record, and where ALL catalog sessions are COMPLETE (status 2). 

-- testing 
-- vs_devUpdateCompletedPlans 'BAB32B7E-3ADA-497C-862E-E5083971CC59', '655A4CD0-32F7-4265-A13F-783782FCA7A8', 1
-- vs_devUpdateCompletedPlans null, null, 1
-- DEV DATA: 
-- select * from veosolutionssecurity.dbo.organizations  
-- Taylor Morrison Houston org 
-- 655A4CD0-32F7-4265-A13F-783782FCA7A8
-- Contempo 
-- '577BFBA0-4089-4229-BAA1-EE84C85A4D1F'

-- select * from veosolutionssecurity.dbo.account_organizations where organization_id =  '655A4CD0-32F7-4265-A13F-783782FCA7A8'  
-- Account Org Id 
-- 'B332BCF7-7FDC-44A7-9668-F9FF99FD215C'

-- select distinct status from account_organization_user_profile_plan

declare @profiles table 
( 
	acct uniqueidentifier, 
	org uniqueidentifier, 
	[user_id] uniqueidentifier, 
	profile_id uniqueidentifier, 
	community_name varchar(50), 
	series varchar(50), 
	plan_name varchar(50) 
) 

insert into @profiles 
select 
pp.account_id, pp.organization_id, pp.user_id, pp.profile_id, pp.community_name, pp.series, pp.plan_name 
from account_organization_user_profile_plan pp
join account_organization_user_profile_plan_catalog_sessions s on s.account_id = pp.account_id and s.organization_id = pp.organization_id and s.user_id = pp.user_id and s.community_name = pp.community_name and s.series = pp.series and s.plan_name = pp.plan_name 
where 
(pp.account_id = @account_id or @account_id is null) 
and (pp.organization_id = @org_id or @org_id is null) 
and pp.status = 'Contracted' 
--and pp.user_id = 'A4066620-2AFB-4706-AD94-05C51884E6E9'
and not exists(select 1 from account_organization_user_profile_plan_catalog_sessions s2 where s2.account_id = pp.account_id and s2.organization_id = pp.organization_id and s2.user_id = pp.user_id and s2.community_name = pp.community_name and s2.series = pp.series and s2.plan_name = pp.plan_name and status in (0,1)  )


if (@select_only <> 1) 
begin 

begin transaction 

update account_organization_user_profile_plan
set status = 'Complete' 
where profile_id in (select profile_id from @profiles) 

commit transaction 

end 

select * from @profiles
GO
PRINT N'Creating Procedure [dbo].[vs_dismissSchedulingMessage]...';


GO
CREATE procedure [dbo].[vs_dismissSchedulingMessage]
@message_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user

update 
	scheduling_messages 
set 
	dismissed = 1,
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	message_id= @message_id
GO
PRINT N'Creating Procedure [dbo].[vs_fixMissingBuildIdsInSessionCatalogSelections]...';


GO
-- =============================================
-- Author:		Shelby Mansker
-- Create date: 9/17/2014
-- Description:	This stored procedure is designed to fix a bug in veoSolutions that
--  wasn't setting build ids properly in the catalog_selections table. At the time of writing,
--  were aren't sure what is causing this problem. Passing a session id to this procedure
--  will add the missing build ids to the session.
-- =============================================
CREATE PROCEDURE [dbo].[vs_fixMissingBuildIdsInSessionCatalogSelections] 
	@session_id UNIQUEIDENTIFIER
AS
BEGIN
	UPDATE cs
        SET cs.build_id = csa.build_id
    FROM
        dbo.catalog_selections cs with (nolock)
        JOIN catalog_selections_areas csa with (nolock) ON csa.session_id = cs.session_id AND csa.[application] = cs.[application] AND csa.product = cs.product AND csa.area = cs.area AND csa.sub_area = cs.sub_area
    WHERE
        cs.session_id = @session_id
        AND cs.[source] = 'prices landed'
        AND cs.item_type <> 'custom'
        AND cs.build_id = 0
END
GO
PRINT N'Creating Procedure [dbo].[vs_getActiveSessionIDFromProfilePlan]...';


GO
/*
	Modified 10/25/2019 - Eric Hickey
		No longer return profile plans that are 'Active', as that status has been merged with 'Contracted'
*/

CREATE procedure [dbo].[vs_getActiveSessionIDFromProfilePlan]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier,
@community varchar(50),
@series varchar(50),
@plan varchar(50)

as

/*

vs_getActiveSessionIDFromProfilePlan 'bab32b7e-3ada-497c-862e-e5083971cc59','577bfba0-4089-4229-baa1-ee84c85a4d1f','424059bc-e4c9-4f21-bdc2-52e5a24bf9ae','LAKES OF PINE FOREST','NONE','BANDERA'

*/

declare @prospective_status_feature int
set @prospective_status_feature = 20
create table #available_profile_plan_statuses
( status varchar(15) )

insert into	#available_profile_plan_statuses
values ('Contracted')

-- also include 'prospective' if the Prospective Status Feature is on
if ([dbo].vdsf_isOrganizationFeatureOn(@organization_id, @prospective_status_feature) = 1)
	begin
		insert into #available_profile_plan_statuses
		values ('Active')
	end

select 
	top 1
	s.session_id
from account_organization_user_profile_plan p with (nolock)

left join account_organization_user_profile_plan_catalog_sessions s with (nolock) on
	s.account_id = p.account_id and
	s.organization_id = p.organization_id and
	s.user_id = p.user_id and
	s.community_name = p.community_name and
	s.series = p.series and
	s.plan_name = p.plan_name

where p.account_id = @account_id and
	p.organization_id = @organization_id and
	p.user_id = @user_id and 
	p.status = (select status from #available_profile_plan_statuses) and
	s.status in (1,2) -- only active or completed
order by s.status asc,s.completed_date desc
GO
PRINT N'Creating Procedure [dbo].[vs_getAddressIDForAccountOrganizationUser]...';


GO
CREATE procedure vs_getAddressIDForAccountOrganizationUser
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier
as
/*

vs_getAddressIDForAccountOrganizationUser 'BAB32B7E-3ADA-497C-862E-E5083971CC59','577BFBA0-4089-4229-BAA1-EE84C85A4D1F','424059BC-E4C9-4F21-BDC2-52E5A24BF9AE'

*/

--todo: Need to limit address id's to exoctic slabs only.

select 
	address_id
from account_organization_user_profile_plan_catalog_sessions
where 
	account_id = @account_id
	and organization_id = @organization_id
	and user_id = @user_id
	and address_id != 0

order by create_date desc
GO
PRINT N'Creating Procedure [dbo].[vs_getBuilderMarkupHBPricingFromSession]...';


GO
create procedure vs_getBuilderMarkupHBPricingFromSession
@session_id uniqueidentifier
as
/*
vs_getBuilderMarkupHBPricingFromSession '77ba7505-7efa-4ced-bf18-2aa935a573c4'
*/

select 
	isnull(o.builder_markup_hb_pricing,0) as builder_markup_hb_pricing
from account_organization_user_profile_plan_catalog_sessions s with (nolock)
left join vss_organizations o with (nolock) on o.organization_id = s.organization_id
where session_id = @session_id
GO
PRINT N'Creating Procedure [dbo].[vs_getCatalogCommunities]...';


GO
CREATE procedure [dbo].[vs_getCatalogCommunities]
@account_id uniqueidentifier,
@organization_id uniqueidentifier
as
/*
vs_getCatalogCommunities 'BAB32B7E-3ADA-497C-862E-E5083971CC59','41E2B9CA-9B05-4C7A-9994-8DBD48660FF9'

*/

select 
	distinct community
from catalog_items
where account_id = @account_id and organization_id = @organization_id and community != 'All'
GO
PRINT N'Creating Procedure [dbo].[vs_getCatalogCommunitySeries]...';


GO
CREATE procedure vs_getCatalogCommunitySeries

@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@community varchar(50)
as
/*
vs_getCatalogCommunitySeries 'BAB32B7E-3ADA-497C-862E-E5083971CC59','41E2B9CA-9B05-4C7A-9994-8DBD48660FF9','Villas of Stoney Hollow'

*/

select 
	distinct series
from catalog_items
where account_id = @account_id 
		and organization_id = @organization_id 
		and community = @community
GO
PRINT N'Creating Procedure [dbo].[vs_getCatalogCommunitySeriesPlans]...';


GO
CREATE procedure vs_getCatalogCommunitySeriesPlans

@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@community varchar(50),
@series varchar(50)
as
/*
vs_getCatalogCommunitySeriesPlans 'BAB32B7E-3ADA-497C-862E-E5083971CC59','41E2B9CA-9B05-4C7A-9994-8DBD48660FF9','Villas of Stoney Hollow','Ryland 1'

*/

select 
	distinct [plan]
from catalog_items
where account_id = @account_id 
		and organization_id = @organization_id 
		and community = @community
		and series =@series
GO
PRINT N'Creating Procedure [dbo].[vs_getCatalogResultCount]...';


GO
CREATE procedure [dbo].[vs_getCatalogResultCount]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@community varchar(100)='',
@series varchar(100)='',
@plan varchar(100)= ''

as
/*

vs_getCatalogResultCount 'BAB32B7E-3ADA-497C-862E-E5083971CC59','78D12721-C3D5-4067-9E89-9B4C32A8CDA2','','All',''

*/



select COUNT(*) as matching_items
from catalog_items 
where organization_id = @organization_id 
	  and account_id = @account_id 
	  and (community = @community or community= 'All')
	  and (series = @series or series = 'All')
	  and ([plan] = @plan or [plan] = 'All')
GO
PRINT N'Creating Procedure [dbo].[vs_getSelectionsReportInfo]...';


GO
CREATE procedure [dbo].[vs_getSelectionsReportInfo]      
@session_id uniqueidentifier      
as      
/*  
HISTORY:
- added buyer signature fields - RH 06/25/14
- added the construction sort order - RIG 20140724

select top 1 * from account_organization_user_profile_plan_catalog_sessions where status = 2
vs_getSelectionsReportInfo '00939613-8AC0-4567-9CE3-D730B3B38AFC'
vs_getSelectionsReportInfo '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2'  
vs_getUserSelectedCatalogSelections '9be70a75-1538-4e4f-b54f-e8e12d4d4cb2'  
vs_selCatalogSelectionAreas '9be70a75-1538-4e4f-b54f-e8e12d4d4cb2'  
*/     
select       
	isnull(vu.first_name,'') + ' '+ isnull(vu.last_name,'') as buyer_name,      
	s.community_id,
	aoupp.community_name as community,  
	aoupp.series as series,  
	aoupp.plan_name as plan_name,  
	s.plan_version,
	--aoupp.catalog_session_date, -- profile plan session date might not be right so use actual session create date 10/17/12 ADG  
	s.create_date as catalog_session_date,      
	aoupp.[address],
	aoupp.property_desc_1,
	aoupp.property_desc_2,
	aoupp.block,
	aoupp.lot,
	vo.name as builder_name,    
	aoupp.sales_price,  
	aoupp.sales_options,  
	aoupp.upgrades_incentive,  
	aoupp.additional_design_deposit,  
	aoupp.deposit_notes,  
	s.status,  
	s.designer,  
	aoupp.elevation,
	aoupp.job_no,  
	vo.show_home_price_on_report,
	s.buyer_signature, 
	s.buyer_signature_date
from     
	account_organization_user_profile_plan_catalog_sessions s with (nolock)  
	left join account_organization_user_profile_plan aoupp with (nolock) on s.account_id = aoupp.account_id and s.organization_id = aoupp.organization_id and s.user_id = aoupp.user_id and s.community_name = aoupp.community_name and s.series = aoupp.series and s.plan_name = aoupp.plan_name and s.session_id = @session_id    
	left join account_organization_user_profile aoup with(nolock) on aoup.account_id = aoupp.account_id and aoup.organization_id = aoupp.organization_id and aoup.user_id = aoupp.user_id 
	left join vss_users vu with (nolock) on vu.user_id = aoup.user_id      
	left join vss_organizations vo with (nolock) on vo.organization_id = aoupp.organization_id      
where     
	s.session_id = @session_id
GO
PRINT N'Creating Procedure [dbo].[vs_getSelectionStatus]...';


GO
create procedure vs_getSelectionStatus
@session_id uniqueidentifier
as
/*
vs_getSelectionStatus '6d50ca71-cd49-4843-ac82-357faf7df9f7'
*/


if exists(
select 
	*
from account_organization_user_profile_plan_catalog_sessions with (nolock)
where 
	session_id = @session_id
	and status = 2)
begin
	--print 'true'
	select 1
end
else 
begin
	--print 'false'
    select 0
end
GO
PRINT N'Creating Procedure [dbo].[vs_getSessionPlanInfo]...';


GO

CREATE procedure [dbo].[vs_getSessionPlanInfo]  
@session_id uniqueidentifier  
as  
  
/*  
vs_getSessionPlanInfo 'd5a727af-9465-4f40-88ad-4017d4d4897b'  
*/  
  
--if exists(select top 1 * from catalog_selections where session_id = @session_id and build_id > 0) -- check to make sure catalog has build_id if not cannot lookup actual plan/revision  
--begin  
-- select top 1  
--	s.spec_id,
--	s.effective_date,  
--	s.plan_name,  
--	s.plan_version as revision,
--	o.external_organization_id as builder_id  
-- from 
--	account_organization_user_profile_plan_catalog_sessions s with (nolock)
--	left join catalog_selections cs with (nolock) on cs.session_id = s.session_id
--	left join vss_organizations o with (nolock) on o.organization_id = s.organization_id  
-- where 
--	s.session_id = @session_id 
--	and cs.source = 'Prices Landed'  
--end  
--else  
--begin  
 select top 1 
	s.spec_id,  
	s.effective_date,  
	s.plan_name,  
	s.plan_version as revision,  
	s.pricing_generated,
	s.pricing_published,
	o.external_organization_id as builder_id,
	s.create_date 
 from 
	account_organization_user_profile_plan_catalog_sessions s with (nolock)  
    left join vss_organizations o with (nolock) on o.organization_id = s.organization_id    
 where 
	s.session_id = @session_id  
--end  
GO
PRINT N'Creating Procedure [dbo].[vs_getUserCatalogSelections]...';


GO
CREATE procedure [dbo].[vs_getUserCatalogSelections]
@session_id uniqueidentifier
as
/*

*/


select 
	isnull(bs.contract_sort_order,9999999) as sort_order,
	cs.*,
	isnull(rg.description,'') as room_group,
	isnull(rg.sort_order,9999999) as room_group_sort_order,
	doc_count = (select count(*) from gpc_products_documents with (nolock) where gpc_id = try_convert(uniqueidentifier,cs.gpc) )

from 
	catalog_selections cs with (nolock)
	left join veo_areas va with (nolock) on va.area_id = cs.area_id
	left join veo_room_groups rg with (nolock) on rg.code = va.room_group
	left join Veo_applications a with (nolock) on a.name = cs.application
	left join Veo_products p with (nolock) on p.name = cs.product
	left join account_organization_user_profile_plan_catalog_sessions s with (nolock) on s.session_id = cs.session_id
	left join Veo_builder_styles bs with (nolock) on 
		bs.spec_id = s.spec_id 
		and bs.application_id = a.application_id
		and bs.product_id = p.product_id
		and bs.item_type = cs.item_type
		and bs.item = cs.item_no
		and bs.effective_date = s.effective_date 
	left join catalog_selections_areas csa with (nolock) on
		csa.session_id = cs.session_id
		and csa.application = cs.application
		and csa.product = cs.product
		and csa.area = cs.area
		and csa.sub_area = cs.sub_area
		and csa.area_id = cs.area_id
		and csa.sub_area_id = cs.sub_area_id
where 
	cs.session_id = @session_id
	and ((cs.source != 'Prices Landed') or (cs.source = 'Prices Landed' and csa.area_selected = 1 ) ) --added to remove any items for areas that are not selected in struct options -5/16/13 ADG
GO
PRINT N'Creating Procedure [dbo].[vs_getUserSelectedCatalogSelections]...';


GO
CREATE procedure [dbo].[vs_getUserSelectedCatalogSelections]
@session_id uniqueidentifier
as

	/*
		vs_getUserSelectedCatalogSelections 'e89b2ce4-8606-421f-8c5d-b9102cff07bb'
		select * from account_organization_application_product_sort_order
		insert into account_organization_application_product_sort_order (account_id, organization_id, application, product, sort_order) values ('bab32b7e-3ada-497c-862e-e5083971cc59','577bfba0-4089-4229-baa1-ee84c85a4d1f','Appliances','Combination Ovens', 350100)
	*/
select 
	--cs.*,
	 cs.[session_id]
      ,cs.[row_id]
      ,cs.[account_id]
      ,cs.[organization_id]
      ,cs.[community]
      ,cs.[series]
      ,cs.[plan]
      ,cs.[application]
      ,cs.[product]
      ,cs.[area]
      ,cs.[area_id]
      ,cs.[sub_area]
      ,cs.[sub_area_id]
      ,cs.[item_type]
      ,cs.[item_no]
      ,replace(replace(cs.[item],char(13),' '),char(10),' ') as item
      ,cs.[vendor]
      ,cs.[standard]
      ,cs.[qty]
      ,cs.[cost]
      ,cs.[price]
      ,cs.[selected]
      ,replace(replace(cs.[notes],char(13),' '),char(10),' ') as notes
      ,cs.[option_pricing_display]
      ,cs.[mutually_exclusive]
      ,cs.[build_data]
      ,cs.[original_build_data]
      ,cs.[source]
      ,cs.[build_id]
      ,cs.[gpc]
      ,cs.[model]
      ,cs.[make_std]
      ,cs.[is_credit]
      ,cs.[author]
      ,cs.[create_date]
      ,cs.[modifier]
      ,cs.[modified_date]
      ,cs.[stamp]
	,isnull(so.sort_order,9999999) as sort_order
from
	catalog_selections cs with (nolock)
	left join account_organization_application_product_sort_order so with (nolock) on so.account_id = cs.account_id and so.organization_id = cs.organization_id and so.application = cs.application and so.product = cs.product
where
	session_id = @session_id
	and selected = 1
order by 
	cs.application,
	cs.product
GO
PRINT N'Creating Procedure [dbo].[vs_importSchedulingBuyersContacts]...';


GO
CREATE procedure [dbo].[vs_importSchedulingBuyersContacts]
@profile_id uniqueidentifier
as

-- create scheduling_buyer_contact records for a buyer profile
-- testing
-- vs_importSchedulingBuyersContacts  'F7A29C0E-7361-4471-8562-AC3D1467EE74'
-- vs_importSchedulingBuyersContacts '05809f0f-7df8-443a-bf44-a303c55dd5bc'
-- vs_importSchedulingBuyersContacts 'CAF34D10-0D41-4750-82A2-C12DC756C7F1'
-- select * from scheduling_buyer_contacts

declare @profile_plan_id uniqueidentifier
select @profile_plan_id = dbo.ef_selSchedulingBuyerActiveProfilePlan(@profile_id)

if @profile_plan_id is null
begin
	return
end

declare @buyer_name varchar(100),
	@email varchar(200),
	@spouse_name varchar(150),
	@country_home_phone varchar(25),
	@home_phone varchar(20),
	@country_work_phone varchar(25),
	@work_phone varchar(20),
	@country_spouse_phone varchar(25),
	@spouse_phone varchar(20),
	@buyer_note varchar(500) = '',
	@other_note varchar(500) = '',
	@primary_phone varchar(20) = ''

select
	@buyer_name = u.first_name + ' ' + u.last_name,
	@email = u.email,
	@spouse_name = case len(pp.spouse_first_name) when 0 then '' else isnull(pp.spouse_last_name,'') + ', ' + isnull(pp.spouse_first_name,'') end,
	@country_home_phone = pp.country_home_phone,
	@home_phone = pp.home_phone,
	@country_work_phone = pp.country_work_phone,
	@work_phone = pp.work_phone,
	@country_spouse_phone = pp.country_spouse_phone,
	@spouse_phone = pp.spouse_phone
from
	account_organization_user_profile_plan pp
	join veosolutionssecurity_users u on u.user_id = pp.user_id
where
	pp.profile_id = @profile_plan_id

if @country_home_phone <> '' and @country_home_phone <> 'North America' and LEN(@home_phone) > 0
begin
	set @buyer_note = @buyer_note + CHAR(13) + CHAR(10) + 'Home Phone : ' + @home_phone
	set @home_phone = ''
end

if @country_work_phone <> '' and @country_work_phone <> 'North America' and LEN(@work_phone) > 0
begin
	set @buyer_note = @buyer_note + CHAR(13) + CHAR(10) + 'Work Phone : ' + @work_phone
	set @work_phone = ''
end

if LEN(@buyer_note) > 0
begin
	set @buyer_note = '-- ORIGINAL PHONE NUMBERS --' + @buyer_note
end

if @country_spouse_phone <> '' and @country_spouse_phone <> 'North America' and LEN(@spouse_phone) > 0
begin
	set @other_note = '-- ORIGINAL PHONE NUMBERS --' + CHAR(13) + CHAR(10) + 'Buyer 2 Phone : ' + @spouse_phone
	set @spouse_phone = ''
end

if @home_phone <> ''
begin
	set @primary_phone = 'home_phone'
end

declare @contacts as table
(
	profile_id uniqueidentifier,
	contact_label varchar(200),
	is_buyer bit,
	contact_role varchar(50),
	email varchar(300),
	mobile_phone varchar(20),
	work_phone varchar(20),
	home_phone varchar(20),
	fax	varchar(20),
	alt1 varchar(200),
	alt2 varchar(200),
	primary_phone varchar(20),
	note varchar(500),
	active bit
)

-- select * from scheduling_buyers_contacts
-- select * from account_organization_user_profile_plan
-- select * from scheduling_buyers
-- select * from veosolutionssecurity_users

-- BUYER
insert into @contacts
select
	@profile_id,
	@buyer_name,
	1,
	'Buyer',
	@email,
	'', -- no mobile phone in this table...
	@work_phone,
	@home_phone,
	'', -- no fax
	'', -- alt1
	'', -- alt2
	@primary_phone,
	@buyer_note, -- note,
	1
	
-- OTHER/SPOUSE
if LEN(@spouse_name) > 0
begin
	insert into @contacts
	select
		@profile_id,
		@spouse_name,
		0,
		'Buyer 2',
		'',
		@spouse_phone,
		'',
		'',
		'', -- no fax
		'', -- alt1
		'', -- alt2
		'',
		@other_note,
		1
end
	
-- SALES CONTACT

if exists (select sales_counselor from account_organization_user_profile_plan where profile_id = @profile_plan_id and len(sales_counselor) > 0 )
begin
	insert into
		@contacts
	select
		@profile_id, 	
		u.first_name + ' ' + u.last_name,
		0,
		'Sales',
		u.email,
		'', -- no mobile phone in this table...
		'',
		'',
		'', -- no fax
		'', -- alt1
		'', -- alt2
		'',
		'', -- note
		1
	from
		account_organization_user_profile_plan pp
		join veosolutionssecurity_users u on u.email = pp.sales_counselor
	where
		pp.profile_id = @profile_plan_id
		and ( u.first_name + ' ' + u.last_name) not in (select contact_label from @contacts)

	if not exists(select * from @contacts where contact_role = 'Sales')
	begin
		insert into
			@contacts
		select
			@profile_id, 	
			pp.sales_counselor,
			0,
			'Sales',
			pp.sales_counselor,
			'', -- no mobile phone in this table...
			'',
			'',
			'', -- no fax
			'', -- alt1
			'', -- alt2
			'',
			'', -- note
			1
		from
			account_organization_user_profile_plan pp
		where
			pp.profile_id = @profile_plan_id
	end
end

-- DESIGNERS
-- select * from scheduling_appointments
if exists (select * from scheduling_appointments where buyer_profile_id = @profile_id  and is_scheduled = 1)
begin
	insert into @contacts
	select
		distinct
		@profile_id, 	
		isnull(u.first_name + ' ' + u.last_name,''),
		0,
		'Designer',
		u.email,
		'', -- no mobile phone in this table...
		'',
		'',
		'', -- no fax
		'', -- alt1
		'', -- alt2
		'',
		'',  -- note
		1
	from
		scheduling_appointments a
		left join veosolutionssecurity_users u on u.user_id = schedule_user_id
	where
		a.buyer_profile_id = @profile_id
		and is_scheduled = 1
		and ( u.first_name + ' ' + u.last_name) not in (select contact_label from @contacts)
end

--select * from @contacts

-- select * from scheduling_buyers_contacts
insert into scheduling_buyers_contacts (
	contact_id, profile_id, contact_label, is_buyer, contact_role, email, mobile_phone, work_phone, home_phone, fax, alt1, alt2, primary_phone, note, active , author, create_date, modifier, modified_date
)
select
	newid(),
	profile_id,
	contact_label,
	is_buyer,
	contact_role,
	email,
	mobile_phone,
	work_phone,
	home_phone,
	fax,
	alt1,
	alt2,
	primary_phone,
	note,
	active,
	'import',
	getdate(),
	'import',
	getdate()
from
	@contacts
where
	contact_label not in (select contact_label from scheduling_buyers_contacts where profile_id = @profile_id)
GO
PRINT N'Creating Procedure [dbo].[vs_insAccountOrganizationDocument]...';


GO

CREATE procedure [dbo].[vs_insAccountOrganizationDocument]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@doc_id uniqueidentifier,
@application varchar(100),
@product varchar(100),
@description varchar(255),
@notes varchar(255),
@size int,
@doc_data varbinary(MAX),
@type varchar(10),
@url varchar(MAX),
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- update first to track delete user
update 
	account_organization_documents 
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where
	account_id = @account_id 
	and organization_id = @organization_id
	and doc_id = @doc_id

delete account_organization_documents where
	account_id = @account_id 
	and organization_id = @organization_id
	and doc_id = @doc_id

insert into account_organization_documents
(account_id, organization_id, doc_id, application, product, description, notes, doc_data, size, type, url, author,modifier)
values 
	(
		@account_id,
		@organization_id,
		@doc_id,
		@application,
		@product,
		@description,
		@notes,
		@doc_data,
		@size,
		@type,
		@url,
		@active_user_id,
		@active_user_id
	)
GO
PRINT N'Creating Procedure [dbo].[vs_insAccountOrganizationUserProfilePlanCatalogSessionsDocument]...';


GO
CREATE procedure [dbo].[vs_insAccountOrganizationUserProfilePlanCatalogSessionsDocument]    
@document_id uniqueidentifier,    
@session_id uniqueidentifier,    
@application_id varchar(10) = 'ALL',    
@product_id varchar(10) = 'ALL',    
@area_id varchar(20) = 'ALLstd',    
@sub_area_id varchar(20) = 'None',    
@document_data varbinary(MAX),    
@security_token uniqueidentifier = NULL,    
@location_id int = 1,    
@document_type varchar(50) = 'Session'    
    
as    
    
declare @active_user_id varchar(100)    
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)    
    
INSERT INTO account_organization_user_profile_plan_catalog_sessions_documents
           (document_id, session_id, application_id, product_id, area_id, sub_area_id, location_id, document_type, document_data, author, create_date, modifier, modified_date)    
     VALUES    
           (@document_id, @session_id, @application_id, @product_id, @area_id, @sub_area_id, @location_id, @document_type, @document_data, @active_user_id, getdate(), @active_user_id, getdate())
GO
PRINT N'Creating Procedure [dbo].[vs_insAccountOrganizationUserProfilePlanOptionsBudgetItem]...';


GO
CREATE procedure [dbo].[vs_insAccountOrganizationUserProfilePlanOptionsBudgetItem]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier,
@community varchar(50),
@series varchar(50),
@plan_name varchar(50),
@application_name varchar(50),
@product_name varchar(50),
@area varchar(100),
@sub_area varchar(50),
@item_no varchar(100),
@item_name varchar(1200),
@qty int = 1,
@source varchar(50),
@price decimal(18,3),
@spec_id INT = NULL,
@effective_date DATETIME = NULL,
@plan_version VARCHAR(50) = NULL,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

set @application_name = ISNULL(@application_name, '')
set @product_name = ISNULL(@product_name, '')
set @area = ISNULL(@area, '')
set @sub_area = ISNULL(@sub_area, '')

-- update first to track delete user
update
	account_organization_user_profile_plan_options_budget_items
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where
	account_id = @account_id
	and organization_id = @organization_id
	and [user_id] = @user_id
	and community = @community
	and series = @series
	and plan_name = @plan_name
	and application_name = @application_name
	and product_name = @product_name
	and area = @area
	and sub_area = @sub_area
	and item_no = @item_no
	and item_name = @item_name
	
delete account_organization_user_profile_plan_options_budget_items where
	account_id = @account_id
	and organization_id = @organization_id
	and [user_id] = @user_id
	and community = @community
	and series = @series
	and plan_name = @plan_name
	and application_name = @application_name
	and product_name = @product_name
	and area = @area
	and sub_area = @sub_area
	and item_no = @item_no
	and item_name = @item_name

insert into account_organization_user_profile_plan_options_budget_items
(account_id, [user_id], organization_id, community, series, plan_name, application_name,
	product_name, area, sub_area,item_no,item_name,qty, price, spec_id, effective_date, plan_version, [source], author, modifier)
values
	(
		@account_id,
		@user_id,
		@organization_id,
		@community,
		@series,
		@plan_name,
		@application_name,
		@product_name,
		@area,
		@sub_area,
		@item_no,
		@item_name,
		@qty,
		@price,
		@spec_id,
		@effective_date,
		@plan_version,
		@source,
		@active_user_id,
		@active_user_id
	)
GO
PRINT N'Creating Procedure [dbo].[vs_insAccountOrganizationUserWishListItem]...';


GO
CREATE procedure [dbo].[vs_insAccountOrganizationUserWishListItem]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier,
@wishlist_item_id uniqueidentifier,
@item_type varchar(50),
@item_no varchar(81),
@description varchar(100)='',
@image_data varbinary(max) = 0,
@notes varchar(max) = '',
@gpc_id varchar(50),
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

insert into account_organization_user_wishlist_items (account_id,organization_id,user_id,wishlist_item_id,item_type,item_no,description,image_data,notes,gpc_id,author,modifier)
	values(@account_id,@organization_id,@user_id,@wishlist_item_id,@item_type,@item_no,@description,@image_data,@notes,@gpc_id,@active_user_id, @active_user_id)
GO
PRINT N'Creating Procedure [dbo].[vs_insCatalogItem]...';


GO

CREATE procedure [dbo].[vs_insCatalogItem]
@row_id uniqueidentifier = null out,
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@community varchar(100) = '',
@series varchar(100) = '',
@plan varchar(100) = '',
@elevation varchar(100)= 'All',
@application varchar(100) = '',
@product varchar(100) = '',
@area varchar(100) = '',
@sub_area varchar(100) = '',
@item_no varchar(100) = '',
@item varchar(max) = '',
@vendor varchar(100) = '',
@standard varchar(200) = '',
@qty decimal(18,4) = 1,
@cost decimal(18,2) = 0,
@price decimal(18,2) = 0,
@selected bit = 0,
@notes varchar(max) = '',
@email varchar(100) = '',
@mutually_exclusive bit,
@option_pricing_display bit,
@gpc varchar(max) = '',
@model varchar(100) = '',  
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

set @row_id = NEWID()

INSERT INTO [catalog_items] (
	[row_id],
	[account_id]
	,[organization_id]
	,[community]
	,[series]
	,[plan]
	,[elevation]
	,[application]
	,[product]
	,[area]
	,[sub_area]
	,[item_no]
	,[item]
	,[vendor]
	,[standard],
	[qty]
	,[cost]
	,[price]
	,[selected]
	,[notes]
	,[mutually_exclusive]
	,[option_pricing_display]
	, gpc
	, model
	,[author]
	,[create_date]
	,[modifier]
	,[modified_date])
VALUES (
	@row_id,
	@account_id,
	@organization_id,
	@community,
	@series,
	@plan,
	@elevation,
	@application,
	@product,
	@area,
	@sub_area,
	@item_no,
	@item,
	@vendor,
	@standard,	
	@qty,
	@cost,
	@price,
	@selected,
	@notes,
	@mutually_exclusive,
	@option_pricing_display,
	@gpc, 
	@model, 
	@active_user_id,
	getdate(),
	@active_user_id,
	getdate() )
GO
PRINT N'Creating Procedure [dbo].[vs_insCatalogSelection]...';


GO


CREATE procedure [dbo].[vs_insCatalogSelection]
@session_id uniqueidentifier,
@row_id uniqueidentifier = null out,
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@community varchar(100),
@series varchar(100),
@plan varchar(100),
@application varchar(100),
@product varchar(100),
@area varchar(100),
@area_id varchar(20)= '',
@sub_area varchar(100),
@sub_area_id varchar(20)='',
@item_type varchar(50),
@item_no varchar(100),
@item varchar(max),
@vendor varchar(100),
@standard varchar(200),
@qty decimal(18,4),
@cost decimal(18,2),
@price decimal(18,2),
@selected bit,
@notes varchar(max),
@source varchar(20),
@build_id int = 0,
@build_data varbinary(max) = null,
@gpc varchar(max) = '', 
@model varchar(100) = '', 
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

set @row_id = NEWID()

INSERT INTO [catalog_selections] (
	[session_id],
    [row_id],
	[account_id],
	[organization_id],
	[community],
	[series],
	[plan],
	[application],
	[product],
	[area],
	[area_id],
	[sub_area],
	[sub_area_id],
	[item_type],
	[item_no],
	[item],
	[vendor],
	[standard],
	[qty],
	[cost],
	[price],
	[selected],
	[notes],
	[source],
    [build_id],
	[build_data],
	[original_build_data],
	gpc, 
	model, 
	author,
	create_date,
	modifier,
	modified_date )
VALUES (
	@session_id,
	@row_id,
	@account_id,
	@organization_id,
	@community,
	@series,
	@plan,
	@application,
	@product,
	@area,
	@area_id,
	@sub_area,
	@sub_area_id,
	@item_type,
	@item_no,
	@item,
	@vendor,
	@standard,
	@qty,
	@cost,
	@price,
	@selected,
	@notes,
	@source,
    @build_id,
	@build_data,
	@build_data,
	@gpc, 
	@model, 
	@active_user_id,
	getdate(),
	@active_user_id,
	getdate() )
GO
PRINT N'Creating Procedure [dbo].[vs_insCatalogSession]...';


GO

CREATE procedure [dbo].[vs_insCatalogSession]  
  
@account_id uniqueidentifier,  
@organization_id uniqueidentifier,  
@user_id uniqueidentifier,  
@community_id int,
@community varchar(50),  
@series varchar(50),  
@plan varchar(50),
@plan_version varchar(50),  
@session_id uniqueidentifier,  
@spec_id int,  
@effective_date datetime,  
@rounding_type int = 0,
@rounding_places int = 2,
@builder_markup_hb_pricing bit = 0,
@security_token uniqueidentifier = null  
as  
  
declare @active_user_id varchar(100)  
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)  
   
insert into     
 account_organization_user_profile_plan_catalog_sessions    
 (account_id,organization_id,[user_id],community_id, community_name,series,plan_name, plan_version, session_id,status,spec_id,effective_date,author,modifier,rounding_type,rounding_places,builder_markup_hb_pricing)    
 values   
 (@account_id,@organization_id,@user_id,@community_id, @community,@series,@plan,@plan_version, @session_id,1,@spec_id,@effective_date,@active_user_id, @active_user_id,@rounding_type,@rounding_places,@builder_markup_hb_pricing)
GO
PRINT N'Creating Procedure [dbo].[vs_insLocation]...';


GO
CREATE procedure [dbo].[vs_insLocation]
@location_id uniqueidentifier,
@name varchar(100),
@address varchar(200),
@phone_number varchar(20),
@location_type varchar(100),
@active bit,
@enable_confirmation bit,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- select * from veosolutionssecurity.dbo.locations
-- INSERT
if not exists(select location_id from veosolutionssecurity_locations where location_id = @location_id)
begin
	insert into veosolutionssecurity_locations
	(location_id, name, [address], [phone_number], location_type, active, enable_confirmation, author, create_date, modifier, modified_date)
	values
	(@location_id, @name, @address, @phone_number, @location_type, @active, @enable_confirmation, @active_user_id, getdate(), @active_user_id, getdate())
end
else
begin
	update
		veosolutionssecurity_locations
	set
		name = @name,
		[address] = @address,
		[phone_number] = @phone_number,
		location_type = @location_type,
		active = @active,
		enable_confirmation = @enable_confirmation,
		modifier = @active_user_id,
		modified_date = GETDATE()
	where
		location_id = @location_id
end
GO
PRINT N'Creating Procedure [dbo].[vs_insProfilePlanDoc]...';


GO
CREATE procedure [dbo].[vs_insProfilePlanDoc]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier,
@community_name varchar(50),
@community_id int=0,
@series varchar(50),
@plan_name varchar(50),
@doc_id uniqueidentifier,
@doc_name varchar(50),
@doc_type varchar(50),
@doc_data varbinary(max)= null,
@doc_notes varchar(50),
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)


if not exists(select * from account_organization_user_profile_plan_documents
			where account_id = @account_id
				  and organization_id = @organization_id
				  and user_id = @user_id
				  and doc_id = @doc_id)
					  
	insert into account_organization_user_profile_plan_documents 
			  (account_id,organization_id,user_id,community_name,community_id,series,plan_name,doc_id,doc_name,doc_data,doc_notes,doc_type,author,create_date,modifier,modified_date)
	   values (@account_id,@organization_id,@user_id,@community_name,@community_id,@series,@plan_name,@doc_id,@doc_name,@doc_data,@doc_notes,@doc_type,@active_user_id,GETDATE(),@active_user_id,GETDATE())
 else
	if @doc_data is null

		update account_organization_user_profile_plan_documents
		set 
			doc_type = @doc_type,
			doc_notes = @doc_notes,
			modifier = @active_user_id,
			modified_date = GETDATE()
		where account_id = @account_id
			and organization_id = @organization_id
			and user_id = @user_id
			and doc_id = @doc_id   
	else
		update account_organization_user_profile_plan_documents
		set 
			doc_type = @doc_type,
			doc_data = @doc_data,
			doc_notes = @doc_notes,
			modifier = @active_user_id,
			modified_date = GETDATE()
		where account_id = @account_id
			and organization_id = @organization_id
			and user_id = @user_id
			and doc_id = @doc_id
GO
PRINT N'Creating Procedure [dbo].[vs_insReport]...';


GO
CREATE procedure [dbo].[vs_insReport]
@storage_id uniqueidentifier,
@report_id varchar(50),
@report_output_type varchar(50),
@binary_data varbinary(max),
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

insert into report_storage (storage_id,report_id,report_output_type,binary_data,author,create_date,modifier,modified_date)
 values (@storage_id,@report_id,@report_output_type,@binary_data,@active_user_id, GETDATE(),@active_user_id, GETDATE())
GO
PRINT N'Creating Procedure [dbo].[vs_insSchedulingAppointmentTemplate]...';


GO
CREATE procedure [dbo].[vs_insSchedulingAppointmentTemplate]
@account_org_id uniqueidentifier, 
@template_id uniqueidentifier,
@template_name varchar(100) ,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

if exists(select template_id from scheduling_appointment_templates where template_id = @template_id) 
begin 

update 
scheduling_appointment_templates
set template_name = @template_name 
where 
template_id = @template_id 

end 
else
begin 
insert into 
scheduling_appointment_templates
(account_org_id, template_id, template_name,author,create_date,modifier,modified_date)
values(@account_org_id, @template_id, @template_name,@active_user_id,GETDATE(),@active_user_id,GETDATE()) 

end
GO
PRINT N'Creating Procedure [dbo].[vs_insSchedulingAppointmentTemplateDetail]...';


GO
CREATE procedure [dbo].[vs_insSchedulingAppointmentTemplateDetail]
@template_id uniqueidentifier,
@template_appointment_id uniqueidentifier, 
@appointment_type int, 
@duration int,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)


insert into scheduling_appointment_templates_detail
(template_id, template_appointment_id, appointment_type, duration,author,create_date,modifier,modified_date) 
values
(@template_id,@template_appointment_id,@appointment_type, @duration,@active_user_id,GETDATE(),@active_user_id,GETDATE())
GO
PRINT N'Creating Procedure [dbo].[vs_insSchedulingBuyerContact]...';


GO
CREATE procedure [dbo].[vs_insSchedulingBuyerContact] 
@contact_id uniqueidentifier, 
@profile_id uniqueidentifier,
@contact_label varchar(200), 
@is_buyer bit = 0, 
@contact_role varchar(50) = '',
@email	varchar(300)='',
@mobile_phone	varchar(20)='',
@work_phone	varchar(20)='',
@home_phone	varchar(20)='',
@mobile_phone_send_message bit = 0,
@work_phone_send_message bit = 0,
@home_phone_send_message bit = 0,
@fax	varchar(20)='',
@alt1	varchar(200)='',
@alt2	varchar(200)='',
@primary_phone varchar(20) = null,
@note	varchar(500)='', 
@active bit=1,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- do insert or update 
if not exists(select contact_label from scheduling_buyers_contacts where contact_id = @contact_id) 
begin 
	insert into scheduling_buyers_contacts 
	(contact_id, profile_id, contact_label, is_buyer, contact_role, email, mobile_phone, work_phone, home_phone, mobile_phone_send_message, work_phone_send_message, home_phone_send_message, fax, alt1, alt2, primary_phone, note, active, author,create_date,modifier,modified_date) 
	values
	( @contact_id, @profile_id, @contact_label, @is_buyer, @contact_role, @email, @mobile_phone, @work_phone, @home_phone, @mobile_phone_send_message, @work_phone_send_message, @home_phone_send_message ,@fax, @alt1, @alt2, @primary_phone, @note, @active,@active_user_id,GETDATE(),@active_user_id,GETDATE()) 
end
else 
begin
	if @primary_phone is not null
	begin
		update 
			scheduling_buyers_contacts
		set
			primary_phone = null
		where 
			profile_id = @profile_id
		and
			primary_phone is not null
	end
	
	update 
		scheduling_buyers_contacts 
	set 
		contact_label = @contact_label, 
		is_buyer = @is_buyer, 
		contact_role = @contact_role,
		email = @email,
		mobile_phone = @mobile_phone,
		work_phone = @work_phone,
		home_phone = @home_phone,
		mobile_phone_send_message = @mobile_phone_send_message,
		work_phone_send_message = @work_phone_send_message,
		home_phone_send_message = @home_phone_send_message,
		fax = @fax,
		alt1= @alt1	,
		alt2 = @alt2,
		primary_phone = @primary_phone,
		note = @note, 
		active= @active,
		modifier = @active_user_id,
		modified_date = GETDATE()
	where
		contact_id = @contact_id
end
GO
PRINT N'Creating Procedure [dbo].[vs_insSchedulingBuyerDefaultAppointments]...';


GO
CREATE procedure [dbo].[vs_insSchedulingBuyerDefaultAppointments] 
@profile_id uniqueidentifier, 
@template_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)


-- find the template 
-- select * from scheduling_appointments where buyer_profile_id = '3E971EFD-92C4-42A5-BE07-8FA228014B6C'
-- select * from scheduling_organization_appointment_templates
-- vs_insSchedulingBuyerDefaultAppointments '2D41E971-73EA-48A6-9A1A-F123A18B829A'
--select 
--	top 1 
--	@template_id =t.template_id,
--	@user_id = pp.user_id   
--from 
--	account_organization_user_profile_plan pp 
--	join veosolutionssecurity_account_organizations o on o.organization_id = pp.organization_id and o.account_id = pp.account_id 
--	join scheduling_organization_appointment_templates t on t.account_org_id = o.account_org_id 
--where
--	pp.profile_id = @profile_id 
	
insert into 
	scheduling_appointments 
	(buyer_profile_id, account_org_id, appointment_template_id, appointment_type, appointment_duration, author,create_date, modifier,modified_date)  
select
	@profile_id, 
	t.account_org_id, 
	d.template_id, 
	d.appointment_type, 
	d.duration,
	@active_user_id,
	GETDATE(),
	@active_user_id,
	GETDATE()
from 
	scheduling_appointment_templates t
	join scheduling_appointment_templates_detail d on d.template_id = t.template_id 
where 
t.template_id = @template_id 

-- update buyer record, set status = 1 which is SETUP 
update 
	scheduling_buyers 
set 
	schedule_status = 1,
	modifier = @active_user_id,
	modified_date = GETDATE()	
where 
	profile_id = @profile_id 


-- TEMPORARY 
-- Store the INITIAL templating date as RECEIVED DATE until i can add to UI 
update 
	scheduling_buyers
set
	received_date = GETDATE() 
where
	received_date is null 
	and profile_id = @profile_id
GO
PRINT N'Creating Procedure [dbo].[vs_insSchedulingOrganization]...';


GO
CREATE procedure [dbo].[vs_insSchedulingOrganization] 
@account_org_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- select * from scheduling_organizations 
-- select o.name, ao.account_org_id, * from veosolutionssecurity.dbo.account_organizations ao join veosolutionssecurity.dbo.organizations o on o.organization_id = ao.organization_id
insert into 
	scheduling_organizations 
	(account_org_id, display_name, author, create_date, modifier, modified_date) 
select
	@account_org_id, 
	o.name ,
	@active_user_id,
	GETDATE(),
	@active_user_id,
	GETDATE()
from 
	veosolutionssecurity_account_organizations ao
	join veosolutionssecurity_organizations o on o.organization_id = ao.organization_id 
where
	ao.account_org_id = @account_org_id
GO
PRINT N'Creating Procedure [dbo].[vs_insSchedulingOrganizationLocation]...';


GO
CREATE procedure [dbo].[vs_insSchedulingOrganizationLocation] 
@account_org_id uniqueidentifier, 
@location_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

 
-- select * from VeoSolutionsSecurity.dbo.account_organizations
-- select * from VeoSolutionsSecurity.dbo.account_organization_locations
insert into 
	veosolutionssecurity_account_organization_locations
	(account_org_id, location_id, author, create_date, modifier, modified_date) 
values
	(@account_org_id, @location_id, @active_user_id, getdate(), @active_user_id, getdate())
GO
PRINT N'Creating Procedure [dbo].[vs_insSchedulingSmsOptIn]...';


GO
CREATE PROCEDURE [dbo].[vs_insSchedulingSmsOptIn]
	@phone_number VARCHAR(25),
	@invite_message NVARCHAR(MAX),
	@invite_date DATETIME2(7),
	@is_pending_confirmation BIT,
	@is_opted_in BIT,
	@confirm_date DATETIME2(7) = NULL,
	@reply_message NVARCHAR(50) = ''
AS

IF EXISTS (SELECT 1 FROM [dbo].[scheduling_sms_opt_in] WHERE [phone_number] = @phone_number)
BEGIN
	RAISERROR('%d already exists.', 16, 1, @phone_number)
	RETURN 
END

INSERT INTO [dbo].[scheduling_sms_opt_in]
(
	[id],
	[phone_number],
	[invite_message],
	[invite_date],
	[is_pending_confirmation],
	[is_opted_in],
	[confirm_date],
	[reply_message]
)
VALUES (
	NEWID(),
	@phone_number,
	@invite_message,
	@invite_date,
	@is_pending_confirmation,
	@is_opted_in,
	@confirm_date,
	@reply_message
)
GO
PRINT N'Creating Procedure [dbo].[vs_insSchedulingUser]...';


GO
CREATE procedure [dbo].[vs_insSchedulingUser]
@user_id uniqueidentifier, 
@import_orgs bit = 0 , 
@import_locations bit = 0 ,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- imports a scheduling user from security 
-- select * from scheduling_users

-- user record 
if not exists(select user_id from scheduling_users where user_id = @user_id) 
begin 
	insert into  
	scheduling_users 
	(user_id, scheduling_enabled, first_name, last_name, email, phone, author, create_date, modifier, modified_date) 
	select 
		user_id, 
		1 as scheduling_enabled, 
		first_name, 
		last_name, 
		email, 
		'',
		@active_user_id,
		GETDATE(),
		@active_user_id,
		GETDATE()
	from 
		veosolutionssecurity_users
	where 
		user_id = @user_id 
end 

-- todo: import orgs & locations 
GO
PRINT N'Creating Procedure [dbo].[vs_insSchedulingUserLanguage]...';


GO
CREATE procedure [dbo].[vs_insSchedulingUserLanguage]
@user_id uniqueidentifier, 
@language varchar(100),
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- vs_selSchedulingUserLanguages '0e4c3d85-5acf-4d8c-af40-a5e33715ed8b'

insert into 
	veosolutionssecurity_users_languages
	(user_id, language, author, create_date, modifier, modified_date)
values
	(@user_id, @language, @active_user_id, GETDATE(), @active_user_id, GETDATE())
GO
PRINT N'Creating Procedure [dbo].[vs_insSchedulingUserLocation]...';


GO
CREATE procedure [dbo].[vs_insSchedulingUserLocation]
@user_id uniqueidentifier, 
@location_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- testing 
-- select * from  veosolutionssecurity.dbo.locations
-- vs_selSchedulingUserLocations
if not exists (select user_id from scheduling_user_locations where user_id = @user_id and location_id = @location_id) 
begin 
	insert into 
	scheduling_user_locations 
		(user_id, location_id, author, create_date, modifier, modified_date) 
	values
		(@user_id, @location_id, @active_user_id, GETDATE(), @active_user_id, GETDATE() )
end
GO
PRINT N'Creating Procedure [dbo].[vs_insSchedulingUserOrganization]...';


GO
CREATE procedure [dbo].[vs_insSchedulingUserOrganization] 
@user_id uniqueidentifier, 
@account_org_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- if we are adding an org to the user for scheduling, go ahead and add it to the scheduling_orgs table 
if not exists (select * from scheduling_organizations where account_org_id = @account_org_id) 
begin 
	declare @display_name varchar(100) 

	select 
		@display_name = o.name 
	from 
		veosolutionssecurity_account_organizations ao
		join  veosolutionssecurity_organizations o on o.organization_id = ao.organization_id 
	--bug found , this was rerturning a random org name since it was selecting all orgs. 4/7/2020 ADG 
	where ao.account_org_id  = @account_org_id

	insert into scheduling_organizations 
		(account_org_id, display_name, author, create_date, modifier, modified_date) 
	values
		(@account_org_id, @display_name, @active_user_id, getdate(), @active_user_id, GETDATE()) 
end

insert into 
	scheduling_user_organizations 
	(user_id, account_org_id, author, create_date, modifier, modified_date) 
values 
	(@user_id, @account_org_id, @active_user_id, GETDATE(), @active_user_id, GETDATE())
GO
PRINT N'Creating Procedure [dbo].[vs_insSchedulingUserRole]...';


GO
CREATE procedure [dbo].[vs_insSchedulingUserRole]
@user_id uniqueidentifier, 
@role_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- vs_insSchedulingUserRoles 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', 'A0A9C6C5-A686-48EB-B125-6901F74AA435'
-- select * from scheduling_user_roles
-- select * from veosolutionssecurity.dbo.users where first_name = 'Robert' 
-- select * from veosolutionssecurity.dbo.app_roles

if not exists (select user_id from scheduling_user_roles where user_id = @user_id and role_id = @role_id) 
begin 
	insert into scheduling_user_roles
		(user_id, role_id, author, create_date, modifier, modified_date) 
	values 
		(@user_id, @role_id, @active_user_id, GETDATE(), @active_user_id, GETDATE()) 
end
GO
PRINT N'Creating Procedure [dbo].[vs_insUpdAccountOrganizationUserProfile]...';


GO

CREATE procedure [dbo].[vs_insUpdAccountOrganizationUserProfile]
	@account_id uniqueidentifier,
	@organization_id uniqueidentifier,
	@user_id uniqueidentifier,
	@interest_rate decimal(18,6),
	@loan_term decimal(18,6) ,
	@completed_steps int ,
	@enable_homebuyer_access bit,
	@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

if not exists(select account_id from account_organization_user_profile where account_id = @account_id and organization_id = @organization_id and [user_id] = @user_id)
	insert into 
		account_organization_user_profile 
	(
		account_id,
		organization_id,
		[user_id],
		--external_builder_id,	
		interest_rate,
		loan_term,
		completed_steps,
		enable_homebuyer_access,
		author,
		create_date,
		modifier,
		modified_date		
	)
	values
	(
		@account_id,
		@organization_id,
		@user_id,
		--@external_builder_id,
		@interest_rate,
		@loan_term,
		@completed_steps,
		@enable_homebuyer_access,
		@active_user_id,
		GETDATE(),
		@active_user_id,
		GETDATE()
	)
else
	update 
		account_organization_user_profile
	set
		--external_builder_id = @external_builder_id,
		interest_rate = @interest_rate,
		loan_term = @loan_term,
		completed_steps = @completed_steps,
		enable_homebuyer_access = @enable_homebuyer_access,
		modifier = @active_user_id,
		modified_date = GETDATE()
	where
		account_id = @account_id
		and organization_id = @organization_id
		and [user_id] = @user_id
GO
PRINT N'Creating Procedure [dbo].[vs_insUpdAccountOrganizationUserProfilePlan]...';


GO
/*
	Modified 10/25/2019 - Eric Hickey
		No longer return profile plans that are 'Active', as that status has been merged with 'Contracted'

	Modified By: Charles Moore
	Date: 9/10/2021
	Description: Convert Lot to string values

	Modified By: Justin Pope
	Date: 11/20/2025
	Description: Changed elevation to VARCHAR(50)

*/


CREATE procedure [dbo].[vs_insUpdAccountOrganizationUserProfilePlan]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier,
@community_name varchar(50),
@series varchar(50),
@plan_name varchar(50),
@base_plan_name varchar(50)='',
@spec_id int,
@sales_price decimal(18,2) = 0,
@sales_options decimal(18,2) = 0,
@upgrades_incentive decimal(18,2) = 0,
@additional_design_deposit decimal(18,2) = 0,
@deposit_notes varchar(255)='',
@home_down_payment decimal(18, 2) = 0,
@home_allowance decimal(18, 2) = 0,
@catalog_session_id uniqueidentifier = null,
@catalog_session_date datetime = null,
@job_no varchar(20) = '',
@address_lot_block varchar(50)= '',
@address varchar(50) = '',
@property_desc_1 varchar(20) = '',
@property_desc_2 varchar(20) = '',
@block varchar(10) = '',
@lot varchar(10) = '',
@city varchar(50) = '',
@state varchar(25) = '',
@zip_code varchar(25) = '',
@sales_counselor varchar(50)='',
@contract_date datetime = null,
@receipt_date datetime = null,
@country_home_phone varchar(25) = 'North America',
@home_phone varchar(20) = '',
@country_work_phone varchar(25) = 'North America',
@work_phone varchar(20) = '',
@spouse_first_name varchar(50)='',
@spouse_last_name varchar(50)='',
@country_spouse_phone varchar(25) = 'North America',
@spouse_phone varchar(20)='',
@status varchar(15),
@echelon_exported bit = 0,
@spec_home	bit = 0,
@job_type	int = 0,
@elevation varchar(50) = '',
@stage varchar(10)='',
@superintendent varchar(50)= '',
@expiration_date datetime = null,
@upgrade_deposit_percentage decimal(18, 2) = null,
@security_token uniqueidentifier = null
as

-- select distinct job_type from account_organization_user_profile_plan
declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

if ISNULL(@base_plan_name, '') = ''
begin
	set @base_plan_name = @plan_name
end

if not exists (select spec_id from account_organization_user_profile_plan where
	account_id = @account_id
	and organization_id = @organization_id
	and [user_id] = @user_id
	and community_name = @community_name
	and series = @series
	and plan_name = @plan_name)
begin
	insert into account_organization_user_profile_plan
	(
		account_id,
		organization_id,
		[user_id],
		community_name,
		series,
		plan_name,
		base_plan_name,
		spec_id,
		sales_price,
		sales_options,
		upgrades_incentive,
		additional_design_deposit,
		deposit_notes,
		home_down_payment,
		home_allowance,
		catalog_session_id,
		catalog_session_date,
		job_no,
		address_lot_block,
		[address] ,
		property_desc_1 ,
		property_desc_2 ,
		block ,
		lot ,
		city,
		state,
		zip_code,
		sales_counselor,
		contract_date,
		receipt_date,
		country_home_phone,
		home_phone,
		country_work_phone,
		work_phone,
		spouse_first_name,
		spouse_last_name,
		country_spouse_phone,
		spouse_phone,
		status,
		echelon_exported,
		spec_home,
		job_type,
		elevation,
		stage,
		superintendent,
		author,
		create_date,
		modifier,
		modified_date,
		expiration_date,
		upgrade_deposit_percentage
	)
	values
	(
		@account_id,
		@organization_id,
		@user_id,
		@community_name,
		@series,
		@plan_name,
		@base_plan_name,
		@spec_id,
		@sales_price,
		@sales_options,
		@upgrades_incentive,
		@additional_design_deposit,
		@deposit_notes,
		@home_down_payment,
		@home_allowance,
		@catalog_session_id,
		@catalog_session_date,
		@job_no,
		@address_lot_block,
		@address,
		@property_desc_1,
		@property_desc_2,
		@block,
		@lot,
		@city,
		@state,
		@zip_code,
		@sales_counselor,
		@contract_date,
		@receipt_date,
		@country_home_phone,
		@home_phone,
		@country_work_phone,
		@work_phone,
		@spouse_first_name,
		@spouse_last_name,
		@country_spouse_phone,
		@spouse_phone,
		@status,
		@echelon_exported,
		@spec_home,
		@job_type,
		@elevation,
		@stage,
		@superintendent,
		@active_user_id,
		GETDATE(),
		@active_user_id,
		GETDATE(),
		@expiration_date,
		@upgrade_deposit_percentage
	)
end
else
begin
	update account_organization_user_profile_plan
	set
		base_plan_name = @base_plan_name,
		spec_id = @spec_id,
		sales_price = @sales_price,
		sales_options = @sales_options,
		upgrades_incentive = @upgrades_incentive,
		additional_design_deposit = @additional_design_deposit,
		deposit_notes = @deposit_notes,
		home_down_payment = @home_down_payment,
		home_allowance = @home_allowance,
		catalog_session_id = @catalog_session_id,
		catalog_session_date = @catalog_session_date,
		job_no = @job_no,
		address_lot_block = @address_lot_block,
		[address] = @address,
		property_desc_1 = @property_desc_1,
		property_desc_2 = @property_desc_2,
		block = @block,
		lot = @lot,
		city = @city,
		state = @state,
		zip_code = @zip_code,
		sales_counselor = @sales_counselor,
		contract_date = @contract_date,
		receipt_date = @receipt_date,
		country_home_phone = @country_home_phone,
		home_phone = @home_phone,
		country_work_phone = @country_work_phone,
		work_phone = @work_phone,
		spouse_first_name = @spouse_first_name,
		spouse_last_name = @spouse_last_name,
		country_spouse_phone = @country_spouse_phone,
		spouse_phone = @spouse_phone,
		status = @status,
		echelon_exported = @echelon_exported,
		spec_home = @spec_home,
		job_type = @job_type,
		elevation = @elevation,
		stage=@stage,
		superintendent=@superintendent,
		modifier = @active_user_id,
		modified_date = GETDATE(),
		expiration_date = @expiration_date,
		upgrade_deposit_percentage = @upgrade_deposit_percentage
	where
		account_id = @account_id
		and organization_id = @organization_id
		and [user_id] = @user_id
		and community_name = @community_name
		and series = @series
		and plan_name = @plan_name

	-- fetch profile id for this plan
	declare @profile_id uniqueidentifier

	select
		@profile_id = profile_id
	from
		account_organization_user_profile
	where
		account_id = @account_id
		and organization_id = @organization_id
		and [user_id] = @user_id


	-- SCHEDULING EXPORT CODE ON CONTRACTED
	if (@status = 'Contracted' and @job_type <> 1)
	begin
		-- select top 10 * from veosolutionssecurity_users
		-- select * from veosolutionssecurity_account_organization_users
		-- select top 10 * from veosolutionssecurity_account_organization_users_roles
	
		-- select top 10 * from account_organization_user_profile_plan
		-- fetch profile plan id
		declare @plan_profile_id uniqueidentifier
	

		select
			@plan_profile_id = profile_id
		from
			account_organization_user_profile_plan
		where
			account_id = @account_id
			and organization_id = @organization_id
			and [user_id] = @user_id
			and community_name = @community_name
			and series = @series
			and plan_name = @plan_name

	
		-- don't import into scheduling if the buyer is already there.
		-- since we have a mixture of user profiles and plan profiles, check both.
		if not exists( select top 1 profile_id from scheduling_buyers where profile_id = @profile_id or profile_id = @plan_profile_id )
		begin
		
			-- is this a HOMEBUYER?
			declare @buyer_name varchar(100)

			set @buyer_name = null
			select
				@buyer_name = ( u.first_name + ' ' + u.last_name)
			from
				veosolutionssecurity_account_organization_users u
				join veosolutionssecurity_account_organization_users_roles_legacy ur on ur.account_id = u.account_id and ur.organization_id = u.organization_id and ur.user_id = u.user_id
				join veosolutionssecurity_roles_legacy r on r.role_id = ur.role_id
			where
				ur.account_id = @account_id
				and ur.organization_id = @organization_id
				and ur.user_id = @user_id
				and r.name = 'Homebuyer'
		
			-- EXIT IF NOT HOMEBUYER
			if (@buyer_name is null) return;

			-- INSERT INTO SCHEDULING
			insert into scheduling_buyers
			(profile_id, schedule_status, buyer_name,is_active, author, create_date, modifier, modified_date)
			values(
				@profile_id,
				0,
				@buyer_name,
				1,
				'export',
				getdate(),
				'export',
				getdate() )

		end
	
	end -- END SCHEDULING EXPORT CODE

	-- DEACTIVATE SCHEDULING BUYERS
	if (@status = 'Bustout' or @status = 'Complete' )
	begin
		
		-- note that i am not really looking for the old buyers where profile_id = profile_plan_id. It is not that important that we deactivate on bustout really,
		-- so i am just updating newer buyers
		-- If no other active plans, deactivate this buyer
		if not exists(
				select profile_id
				from account_organization_user_profile_plan
				where
					account_id = @account_id
					and organization_id = @organization_id
					and [user_id] = @user_id
					AND status IN ('Active', 'Contracted')) -- we can still use 'active' here (until it is completely removed) because organizations that use the Prospective Status Feature will not have any 'active' profile plans
			begin
				
				update
					scheduling_buyers
				set
					is_active = 0
				where
					profile_id = @profile_id

			end

	end -- END DEACTIVATE BUYERS CODE
end
GO
PRINT N'Creating Procedure [dbo].[vs_insupdInvoice]...';


GO
CREATE procedure [dbo].[vs_insupdInvoice]
@invoice_id int = 0,
@reference_id uniqueidentifier,
@reference_type  varchar(50),
@invoice_no varchar(100),
@invoice_date datetime,
@invoice_template varchar(50),
@invoice_customer_id varchar(50),
--@invoice_customer_desc varchar(100),
@invoice_po varchar(100),
@invoice_status varchar(10),
@invoice_ratio decimal(18,4),
@amount decimal(18,2),
@external_invoice_reference varchar(50),
@last_print_date datetime,
@invoice_module varchar(20),
--@invoice_module_data varchar(300),
@invoice_notes text,
@edit_user varchar(100)

as

if (@invoice_id = 0)
begin
	INSERT INTO [invoices]
			   ([reference_id]
			   ,[reference_type]
			   ,[invoice_no]
			   ,[invoice_date]
			   ,[invoice_template]
			   ,[invoice_customer_id]
			   --,[invoice_customer_desc]
			   ,[invoice_po]
			   ,[invoice_status]
			   ,[invoice_ratio]
			   ,[amount]
			   ,[external_invoice_reference]
			   ,[last_print_date]
			   ,[invoice_module]
			   --,[invoice_module_data]
			   ,[invoice_notes]
			   ,[author]
			   ,[create_date]
			   ,[modifier]
			   ,[modified_date])
		 VALUES
		 (
			   @reference_id,
			   @reference_type,
			   @invoice_no,
			   @invoice_date, 
			   @invoice_template,
			   @invoice_customer_id,
			   --@invoice_customer_desc, 
			   @invoice_po, 
			   @invoice_status, 
			   @invoice_ratio, 
			   @amount, 
			   @external_invoice_reference, 
			   @last_print_date,
			   @invoice_module,
			   --@invoice_module_data,
			   @invoice_notes, 
			   @edit_user, 
			   getdate(),
			   @edit_user, 
			   getdate()
			   )

	select scope_identity() as invoice_id

end

else
begin 

	update [invoices]
	set
	
			   [reference_id] = @reference_id
			   ,[reference_type] = @reference_type
			   ,[invoice_no] = @invoice_no
			   ,[invoice_date] = @invoice_date
			   ,[invoice_template] = @invoice_template
			   ,[invoice_customer_id] = @invoice_customer_id
			   --,[invoice_customer_desc]
			   ,[invoice_po] = @invoice_po
			   ,[invoice_status] = @invoice_status
			   ,[invoice_ratio] = @invoice_ratio
			   ,[amount] = @amount
			   ,[external_invoice_reference] = @external_invoice_reference
			   ,[last_print_date] = @last_print_date
			   ,[invoice_module] = @invoice_module
			   --,[invoice_module_data]
			   ,[invoice_notes] = @invoice_notes
			   ,[modifier] = @edit_user
			   ,[modified_date] = getdate()
			   
	where invoice_id = @invoice_id

end
GO
PRINT N'Creating Procedure [dbo].[vs_insupdInvoiceLine]...';


GO

CREATE procedure [dbo].[vs_insupdInvoiceLine]
@invoice_id int,
@line_no int,
@application varchar(50),
@product varchar(50),
@area varchar(255),
@item varchar(255),
@vendor varchar(50),
@line_amount decimal(18,2),
@orig_line_amount decimal(18,2) = 0,
@invoice bit,
@invoice_amount decimal(18,2),
@notes varchar(255),
@edit_user varchar(255)

as

if exists(select invoice_id 
			from invoice_lines 
			where invoice_id = @invoice_id and line_no = @line_no)
			
begin

	update [invoice_lines]
	set
			   [application] = @application
			   ,[product] = @product
			   ,[area] = @area
			   ,[item] = @item
			   ,[vendor] = @vendor
			   ,[line_amount] = @line_amount
			   ,[orig_line_amount]= @orig_line_amount
			   ,[invoice] = @invoice
			   ,[invoice_amount] = @invoice_amount					 
			   ,[notes] = @notes
			   ,[author] = @edit_user
			   ,[create_date] = getdate()
			   ,[modifier] = @edit_user
			   ,[modified_date] = getdate()
			   
	where invoice_id = @invoice_id and line_no = @line_no

			    
end

else

begin
	INSERT INTO [invoice_lines]
			   ([invoice_id]
			   ,[line_no]
			   ,[application]
			   ,[product]
			   ,[area]
			   ,[item]
			   ,[vendor]
			   ,[line_amount]
			   ,[orig_line_amount]
			   ,[invoice]
			   ,[invoice_amount]
			   ,[notes]
			   ,[modifier]
			   ,[modified_date])
		 VALUES
			   (@invoice_id,
			   @line_no, 
			   @application,
			   @product, 
			   @area, 
			   @item, 
			   @vendor, 
			   @line_amount,
			   @orig_line_amount,
			   @invoice, 
			   @invoice_amount, 
			   @notes, 
			   @edit_user, 
			   getdate())
end
GO
PRINT N'Creating Procedure [dbo].[vs_insUpdSchedulingAppointmentConfirmationLog]...';


GO
CREATE PROCEDURE [dbo].[vs_insUpdSchedulingAppointmentConfirmationLog]
	@user_id UNIQUEIDENTIFIER,
	@log_date DATE,
	@duration_increment INT
AS
IF EXISTS (
	SELECT
		1
	FROM
		scheduling_appointment_confirmation_log l WITH (NOLOCK)
	WHERE
		l.[user_id] = @user_id
		AND l.[log_date] = @log_date
)
BEGIN
	UPDATE
		l
	SET
		[duration] = [duration] + @duration_increment
	FROM
		scheduling_appointment_confirmation_log l WITH (NOLOCK)
	WHERE
		l.[user_id] = @user_id
		AND l.[log_date] = @log_date
END
ELSE
BEGIN
	INSERT INTO scheduling_appointment_confirmation_log (
		[id], [user_id], [log_date], [duration]
	)
	SELECT NEWID(), @user_id, @log_date, @duration_increment
END
GO
PRINT N'Creating Procedure [dbo].[vs_locateActiveSession]...';


GO
/*
	Modified 10/25/2019 - Eric Hickey
		No longer return profile plans that are 'Active', as that status has been merged with 'Contracted'
*/

CREATE procedure [dbo].[vs_locateActiveSession]
@session_id uniqueidentifier
as

/*
vs_locateActiveSession '90d6e813-5278-4882-9656-ce25534a3303'
*/

--locate acc,org,user

declare @account_id uniqueidentifier
declare @organization_id uniqueidentifier
declare @user_id uniqueidentifier
declare @community varchar(50)
declare @series varchar(50)
declare @plan varchar(50)

select 
 @account_id = p.account_id,
 @organization_id = p.organization_id,
 @user_id = p.user_id,
 @community = p.community_name,
 @series = p.series,
 @plan = p.plan_name

from account_organization_user_profile_plan_catalog_sessions s with (nolock)
left join account_organization_user_profile_plan p with (nolock) on 
	p.account_id = s.account_Id
	and p.organization_id = s.organization_id
	and p.user_id = s.user_id
	and p.community_name = s.community_name
	and p.series = s.series
	and p.plan_name = s.plan_name
where s.session_id = @session_id


--locate 'active' session from active plan
print @account_id
print @organization_id
print @user_id
print @community
print @series
print @plan

select
	s.*
from account_organization_user_profile_plan p with (nolock)
left join account_organization_user_profile_plan_catalog_sessions s with (nolock) on 
	s.account_id = p.account_Id
	and s.organization_id = p.organization_id
	and s.user_id = p.user_id
	and p.community_name = s.community_name
	and p.series = s.series
	and p.plan_name = s.plan_name

where p.account_id = @account_id 
	and p.organization_id = @organization_id 
	and p.user_id = @user_id
	and p.community_name = @community
	and p.series = @series
	and p.plan_name = @plan
	and p.status in ('active', 'contracted') -- we can still use 'active' here (until it is completely removed) because organizations that use the Prospective Status Feature will not have any 'active' profile plans
	and s.status = 1
GO
PRINT N'Creating Procedure [dbo].[vs_logCatalogSelectionsPricingError]...';


GO
CREATE procedure [dbo].[vs_logCatalogSelectionsPricingError]
@session_id uniqueidentifier,
@application varchar(100) = '',
@product varchar(100) = '',
@area varchar(100) = '',
@sub_area varchar(100) = '',
@item_type varchar(20) = '',
@item_id varchar(50) = '',
@real_item_id varchar(50) = '',
@real_item_name varchar(100) = '',
@uom_id varchar(20) = '',
@error varchar(max),
@source varchar(max),
@security_token uniqueidentifier
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)	

if @active_user_id is null
begin
	raiserror('Insufficient rights to execute query.',16,1)
	return
end

insert into catalog_selections_error_log (session_id, error_date, [application], product, area,sub_area, item_type, item_id, real_item_id, real_item_name, uom_id,  error, source)
values 
(
@session_id,
getdate(),
@application,
@product,
@area,
@sub_area,
@item_type,
@item_id,
@real_item_id,
@real_item_name,
@uom_id,
@error,
@source
)
GO
PRINT N'Creating Procedure [dbo].[vs_RPT_DailySchedule]...';


GO
CREATE procedure [dbo].[vs_RPT_DailySchedule]
	@location_id uniqueidentifier = null,
	@account_org_id uniqueidentifier = null,
	@begin_date datetime = null,
	@end_date datetime = null,
	@buyer_appointments_only bit = 1
as

/*
	Modified By: Charles Moore
	Date: 9/10/2021
	Description: Convert Lot to string values

	Modified By: Roger Wang
	Date: 3/9/2022
	Description: Include date scheduled and sort by appointment type sort order
*/

-- SUMMARY
-- Schedule report for VeoSolutions Scheduling
-- Can be run for a location or account org or both

-- PARAMETER NOTES
-- if @account_org_id is null and @locaiton_id is null it generates an error
-- if @begin_date is null, then it uses TODAY
-- if @end_date is null, then it uses the max scheduled appointment date
-- if @buyer_appointments_only, then it ignores PTO, MEETINGS, etc.

-- TESTING
-- select * from scheduling_appointments
-- select * from scheduling_appointments order by appointment_date asc
-- select getdate()
-- select DATEADD(dd, DATEDIFF(dd, 0, getdate()), 0)

-- select * from scheduling_appointment_types
-- select * from scheduling_users
-- select * from scheduling_buyers
-- select * from scheduling_organizations
-- select * from veosolutionssecurity.dbo.locations
-- select * from account_organization_user_profile_plan where address_lot_block = '11304 Cherisse Dr'
-- select * from account_organization_user_profile
-- select * from scheduling_buyers_contacts

-- SANDBOX TESTING
-- -- select * from veosolutionssecurity_locations

-- BY LOCATION
-- vs_RPT_DailySchedule 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23'
-- vs_RPT_DailySchedule 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23', null, '03/01/13'
-- vs_RPT_DailySchedule 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23'

-- BY ORG
-- vs_RPT_DailySchedule null, 'CC2A0C00-FD76-408C-AFCB-3C5134671848', '11/21/12', null, 0

if (@begin_date is null)
set @begin_date = DATEADD(dd, DATEDIFF(dd, 0, getdate()), 0)

declare @schedule as table
(
	appt_date datetime,
	appt_start time,
	report_location varchar(100),
	appointment_date varchar(20),
	appointment_dow varchar(10),
	start_time varchar(10),
	appointment_code varchar(10),
	appointment_label varchar(200),
	appointment_sort_order int,
	designer varchar(100),
	buyer varchar(200),
	phone varchar(25),
	sales varchar(100),
	builder varchar(100),
	project varchar(100),
	plan_id varchar(100),
	[address] varchar(100) ,
	[property_desc_1] varchar(20),
	[property_desc_2] varchar(20),
	[block] varchar(10),
	[lot] varchar(10),
	orig_appt_date datetime,
	date_scheduled datetime
)

-- APPOINTMENTS FOR LOCATION
if (@location_id is not null)
begin
	insert into @schedule
	select	
		a.appointment_date as appt_date,
		a.start_time as appt_start,
		l.name as report_location,
		convert(varchar, a.appointment_date,106) as appointment_date,
		DATENAME(dw, a.appointment_date) as appointment_dow,
		convert(varchar, a.start_time, 100) as start_time,
		t.abbrev as appointment_code,
		a.appointment_label as appointment_label,
		ISNULL(t.sort_order, 9999) as appointment_sort_order,
		su.first_name + ' ' + su.last_name as designer,
		isnull(b.buyer_name,'') as buyer,
		dbo.ef_selSchedulingBuyerFirstPhone(a.buyer_profile_id) as phone,
		isnull( ( select top 1 sbc.contact_label from scheduling_buyers_contacts sbc where sbc.profile_id = a.buyer_profile_id and sbc.contact_role = 'Sales'),'') as sales,
		so.display_name as builder,
		isnull(pp.community_name,'') as project,
		isnull(pp.plan_name,'') as plan_id,
		isnull(pp.[address],'') as [address],
		isnull(pp.property_desc_1,'') as [property_desc_1],
		isnull(pp.property_desc_2,'') as [property_desc_2],
		isnull(pp.block,'') as [block],
		isnull(pp.lot,'') as [lot],
		a.appointment_date as orig_appt_date,
		(select top 1 completion_date from scheduling_messages with (nolock) where appointment_id = a.appointment_id and message_title = 'Scheduled' order by completion_date desc) as date_scheduled
	from
		scheduling_appointments a with (nolock)
		join scheduling_appointment_types t with (nolock) on t.appointment_type = a.appointment_type
		left join veosolutionssecurity_locations l with (nolock) on l.location_id = a.location_id
		left join scheduling_users su with (nolock) on su.user_id = a.schedule_user_id
		--RIG left join account_organization_user_profile_plan pp with (nolock) on pp.profile_id = a.buyer_profile_id
		left join account_organization_user_profile_plan pp with (nolock) on pp.profile_id = dbo.ef_selSchedulingBuyerActiveProfilePlan(a.buyer_profile_id)
		left join scheduling_buyers b with (nolock) on b.profile_id = a.buyer_profile_id
		--left join scheduling_buyers_contacts c on c.profile_id = a.buyer_profile_id and c.is_buyer = 1
		left join scheduling_organizations so with (nolock) on so.account_org_id = a.account_org_id
	where
		(a.location_id = @location_id or a.location_id is null)
		and a.appointment_date is not null -- exclude empty slots (template)
		and a.buyer_profile_id is not null -- exclude non-buyer appointments (PTO)
		and a.appointment_date >= @begin_date
		and ( a.appointment_date <= @end_date or @end_date is null)
end

-- get the property desc 1&2 labels
declare @property_desc_label_1 varchar(20)
declare @property_desc_label_2 varchar(20)

select
	@property_desc_label_1 = isnull(property_desc_1_label,''),
	@property_desc_label_2 = isnull(property_desc_2_label,'')
from
	veosolutionssecurity_account_organizations vsao with (nolock)
	left join veosolutionssecurity_organizations vso with (nolock) on vso.organization_id = vsao.organization_id
where
	vsao.account_org_id = @account_org_id


-- get the end date
if (@end_date is null)
	select @end_date = max(orig_appt_date) from @schedule

-- use the end date in the report, which includes all fields
select
	@begin_date as report_begin_date,
	@end_date as report_end_date,
	*,
	address + ' ' +
	case len(property_desc_1) when 0 then '' else @property_desc_label_1 + ' ' + isnull(property_desc_1,'') + ' ' end +
	case len(property_desc_2) when 0 then '' else @property_desc_label_2 + ' ' + isnull(property_desc_2,'') + ' ' end +
	case len(block) when 0 then '' else 'Block: ' + block + ' ' end +
	case when lot in('0','') then '' else 'Lot: ' + lot end as job_address
from
	@schedule
order by
	appointment_sort_order,
	date_scheduled desc,
	appt_date,
	appt_start asc


-- ========================================
-- DCM REPORT HERE INCLUDED FOR REF ONLY
-- ========================================
--declare @schedule as table
--(
--	dc_name varchar(50),
--	dc_address varchar(200),
	
--	activity_type varchar(50),
--	schedule_datetime datetime,
	
--	schedule_date varchar(30),
--	schedule_time varchar(30),
	
--	appointment_ordinal varchar(10),
	
--	consultant varchar(100),
--	builder_name varchar(100),
	
--	buyer_info varchar(200),
--	buyer_email varchar(100),
--	buyer_phone varchar(100),
	
--	salesperson varchar(100),
--	salesperson_phone varchar(100),
	
--	project varchar(100),
--	plan_name varchar(50),
	
--	job_address varchar(100),
	
--	upgrade_amount decimal(18,2),
	
--	job_status varchar(50),
	
--	job_receipt_date datetime,
	
--	elapsed_days int,
	
--	job_tags varchar(500)
--)


--/* FETCH APPOINTMENTS */
--insert into @schedule
--select
--	d.name as dc_name,
--	d.address1 +  ' ' + d.address2 + ' ' + d.city + ' ' + d.state + ' ' + d.zipcode,
--	'Appointment' as activity_type,

--	a.appointment_date, -- convert(varchar(10), a.appointment_date, 101),
	
--	Convert(varchar, a.appointment_date, 101),
--	RIGHT(Convert(VARCHAR(20), a.appointment_date, 0) ,8),--DATEPART("Hh", a.appointment_date) + ':' + DATEPART("mi", a.appointment_date),
	
--	dcsm.dcf_SelJobAppointmentOrdinalString(j.job_id, a.appointment_date) as appointment_ordinal,
	
--	u.first_name + ' ' + u.last_name as consultant,
--	ac.customer_name,

--	dcsm.dcf_SelFirstJobContactName(j.job_id, 2) as buyer_info,
--	dcsm.dcf_SelFirstJobContactNumber(j.job_id, 2, 'E-mail') as buyer_email,
	
--	/* buyer phone numbers */
--	isnull(dcsm.dcf_SelFirstJobContactNumber(j.job_id, 2, 'Home'), '') +
--	case when dcsm.dcf_SelFirstJobContactNumber(j.job_id, 2, 'Home') IS NOT NULL then ' (h)' else '' end +
--	case when
--		( dcsm.dcf_SelFirstJobContactNumber(j.job_id, 2, 'Home') IS NOT NULL and
--		dcsm.dcf_SelFirstJobContactNumber(j.job_id, 2, 'Work') IS NOT NULL) then ' / ' else  ''  end +
	
--	isnull(dcsm.dcf_SelFirstJobContactNumber(j.job_id, 2, 'Work'), '') +
--	case when dcsm.dcf_SelFirstJobContactNumber(j.job_id, 2, 'Work') IS NOT NULL then ' (w)' else '' end +
--	case when
--		( dcsm.dcf_SelFirstJobContactNumber(j.job_id, 2, 'Work') IS NOT NULL and
--		dcsm.dcf_SelFirstJobContactNumber(j.job_id, 2, 'Cell') IS NOT NULL) then ' / ' else '' end +
	
--	isnull(dcsm.dcf_SelFirstJobContactNumber(j.job_id, 2, 'Cell'), '') +
--	case when dcsm.dcf_SelFirstJobContactNumber(j.job_id, 2, 'Cell') IS NOT NULL then ' (c)' else '' end,

--	 dcsm.dcf_SelFirstJobContactName(j.job_id, 1) as salesperson,
	
--	/* sales phone numbers */
--	isnull(dcsm.dcf_SelFirstJobContactNumber(j.job_id, 1, 'Home'), '') +
--	case when dcsm.dcf_SelFirstJobContactNumber(j.job_id, 1, 'Home') IS NOT NULL then ' (h)' else '' end +
--	case when
--		( dcsm.dcf_SelFirstJobContactNumber(j.job_id, 1, 'Home') IS NOT NULL and
--		dcsm.dcf_SelFirstJobContactNumber(j.job_id, 1, 'Work') IS NOT NULL) then ' / ' else  ''  end +
	
--	isnull(dcsm.dcf_SelFirstJobContactNumber(j.job_id, 1, 'Work'), '') +
--	case when dcsm.dcf_SelFirstJobContactNumber(j.job_id, 1, 'Work') IS NOT NULL then ' (w)' else '' end +
--	case when
--		( dcsm.dcf_SelFirstJobContactNumber(j.job_id, 1, 'Work') IS NOT NULL and
--		dcsm.dcf_SelFirstJobContactNumber(j.job_id, 1, 'Cell') IS NOT NULL) then ' / ' else '' end +
	
--	isnull(dcsm.dcf_SelFirstJobContactNumber(j.job_id, 1, 'Cell'), '') +
--	case when dcsm.dcf_SelFirstJobContactNumber(j.job_id, 1, 'Cell') IS NOT NULL then ' (c)' else '' end,
	
--	j.community_name,
--	j.plan_name,

--	j.address1,
	
--	isnull( dcsm.dcf_SelJobUpgradeAmount(j.job_id), 0.00) as [upgrade_amount],
	
--	js.description as job_status,
--	j.job_receipt_date,
--	datediff(day, j.job_receipt_date, getdate()),
--	dcsm.dcf_SelJobTags(j.job_id)
	
--from dcsm.dc_appointments a
--join dcsm.dc d on d.design_center_id = a.design_center_id
--join dcsm.dc_customers c on c.design_center_id = a.design_center_id
--join dcsm.dc_jobs j on j.job_id = a.job_id
--join dcsm.dc_job_status js on js.status_id = j.job_status
--join dcsm.dc_accounts_customers ac on ac.customer_id = j.customer_id
--left join dcsm.dc_users u on u.user_id = a.designer_id

--where
--	c.customer_id = @builder_id
--	and a.appointment_date between @begin_date and @end_date
--order by a.appointment_date asc


--/* FETCH WORK SCHEDULE (NON APPOINTMENTS) */
--if @buyer_appointments_only = 0
--begin

--insert into @schedule
--select
--	d.name as dc_name,
--	d.address1 +  ' ' + d.address2 + ' ' + d.city + ' ' + d.state + ' ' + d.zipcode,
	
--	case wt.description
--		when 'Appointment' then 'Open'
--		else wt.description
--		end as activity_type,
		
--	w.work_date_time,
	
--	Convert(varchar,w.work_date_time, 101),
--	RIGHT(Convert(VARCHAR(20), work_date_time, 0) ,8),
	
--	'',
	
--	u.first_name + ' ' + u.last_name,
	
--	'', -- builder
--	'', -- buyer info
--	'', -- buyer email
--	'', -- buyer phone
--	'', -- sales person
--	'', -- sales phone
--	'', -- project
--	'', -- plan
--	'', -- address
--	0.00 as upgrade_amount,
--	'' as job_status,
--	null, -- receipt date
--	null,  -- elapsed days
--	null -- job tags
	
--from
--	dcsm.dc_users_work_schedule w
--	join dcsm.dc d on d.design_center_id = w.design_center_id
--	join dcsm.dc_work_types wt on wt.work_type_id = w.work_type_id
--	join dcsm.dc_customers c on c.design_center_id = w.design_center_id
--	left join dcsm.dc_users u on u.user_id = w.user_id
--	left outer join dcsm.dc_appointments app on app.design_center_id = w.design_center_id and app.designer_id = w.user_id and app.appointment_date = w.work_date_time
--where
--	c.customer_id = @builder_id -- limite to users with this customer defined...
--	and w.work_date_time between @begin_date and @end_date
--	and app.appointment_id is null
--order by w.work_date_time asc

--end

---- select * from dcsm.dc_users_work_schedule
--select * from @schedule
--order by schedule_datetime, consultant asc
GO
PRINT N'Creating Procedure [dbo].[vs_RPT_SchedulingActivity]...';


GO
create procedure [dbo].[vs_RPT_SchedulingActivity]
@account_org_id uniqueidentifier, 
@start datetime = null, 
@end datetime = null, 
@user_notes_only bit = 1
as

-- EXPLORATION QUERIES
-- select * from veosolutionssecurity_account_organizations
-- select * from veosolutionssecurity.dbo.organizations
-- select top 10 * from scheduling_appointments
-- select top 10 * from scheduling_messages
-- select * from veosolutionssecurity.dbo.users
-- select * from account_organization_user_profile_plan

-- REFERENCE: Message Types (used to filter out system related notes from report) 
-- select * from scheduling_message_types
--0	System
--1	Info
--2	Notify
--3	Conflict
--4	Rescheduled
--5	Reassigned
--6	Canceled
--7	Completed
--8	Request
--9	IM
--10	CheckIn
--11	NoShow
--12	Communication
--13	TalkedToBuyer
--14	LeftVoicemail
--15	LeftHumanMessage
--16	NoAnswer
--17	DeclinedAppointment

-- TESTING 
-- Default - account org, no start no end defined
-- [vs_RPT_SchedulingActivity] 'CC2A0C00-FD76-408C-AFCB-3C5134671848'
-- vs_rpt_schedulingActivity '34c914cd-5dc8-4574-ac4e-f70a7f873832','07/01/2013','07/31/2013',0
-- select dbo.ef_selSchedulingBuyerActiveProfilePlan('1E68BB67-6473-4D3E-8D89-086A7A705747')
-- select dbo.ef_selAppointmentDateByOrdinal('1E68BB67-6473-4D3E-8D89-086A7A705747',1)
-- select dbo.ef_selAppointmentDateByOrdinal('7C9F3235-DECD-44E8-AFD8-070DAF208109',1)

if (@start is null) 
set @start = DATEADD(dd, DATEDIFF(dd, 0, getdate()), 0)

declare @data table 
(
	report_begin_date datetime, 
	report_end_date datetime, 
	profile_id uniqueidentifier, 
	report_builder_name varchar(100), 
	job_no varchar(25), 
	community_name varchar(100), 
	series varchar(100), 
	plan_name varchar(100), 
	elevation varchar(100), 
	address_lot_block varchar(100), 
	lot varchar(50),
	block varchar(50),
	buyer_name varchar(200),  
    email varchar(200), 
	designer varchar(100),
    sales_counselor varchar(100), 
	contract_date datetime, 
	received_date datetime, 
	appt_1 datetime, 
	days int, 
	appt_2 datetime ,
	appt_3 datetime ,
	appt_4 datetime, 
	job_tags varchar(100), 
	[status] varchar(100), 
	completion datetime, 
	pm varchar(100), 
	builder varchar(100), 
	upgrade varchar(100), 
	activity_author varchar(100), 
	activity_create_date datetime, 
	activity_notes varchar(1000),
	buyer_profile_id uniqueidentifier,
	appt_1_design_type varchar(50),
	appt_2_design_type varchar(50),
	appt_3_design_type varchar(50),
	appt_4_design_type varchar(50)
) 

insert into 
	@data 
SELECT
      @start as report_begin_date, 
	  @end as report_end_date, 
      aoupp.profile_id, 
	  so.display_name as report_builder_name,
      aoupp.job_no,
      aoupp.community_name,
      aoupp.series,
      aoupp.plan_name,
      aoupp.elevation,
	  aoupp.address as address_lot_block,
	  aoupp.lot,
	  aoupp.block,
      aou.first_name + ' ' + aou.last_name as buyer_name,  
      u.email,
      (designer.first_name + ' ' + designer.last_name) as designer, --isnull(dbo.ef_selSchedulingBuyerContactsByRole(aoupp.profile_id,'Designer'),'') as 'designer',
      dbo.ef_selSalesCounselorNameFromProfilePlan(aoupp.account_id, aoupp.organization_id, aoupp.[user_id], aoupp.community_name, aoupp.series, aoupp.plan_name) as 'sales_counselor',
      aoupp.contract_date,
      sb.received_date,
      --isnull( dbo.ef_selAppointmentDateByOrdinal(dbo.ef_selSchedulingBuyerActiveProfilePlan(sa.buyer_profile_id),1), dbo.ef_selAppointmentDateByOrdinal(sa.buyer_profile_id,1)) as [appt_1],
      dbo.ef_selAppointmentDateByOrdinal(sa.buyer_profile_id,1) as [appt_1],
      dbo.ef_selBuyerCycleTime(aoupp.profile_id) as days,
      dbo.ef_selAppointmentDateByOrdinal(sa.buyer_profile_id,2) as [appt_2],
      dbo.ef_selAppointmentDateByOrdinal(sa.buyer_profile_id,3) as [appt_3],
      dbo.ef_selAppointmentDateByOrdinal(sa.buyer_profile_id,4) as [appt_4],
      'N/A' as job_tags,
      aoupp.status,
      dbo.ef_selLastCompletionDateByUser(aoupp.account_id, aoupp.organization_id, aoupp.user_id) as completion,
      'N/A' as pm,
      'N/A' as builder,
      'N/A' as upgrade,
      sm.author as [activity_author],
      sm.create_date as [activity_create_date],
      sm.message_body as [activity_notes],
	  sm.buyer_profile_id,
	  dbo.ef_selAppointmentDesignTypeByOrdinal(sa.buyer_profile_id,1) as [appt_1_design_type],
	  dbo.ef_selAppointmentDesignTypeByOrdinal(sa.buyer_profile_id,2) as [appt_2_design_type],
	  dbo.ef_selAppointmentDesignTypeByOrdinal(sa.buyer_profile_id,3) as [appt_3_design_type],
	  dbo.ef_selAppointmentDesignTypeByOrdinal(sa.buyer_profile_id,4) as [appt_4_design_type]

FROM
      [scheduling_buyers] sb with (nolock)
      left join account_organization_user_profile_plan aoupp with (nolock) on aoupp.profile_id = dbo.ef_selSchedulingBuyerActiveProfilePlan(sb.profile_id)  
      left join scheduling_appointments sa with (nolock) on sa.buyer_profile_id = sb.profile_id
      left join scheduling_organizations so with (nolock) on so.account_org_id = sa.account_org_id
      left join VeoSolutionsSecurity_users designer with (nolock) on designer.[user_id] = sa.schedule_user_id
	  left join VeoSolutionsSecurity_account_organization_users aou with (nolock) on aou.account_id = aoupp.account_id and aou.organization_id = aoupp.organization_id and aou.[user_id] = aoupp.[user_id]
      left join VeoSolutionsSecurity_users u with (nolock) on u.[user_id] = aou.[user_id]
      left join account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock) on aouppcs.account_id = aoupp.account_id and aouppcs.organization_id = aoupp.organization_id and aouppcs.[user_id] = aoupp.[user_id] and aouppcs.[status] = 2
	  left join scheduling_messages sm with (nolock) on sm.buyer_profile_id = sb.profile_id and (@user_notes_only = 0 or sm.message_type not in (0,2,3,4,5,6,7) ) 
where
	sa.account_org_id = @account_org_id
	and sa.appointment_date is not null -- exclude empty slots (template) 
	and sa.buyer_profile_id is not null -- exclude non-buyer appointments (PTO) 
	and sa.appointment_date >= @start 
	and ( sa.appointment_date <= @end or @end is null) 

order by 
	sa.appointment_date, sa.start_time,  sm.create_date desc 


select distinct 
	report_begin_date , 
	report_end_date ,
	profile_id , 
	report_builder_name , 
	job_no, 
	community_name , 
	series , 
	plan_name , 
	elevation , 
	address_lot_block , 
	lot,
	block,
	buyer_name,  
    email, 
	designer ,
    sales_counselor , 
	contract_date , 
	dateadd(day,20,contract_date) as estimated_complete_date,
	received_date , 
	appt_1 , 
	days , 
	appt_2  ,
	appt_3  ,
	appt_4 , 
	job_tags , 
	[status] , 
	completion , 
	pm , 
	builder , 
	upgrade , 
	activity_author , 
	activity_create_date , 
	activity_notes,
	buyer_profile_id,
	appt_1_design_type,
	appt_2_design_type,
	appt_3_design_type,
	appt_4_design_type
from 
	@data 
where profile_id is not null
order by job_no, activity_create_date desc
GO
PRINT N'Creating Procedure [dbo].[vs_RPT_SchedulingAppointmentHours]...';


GO

-- ================================================================================================
-- Author:		John McPherson
-- Create date: 2019-04-11
-- Description:	Report based stored procedure used 
--				pulling the scheduled appointment hours
--				for a specific account organization along 
--				with a specific start and possible end date range
-- the following logic: 
-- Reduced number of functions called leveraging temp tables to pull the following:
--		1) Scheduled appointments over the time period for a specific account organizations
--		(i.e. PERRY HOMES - HOUSTON-5293)
--		2) Aggregated table of scheduled appointments to help with calculating total and average
--		duration for appointments per home/address/homebuyer
--
--Modified:		Charles Moore
--Date:			5/07/2021
--Description:	when @account_org_id is null the Scheduled appointments over the time period is for all account organizations
-- 
-- ================================================================================================
CREATE procedure [dbo].[vs_RPT_SchedulingAppointmentHours]
@account_org_id uniqueidentifier, 
@start datetime = null, 
@end datetime = null, 
@completed_only bit = 1 
with recompile
as

if (@start is null) 
set @start = DATEADD(dd, DATEDIFF(dd, 0, getdate()), 0)


-- 1st Create a temp table for all of the appointments 
-- set up over this period for the account organization passed in
select 
sa.appointment_id as appointment_id,
sa.account_org_id as account_org_id,
sa.schedule_user_id as schedule_user_id,
sa.buyer_profile_id as buyer_profile_id,
ROW_NUMBER() OVER (PARTITION BY sa.buyer_profile_id ORDER BY sa.buyer_profile_id, sa.appointment_date, sa.start_time) AS ordinal,
sa.appointment_type as appointment_type, 
cast(sa.appointment_date as datetime) + cast(sa.start_time as datetime) as appointment_date_and_time,
sa.appointment_date as appointment_date, 
sa.start_time as start_time, 
sa.start_time_actual as start_time_actual, 
sa.end_time_actual as end_time_actual,
convert(time, DATEADD(s, DATEDIFF(s, sa.start_time_actual, sa.end_time_actual), 0)) as appointment_duration_seconds,
convert(time, DATEADD(minute, DATEDIFF(minute, sa.start_time_actual, sa.end_time_actual), 0)) as appointment_duration_minutes
into #appointments
from scheduling_buyers sb with (nolock)
join scheduling_appointments sa with (nolock) on sa.buyer_profile_id = sb.profile_id
where
sa.buyer_profile_id in
(
	select distinct buyer_profile_id from scheduling_appointments 
	where 
	appointment_date >= @start
	and 
	( appointment_date <= @end or @end is null) 
)
and
sa.appointment_date is not null -- exclude empty slots (template) 
and
sa.buyer_profile_id is not null -- exclude non-buyer appointments (PTO) 
and
sa.is_scheduled = 1
and
sa.account_org_id =
  case when @account_org_id = '00000000-0000-0000-0000-000000000000' then 
     sa.account_org_id
  when @account_org_id is not null then
	 @account_org_id
  else
	 sa.account_org_id
  end
order by sa.buyer_profile_id, sa.appointment_date, sa.start_time


-- 2nd Create a temp table for that is calculating the sum duration time 
-- and the average duration time in minutes for appointments
-- set up over this period for the account organization passed in
select 
sa.buyer_profile_id as buyer_profile_id,
SUM(DATEDIFF(minute, sa.start_time_actual, sa.end_time_actual)) as total_appointment_duration_minutes,
AVG(DATEDIFF(minute, sa.start_time_actual, sa.end_time_actual)) as average_appointment_duration_minutes
into #aggregated_appointment_durations
from scheduling_buyers sb with (nolock)
join scheduling_appointments sa with (nolock) on sa.buyer_profile_id = sb.profile_id
where
sa.buyer_profile_id in
(
	select distinct buyer_profile_id from scheduling_appointments 
	where appointment_date >= @start
	and 
	( appointment_date <= @end or @end is null) 
)
and
sa.appointment_date is not null -- exclude empty slots (template) 
and
sa.buyer_profile_id is not null -- exclude non-buyer appointments (PTO) 
and
sa.is_scheduled = 1
and
sa.start_time_actual is not null
and
sa.end_time_actual is not null
and
sa.account_org_id =
  case when @account_org_id = '00000000-0000-0000-0000-000000000000' then 
     sa.account_org_id
  when @account_org_id is not null then
	 @account_org_id
  else
	 sa.account_org_id
  end
group by sa.buyer_profile_id


SELECT
	
    @start as report_begin_date, 
	@end as report_end_date, 
	so.display_name as report_builder_name,

	aoupp.community_name,
    dbo.ef_selFullLegalDescription(aoupp.account_id, aoupp.organization_id, aoupp.[user_id], aoupp.community_name, aoupp.series, aoupp.plan_name) as address_lot_block,
	aoupp.plan_name,
	aoupp.elevation,
	aoupp.profile_id, 
	aou.first_name + ' ' + aou.last_name as buyer_name,  
	u.email,
    (designer.first_name + ' ' + designer.last_name) as designer, 
	aoupp.job_no,
	aoupp.sales_counselor,
	aoupp.[status],

	sa1.appointment_date_and_time as [appt_1],
	convert(varchar(10), sa1.start_time_actual,0) as appt_1_in,
	convert(varchar(10), sa1.end_time_actual,0) as appt_1_out, 

	sa2.appointment_date_and_time as [appt_2],
	convert(varchar(10), sa2.start_time_actual,0) as appt_2_in,
	convert(varchar(10), sa2.end_time_actual,0) as appt_2_out, 

	sa3.appointment_date_and_time as [appt_3],
	convert(varchar(10), sa3.start_time_actual,0) as appt_3_in,
	convert(varchar(10), sa3.end_time_actual,0) as appt_3_out, 

	sa4.appointment_date_and_time as [appt_4],
	convert(varchar(10), sa4.start_time_actual,0) as appt_4_in,
	convert(varchar(10), sa4.end_time_actual,0) as appt_4_out, 
	
	-- appt1_duration
	convert(varchar(10), sa1.appointment_duration_seconds, 14) as appt_1_duration, 
	convert(varchar(10), sa2.appointment_duration_seconds, 14) as appt_2_duration, 
	convert(varchar(10), sa3.appointment_duration_seconds, 14) as appt_3_duration, 
	convert(varchar(10), sa4.appointment_duration_seconds, 14) as appt_4_duration, 

	convert(varchar(10), aad.total_appointment_duration_minutes, 14)  as design_duration, 
	convert(varchar(10), aad.average_appointment_duration_minutes, 14)  as per_appt_avg,
		
	aoupp.contract_date, 
	sb.received_date, 
	-- no, should session complete date dbo.ef_selLastCompletionDateByUser(aoupp.account_id, aoupp.organization_id, aoupp.user_id),
	aouppcs.first_completed_date as completion_date,
	  
	dbo.ef_selWorkingDatesBetweenDates( aoupp.contract_date, sb.received_date, 1) as contract_to_received, 
	dbo.ef_selWorkingDatesBetweenDates( sb.received_date, sa1.appointment_date_and_time, 1) as received_to_first,  
	dbo.ef_selWorkingDatesBetweenDates( sa1.appointment_date_and_time, sa2.appointment_date_and_time, 1) as first_to_second, 
	dbo.ef_selWorkingDatesBetweenDates( sa2.appointment_date_and_time, sa3.appointment_date_and_time, 1) as second_to_third, 
	dbo.ef_selWorkingDatesBetweenDates( sa3.appointment_date_and_time, sa4.appointment_date_and_time , 1) as third_to_fourth, 
	dbo.ef_selWorkingDatesBetweenDates(  aoupp.contract_date,dbo.ef_selLastCompletionDateByUser(aoupp.account_id, aoupp.organization_id, aoupp.user_id), 1) as contract_to_complete,
	dbo.ef_selBuyerCycleTime(sb.profile_id) as cycle_time,
	aoupp.superintendent,
	aoupp.stage,
	dbo.ef_selSchedulingBuyerActivityNotes(sb.profile_id) as notes

into #report_results
FROM
    [scheduling_buyers] sb with (nolock)
    -- RIG make same as scheduleing activity report left join account_organization_user_profile_plan aoupp with (nolock) on aoupp.profile_id = sb.profile_id
    left join account_organization_user_profile_plan aoupp with (nolock) on aoupp.profile_id = dbo.ef_selSchedulingBuyerActiveProfilePlan(sb.profile_id)
	left join #appointments sa with (nolock) on sa.buyer_profile_id = sb.profile_id
    left join scheduling_organizations so with (nolock) on so.account_org_id = sa.account_org_id
    left join VeoSolutionsSecurity_users designer with (nolock) on designer.[user_id] = sa.schedule_user_id
	left join VeoSolutionsSecurity_account_organization_users aou with (nolock) on aou.account_id = aoupp.account_id and aou.organization_id = aoupp.organization_id and aou.[user_id] = aoupp.[user_id]
    left join VeoSolutionsSecurity_users u with (nolock) on u.[user_id] = aou.[user_id]
    left join account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock) on aouppcs.account_id = aoupp.account_id and aouppcs.organization_id = aoupp.organization_id and aouppcs.[user_id] = aoupp.[user_id] -- and aouppcs.[status] = 2
	left join scheduling_messages sm with (nolock) on sm.buyer_profile_id = sb.profile_id and (sm.message_type not in (0,2,3,4,5,6,7) ) 
	left join #appointments sa1 with (nolock) on sa1.buyer_profile_id = sb.profile_id and sa1.ordinal = 1
	left join #appointments sa2 with (nolock) on sa2.buyer_profile_id = sb.profile_id and sa2.ordinal = 2
	left join #appointments sa3 with (nolock) on sa3.buyer_profile_id = sb.profile_id and sa3.ordinal = 3
	left join #appointments sa4 with (nolock) on sa4.buyer_profile_id = sb.profile_id and sa4.ordinal = 4
	left join #aggregated_appointment_durations aad with (nolock) on sb.profile_id = aad.buyer_profile_id
    
where
	sb.profile_id in 
	(
		select distinct buyer_profile_id from #appointments 
	)


select 
distinct 
	report_begin_date , 
	report_end_date , 
	report_builder_name, 

	community_name , 
	address_lot_block , 
	plan_name,
	elevation,
	profile_id , 
	buyer_name ,  
	email,
    designer ,
	job_no,
	sales_counselor,
	[status],
    appt_1, 
	appt_1_in, 
	appt_1_out, 

	appt_2,
	appt_2_in,
	appt_2_out,

	appt_3,
	appt_3_in,
	appt_3_out,

	appt_4, 
	appt_4_in,
	appt_4_out,

	appt_1_duration,
	appt_2_duration,
	appt_3_duration,
	appt_4_duration,
	design_duration, 
	per_appt_avg, 

	contract_date , 
	received_date , 
	completion_date ,
	
	contract_to_received, 
	received_to_first , 
	first_to_second , 
	second_to_third , 
	third_to_fourth , 
	contract_to_complete , 
	cycle_time,
	superintendent,
	stage,
	notes

from #report_results
GO
PRINT N'Creating Procedure [dbo].[vs_rptAccountOrganizationCatalogSessionHeader]...';


GO

CREATE procedure [dbo].[vs_rptAccountOrganizationCatalogSessionHeader]

@session_id uniqueidentifier		

/*
	vs_rptAccountOrganizationCatalogSessionHeader @session_id = '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2'
*/

as

select 
	aouppcs.*,
	ao.name as builder_name,
	aoupp.profile_id,
	aoupp.sales_price,
	aoupp.upgrades_incentive,
	aoupp.additional_design_deposit,
	aoupp.deposit_notes,
	aoupp.job_no,
	aoupp.[address],
	aoupp.block,
	aoupp.lot,
	aoupp.city,
	aoupp.[state],
	aoupp.zip_code,
	aoupp.sales_counselor,
	aoupp.contract_date,
	aoupp.receipt_date,
	aoupp.home_phone,
	aoupp.work_phone,
	aoupp.spouse_first_name,
	aoupp.spouse_last_name,
	aoupp.spouse_phone,
	aoupp.status as profile_status,
	aoupp.echelon_exported,
	aoupp.spec_home,
	aoupp.elevation,
	au.first_name,
	au.last_name,
	au.email
from 
	account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock)
	left join account_organization_user_profile_plan aoupp with (nolock) on aoupp.account_id = aouppcs.account_id and aoupp.organization_id = aouppcs.organization_id and aoupp.[user_id] = aouppcs.[user_id]
	left join VeoSolutionsSecurity_users au with (nolock) on au.[user_id] = aouppcs.[user_id]
	left join VeoSolutionsSecurity_organizations ao with (nolock) on ao.organization_id = aouppcs.organization_id
where 
	session_id = @session_id
GO
PRINT N'Creating Procedure [dbo].[vs_rptAccountOrganizationUserRegistrationsByDate]...';


GO
CREATE proc vs_rptAccountOrganizationUserRegistrationsByDate 
@account_id uniqueidentifier, 
@organization_id uniqueidentifier, 
@start_date datetime, 
@end_date datetime


as

/*
	vs_rptAccountOrganizationUserRegistrationsByDate 'BAB32B7E-3ADA-497C-862E-E5083971CC59', '577BFBA0-4089-4229-BAA1-EE84C85A4D1F', '01-01-2012', '01-01-2013'
*/

--First Name, Last Name, E-Mail, Community, Series, Plan Name, Date Registered

select 
	aou.first_name,
	aou.last_name,
	users.email,
	isnull(plans.community_name, '') as community_name,
	isnull(plans.series, '') as series,
	isnull(plans.plan_name, '') as plan_name,
	aou.create_date

from 

VeoSolutionsSecurity_account_organization_users aou
left join VeoSolutionsSecurity_users users on users.user_id = aou.user_id
left join account_organization_user_profile_plan plans on plans.user_id = users.user_id
left join VeoSolutionsSecurity_account_organization_users_roles_legacy user_roles on user_roles.user_id = aou.user_id
left join VeoSolutionsSecurity_roles_legacy roles on roles.role_id = user_roles.role_id

where

roles.name = 'Homebuyer'
and aou.create_date >= @start_date
and aou.create_date <= @end_date
and aou.organization_id = @organization_id
and aou.account_id = @account_id
GO
PRINT N'Creating Procedure [dbo].[vs_RptInvoice]...';


GO
CREATE procedure [dbo].[vs_RptInvoice]

@invoice_id as int

as

/*

vs_RptInvoice 20435

Modified By: Charles Moore
Date: 9/10/2021
Description: Convert Lot to string values

*/ 
declare @items TABLE 
(               
	-- invoice header fields          
	invoice_no int, 
	reference_id uniqueidentifier,
	reference_type varchar(255),
	invoice_date datetime, 
	invoice_customer_desc varchar(255), 
	invoice_status varchar(255), 
	invoice_ratio decimal(18,4), 
	external_invoice_reference varchar(255), 
	last_print_date datetime, 
	invoice_notes text,
	upgrade_total decimal(18,2), 
	invoice_total decimal(18,2), 
	
	-- job header fields 
	builder_job_no varchar(255) not null default('na'), 
	address1 varchar(255) default('na'), 
	lot_block varchar(255) default('na'),
	community_name varchar(255) default('na'), 
	plan_name varchar(255) default('na'), 
	homeowner varchar(255) default('na'), 
	designer varchar(255) default('na'), 
	
	-- invoice line fields 
	line_no int, 
	[application] varchar(500), 
	product varchar(500), 
	area varchar(500), 
	item varchar(max), 
	vendor varchar(255), 
	line_amount decimal(18,2), 
	invoice bit, 
	invoice_amount decimal(18,2), 
	invoice_net decimal(18,2), 
	line_notes varchar(255)

)     

declare @reference_type varchar(50)
declare @reference_id uniqueidentifier

select @reference_type = reference_type,
	   @reference_id = reference_id
	   
from invoices where invoice_id = @invoice_id

--print @reference_type
--print @reference_id

insert into @items 
(	line_no, 
	[application],
	product, 
	area , 
	item , 
	vendor , 
	line_amount , 
	invoice , 
	invoice_amount , 
	invoice_net,
	--sequence , 
	line_notes ) 
select 
	line_no, 
	[application],
	product, 
	area, 
	item, 
	vendor, 
	line_amount, 
	invoice,
	invoice_amount, 
	0,
	--sequence, 
	notes 
from 
	invoice_lines 
where 
	invoice_id = @invoice_id 

-- invoice header 
update @items 
set
	invoice_no = i.invoice_no, 
	--job_id = i.job_id,
	reference_id = i.reference_id,
	reference_type = i.reference_type,
	invoice_date = i.invoice_date, 
	--invoice_customer_desc = i.invoice_customer_desc, 
	invoice_customer_desc = vc.customer_name, 
	invoice_status = i.invoice_status, 
	invoice_ratio = i.invoice_ratio , 
	external_invoice_reference = i.external_invoice_reference, 
	last_print_date = i.last_print_date, 
	invoice_notes = ISNULL(i.invoice_notes,''),
	upgrade_total = (select sum(line_amount) from @items), 
	invoice_total = (select sum(invoice_amount) from @items) 
from 
	invoices i 
	left join veo_customers vc with (nolock) on vc.custnmbr = i.invoice_customer_id
where 
	i.invoice_id = @invoice_id 

if @reference_type = 'DesignSelectionInvoice'
begin

	-- locate homebuyer name, address, customer name
	/*
	update @items
	set

	builder_job_no = @invoice_id, 
	address1 = address_lot_block, 
	lot_block = aoupp.lot_block,
	community_name = aoupp.community_name, 
	plan_name = aoupp.plan_name, 
	homeowner = isnull(u.first_name,'')+ ' '+ isnull(u.last_name,''), 
	designer = aouppcs.designer
	
	from account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock)
	
	left join account_organization_user_profile_plan aoupp with (nolock) on 
		aoupp.account_id = aouppcs.account_id
		and aoupp.organization_id = aouppcs.organization_id
		and aoupp.community_name = aouppcs.community_name
		and aoupp.series = aouppcs.series
		and aoupp.plan_name = aouppcs.plan_name
	left join VeoSolutionsSecurity_users u with (nolock) on
		u.user_id = aoupp.user_id

	where aouppcs.session_id = @reference_id
	*/
	

	update 
		@items
	set
		builder_job_no = isnull(aoup.job_no,''), 
		address1 = aoup.[address], 
		lot_block = case when aoup.block = '' then '' else 'Blk: ' + aoup.block + ' ' end + 
			case when aoup.lot in('0','') then '' else 'Lot: ' + aoup.lot end,
		community_name = s.community_name, 
		plan_name = s.plan_name, 
		homeowner = isnull(vssu.first_name,'')+ ' '+ isnull(vssu.last_name,''), 
		designer = s.designer
	from 
		account_organization_user_profile_plan_catalog_sessions  s with (nolock)
		left join account_organization_user_profile_plan aoup with (nolock) on  
			aoup.account_id = s.account_id 
			and aoup.organization_id = s.organization_id 
			and aoup.user_id = s.user_id
			and aoup.community_name = s.community_name
			and aoup.series = s.series
			and aoup.plan_name = s.plan_name
		left join VeoSolutionsSecurity_users vssu with (nolock) on 
			vssu.user_id = s.user_id		
	where 
		session_id = @reference_id	
	
	
		
end

-- last print date == view date really, so update this field for the invoice
update 
	invoices 
set 
	last_print_date = getdate() 
where 
	invoice_id = @invoice_id 
	

--fill in invoice_net total

declare @credits decimal(18,2)


--declare @customer_id varchar(50)
----set @customer_id = 'DCA3333'
--declare @invoice_no int
----set @invoice_no = '35539855'

--select top 1 @customer_id = external_invoice_reference , @invoice_no = invoice_no from @items
  
--select
--	@credits = isnull(sum(Extended),0)
--from

--(    
--select          
-- round(qty * amount,2) as [Extended]  
--from      
-- yukon_invoice_cr_memo_mstr icmm with (nolock)      
-- left join yukon_invoice_cr_memo_det icmd with (nolock) on icmd.cm_id = icmm.cm_id      
--where      
-- invoice_no = @invoice_no      
      
--UNION       
      
---- cash receipts      
--select            
-- apptoamt as [Extended]
--from       
-- accounting_invoice_payments      
--where      
-- custnmbr = @customer_id      
-- and aptodcnm = cast(@invoice_no as varchar(30))      
-- and apfrdcty = 9 --- payment       
     
-- UNION
      
---- cash receipts history    
--select            
-- apptoamt as [Extended]
--from       
-- accounting_invoice_payments_history      
--where      
-- custnmbr = @customer_id      
-- and aptodcnm = cast(@invoice_no as varchar(30))      
-- and apfrdcty = 9 --- payment   
 
--)t1    

--update @items
--set invoice_net = (select sum(invoice_amount) from @items) - @credits

select * from @items 

-- print @credits
GO
PRINT N'Creating Procedure [dbo].[vs_rptSchedulingMonthlyAppointmentCalendar]...';


GO
CREATE procedure [dbo].[vs_rptSchedulingMonthlyAppointmentCalendar]
	@account_org_id uniqueidentifier,
	@begin_date datetime = null,
	@end_date datetime = null,
	@security_token uniqueidentifier
as
/*
	This stored procedure creates a monthly calendar style report for homebuyer design center appointments.
	It is intended for eventual output to Excel.

	Usage: 
	
	vs_rptSchedulingMonthlyAppointmentCalendar '34c914cd-5dc8-4574-ac4e-f70a7f873832','07/01/2013','07/31/2013','60342319-ab01-4f1c-bf96-51f9946b8fa3'
	vs_rptSchedulingMonthlyAppointmentCalendar 'CC2A0C00-FD76-408C-AFCB-3C5134671848', '02/01/2014', '02/28/2014', null

	select * from veosolutionssecurity.dbo.organizations
	select * from veosolutionssecurity.dbo.account_organizations where organization_id = '577BFBA0-4089-4229-BAA1-EE84C85A4D1F'
*/
set nocount on 

--declare @active_user_id varchar(100)
--set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
--if @active_user_id is null
--begin
--	raiserror('Invalid security token',16,1)
--	return
--end

-- set the dates if incoming dates are null
if (@begin_date is null) set @begin_date = DATEADD(dd, DATEDIFF(dd, 0, getdate()), 0)


declare @calendar table 
(
	sort_order int,
	sunday  varchar(100),
	monday  varchar(100),
	tuesday  varchar(100),
	wednesday  varchar(100),
	thursday  varchar(100),
	friday  varchar(100),
	saturday  varchar(100),
	saturday_date date,
	line_type varchar(100)
)
-------------------------------
-- Set up a cursor for the data
-------------------------------
declare @buyer_name varchar(100)
declare @community_name varchar(100)
declare @appointment_date datetime
declare @appointment_type varchar(20)
declare @sales_counselor_name varchar(50)

declare c cursor for
select
	buyer_name,
	community_name,
	appointment_date,
	t.abbrev,
	dbo.ef_selSalesCounselorNameFromProfilePlan(aoupp.account_id, aoupp.organization_id, aoupp.[user_id], aoupp.community_name, aoupp.series, aoupp.plan_name) as sales_counselor
from 
	veosolutionssecurity_account_organizations ao with (nolock)
	left join scheduling_appointments sa with (nolock) on sa.account_org_id = ao.account_org_id
    left join account_organization_user_profile_plan aoupp with (nolock) on aoupp.profile_id = dbo.ef_selSchedulingBuyerActiveProfilePlan(sa.buyer_profile_id)
	left join scheduling_buyers sb with (nolock) on sb.profile_id = sa.buyer_profile_id
	left join scheduling_appointment_types t with (nolock) on t.appointment_type = sa.appointment_type
where 
	ao.account_org_id = @account_org_id
	and community_name is not null
	and appointment_date is not null
	and appointment_date >= @begin_date
	and (@end_date is null or appointment_date <= @end_date)
order by 
	appointment_date, buyer_name

declare @last_appointment_date datetime = null
declare @sort_order int = 0
declare @last_saturday_date date = null

--------------------------------------------------------------------------------------------------
-- Process the records, 1 row at a time, inserted the required data into the appropriate date slot
--------------------------------------------------------------------------------------------------
open c
fetch next from c into @buyer_name, @community_name, @appointment_date, @appointment_type, @sales_counselor_name
while @@fetch_status = 0 -- and @sort_order < 9
begin

	-- print @buyer_name + '>' + cast(@appointment_date as varchar(20))

	-- get the week beginning and week ending date of the current appointment
	declare @sunday_date date = dateadd(dw, (-1) * DATEPART(dw, cast(@appointment_date as date) ) + @@DATEFIRST % 7 + 1, cast(@appointment_date as date)) 
	declare @saturday_date date = dateadd(day,6,@sunday_date)

	-- insert a "Date" row here if the appointment date represents a different week 
	if @last_saturday_date is null or @last_saturday_date <> @saturday_date
	begin
		insert into @calendar (sort_order, sunday, monday, tuesday, wednesday, thursday, friday, saturday,line_type)
		select @sort_order, '----------------------------------------', '----------------------------------------', '----------------------------------------', '----------------------------------------', '----------------------------------------', '----------------------------------------', '----------------------------------------','separator'
		set @sort_order = @sort_order + 1

		insert into @calendar (sort_order, sunday, monday, tuesday, wednesday, thursday, friday, saturday, saturday_date, line_type)
		select
			@sort_order,
			convert(varchar(20),dateadd(day,0,@sunday_date),107),
			convert(varchar(20),dateadd(day,1,@sunday_date),107),
			convert(varchar(20),dateadd(day,2,@sunday_date),107),
			convert(varchar(20),dateadd(day,3,@sunday_date),107),
			convert(varchar(20),dateadd(day,4,@sunday_date),107),
			convert(varchar(20),dateadd(day,5,@sunday_date),107),
			convert(varchar(20),dateadd(day,6,@sunday_date),107),
			@saturday_date,
			'date'
		set @sort_order = @sort_order + 1

		insert into @calendar (sort_order, sunday, monday, tuesday, wednesday, thursday, friday, saturday, line_type)
		select @sort_order, '----------------------------------------', '----------------------------------------', '----------------------------------------', '----------------------------------------', '----------------------------------------', '----------------------------------------', '----------------------------------------','separator'
		set @sort_order = @sort_order + 1
	end

	-- if a row exists where the weekday slot is null, do an update. Otherwise, insert a new row
	if exists(select sort_order from @calendar where saturday_date = @saturday_date and 
		(case 
			when lower(datename(dw,@appointment_date)) = 'sunday' then sunday
			when lower(datename(dw,@appointment_date)) = 'monday' then monday
			when lower(datename(dw,@appointment_date)) = 'tuesday' then tuesday
			when lower(datename(dw,@appointment_date)) = 'wednesday' then wednesday
			when lower(datename(dw,@appointment_date)) = 'thursday' then thursday
			when lower(datename(dw,@appointment_date)) = 'friday' then friday
			when lower(datename(dw,@appointment_date)) = 'saturday' then saturday
		end) is null)
	begin
		
		-- empty row (spacer)
		if lower(datename(dw,@appointment_date)) = 'sunday' update @calendar set sunday	= '[SPACE]' where saturday_date = @saturday_date and sunday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and sunday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'monday' update @calendar set monday	= '[SPACE]' where saturday_date = @saturday_date and monday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and monday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'tuesday' update @calendar set tuesday = '[SPACE]' where saturday_date = @saturday_date and tuesday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and tuesday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'wednesday' update @calendar set wednesday	= '[SPACE]' where saturday_date = @saturday_date and wednesday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and wednesday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'thursday' update @calendar set thursday	= '[SPACE]' where saturday_date = @saturday_date and thursday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and thursday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'friday' update @calendar set friday	= '[SPACE]' where saturday_date = @saturday_date and friday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and friday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'saturday' update @calendar set saturday	= '[SPACE]' where saturday_date = @saturday_date and saturday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and saturday is null order by sort_order)

		-- buyer name row
		if lower(datename(dw,@appointment_date)) = 'sunday' update @calendar set sunday	= @buyer_name + ' (' + @appointment_type + ')' where saturday_date = @saturday_date and sunday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and sunday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'monday' update @calendar set monday	= @buyer_name + ' (' + @appointment_type + ')' where saturday_date = @saturday_date and monday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and monday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'tuesday' update @calendar set tuesday = @buyer_name + ' (' + @appointment_type + ')' where saturday_date = @saturday_date and tuesday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and tuesday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'wednesday' update @calendar set wednesday = @buyer_name + ' (' + @appointment_type + ')' where saturday_date = @saturday_date and wednesday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and wednesday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'thursday' update @calendar set thursday	= @buyer_name + ' (' + @appointment_type + ')' where saturday_date = @saturday_date and thursday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and thursday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'friday' update @calendar set friday	= @buyer_name + ' (' + @appointment_type + ')' where saturday_date = @saturday_date and friday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and friday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'saturday' update @calendar set saturday	= @buyer_name + ' (' + @appointment_type + ')' where saturday_date = @saturday_date and saturday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and saturday is null order by sort_order)
		-- community name row
		if lower(datename(dw,@appointment_date)) = 'sunday' update @calendar set sunday	= @community_name + ' (' + @sales_counselor_name + ')' where saturday_date = @saturday_date and sunday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and sunday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'monday' update @calendar set monday	= @community_name + ' (' + @sales_counselor_name + ')' where saturday_date = @saturday_date and monday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and monday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'tuesday' update @calendar set tuesday	= @community_name + ' (' + @sales_counselor_name + ')' where saturday_date = @saturday_date and tuesday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and tuesday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'wednesday' update @calendar set wednesday	= @community_name + ' (' + @sales_counselor_name + ')' where saturday_date = @saturday_date and wednesday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and wednesday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'thursday' update @calendar set thursday	= @community_name + ' (' + @sales_counselor_name + ')' where saturday_date = @saturday_date and thursday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and thursday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'friday' update @calendar set friday	= @community_name + ' (' + @sales_counselor_name + ')' where saturday_date = @saturday_date and friday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and friday is null order by sort_order)
		if lower(datename(dw,@appointment_date)) = 'saturday' update @calendar set saturday	= @community_name + ' (' + @sales_counselor_name + ')' where saturday_date = @saturday_date and saturday is null and sort_order = (select top 1 sort_order from @calendar where saturday_date = @saturday_date and saturday is null order by sort_order)

	end
	else
	begin
		-- empty row (spacer)
	
		if lower(datename(dw,@appointment_date)) = 'sunday' insert into @calendar (sort_order, sunday, saturday_date, line_type) values (@sort_order, '[SPACE]', @saturday_date,'spacer')
		if lower(datename(dw,@appointment_date)) = 'monday' insert into @calendar (sort_order, monday, saturday_date, line_type) values (@sort_order, '[SPACE]', @saturday_date,'spacer')
		if lower(datename(dw,@appointment_date)) = 'tuesday' insert into @calendar (sort_order, tuesday, saturday_date, line_type) values (@sort_order, '[SPACE]', @saturday_date,'spacer')
		if lower(datename(dw,@appointment_date)) = 'wednesday' insert into @calendar (sort_order, wednesday, saturday_date, line_type) values (@sort_order, '[SPACE]', @saturday_date,'spacer')
		if lower(datename(dw,@appointment_date)) = 'thursday' insert into @calendar (sort_order, thursday, saturday_date, line_type) values (@sort_order, '[SPACE]', @saturday_date,'spacer')
		if lower(datename(dw,@appointment_date)) = 'friday' insert into @calendar (sort_order, friday, saturday_date, line_type) values (@sort_order, '[SPACE]', @saturday_date,'spacer')
		if lower(datename(dw,@appointment_date)) = 'saturday' insert into @calendar (sort_order, saturday, saturday_date, line_type) values (@sort_order, '[SPACE]', @saturday_date,'spacer')
		
		set @sort_order = @sort_order + 1
		-- buyer name row
		if lower(datename(dw,@appointment_date)) = 'sunday' insert into @calendar (sort_order, sunday, saturday_date, line_type) values (@sort_order, @buyer_name + ' (' + @appointment_type + ')', @saturday_date,'homebuyer')
		if lower(datename(dw,@appointment_date)) = 'monday' insert into @calendar (sort_order, monday, saturday_date, line_type) values (@sort_order, @buyer_name + ' (' + @appointment_type + ')', @saturday_date,'homebuyer')
		if lower(datename(dw,@appointment_date)) = 'tuesday' insert into @calendar (sort_order, tuesday, saturday_date, line_type) values (@sort_order, @buyer_name + ' (' + @appointment_type + ')', @saturday_date,'homebuyer')
		if lower(datename(dw,@appointment_date)) = 'wednesday' insert into @calendar (sort_order, wednesday, saturday_date, line_type) values (@sort_order, @buyer_name + ' (' + @appointment_type + ')', @saturday_date,'homebuyer')
		if lower(datename(dw,@appointment_date)) = 'thursday' insert into @calendar (sort_order, thursday, saturday_date, line_type) values (@sort_order, @buyer_name + ' (' + @appointment_type + ')', @saturday_date,'homebuyer')
		if lower(datename(dw,@appointment_date)) = 'friday' insert into @calendar (sort_order, friday, saturday_date, line_type) values (@sort_order, @buyer_name + ' (' + @appointment_type + ')', @saturday_date,'homebuyer')
		if lower(datename(dw,@appointment_date)) = 'saturday' insert into @calendar (sort_order, saturday, saturday_date, line_type) values (@sort_order, @buyer_name + ' (' + @appointment_type + ')', @saturday_date,'homebuyer')
		set @sort_order = @sort_order + 1
		-- community name row
		if lower(datename(dw,@appointment_date)) = 'sunday' insert into @calendar (sort_order, sunday, saturday_date, line_type) values (@sort_order, @community_name + ' (' + @sales_counselor_name + ')', @saturday_date,'community')
		if lower(datename(dw,@appointment_date)) = 'monday' insert into @calendar (sort_order, monday, saturday_date, line_type) values (@sort_order, @community_name + ' (' + @sales_counselor_name + ')', @saturday_date,'community')
		if lower(datename(dw,@appointment_date)) = 'tuesday' insert into @calendar (sort_order, tuesday, saturday_date, line_type) values (@sort_order, @community_name + ' (' + @sales_counselor_name + ')', @saturday_date,'community')
		if lower(datename(dw,@appointment_date)) = 'wednesday' insert into @calendar (sort_order, wednesday, saturday_date, line_type) values (@sort_order, @community_name + ' (' + @sales_counselor_name + ')', @saturday_date,'community')
		if lower(datename(dw,@appointment_date)) = 'thursday' insert into @calendar (sort_order, thursday, saturday_date, line_type) values (@sort_order, @community_name + ' (' + @sales_counselor_name + ')', @saturday_date,'community')
		if lower(datename(dw,@appointment_date)) = 'friday' insert into @calendar (sort_order, friday, saturday_date, line_type) values (@sort_order, @community_name + ' (' + @sales_counselor_name + ')', @saturday_date,'community')
		if lower(datename(dw,@appointment_date)) = 'saturday' insert into @calendar (sort_order, saturday, saturday_date, line_type) values (@sort_order, @community_name + ' (' + @sales_counselor_name + ')', @saturday_date,'community')
	
	end

	set @sort_order = @sort_order + 1
	set @last_appointment_date = @appointment_date
	set @last_saturday_date = @saturday_date
	fetch next from c into @buyer_name, @community_name, @appointment_date, @appointment_type, @sales_counselor_name
end
close c
deallocate c

declare @builder_name varchar(100) 
select top 1  
	@builder_name = name 
from 
	VeoSolutionsSecurity_account_organizations ao with (nolock)
	left join VeoSolutionsSecurity_organizations o with (nolock) on o.organization_id = ao.organization_id
where 
	ao.account_org_id = @account_org_id


-- remove spaces
update 
	@calendar 
set monday = '' where monday = '[SPACE]' 
update 
	@calendar 
set tuesday = '' where tuesday = '[SPACE]' 
update 
	@calendar 
set wednesday = '' where wednesday = '[SPACE]' 
update 
	@calendar 
set thursday = '' where thursday = '[SPACE]' 
update 
	@calendar 
set friday = '' where friday = '[SPACE]' 
update 
	@calendar 
set saturday = '' where saturday = '[SPACE]' 

select 
	@builder_name as builder,
	@begin_date as begin_date,
	@end_date as end_date,
	isnull(sunday,'') as Sunday, 
	isnull(monday,'') as Monday, 
	isnull(tuesday,'') as Tuesday, 
	isnull(wednesday,'') as Wednesday, 
	isnull(thursday,'') as Thursday, 
	isnull(friday,'') as Friday, 
	isnull(saturday,'') as Saturday,
	line_type
from 
	@calendar
where 
	line_type <> 'separator'
order by
	sort_order
GO
PRINT N'Creating Procedure [dbo].[vs_rptSelectionsPatterns]...';


GO
CREATE proc [dbo].[vs_rptSelectionsPatterns]
@session_id uniqueidentifier
-- @security_token uniqueidentifier

as

/*
dselect * from catalog_selections_area_details where session_id = 'b20b8ac3-93cf-445e-9c6d-6a4be40d5716' and area = 'bedroom 2'
Richard Gladstone
14102 Kellywood
Blk: 
Lot: 0
Lakes of Pine Forest
None
BANDERA
6caba686-b9ad-457b-9727-daf7c5abbb60

-- vs_rptSelectionsPatterns '6caba686-b9ad-457b-9727-daf7c5abbb60'

*/

--declare @active_user_id varchar(100)
--set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)	

--if @active_user_id is null
--begin
--	raiserror('Insufficient rights to execute query.',16,1)
--	return
--end

declare @work_table table
(
	area varchar(50),
	sub_area varchar(50),
	area_sub_area varchar(100),
	pattern_id int,
	item_id varchar(50),
	item_id_description varchar(50),
	sort_order int,
	name varchar(100),
	image_data varbinary(max),
	group_id int,
	bom varchar(max),
	areas varchar(max),
	notes varchar(max)
)

--select
--	csa.area
--	,csa.sub_area
--	,csa.area + case when len( rtrim(csa.sub_area) ) > 0 then ' / ' else '' end + csa.sub_area as area_sub_area
--	,csa.pattern_id
--    ,'Pattern' as item_id
--	,'Pattern' as item_id_description
--	,0 as sort_order
--    ,'' as name
--    ,pp.[image_data] as image_data
--	,notes
--FROM 
--	catalog_selections_areas csa with (nolock)
--	left join Veo_product_patterns pp on pp.pattern_id = csa.pattern_id 
--where 
--	csa.session_id = @session_id
--	and csa.selected != 0
--	and csa.pattern_id > 0
--	and csa.product <> 'CARPET'

-- select * from catalog_selections_areas where session_id = '6caba686-b9ad-457b-9727-daf7c5abbb60'
insert into @work_table (area, sub_area, area_sub_area, pattern_id, item_id, item_id_description, sort_order, name, image_data, notes)
select
	csa.area
	,csa.sub_area
	,csa.area + case when len( rtrim(csa.sub_area) ) > 0 then ' / ' else '' end + csa.sub_area as area_sub_area
	,csa.pattern_id
    ,'Pattern' as item_id
	,'Pattern' as item_id_description
	,0 as sort_order
    ,'' as name
    ,pp.[image_data] as image_data
	,notes
FROM 
	catalog_selections_areas csa with (nolock)
	left join Veo_product_patterns pp on pp.pattern_id = csa.pattern_id 
where 
	csa.session_id = @session_id
	and csa.area_selected = 1
	and csa.selected != 0
	and csa.pattern_id > 0
	and csa.product <> 'CARPET'

UNION

select
	csad.area
	,csad.sub_area
	,csa.area + case when len( rtrim(csa.sub_area) ) > 0 then ' / ' else '' end + csa.sub_area as area_sub_area
	,csa.pattern_id
	,csad.item_id
    ,isnull(vpi.description, csad.[item_id])
	,case csad.item_id when 'field' then 1 when 'grout' then 999 else 2 end as sort_order
    ,isnull(col.name,'NO SELECTION !!! ')
    ,ppm.[image_data] as 'material_image_data'
	,isnull(csa.notes,'') + case len(isnull(csa.notes,'')) when 0 then '' else char(13)+char(10) end + case len(isnull(csad.accent_prompt,'')) when 0 then '' else 'Accent Size: ' end + csad.accent_prompt
FROM 
	catalog_selections_areas csa with (nolock)
	left join catalog_selections_area_details csad with (nolock) on csa.session_id = csad.session_id and csa.area = csad.area and csa.application = csad.application and csa.product = csad.product
	left join veo_applications va with (nolock) on va.name = csad.application
	left join veo_products vp with (nolock) on vp.name = csad.product
	left join Veo_product_patterns_material ppm on csa.pattern_id = ppm.pattern_id and csad.item_id = ppm.[item_id] 
	left join Veo_colors col on csad.real_item_id = col.part_no  
	left join Veo_plan_items vpi with (nolock) on vpi.application_id = va.application_id and vpi.product_id = vp.product_id and vpi.item_type = csad.item_type and vpi.item_id = csad.item_id
where 
	csad.session_id = @session_id
	and csa.area_selected = 1
	and csa.selected != 0
	and csad.selectable != 0
	and csa.pattern_id > 0
	and csa.product <> 'CARPET'

-- select * from @work_table 

declare @done bit = 0

declare @pattern_id int
declare @item_id varchar(max)
declare @real_item_id varchar(max)
declare @area_sub_area varchar(max)
declare @bom varchar(max) = ''

-- first, build the selected BOM for an unprocessed area / sub area
while @done = 0
begin
	select top 1 @area_sub_area = area_sub_area from @work_table where bom is null
	set @bom = ''
	select @bom = @bom + cast(pattern_id as varchar(10)) + item_id + name from @work_table where area_sub_area = @area_sub_area order by item_id
	update @work_table set bom = @bom where area_sub_area = @area_sub_area

	-- are we done yet?
	if exists ( select name from @work_table where bom is null)
		set @done = 0
	else
		set @done = 1
end 

-- vs_rptSelectionsPatterns '6caba686-b9ad-457b-9727-daf7c5abbb60'

-- now there is a basis for comparison between area/sub areas (+ notes)
-- select a concatenation of the area_sub_area where the BOMs are the same
set @done = 0
while @done = 0
begin
	select top 1 @bom = bom from @work_table where areas is null
	set @area_sub_area = ''
	select @area_sub_area = @area_sub_area + area_sub_area + '; ' from @work_table where bom = @bom and item_id = 'pattern'

	-- strip the final semicolon? This should NOT work for the comparison below
	--if len(@area_sub_area) > 0
	--	set @area_sub_area = SUBSTRING(@area_sub_area,1,len(@area_sub_area)-1)

	-- print @area_sub_area

	update @work_table set areas = @area_sub_area where bom = @bom

	-- are we done yet?
	if exists ( select name from @work_table where areas is null)
		set @done = 0
	else
		set @done = 1
end


-- final select
select 
	area,
	sub_area,
	area_sub_area,
	pattern_id,
	item_id,
	item_id_description,
	sort_order,
	name,
	image_data,
	group_id,
	bom,
	case 
		when len(areas) > 0
			then substring(areas,1,len(areas)-1)
		else ''
	end as areas,
	notes
from 
	@work_table 
where 
	areas like area + ';%' 
	and image_data is not null
	--or areas = area
order by 
	area, sub_area, sort_order
GO
PRINT N'Creating Procedure [dbo].[vs_rptStructuralOptionsBySession]...';


GO

CREATE procedure [dbo].[vs_rptStructuralOptionsBySession]  
  
@session_id uniqueidentifier,	-- set @session_id = '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2'  
@mode int						-- 2=All rows regardless of whether the areas were selected
								-- 1=Selected rows (Selected > 0)
								-- 0=Selected + Unselected where area + sub area has not been selected for another product 
  
  
/*  
vs_rptStructuralOptionsBySession '15C5863A-B953-4BB0-B06A-C3B125C0990D',2  
vs_rptStructuralOptionsBySession '15C5863A-B953-4BB0-B06A-C3B125C0990D',1
vs_rptStructuralOptionsBySession '15C5863A-B953-4BB0-B06A-C3B125C0990D',0
vs_rptStructuralOptionsBySession 'c4ccf00f-1289-442f-a4ad-27ac7993aa37',1  
vs_rptStructuralOptionsBySession 'c4ccf00f-1289-442f-a4ad-27ac7993aa37',2  
vs_rptStructuralOptionsBySession 'd0618e64-55f0-4cd6-8877-3c136f056bf3',0
vs_rptStructuralOptionsBySession 'd0618e64-55f0-4cd6-8877-3c136f056bf3',1
vs_rptStructuralOptionsBySession 'd0618e64-55f0-4cd6-8877-3c136f056bf3',2
*/  
  
--select * from account_organization_user_profile_plan_catalog_sessions where session_id = '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2'  
--select * from catalog_selections where session_id = '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2'  
--select * from catalog_selections_areas where session_id = 'd5a727af-9465-4f40-88ad-4017d4d4897b'
--select * from catalog_selections_areas where session_id = '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2'
--select * from catalog_selections_area_details where session_id = '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2' and application = 'countertops'  
as  

--2/6/13 changed references from 'selected' to 'area_selected' -ADG


if @mode = 2  
begin  
 select   
  *   
 from  
  catalog_selections_areas   
 where   
  session_id = @session_id  
 order by  
  --[selected] desc,  
  [application],  
  product,  
  area  
end  
else if @mode = 1  
begin  
 select   
  *   
 from  
  catalog_selections_areas   
 where   
  session_id = @session_id  
  and selected > 0
  and area_selected = 1
 order by  
  --selected desc,  
  application,  
  product,  
  area  
end  
else if @mode = 0  
begin  
	select   
		*   
	from  
		catalog_selections_areas csa with (nolock)
--		left join catalog_selections_area_details csad with (nolock) on csa.session_id = csa.session_id and csad.application = csa.application and csad.product = csa.product and csad.area = csa.area and csad.sub_area = csa.sub_area 
	where   
		csa.session_id = @session_id  
		and area_selected = 1
		and selected > 0

 union all

	select   
		*   
	from  
		catalog_selections_areas  csa with (nolock)
--		left join catalog_selections_area_details csad with (nolock) on csa.session_id = csa.session_id and csad.application = csa.application and csad.product = csa.product and csad.area = csa.area and csad.sub_area = csa.sub_area 
	where   
		csa.session_id = @session_id  
		and selected = 0
		and area_selected = 1	
		and (area_id + '|' + sub_area_id) not in (select area_id + '|' + sub_area_id from catalog_selections_areas where session_id = @session_id and area_selected = 1 and selected > 0)
 order by  
  csa.application,  
  csa.product,  
  csa.area  
end
GO
PRINT N'Creating Procedure [dbo].[vs_rptStructuralOptionsProductSelectionsDetail]...';


GO
CREATE procedure [dbo].[vs_rptStructuralOptionsProductSelectionsDetail]

@session_id uniqueidentifier,		-- set @session_id = '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2'
@application varchar(100),
@product varchar(100),
@area varchar(100),
@sub_area varchar(100),
@mode int,							-- 2=All 1=Selected 0=Unselected
@selectable_only bit

/*
update 
	catalog_selections_area_details set real_item_id = '' 
where
	session_id = '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2'
	and application = 'countertops'
	and area = 'Kitchen w/Cooktop'
	and item_id = 'edge'
vs_rptStructuralOptionsBySession '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2',0
vs_rptStructuralOptionsProductSelectionsDetail 'd5a727af-9465-4f40-88ad-4017d4d4897b','Flooring','Tile','Master Bedroom','',1,1
vs_rptStructuralOptionsBySession '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2',2
*/

--select * from account_organization_user_profile_plan_catalog_sessions where session_id = '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2'
--select * from catalog_selections where session_id = '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2'
-- select * from catalog_selections_area_details where session_id = 'd5a727af-9465-4f40-88ad-4017d4d4897b' and application = 'flooring' and product = 'carpet' and area = 'Master Bedroom'
-- select * from catalog_selections_area_details where session_id = 'd5a727af-9465-4f40-88ad-4017d4d4897b' 
as
if @mode = 2
begin
	select 
		csad.* ,
		case 
			when csad.session_id is null then 'All selections missing'
			else ''
		end as [AllMissing]
	from
	  catalog_selections_areas csa with (nolock)
		left join catalog_selections_area_details csad with (nolock) on csad.session_id = csa.session_id
	where 
		csa.session_id = @session_id
		and csa.application = @application
		and csa.product = @product
		and csa.area = @area
		and csa.sub_area = @sub_area
		and (@selectable_only = 0 or selectable = 1 or selectable is null)
	order by
		item_type,
		item_id
end
else if @mode = 1
begin
	select 
		csad.*,
		case 
			when csad.session_id is null then 'All selections missing'
			else ''
		end as [AllMissing]
	from
	  catalog_selections_areas csa with (nolock)
		left join catalog_selections_area_details csad with (nolock) on csad.session_id = csa.session_id and csad.application = csa.application and csad.product = csa.product and csad.area = csa.area
	where 
		csa.session_id = @session_id
		and csa.application = @application
		and csa.product = @product
		and csa.area = @area
		and csa.sub_area = @sub_area
		and (@selectable_only = 0 or selectable = 1 )
		and (real_item_id <> '' )
	order by
		item_type,
		item_id
end
else if @mode = 0
begin
	select 
		csad.*,
		case 
			when csad.session_id is null then 'All selections missing'
			else ''
		end as [AllMissing]
	from
	  catalog_selections_areas csa with (nolock)
		left join catalog_selections_area_details csad with (nolock) on csad.session_id = csa.session_id and csad.application = csa.application and csad.product = csa.product and csad.area = csa.area
	where 
		csa.session_id = @session_id
		and csa.application = @application
		and csa.product = @product
		and csa.area = @area
		and csa.sub_area = @sub_area
		and (@selectable_only = 0 or selectable = 1 or selectable is null)
		and (real_item_id = '' or real_item_id is null)
	order by
		item_type,
		item_id
end
else
	raiserror('Invalid mode passed to vs_rptStructuralOptionsProductSelectionsDetail %d',16,1,@mode)
GO
PRINT N'Creating Procedure [dbo].[vs_selAccountOrganizationCatalogSession]...';


GO

create procedure [dbo].[vs_selAccountOrganizationCatalogSession]

@session_id uniqueidentifier

as

select 
	* 
from account_organization_user_profile_plan_catalog_sessions
where 
	session_id = @session_id
GO
PRINT N'Creating Procedure [dbo].[vs_selAccountOrganizationCatalogSessions]...';


GO
CREATE procedure [dbo].[vs_selAccountOrganizationCatalogSessions]

@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier,
@community varchar(100)='',
@series varchar(100)='',
@plan varchar(100)= ''



as

select 
	*,
	selection_count = (select count(*) from catalog_selections where session_id = ppcs.session_id and selected = 1) + (select count(*) from catalog_selections_areas where session_id = ppcs.session_id and selected != 0)
from account_organization_user_profile_plan_catalog_sessions ppcs with(nolock)
where 
	account_id = @account_id
	and organization_id = @organization_id
	and user_id = @user_id
	and community_name = @community
	and series = @series
	and plan_name = @plan
GO
PRINT N'Creating Procedure [dbo].[vs_selAccountOrganizationDocumentData]...';


GO


CREATE procedure [dbo].[vs_selAccountOrganizationDocumentData]
(
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@doc_id uniqueidentifier
)
as
select
	doc_data

from account_organization_documents
where
	account_id = @account_id
	and organization_id = @organization_id
	and doc_id = @doc_id
GO
PRINT N'Creating Procedure [dbo].[vs_selAccountOrganizationDocuments]...';


GO
/*

vs_selAccountOrganizationDocuments 'bab32b7e-3ada-497c-862e-e5083971cc59','bab32b7e-3ada-497c-862e-e5083971cc59','',''
vs_selAccountOrganizationDocuments 'BAB32B7E-3ADA-497C-862E-E5083971CC59','41e2b9ca-9b05-4c7a-9994-8dbd48660ff9',
*/
CREATE procedure [dbo].[vs_selAccountOrganizationDocuments]
(
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@application varchar(100),
@product varchar(100)
)
as
select 
	account_id, 
	organization_id, 
	doc_id, 
	application, 
	product, 
	description, 
	notes, 
	author,
	create_date, 
	modifier, 
	modified_date,
	size,
	type,
	url

from account_organization_documents with (nolock)
where
	account_id = @account_id
	and organization_id = @organization_id
	and (application = @application or @application = '' or @application = 'All' or application = 'All')
	and (product = @product	or @product = '' or @product = 'All' or product = 'All')

order by modified_date desc
GO
PRINT N'Creating Procedure [dbo].[vs_selAccountOrganizationUserProfile]...';


GO
create procedure [dbo].[vs_selAccountOrganizationUserProfile]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier
as
select
	*
from account_organization_user_profile
where account_id = @account_id
	and organization_id = @organization_id
	and [user_id] = @user_id
GO
PRINT N'Creating Procedure [dbo].[vs_selAccountOrganizationUserProfilePlanBySessionID]...';


GO

CREATE procedure [dbo].[vs_selAccountOrganizationUserProfilePlanBySessionID]
(
@session_id uniqueidentifier
)
as

/*
vs_selAccountOrganizationUserProfilePlanBySessionID '90d6e813-5278-4882-9656-ce25534a3303'

*/

--locate acc,org,user

declare @account_id uniqueidentifier
declare @organization_id uniqueidentifier
declare @user_id uniqueidentifier
declare @community_name varchar(50)
declare @series varchar(50)
declare @plan_name varchar(50)
declare @user_profile_id uniqueidentifier 

select 
 @account_id = p.account_id,
 @organization_id = p.organization_id,
 @user_id = p.user_id,
 @community_name = s.community_name,
 @series = s.series,
 @plan_name = s.plan_name, 
 @user_profile_id = up.profile_id 
from 
	account_organization_user_profile_plan_catalog_sessions s with (nolock)
	left join account_organization_user_profile_plan p with (nolock) on 
		p.account_id = s.account_Id
		and p.organization_id = s.organization_id
		and p.user_id = s.user_id
	left join account_organization_user_profile up on up.account_id = p.account_id and up.organization_id = p.organization_id and up.user_id = p.user_id 
where 
	s.session_id = @session_id



select 
	*, 
	@user_profile_id as user_profile_id,
	o.property_desc_1_label,
	o.property_desc_2_label
from 
	account_organization_user_profile_plan aoupp with (nolock)
	left join veosolutionssecurity_organizations o with (nolock) on o.organization_id = aoupp.organization_id
where
	account_id = @account_id
	and aoupp.organization_id = @organization_id
	and [user_id] = @user_id
	and community_name = @community_name
	and series = @series
	and plan_name = @plan_name
GO
PRINT N'Creating Procedure [dbo].[vs_selAccountOrganizationUserProfilePlanCatalogSessionsDocuments]...';


GO
CREATE proc [dbo].[vs_selAccountOrganizationUserProfilePlanCatalogSessionsDocuments]  
@session_id uniqueidentifier  
  
/*  
[vs_selAccountOrganizationUserProfilePlanCatalogSessionsDocuments] '3E5AD6BE-3A82-4F45-96EA-083259E0D3CA'  
*/  
  
as  
  
SELECT   
 *
FROM   
 account_organization_user_profile_plan_catalog_sessions_documents
where   
 session_id = @session_id  
order by   
 [document_TYPE] asc
GO
PRINT N'Creating Procedure [dbo].[vs_selAccountOrganizationUserProfilePlanOptionsBudgetItems]...';


GO

create procedure [dbo].[vs_selAccountOrganizationUserProfilePlanOptionsBudgetItems]
(
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier,
@community varchar(50),
@series varchar(50),
@plan_name varchar(50)
)
as
select * from 
account_organization_user_profile_plan_options_budget_items
where
	account_id = @account_id
	and organization_id = @organization_id
	and [user_id] = @user_id
	and community = @community
	and series = @series
	and plan_name = @plan_name
GO
PRINT N'Creating Procedure [dbo].[vs_selAccountOrganizationUserProfilePlans]...';


GO
CREATE procedure [dbo].[vs_selAccountOrganizationUserProfilePlans]
(
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier
)
as

select 
	pp.*, 
	p.profile_id as user_profile_id,
	o.property_desc_1_label,
	o.property_desc_2_label
from 
	account_organization_user_profile_plan pp with (nolock)
	left join account_organization_user_profile p with(nolock) on p.account_id = pp.account_id and p.organization_id = pp.organization_id and p.user_id = pp.user_id 
	left join veosolutionssecurity_organizations o with (nolock) on o.organization_id = pp.organization_id
where
	pp.account_id = @account_id
	and pp.organization_id = @organization_id
	and pp.[user_id] = @user_id
GO
PRINT N'Creating Procedure [dbo].[vs_selAccountOrganizationUserWishListItems]...';


GO
CREATE procedure [dbo].[vs_selAccountOrganizationUserWishListItems]

@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier,
@item_type varchar(50) = ''
as


if (@item_type != '') -- return specific wishitem type
begin
	select
		*
	from account_organization_user_wishlist_items
	where 
		account_id = @account_id
		and user_id = @user_id
		and item_type = @item_type
end
else
begin -- return all wish list items
	select
		*
	from account_organization_user_wishlist_items
	where 
		account_id = @account_id
		and organization_id = @organization_id
		and user_id = @user_id
end
GO
PRINT N'Creating Procedure [dbo].[vs_selAccountProductGuidePages]...';


GO
CREATE procedure [dbo].[vs_selAccountProductGuidePages]
@account_id uniqueidentifier 
as
/* Testing
vs_SelAccountProductGuidePages 'bab32b7e-3ada-497c-862e-e5083971cc59' 
*/
select p.*, 
l.* 
from account_product_guide_pages p 
left join account_product_guide_pages_links l on l.page_id = p.page_id 
where account_id = @account_id and active = 1
order by p.Category, p.display_sequence, l.display_sequence
GO
PRINT N'Creating Procedure [dbo].[vs_selAddressSelectionSummaryByArea]...';


GO
create procedure [dbo].[vs_selAddressSelectionSummaryByArea]
	@address varchar(100),
	@customer_id varchar(15)
as

/*
		Procedure:		vs_selAddressSelectionSummaryByArea
		Author:			Richard Gladstone
		Date:			09/02/2016
		Purpose:		Report on all the selections for an address exclusive of promo_credit.

		Usage:			
						[vs_selAddressSelectionSummaryByArea] '205 M','TMAU2008'
						[vs_selAddressSelectionSummaryByArea] '9107 Baysh','TMAU2008','summary'
						[vs_selAddressSelectionSummaryByArea] '3229 Aur','TMAU2008','summary'
						[vs_selAddressSelectionSummaryByArea]'12405 Britta Lane'
						select * from account_organization_user_profile_plan where address = '9107 Bayshore'
						select * from account_organization_user_profile_plan_catalog_sessions where account_id = 'BAB32B7E-3ADA-497C-862E-E5083971CC59' and user_id = 'C60D8D86-562E-4EC1-8E1A-682071C88B4D'
						select * from catalog_selections where session_id = '23B10234-EC7C-4C1E-9765-5EA348C8079A' and item = 'Artisan Finish Granite - Level 1'
						select * from catalog_selections_areas where session_id = '23B10234-EC7C-4C1E-9765-5EA348C8079A' and selected_field_group = '98D0DCC9-B3B4-497F-98E7-00354211F75C'
						select * from catalog_selections_areas where session_id = '23B10234-EC7C-4C1E-9765-5EA348C8079A' AND AREA = 'BATH 2 VANITY'
						SELECT * from catalog_selections where session_id = '23B10234-EC7C-4C1E-9765-5EA348C8079A' and source = 'Prices Landed' order by application, product, area, price -- and row_id = '6330F512-616F-41D0-91E5-4E8BFC333448'
*/

declare @debug bit = 0
declare	@mode varchar(15) = 'summary'

-- =========================================
-- create a table variable to hold the 
-- selections and later on the invoiced total
-- ==========================================
declare @selections table
(
	[session_id] [uniqueidentifier] ,
	spec_id int,
	effective_date datetime,
	profile_date datetime,
	[address] varchar(100),
	plan_name varchar(100),
	plan_description varchar(100),
	[application] [varchar](100) ,
	[product] [varchar](100) ,
	[area] [varchar](100) ,
	[sub_area] [varchar](100) ,
	[item_type] [varchar](20) ,
	[item_id] [varchar](max) ,
	[selectable] [bit] ,
	[real_item_id] [varchar](max) ,
	[item_description] [varchar](max),
	[bill_qty] [decimal](18, 4) ,
	[uom_id] [varchar](9) ,
	[builder_price] [decimal](18, 2) ,
	budget_qty decimal(18,2),
	budget_cost decimal(18,2),
	budget_price decimal(18,2),
	[retail_percentage] [decimal](18, 4) ,
	[retail_percentage_type] [varchar](10) 
)

declare @session_id uniqueidentifier
select 
	@session_id = session_id
from 
	account_organization_user_profile_plan aoupp with (nolock)
	left join account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock) on aoupp.account_id = aouppcs.account_id and aoupp.organization_id = aouppcs.organization_id and aoupp.user_id = aouppcs.user_id and aoupp.community_name = aouppcs.community_name and aoupp.series = aouppcs.series and aoupp.plan_name = aouppcs.plan_name
	left join VeoSolutionsSecurity_organizations o with (nolock) on o.organization_id = aoupp.organization_id
where
	address like @address + '%'
	and o.external_organization_id = @customer_id
order by
	aouppcs.status asc
print @session_id


-- ==============================================================
-- fill the table with ALL ESTIMATED selections, past and present
-- ==============================================================
insert into @selections (session_id, spec_id, effective_date, profile_date, [application]  ,[product]  ,[area]  ,[sub_area]  ,[item_type]  ,[item_id] ,[selectable]  ,[real_item_id], [bill_qty]  ,[uom_id]  ,[builder_price], budget_qty, budget_cost, budget_price, retail_percentage, retail_percentage_type)
select
  d.session_id, aoupp.spec_id, vsm.start_date, aoupp.create_date, 
  d.[application], d.[product] , d.[area], d.[sub_area]  ,s.[item_type]  ,s.[item]  ,[selectable]    ,[real_item_id] , 
  case s.is_credit when 0 then d.bill_qty else 
	case d.item_id when 'credit' then d.credit_qty * -1
	else credit_qty end 
  end 
  ,[uom_id]  ,[builder_price] , s.qty, s.cost, s.price, d.retail_percentage, d.retail_percentage_type
from 
	catalog_selections_area_details d
	left join catalog_selections_areas a with (nolock) on a.session_id = d.session_id and a.[application] = d.[application] and a.product = d.product and a.area = d.area and a.sub_area = d.sub_area
	left join account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock) on aouppcs.session_id = d.session_id
	left join account_organization_user_profile_plan aoupp with (nolock) on aoupp.account_id = aouppcs.account_id and aoupp.organization_id = aouppcs.organization_id and aoupp.user_id = aouppcs.user_id and aoupp.community_name = aouppcs.community_name and aoupp.series = aouppcs.series and aoupp.plan_name = aouppcs.plan_name
	left join VeoSolutionsSecurity_organizations o with (nolock) on o.organization_id = aoupp.organization_id
	left join catalog_selections s with (nolock) on s.session_id = a.session_id and s.row_id = a.selected_field_group
	left join veo_spec_mstr vsm with (nolock) on vsm.spec_id = aoupp.spec_id
where 
	-- aoupp.address like @address + '%'
	d.session_id = @session_id
	and item_id <> 'promo_credit'
	and a.area_selected > 0

-- ==============================================================
-- fill the table with ALL CATALOG selections, past and present
-- ==============================================================
insert into @selections ( session_id, spec_id, effective_date, profile_date, [application]  ,[product]  ,[area]  
	,[sub_area]  ,[item_type]  ,[item_id] ,[selectable]  ,[real_item_id]  , [bill_qty] 
	,[uom_id]  ,[builder_price], budget_qty, budget_cost, budget_price, retail_percentage, retail_percentage_type)
select
	 cs.session_id, aoupp.spec_id,vsm.start_date, aoupp.create_date, [application]  ,[product]  ,[area]  
	 ,[sub_area]  ,[item_type]  ,[item]  ,1, [notes], case selected when 1 then [qty] else 0 end
	, 'Ea' ,0,0,0,0,0,'' 
from 
	catalog_selections cs
	join account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock) on aouppcs.session_id = cs.session_id
	join account_organization_user_profile_plan aoupp with (nolock) on aoupp.account_id = aouppcs.account_id and aoupp.organization_id = aouppcs.organization_id and aoupp.user_id = aouppcs.user_id and aoupp.community_name = aouppcs.community_name and aoupp.series = aouppcs.series and aoupp.plan_name = aouppcs.plan_name
	left join VeoSolutionsSecurity_organizations o with (nolock) on o.organization_id = aoupp.organization_id
	left join veo_spec_mstr vsm with (nolock) on vsm.spec_id = aoupp.spec_id
where 
	aoupp.address like @address+'%'
	and source <> 'Prices Landed'
	and selected = 1
	and o.external_organization_id = @customer_id
	and cs.application <> '' and cs.product <> ''

if @mode = 'detail'
begin
	print 'detail'
	select 
		s.session_id,
		s.spec_id,
		isnull(s.effective_date, '1/1/1900') as effective_date,
		s.profile_date,
		aoupp.series,
		aoupp.plan_name,
		aouppcs.plan_version,
		aoupp.address,
		s.[application]  ,
		s.[product]  ,
		s.[area]  ,
		s.[item_id] ,
		s.real_item_id,
		s.bill_qty,
		s.builder_price,
		s.builder_price * s.bill_qty as ext_bldr_price,
		budget_qty,
		budget_cost,
		s.retail_percentage_type,
		s.retail_percentage
	from 
		@selections s
		left join veo_colors vc with (nolock) on vc.part_no = s.real_item_id
		left join veo_labor_codes vl with (nolock) on vl.code = s.real_item_id
		left join account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock) on aouppcs.session_id = s.session_id
		left join account_organization_user_profile_plan aoupp with (nolock) on aoupp.account_id = aouppcs.account_id and aoupp.organization_id = aouppcs.organization_id and aoupp.user_id = aouppcs.user_id and aoupp.community_name = aouppcs.community_name and aoupp.series = aouppcs.series and aoupp.plan_name = aouppcs.plan_name
		left join veosolutionssecurity_organizations o with (nolock) on o.organization_id = aoupp.organization_id
		left join veosolutionssecurity_users u with (nolock) on u.user_id = aoupp.user_id
	order by
		application,
		product,
		area,
		sub_area
end
else
begin
	create table #summary 
	(
		row_id int,
		session_id uniqueidentifier,
		spec_id int,
		effective_date datetime,
		profile_date datetime,
		series varchar(50),
		plan_name varchar(100),
		plan_description varchar(100),
		[address] varchar(100),
		[application] [varchar](100) ,
		[product] [varchar](100) ,
		[area] [varchar](100) ,
		[item_id] [varchar](max) ,
		ext_price decimal(18,2),
		total varchar(20)
	)

	insert into #summary
	select 
		row_number() over (partition by application, product order by area) as row_id,
		s.session_id,
		s.spec_id,
		s.effective_date,
		s.profile_date,
		aoupp.series,
		aoupp.plan_name,
		aouppcs.plan_version,
		aoupp.address,
		s.[application]  ,
		s.[product]  ,
		s.[area]  ,
		s.[item_id] ,
		sum(round(s.[builder_price] * s.bill_qty,2)) as ext_price,
		'' as total
	from 
		@selections s
		left join veo_colors vc with (nolock) on vc.part_no = s.real_item_id
		left join veo_labor_codes vl with (nolock) on vl.code = s.real_item_id
		left join account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock) on aouppcs.session_id = s.session_id
		left join account_organization_user_profile_plan aoupp with (nolock) on aoupp.account_id = aouppcs.account_id and aoupp.organization_id = aouppcs.organization_id and aoupp.user_id = aouppcs.user_id and aoupp.community_name = aouppcs.community_name and aoupp.series = aouppcs.series and aoupp.plan_name = aouppcs.plan_name
		left join veosolutionssecurity_organizations o with (nolock) on o.organization_id = aoupp.organization_id
		left join veosolutionssecurity_users u with (nolock) on u.user_id = aoupp.user_id
	 group by
		s.session_id,
		s.spec_id,
		s.effective_date,
		s.profile_date,
		aoupp.series,
		aoupp.plan_name,
		aouppcs.plan_version,
		aoupp.address,
		s.[application]  ,
		s.[product]  ,
		s.area,
		s.item_id
	order by
		application,
		product,
		area

	declare @application varchar(50), @product varchar(50), @total decimal(18,2)
	declare c cursor for select application, product, sum(ext_price) from #summary group by application, product order by application, product
	open c
	fetch next from c into @application, @product, @total 
	while @@fetch_status = 0
	begin
		update #summary set total = cast(@total as varchar(20)) where application = @application and product = @product and row_id = (select max(row_id) from #summary where application = @application and product = @product)
		fetch next from c into @application, @product, @total
	end
	close c
	deallocate c

	select 
		--session_id,
		spec_id,
		effective_date,
		profile_date,
		series,
		plan_name,
		plan_description,
		address,
		[application]  ,
		[product]  ,
		[area]  ,
		[item_id] ,
		ext_price,
		total
	from #summary

	drop table #summary

end
GO
PRINT N'Creating Procedure [dbo].[vs_selBuilderFeatureByProfileId]...';


GO
CREATE procedure [dbo].[vs_selBuilderFeatureByProfileId]
@profile_id AS uniqueidentifier,
@feature_id AS int
as
begin 
select bf.organization_id, [feature_id], [value]
from [scheduling_buyers] sb left join account_organization_user_profile aoup on sb.profile_id = aoup.profile_id
		inner join builder_features bf on aoup.organization_id = bf.organization_id
where sb.profile_id  = @profile_id
	and bf.feature_id = @feature_id
end
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogAreaBySessionID]...';


GO

CREATE procedure [dbo].[vs_selCatalogAreaBySessionID]
@session_id uniqueidentifier
as


select 
	*,
	a.name as area_name,
	sa.name as sub_area_name
from catalog_selections_areas csa with (nolock) 
left join veo_areas a with (nolock) on a.area_id = csa.area_id
left join veo_sub_areas sa with (nolock) on sa.sub_area_id = csa.sub_area_id

where csa.session_id = @session_id

order by area_name,sub_area_name,application,product
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogCommunitiesSeriesPlans]...';


GO
create procedure vs_selCatalogCommunitiesSeriesPlans

@account_id uniqueidentifier,
@organization_id uniqueidentifier

as


select 
	distinct
	community,series,[plan]
from catalog_items
where account_id = @account_id and organization_id = @organization_id
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogItems]...';


GO
create procedure [dbo].[vs_selCatalogItems]
@account_id uniqueidentifier,
@organization_id uniqueidentifier
as 

select
	*
from
	catalog_items with (nolock)
where
	account_id = @account_id
	and organization_id = @organization_id
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogItemsApplications]...';


GO

create procedure [dbo].[vs_selCatalogItemsApplications]
@organization_id uniqueidentifier
as
select 
	distinct [application] 
from catalog_items
where organization_id = @organization_id
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogItemsCommunities]...';


GO
CREATE procedure [dbo].[vs_selCatalogItemsCommunities]
@organization_id uniqueidentifier
as
select 
	distinct community 
from catalog_items
where organization_id = @organization_id
      and community != 'All'
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogItemsCommuntiySeriesPlan]...';


GO
CREATE procedure [dbo].[vs_selCatalogItemsCommuntiySeriesPlan]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@community varchar(50)='',
@series varchar(50)='',
@plan varchar(50)=''
as 
/*
vs_selCatalogItemsCommuntiySeriesPlan 'bab32b7e-3ada-497c-862e-e5083971cc59','41e2b9ca-9b05-4c7a-9994-8dbd48660ff9','Cypress Creek Lakes','Plantation','1555'

*/
select
	distinct
	--aoc.name as avail_community_name,
	--aocm.mapped_name,	
	--aoc2.name as mapped_community_name,	
	
	--aos.name as avail_series_name,
	--aos2.name as mapped_sereis_name,
	
	--aop.name as avail_plan_name,
	--aopm.mapped_name,
	--aop2.name as mapped_plan_name,
	
	ci.*,
	doc_count = (select count(*) from gpc_products_documents with (nolock) where gpc_id = try_convert(uniqueidentifier,ci.gpc) )
from
	catalog_items ci with (nolock)
	
-- join to match on community	
left join VeoSolutionsSecurity_account_organization_communities aoc with (nolock) 
	on aoc.account_id = ci.account_id 
	   and aoc.organization_id = ci.organization_id
	   and aoc.name = ci.community
	   
left join VeoSolutionsSecurity_account_organization_communities_mappings aocm with (nolock)
	on aocm.account_id = @account_id
	   and aocm.organization_id = @organization_id
	   and aocm.mapped_name = ci.community
	
left join VeoSolutionsSecurity_account_organization_communities aoc2 with (nolock) 
	on aoc2.account_id = @account_id
	   and aoc2.organization_id = @organization_id
	   and aoc2.community_id = aocm.community_id
	
-- join to match on series	
left join VeoSolutionsSecurity_account_organization_series aos with (nolock) 
	on aos.account_id = ci.account_id 
	   and aos.organization_id = ci.organization_id
	   and aos.name = ci.series
	   
left join VeoSolutionsSecurity_account_organization_series_mappings aosm with (nolock)
	on aosm.account_id = @account_id
	   and aosm.organization_id = @organization_id
	   and aosm.mapped_name = ci.series
	
left join VeoSolutionsSecurity_account_organization_series aos2 with (nolock) 
	on aos2.account_id = @account_id
	   and aos2.organization_id = @organization_id
	   and aos2.series_id = aosm.series_id
	
	
	
	
-- join to match on plan
left join VeoSolutionsSecurity_account_organization_plans aop with (nolock) 
	on aop.account_id = ci.account_id 
	   and aop.organization_id = ci.organization_id
	   and aop.name = ci.[plan]
	   
left join VeoSolutionsSecurity_account_organization_plans_mappings aopm with (nolock)
	on aopm.account_id = @account_id
	   and aopm.organization_id = @organization_id
	   and aopm.mapped_name = ci.[plan]
	
left join VeoSolutionsSecurity_account_organization_plans aop2 with (nolock) 
	on aop2.account_id = @account_id
	   and aop2.organization_id = @organization_id
	   and aop2.plan_id = aopm.plan_id
	
	
where
	ci.account_id = @account_id
	and ci.organization_id = @organization_id
	
	--and (ci.community = @community or ci.community = 'All' or @community = '')	
	and (aoc.name = @community or aoc2.name = @community or ci.community = 'All'  )
	
	--and (ci.series = @series or ci.series = 'All' or @series = '')
	and (aos.name = @series or aos2.name = @series or ci.series = 'All' or ci.series = 'All')
	
	--and (ci.[plan] = @plan or ci.[plan] = 'All' or @plan = '')
	and (aop.name = @plan or aop2.name = @plan or ci.[plan] = 'All')
	
	and ci.option_pricing_display = 1
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogItemsFiltered]...';


GO

CREATE procedure [dbo].[vs_selCatalogItemsFiltered]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@application varchar(50),
@product varchar(50),
@community varchar(50)='',
@series varchar(50)='',
@plan varchar(50)=''
as 
/*
vs_selCatalogItemsFiltered 'bab32b7e-3ada-497c-862e-e5083971cc59','41e2b9ca-9b05-4c7a-9994-8dbd48660ff9','Appliances','Appliance Packages','All','All','All'

*/
select
	distinct
	
	ci.*

from
	catalog_items ci with (nolock)
	
where
	ci.account_id = @account_id
	and ci.organization_id = @organization_id	
	and (ci.application = @application or @application = 'All')
	and (ci.product = @product or @product = 'All')
	and (ci.community = @community or @community = 'All'  )
	and (ci.series = @series or @series = 'All')
	and (ci.[plan]  = @plan or @plan = 'All')
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogItemsPlans]...';


GO
CREATE procedure [dbo].[vs_selCatalogItemsPlans]
@organization_id uniqueidentifier
as
select 
	distinct [plan] 
from catalog_items
where organization_id = @organization_id
	  and [plan] != 'All'
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogItemsProducts]...';


GO

create procedure [dbo].[vs_selCatalogItemsProducts]
@organization_id uniqueidentifier
as
select 
	distinct [product] 
from catalog_items
where organization_id = @organization_id

order by product
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogItemsSeries]...';


GO
CREATE procedure [dbo].[vs_selCatalogItemsSeries]
@organization_id uniqueidentifier
as
select 
	distinct series 
from catalog_items
where organization_id = @organization_id
	  and series != 'All'
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogSelectionAreaDetailOptions]...';


GO
CREATE procedure [dbo].[vs_selCatalogSelectionAreaDetailOptions]
	@session_id uniqueidentifier,
	@application varchar(100),
	@product varchar(100),
	@area varchar(100),
	@sub_area varchar(100),
	@item_type varchar(20),
	@item_id varchar(50)
as
/*
	Author:			Adrian Garza
	Create date:	12/4/2014
	Description:	select bom line options

	Modified: Shelby Mansker
	Date: 2/2/2016
	Description: Returns zeros, or empty strings, instead of nulls so that Veo Solutions
		doesn't crash. 
*/
BEGIN
	SELECT
		session_id,
		[application],
		product,
		area,
		sub_area,
		item_type,
		item_id,
		option_id,
		option_value,
		option_source,
		included,
		ISNULL(qty, 0) AS qty,
		ISNULL(alloc_qty, 0) AS alloc_qty,
		ISNULL(price, 0) AS price,
		ISNULL(price_retail, 0) AS price_retail,
		ISNULL(retail_percentage, 0) AS retail_percentage,
		ISNULL(retail_percentage_type, '') AS retail_percentage_type,
		ISNULL(price_type, '') AS price_type,
		ISNULL(pricing_source, '') AS pricing_source,
		ISNULL([error_message], '') AS [error_message]
	FROM 
		dbo.catalog_selections_area_detail_options WITH (NOLOCK)
	WHERE 
		session_id = @session_id
		AND [application] = @application
		AND product = @product
		AND area = @area
		AND sub_area = @sub_area
		AND item_type = @item_type
		AND item_id = @item_id
END
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogSelectionAreaDetails]...';


GO
CREATE PROCEDURE [dbo].[vs_selCatalogSelectionAreaDetails]
@session_id uniqueidentifier,
@application varchar(100),
@product varchar(100),
@area varchar(100) = '',
@sub_area varchar(100) = ''
AS
/*
	Modified: 06/10/2019 by RW
	Description: Included BOM Modifications for Invoicing
*/

IF OBJECT_ID('tempdb.dbo.#bom_modifications', N'U') IS NOT NULL DROP TABLE #bom_modifications

CREATE TABLE #bom_modifications
(
	[item_description] varchar(200),
	[real_item_description] varchar(200),
	[session_id] uniqueidentifier,
	[application] varchar(100),
	[product] varchar(100),
	[area] varchar(100),
	[sub_area] varchar(100),
	[item_type] varchar(20),
	[item_id] varchar(50),
	[bom_bill_qty] decimal(18, 4),
	[bill_qty] decimal(18, 4),
	[alloc_qty] decimal(18, 4),
	[credit_qty] decimal(18, 4),
	[builder_price] decimal(18, 2),
	[homeowner_price] decimal(18, 2),
	[bom_item_id] varchar(50),
	[calc_qty] decimal(18, 4)
)

INSERT INTO
	#bom_modifications
select
	csbm.item as item_description,
	csbm.item as real_item_description,
	csa.session_id,
	csa.[application],
	csa.[product],
	csa.[area],
	csa.[sub_area],
	'modification' as item_type,
	mt.[name] as item_id,
	csabm.quantity as bom_bill_qty,
	csabm.quantity as bill_qty,
	csabm.quantity as alloc_qty,
	csabm.quantity as credit_qty,
	csabm.price as builder_price,
	csabm.price as homeowner_price,
	mt.[name] as bom_item_id,
	csabm.quantity as calc_qty
from
	[catalog_selections_areas] csa with (nolock)
inner join
	[catalog_selections_area_bom_modifications] csabm with (nolock) on csabm.session_id = csa.session_id and csabm.build_id = csa.build_id
inner join
	[catalog_selections_bom_modifications] csbm with (nolock) on csbm.session_id = csabm.session_id and csbm.id = csabm.session_bom_modification_id
inner join
	[builder_bom_modification_types] mt with (nolock) on mt.id = csbm.modification_type
WHERE
	csa.[session_id] = @session_id
	and csa.[application] = @application
	and csa.[product] = @product
	and csa.[area] = @area
	and csa.[sub_area] = @sub_area

IF OBJECT_ID('tempdb.dbo.#area_details', N'U') IS NOT NULL DROP TABLE #area_details

select
	convert(varchar(200), isnull(vpi.description,'')) as item_description,
	convert(varchar(200), isnull(isnull(vclr.name,lc.description),'')) as real_item_description,
	ad.*
into
	#area_details
from
	[catalog_selections_area_details] ad with (nolock)
	left join Veo_applications vap with (nolock) on vap.name = ad.[application]
	left join Veo_products vprd with (nolock) on vprd.name = ad.[product]
	left join Veo_plan_items vpi with (nolock) on
		vpi.application_id = vap.application_id
		and vpi.product_id = vprd.product_id
		and vpi.item_type = ad.[item_type]
		and vpi.item_id = ad.item_id
	left join veo_colors vclr with (nolock) on 	vclr.part_no = ad.real_item_id
	left join Veo_labor_codes lc with (nolock) on lc.code = ad.real_item_id
WHERE
	[session_id] = @session_id
	and [application] = @application
	and [product] = @product
	and [area] = @area
	and [sub_area] = @sub_area

ALTER TABLE #area_details DROP COLUMN [stamp]

-- Use dynamic SQL here can prevent errors caused by possibly adding/reordering columns for catalog_selections_area_details
declare @sql varchar(max) = '',
	@column_sql varchar(max) = '',
	@value_sql varchar(max) = ''

select
	@column_sql = @column_sql +
		case @column_sql when '' then '' else ',' + CHAR(13) + CHAR(10) end + CHAR(9) +
		'[' + c1.[name] + ']',
	@value_sql = @value_sql +
		case @value_sql when '' then '' else ',' + CHAR(13) + CHAR(10) end + CHAR(9) +
		case
			when c2.column_id is null then
				case
					when c1.[name] like '%item_id' then ''''''
					when c1.[name] like '%uom_id' then '''Ea'''
					when c1.[name] like '%percentage_type' then '''Margin'''
					when c1.[name] like '%percentage' then '0'
					else
						case
							when t.[name] in ('bit', 'float', 'int', 'money', 'smallint', 'smallmoney', 'tinyint') then '0'
							when t.[name] in ('date', 'datetime', 'datetime2') then '''' + CONVERT(varchar(10), GETDATE(), 101) + ''''
							else ''''''
						end
				end
			else '[' + c2.[name] + ']'
		end
from
	tempdb.sys.columns c1
inner join
	tempdb.sys.types t on t.system_type_id = c1.system_type_id
left join
	tempdb.sys.columns c2 on c2.[object_id] = OBJECT_ID('tempdb.dbo.#bom_modifications', N'U') and c2.[name] = c1.[name]
where
	c1.[object_id] = OBJECT_ID('tempdb.dbo.#area_details', N'U')

set @sql =
'insert into #area_details (
' + @column_sql +'
)
select
' + @value_sql + '
from
	#bom_modifications
'

exec (@sql)

select * from #area_details
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogSelectionAreas]...';


GO

/*
	History:	RIG 20140724	Added construction sort order for no cost report
    History:    SLM 20140725    Fixed issue where account_organization_application_product_sort_order join wasn't using all of the primary key fields.
*/


CREATE procedure [dbo].[vs_selCatalogSelectionAreas]
@session_id uniqueidentifier,
@selected_areas_only bit = 1
as

-- vs_selCatalogSelectionAreas '137e9031-51b1-436e-bf45-9fdd8a5bf007',1

select 
	csa.*,
	cs.*,
	isnull(cs.item,'No Group Description') as selected_field_group_description,
	rg.description as room_group,
	rg.sort_order as room_group_sort_order,
	isnull(so.sort_order,9999999) as sort_order
from	
	[catalog_selections_areas] csa with (nolock)
	left join catalog_selections cs with (nolock) on cs.session_id = csa.session_id and cs.row_id = csa.selected_field_group
	left join veo_areas va with (nolock) on va.area_id = csa.area_id
	left join veo_room_groups rg with (nolock) on rg.code = va.room_group
	left join account_organization_application_product_sort_order so with (nolock) on so.account_id = cs.account_id and so.organization_id = cs.organization_id and so.[application] = csa.[application] and so.product = csa.product
WHERE
	csa.[session_id] = @session_id
	and (area_selected = 1 or @selected_areas_only = 0)
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogSelectionByID]...';


GO


create procedure [dbo].[vs_selCatalogSelectionByID]
@row_id uniqueidentifier
as
/*

vs_selCatalogSelectionByID '27531c52-5d80-4797-b4dc-6e2b6f2d9852'

*/


select 
	*
from
	catalog_selections with (nolock)
where
	row_id = @row_id
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogSelections]...';


GO
CREATE procedure [dbo].[vs_selCatalogSelections]
@session_id uniqueidentifier
as 

select
	*
from
	catalog_selections with (nolock)
where
	session_id = @session_id
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogSelectionsByDate]...';


GO
/*
	Modified 10/25/2019 - Eric Hickey
		No longer return profile plans that are 'Active', as that status has been merged with 'Contracted'.  This was only in comments, but it was updated for clarity.
	
	Modified By: Charles Moore
	Date: 9/10/2021
	Description: Convert Lot to string values
*/

CREATE procedure [dbo].[vs_selCatalogSelectionsByDate]

@builder_id varchar(max),
@start_date datetime,
@end_date datetime,
@email varchar(100) = ''



/*

vs_selCatalogSelectionsByDate 'MHI1957','01/01/2014', '02/28/2014',''
vs_selCatalogSelectionsByDate 'MHI1957','7/1/2012', '9/30/2012',''
vs_selCatalogSelectionsByDate 'MHI1957','7/1/2013', '9/30/2013',''

*/

as

select 
*
from

(
select
	'catalog' as source,
	pp.community_name as community,
	pp.series,
	pp.plan_name as [plan],
	pp.[address] as street_address,
	case when pp.block = '' then '' else 'Blk: ' + pp.block + ' ' end + 
		case when pp.lot in('0','') then '' else 'Lot: ' + pp.lot end  as lot_block,
	pp.city,
	pp.state,
	pp.zip_code,
	u.email,
	users.first_name,
	users.last_name,
	pp.sales_counselor,
	pp.sales_price,
	pp.sales_options,
	pp.upgrades_incentive,
	pp.additional_design_deposit,
	pp.contract_date,
	csess.first_completed_date,
	csess.designer,
	replace(replace(csel.application,char(13),''),char(10),'') as application,
	replace(replace(csel.product,char(13),''),char(10),'') as product,
	replace(replace(csel.area,char(13),''),char(10),'') as area,
	'' as group_name,
	'' as plan_item,
	csel.item_no as item_id,
	replace(replace(csel.item,char(13),''),char(10),'') as item_desc,
	isnull(csel.vendor,'') as vendor,
	csel.price,
	csel.qty as quantity,
	0.00 as credit_qty,
	'' as price_type,
	replace(replace(csel.notes,char(13),''),char(10),'') as notes,
	csess.create_date as session_date,
	csess.session_id,
	csess.status,
	csess.completed_date,
	0 as detail_sort	
from 
	account_organization_user_profile_plan_catalog_sessions csess with (nolock)
	join account_organization_user_profile_plan pp with (nolock) on  
		pp.account_id = csess.account_id 
		and pp.organization_id = csess.organization_id 
		and pp.user_id = csess.user_id 
		and pp.community_name = csess.community_name
		and pp.series = csess.series
		and pp.plan_name = csess.plan_name
	join VeoSolutionsSecurity_organizations o with (nolock)	on o.organization_id = pp.organization_id
	left join catalog_selections csel with (nolock) on csel.session_id = csess.session_id
	left join VeoSolutionsSecurity_account_organization_users users with (nolock) on pp.user_id = users.user_id
	left join VeoSolutionsSecurity_users u with (nolock) on pp.user_id = u.user_id
where
	csess.create_date >= @start_date and csess.create_date <= @end_date
	--and pp.status = 'Contracted'
	and csess.status in ('2','3','4') -- 2 = complete
	and csel.selected = '1' -- 1 = catalog item selected
	and csel.source != 'Prices Landed'
	and external_organization_id = @builder_id
	and (u.email = @email or @email = '')
	
union

select
	'areas' as source,
	pp.community_name as community,
	pp.series,
	pp.plan_name as [plan],
	pp.[address] as street_address,
	case when pp.block = '' then '' else 'Blk: ' + pp.block + ' ' end + 
		case when pp.lot in('0','') then '' else 'Lot: ' + pp.lot end  as lot_block,
	pp.city,
	pp.state,
	pp.zip_code,
	u.email,
	users.first_name,
	users.last_name,
	pp.sales_counselor,
	pp.sales_price,
	pp.sales_options,
	pp.upgrades_incentive,
	pp.additional_design_deposit,
	pp.contract_date,
	csess.first_completed_date,
	csess.designer,
	csela.application,
	csela.product,
	csela.area,
	isnull(csel.item,'') as group_name,
	item_id as plan_item,
	det.real_item_id as [item_id],
	isnull(isnull(vc.name,vlc.[description]),'N/A') as item_desc,
	isnull(cs.vendor,'') as vendor,
	det.homeowner_price as price,
	det.bill_qty as quantity,
	det.credit_qty as credit_qty,
	isnull(det.price_type,'') as price_type,
	csela.notes as notes,
	csess.create_date as session_date,
	csess.session_id,
	csess.status,
	csess.completed_date,
	1 as detail_sort	
from 
	account_organization_user_profile_plan_catalog_sessions csess with (nolock)
	join account_organization_user_profile_plan pp with (nolock) on 
		pp.account_id = csess.account_id 
		and pp.organization_id = csess.organization_id 
		and pp.user_id = csess.user_id 
		and pp.community_name = csess.community_name
		and pp.series = csess.series
		and pp.plan_name = csess.plan_name
	join VeoSolutionsSecurity_organizations o with (nolock)	on o.organization_id = pp.organization_id
	left join catalog_selections_areas csela on csela.session_id = csess.session_id
	join catalog_selections_area_details det on 
		csela.session_id = det.session_id and 
		csela.application = det.application and 
		csela.product = det.product and
		csela.area = det. area and
		csela.sub_area = det.sub_area
	left join Veo_colors vc on det.real_item_id = vc.part_no
	left join Veo_labor_codes vlc on det.real_item_id = vlc.code
	left join catalog_selections cs on csela.selected_field_group = cs.row_id and csela.session_id = cs.session_id
	left join VeoSolutionsSecurity_account_organization_users users on pp.user_id = users.user_id
	left join catalog_selections csel with (nolock) on csel.session_id = csela.session_id and csel.row_id = csela.selected_field_group
	left join VeoSolutionsSecurity_users u with (nolock) on pp.user_id = u.user_id
where
	csess.create_date >= @start_date 
	and csess.create_date <= @end_date
	and o.external_organization_id = @builder_id
	--and pp.status in ('Contracted','Completed') 
	and csess.status in ('2','3','4')
	and csela.selected = '1'
	and det.selectable = '1'
	and (u.email = @email or @email = '')
) t1

--where price_type is null
order by first_completed_date desc, community, series, [plan], street_address, first_name,designer, application, product, area, item_desc, detail_sort
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogSelectionsPricingErrorsBySession]...';


GO
CREATE procedure [dbo].[vs_selCatalogSelectionsPricingErrorsBySession]
@session_id uniqueidentifier,
@security_token uniqueidentifier
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)	

if @active_user_id is null
begin
	raiserror('Insufficient rights to execute query.',16,1)
	return
end

select 
	o.name as organization_name,
	aoupp.community_name,
	aoupp.series,
	aoupp.base_plan_name,
	aoupp.[address],
	case when aoupp.block = '' then '' else 'Blk: ' + aoupp.block + ' ' end + 
		case when aoupp.lot in('0','') then '' else 'Lot: ' + aoupp.lot end  as lot_block,
	csel.*
from 
	catalog_selections_error_log csel with (nolock)
	left join account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock) on aouppcs.session_id = csel.session_id
	left join veosolutionssecurity_organizations o with (nolock) on o.organization_id = aouppcs.organization_id
	left join account_organization_user_profile_plan aoupp with (nolock) on aoupp.account_id = aouppcs.account_id and aoupp.organization_id = aouppcs.organization_id and aoupp.user_id = aouppcs.user_id and aoupp.community_name = aouppcs.community_name and aoupp.series = aouppcs.series and aoupp.plan_name = aouppcs.plan_name

where 
	csel.session_id = @session_id

/*
	Modified By: Charles Moore
	Date: 9/10/2021
	Description: Convert Lot to string values

	vs_selCatalogSelectionsPricingErrorsBySession '33d8523b-ef49-4780-81f2-cb297c77e3b6','EC5F9F8D-B513-4493-B247-5D3E38909BC7'
*/
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogSelectionsPricingErrorsUnreviewed]...';


GO
CREATE procedure [dbo].[vs_selCatalogSelectionsPricingErrorsUnreviewed]
@security_token uniqueidentifier
as

/*

	Modified By: Charles Moore
	Date: 9/10/2021
	Description: Convert Lot to string values

vs_selCatalogSelectionsPricingErrorsUnreviewed 'EC5F9F8D-B513-4493-B247-5D3E38909BC7'
*/

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)	

if @active_user_id is null
begin
	raiserror('Insufficient rights to execute query.',16,1)
	return
end

select 
	o.name as organization_name,
	aoupp.community_name,
	aoupp.series,
	aoupp.base_plan_name,
	aoupp.[address],
	case when aoupp.block = '' then '' else 'Blk: ' + aoupp.block + ' ' end + 
		case when aoupp.lot in('0','') then '' else 'Lot: ' + aoupp.lot end  as lot_block,
	csel.*
from 
	catalog_selections_error_log csel with (nolock)
	left join account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock) on aouppcs.session_id = csel.session_id
	left join veosolutionssecurity_organizations o with (nolock) on o.organization_id = aouppcs.organization_id
	left join account_organization_user_profile_plan aoupp with (nolock) on aoupp.account_id = aouppcs.account_id and aoupp.organization_id = aouppcs.organization_id and aoupp.user_id = aouppcs.user_id and aoupp.community_name = aouppcs.community_name and aoupp.series = aouppcs.series and aoupp.plan_name = aouppcs.plan_name
where 
	review_date is null

/*
vs_selCatalogSelectionsPricingErrorsUnreviewed 'EC5F9F8D-B513-4493-B247-5D3E38909BC7'
*/
GO
PRINT N'Creating Procedure [dbo].[vs_selCatalogSession]...';


GO
create procedure vs_selCatalogSession
@session_id uniqueidentifier
as

select * 
from account_organization_user_profile_plan_catalog_sessions
where session_id = @session_id
GO
PRINT N'Creating Procedure [dbo].[vs_selCustomerLogo]...';


GO
-- find 'security_token'
create procedure vs_selCustomerLogo
-- declare @account_id uniqueidentifier = 'BAB32B7E-3ADA-497C-862E-E5083971CC59'
@organization_id uniqueidentifier = '3bf05014-1588-4942-94fd-7706ecb2cee2',
@security_token uniqueidentifier = 'D9138A0C-1B8A-458B-95DB-0957B555F8B2'

as

-- select top 1 * from veosolutionssecurity_users_login_sessions 
-- select external_organization_id from veosolutionssecurity_organizations where organization_id = @organization_id

declare @edit_user_id varchar(75)
set @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
if (@edit_user_id is null)
	begin
		raiserror('Invalid credentials.',16,1)
		return
	end

select 
	image_data
from 
	veo_customers 
where 
	custnmbr = (select external_organization_id from veosolutionssecurity_organizations where organization_id = @organization_id)
GO
PRINT N'Creating Procedure [dbo].[vs_selDesignCenterInfoForAppointment]...';


GO
CREATE PROCEDURE [dbo].[vs_selDesignCenterInfoForAppointment]
	@appointment_id UNIQUEIDENTIFIER
AS
SELECT 
	su.first_name + ' ' + su.last_name as designer_name,
	sl.[name] AS design_center_name,
	sl.[address] AS appointment_address,
	REPLACE(sl.phone_number, '+1 ', '') AS phone_number
FROM 
	scheduling_appointments a with (nolock) 
	LEFT JOIN scheduling_users su with (nolock) on su.user_id = a.schedule_user_id 
	LEFT JOIN VeoSolutionsSecurity_locations sl ON sl.location_id = a.location_id
WHERE
	a.appointment_id = @appointment_id
GO
PRINT N'Creating Procedure [dbo].[vs_selDocumentApplications]...';


GO
CREATE procedure vs_selDocumentApplications
@account_id uniqueidentifier,
@organization_id uniqueidentifier

as
/*

vs_selDocumentApplications 'BAB32B7E-3ADA-497C-862E-E5083971CC59','78D12721-C3D5-4067-9E89-9B4C32A8CDA2'

*/
select 
	distinct application
from
(
select  
	distinct application
from catalog_items ci with (nolock)
where account_id = @account_id and organization_id = @organization_id

union

select name as application
from veo_applications
)t1
GO
PRINT N'Creating Procedure [dbo].[vs_selDocumentDataByAccountOrganizationDocumentType]...';


GO
CREATE procedure vs_selDocumentDataByAccountOrganizationDocumentType
@session_id uniqueidentifier,
@document_type varchar(max)
as
/*
vs_selDocumentDataByAccountOrganizationDocumentType 'a61f9d90-6470-4b6c-9e6b-4a7259286fd6','Selections Disclaimer'
select * from catalog_selections where session_id = 'a61f9d90-6470-4b6c-9e6b-4a7259286fd6'
select * from VeoSolutionsSecurity_account_organization_documents
*/
select top 1 ISNULL( aod.document_data, convert(varbinary(max),'')) as document_data
	-- ISNULL(aod.document_data,'') as document_data
from 
	catalog_selections cs
	left join VeoSolutionsSecurity_account_organization_documents aod on 
		aod.account_id = cs.account_id and 
		aod.organization_id = cs.organization_id and 
		aod.document_type = @document_type
where
	session_id = @session_id
GO
PRINT N'Creating Procedure [dbo].[vs_selDocumentProductFromApplications]...';


GO
CREATE procedure [dbo].[vs_selDocumentProductFromApplications]
	@account_id uniqueidentifier,
	@organization_id uniqueidentifier,
	@application varchar(100)

as
/*
	Modified: Shelby Mansker
	Date: 4/15/2016
	Description: I reformatted this stored procedure to make it easier to read.
		Also, Visual Studio's SSDT was complaining that there was some
		ambiguity in the columns used, so I cleaned that up too.

	vs_selDocumentProductFromApplications 'BAB32B7E-3ADA-497C-862E-E5083971CC59','78D12721-C3D5-4067-9E89-9B4C32A8CDA2',''
	vs_selDocumentProductFromApplications 'BAB32B7E-3ADA-497C-862E-E5083971CC59','41e2b9ca-9b05-4c7a-9994-8dbd48660ff9','All'

*/

SELECT 
	DISTINCT t1.product
FROM
	(
		SELECT
			DISTINCT ci.product
		FROM 
			dbo.catalog_items ci WITH (NOLOCK)
		WHERE 
			account_id = @account_id 
			AND organization_id = @organization_id 
			AND (ci.[application] = @application OR @application = '' OR @application = 'All')

		UNION

		SELECT
			DISTINCT vp.name AS product
		FROM 
			veo_products vp WITH (NOLOCK)
			LEFT JOIN veo_application_products vap WITH (NOLOCK) ON vap.product_id = vp.product_id
			LEFT JOIN veo_applications va WITH (NOLOCK) ON va.application_id = vap.application_id
		WHERE 
			va.name = @application 
			OR @application = '' 
			OR @application = 'All'

	) t1
GO
PRINT N'Creating Procedure [dbo].[vs_selGroupDetails]...';


GO


CREATE procedure [dbo].[vs_selGroupDetails]
@session_id uniqueidentifier,
@product_id varchar(20),
@group_id int = 0


as

/*

vs_selGroupDetails 'C559D7D5-88D4-407E-879A-3B0FF422959F','O' ,4656

*/

select 
	t1.*,
	vs.description as style_name,
	isnull(vsc.include_in_search,0) as include_in_search
	 
from
(
select 
	--*,
	isnull(vc.part_no,vc2.part_no) as part_id,
	isnull(vc.product_id,vc2.product_id) as product_id,
	isnull(vc.color_id,vc2.color_id) as color_id,
	isnull(vc.style_id,vc2.style_id) as style_id,
	isnulL(vc.image_data,vc2.image_data) as image_data,
	isnull(vc.name,vc2.name) as color_name,
	isnull(vc.stocking_code,vc2.stocking_code) as stocking_code

	
	
from catalog_selections_group_detail csgd with (nolock)

left join veo_colors vc with (nolock) on
	vc.style_id = csgd.item and vc.product_id = @product_id

left join veo_colors vc2 with (nolock) on
	vc2.part_no = csgd.item and vc2.product_id = @product_id
	
	
where csgd.session_id = @session_id 
	and (csgd.group_id = @group_id or @group_id = 0)



) t1 
left join veo_styles vs with (nolock)on
	vs.style_id = t1.style_id and vs.product_id = t1.product_id
left join veo_stocking_codes vsc with (nolock) on
	vsc.code = t1.stocking_code
GO
PRINT N'Creating Procedure [dbo].[vs_selInvoice]...';


GO
CREATE procedure [dbo].[vs_selInvoice]
@invoice_id int
as

select *
from invoices with (nolock)
where invoice_id = @invoice_id
GO
PRINT N'Creating Procedure [dbo].[vs_selInvoiceLines]...';


GO
CREATE procedure [dbo].[vs_selInvoiceLines]
@invoice_id int
as

select *
from invoice_lines with (nolock)
where invoice_id = @invoice_id
GO
PRINT N'Creating Procedure [dbo].[vs_selInvoices]...';


GO

create procedure [dbo].[vs_selInvoices]
@reference_id uniqueidentifier
as

select *
from invoices with (nolock)
where reference_id = @reference_id
GO
PRINT N'Creating Procedure [dbo].[vs_selInvoicesByOrganizationByDateRange]...';


GO
CREATE procedure [dbo].[vs_selInvoicesByOrganizationByDateRange]
	@security_token uniqueidentifier,
	@organization_id uniqueidentifier,
	@begin_date datetime,
	@end_date datetime
as


/*

vs_selInvoicesByOrganizationByDateRange '5302a13f-3ccc-4b1c-8ddd-c84a510dca71','722d7706-6e08-4993-b94a-45b71f5375df','12/1/2013','1/11/2014'
select * from invoices where invoice_no = '35685189'
select * from invoice_lines where invoice_id = 1189
*/



declare @edit_user_id varchar(75)

set @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

if (@edit_user_id is null)
	begin
		raiserror('Invalid credentials.',16,1)
		return
	end


select 
	invoice_id,
	rtrim(aoupp.address + ' ' + case cast(aoupp.lot as varchar(10)) when '0' then '' else cast(aoupp.lot as varchar(10)) end  + ' ' + aoupp.block) as address,
	aoupp.community_name,
	i.invoice_no,
	i.invoice_date,
	i.amount,
	-- (select sum(invoice_amount) from invoice_lines where invoice_id = i.invoice_id) as amount,
	o.name as organization_name
	-- i.*
	--,*
from 
	invoices i with (nolock)
	left join account_organization_user_profile_plan_catalog_sessions aouppcs with (nolock) on aouppcs.session_id = i.reference_id
	left join account_organization_user_profile_plan aoupp with (nolock) 
		on aoupp.account_id = aouppcs.account_id and aoupp.organization_id = aouppcs.organization_id and aoupp.user_id = aouppcs.user_id
		and aoupp.community_name = aouppcs.community_name and aoupp.series = aouppcs.series and aoupp.plan_name = aouppcs.plan_name
	left join veosolutionssecurity_organizations o with (nolock) on o.organization_id = aoupp.organization_id
where 
	convert(datetime, i.invoice_date, 101) between @begin_date and DATEADD(DAY, 1, @end_date)
	and aouppcs.organization_id = @organization_id
	and isnumeric(invoice_no) = 1
order by 
	invoice_no

-- select sum(invoice_amount) from invoice_lines where invoice_no = 23
GO
PRINT N'Creating Procedure [dbo].[vs_selLanguages]...';


GO
create procedure [dbo].[vs_selLanguages]

as
-- vs_selSchedulingUserLanguages '0e4c3d85-5acf-4d8c-af40-a5e33715ed8b'
select * from  
VeoSolutionsSecurity_languages
GO
PRINT N'Creating Procedure [dbo].[vs_selLocationTypes]...';


GO
CREATE procedure [dbo].[vs_selLocationTypes]

as

select * from [VeoSolutionsSecurity_location_types]
GO
PRINT N'Creating Procedure [dbo].[vs_selMyIncompleteHomebuyers]...';


GO
/*
	Modified 10/25/2019 - Eric Hickey
		No longer return profile plans that are 'Active', as that status has been merged with 'Contracted'
*/

CREATE procedure [dbo].[vs_selMyIncompleteHomebuyers]
@user_id uniqueidentifier
as

/*
sysadmin
vs_selMyIncompleteHomebuyers '424059BC-E4C9-4F21-BDC2-52E5A24BF9AE'

designer
vs_selMyIncompleteHomebuyers '0566C040-9C11-4129-8ADB-72F31658DD19'
*/


--determine if user is sysadmin

declare @is_sysadmin bit

set @is_sysadmin = (
select 

	count(*)

from VeoSolutionsSecurity_users vssu with (nolock)

left join  VeoSolutionsSecurity_account_organization_users aou with (nolock) on
	aou.user_id = vssu.user_id

left join VeoSolutionsSecurity_account_organization_users_roles_legacy aour with (nolock) on
	aour.account_id = aou.account_id
	and aour.organization_id = aou.organization_id
	and aour.user_id = @user_id

left join VeoSolutionsSecurity_roles_legacy r with (nolock) on 
	r.role_id = aour.role_id

where 
	vssu.user_id = @user_id and r.name = 'System Administrator'
	)

--locate incomplete sessions

select 
 distinct
 p.profile_id,
 o.name as org_name,
 s.account_id,
 s.organization_id,
 s.series,
 s.plan_name,
 s.community_name,
 s.session_id,
 s.designer as assigned_designer,
 'session_status' =
 case s.status
	when 1 then 'Active'
	when 4 then 'Pending'
 end,
 sessionUser.first_name,
 sessionUser.last_name,
 sessionUser.email,
 p.home_phone,
 p.work_phone,
 p.address,
 p.city,
 p.state,

 p.lot,
 p.block,
 p.status,
 u.first_name + ' ' + u.last_name as user_full_name,
 @is_sysadmin as is_sysadmin
from account_organization_user_profile_plan_catalog_sessions s with (nolock)

left join account_organization_user_profile_plan p with (nolock) on
	p.account_id = s.account_id
	and p.organization_id = s.organization_id
	and p.user_id = s.user_id
	and p.community_name = s.community_name
	and p.series = s.series
	and p.plan_name = s.plan_name

left join VeoSolutionsSecurity_users u with (nolock) on 
	u.user_id = @user_id

left join VeoSolutionsSecurity_users sessionUser with (nolock) on 
	sessionUser.user_id = s.user_id

left join vss_organizations o with (nolock) on 
	o.organization_id = s.organization_id

left join VeoSolutionsSecurity_account_organization_users aou with (nolock) on
	aou.account_id = s.account_id
	and aou.organization_id = s.organization_id
	and aou.user_id = s.user_id

--left join VeoSolutionsSecurity_account_organization_users_roles aour with (nolock) on
--	aour.account_id = s.account_id
--	and aour.organization_id = s.organization_id
--	and aour.user_id = @user_id

--left join VeoSolutionsSecurity_roles r with (nolock) on 
--	r.role_id = aour.role_id

where s.organization_id in (select organization_id 
					   from VeoSolutionsSecurity_account_organization_users  with (nolock)
                       where user_id = @user_id)

      and s.status in (1,4)-- 'active,pending'
	  and p.status in ('Active', 'Contracted') -- we can still use 'active' here (until it is completely removed) because organizations that use the Prospective Status Feature will not have any 'active' profile plans
	  and ((s.designer =  u.first_name + ' ' + u.last_name) or (@is_sysadmin = 1)) -- only show sessions that are assigned this designer or any session if sysadmin
GO
PRINT N'Creating Procedure [dbo].[vs_selOperatorActivity]...';


GO
CREATE procedure [dbo].[vs_selOperatorActivity] 
@operator_email varchar(100) 
as

-- TESTING 
-- vs_selOperatorActivity 'c_kwithr@ryland.com'
-- vs_selOperatorActivity 'philm@eplanpartners.com'

-- select top 10 * from z_scheduling_appointments
select 'APPOINTMENTS SCHEDULED' 
select * from z_scheduling_appointments 
where 
z_user_name = @operator_email 
and z_action = 'update'
and is_scheduled = 1 
order by z_time desc 

select 'APPOINTMENTS SETUP' 
select * from z_scheduling_appointments 
where 
z_user_name = @operator_email 
and z_action = 'insert'
order by z_time desc
GO
PRINT N'Creating Procedure [dbo].[vs_selPartListFromSession]...';


GO
CREATE procedure [dbo].[vs_selPartListFromSession]
@session_id as uniqueidentifier,
@security_token as uniqueidentifier
as

declare @edit_user_id varchar(75)
set @edit_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
if (@edit_user_id is null)
	begin
		raiserror('Invalid credentials.',16,1)
		return
	end

/*
Session ID in DEV: '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2'
select * from veo_stocking_codes
select * from catalog_selections_group_detail csgd where session_id = '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2' order by item
vs_selPartListFromSession '9BE70A75-1538-4E4F-B54F-E8E12D4D4CB2'
*/

select 
	item as part_no
from 
	catalog_selections_group_detail
where
	session_id = @session_id
	and item_type = 'color'

union

select 
	vc.part_no
from 
	catalog_selections_group_detail csgd with (nolock)
	join veo_styles vs with (nolock) on vs.product_id + vs.style_id = csgd.item
	join Veo_colors vc with (nolock) on vc.product_id = vs.product_id and vc.style_id = vs.style_id
where
	session_id = @session_id
	and item_type = 'style'
	and vc.stocking_code not in ('d','DP')

order by item
GO
PRINT N'Creating Procedure [dbo].[vs_selPatternBuildReportDetails]...';


GO
CREATE proc [dbo].[vs_selPatternBuildReportDetails]
@session_id uniqueidentifier,
@area varchar(100)

as
/*
	Modified: Shelby Mansker
	Date: 3/16/2016
	Description: The image_data has been modified to return an empty byte array, rather than null, when
		the product_patterns_material record is null for a line. This is to fix a bug in VeoSolutions, which
		isn't checking for NULL.

	vs_selPatternBuildReportDetails '3E5AD6BE-3A82-4F45-96EA-083259E0D3CA', 'Kitchen/Breakfast / Back Splash'
	vs_selPatternBuildReportDetails '3E5AD6BE-3A82-4F45-96EA-083259E0D3CA', 'Master Bath / Shower Stall'
	vs_selPatternBuildReportDetails '3259366e-b296-4503-a502-5475d22a7775', 'Kitchen/Breakfast/Butler Backsplash'
*/
BEGIN
	SELECT 
		csad.[item_id],
		ISNULL(col.name,'') AS name,
		csad.[bill_qty] AS 'qty',
		csad.[uom_id],
		ISNULL(ppm.[image_data], 0x) AS 'material_image_data',
		csad.[accent_prompt] AS 'notes'
	FROM 
		[catalog_selections_areas] csa
		LEFT JOIN [catalog_selections_area_details] csad ON csa.session_id = csad.session_id AND csa.area = csad.area
		JOIN Veo_product_patterns_material ppm ON csa.pattern_id = ppm.pattern_id AND csad.item_id = ppm.[item_id] --do left join to include grout
		LEFT JOIN Veo_colors col ON csad.real_item_id = col.part_no
	WHERE
		csad.session_id = @session_id
		AND csa.selected != 0
		AND csad.selectable != 0
		AND csa.area = @area
		AND csad.pattern_id != 0 --added 2/5/2015 to keep no pattern items from creeping in (i.e. ctops with same named area)
END
GO
PRINT N'Creating Procedure [dbo].[vs_selPatternBuildReportInfo]...';


GO


CREATE proc [dbo].[vs_selPatternBuildReportInfo]
@session_id uniqueidentifier

as
/*
	Modified By: Charles Moore
	Date: 9/10/2021
	Description: Convert Lot to string values

vs_selPatternBuildReportInfo '3E5AD6BE-3A82-4F45-96EA-083259E0D3CA'
*/

SELECT 
	orgs.name as 'builder_name'
	,pp.[address]
	,case when block = '' then '' else 'Blk: ' + block + ' ' end + 
		case when lot in('0','') then '' else 'Lot: ' + pp.lot end  as lot_block
	,csa.[area]
	,pat.image_data as 'pattern_image_data'
	,pat.application_id
	,pat.product_id
	,csa.area_id
	,csa.sub_area_id
FROM 
	catalog_selections_areas csa with (nolock)
	join account_organization_user_profile_plan_catalog_sessions cs with (nolock) on 	cs.session_id = csa.session_id
	join account_organization_user_profile_plan pp with (nolock) on 
		pp.account_id = cs.account_id
		and pp.organization_id = cs.organization_id
		and pp.user_id = cs.user_id
		and pp.series = cs.series
		and pp.community_name = cs.community_name
		and pp.plan_name = cs.plan_name
  join VeoSolutionsSecurity_organizations orgs with (nolock) on orgs.organization_id = pp.organization_id
  left join Veo_product_patterns pat with (nolock) on pat.pattern_id = csa.pattern_id
where 
	csa.session_id = @session_id
	and pat.image_data is not null
	and csa.selected != 0
GO
PRINT N'Creating Procedure [dbo].[vs_selProfileDoc]...';


GO
create procedure [dbo].[vs_selProfileDoc]
@doc_id uniqueidentifier
as

select
	*,
	DATALENGTH(doc_data) as doc_size
from account_organization_user_profile_plan_documents
where doc_id = @doc_id
GO
PRINT N'Creating Procedure [dbo].[vs_selProfilePlanDocs]...';


GO
CREATE procedure [dbo].[vs_selProfilePlanDocs]
    @account_id UNIQUEIDENTIFIER,
    @organization_id UNIQUEIDENTIFIER,
    @user_id UNIQUEIDENTIFIER,
    @community_id INT = 0, --TODO: Remove this parameter once VeoSolutions is updated with proper code.
    @community_name VARCHAR(50) = '', --TODO: Remove default value once VeoSolutions is updated with proper code.
    @series VARCHAR(50),
    @plan_name VARCHAR(50)
AS
/*
    ===================================================
    Modified by Shelby Mansker on 10/21/2014
        - Updated this stored proc to use the community name,
        rather than the community id, for looking up profile
        plan documents.
    ===================================================
*/
BEGIN
    SELECT
        account_id,
        organization_id,
        [user_id],
        community_name,
        community_id,
        series,
        plan_name,
        doc_id,
        doc_name,
        doc_type,
        doc_data,
        doc_notes,
        author,
        create_date,
        modifier,
        modified_date,
        DATALENGTH(doc_data) AS doc_size
    FROM 
        dbo.account_organization_user_profile_plan_documents WITH (NOLOCK)
    WHERE 
        account_id = @account_id
        AND organization_id = @organization_id
        AND [user_id] = @user_id
        AND community_name = @community_name
        AND series = @series
        AND plan_name = @plan_name
END
GO
PRINT N'Creating Procedure [dbo].[vs_selReport]...';


GO
CREATE procedure [dbo].[vs_selReport]
@storage_id uniqueidentifier
as
select * from report_storage where storage_id = @storage_id
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingAdminUsersList]...';


GO
CREATE procedure [dbo].[vs_selSchedulingAdminUsersList]
@operator_id uniqueidentifier
as

-- testing: 
-- select * from scheduling_users
-- select * from scheduling_user_roles
-- select * from veosolutionssecurity_roles

-- grabs a list of all scheduling users within scope of the operator, 
-- vs_selSchedulingUsersForOperator 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'
-- [vs_selSchedulingAdminUsersList] 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'

-- SECURITY CHECK 
if exists (select user_id from scheduling_user_roles u with (nolock) join veosolutionssecurity_roles_legacy r with (nolock)  on u.role_id = r.role_id where u.user_id = @operator_id and r.name in ('Design Center Manager',  'Design Center Administrator', 'System Administrator') ) 
begin 

select 
	distinct
	su.user_id, 
	su.first_name + ' ' + su.last_name as name
from 
	scheduling_users su with (nolock) 
order by su.first_name + ' ' + su.last_name asc 

end 
else 
begin 
-- empty rowset 
select 
	su.user_id, 
	su.first_name + ' ' + su.last_name as name
from 
	scheduling_users su with (nolock) 
where 
	su.user_id is null 
end
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingAppointment]...';


GO
CREATE procedure [dbo].[vs_selSchedulingAppointment]
@appointment_id uniqueidentifier 
as


-- testing 
-- select * from scheduling_appointments 
-- vs_selSchedulingAppointment '1420EAA4-0191-43E2-B395-3D27A8A22623'

select 
a.*, 
o.display_name as org_name, 
isnull(u.first_name + ' ' + u.last_name, '') as buyer_name 
from 
	scheduling_appointments a with (nolock) 
	left join scheduling_organizations o with (nolock)  on o.account_org_id = a.account_org_id
	left join account_organization_user_profile_plan pp with (nolock)  on pp.profile_id = a.buyer_profile_id 
	left join veosolutionssecurity_users u with (nolock)  on u.user_id = pp.user_id 
where
	a.appointment_id = @appointment_id
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingAppointments]...';


GO
CREATE procedure [dbo].[vs_selSchedulingAppointments]
@operator_id uniqueidentifier,
@start date,
@end date,
@location_id uniqueidentifier = null,
@all_organizations bit = 0
as

-- select * from scheduling_appointments
-- vs_selSchedulingAppointments 'FD937A7F-FAA4-4FC1-B54B-4E867A6C23DD', '07/20/2012', '08/01/2012', null
-- vs_selSchedulingAppointments 'FD937A7F-FAA4-4FC1-B54B-4E867A6C23DD', '07/20/2012', '08/01/2012', 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23'

-- vs_selSchedulingUserAppointments 'FD937A7F-FAA4-4FC1-B54B-4E867A6C23DD',
-- select * from scheduling_appointments
-- select * from scheduling_users
-- select * from veosolutionssecurity.dbo.locations
-- C04B5E52-8D06-4BAB-B878-1EECA0BC8D23
-- select * from scheduling_buyers
-- select * from scheduling_organizations

-- TESTING BUILDER FILTERING
-- NO FILTER
-- vs_selSchedulingAppointments 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', '07/01/13', '08/05/13', null
-- DELETE FILTER
-- dev_setupSelectedBuilderTest 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', 1
-- SETUP FILTER - contempo
-- dev_setupSelectedBuilderTest 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', 0, 'CC2A0C00-FD76-408C-AFCB-3C5134671848'
-- SETUP FILTER - MHI-HOUSTON
-- dev_setupSelectedBuilderTest 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', 0, '2F3B34D1-80BD-41D8-8CC6-B662A186F7AE'

-- select * from scheduling_user_organizations where [user_id] = 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'
-- select * from scheduling_user_preferences where user_id = 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'
-- insert into scheduling_user_preferences select 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'

-- FETCH A BUILDER FROM PREFERENCES
declare @selected_account_org uniqueidentifier
set @selected_account_org = '00000000-0000-0000-0000-000000000000'
-- select * from scheduling_user_preferences
if @all_organizations = 0 and exists( select pref_value from scheduling_user_preferences where user_id = @operator_id and pref_key = 'selected_account_org' )
begin
	select @selected_account_org = convert(uniqueidentifier, pref_value) from scheduling_user_preferences where user_id = @operator_id and pref_key = 'selected_account_org'
end

-- OPTIMIZED VERSION - need to test. 03.27.13
declare @appointments table
(
	appointment_id uniqueidentifier,
	buyer_profile_id uniqueidentifier,
	account_org_id uniqueidentifier
)

insert into @appointments
select distinct
	a.appointment_id,
	a.buyer_profile_id,
	a.account_org_id
from
	scheduling_appointments a
	join scheduling_users u on u.user_id = a.schedule_user_id
	join scheduling_user_organizations suo on suo.user_id = u.user_id
where
	a.appointment_date between @start and @end
	AND
	(suo.account_org_id = @selected_account_org OR
		(@selected_account_org = '00000000-0000-0000-0000-000000000000' AND suo.account_org_id in (select account_org_Id from scheduling_user_organizations where user_id = @operator_id) )
	)

select
	a.*,
	o.display_name as org_name,
	isnull(u.first_name + ' ' + u.last_name, '') as buyer_name,
	isnull(du.first_name + ' ' + du.last_name, '') as designer_name,
	isnull(su.first_name + ' ' + su.last_name, '') as provisional_scheduler_name
from
	scheduling_appointments a
	left join scheduling_organizations o on o.account_org_id = a.account_org_id
	left join account_organization_user_profile p on p.profile_id = a.buyer_profile_id
	left join veosolutionssecurity_users u on u.user_id = p.user_id
	left join veosolutionssecurity_users du on du.user_id = a.schedule_user_id
	left join veosolutionssecurity_users su on su.user_id = a.provisional_scheduler_user_id
	join @appointments app on app.appointment_id = a.appointment_id
where
	a.appointment_date between @start and @end
order by
	a.appointment_date asc
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingAppointmentsForLocation]...';


GO
CREATE procedure [dbo].[vs_selSchedulingAppointmentsForLocation]
@location_id uniqueidentifier, 
@date datetime = null 
as

-- vs_selSchedulingAppointmentsForLocation '3DDA5635-04DD-40C1-9D8D-B7BDFA9DCEA1',  '08/03/12'
-- select * from scheduling_appointments
-- select * from veosolutionssecurity_locations
-- select * from scheduling_buyers 
-- select * from account_organization_user_profile_plan
-- select * from veosolutionssecurity_users
-- select * from veosolutionssecurity_account_organizations
-- select * from veosolutionssecurity_organizations
select
a.*, 
u1.first_name + ' ' + u1.last_name as buyer_name, 
u2.first_name + ' ' + u2.last_name as designer_name, 
l.name as location_name, 
o.name as org_name 
from 
scheduling_appointments a with (nolock) 
join account_organization_user_profile_plan pp with (nolock)  on pp.profile_id = dbo.ef_selSchedulingBuyerActiveProfilePlan(a.buyer_profile_id)
join veosolutionssecurity_users u1 with (nolock)  on u1.user_id = pp.user_id
join veosolutionssecurity_users u2 with (nolock)  on u2.user_id = a.schedule_user_id 
join veosolutionssecurity_locations l with (nolock)  on l.location_id = a.location_id 
join veosolutionssecurity_account_organizations ao with (nolock)  on ao.account_org_id = a.account_org_id
join veosolutionssecurity_organizations o with (nolock)  on o.organization_id = ao.organization_id 
where 
a.is_scheduled = 1
and 
(a.appointment_date = @date or @date is null)
and 
a.location_id = @location_id 
order by 
start_time asc
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingAppointmentTemplates]...';


GO
CREATE procedure [dbo].[vs_selSchedulingAppointmentTemplates]
@account_org_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
--select @active_user_id = [user_id] from VeoSolutionsSecurity_users_login_sessions where security_token = @security_token 
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- testing 
--	select * from VeoSolutionsSecurity.dbo.account_organizations
--  select * from scheduling_appointment_templates
--	vs_selSchedulingAppointmentTemplates 'CC2A0C00-FD76-408C-AFCB-3C5134671848'

if not exists(select template_id from scheduling_appointment_templates with (nolock)  where account_org_id = @account_org_id) 
begin 
	-- insert default template 
	insert into scheduling_appointment_templates
	(account_org_id, template_id, template_name, author, create_date, modifier, modified_date) 
	values 
	(@account_org_id, newid(),  'Default', @active_user_id, GETDATE(), @active_user_id, GETDATE()) 
end 

select 
t.*, 
i.template_appointment_id, 
i.appointment_type, 
i.duration
from 
	scheduling_appointment_templates t with (nolock) 
	left join scheduling_appointment_templates_detail i with (nolock)  on i.template_id = t.template_id 
where
	account_org_id = @account_org_id 
order by 
	template_name, i.appointment_type asc
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingBuilder]...';


GO
CREATE procedure [dbo].[vs_selSchedulingBuilder]
@account_org_id uniqueidentifier
as
-- testing: 
-- select * from VeoSolutionsSecurity.dbo.account_organizations
-- vs_selSchedulingBuilder 'CC2A0C00-FD76-408C-AFCB-3C5134671848'
select 
	o.*
from 
	scheduling_organizations o with (nolock) 
where 
	o.account_org_id = @account_org_id
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingBuyer]...';


GO
CREATE procedure [dbo].[vs_selSchedulingBuyer] 
@profile_id uniqueidentifier 
as 
-- vs_selSchedulingBuyerProfilesByOperator 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'

-- [vs_selSchedulingBuyer] '2CE93ABE-EBD5-4014-B669-5498D5FC012D'
-- vs_selSchedulingBuyer 'A3684CAC-5C38-44B6-B4A8-1DE60A65EF0F'

-- SANDBOX TESTING 
-- vs_selSchedulingBuyer '6F406F49-E306-427B-8E1F-86DE56662282'
--declare @operator uniqueidentifier 
-- TESTING 
/* 

	Modified By: Charles Moore
	Date: 9/10/2021
	Description: Convert Lot to string values

select * from account_organization_user_profile_plan
select distinct u.user_id, u.first_name, u.last_name from veosolutionssecurity.dbo.users u 
join veosolutionssecurity.dbo.account_organization_users_roles ur on ur.user_id = u.user_id -- has a role...
join veosolutionssecurity.dbo.roles r on r.role_id = ur.role_id 
where 
r.name = 'Homebuyer'

select * from scheduling_buyers
*/


select 
	pp.user_id, 
	b.profile_id, 
	b.buyer_name as name,
	u.first_name, 
	u.last_name, 
	ao.account_org_id, 
	o.name as organization_name,  
	b.schedule_status as schedule_status, 
	b.received_date, 
	isnull(pp.[address],'') as [address],  
	case when block = '' then '' else 'Blk: ' + block + ' ' end + 
		case when lot in('0','') then '' else 'Lot: ' + pp.lot end  as lot_block,
	pp.home_phone, 
	pp.work_phone,
	pp.status, 
	b.schedule_status as schedule_status, 
	pp.contract_date, 
	b.received_date, 
	b.is_active 
from 
	scheduling_buyers b with (nolock)
	join account_organization_user_profile_plan pp with (nolock) on pp.profile_id = dbo.ef_selSchedulingBuyerActiveProfilePlan(b.profile_id) 
	join VeoSolutionsSecurity_users u with (nolock) on u.user_id = pp.user_id 
	join VeoSolutionsSecurity_account_organizations ao with (nolock) on ao.account_id = pp.account_id and ao.organization_id = pp.organization_id 
	join VeoSolutionsSecurity_organizations o with (nolock) on o.organization_id = ao.organization_id
where 
	b.profile_id = @profile_id 


-- old code - pre is_active change, profile update 
--select 
--u.user_id, 
--pp.profile_id, 
--u.first_name + ' ' + u.last_name as name, 
--u.first_name, 
--u.last_name, 
--ao.account_org_id, 
--o.name as organization_name,  
--pp.address_lot_block as address, 
--pp.home_phone, 
--pp.work_phone,
--pp.status, 
--b.schedule_status as schedule_status, 
--pp.contract_date, 
--b.received_date, 
--b.is_active 

--from 
--account_organization_user_profile_plan pp 
--join VeoSolutionsSecurity_users u on u.user_id = pp.user_id 
--join VeoSolutionsSecurity_account_organizations ao on ao.account_id = pp.account_id and ao.organization_id = pp.organization_id 
--join VeoSolutionsSecurity_organizations o on o.organization_id = ao.organization_id
--left join scheduling_buyers b on b.profile_id = pp.profile_id 
--where 
--pp.profile_id = @profile_id 
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingBuyerAppointments]...';


GO
CREATE procedure [dbo].[vs_selSchedulingBuyerAppointments]
@profile_id uniqueidentifier
as
-- vs_selSchedulingBuyerAppointments  'DB78C8F2-58CC-4A53-B8B8-A2DABFE579A6'

-- select * from scheduling_appointment_tasks
-- select * from account_organization_user_profile_plan
-- select * from scheduling_appointments order by create_date desc
-- select * from account_organization_user_profile where profile_id = 'DB78C8F2-58CC-4A53-B8B8-A2DABFE579A6'
-- select * from scheduling_buyers where profile_id = 'DB78C8F2-58CC-4A53-B8B8-A2DABFE579A6' 
-- select * from scheduling_organizations
select 
a.*,
--o.name as org_name, 
l.name as location_name,
o.display_name as org_name, 
u.first_name + ' ' + u.last_name as buyer_name

from
scheduling_appointments a with (nolock) 
join account_organization_user_profile_plan pp  with (nolock) on pp.profile_id = dbo.ef_selSchedulingBuyerActiveProfilePlan(a.buyer_profile_id)
join VeoSolutionsSecurity_users u  with (nolock) on u.user_id = pp.user_id 
join scheduling_organizations o  with (nolock) on o.account_org_id = a.account_org_id 
left join VeoSolutionsSecurity_locations l  with (nolock) on l.location_id = a.location_id
where 
a.buyer_profile_id = @profile_id  
order by 
a.appointment_type asc
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingBuyerDesignAppointmentInfo]...';


GO
CREATE procedure vs_selSchedulingBuyerDesignAppointmentInfo
@profile_id uniqueidentifier

as

-- fetches information on what the system thinks is the most current appointment for this buyer design session 
-- what do we need? 
-- buyer id 
-- appointment id 
-- date/time 
-- start/end scheduled 
-- designer 

-- testing: 
-- vs_selSchedulingBuyerDesignAppointmentInfo '4abeec17-dc72-4571-bb74-2c2343eb2f71' 

-- select * from account_organization_user_profile where profile_id = '682f227f-788b-498c-a106-d69cf1ceea17' 

-- research: 
-- select top 100 * from scheduling_buyers 
-- select top 100 * from account_organization_user_profile where profile_id in (select profile_id from scheduling_buyers) 
-- AF0CC4D0-1419-4B15-A982-C569E69F782D


-- here you can tweak the date/time to test different scenarios. Default to Today/Now. 
declare @test_date datetime 
declare @test_time time 

select @test_date = DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE())) 
select @test_time = convert(time, getdate() ) 


-- NOTE: i am using a table variable here only because the logic has not been firmly established. 
-- I expect changes to which appointments to return. 
declare @appointments table 
(
	appointment_id uniqueidentifier, 
	buyer_profile_id uniqueidentifier, 
	appointment_type int, 
	appointment_label varchar(200), 
	appointment_duration int, 
	appointment_date datetime, 
	
	start_time time, 
	end_time time, 
	start_time_actual time, 
	end_time_actual time
) 


-- GET TODAY'S APPOINTMENTS 
insert into @appointments 

select 
	appointment_id, 
	buyer_profile_id, 
	appointment_type, 
	appointment_label, 
	appointment_duration, 
	appointment_date, 
	start_time, 
	end_time, 
	
	start_time_actual, 
	end_time_actual 
from 
	scheduling_appointments a with (NOLOCK) 
	--join scheduling_buyers b on b.profile_id = a.buyer_profile_id 
where 
	buyer_profile_id = @profile_id 
	and a.is_scheduled = 1 
	and appointment_date = @test_date -- scheduled is from today 


declare @start_time time(7)

-- NORMAL CHECK IN 
-- fetch most recent appointment where start_time is less than or equal to this one 
-- if there are multiple appointments, get the one closest to NOW 
select top 1 @start_time = max(start_time) from @appointments where start_time <= @test_time   -- start time is before now 

-- EARLY CHECK IN? 
if (@start_time is null) 
begin 
	select top 1 @start_time = max(start_time) from @appointments where start_time_actual is not null and end_time_actual is null 
end 

-- fetch appointment id 
declare @appointment_id uniqueidentifier 
select @appointment_id = appointment_id from @appointments where start_time = @start_time 

select * from scheduling_appointments where appointment_id = @appointment_id 

-- vs_selSchedulingBuyerDesignAppointmentInfo '4ABEEC17-DC72-4571-BB74-2C2343EB2F71' 
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingBuyerProfilePlanInfo]...';


GO
CREATE procedure [dbo].[vs_selSchedulingBuyerProfilePlanInfo]
	@profile_id uniqueidentifier
as

-- TESTING 
-- sandbox, new buyer 
--[vs_selSchedulingBuyerProfilePlanInfo] '3E971EFD-92C4-42A5-BE07-8FA228014B6C'

select
	pp.*,
	o.property_desc_1_label,
	o.property_desc_2_label
from 
	account_organization_user_profile_plan pp with (nolock) 
	left join veosolutionssecurity_organizations o with (nolock) on o.organization_id = pp.organization_id
where 
	profile_id = dbo.ef_selSchedulingBuyerActiveProfilePlan(@profile_id)
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingBuyerProfilesByOperator]...';


GO

CREATE procedure [dbo].[vs_selSchedulingBuyerProfilesByOperator] 
@operator uniqueidentifier ,
@security_token uniqueidentifier = null
as

-- TESTING SANDBOX: 
-- select * from scheduling_users
--  vs_selSchedulingBuyerProfilesByOperator '0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B'
--  vs_selSchedulingBuyerProfilesByOperator  'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'

-- 6 buyers 
--profile_id  tier   buyer_name    pp_status
--EB938947-4E53-479E-96E3-01F06E75BC6E   0      New Homebuyer Contracted
--4D93C3C1-849F-4F2C-8CFB-C2E077CED430   0      Deepa Venkat  Contracted
--6F406F49-E306-427B-8E1F-86DE56662282   0      Chin Chong Tan      Contracted
--C6BB5C2D-8647-481E-A6D0-BD72E369BB64   0      NotsoNew Homeshoppertest       Contracted
--B5C458FE-1970-4AAB-B426-5CC287309B1E   1      Marc Smith    Contracted
--2456DBB3-86AC-42BF-96BE-FD9E06A4DFF7   1      Rupali Rane   Contracted

-- verify plan id is correct here.... 
--declare @plan_id uniqueidentifier 
--select @plan_id = dbo.ef_selSchedulingBuyerActiveProfilePlan('EB938947-4E53-479E-96E3-01F06E75BC6E')
--print @plan_id 

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)


-- FETCH A BUILDER FROM PREFERENCES 
declare @selected_account_org uniqueidentifier 
set @selected_account_org = '00000000-0000-0000-0000-000000000000'  

-- select * from scheduling_user_preferences 
--if exists( select pref_value from scheduling_user_preferences where user_id = @operator and pref_key = 'selected_account_org' ) 
--begin 
--select @selected_account_org = convert(uniqueidentifier, pref_value)  from scheduling_user_preferences where user_id = @operator and pref_key = 'selected_account_org'
--end 


/* 
select * from scheduling_appointments
-- select * from scheduling_users
select distinct u.user_id, u.first_name, u.last_name from veosolutionssecurity.dbo.users u 
join veosolutionssecurity.dbo.account_organization_users_roles ur on ur.user_id = u.user_id -- has a role...
join veosolutionssecurity.dbo.roles r on r.role_id = ur.role_id 
where 
r.name = 'Homebuyer'
-- update scheduling_appointments set is_scheduled = 0 where buyer_profile_id = 'CAF34D10-0D41-4750-82A2-C12DC756C7F1'

*/

-- local only for now
declare @received_after datetime 
set @received_after = dateadd(d, -180, getdate()) 

--print @received_after

declare @buyers table 
( 
       profile_id uniqueidentifier, 
       tier int, 
       buyer_name varchar(200), 
       is_active int, 
       pp_status varchar(100) 
) 


insert into 
       @buyers 
select
       b.profile_id, 
       0 as tier, 
       b.buyer_name,  
       b.is_active, 
       pp.status as pp_status
from 
       scheduling_buyers b  with (nolock)
       join account_organization_user_profile_plan pp with (nolock) on pp.profile_id = dbo.ef_selSchedulingBuyerActiveProfilePlan(b.profile_id) 
       join veosolutionssecurity_account_organizations ao with (nolock) on ao.account_id = pp.account_id and ao.organization_id = pp.organization_id 
       join scheduling_user_organizations suo with (nolock) on suo.account_org_id = ao.account_org_id 
       join scheduling_organizations o with (nolock) on o.account_org_id = suo.account_org_id 
where
       b.is_active = 1
       AND 
       b.create_date >= @received_after 
       AND 
       suo.user_id = @operator
       AND 
       (suo.account_org_id = @selected_account_org OR 
             @selected_account_org = '00000000-0000-0000-0000-000000000000'  
       ) 
        


select * from @buyers 

-- OLD CODE: pre is_active/user profile id change 
---- get any buyers in scheduling for the operator who are NOT fully scheduled. 
--insert into @buyers 
--select
--     b.profile_id, 
--     -1 as tier, 
--     b.buyer_name, 
--     pp.status as pp_status
--from scheduling_buyers b 
--join account_organization_user_profile_plan pp on pp.profile_id = b.profile_id 
--join veosolutionssecurity_account_organizations ao on ao.account_id = pp.account_id and ao.organization_id = pp.organization_id 
--join scheduling_user_organizations suo on suo.account_org_id = ao.account_org_id 
--join scheduling_organizations o on o.account_org_id = suo.account_org_id 
--where 
--     suo.user_id = @operator

---- TIER 0 - buyers with open appointments 
---- setup, but with some open appointment slots to be scheduled 
--update 
--@buyers 
--set tier = 0 
--where 
--profile_id in ( select buyer_profile_id from scheduling_appointments where buyer_profile_id is not null and  is_scheduled = 0) 
 
---- TIER 1 - buyers who have not been setup 
--update 
--@buyers 
--set 
--tier = 1 
--where
--profile_id not in (select buyer_profile_id from scheduling_appointments where buyer_profile_id is not null) 

---- TIER 2 - buyers with appointments - all scheduled 
--update 
--@buyers 
--set 
--tier = 2 
--where 
--profile_id not in ( 
--select 
--distinct 
--a.buyer_profile_id 
--from scheduling_appointments a 
--join scheduling_appointments b on b.buyer_profile_id = a.buyer_profile_id 
--where 
--a.buyer_profile_id is not null 
--and b.is_scheduled = 0) 
--and tier not in (0,1) -- don't update those already determined 

--select * from @buyers where pp_status not in ('Complete','Bustout') and tier in (0,1)  order by tier asc  
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingBuyerProfilesByOperatorForDateRange]...';


GO
CREATE procedure [dbo].[vs_selSchedulingBuyerProfilesByOperatorForDateRange] 
@operator uniqueidentifier ,
@security_token uniqueidentifier = null,
@start_date datetime = null, 
@end_date datetime = null 
as

/*
select * from scheduling_users 
select * from scheduling_appointments

-- TESTING: DEV 
[vs_selSchedulingBuyerProfilesByOperator] 0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B
[vs_selSchedulingBuyerProfilesByOperatorForDateRange] 0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B
select distinct u.user_id, u.first_name, u.last_name from veosolutionssecurity.dbo.users u 
join veosolutionssecurity.dbo.account_organization_users_roles ur on ur.user_id = u.user_id -- has a role...
join veosolutionssecurity.dbo.roles r on r.role_id = ur.role_id 
where 
r.name = 'Homebuyer'
-- update scheduling_appointments set is_scheduled = 0 where buyer_profile_id = 'CAF34D10-0D41-4750-82A2-C12DC756C7F1'
*/

-- TESTING 
-- select * from scheduling_buyers
--  vs_selSchedulingBuyerProfilesByOperator 'C910749E-CA8B-46B1-BFE8-4525C10CC4DA'

if (@start_date is null) 
set @start_date = getdate() 

if (@end_date is null) 
set @end_date = dateadd(d, 30, @start_date) -- note: could use user_preferences days to load to set this more appropriately 

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
 
declare @buyers table 
( 
	profile_id uniqueidentifier, 
	tier int, 
	buyer_name varchar(200), 
	pp_status varchar(100) 
) 

-- fetch all buyers for orgs associated with the operator 
-- NOTE: this will get slower with time. need to move this once we have a "Contract" entity in VEO
insert into 
@buyers 
(profile_id, tier, buyer_name, pp_status) 
select 
distinct 
pp.profile_id, 
-1,
u.first_name + ' ' + u.last_name, 
pp.status  
 -- default to something bogus 
from 
veosolutionssecurity_users u 
join veosolutionssecurity_account_organization_users_roles_legacy ur on ur.user_id = u.user_id -- has a role...
join veosolutionssecurity_roles_legacy r on r.role_id = ur.role_id 
join veosolutionssecurity_account_organizations ao on ao.account_id = ur.account_id and ao.organization_id = ur.organization_id 
join account_organization_user_profile_plan pp on pp.account_id = ao.account_id and pp.organization_id = ao.organization_id and pp.user_id = u.user_id 
join scheduling_user_organizations suo on suo.account_org_id = ao.account_org_id 
where
--r.role_id = 'D79046BE-DBCF-49F4-896A-7FA7DEA5CE21' -- homebuyer role 
r.name = 'Homebuyer'
and 
suo.user_id = @operator 
and pp.status in ( 'Contracted' ,  'Complete') 


-- GENERATE SCHEDULING BUYER RECORDS 
insert into 
scheduling_buyers
(profile_id, schedule_status, buyer_name, author, create_date, modifier, modified_date)
select 
profile_id, 
0 ,
buyer_name, 
@active_user_id,
GETDATE(),
@active_user_id,
GETDATE()
from 
@buyers
where 
profile_id not in (select profile_id from scheduling_buyers) 


-- TIER 0 - buyers with open appointments 
-- setup, but with some open appointment slots to be scheduled 
update 
@buyers 
set tier = 0 
where 
profile_id in ( select buyer_profile_id from scheduling_appointments where buyer_profile_id is not null and  is_scheduled = 0) 
 
-- TIER 1 - buyers who have not been setup 
update 
@buyers 
set 
tier = 1 
where
profile_id not in (select buyer_profile_id from scheduling_appointments where buyer_profile_id is not null) 

-- TIER 2 - buyers with appointments - all scheduled 
update 
@buyers 
set 
tier = 2 
where 
profile_id not in ( 
select 
distinct 
a.buyer_profile_id 
from scheduling_appointments a 
join scheduling_appointments b on b.buyer_profile_id = a.buyer_profile_id 
where 
a.buyer_profile_id is not null 
and b.is_scheduled = 0
and ( b.appointment_date < @start_date  or b.appointment_date > @end_date ) 
) 
and tier not in (0,1) -- don't update those already determined 
 
select * from @buyers where pp_status <> 'Complete'  order by tier asc  -- ignore completed buyers 

-- OPTIMIZATION TESTING -- 03.27.2013
--select * from @buyers where pp_status <> 'Complete' and tier in (0,1)  order by tier asc  -- ignore completed buyers 

--union

--select * from @buyers where pp_status <> 'Complete' and tier = 2 and profile_id in (and b.appointment_date >=  @start_date and ( b.appointment_date <= @end_date or @end_date is null) 

-- select * from veosolutionssecurity.dbo.roles
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingBuyersContact]...';


GO
CREATE procedure [dbo].[vs_selSchedulingBuyersContact]

@profile_id uniqueidentifier

as

select * from scheduling_buyers_contacts  with (nolock)
where 
profile_id = @profile_id 
and is_buyer = 1
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingBuyersContacts]...';


GO
CREATE procedure [dbo].[vs_selSchedulingBuyersContacts]

@profile_id uniqueidentifier 

as

-- testing 
-- [vs_selSchedulingBuyersContacts] '05809f0f-7df8-443a-bf44-a303c55dd5bc'

-- import if none exist 
if not exists (select top 1 * from scheduling_buyers_contacts with (nolock) where profile_id = @profile_id) 
begin 

exec vs_importSchedulingBuyersContacts @profile_id 

end 



select * from scheduling_buyers_contacts  with (nolock)
where 
profile_id = @profile_id 
and is_buyer = 1

UNION 

select * from scheduling_buyers_contacts  with (nolock)
where 
profile_id = @profile_id 
and is_buyer <> 1 
order by contact_label asc
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingBuyersSearch]...';


GO
/*
	Modified 10/25/2019 - Eric Hickey
		No longer return profile plans that are 'Active', as that status has been merged with 'Contracted'

	Modified By: Charles Moore
	Date: 9/10/2021
	Description: Convert Lot to string values
*/

CREATE procedure [dbo].[vs_selSchedulingBuyersSearch] 
@operator uniqueidentifier, 
@account_org_id uniqueidentifier, 
@searchterm varchar(100), 
@received_after datetime = null 
WITH RECOMPILE
AS 
-- HISTORY 
--
-- 09.14.16 We were getting timeouts so I rewrote the proc. If issues arrive with results, please 
-- consult: [vs_selSchedulingBuyersSearch_20160914]
--
-- 10.17.13 - modified by RH to limit the results to the selected account org (in user preferences). Note that if one is not found, or if it's all, then it doesn't affect the search. 
--
--
-- TESTING 
-- select address_lot_block, job_no, status, * from account_organization_user_profile_plan

-- ADDRESS SEARCHES 
-- vs_selSchedulingBuyersSearch  'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', 't'
-- vs_selSchedulingBuyersSearch  'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', 'Took'

-- BUYER NAME 
-- vs_selSchedulingBuyersSearch '260de2f2-b022-48cf-b3bd-dd940394fb7b', '8a2c79c1-0ae2-47f7-b816-b01f08322b55', 'Reid'

-- vs_selSchedulingBuyersSearch  '260de2f2-b022-48cf-b3bd-dd940394fb7b', '8a2c79c1-0ae2-47f7-b816-b01f08322b55', 'Smith'


-- BUYER NAME RECEIVED AFTER YESTERDAY
-- vs_selSchedulingBuyersSearch   '260de2f2-b022-48cf-b3bd-dd940394fb7b','8a2c79c1-0ae2-47f7-b816-b01f08322b55', 'Smith', '04/15/16'

-- JOB NO 
-- vs_selSchedulingBuyersSearch  'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', '123'

-- select * from scheduling_user_preferences where pref_key = 'selected_account_org'
-- 00000000-0000-0000-0000-000000000000

-- testing selected org: 
-- update scheduling_user_preferences set pref_value = '00000000-0000-0000-0000-000000000000' where pref_key = 'selected_account_org' and user_id = 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'
-- update scheduling_user_preferences set pref_value = '2F3B34D1-80BD-41D8-8CC6-B662A186F7AE' where pref_key = 'selected_account_org' and user_id = 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'
-- update scheduling_user_preferences set pref_value = 'CC2A0C00-FD76-408C-AFCB-3C5134671848' where pref_key = 'selected_account_org' and user_id = 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'


SELECT 
	newid() as id, 
	b.profile_id, 
	b.schedule_status as schedule_status, 
	b.received_date, 
	b.buyer_name as name,
	b.is_active, 
	pp.[user_id], 
	ao.account_org_id, 
	o.name as organization_name,
	u.first_name, 
	u.last_name, 
	pp.[address], 
	case when block = '' then '' else 'Blk: ' + block + ' ' end + 
		case when lot in('0','') then '' else 'Lot: ' + pp.lot end  as lot_block,
	pp.home_phone, 
	pp.work_phone,
	case pp.status
		when 'Contracted' then 0 
		when 'Active' then 1 
		when 'Complete' then 2 
		when 'Bustout' then 3
	end as status_value, 
	pp.status, 
	pp.contract_date
INTO #temp_results 
from 
	scheduling_buyers b  with (nolock)
	join account_organization_user_profile p   with (nolock) on p.profile_id = b.profile_id  --p.account_id = pp.account_id and p.organization_id = pp.organization_id and p.user_id = pp.user_id 
	join account_organization_user_profile_plan pp with (nolock) on p.account_id = pp.account_id and p.organization_id = pp.organization_id and p.user_id = pp.user_id 
	join VeoSolutionsSecurity_account_organizations ao with (nolock) on ao.account_id = pp.account_id and ao.organization_id = pp.organization_id 
	join VeoSolutionsSecurity_organizations o with (nolock) on o.organization_id = ao.organization_id
	join VeoSolutionsSecurity_users u with (nolock) on u.user_id = pp.user_id 
where 
	(pp.address like '%' + @searchterm + '%'
	OR 
	b.buyer_name like '%' + @searchterm + '%')
	AND ao.account_org_id in (select account_org_id from scheduling_user_organizations with (nolock) where user_id = @operator) 
	AND 
	(ao.account_org_id = @account_org_id  OR @account_org_id = '00000000-0000-0000-0000-000000000000') 
	AND
	(@received_after is null OR b.create_date >= @received_after) 

DELETE FROM #temp_results WHERE id in (
	SELECT id FROM (
		SELECT 
			id, ROW_NUMBER() OVER (PARTITION BY profile_id ORDER BY status_value asc) AS row_counter
			  -- Change the partition columns to include the ones that make the row distinct
			FROM 
				#temp_results
	) a WHERE row_counter > 1 
)

SELECT  
	profile_id, 
	schedule_status, 
	received_date, 
	name,
	is_active, 
	[user_id], 
	account_org_id, 
	organization_name,
	first_name, 
	last_name, 
	[address], 
	lot_block,
	home_phone, 
	work_phone,
	status, 
	contract_date 
FROM 
	#temp_results 

drop table #temp_results
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingEnabledOrganizationsList]...';


GO
CREATE procedure [dbo].[vs_selSchedulingEnabledOrganizationsList]
@account_id uniqueidentifier, 
@operator_id uniqueidentifier = null 
as
-- testing: 
-- vs_selSchedulingEnabledOrganizationsList 'BAB32B7E-3ADA-497C-862E-E5083971CC59', 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'
-- select * from veosolutionssecurity.dbo.users where first_name = 'Robert' 
-- select * from scheduling_organizations
-- select * from veosolutionssecurity.dbo.organizations
-- this fetches organizations enabled for scheduling (scheduling_organizations)  

select 
	so.account_org_id, 
	so.display_name as name,
	o.organization_type, 
	so.display_hours_start, 
	so.display_hours_end, 
	so.excluded_designers,
	so.email_cc
from 
	scheduling_organizations so 
	join VeoSolutionsSecurity_account_organizations ao on ao.account_org_id = so.account_org_id 
	join VeoSolutionsSecurity_organizations o on o.organization_id = ao.organization_id 
	join VeoSolutionsSecurity_account_organization_users u on u.account_id = ao.account_id and u.organization_id = ao.organization_id
where 
	ao.account_id = @account_id 
	and o.active = 1 
	and u.user_id = @operator_id 
order by name asc
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingLocation]...';


GO
CREATE procedure [dbo].[vs_selSchedulingLocation]
@location_id uniqueidentifier
as
-- vs_selSchedulingLocation 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23'
select 
* 
from 
	VeoSolutionsSecurity_locations  with (nolock)
where 
	location_id = @location_id 
order by 
name asc
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingLocations]...';


GO
CREATE procedure [dbo].[vs_selSchedulingLocations]
as
-- NOTE: i put locations as a global table in veo solutions security, still this proc is used by scheduling, 
-- so I have named it thus to remind myself and others that should we expand the scope of locations in the system, it is used in this subsystem 
-- and thus must be updated 
--	select * from VeoSolutionsSecurity.dbo.locations
select 
* 
from 
	VeoSolutionsSecurity_locations with (nolock)
order by 
name asc
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingMessagesForBuyer]...';


GO
CREATE procedure [dbo].[vs_selSchedulingMessagesForBuyer] 
@buyer_profile_id uniqueidentifier 
as

-- testing 
-- select * from scheduling_messages
-- delete from scheduling_messages
-- vs_selSchedulingMessagesForBuyer 'ba9eb6b0-ed9a-4708-85a3-2977e60f4961'

select 
m.message_id,
m.message_type, 
m.message_status, 
m.is_read, 
m.message_title, 
m.message_priority, 
m.user_id, 
m.buyer_profile_id, 
m.appointment_id, 
m.sender_id,  
isnull(m.message_body, '') as message_body, 
m.completion_date, 
m.dismissed, 
m.tags, 
m.author, 
m.create_date, 
m.modifier, 
m.modified_date,
m.stamp,
isnull(u.first_name + ' ' + u.last_name, '') as sender_name  
from 
scheduling_messages m with (nolock)
left join scheduling_users u with (nolock) on u.user_id = m.sender_id
where 
buyer_profile_id = @buyer_profile_id  
order by 
m.create_date desc 


--message_priority asc
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingMessagesForBuyerScoped]...';


GO
CREATE procedure [dbo].[vs_selSchedulingMessagesForBuyerScoped] 
@buyer_profile_id uniqueidentifier, 
@loading_scope int = 0, 
@lastX int = 0
as

-- testing 
-- select * from scheduling_messages
-- delete from scheduling_messages
-- vs_selSchedulingMessagesForBuyerScoped 'A3684CAC-5C38-44B6-B4A8-1DE60A65EF0F'
-- vs_selSchedulingMessagesForBuyerScoped 'A3684CAC-5C38-44B6-B4A8-1DE60A65EF0F', 1
-- vs_selSchedulingMessagesForBuyerScoped 'A3684CAC-5C38-44B6-B4A8-1DE60A65EF0F', null, 5


-- Loading Scopes: 
-- All
-- UserOnly
-- LastX (all) 

declare @messages as table 
( 
message_id uniqueidentifier, 
message_type int, 
create_date datetime
)

-- insert all 
insert into 
@messages
select 
	message_id, 
	message_type, 
	create_date 
from 
	scheduling_messages with (nolock)
where 
	buyer_profile_id = @buyer_profile_id
	
-- select all
if (@loading_scope = 0) 
begin 
select 
m.message_id,
m.message_type, 
m.message_status, 
m.is_read, 
m.message_title, 
m.message_priority, 
m.user_id, 
m.buyer_profile_id, 
m.appointment_id, 
m.sender_id,  
isnull(m.message_body, '') as message_body, 
m.completion_date, 
m.dismissed, 
m.tags, 
m.author, 
m.create_date, 
m.modifier, 
m.modified_date,
m.stamp,
isnull(u.first_name + ' ' + u.last_name, '') as sender_name  
from 
scheduling_messages m with (nolock)
join @messages m1 on m1.message_id = m.message_id
left join scheduling_users u with (nolock) on u.user_id = m.sender_id
order by 
m.create_date desc 

end 

if (@loading_scope = 1) -- user only 
begin 

select 
m.message_id,
m.message_type, 
m.message_status, 
m.is_read, 
m.message_title, 
m.message_priority, 
m.user_id, 
m.buyer_profile_id, 
m.appointment_id, 
m.sender_id,  
isnull(m.message_body, '') as message_body, 
m.completion_date, 
m.dismissed, 
m.tags, 
m.author, 
m.create_date, 
m.modifier, 
m.modified_date,
m.stamp,
isnull(u.first_name + ' ' + u.last_name, '') as sender_name  
from 
scheduling_messages m with (nolock)
join @messages m1 on m1.message_id = m.message_id
left join scheduling_users u with (nolock) on u.user_id = m.sender_id
where 
	m.message_type in (1,12,13,14,15,16,17)
order by 
	m.create_date desc 


end 

if (@lastX > 0) 
begin 
declare @sql varchar(1000); 

set @sql = 
'select 
top ' + convert(varchar(4), @lastX) + '
m.message_id,
m.message_type, 
m.message_status, 
m.is_read, 
m.message_title, 
m.message_priority, 
m.user_id, 
m.buyer_profile_id, 
m.appointment_id, 
m.sender_id,  
isnull(m.message_body, '') as message_body, 
m.completion_date, 
m.dismissed, 
m.tags, 
m.author, 
m.create_date, 
m.modifier, 
m.modified_date,
m.stamp,
isnull(u.first_name + '' '' + u.last_name, '''') as sender_name  
from 
scheduling_messages m with (nolock)
join @messages m1 with (nolock) on m1.message_id = m.message_id
left join scheduling_users u with (nolock) on u.user_id = m.sender_id
order by 
m.create_date desc' 

print @sql 

end
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingMessagesForOperator]...';


GO
CREATE procedure [dbo].[vs_selSchedulingMessagesForOperator] 
@operator_id uniqueidentifier 
as

-- testing 
--[vs_selSchedulingMessagesForOperator] 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'
-- select * from scheduling_users
select 
m.*, 
isnull(u.first_name + ' ' + u.last_name, '') as sender_name  
from 
scheduling_messages m with (nolock)
left join scheduling_users u with (nolock) on u.user_id = m.sender_id
where 
m.[user_id] = @operator_id
and m.message_status  in (0,1) 
and m.dismissed <> 1 
order by 
create_date desc 
--message_priority asc
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingOrganizationLocations]...';


GO
CREATE procedure [dbo].[vs_selSchedulingOrganizationLocations]
@account_org_id uniqueidentifier
as

-- testing 
-- select * from VeoSolutionsSecurity.dbo.locations
--	select * from VeoSolutionsSecurity.dbo.account_organizations
--	vs_selSchedulingOrganizationLocations 'CC2A0C00-FD76-408C-AFCB-3C5134671848'
select 
l.*
from 
	VeoSolutionsSecurity_account_organization_locations aol with (nolock)
	join VeoSolutionsSecurity_locations l with (nolock) on l.location_id = aol.location_id 
where 
	aol.account_org_id = @account_org_id
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingOrganizationsByLocation]...';


GO
CREATE PROCEDURE [dbo].[vs_selSchedulingOrganizationsByLocation]
	@account_id uniqueidentifier,
	@location_id uniqueidentifier,
	@operator_id uniqueidentifier
AS
/*
	Author: Roger Wang
	Date: 09/30/2022
	Description: Returns a list of organizations for a given location
*/

select
	ao.account_org_id, 
	o.name, 
	o.organization_type, 
	o.external_organization_id, 
	o.dc_billing_id
from
	VeoSolutionsSecurity_account_organization_locations aol with (nolock)
	inner join VeoSolutionsSecurity_account_organizations ao with (nolock) on ao.account_org_id = aol.account_org_id
	inner join VeoSolutionsSecurity_organizations o with (nolock) on o.organization_id = ao.organization_id
	inner join VeoSolutionsSecurity_account_organization_users u with (nolock) on u.account_id = ao.account_id and u.organization_id = ao.organization_id
	inner join VeoSolutionsSecurity_locations l with (nolock) on l.location_id = aol.location_id
where
	ao.account_id = @account_id
	and aol.location_id = @location_id
	and o.active = 1
	and u.user_id = @operator_id
order by
	o.name asc
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingOrganizationsList]...';


GO
CREATE procedure [dbo].[vs_selSchedulingOrganizationsList]
@account_id uniqueidentifier, @operator_id uniqueidentifier
as

-- SUMMARY: fetches a list of organizations to import into scheduling. Scoped by the operator. 

-- testing: 
-- vs_selSchedulingOrganizationsList 'BAB32B7E-3ADA-497C-862E-E5083971CC59', 'A2A96317-4836-49F9-A0B2-2E3895BB0CCE'
-- select * from veosolutionssecurity_users
-- this version fetches all orgs for the account, excluding those already in scheduling_organizations 
select 
	ao.account_org_id, 
	o.name, 
	o.organization_type, 
	o.external_organization_id, 
	o.dc_billing_id
from 
	VeoSolutionsSecurity_account_organizations ao
	join VeoSolutionsSecurity_organizations o on o.organization_id = ao.organization_id 
	join VeoSolutionsSecurity_account_organization_users u on u.account_id = ao.account_id and u.organization_id = ao.organization_id
	
where 
	ao.account_id = @account_id 
	and o.active = 1 
	and ao.account_org_id not in (select account_org_id from scheduling_organizations ) 
	and u.user_id = @operator_id 
order by name asc 

-- THIS VERSION JOINS ON ORG APPS, SO IF AN ORG DOESN'T HAVE SCHEDULING ENABLED, THEY DON"T SHOW UP. 
--select 
--	a.*, 
--	ao.account_org_id, 
--	o.name, 
--	o.organization_type, 
--	o.external_organization_id, 
--	o.dc_billing_id
--from 
--	VeoSolutionsSecurity.dbo.account_organization_apps a
--	join VeoSolutionsSecurity.dbo.account_organizations ao on ao.account_id = a.account_id and ao.organization_id = a.organization_id
--	join VeoSolutionsSecurity.dbo.organizations o on o.organization_id = a.organization_id
--where 
--	a.app_id = 'Scheduling'
--	and o.active = 1 
--	and a.account_id = @account_id 
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingRoles]...';


GO
CREATE procedure [dbo].[vs_selSchedulingRoles] 
as

-- vs_selSchedulingRoles
-- select * from veosolutionssecurity.dbo.app_roles
select 
r.*
from veosolutionssecurity_app_roles_legacy r with (nolock)
where 
app_id = 'Scheduling' 
order by r.name asc
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingSettings]...';


GO
CREATE PROCEDURE [dbo].[vs_selSchedulingSettings]
AS
BEGIN
    SELECT * FROM scheduling_settings;
END;
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingSmsOptIn]...';


GO
CREATE PROCEDURE [dbo].[vs_selSchedulingSmsOptIn]
	@phone_number VARCHAR(25) = ''
AS
SELECT
	*
FROM
	[dbo].[scheduling_sms_opt_in]
WHERE
	ISNULL(@phone_number, '') = ''
	OR [phone_number] = @phone_number
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingUser]...';


GO
CREATE procedure [dbo].[vs_selSchedulingUser]
@user_id uniqueidentifier 
as

-- 5
-- role 
-- phone number 
-- email 
select 
u.user_id, 
isnull(su.email, u.email) as email, 
isnull(su.first_name, u.first_name) as first_name, 
isnull(su.last_name, u.last_name) as last_name, 
isnull(su.phone,'') as phone,
isnull(su.scheduling_enabled, 0) as scheduling_enabled
from 
veosolutionssecurity_users u with (nolock)
left join scheduling_users su with (nolock) on su.user_id = u.user_id 
--left join veosolutionssecurity.dbo.users_languages ul on ul.user_id = u.user_id 
where 
u.user_id = @user_id
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingUserAppointments]...';


GO

CREATE procedure [dbo].[vs_selSchedulingUserAppointments]
@user_id uniqueidentifier, 
@date datetime 			
as

-- vs_selSchedulingUserAppointments 'FD937A7F-FAA4-4FC1-B54B-4E867A6C23DD', '05/28/12' --'C87232BF-9313-413C-83F8-7F24B9E95E45', '05/23/12'
-- select * from scheduling_appointments
-- select * from veosolutionssecurity.dbo.users
-- select * from veosolutionssecurity.dbo.locations
-- C04B5E52-8D06-4BAB-B878-1EECA0BC8D23

select 
a.*, 
o.display_name as org_name
from 
	scheduling_appointments a with (nolock)
	left join scheduling_organizations o with (nolock) on o.account_org_id = a.account_org_id 
where
	a.schedule_user_id = @user_id 
	and a.appointment_date = @date
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingUserEligibleOrganizations]...';


GO
CREATE procedure [dbo].[vs_selSchedulingUserEligibleOrganizations]
@user_id uniqueidentifier
as
-- fetch account orgs associated with this user, but not already in the scheduling sub system 
-- vs_selSchedulingUserEligibleOrganizations 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'

select 
ao.account_org_id, 
o.name
from
veosolutionssecurity_account_organizations ao with (nolock)
join veosolutionssecurity_account_organization_users ou with (nolock) on ao.account_id = ou.account_id and ao.organization_id = ou.organization_id 
join veosolutionssecurity_organizations o with (nolock) on o.organization_id = ou.organization_id 
where 
ou.user_id = @user_id 
and ao.account_org_id not in (select account_org_id from scheduling_user_organizations with (nolock) where user_id = @user_id) 
order by 
o.name asc
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingUserImportList]...';


GO
CREATE PROCEDURE [dbo].[vs_selSchedulingUserImportList] 
@searching_user uniqueidentifier 
AS
BEGIN 
/* 
	Author: Robert Hobbs 
	Created: UNKNOWN (probably ~2013) 
	Description: fetch a user list, scoped by the searching user, to import into scheduling 
	
	Updated: 03/18/19 
	By: Robert Hobbs 
	Performance was terrible. Rewrote proc to be speedy. 

	-- testing 
	vs_selSchedulingUserImportList 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'
	
*/ 

CREATE TABLE #TEMP_USERS_IMPORT
(
	user_id uniqueidentifier, 
	name  varchar(200),
	email varchar(200),  
	role varchar(100), 
	orgs varchar(1000)
)

INSERT INTO #TEMP_USERS_IMPORT 
(user_id, name, email, role,  orgs) 
select 
distinct
u.user_id,
u.first_name + ' ' + u.last_name,
u.email, 
r.name, 
''
FROM 
veosolutionssecurity_users u  with (nolock)
JOIN [VeoSolutionsSecurity_account_organization_users_roles_legacy] ur with (nolock) on ur.user_id = u.user_id 
JOIN [VeoSolutionsSecurity_app_roles_legacy] ar with (nolock) on ar.role_id = ur.role_id 
JOIN VeoSolutionsSecurity_roles_legacy r on r.role_id = ur.role_id
JOIN scheduling_roles sr on sr.role_id = ur.role_id 
WHERE 
	u.active = 1
	AND u.user_id NOT IN (select user_id from scheduling_users with (nolock)) 
	AND u.first_name NOT IN ('SPEC', 'TEST') -- filter out some silly users 
	AND u.last_name NOT IN ('TEST') 

-- create an orgs list 
CREATE TABLE #TEMP_USER_ORG_NAMES  
( 
	[user_id] uniqueidentifier, 
	orgs varchar(1000) 
) 

INSERT INTO 
#TEMP_USER_ORG_NAMES 
(user_id, orgs) 
 SELECT
   t1.user_id,
   OrgsList = substring((SELECT ( ', ' + o.name )
                           FROM 
							#TEMP_USERS_IMPORT i
							JOIN VeosolutionsSecurity_account_organization_users t2 with (nolock) ON t2.user_id = i.user_id
							JOIN Veosolutionssecurity_organizations o with (nolock) on o.organization_id = t2.organization_id 
                           WHERE t1.user_id = t2.user_id
                           ORDER BY 
                              o.Name
                           FOR XML PATH( '' )
                          ), 3, 1000 ) FROM #TEMP_USERS_IMPORT t1
GROUP BY user_id 

update u 
set u.orgs = uo.orgs 
from #TEMP_USERS_IMPORT u 
JOIN #TEMP_USER_ORG_NAMES uo on uo.user_id = u.user_id 

select * from #TEMP_USERS_IMPORT order by name asc

DROP TABLE #TEMP_USERS_IMPORT 
DROP TABLE #TEMP_USER_ORG_NAMES

END
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingUserLanguages]...';


GO
CREATE procedure [dbo].[vs_selSchedulingUserLanguages]
@user_id uniqueidentifier
as
-- vs_selSchedulingUserLanguages '0e4c3d85-5acf-4d8c-af40-a5e33715ed8b'

select 
* 
from 
veosolutionssecurity_users_languages with (nolock)
where 
user_id = @user_id
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingUserLocations]...';


GO
CREATE procedure [dbo].[vs_selSchedulingUserLocations]
@user_id uniqueidentifier
as
-- testing
-- select * from  veosolutionssecurity.dbo.locations
-- vs_selSchedulingUserLocations
select
	sl.location_id,
	sl.name,
	sl.address,
	sl.location_type,
	sl.active,
	sl.enable_confirmation
from
	scheduling_user_locations l with (nolock)
	join veosolutionssecurity_locations sl with (nolock) on sl.location_id = l.location_id
where
	l.user_id = @user_id
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingUserOrganizations]...';


GO
CREATE procedure [dbo].[vs_selSchedulingUserOrganizations]
@user_id uniqueidentifier
as
-- select * from veosolutionssecurity.dbo.users where first_name = 'Robert' 
-- select * from  veosolutionssecurity.dbo.account_organizations
-- select * from scheduling_organizations
-- vs_selSchedulingUserOrganizations 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'
select 
suo.*, 
so.display_name, 
so.display_hours_start, 
so.display_hours_end, 
so.excluded_designers,
so.email_cc
from 
scheduling_user_organizations suo with (nolock)
join scheduling_organizations so with (nolock) on so.account_org_id = suo.account_org_id
where 
user_id = @user_id
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingUserPrefs]...';


GO

CREATE procedure [dbo].[vs_selSchedulingUserPrefs]
@user_id uniqueidentifier
as
select 
* 
from 
scheduling_user_preferences with (nolock)
where 
user_id = @user_id
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingUserRoles]...';


GO
CREATE procedure [dbo].[vs_selSchedulingUserRoles]
@user_id uniqueidentifier 
as

-- vs_selSchedulingUserRoles 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'

select 
sur.*, 
r.*
from 
scheduling_user_roles sur with (nolock)
join veosolutionssecurity_app_roles_legacy r with (nolock) on r.role_id = sur.role_id 
where
sur.user_id = @user_id
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingUsersByOrganization]...';


GO
CREATE procedure [dbo].[vs_selSchedulingUsersByOrganization]
@account_org_id uniqueidentifier
as
-- select * from scheduling_organizations
-- select * from scheduling_users 
-- [vs_selSchedulingUsersByOrganization] 'CC2A0C00-FD76-408C-AFCB-3C5134671848'
select 
	* 
from 
	scheduling_users u 
	join scheduling_user_organizations so on so.user_id = u.user_id 
where 
	so.account_org_id = @account_org_id 
order by 
	u.last_name asc
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingUserSettings]...';


GO
CREATE PROCEDURE [dbo].[vs_selSchedulingUserSettings]
@user_id uniqueidentifier
AS
BEGIN
	SELECT
		sus.*,
		ss.[setting_key],
		ss.[setting_description],
		ss.[data_type]
	FROM
		scheduling_user_settings sus WITH (NOLOCK)
	INNER JOIN
		scheduling_settings ss WITH (NOLOCK) ON ss.[id] = sus.[setting_id]
	WHERE
		sus.[user_id] = @user_id
END
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingUsersForOperator]...';


GO
CREATE procedure [dbo].[vs_selSchedulingUsersForOperator]
@operator_id uniqueidentifier,
@all_organizations bit = 0
as

--Summary:
-- show all designers defined in scheduling where
-- scheduling is enabled
-- they share an org with the operator


-- TESTING
-- select * from scheduling_users
-- select * from scheduling_user_roles
-- select * from veosolutionssecurity_roles
-- first, choose an operator
-- select * from veosolutionssecurity_users where first_name = 'Phil'

-- select * from scheduling_user_organizations
-- vs_selSchedulingUsersForOperator 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'
-- vs_selSchedulingUsersForOperator '0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B'
-- check to see if the current user is a "Design Center Administrator"

BEGIN
	-- FETCH A BUILDER FROM PREFERENCES
	declare @selected_account_org uniqueidentifier
	set @selected_account_org = '00000000-0000-0000-0000-000000000000'

	-- select * from scheduling_user_preferences
	if @all_organizations = 0 AND exists (select pref_value from scheduling_user_preferences where user_id = @operator_id and pref_key = 'selected_account_org')
	begin
		select @selected_account_org = convert(uniqueidentifier, pref_value)  from scheduling_user_preferences where user_id = @operator_id and pref_key = 'selected_account_org'
	end

	select distinct
		su.user_id,
		su.first_name + ' ' + su.last_name as name
	from
		scheduling_users su with (nolock)
		join scheduling_user_roles r with (nolock) on r.user_id = su.user_id
		join scheduling_user_organizations o with (nolock) on o.user_id = su.user_id
	where
		r.role_id in (select role_id from veosolutionssecurity_roles_legacy with (nolock) where name = 'Designer')
		and scheduling_enabled = 1
		AND
		(
			o.account_org_id = @selected_account_org
			OR
			(
				@selected_account_org = '00000000-0000-0000-0000-000000000000' AND o.account_org_id in (select account_org_id from  scheduling_user_organizations with (nolock) where user_id = @operator_id)
			)
		)
END
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingUsersWithOrganizationLocationLegacyRole]...';


GO
CREATE PROCEDURE vs_selSchedulingUsersWithOrganizationLocationLegacyRole
    @legacy_role_name VARCHAR(50) = NULL,
    @account_org_id UNIQUEIDENTIFIER = NULL,
    @location_id UNIQUEIDENTIFIER = NULL
AS
BEGIN
    SELECT su.*
    FROM scheduling_users su
    JOIN scheduling_user_roles sur ON sur.user_id = su.user_id
    JOIN VeoSolutionsSecurity_roles_legacy rl ON rl.role_id = sur.role_id
    JOIN scheduling_user_locations sul ON sul.user_id = su.user_id
    JOIN scheduling_user_organizations suo ON su.user_id = suo.user_id
    JOIN VeoSolutionsSecurity_account_organizations ao ON ao.account_org_id = suo.account_org_id
    WHERE su.scheduling_enabled = 1
        AND (LOWER(rl.name) = LOWER(@legacy_role_name) OR @legacy_role_name IS NULL)
        AND (suo.account_org_id = @account_org_id OR @account_org_id IS NULL)
        AND (sul.location_id = @location_id OR @location_id IS NULL);
END;
GO
PRINT N'Creating Procedure [dbo].[vs_selSchedulingUserWorkSchedules]...';


GO

CREATE procedure [dbo].[vs_selSchedulingUserWorkSchedules]
@user_id uniqueidentifier				
as
-- vs_selSchedulingUserWorkSchedules 'FBDBAC7D-C410-4C73-9C27-85EDD19F87B0'
-- select * from veosolutionssecurity.dbo.users
-- select * from veosolutionssecurity.dbo.locations
-- C04B5E52-8D06-4BAB-B878-1EECA0BC8D23

select * from 
scheduling_user_work_schedules w with (nolock)
join veosolutionssecurity_locations l with (nolock) on l.location_id = w.location_id 
where 
w.user_id = @user_id
GO
PRINT N'Creating Procedure [dbo].[vs_selSessionPricingMode]...';


GO

CREATE procedure [dbo].[vs_selSessionPricingMode]
@session_id uniqueidentifier
as
/*

vs_selSessionPricingMode 'c97a9ab2-ae8d-4d5a-be57-3a34a89aa71f'


modifed to use session instead of org 5/14/14 ADG

*/
select 
	--o.builder_markup_hb_pricing
	s.builder_markup_hb_pricing

from account_organization_user_profile_plan_catalog_sessions s with (nolock)
--left join VeoSolutionsSecurity_organizations o with (nolock) on o.organization_id = s.organization_id
where session_id = @session_id
GO
PRINT N'Creating Procedure [dbo].[vs_selSmsDefaultTemplates]...';


GO
CREATE PROCEDURE [dbo].[vs_selSmsDefaultTemplates]
	@template_key VARCHAR(50) = ''
AS
SELECT
	*
FROM
	[dbo].[sms_default_templates]
WHERE
	ISNULL(@template_key, '') = ''
	OR [template_key] = @template_key
GO
PRINT N'Creating Procedure [dbo].[vs_selSupportLink]...';


GO
CREATE procedure [dbo].[vs_selSupportLink]
@link_id varchar(500), 
@account_org varchar(36) = '', 
@role_id varchar(36)  = ''
as
-- '' == ALL 

-- select * from veosolutionssecurity.dbo.organizations
-- select * from veosolutionssecurity.dbo.account_organizations where organization_id = '577BFBA0-4089-4229-BAA1-EE84C85A4D1F'

-- CC2A0C00-FD76-408C-AFCB-3C5134671848 // contempo homes, dev 
-- vs_selSupportLink 'support.home' -- support.home for ALL org and ALL roles. 
-- support.home for ALL roles for specific org 
-- vs_selSupportLink 'support.home',  'CC2A0C00-FD76-408C-AFCB-3C5134671848',  null 
-- support.home for ALL orgs, for SALES COUNSELORS
-- vs_selSupportLink 'support.home', '', 'A675A67B-4648-43F4-814A-591884A64EC4' 

-- select * from support_links
-- 

-- TESTING 
-- match on link id, account and role 
-- match on link id, account only 
-- match on link id, role  only 
-- match on link id only 

-- EXACT MATCH 
declare @link_url varchar(500) 

select 
	@link_url = url 
from 
	support_links
where 
	link_id = @link_id
	and account_org = @account_org
	and role_id = @role_id

if (@link_url <> '') 
begin 
select @link_url as url 
return; 
end 


-- MATCH ON ACCOUNT ONLY 
select 
	@link_url = url 
from 
	support_links
where 
	link_id = @link_id
	and account_org = @account_org
	and role_id = ''

if (@link_url <> '') 
begin 
select @link_url as url 
return; 
end 


-- MATCH ON ROLE ONLY 
select 
	@link_url = url 
from 
	support_links
where 
	link_id = @link_id
	and account_org = ''
	and role_id = @role_id

if (@link_url <> '') 
begin 
select @link_url as url 
return; 
end 

-- MATCH ON LINK ID ONLY 
select 
	@link_url = url 
from 
	support_links
where 
	link_id = @link_id
	and account_org = ''
	and role_id = ''

if (@link_url <> '') 
begin 
select @link_url as url 
return; 
end 

select '' as url
GO
PRINT N'Creating Procedure [dbo].[vs_selVeoSolutionsSelectionSetDataExport]...';


GO
CREATE PROCEDURE [dbo].[vs_selVeoSolutionsSelectionSetDataExport]
@session_id_orig uniqueidentifier,
@xml xml = null out,
@set_export_date bit = 1
as

/*
	Modifier:    Saul Sanchez
	Date:        11/12/2018
	Description: Someone changed the proc in production, and I am simply updating it here to match what was in production.
*/

declare @session_id uniqueidentifier
set @session_id = null
set @session_id = @session_id_orig

/*
vs_selVeoSolutionsSelectionSetDataExport 'b802ca15-d02d-4ab4-903a-428cdcaccc66'
vs_selVeoSolutionsSelectionSetDataExport 'a9015eb8-3abf-4059-8dc4-062040cccb34'
address_id 197016

Modified:
	9/16/2015	Need to scrub xml_string converting '&' was causing XML to blow up.   ADG
	4/18/2016	removed distinct from image section for xml creation, caused major slow down. ADG
	2/14/2017   added area notes ADG
	12/19/2017	added design appointment date RW
*/

--get user info

declare @user_id varchar(75), @effective_date varchar(10), @designer varchar(100), @spec_id int, @job_type int, @appointment_date datetime

select
	@user_id = vsu.email,
	@designer = designer,
	@effective_date = convert(varchar(10), cs.create_date, 101),
	@spec_id = cs.spec_id,
	@job_type = pp.job_type
from account_organization_user_profile_plan_catalog_sessions cs with (nolock)
left join account_organization_user_profile_plan pp with (nolock) on
	pp.account_id = cs.account_id
	and pp.organization_id = cs.organization_id
	and pp.user_id = cs.user_id
	and pp.community_name = cs.community_name
	and pp.series = cs.series
	and pp.plan_name = cs.plan_name

left join vss_users vsu with (nolock) on vsu.user_id = cs.user_id
where cs.session_id = @session_id

select top 1
	@appointment_date = sa.appointment_date
from account_organization_user_profile_plan_catalog_sessions cs with (nolock)
left join account_organization_user_profile p with (nolock) on
	p.account_id = cs.account_id
	and p.organization_id = cs.organization_id
	and p.user_id = cs.user_id
left join scheduling_appointments sa on sa.buyer_profile_id = p.profile_id
where cs.session_id = @session_id
order by sa.appointment_date

set @appointment_date = ISNULL(@appointment_date, '1/1/1900')

--locate plan_id
declare @plan_id int

select top 1
	@plan_id = vpb.plan_id
from account_organization_user_profile_plan_catalog_sessions cs with (nolock)
left join catalog_selections_areas csa with (nolock)
	on csa.session_id = cs.session_id
left join veo_plan_builds vpb on vpb.build_id_num = csa.build_id
where cs.session_id = @session_id


declare @xml_document_name varchar(100), @xml_string varchar(max), @xml_image_string varchar(max)
set @xml_document_name = 'ConciergeSelectionSet'

set @xml_string = '<' + @xml_document_name +
	' user_plan_id="' + cast(@session_id as varchar(36)) +
	'" estimate_id="' + cast(@session_id as varchar(36)) +
	'" user_id ="' +  @user_id +
	'" plan_id ="' +  cast(@plan_id as varchar(10)) +
	'" spec_id ="' +  cast(@spec_id as varchar(5)) +
	'" effective_date = "' + @effective_date +
	'" designer="' + @designer +
	'" job_type = "'+ rtrim(str(@job_type)) +
	'" appointment_date = "'+ convert(varchar(10), @appointment_date, 101) +
	'" >'

--locate real elevation & plan from build info on catalog
declare @elevation varchar(50)
declare @plan_name varchar(50)




--removed elevation now comes from profile plan. 3/13/13 ADG
--select top 1 @elevation= rtrim(pm.elevation), @plan_name = rtrim(pm.plan_name)
--from catalog_selections_areas csa with (nolock)
--left join veo_plan_builds vpb with (nolock) on vpb.build_id = csa.build_id
--left join veo_plan_mstr pm with (nolock) on pm.plan_id = vpb.plan_id
--where session_id = @session_id

----print @plan_name
----print @elevation
----set @plan_name = '1234'
----set @elevation = 'a'

--if (@elevation is null)
--begin
--	raiserror('Import not available for this order. Please create quote manually. Session has no build id information.',16,1)	
--end


--find wbs community_id
declare @community_id int
select @community_id = dbo.getSessionWBSCommunityID(@session_id)


set @xml_string = @xml_string + (

select
	p.address as "@address",
	cast(p.lot as varchar(10)) + ' ' + p.block as "@lot_block",
	p.city as "@city",
	p.state as "@state",
	p.zip_code as "@zipcode",
	isnull(vss_o.external_organization_id,'') as "@builder_id",
	isnull(p.spec_id,0) as "@spec_id",

	cs.community_id AS "@community_id",
	--@community_id as "@community_id",	--changed to cs.community_id 4/5/2017 per Roger W. -ADG

	--isnull(p.series,'') as "@series",
	--dbo.getSessionWBSSeries(@session_id) as "@series",
	isnull(cs.series,'') as "@series", --changed to cs.series 4/5/2017 per Roger W. -ADG

	@plan_name as "@plan_name",
	--@elevation as "@elevation"
	p.elevation as "@elevation"
from
	account_organization_user_profile_plan_catalog_sessions cs with (nolock)
left join
	account_organization_user_profile_plan p with (nolock) on
		p.account_id = cs.account_id
		and p.organization_id = cs.organization_id
		and p.user_id = cs.user_id
		and p.community_name = cs.community_name
		and p.series = cs.series
		and p.plan_name = cs.plan_name
		
left join VeoSolutionsSecurity_organizations vss_o with (nolock) on vss_o.organization_id = p.organization_id
where
	cs.session_id = @session_id
	
for xml path('address'))


-- added contact info 10-31-12
set @xml_string = @xml_string + (

select
	u.first_name + ' ' + u.last_name as "@contact_name",
	p.home_phone as "@home_phone",
	p.work_phone as "@work_phone",
	u.email as "@email"
	
from
	account_organization_user_profile_plan_catalog_sessions cs with (nolock)
left join
	account_organization_user_profile_plan p with (nolock) on
		p.account_id = cs.account_id
		and p.organization_id = cs.organization_id
		and p.user_id = cs.user_id
		and p.community_name = cs.community_name
		and p.series = cs.series
		and p.plan_name = cs.plan_name
left join VeoSolutionsSecurity_users u with (nolock) on
	u.user_id = cs.user_id	
where
	cs.session_id = @session_id
for xml path('contact'))

--need temp table to properly "group" the xml create below

declare @area_groups table (session_id uniqueidentifier,
						   application_id varchar(50),
						   application varchar(50),
						   product_id varchar(50),
						   product varchar(50),
						   area_group_id varchar(50),
						   area_desc varchar(100),
						   area_id varchar(50),
						   area varchar(100),
						   sub_area_id varchar(50),
						   sub_area varchar(100),
						   location_id varchar(1),
						   build_id int,
						   notes varchar(max))

insert into @area_groups
select
	csa.session_id,
	va.application_id,
	csa.application,
	vp.product_id,
	csa.product,
	csa.area_id+'|'+csa.sub_area_id as area_group_id,
	csa.area as area_desc,
	csa.area_id,
	csa.area,
	csa.sub_area_id,
	csa.sub_area,
	'1' as location_id,
	csa.build_id,
	case
		when csa.notes <> '' and dbo.vdsf_getBomModificationNotes(@session_id,csa.build_id) <> '' then 	'Area Notes: '+csa.notes + ' Bom Mod Notes: '+ dbo.vdsf_getBomModificationNotes(@session_id,csa.build_id)
		when csa.notes <> '' then 'Area Notes: '+csa.notes
		when dbo.vdsf_getBomModificationNotes(@session_id,csa.build_id) <> '' then ' Bom Mod Notes: '+ dbo.vdsf_getBomModificationNotes(@session_id,csa.build_id)
		else ''
	end as notes
	
from catalog_selections_areas csa with (nolock)

left join veo_applications va with (nolock) on va.name = rtrim(csa.application)
left join veo_products vp with (nolock) on vp.name = rtrim(csa.product)
	
where csa.session_id = @session_id
and csa.area_selected = 1 --added 4/5/2017 per Roger W And Robert H (i.e. Srum daddy) -ADG

--select * from @area_groups

set @xml_string = @xml_string + (  	
select
	area_group.application_id,
	area_group.product_id,
	area_group.area_group_id,
	area_group.area as area_desc,
	area_group.area_id,
	area_group.sub_area_id,
	area_group.location_id,
	area_group.build_id,
	area_group.notes as area_notes,
	item.item_type,
	item.item_id,
	item.real_item_id as item_number,
	item.uom_id,

	case
		when item.price_type = 'area' then 1
		else item.bill_qty
	end as bill_qty,
	--item.bill_qty,

	item.builder_price,
	item.homeowner_price,
	case
		when item.alloc_qty > 0 then item.alloc_qty
		else item.bill_qty
	end as alloc_qty,
	item.pattern_id,
	pp.pattern_name,
	'' as notes,
	item.credit_qty,
	accent_prompt,
	options.option_id,
	options.option_value,
	options.option_source,
	options.included,
	options.qty,
	options.alloc_qty,
	options.price,
	options.price_retail,
	options.retail_percentage,
	options.retail_percentage_type,
	options.price_type,
	options.pricing_source
	
from @area_groups area_group

left join catalog_selections_area_details item with (nolock) on
	item.session_id = area_group.session_id
	and rtrim(item.application) = rtrim(area_group.application)
	and rtrim(item.product) = rtrim(area_group.product)
	and rtrim(item.area) = rtrim(area_group.area)
	and rtrim(item.sub_area) = rtrim(area_group.sub_area)

left join Veo_product_patterns pp with (nolock) on pp.pattern_id = item.pattern_id

--added 12/24/2014 -ADG
left join catalog_selections_area_detail_options options with (nolock) on
	options.session_id = item.session_id
	and rtrim(options.application) = rtrim(item.application)
	and rtrim(options.product) = rtrim(item.product)
	and rtrim(options.area) = rtrim(item.area)
	and rtrim(options.sub_area) = rtrim(item.sub_area)
	and rtrim(options.item_type) = rtrim(item.item_type)
	and rtrim(options.item_id) = rtrim(item.item_id)

where item.session_id is not null and item.item_id not in ('promo_credit','override_credit','incorrect_price_credit','credit','sold_at_contract_credit')
order by
	area_group.application_id, area_group.product_id, area_group.area_group_id, item.item_type desc, item.item_id
	
for xml auto )


PRINT 'before'
--========
-- Images
--========
set @xml_image_string = (
select
	--distinct
	document_type,
	application_id,
	product_id,
	area_id,
	sub_area_id,
	location_id,
	document_data
from
	account_organization_user_profile_plan_catalog_sessions_documents images with (nolock)
where
	images.session_id = @session_id
order by
	images.application_id, images.product_id, images.document_type
for xml auto, BINARY BASE64 )

set @xml_string = @xml_string + isnull(@xml_image_string, '') + '</' + @xml_document_name + '>'


-- added 9/16/2015 adg
set @xml_string = REPLACE(@xml_string,'&','&amp;')


set @xml = convert(xml, @xml_string)


select @xml as [xml]

--==================================
-- Mark the profile plan session export date
--==================================
if @set_export_date = 1
begin
	update account_organization_user_profile_plan_catalog_sessions
	set export_date = getdate()
	from
		account_organization_user_profile_plan_catalog_sessions cs with (nolock)
	left join
		account_organization_user_profile_plan p with (nolock) on
			p.account_id = cs.account_id
			and p.organization_id = cs.organization_id
			and p.user_id = cs.user_id
			and p.community_name = cs.community_name
			and p.series = cs.series
			and p.plan_name = cs.plan_name
	where
		cs.session_id = @session_id
end
GO
PRINT N'Creating Procedure [dbo].[vs_SessionStatusReport]...';


GO
CREATE procedure vs_SessionStatusReport 
@start_date datetime,
@end_date datetime
--@statuses varchar(50)
as
/*

vs_SessionStatusReport '9/1/2013','9/16/2013'
--,'Active,Complete'

*/
select 
	
	o.name as organization,
	s.community_name,
	s.series,
	s.plan_name,
	ss.status as session_status,
	p.status as profile_status,
	s.create_date,
	s.modified_date,
	u.email,
	u.first_name,
	u.last_name,
	p.job_no,
	p.address,
	p.lot,
	p.block,
	s.designer,
	p.sales_counselor
	--s.*
from account_organization_user_profile_plan_catalog_sessions s with (nolock)
left join account_organization_user_profile_plan p with (nolock) on 
	p.account_id = s.account_id 
	and p.organization_id = s.organization_id
	and p.user_id = s.user_id
	and p.community_name = s.community_name
	and p.series = s.series
	and p.plan_name = s.plan_name
left join session_statuses ss with (nolock) on
	ss.status_id = s.status
left join veosolutionssecurity_organizations o with (nolock) on
	o.organization_id = s.organization_id
left join veosolutionssecurity_users u with (nolock) on
	u.user_id= s.user_id

where 
	p.status is not null
	and s.create_date >= @start_date
	and s.create_date <= @end_date
	--and (@statuses = '' or ss.status in (select value from dbo.of_split(@statuses,',')))
order by s.create_date, s.status asc
GO
PRINT N'Creating Procedure [dbo].[vs_setupErrors]...';


GO
create PROCEDURE [dbo].[vs_setupErrors] 
AS

-- SCHEDULING MESSAGES 50100-50300
--  0 VALID 
-- -1 appointment changed since update (timestamp) 
-- -10 eclipse 
-- -20 end overlap 
-- -30 start overlap
-- -100 designer schedule is invalid now 
-- -110 designer no longer active 
-- -120 designer no longer has account org 
 
EXEC master.dbo.sp_addmessage @msgnum =50101,@severity =10,@msgtext ='Appointment changed by another user.'

EXEC master.dbo.sp_addmessage @msgnum =50110,@severity =10,@msgtext ='Appointment would eclipse another.'

EXEC master.dbo.sp_addmessage @msgnum =50120,@severity =10,@msgtext ='Appointment end overlaps another'

EXEC master.dbo.sp_addmessage @msgnum =50130,@severity =10,@msgtext ='Appointment start overlaps another'

EXEC master.dbo.sp_addmessage @msgnum =50200,@severity =10,@msgtext ='Designer schedule is invalid for this appointment'

EXEC master.dbo.sp_addmessage @msgnum =50210,@severity =10,@msgtext ='Designer is not active'

EXEC master.dbo.sp_addmessage @msgnum =50220,@severity =10,@msgtext ='Designer is not associated with the Organization'
GO
PRINT N'Creating Procedure [dbo].[vs_updAccountOrganizationDocument]...';


GO

CREATE procedure [dbo].[vs_updAccountOrganizationDocument]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@doc_id uniqueidentifier,
@application varchar(100),
@product varchar(100),
@description varchar(255),
@notes varchar(255),
@size int,
@doc_data varbinary(MAX) = NULL,
@type varchar(10),
@url varchar(MAX),
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)


update account_organization_documents

set 
	application = @application,
	product = @product,
	description = @description,
	notes = @notes,
	size = @size,
	doc_data = coalesce(@doc_data, doc_data),
	type = @type,
	url = @url,
	modifier = @active_user_id,
	modified_date = GETDATE()
where
	account_id = @account_id 
	and	organization_id = @organization_id 
	and doc_id = @doc_id
GO
PRINT N'Creating Procedure [dbo].[vs_updAccountOrganizationUserWishListItem]...';


GO
CREATE procedure [dbo].[vs_updAccountOrganizationUserWishListItem]
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@user_id uniqueidentifier,
@wishlist_item_id uniqueidentifier,
@item_type varchar(50),
@item_no varchar(81),
@description varchar(100)='',
@image_data varbinary(max) = 0,
@notes varchar(max) = '',
@gpc_id varchar(50),
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

update account_organization_user_wishlist_items
set item_type = @item_type,
	item_no = @item_no,
	description = @description,
	image_data = @image_data,
	notes = @notes,
	gpc_id = @gpc_id,
	modifier = @active_user_id,
	modified_date = GETDATE()
where
	account_id = @account_id and
	organization_id = @organization_id and
	user_id = @user_id and
	wishlist_item_id = @wishlist_item_id
GO
PRINT N'Creating Procedure [dbo].[vs_UpdateCatalogSelectionsAreas]...';


GO

CREATE procedure [dbo].[vs_UpdateCatalogSelectionsAreas]
@session_id uniqueidentifier,
@builds varchar(max),
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

/*

vs_UpdateCatalogSelectionsAreas '322a7f21-dbe4-4889-b5db-a62bf09aa06f','9484328,9484329,9484332,9484335,9484336'

*/


-- create builds table
declare @build_table table ( build_id int null)  
insert into @build_table
select  
  value
from  
 dbo.of_split(@builds, ',')  

--select * from @build_table

-- unselect all
update 
	catalog_selections_areas 
set 
	area_selected = 0,
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	session_id = @session_id

-- update only passed in build ids.
update 
	catalog_selections_areas 
set 
	area_selected = 1,
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	session_id = @session_id 
	and str(build_id) in 
		(select build_id from @build_table)
GO
PRINT N'Creating Procedure [dbo].[vs_UpdateSessionAddressID]...';


GO
create procedure vs_UpdateSessionAddressID
@session_id uniqueidentifier,
@address_id int
as

update account_organization_user_profile_plan_catalog_sessions
set address_id = @address_id
where session_id = @session_id
GO
PRINT N'Creating Procedure [dbo].[vs_updCatalogItem]...';


GO

CREATE procedure [dbo].[vs_updCatalogItem]
@row_id uniqueidentifier,
@account_id uniqueidentifier,
@organization_id uniqueidentifier,
@community varchar(100) = '',
@series varchar(100) = '',
@plan varchar(100) = '',
@elevation varchar(100)= '',
@application varchar(100) = '',
@product varchar(100) = '',
@area varchar(100) = '',
@sub_area varchar(100) = '',
@item_no varchar(100) = '',
@item varchar(max) = '',
@vendor varchar(100) = '',
@standard varchar(200) = '',
@qty decimal(18,4) = 1,
@cost decimal(18,2) = 0,
@price decimal(18,2) = 0,
@selected bit = 0,
@notes varchar(max) = '',
@mutually_exclusive bit,
@option_pricing_display bit,
@email varchar(100) = '',
@gpc varchar(max) = '', 
@model varchar(100) = '', 
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

update catalog_items
	set

	[account_id] = @account_id
	,[organization_id] = @organization_id
	,[community] = @community
	,[series]= @series
	,[plan] = @plan
	,[elevation]= @elevation
	,[application] = @application
	,[product] = @product
	,[area] = @area
	,[sub_area] = @sub_area
	,[item_no] = @item_no
	,[item] = @item
	,[vendor] = @vendor
	,[standard] = @standard
	,[qty] = @qty
	,[cost]=@cost
	,[price] = @price
	,[selected] = @selected
	,[notes] = @notes
	,[mutually_exclusive] = @mutually_exclusive
	,[option_pricing_display] = @option_pricing_display
	,[gpc] = @gpc
	,[model] = @model 
	,[modifier] = @active_user_id
	,[modified_date] = getdate()

where row_id = @row_id
GO
PRINT N'Creating Procedure [dbo].[vs_updCatalogSelection]...';


GO

CREATE procedure [dbo].[vs_updCatalogSelection]
@session_id uniqueidentifier, 
@row_id uniqueidentifier, 
--@account_id uniqueidentifier, 
--@organization_id uniqueidentifier, 
--@community varchar(100) = '',
--@series varchar(100) = '', 
--@plan varchar(100) = '', 
@application varchar(100)= '',
@product varchar(100) = '',
@area varchar(100) = '',
@area_id varchar(100) = '',
@sub_area varchar(100) = '',
@sub_area_id varchar(100) = '',
@item_type varchar(100)='',
@item_no varchar(100) = '', 
@item varchar(max) = '', 
@vendor varchar(100) = '',
@standard varchar(200) = '',
@qty decimal(18,4), 
@cost decimal(18,2), 
@price decimal(18,2), 
@selected bit,
@notes varchar(max),
@source varchar(20),
@build_data varbinary(max) = null,
@gpc varchar(max) = '', 
@model varchar(100) = '', 
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)


--locate acc,org,user

declare @account_id uniqueidentifier
declare @organization_id uniqueidentifier
declare @user_id uniqueidentifier
declare @community varchar(50)
declare @series varchar(50)
declare @plan varchar(50)

select 
 @account_id = p.account_id,
 @organization_id = p.organization_id,
 @user_id = p.user_id,
 @community = s.community_name,
 @series = s.series,
 @plan = s.plan_name

from account_organization_user_profile_plan_catalog_sessions s with (nolock)
left join account_organization_user_profile_plan p with (nolock) on 
	p.account_id = s.account_Id
	and p.organization_id = s.organization_id
	and p.user_id = s.user_id
where s.session_id = @session_id



if (@row_id is null) 
	begin
		INSERT INTO [catalog_selections]
			([session_id]
			,[row_id]
			,[account_id]
			,[organization_id]
			,[community]
			,[series]
			,[plan]
			,[application]
			,[product]
			,[area]
			,[area_id]
			,[sub_area]
			,[sub_area_id]
			,[item_type]
			,[item_no]
			,[item]
			,[vendor]
			,[standard]
			,[qty]
			,[cost]
			,[price]
			,[selected]
			,[notes]
			,[source]
			,[gpc]
			,[model]
			,author
			,create_date
			,modifier
			,modified_date)
		VALUES (
      @session_id,
      @row_id,
      @account_id, 
      @organization_id,
      @community,
      @series,
      @plan,
      @application,
      @product,
      @area,
	  @area_id,
      @sub_area,
	  @sub_area_id,
	  @item_type,
      @item_no,
      @item,
      @vendor,
      @standard,
      @qty,
	  @cost,
      @price,
      @selected,
      @notes,
      @source,
	  @gpc, 
	  @model, 
      @active_user_id,
      GETDATE(),
      @active_user_id,
      GETDATE() )
	end
else
	begin
		UPDATE
			[catalog_selections]
		SET

			[qty] = @qty,
			[cost]=@cost,
			[price] = @price,
			[item_type]=@item_type,
			[item] = @item,
			[item_no] = @item_no,
			[application] = @application,
			[product] = @product,
			[selected] = @selected,
			[notes] = @notes, 
			[area] = @area,
			[area_id] = @area_id,
			[sub_area] = @sub_area,
			[sub_area_id] = @sub_area_id,
			[vendor] = @vendor,
			[standard] = @standard,
			[build_data] = @build_data,
			[gpc] = @gpc, 
			[model] = @model, 
			modifier = @active_user_id,
			modified_date = GETDATE()
		WHERE
			[session_id] = @session_id
			and [row_id] = @row_id
	end
GO
PRINT N'Creating Procedure [dbo].[vs_updCatalogSelectionArea]...';


GO


CREATE procedure [dbo].[vs_updCatalogSelectionArea]
@session_id uniqueidentifier,
@application varchar(100),
@product varchar(100), 
@area varchar(100) = '',
@area_id varchar(25) = '',
@sub_area varchar(100) = '',
@sub_area_id varchar(25) = '',
@selected int,
@notes varchar(max),
--@original_build_data varbinary(max),
@selection_total decimal(18,2),
@selected_field_group uniqueidentifier,
@pattern_id int = 0,
@area_selected bit = 0,
@build_id int = 0,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)



if (exists(select session_id from catalog_selections_areas 
			WHERE
				[session_id] = @session_id
				and [application] = @application
				and [product] = @product
				and [area] = @area
				and [sub_area] = @sub_area))
begin				

	UPDATE
		[catalog_selections_areas]
	SET

		[selected] = @selected,
		[notes] = @notes, 
		[selection_total] = @selection_total,
		[selected_field_group] = @selected_field_group,
		[area_id] = @area_id,
		[sub_area_id] = @sub_area_id,
		[pattern_id] = @pattern_id,
		[area_selected] = @area_selected,
		[build_id] = @build_id,
		modifier = @active_user_id,
		modified_date = GETDATE()
	WHERE
		[session_id] = @session_id
		and [application] = @application
		and [product] = @product
		and [area] = @area
		and [sub_area] = @sub_area
end
else

begin

	INSERT INTO [catalog_selections_areas]
	(
		[session_id],
		[application],
		[product],
		[area],
		[area_id],
		[sub_area],
		[sub_area_id],
		[selected],
		[notes],
		--[original_build_data],
		[selection_total],
		[selected_field_group],
		[pattern_id],
		[area_selected],
		[build_id],
		author,
		create_date,
		modifier,
		modified_date
	)
	VALUES 
	(
		@session_id,
		@application,
		@product,
		@area,
		@area_id,
		@sub_area,
		@sub_area_id,
		@selected,
		@notes,
		--@original_build_data,
		@selection_total,
		@selected_field_group,
		@pattern_id,
		@area_selected,
		@build_id,
		@active_user_id,
		GETDATE(),
		@active_user_id,
		GETDATE()
	)
end
GO
PRINT N'Creating Procedure [dbo].[vs_updCatalogSelectionAreaDetail]...';


GO


CREATE procedure [dbo].[vs_updCatalogSelectionAreaDetail]
@session_id uniqueidentifier,
@application varchar(100),
@product varchar(100), 
@area varchar(100) ,
@sub_area varchar(100),
@item_type varchar(20),
@bom_item_id varchar(50) = '',
@item_id varchar(50),
@selectable bit,
@bom_real_item_id varchar(50)='',
@real_item_id varchar(50),
@bom_bill_qty decimal(18,2)=0,
@bill_qty decimal(18,2),
@alloc_qty decimal(18,2),
@credit_qty decimal(18,2),
@bom_uom_id varchar(9),
@uom_id varchar(9),
@builder_price decimal(18,2),
@homeowner_price decimal(18,2),
@pattern_id int,
@is_pattern_item bit,
@pattern_percentage decimal(18,4),
@force_reprice bit,
@price_type varchar(25)='',
@price_source varchar(25) = '',
@retail_percentage decimal(18,4)= 1,
@retail_percentage_type varchar(10)='None',
@accent_prompt varchar(20) = '',
@priced bit = 0,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)



if (exists(select session_id from catalog_selections_area_details
			WHERE
				[session_id] = @session_id
				and [application] = @application
				and [product] = @product
				and [area] = @area
				and [sub_area] = @sub_area
				and [item_type] = @item_type
				and [item_id] = @item_id
				)
	)
begin				

	UPDATE
		[catalog_selections_area_details]
	SET
		[bom_item_id] = @bom_item_id,
		[selectable] = @selectable,
		[bom_real_item_id] = @bom_real_item_id,
		[real_item_id] = @real_item_id,
		[bom_bill_qty] = @bom_bill_qty,
		[bill_qty] = @bill_qty,
		[alloc_qty] = @alloc_qty ,
		[credit_qty] = @credit_qty,
		[bom_uom_id] = @bom_uom_id,
		[uom_id] = @uom_id,
		[builder_price] = @builder_price,
		[homeowner_price] = @homeowner_price,
		[pattern_id] = @pattern_id ,
		[is_pattern_item]=@is_pattern_item ,
		[pattern_percentage] = @pattern_percentage,
		[force_reprice] = @force_reprice,
		[price_type] = @price_type,
		[price_source] = @price_source,
		[retail_percentage] = @retail_percentage,
		[retail_percentage_type] = @retail_percentage_type,
		[accent_prompt] = @accent_prompt,
		[priced] = @priced,
		modifier = @active_user_id,
		modified_date = GETDATE()		
	WHERE
		[session_id] = @session_id
		and [application] = @application
		and [product] = @product
		and [area] = @area
		and [sub_area] = @sub_area
		and [item_type] = @item_type
		and [item_id] = @item_id
end
else

begin

	INSERT INTO [catalog_selections_area_details]
	(
		[session_id],
		[application],
		[product],
		[area],
		[sub_area],
		[item_type],
		[bom_item_id],
		[item_id],
		[selectable],
		[bom_real_item_id],
		[real_item_id],
		[bom_bill_qty],
		[bill_qty],
		[alloc_qty],
		[credit_qty],
		[bom_uom_id],
		[uom_id],
		[builder_price],
		[homeowner_price],
		[pattern_id],
		[is_pattern_item],
		[pattern_percentage],
		[force_reprice]	,
		[price_type],
		[price_source],
		[retail_percentage],
		[retail_percentage_type],
		[accent_prompt],
		[priced],
		author,
		create_date,
		modifier,
		modified_date
	)
	VALUES 
	(
		@session_id,
		@application,
		@product,
		@area,
		@sub_area,
		@item_type,
		@bom_item_id,
		@item_id,
		@selectable,
		@bom_real_item_id,
		@real_item_id,
		@bom_bill_qty,
		@bill_qty,
		@alloc_qty,
		@credit_qty,
		@bom_uom_id,
		@uom_id,
		@builder_price,
		@homeowner_price,
		@pattern_id,
		@is_pattern_item,
		@pattern_percentage,
		@force_reprice,
		@price_type,
		@price_source,
		@retail_percentage,
		@retail_percentage_type,
		@accent_prompt,
		@priced,
		@active_user_id,
		GETDATE(),
		@active_user_id,
		GETDATE()
	)
end
GO
PRINT N'Creating Procedure [dbo].[vs_updCatalogSelectionsErrorLog]...';


GO
CREATE procedure [dbo].[vs_updCatalogSelectionsErrorLog]
@session_id uniqueidentifier,
@auto_number int,
@review_date datetime,
@security_token uniqueidentifier
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)	

if @active_user_id is null
begin
	raiserror('Insufficient rights to execute query.',16,1)
	return
end

update catalog_selections_error_log 
set review_date = @review_date
where 
	session_id = @session_id
	and auto_number = @auto_number
GO
PRINT N'Creating Procedure [dbo].[vs_updCatalogSession]...';


GO

CREATE procedure [dbo].[vs_updCatalogSession]
@session_id uniqueidentifier,
@status int,
@session_notes varchar(255),
@deposit decimal(18,2),
@deposit_notes varchar(255),
@designer varchar(50)= '',
@spec_id int = 0,
@completed_date datetime = null,
@effective_date datetime = null,
@community_id int = 0,
@rounding_type int = 0,
@rounding_places int = 2,
@builder_markup_hb_pricing bit = 0,
@pricing_generated datetime = null,
@pricing_published datetime = null,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

if (@effective_date is null)
	set @effective_date = '1/1/1980'


if @status = 1 -- 1 = active
begin
  declare @account_id uniqueidentifier
  declare @organization_id uniqueidentifier
  declare @user_id uniqueidentifier
  declare @community_name varchar(50)
  declare @series varchar(50)
  declare @plan_name varchar(50)
  select
		@account_id = account_id,
		@organization_id = organization_id,
		@user_id = user_id,
		@community_name = community_name,
		@series = series,
		@plan_name = plan_name
	from
		account_organization_user_profile_plan_catalog_sessions
	where
		session_id = @session_id
  
	declare @active_count int
	select 
		@active_count = COUNT(status) from account_organization_user_profile_plan_catalog_sessions
	where
		account_id = @account_id
		and organization_id = @organization_id
		and user_id = @user_id
		and community_name = @community_name
		and series = @series
		and plan_name = @plan_name
		and session_id <> @session_id
		and [status] = 1
	
	if @active_count > 0
	begin
		Raiserror('A session is already active',16,1)
		return
	end
end	

update account_organization_user_profile_plan_catalog_sessions
set status = @status,
	session_notes = @session_notes,
	deposit = @deposit,
	deposit_notes = @deposit_notes,
	designer = @designer,
	spec_id = @spec_id,
	effective_date = @effective_date,
	completed_date = coalesce(@completed_date, completed_date),
	community_id = @community_id,
	rounding_type = @rounding_type,
	rounding_places = @rounding_places,
	builder_markup_hb_pricing = @builder_markup_hb_pricing,
	pricing_generated = @pricing_generated,
	pricing_published = @pricing_published,
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	session_id = @session_id
	
if (@status = 1)
begin
	update account_organization_user_profile_plan
    set 
		additional_design_deposit = @deposit,
		deposit_notes = @deposit_notes,
		modifier = @active_user_id,
		modified_date = GETDATE()
    where 
		catalog_session_id = @session_id
end	

--remove export date if not complete state
if (@status <> 2)
begin
	update account_organization_user_profile_plan_catalog_sessions
    set 
		export_date = '1/1/1900',
		modifier = @active_user_id,
		modified_date = GETDATE()
    where 
		session_id = @session_id
end
GO
PRINT N'Creating Procedure [dbo].[vs_updSchedulingAppointmentActualTime]...';


GO
CREATE procedure [dbo].[vs_updSchedulingAppointmentActualTime]
@appointment_id uniqueidentifier, 
@start_actual time(7) = null, 
@end_actual time(7) = null, 
@security_token uniqueidentifier = NULL
as
/* SUMMARY 

We expect the start or end to be passed, not both. 

*/

-- testing 
-- select * from scheduling_appointments where is_scheduled = 1
-- update start time 
-- vs_updSchedulingAppointmentActualTime '7C84577A-0E94-49B6-AE3D-10D51BD94726', '8:00:00'
-- delete from scheduling_messages where appointment_id = '7C84577A-0E94-49B6-AE3D-10D51BD94726'
-- select * from scheduling_messages where appointment_id = '7C84577A-0E94-49B6-AE3D-10D51BD94726'
-- check messages 



declare @operator_email varchar(100)
set @operator_email = dbo.ef_getUserEmailFromSecurityToken(@security_token)

declare @operator_id uniqueidentifier 
set @operator_id = null 
select  @operator_id = [user_id] from VeoSolutionsSecurity_users_login_sessions where security_token = @security_token

declare @action varchar(20) 
declare @time time(7) 

if (@start_actual is not null) 
begin 

update scheduling_appointments 
set
start_time_actual = @start_actual ,
modifier = @operator_email,
modified_date = getdate()
where 
appointment_id = @appointment_id 

set @action = 'check-in'
set @time = @start_actual 

end 
else 
begin
 
update scheduling_appointments 
set
end_time_actual = @end_actual , 
modifier = @operator_email,
modified_date = getdate()
where 
appointment_id = @appointment_id 

set @action = 'check-out'
set @time = @end_actual 

end 



-- update buyer history 
if (@action <> '') 
begin 	

	declare @appointment_date datetime 
	declare @message varchar(100)
	declare @appt_abbrev varchar(20) 
	declare @buyer_id uniqueidentifier

	-- select top 10 * from scheduling_appointments 
	select 
		@appointment_date = a.appointment_date,
	    @buyer_id = a.buyer_profile_id, 
		@appt_abbrev = st.abbrev 
	from 
		scheduling_appointments a 
		join scheduling_appointment_types st on st.appointment_type = a.appointment_type 
	where 
		a.appointment_id = @appointment_id 

		-- BUILD MESSAGE  
		set @message = 'Buyer ' + @action + ' for ' + @appt_abbrev + ' appt at ' + convert(varchar, @time, 0) 

	-- select * from scheduling_messages order by create_date desc
	-- select * from scheduling_message_types
	insert into 
	scheduling_messages
	(message_id, message_type, message_status, is_read, message_title, message_priority, [user_id], buyer_profile_id, appointment_id, sender_id, message_body, completion_date) 
	values
	(newid(), 10, 0, 0, @action, 0, @operator_id, @buyer_id, @appointment_id, @operator_Id, @message, getdate())
	
	
end
GO
PRINT N'Creating Procedure [dbo].[vs_updSchedulingBuyerActive]...';


GO
CREATE procedure [dbo].[vs_updSchedulingBuyerActive]
@profile_id uniqueidentifier,
@is_active int , 
@security_token uniqueidentifier 
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

update 
	scheduling_buyers 
set 
	is_active = @is_active , 
	modifier = @active_user_id, 
	modified_date = getdate() 
where 
	profile_id = @profile_id
GO
PRINT N'Creating Procedure [dbo].[vs_updSchedulingBuyerActiveBasedOnAppointments]...';


GO
create procedure [dbo].[vs_updSchedulingBuyerActiveBasedOnAppointments]
@profile_id uniqueidentifier, 
@security_token uniqueidentifier 
as

-- TESTING 
-- select * from scheduling_appointments where buyer_profile_id ='090BEDD2-455D-4D41-B98D-F380531E617A'
-- [vs_updSchedulingBuyerActiveBasedOnAppointments] '090BEDD2-455D-4D41-B98D-F380531E617A', null
-- select * from scheduling_buyers where profile_id ='090BEDD2-455D-4D41-B98D-F380531E617A'

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

declare @is_active int 
set @is_active = -1

declare @has_appointments bit 

if not exists (select buyer_profile_id from scheduling_appointments where buyer_profile_id = @profile_id) 
	set @is_active = 1 

-- BUYER HAS APPOINTMENTS 
if (@is_active = -1) 
begin 

-- FULLY SCHEDULED? 
if exists (select buyer_profile_id from scheduling_appointments where buyer_profile_id = @profile_id and is_scheduled = 0) 
	set @is_active = 1
else
	set @is_active = 0 
end 

-- error case? 
if (@is_active = -1) 
	set @is_active = 1 


update 
	scheduling_buyers 
set 
	is_active = @is_active , 
	modifier = @active_user_id, 
	modified_date = getdate() 
where 
	profile_id = @profile_id 
	and is_active <> @is_active -- only update if needed 
GO
PRINT N'Creating Procedure [dbo].[vs_updSchedulingBuyerReceivedDate]...';


GO
CREATE procedure [dbo].[vs_updSchedulingBuyerReceivedDate]
@profile_id uniqueidentifier,
@received_date datetime , 
@security_token uniqueidentifier 
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)
if (@active_user_id is null)
	begin
		raiserror('Invalid credentials.',16,1)
		return
	end

update 
	scheduling_buyers 
set 
	received_date = @received_date, 
	modifier = @active_user_id, 
	modified_date = getdate() 
where 
	profile_id = @profile_id
GO
PRINT N'Creating Procedure [dbo].[vs_updSchedulingMessage]...';


GO
CREATE procedure [dbo].[vs_updSchedulingMessage]
@message_id uniqueidentifier = null, 
@message_type	int = 0, 
@message_status	int = 0, 
@is_read bit = 0, 
@message_title	varchar(100) = '', 
@message_priority	int	= 0, 
@user_id	uniqueidentifier = null, 
@buyer_profile_id uniqueidentifier = null, 
@appointment_id	uniqueidentifier = null, 
@sender_id	uniqueidentifier = null, 
@message_body	varchar(1000) = '', 
@completion_date	datetime = null , 
@dismissed bit = 0,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)


-- testing 
-- select * from scheduling_messages 
-- update 
if exists(select message_id from scheduling_messages where message_id = @message_id) 
begin 

update 
	scheduling_messages
set 
	message_type = @message_type, 
	message_status = @message_status,
	is_read = @is_read,  
	message_title = @message_title,
	message_priority = @message_priority,  
	user_id= @user_id, 
	buyer_profile_id = @buyer_profile_id, 
	appointment_id= @appointment_id	, 
	sender_id= @sender_id	, 
	message_body = @message_body, 
	completion_date= @completion_date, 
	dismissed = @dismissed,
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	message_id = @message_id 

return; 

end 

-- insert 
insert into scheduling_messages
(
	message_id, 
	message_type, 
	message_status, 
	is_read,
	message_title, 
	message_priority, 
	user_id, 
	buyer_profile_id, 
	appointment_id, 
	sender_id, 
	message_body, 
	completion_date, 
	dismissed,
	author,
	create_date,
	modifier,
	modified_date
) 
values 
( 
	@message_id, 
	@message_type, 
	@message_status	, 
	@is_read,
	@message_title, 
	@message_priority	, 
	@user_id	, 
	@buyer_profile_id, 
	@appointment_id, 
	@sender_id,
	@message_body	, 
	@completion_date, 
	@dismissed,
	@active_user_id,
	GETDATE(),
	@active_user_id,
	GETDATE()
)
GO
PRINT N'Creating Procedure [dbo].[vs_updSchedulingOrgDisplayHours]...';


GO
CREATE procedure [dbo].[vs_updSchedulingOrgDisplayHours] 
@account_org_id uniqueidentifier, 
@start datetime = null, 
@end datetime = null , 
@security_token uniqueidentifier 
as


-- select * from scheduling_organizations
update 
scheduling_organizations 
set 
	display_hours_start = @start, 
	display_hours_end = @end 
where
	account_org_id = @account_org_id
GO
PRINT N'Creating Procedure [dbo].[vs_updSchedulingOrgExcludedDesigners]...';


GO

create procedure vs_updSchedulingOrgExcludedDesigners
@account_org_id uniqueidentifier, 
@excluded_designers varchar(500) = '' , 
@security_token uniqueidentifier 
as

-- select * from scheduling_organizations 
update 
	scheduling_organizations
set
	excluded_designers = @excluded_designers 
where
	account_org_id = @account_org_id
GO
PRINT N'Creating Procedure [dbo].[vs_updSchedulingSmsOptIn]...';


GO
CREATE PROCEDURE [dbo].[vs_updSchedulingSmsOptIn]
	@id UNIQUEIDENTIFIER,
	@phone_number VARCHAR(25),
	@invite_message NVARCHAR(MAX),
	@invite_date DATETIME2(7),
	@is_pending_confirmation BIT,
	@is_opted_in BIT,
	@confirm_date DATETIME2(7) = NULL,
	@reply_message NVARCHAR(50) = ''
AS

UPDATE
	[dbo].[scheduling_sms_opt_in]
SET
	[phone_number] = @phone_number,
	[invite_message] = @invite_message,
	[invite_date] = @invite_date,
	[is_pending_confirmation] = @is_pending_confirmation,
	[is_opted_in] = @is_opted_in,
	[confirm_date] = @confirm_date,
	[reply_message] = @reply_message
WHERE
	[id] = @id
GO
PRINT N'Creating Procedure [dbo].[vs_updSchedulingUser]...';


GO
CREATE procedure [dbo].[vs_updSchedulingUser]
@user_id uniqueidentifier, 
@first varchar(100), 
@last varchar(100), 
@phone varchar(20), 
@email varchar(200), 
@scheduling_enabled bit ,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- select * from scheduling_users

-- import case 
if not exists (select user_id from scheduling_users where user_id = @user_id) 
begin 
	insert into scheduling_users 
	(user_id, email, first_name, last_name, phone, scheduling_enabled, author, create_date, modifier, modified_date) 
	values
	(@user_id, @email, @first, @last, @phone, @scheduling_enabled, @active_user_id, GETDATE(), @active_user_id, GETDATE()) 
	end 
else 
begin 
	update scheduling_users
	set 
		email = @email, 
		first_name = @first, 
		last_name = @last, 
		phone = @phone, 
		scheduling_enabled = @scheduling_enabled,
		modifier = @active_user_id,
		modified_date = GETDATE()
	where
		user_id = @user_id 
end
GO
PRINT N'Creating Procedure [dbo].[vs_updSchedulingUserPref]...';


GO
CREATE procedure [dbo].[vs_updSchedulingUserPref]
@user_id uniqueidentifier, 
@pref_key varchar(50), 
@pref_value varchar(300),
@delete bit = 0 ,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)


if (@delete  = 1)
begin
	-- update first to track user making the change
	update 
		scheduling_user_preferences 
	set
		modifier = @active_user_id,
		modified_date = GETDATE()
	where
		[USER_ID] = @user_id
		and pref_key = @pref_key
		
	delete 
		scheduling_user_preferences 
	where 
		[USER_ID] = @user_id
		and pref_key = @pref_key 
	return
end 

if exists(select pref_key from scheduling_user_preferences where user_id = @user_id and pref_key = @pref_key) 
begin 
	update 
		scheduling_user_preferences 
	set 
		pref_value = @pref_value,
		modifier = @active_user_id,
		modified_date = GETDATE()
	where 
		user_id = @user_id 
		and pref_key = @pref_key
end 
else
begin 
	
	insert into
		scheduling_user_preferences 
		(user_id, pref_key, pref_value, author,create_date, modifier, modified_date) 
		values
		(@user_id, @pref_key, @pref_value, @active_user_id, GETDATE(), @active_user_id, GETDATE()) 
end
GO
PRINT N'Creating Procedure [dbo].[vs_updSchedulingUserSetting]...';


GO
CREATE PROCEDURE [dbo].[vs_updSchedulingUserSetting]
@user_id uniqueidentifier,
@setting_id uniqueidentifier,
@setting_value varchar(200),
@security_token uniqueidentifier = null
AS
BEGIN
	declare @active_user_id varchar(100)
	set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

	IF EXISTS (SELECT 1 FROM scheduling_user_settings WHERE setting_id = @setting_id AND user_id = @user_id)
	BEGIN
		UPDATE
			scheduling_user_settings
		SET
			setting_value = @setting_value,
			modifier = @active_user_id,
			modified_date = getdate()
		WHERE
			user_id = @user_id
			AND setting_id = @setting_id
	END
	ELSE
	BEGIN
		INSERT INTO
			scheduling_user_settings (id, user_id, setting_id, setting_value, author, create_date, modifier, modified_date)
		VALUES
			(newid(), @user_id, @setting_id, @setting_value, @active_user_id, getdate(), @active_user_id, getdate())
	END
END
GO
PRINT N'Creating Procedure [dbo].[vs_updSchedulingUserWorkSchedule]...';


GO
CREATE procedure [dbo].[vs_updSchedulingUserWorkSchedule] 
@user_id uniqueidentifier, 
@day int, 
@location_id uniqueidentifier, 
@work_type int, 
@start_time time, 
@end_time time ,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)


-- select * from scheduling_user_work_schedules

if exists (select user_id from scheduling_user_work_schedules where [day] = @day and user_id = @user_id) 
begin 
	update scheduling_user_work_schedules
	set 
		location_id = @location_id, 
		work_type = @work_type, 
		start_time = @start_time, 
		end_time = @end_time,
		modifier = @active_user_id,
		modified_date = GETDATE()
	where
		user_id = @user_id 
		and day = @day 
end 
else 
begin 
	insert into scheduling_user_work_schedules 
	(user_id, day, location_id, work_type, start_time, end_time, author, create_date, modifier, modified_date) 
	values
	( @user_id, @day, @location_id, @work_type, @start_time, @end_time, @active_user_id, GETDATE(), @active_user_id, GETDATE() ) 
end
GO
PRINT N'Creating Procedure [dbo].[vs_validateSchedulingAppointment]...';


GO
CREATE procedure [dbo].[vs_validateSchedulingAppointment] 
@appointment_id UNIQUEIDENTIFIER, 
@buyer_profile_id UNIQUEIDENTIFIER, 
@account_org_id UNIQUEIDENTIFIER, 
@schedule_user_id UNIQUEIDENTIFIER = null, 
@appointment_date datetime = null, 
@start_time time = null, 
@end_time time = null, 
@stamp TIMESTAMP = null
AS

-- ERROR CODES 
--  0 VALID 
-- -1 appointment changed since update (timestamp) 
-- -10 eclipse 
-- -20 end overlap 
-- -30 start overlap
-- -100 designer schedule is invalid now 
-- -110 designer no longer active 
-- -120 designer no longer has account org 

-- TESTING A BUG IN PRODUCTION: 
-- +		appointment.BuyerProfileID	{00000000-0000-0000-0000-000000000000}	System.Guid
-- +		appointment.Date	{3/8/2013 12:00:00 AM}	System.DateTime
-- 	appointment.Duration	225	int
-- +		appointment.Start	{10:45:00}	System.TimeSpan
-- +		appointment.AppointmentID	{a82c24c0-30df-42bf-a9b1-9977780a03a4}	System.Guid
-- +		appointment.AccountOrgID	{2f3b34d1-80bd-41d8-8cc6-b662a186f7ae}	System.Guid
--		appointment.AppointmentType	Custom	VeoSolutionsData.Classes.Scheduling.AppointmentTypeEnum
-- +		appointment.Location.LocationID	{c04b5e52-8d06-4bab-b878-1eeca0bc8d23}	System.Guid

-- STAMP CHANGE 
IF EXISTS (SELECT appointment_id FROM scheduling_appointments WHERE appointment_id = @appointment_id AND stamp <> @stamp) 
RETURN -1;

-- CHECK DESIGNER ACCOUNT ORG 
IF NOT EXISTS(SELECT [user_id] FROM dbo.scheduling_user_organizations WHERE user_id = @schedule_user_id AND account_org_id = @account_org_id) 
RETURN -120; 

-- CHECK DESIGNER WORK SCHEDULE 
-- day of week & start/end time 
DECLARE @day INT 
SELECT @day = DATEPART(dw, @appointment_date) 

SET @day  = @day -1  -- SQL days start at 1 instead of 0 index for SUN 

IF NOT EXISTS(SELECT USER_ID FROM dbo.scheduling_user_work_schedules WHERE user_id = @schedule_user_id AND [day] = @day AND start_time <= @start_time AND end_time >= @end_time)
RETURN -100; 


--SELECT * FROM dbo.scheduling_appointments
DECLARE @appointments TABLE 
(appointment_id UNIQUEIDENTIFIER, 
buyer_profile_id UNIQUEIDENTIFIER, 
account_org_id UNIQUEIDENTIFIER, 
appointment_type INT, 
schedule_user_id UNIQUEIDENTIFIER, 
appointment_date DATETIME, 
start_time TIME, 
end_time TIME, 
location_id UNIQUEIDENTIFIER) 

INSERT INTO @appointments 
SELECT 
appointment_id, 
buyer_profile_id, 
account_org_id, 
appointment_type, 
schedule_user_id, 
appointment_date, 
start_time, 
end_time, 
location_id
FROM scheduling_appointments 
WHERE 
	schedule_user_id = @schedule_user_id 
	AND appointment_date = @appointment_date
	AND appointment_id <> @appointment_id -- exclude test appointment 

-- no other appointments! 
IF (@@rowcount = 0) 
RETURN 0; 

-- ECLIPSE (must test first) 
IF EXISTS ( 
SELECT a.appointment_id FROM @appointments a
WHERE 
a.start_time >= @start_time AND a.end_time <= @end_time ) 
RETURN -10; 

-- END TIME OVERLAP
IF EXISTS ( 
SELECT a.appointment_id FROM @appointments a
WHERE 
a.start_time >= @start_time AND a.start_time < @end_time) 
RETURN -20; 

-- START TIME OVERLAP
IF EXISTS ( 
SELECT a.appointment_id FROM @appointments a
WHERE 
a.start_time < @start_time AND a.end_time > @start_time ) 
RETURN -30; 

-- success!
RETURN 0;
GO
PRINT N'Creating Procedure [dbo].[vsd_selSessionCabinetsByBuild]...';


GO
CREATE procedure [dbo].[vsd_selSessionCabinetsByBuild]
@session_id uniqueidentifier,
@build_id int,
@security_token uniqueidentifier
as

/*
	Author:	Adrian Garza
	Create date: 12/11/2014
	Description: Locate matching for a style by width,height, and/or depth

	vsd_selSessionCabinetsByBuild '2972c1e1-a86d-45d8-9065-ce6a4301bcbd' ,11875062,'01234567-89AB-CDEF-0000-123456789ABC'
*/


-- Validate the security token
IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
BEGIN
	RAISERROR('Access Denied.',16,1)
	RETURN
END


--locate main style from field

declare @main_style_id varchar(50)

select
@main_style_id = c.style_id

from catalog_selections_areas csa with (nolock)

left join catalog_selections cs with (nolock) on cs.row_id = csa.selected_field_group
left join veo_colors c with (nolock) on c.part_no = cs.item_no

where 
csa.session_id = @session_id
and csa.build_id = @build_id



select
distinct
csad.bom_item_id as source_plan_item_id,
csad.bom_real_item_id as source_cabinet_id,
c_source.name as source_cabinet_description,
'target_plan_item_id' =
	case
		when csad.item_id <> csad.bom_item_id then csad.item_id
		else ''
	end,
'target_cabinet_id' =
	case 
		when csad.real_item_id <> csad.bom_real_item_id then csad.real_item_id
		else ''
	end,
'target_cabinet_description' =
	case
		when c_target.name <> c_source.name then c_target.name
		else ''
	end,

sa_w.value_id as width,
sa_d.value_id as depth,
sa_h.value_id as height,
c_source.product_id,
sri.style_id,
c_source.color_id


from catalog_selections_areas csa with (nolock)
left join catalog_selections_area_details csad with (nolock) on
	csad.session_id = csa.session_id
	and csad.application = csa.application
	and csad.product = csa.product
	and csad.area = csa.area
	and csad.sub_area = csa.sub_area

left join veo_colors c_source with (nolock)
	on c_source.part_no = csad.bom_real_item_id

left join veo_colors c_target with (nolock)
	on c_target.part_no = csad.real_item_id

left join veo_styles_attributes sa_w with (nolock) on 
	sa_w.product_id = c_source.product_id
	and sa_w.style_id = c_source.style_id
	and sa_w.attribute_id = 'WIDTH'

left join veo_styles_attributes sa_d with (nolock) on 
	sa_d.product_id = c_source.product_id
	and sa_d.style_id = c_source.style_id
	and sa_d.attribute_id = 'Depth'


left join veo_styles_attributes sa_h with (nolock) on 
	sa_h.product_id = c_source.product_id
	and sa_h.style_id = c_source.style_id
	and sa_h.attribute_id = 'Height'


left join Veo_styles_related_items sri with (nolock) on
	sri.item_style_id = c_source.style_id 
	and sri.product_id = c_source.product_id

where 
	csa.session_id = @session_id
	and csa.build_id = @build_id
	and csad.item_type = 'material'
	and item_id not in ('credit','Field')
	and sri.style_id is not null -- cannot show any plan items that are not setup in style related items. 12/12/14 -ADG
	and sri.style_id = @main_style_id
GO
PRINT N'Creating Procedure [dbo].[vds_addSectionToRoom]...';


GO
CREATE PROCEDURE [dbo].[vds_addSectionToRoom]
	@room_id UNIQUEIDENTIFIER,
	@area_id VARCHAR(50),
	@sub_area_id VARCHAR(50),
	@security_token UNIQUEIDENTIFIER
AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	INSERT INTO [room_sections] (
		[room_id],
		[area_id],
		[sub_area_id]
	)
	VALUES (
		@room_id,
		@area_id,
		@sub_area_id
	)

	EXEC vds_getSectionsForRoom @room_id, @security_token
END
GO
PRINT N'Creating Procedure [dbo].[vds_getRoomById]...';


GO
CREATE PROCEDURE [dbo].[vds_getRoomById]
@id UNIQUEIDENTIFIER,
@security_token UNIQUEIDENTIFIER

AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	SELECT 
		[rooms].[id],
		[rooms].[name],
		[rooms].[icon_id],
		[rooms].[author],
		[rooms].[create_date],
		[rooms].[modifier],
		[rooms].[modified_date]
	FROM 
		[rooms]
	WHERE 
		[id] = @id

	EXEC vds_getSectionsForRoom @id, @security_token
END
GO
PRINT N'Creating Procedure [dbo].[vds_getRoomByName]...';


GO
CREATE PROCEDURE [dbo].[vds_getRoomByName]
@name VARCHAR(100),
@security_token UNIQUEIDENTIFIER

AS
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.', 16, 1)
		RETURN
	END

	DECLARE @id UNIQUEIDENTIFIER;

	SELECT @id = [rooms].[id] FROM [rooms] WHERE UPPER([name]) = UPPER(@name)

	EXEC vds_getRoomById @id, @security_token
END
GO
PRINT N'Creating Procedure [dbo].[vds_selCatalogSelectionAreas]...';


GO
CREATE PROCEDURE [dbo].[vds_selCatalogSelectionAreas]
	@session_id UNIQUEIDENTIFIER,
	@selected_areas_only BIT = 1,
	@security_token UNIQUEIDENTIFIER = NULL
AS
/*
	Author: Shelby Mansker
	Create date: 5/27/2014
	Description: Returns catalog selection areas for the specified
	session. Use the selected_areas_only bit parameter
	to only return selected areas.
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Call the legacy stored procedure
	EXEC dbo.vs_selCatalogSelectionAreas @session_id, @selected_areas_only
END
GO
PRINT N'Creating Procedure [dbo].[vds_updApplyPattern]...';


GO

CREATE proc [dbo].[vds_updApplyPattern]
	@session_id UNIQUEIDENTIFIER,-- = '83b5e473-5062-4373-a5d7-54225d50f1ca',
	@build_id INT,-- = 9797568,
	@pattern_id INT,-- = 668,
	@security_token UNIQUEIDENTIFIER,
	@reprice bit = 1
AS
/*
	Author:		Scott Friend
	Create date: ???
	Description:	Apply Patterns (blow up BOM) and reprice

	Updated 5/23/2014: Added this comment block AND reformatted the
	proc a little. Updated the security token validation code to be
	consistent with other procs. -Shelby

	Updated 5/28/2014: Moved out the repricing logic into a resuable call and pass a flag to default the pricing to occur - Scott

    Updated 07/02/2014. Use synonyms to reference other database tables. Saul.

	vds_updApplyPattern '83b5e473-5062-4373-a5d7-54225d50f1ca', 9797568, 668	--Apply Pattern
	vds_updApplyPattern '83b5e473-5062-4373-a5d7-54225d50f1ca', 9797568, 0		--Clear out Pattern selection
	vds_updApplyPattern '83b5e473-5062-4373-a5d7-54225d50f1ca', 9797568, -1		--Error Condition, No Pattern Found
*/
BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	SET NOCOUNT ON

	DECLARE @empty_pattern INT = 0;

	IF (@pattern_id != 0)
	BEGIN
		DECLARE @valid_pattern INT = 0;
		SELECT @valid_pattern = COUNT(DISTINCT 1) + @valid_pattern FROM Veo_product_patterns_material ppm WITH (NOLOCK) WHERE ppm.pattern_id = @pattern_id
		IF (@valid_pattern = 0)
		BEGIN
			SELECT @valid_pattern = COUNT(DISTINCT 1) + @valid_pattern FROM Veo_product_patterns_labor ppl WITH (NOLOCK) WHERE ppl.pattern_id = @pattern_id
		END
		IF (@valid_pattern = 0)
		BEGIN
			RAISERROR('Invalid Pattern ID: %d', 0, 0, @pattern_id)
			RETURN
		END
	END

	
	DECLARE @application VARCHAR(100)
	DECLARE @product VARCHAR(100)
	DECLARE @area VARCHAR(100)
	DECLARE @area_id VARCHAR(25)
	DECLARE @sub_area VARCHAR(100)
	DECLARE @sub_area_id VARCHAR(25)

	SELECT
		@application = csa.application,
		@product = csa.product,
		@area = csa.area,
		@area_id = csa.area_id,
		@sub_area = csa.sub_area,
		@sub_area_id = csa.sub_area_id
	FROM catalog_selections_areas csa WITH (NOLOCK)
	WHERE csa.session_id = @session_id
		AND csa.build_id = @build_id
		
	DECLARE @application_id VARCHAR(10)
	SELECT @application_id = a.application_id FROM Veo_applications a WITH (NOLOCK) WHERE a.name = @application

	DECLARE @product_id VARCHAR(10)
	SELECT @product_id = p.product_id FROM Veo_products p WITH (NOLOCK) WHERE p.name = @product
		
	DECLARE @organization_id UNIQUEIDENTIFIER
	DECLARE @effective_date datetime
	DECLARE @spec_id INT
	DECLARE @plan_id VARCHAR(20) = ''
	SELECT
		@effective_date = effective_date,
		@spec_id = spec_id,
		@organization_id = organization_id
	FROM account_organization_user_profile_plan_catalog_sessions WITH (NOLOCK)
	WHERE session_id = @session_id

	DECLARE @customer_id VARCHAR(20)
	SELECT @customer_id = external_organization_id FROM veosolutionssecurity_organizations WITH (NOLOCK) WHERE organization_id = @organization_id

	BEGIN transaction
		
		/** Clear Previously Selected Pattern **/
		UPDATE catalog_selections_areas
		SET pattern_id = @empty_pattern
		WHERE session_id = @session_id
		AND build_id = @build_id

		DELETE csad
		FROM catalog_selections_area_details csad 
		WHERE
			csad.session_id = @session_id
			AND csad.[application] = @application
			AND csad.product = @product
			AND csad.area = @area
			AND csad.sub_area = @sub_area
			AND csad.is_pattern_item = 1

		UPDATE catalog_selections_area_details 
			SET pattern_id = @empty_pattern,
			bill_qty = bom_bill_qty
		WHERE 
			session_id = @session_id
			AND [application] = @application
			AND product = @product
			AND area = @area
			AND sub_area = @sub_area
			AND pattern_id <> @empty_pattern
			
		IF (@pattern_id != 0)
		BEGIN
			-- Get New BOM Lines
			DECLARE @patternLines TABLE
			(
				item_type VARCHAR(20),
				item_id VARCHAR(50),
				pattern_percentage decimal(18,4),
				real_item_id VARCHAR(50),
				selectable BIT,
				uom_id VARCHAR(9),
				class_id VARCHAR(50)
			)

			INSERT INTO @patternLines
			SELECT 
				LOWER(ppm.item_type),
				ppm.item_id,
				ppm.area_percentage pattern_percentage, 
				'' real_item_id,
				pi.hb_selection_display	selectable,
				pi.uom_id,
				pi.class_id
			FROM 
				Veo_plan_items pi WITH (NOLOCK)
			join Veo_product_patterns_material ppm WITH (NOLOCK)
				on pi.application_id = ppm.application_id  
				AND pi.product_id = ppm.product_id 
				AND pi.item_type = ppm.item_type 
				AND pi.item_id = ppm.item_id
				AND ppm.pattern_id = @pattern_id

			INSERT INTO @patternLines
			SELECT 
				LOWER(ppl.item_type),
				ppl.item_id,
				1 pattern_percentage, 
				ppl.labor_code real_item_id,
				pi.hb_selection_display	selectable,
				pi.uom_id,
				pi.class_id
			FROM 
				Veo_plan_items pi WITH (NOLOCK)
			join Veo_product_patterns_labor ppl WITH (NOLOCK) 
				on pi.application_id = ppl.application_id  
				AND pi.product_id = ppl.product_id 
				AND pi.item_type = ppl.item_type 
				AND pi.item_id = ppl.item_id
				AND ppl.pattern_id = @pattern_id

			--Update Existing BOM Lines
			UPDATE csad
				SET csad.pattern_id = @pattern_id,
				csad.pattern_percentage = pl.pattern_percentage,
				csad.bill_qty = dbo.vdsf_roundBanker(csad.bom_bill_qty * pl.pattern_percentage,0),
				csad.force_reprice = 1
			FROM
				@patternLines pl
			join catalog_selections_area_details csad
				on pl.item_type = csad.item_type
				AND pl.item_id = csad.item_id
			WHERE csad.session_id = @session_id
				AND csad.application = @application
				AND csad.product = @product
				AND csad.area = @area
				AND csad.sub_area = @sub_area

			DELETE pl
			FROM @patternLines pl
			join catalog_selections_area_details csad
				on pl.item_type = csad.item_type
				AND pl.item_id = csad.item_id
			WHERE csad.session_id = @session_id
				AND csad.application = @application
				AND csad.product = @product
				AND csad.area = @area
				AND csad.sub_area = @sub_area

			--Insert New BOM Lines
			DECLARE @original_Bill_Qty decimal(18,4)
			SELECT 
				@original_Bill_Qty = max(csad.bom_bill_qty)
			FROM  
				catalog_selections_area_details csad
			join catalog_selections_areas csa
				on csad.session_id = csa.session_id
				AND csad.application = csa.application
				AND csad.product = csa.product
				AND csad.area = csa.area
				AND csad.sub_area = csa.sub_area
				AND csa.session_id = @session_id
				AND csa.build_id = @build_id
			WHERE
				csad.item_type = 'material'
				AND csad.item_id = 'FIELD'

			INSERT INTO catalog_selections_area_details
				(session_id, application, product, area, sub_area, item_type, item_id, selectable, bom_real_item_id, real_item_id, bom_bill_qty, bill_qty, alloc_qty, credit_qty, bom_uom_id, uom_id, builder_price, homeowner_price, pattern_id, is_pattern_item, pattern_percentage, force_reprice,retail_percentage)
			SELECT 
				@session_id,
				@application,
				@product,
				@area,
				@sub_area,
				pl.item_type,
				pl.item_id,
				case(real_item_id) when '' then 1 else 0 END,
				pl.real_item_id,
				pl.real_item_id,
				dbo.vdsf_roundBanker(@original_Bill_Qty * pl.pattern_percentage,0),
				dbo.vdsf_roundBanker(@original_Bill_Qty * pl.pattern_percentage,0),
				0,
				0,
				pl.uom_id,
				pl.uom_id,
				0,
				0,
				@pattern_id,
				1,
				pl.pattern_percentage,
				1,
				0
			FROM @patternLines pl

		END

/** MOVE OUT FOR REUSE 			
		--Reprice
                        
		DECLARE @generic_item_type VARCHAR(20)
		DECLARE @generic_item_id VARCHAR(50) = ''
		DECLARE @item VARCHAR(81)
		DECLARE @uom VARCHAR(9) = ''
		DECLARE @item_price decimal(18,2)   
		DECLARE @item_price_retail decimal(18,2)  
		DECLARE @price_type VARCHAR(10) 
		DECLARE @pricing_layer VARCHAR(200)
		DECLARE @retail_percentage decimal(18,2)                          
		DECLARE @retail_percentage_type VARCHAR(20)   
		
		--For Each BOM Line
		DECLARE cur_bomLines cursor for
		SELECT 
			csad.item_type,
			csad.item_id,
			csad.real_item_id,
			csad.uom_id
		FROM catalog_selections_area_details csad
			join catalog_selections_areas csa
				on csad.session_id = csa.session_id
				AND csad.application = csa.application
				AND csad.product = csa.product
				AND csad.area = csa.area
				AND csad.sub_area = csa.sub_area
				AND csa.session_id = @session_id
				AND csa.build_id = @build_id

		OPEN cur_bomLines
		FETCH NEXT FROM cur_bomLines INTO 
			@generic_item_type,
			@generic_item_id,
			@item,
			@uom
		WHILE @@fetch_status = 0
		BEGIN
				EXEC Veo_esp_selItemPrice @effective_date,@customer_id,@application_id,@product_id,@area_id,@sub_area_id,@spec_id,@plan_id,@build_id,
						@generic_item_type,@generic_item_id,@item,@uom,@pattern_id,@item_price OUTPUT,@item_price_retail OUTPUT,
						@price_type OUTPUT,@pricing_layer OUTPUT,@retail_percentage OUTPUT,@retail_percentage_type OUTPUT,@security_token
				
				UPDATE catalog_selections_area_details 
					SET builder_price = ISNULL(@item_price,0),
					homeowner_price = ISNULL(@item_price_retail,0),
					price_type = @price_type,
					retail_percentage = ISNULL(@retail_percentage,0),
					retail_percentage_type = ISNULL(@retail_percentage_type,'')
				WHERE 
					session_id = @session_id
					AND application = @application
					AND product = @product
					AND area = @area
					AND sub_area = @sub_area
					AND item_type = @generic_item_type
					AND item_id = @generic_item_id
					AND real_item_id = @item

			FETCH NEXT FROM cur_bomLines INTO 
				@generic_item_type,
				@generic_item_id,
				@item,
				@uom
		END
		CLOSE cur_bomLines
		DEALLOCATE cur_bomLines
			
**/
		--Update Header

		UPDATE catalog_selections_areas
			SET pattern_id = @pattern_id,
			selection_total = 0 --TODO
		WHERE 
			session_id = @session_id AND build_id = @build_id



  	    exec dbo.vds_updateBuildStatus @session_id, @build_id, @security_token

    --removed not working, moving to middle tier 7/11/14 ADG
	--if (@reprice = 1)
	--begin
	--	exec dbo.vds_updRepriceArea @session_id, @build_id, @security_token
	--end

	--stupid hack: need to set all bill_qty to 1 where price_type = 'area' 7/11/2014 -ADG
	update catalog_selections_area_details
	set bill_qty = 1
	where price_type = 'area'
	and session_id = @session_id 
	and application = @application
	and product = @product
	and area = @area
	and sub_area = @sub_area
	and bill_qty > 1




	commit transaction
END
GO
PRINT N'Creating Procedure [dbo].[vds_updSelectionSessionStatus]...';


GO

CREATE PROCEDURE [dbo].[vds_updSelectionSessionStatus]
	@session_id UNIQUEIDENTIFIER,
	@status int, 
	@security_token UNIQUEIDENTIFIER
AS
/*
	Author:      Robert Hobbs
	Create date: 7/8/2014
	Description: Updates the session status by delegating a call to vs_updCatalogSession
	
	TESTING: 
	select top 10 * from account_organization_user_profile_plan_catalog_sessions where session_id = '436c7112-8bbb-4d54-becf-90b45d78a054'
	update account_organization_user_profile_plan_catalog_sessions set status =1   where session_id = '436c7112-8bbb-4d54-becf-90b45d78a054'
	
	select top 10 * from account_organization_user_profile_plan_catalog_sessions order by create_date desc
	select top 10 * from account_organization_user_profile_plan
	select top 10 * from account_organization_user_profile order by create_date desc

	vds_selSelectionSessionInfo 'FCA8283D-D5C1-4B9E-A023-4EB952A2F687', 0,  null
	vds_updSelectionSessionStatus 'FCA8283D-D5C1-4B9E-A023-4EB952A2F687', 0, null 
*/
BEGIN
   
	-- Validate the security token
	--IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	--BEGIN
	--	RAISERROR('Access Denied.',16,1)
	--	RETURN
	--END

	-- DECLARE VARIABLES FOR THE CATALOG SESSION 
	declare @session_notes varchar(255)
	declare @deposit decimal(18,2)
	declare @deposit_notes varchar(255)
	declare @designer varchar(50)= ''
	declare @spec_id int = 0
	declare @completed_date datetime = null
	declare @effective_date datetime = null
	declare @community_id int = 0
	declare @rounding_type int = 0
	declare @rounding_places int = 2
	declare @builder_markup_hb_pricing bit = 0

	select 
		@session_notes = session_notes, 
		@deposit = deposit, 
		@deposit_notes = deposit_notes, 
		@designer = designer, 
		@spec_id = spec_id, 
		@completed_date = completed_date,
		@effective_date = effective_date, 
		@community_id = community_id, 
		@rounding_type = rounding_type,
		@rounding_places = rounding_places, 
		@builder_markup_hb_pricing = builder_markup_hb_pricing 
	FROM 
		account_organization_user_profile_plan_catalog_sessions
	WHERE 
		session_id = @session_id 

	exec vs_updCatalogSession @session_id, @status, @session_notes, @deposit, @deposit_notes, 
	@designer, @spec_id, @completed_date, @effective_date, @community_id, @rounding_type,
	@rounding_places, @builder_markup_hb_pricing, @security_token
	 
END
GO
PRINT N'Creating Procedure [dbo].[vs_CancelSchedulingAppointment]...';


GO
CREATE procedure [dbo].[vs_CancelSchedulingAppointment]
@appointment_id uniqueidentifier,
@operator_id uniqueidentifier, 
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

declare @buyer_profile_id uniqueidentifier
select @buyer_profile_id = buyer_profile_id from scheduling_appointments where appointment_id = @appointment_id 

-- select * from scheduling_appointments where is_scheduled = 1
update 
	scheduling_appointments 
set
	is_scheduled = 0, 
	schedule_user_id = null, 
	appointment_date = null, 
	start_time = null, 
	end_time = null, 
	location_id = null,
	modifier = @active_user_id,
	modified_date = GETDATE()
where 
	appointment_id = @appointment_id 
	
-- update buyer messages


--	select * from scheduling_appointment_typees
-- select * from scheduling_messages
-- select * from scheduling_message_types
insert into 
scheduling_messages
(message_id, message_type, message_status, is_read, message_title, message_priority, [user_id], buyer_profile_id, appointment_id, sender_id, message_body, completion_date) 
values
(newid(), 0, 0, 0, 'Canceled', 0, @operator_id , @buyer_profile_id, @appointment_id, @operator_id, 'Appointment Canceled', getdate())


-- update buyer is_active based on appointments 
exec vs_updSchedulingBuyerActiveBasedOnAppointments @buyer_profile_id, @security_token
GO
PRINT N'Creating Procedure [dbo].[vs_delSchedulingBuyerAppointment]...';


GO
CREATE procedure [dbo].[vs_delSchedulingBuyerAppointment] 
@appointment_id uniqueidentifier,
@security_token uniqueidentifier = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

-- SUMMARY 
-- this proc deletes and unscheduled buyer appointment 

-- TESTING 
-- select * from scheduling_appointments where buyer_profile_id is not null and is_scheduled = 0
-- vs_delSchedulingBuyerAppointment '55FB5FAE-E632-43EF-9686-0615160A4393'

declare @buyer_profile_id uniqueidentifier 
select @buyer_profile_id = buyer_profile_id from scheduling_appointments where appointment_id = @appointment_id

update
	scheduling_appointments
set
	modifier = @active_user_id,
	modified_date = GETDATE()
where
	appointment_id = @appointment_id
	and is_scheduled = 0
	and appointment_date is null
	
delete 
	scheduling_appointments
where 
	appointment_id = @appointment_id 
	and is_scheduled = 0 
	and appointment_date is null 


-- UPDATE THE BUYER 
exec vs_updSchedulingBuyerActiveBasedOnAppointments @buyer_profile_id, @security_token
GO
PRINT N'Creating Procedure [dbo].[vs_updSchedulingAppointment]...';


GO
create procedure [dbo].[vs_updSchedulingAppointment]
@appointment_id uniqueidentifier,
@buyer_profile_id uniqueidentifier,
@account_org_id uniqueidentifier,
@appointment_template_id uniqueidentifier = null,
@appointment_type int,
@appointment_duration int,
@is_scheduled bit = 0 ,
@is_conflict bit = 0,
@schedule_user_id uniqueidentifier = null,
@appointment_date datetime = null,
@start_time time = null,
@end_time time = null,
@location_id uniqueidentifier = null,
@appointment_label varchar(200)='',
@appointment_note varchar(200) = '',
@is_virtual bit = 0,
@in_design bit = 0,
@design_type uniqueidentifier = null,
@confirmation_status int = 0,
@is_provisional bit = 0,
@provisional_scheduler_user_id uniqueidentifier = null,
@security_token uniqueidentifier = NULL,
@stamp TIMESTAMP = null
as

declare @active_user_id varchar(100)
set @active_user_id = dbo.ef_getUserEmailFromSecurityToken(@security_token)

declare @sender_id uniqueidentifier
set @sender_id = null
select  @sender_id = [user_id] from VeoSolutionsSecurity_users_login_sessions where security_token = @security_token

-- validate
if (@is_scheduled = 1 and @schedule_user_id is not null)
begin
	DECLARE @result INT
	EXEC @result = dbo.vs_validateSchedulingAppointment @appointment_id, @buyer_profile_id, @account_org_id,  @schedule_user_id , @appointment_date, @start_time, @end_time, @stamp

	IF (@result <> 0)
	BEGIN
		-- custom errors are abs(return code) + 50100
		DECLARE @custom_error INT
		SET @custom_error = ABS(@result) + 50100;
		RAISERROR(@custom_error,16,1);
		return @result
	END
end

--select * from scheduling_appointments order by modified_date desc
-- select * from z_scheduling_appointments where appointment_id = 'F27538B5-B094-41C6-93AE-B393897B00CB' order by z_time desc
--select * from scheduling_appointment_tasks

declare @action varchar(20)
set @action = ''

if (@appointment_id = '00000000-0000-0000-0000-000000000000')
begin
	set @appointment_id = newid()
end

if not exists (select appointment_id from scheduling_appointments where appointment_id = @appointment_id )
begin

	-- buyer 'extra' appointments are created, but not scheduled.
	if (@is_scheduled = 1)
		set @action = 'Scheduled'

	declare @newid uniqueidentifier

	insert into scheduling_appointments (
		appointment_id,
		buyer_profile_id,
		account_org_id,
		appointment_template_id,
		appointment_type,
		appointment_duration,
		is_scheduled,
		is_conflict,
		schedule_user_id,
		appointment_date,
		start_time,
		end_time,
		location_id,
		appointment_label,
		appointment_note,
		author,
		create_date,
		modifier,
		modified_date,
		is_virtual,
		in_design,
		design_type,
		confirmation_status,
		is_provisional
	)
	values
	(
		@appointment_id,
		@buyer_profile_id,
		@account_org_id,
		@appointment_template_id,
		@appointment_type,
		@appointment_duration,
		@is_scheduled,
		@is_conflict,
		@schedule_user_id,
		@appointment_date ,
		@start_time ,
		@end_time ,
		@location_id ,
		@appointment_label,
		@appointment_note,
		@active_user_id,
		GETDATE(),
		@active_user_id,
		GETDATE(),
		@is_virtual,
		@in_design,
		@design_type,
		@confirmation_status,
		@is_provisional
	)
end
else -- udpate case
begin
	-- select * from scheduling_appointments where appointment_date is null
	if ( (@appointment_date is not null) and exists(select appointment_id from scheduling_appointments where appointment_id = @appointment_id and appointment_date is null) )
	set @action = 'Scheduled'

	if (@action = '')
	begin
	if ( (@appointment_date is not null) and exists(select appointment_id from scheduling_appointments where appointment_id = @appointment_id and appointment_date is not null and appointment_date <> @appointment_date) )
	set @action = 'Rescheduled'
	end

	-- canceled is handled in another proc
	if (@action = '')
	begin
	if ( (@appointment_date is not null) and exists(select appointment_id from scheduling_appointments where appointment_id = @appointment_id and appointment_date is not null and schedule_user_id <> @schedule_user_id) )
	set @action = 'Reassigned'
	end

	-- adjusted start time
	if (@action = '')
	begin
	if ( (@appointment_date is not null) and exists(select appointment_id from scheduling_appointments where appointment_id = @appointment_id and appointment_date is not null and appointment_date = @appointment_date and start_time <> @start_time ) )
	set @action = 'Changed Start Time'
	end

	-- changed duration
	if (@action = '')
	begin
	if ( (@appointment_date is not null) and exists(select appointment_id from scheduling_appointments where appointment_id = @appointment_id and appointment_date is not null and appointment_date = @appointment_date and start_time = @start_time and end_time <> @end_time  ) )
	set @action = 'Changed Duration'
	end

	update
		scheduling_appointments
	set
		schedule_user_id = @schedule_user_id,  -- reassign? todo: make a reassign proc
		--appointment_type = @appointment_type, -- change appointment type?  probably not
		--buyer_profile_id = @buyer_profile_id, -- never?
		--appointment_task_id = @appointment_task_id, -- never?
		is_scheduled = @is_scheduled,
		is_conflict = @is_conflict,
		appointment_date = @appointment_date, -- reschedule
		start_time = @start_time,
		end_time = @end_time,
		location_id = @location_id,
		appointment_label = @appointment_label,
		appointment_note = @appointment_note,
		modifier = @active_user_id,
		modified_date = GETDATE(),
		is_virtual = @is_virtual,
		in_design = @in_design,
		design_type = @design_type,
		confirmation_status = @confirmation_status,
		is_provisional = @is_provisional,
		provisional_scheduler_user_id = @provisional_scheduler_user_id 
	where
		appointment_id = @appointment_id
end


-- update buyer history
if (@action <> '')
begin 	
	declare @message varchar(300)
	select @message = dbo.ef_selSchedulingAppointmentSystemNote(@appointment_id, @action, @is_provisional);

	-- select * from scheduling_messages order by create_date desc
	-- select * from scheduling_message_types
	insert into
	scheduling_messages
	(message_id, message_type, message_status, is_read, message_title, message_priority, [user_id], buyer_profile_id, appointment_id, sender_id, message_body, completion_date)
	values
	(newid(), 0, 0, 0, @action, 0, @schedule_user_id, @buyer_profile_id, @appointment_id, @sender_id, @message, getdate())

	-- update IS ACTIVE
	exec vs_updSchedulingBuyerActiveBasedOnAppointments @buyer_profile_id, @security_token
end
GO
PRINT N'Creating Procedure [dbo].[vds_updApplyOtherAreas]...';


GO
CREATE proc vds_updApplyOtherAreas
	@session_id uniqueidentifier,
	@build_id int,
	@dest_build_id int,
	@notes varchar(max),
	@security_token uniqueidentifier
as

/* 
	Author:		Scott Friend
	Create date: May 28, 2013
	Description:	Apply the selections of one build to another
  
	-- Examples
	vds_updApplyOtherAreas '83b5e473-5062-4373-a5d7-54225d50f1ca', 9797568, 9797571, '', '01234567-89AB-CDEF-0000-123456789ABC'
*/

BEGIN
	-- Validate the security token
	IF (dbo.vdsf_isValidSecurityToken(@security_token) = 0)
	BEGIN
		RAISERROR('Access Denied.',16,1)
		RETURN
	END

	-- Get Variables from Source
	declare @application varchar(100)
	declare @product varchar(100)
	declare @area varchar(100)
	declare @sub_area varchar(100)
	declare @pattern_id int
	declare @selected int
	declare @selected_field_group uniqueidentifier

	select 
		@application = [application],
		@product = product,
		@area = area,
		@sub_area = sub_area,
		@pattern_id = pattern_id,
		@selected = selected,
		@selected_field_group = selected_field_group
	from
		catalog_selections_areas with (nolock)
	where
		session_id = @session_id 
		and build_id = @build_id

	--Apply level selection to Destination (and will clear any other selections for same application/area/sub-area)
	exec dbo.vds_updSelectedBuildPriceLevel @session_id, @dest_build_id, null, @selected_field_group, @security_token
		
	--Get Destination variables
	declare @dest_area varchar(100)
	declare @dest_sub_area varchar(100)
	declare @dest_pattern_id int
	select 
		@dest_area = area,
		@dest_sub_area = sub_area,
		@dest_pattern_id = pattern_id
	from
		catalog_selections_areas with (nolock)
	where
		session_id = @session_id 
		and build_id = @dest_build_id

	--Apply Pattern if Source area has pattern selected
	if (@pattern_id != @dest_pattern_id)
	begin
		exec dbo.vds_updApplyPattern @session_id, @dest_build_id, @pattern_id, @security_token
	end

	/* WHERE DO I GET THE BOM LINES FROM?! */

	--Update destination BOM lines
	update dst set
		dst.real_item_id = src.real_item_id,
		dst.builder_price = src.builder_price,
		dst.homeowner_price = src.homeowner_price,
		dst.price_type = src.price_type,
		dst.retail_percentage = src.retail_percentage,
		dst.retail_percentage_type = src.retail_percentage_type
	from
		catalog_selections_area_details dst
	join catalog_selections_area_details src with (nolock)
		on dst.session_id = src.session_id
		and dst.application = src.application
		and dst.product = src.product
		and dst.selectable = src.selectable
		and dst.item_type = src.item_type
		and dst.item_id = src.item_id
	where 
		src.session_id = @session_id
		and src.[application] = @application
		and src.product = @product
		and src.area = @area
		and src.sub_area = @sub_area
		and dst.area = @dest_area
		and dst.sub_area = @dest_sub_area
		and dst.selectable = 1

	update catalog_selections_areas set
		selected = @selected,
		notes = @notes
	where session_id = @session_id
		and build_id = @dest_build_id
END
GO
PRINT N'Creating Permission Permission...';


GO
GRANT CONNECT TO [vds];


GO
PRINT N'Creating Permission Permission...';


GO
GRANT CONNECT TO [EchelonService];


GO
PRINT N'Creating Extended Property [dbo].[account_organization_user_profile_plan].[catalog_session_id].[Deprecated]...';


GO
EXECUTE sp_addextendedproperty @name = N'Deprecated', @value = N'True', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'account_organization_user_profile_plan', @level2type = N'COLUMN', @level2name = N'catalog_session_id';


GO
PRINT N'Creating Extended Property [dbo].[account_organization_user_profile_plan].[address_lot_block].[Deprecated]...';


GO
EXECUTE sp_addextendedproperty @name = N'Deprecated', @value = N'True', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'account_organization_user_profile_plan', @level2type = N'COLUMN', @level2name = N'address_lot_block';


GO
PRINT N'Creating Extended Property [dbo].[account_organization_user_profile_plan_exterior_selections].[selection_type].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Brick, Stucco, Hardiboard, Cedar, Stone, etc.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'account_organization_user_profile_plan_exterior_selections', @level2type = N'COLUMN', @level2name = N'selection_type';


GO
PRINT N'Creating Extended Property [dbo].[account_organization_user_profile_plan_exterior_selections].[manufacturer_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'May not be in database', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'account_organization_user_profile_plan_exterior_selections', @level2type = N'COLUMN', @level2name = N'manufacturer_id';


GO
PRINT N'Creating Extended Property [dbo].[account_organization_user_profile_plan_exterior_selections].[part_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'May not be in database', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'account_organization_user_profile_plan_exterior_selections', @level2type = N'COLUMN', @level2name = N'part_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_prices_published].[table_name].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'material or labor', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_prices_published', @level2type = N'COLUMN', @level2name = N'table_name';


GO
PRINT N'Creating Extended Property [dbo].[catalog_prices_published].[custclas].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'custom or production', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_prices_published', @level2type = N'COLUMN', @level2name = N'custclas';


GO
PRINT N'Creating Extended Property [dbo].[catalog_prices_published].[item_type].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'group,style,color,labor', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_prices_published', @level2type = N'COLUMN', @level2name = N'item_type';


GO
PRINT N'Creating Extended Property [dbo].[catalog_prices_published].[price_type].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'area or unit', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_prices_published', @level2type = N'COLUMN', @level2name = N'price_type';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Records for sessions are created in this table to hold all published prices for catalog items and estimated items. Catalog items are copied from a table named catalog_items, in this same database. Estimated items (i.e. Source = "Prices Landed") come from Yukon.WBS.prices_landed table.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[session_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Unique identifier to a user''s session snapshot. A Session is a snapshot of all published pricing for catalog items and estimated areas, for a given builder, at a specific point in time.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'session_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[row_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'This is a unique identifier for a record in this table. A record in this table represents a price to the homebuyer for either a catalog item or an estimated area.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'row_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[account_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The id of the account that this record belongs to. This information is provided here for convenience, since a Session is tied to a single Account. The accounts are currently stored in the VeoSolutions_Security database.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'account_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[organization_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The id of the organization that this record belongs to. This information is provided here for convenience, since a Session is tied to a single organization. Organizations are currently stored in the VeoSolutions_Security database.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'organization_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[community].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The name of the community that this record belongs to. This information is provided for convenience, since a Community is tied to the session. Communities are currently stored in the VeoSolutions_Security database.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'community';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[series].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The name of the series that this record belongs to. This information is provided for convenience, since a Sieries is tied to the session. Series are currently stored in the VeoSolutions_Security database.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'series';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[plan].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The name of the plan that this record belongs to. This information is provided for convenience, since a Plan is tied to the session. Plans are currently stored in the VeoSolutions_Security database.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'plan';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[application].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Application is a categorization of products, allowing us to group products by where or how they are associated within a home. Examples of applications include: plumbing, countertops, flooring, appliances, etc. ', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'application';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[product].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'A product is a specific offering, within an application, that a builder offers to homebuyers. Examples of products are things like; blinds, carpet, tile, refrigerators, warranties. Catalog Items represent product offerings defined by the builder, and can really be anything with a static price. Estimated Areas represent product offerings that have variable prices that are determined by decisions made by the homebuyer during selection. Estimated Areas have a Bill of Materials associated within them, that figures into the cost and selection options.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'product';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[area].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'For catalog items, this is the area as it is defined by the builder. For estimated items, this is the build description to distinquish estimated area items with the same area id. For example, assume that we have an area id that represents Kitchen (KIT). Within a single area id, e.g. Kitchen, there are multiple build configurations available, e.g. Standard Kitchen versus Kitchen with Cooktop. The area field is the description of the configuration, within the area id, that this record represents.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'area';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[area_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Area ID is only used by Estimated Areas records. Catalog Items will set this field to a blank string. Area ID comes from the Echelon Areas table and represents an area in the home; e.g. KIT (for Kitchen), LIV (Livinig Room)', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'area_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[sub_area].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'A sub area represents a area contained within another area. For example, within a kitchen, a sub area might be a pantry. This field is used by catalog items (source = "catalog") only. Since we use Build Descriptions for the area field for estimated areas (source = "Prices Landed"), which will include sub areas, this column is not used for estimated areas and will be blank.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'sub_area';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[sub_area_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Only used by estimated area items. Catalog items will set this field to a blank string. Sub Area ID comes from the Echelon Sub_Areas table and represents a sub area within an area.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'sub_area_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[item_type].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Each record in this database is describing a priced item, or area, to the home buyer.

The item_type field indicates what kind of item this record represents, and what''s available for selection for this price.

If item_type blank, it is a catalog item.

If item_type is Color, it indicates that this is the only selection available forthis item.

If item_type is Style, it indicates that any of the colors in that style may be selected. A style is a grouping of colors.

If item_type is Group, it indicates that any of the colors in this group, or in any of the styles that are in this group, may be selected. A Group is a set of Styles and/or colors.

If item_type is Custom, it indicates that any valid colors in the system may be selected, and the price will be calculated based on selections rather than set by this record (price in this record will be zero, until it is calculated).', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'item_type';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[item_no].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'A ID for the item (think SKU) that this record represents.

For catalog items, this is not required, but could contain the builders selection ID for this item if provided.

For estimated items, this will be the Group ID, Style ID, or Color ID. For Custom estimated items this field will be zero (and isn''t used)', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'item_no';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[item].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The homebuyer visible description of the item that this record represents. e.g. the name of the catalog item, the name of the group, style, or color. For custom estimated items, this will be "Custom".', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'item';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[vendor].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The name of the vendor for a specific catalog item. Not used for estimated areas. Not required (may be blank).', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'vendor';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[standard].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Appears to mostly be used for user created catalog items (source = "user"). It is a free form field in this case, and can contain literaly anything the user types.

There are cases where it contains a "1" or "No" for catalog items (source = "catalog"). Not sure how this is used. Nothing for estimated areas.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'standard';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[qty].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates how many of this record''s item the homebuyer has selected. This is changeable for catalog items, by the homebuyer. For estimated items this is always 1.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'qty';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[cost].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates how much each item costs the builder. Multiply this by qty field for catalog items to get extended prices for this record.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'cost';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[price].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates how much each item costs the homebuyer. Multiply this by qty field for catalog items to get extended price for this record for the homebuyer.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'price';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[selected].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates whether or not a homebuyer has selected this catalog item in their session. This field is not used for estimated areas (source = "prices landed")', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'selected';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[notes].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Contains catalog item notes from the builder and/or user. Not used for estimated items.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'notes';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[option_pricing_display].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates whether or not this item should be visible to the option pricing tool. ', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'option_pricing_display';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[mutually_exclusive].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'If set, indicates that only one item for this application, product, and area, may be selected at any given time. This is only used for catalog items.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'mutually_exclusive';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[build_data].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Contains the BOM. Data is stored in a binary field, it is serialized using .NET DataContract serializer, and is compressed using a zip library (gzip2 format I think).', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'build_data';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[original_build_data].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Intended to be a backup copy of the original compressed, serialized bom (unmodified). This would be used to restore the BOM to its original state. This field may not currently be used everywhere, so this field will likely be empty.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'original_build_data';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[source].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates where the item came from. It is also used to determine the kind of item; e.g. catalog item versus estimated item.

A value of "catalog" indicates it came from catalog_items table. Indicates a catalog item.

A value of "prices landed" indicates that it came from echelon prices_landed table. Indicates an estimated item.

A value of "user" indicates that it was created by a user. Indicates a user created catalog item.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'source';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[build_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'A build is a Bill of Materials for an application, product, area, sub area, and location. Builds are stored in Echelon. This field contains the build ID for locating the associated bom. Only used by estimated items.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'build_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[gpc].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'An identifier used to locate information, for this catalog item, using the GPC database (e.g. pictures, documents, etc.). Not used by estimated items.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'gpc';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[model].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Contains the vendor model # for this catalog item. Not used for estimated items.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'model';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[make_std].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates whether or not this estimated item''s price level has been set as the standard price level override.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'make_std';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections].[is_credit].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Used to give carpet credits in an area when other flooring options are selected for the same area, if this area is included in all standard carpet areas. Not used for anything else at the moment (non-rolled goods). Not used by catalog items.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections', @level2type = N'COLUMN', @level2name = N'is_credit';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Contains the current bom for a selected area.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[item_type].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates whether this BOM line is for "material", "labor", or "credit".

', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'item_type';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[item_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Contains the plan item id for this BOM  line; e.g. "field", "underlayment". In the case of credit bom lines, this will contain "Credit".', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'item_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[selectable].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates whether or not this item is selectable by the homebuyer.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'selectable';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[bom_real_item_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The original value for real_item_id when the price level was first selected. This is useful to track so that we can restore the bom to its original state more easily.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'bom_real_item_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[real_item_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Contains the unique identifier for what is selected, based on item_type and item_id. For example, the color selected for a material/field line, or the labor code for a pattern charge.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'real_item_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[bom_bill_qty].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The original bill_qty value when the price level was first selected. This is useful to track so that we can restore the bom to its original state more easily.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'bom_bill_qty';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[bill_qty].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The quantity of this bom line that will be used to calculate the extended builder and homebuyer costs.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'bill_qty';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[alloc_qty].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The actual quantity of this BOM line that will be allocated for installation. May be different than billable quantity.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'alloc_qty';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[credit_qty].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The quantity of this bom line that will be used to calculate the extended builder and homebuyer credits. Only really useful in credit areas to indicate credits to that area.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'credit_qty';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[bom_uom_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The original value for bom_uom when the price level was first selected. This is useful to track so that we can restore the bom to its original state more easily.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'bom_uom_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[uom_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates the unit of measure that this line is measure with in order to calculatepricing. Valid values include: Ea, Deco, SqFt, LinFt, and SqYd. The "Deco" unit of measure is a placeholder that eventually gets replaced by one of the other values.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'uom_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[builder_price].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'This is the amount charged to the builder, per quantity by unit of measure, for this line. However, if this bom line''s price_type is "area", this is the total amount charged to the builder for this bom line, regardless of qty and unit of measure.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'builder_price';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[homeowner_price].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'This is the amount charged to the homebuyer, per quantity by unit of measure, for this line. However, if this bom line''s price_type is "area", this is the total amount charged to the homebuyer for this bom line, regardless of qty and unit of measure.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'homeowner_price';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[pattern_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Contains the id of the pattern associated with this bom line, if there is one selected. If not, value is zero.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'pattern_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[is_pattern_item].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates whether or not this bom line was added to the bom due to the selection of a specific pattern. For example, pattern labor charge would have this value set to 1 (true).', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'is_pattern_item';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[pattern_percentage].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates how much of this material is used in the pattern. This is used to adjust the quantities of any of the affected BOM lines. For example, if the field 50% of the pattern, and the original field quatity was 150, then the new bill quantity would become 75 when the pattern was applied.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'pattern_percentage';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[force_reprice].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'If this field is set, then when recalculating the price of the bom, this item MUST be repriced from Echelon data (and not just use existing BOM data).', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'force_reprice';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[price_type].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates how the price should be calculated for this bom line. Acceptable values are "Unit", "Area", and a blank string.

If the value is blank or "Unit", this means we must extend the price from the proper quantity by proper price.

If the value is "Area", ignore the quantities and use the proper price field.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'price_type';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[price_source].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates where the price came from. Acceptable values are: extended, default, public, global, sum, and blank. This field is for informational purposes.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'price_source';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[retail_percentage].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates the percentage value to use in calculating homebuyer price, based on the retail_percentage_type.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'retail_percentage';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[retail_percentage_type].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates which profit model a builder wants to use to calculate homebuyer prices. Values are "Markup", and "Margin".', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'retail_percentage_type';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[accent_prompt].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Contains the selected cut-down size for this accent line, if this part number can be cut-down.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'accent_prompt';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[priced].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'DEPRECATED (NOT SURE IF IT IS USED, INVESTIGATE)', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'priced';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_area_details].[bom_item_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'DEPRECATED (NOT SURE IF IT IS USED. See bom_bill_qty for example of how this might have been intended to be used. Not sure there''s any point in tracking this, if the item_id field won''t change).', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_area_details', @level2type = N'COLUMN', @level2name = N'bom_item_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_areas].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Each record in this table represents a unique build, which area also considered structural options, in a session.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_areas';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_areas].[session_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Unique identifier to a user''''s session snapshot. A Session is a snapshot of all published pricing for catalog items and estimated areas, for a given builder, at a specific point in time.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_areas', @level2type = N'COLUMN', @level2name = N'session_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_areas].[application].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Application is a categorization of products, allowing us to group products by where or how they are associated within a home. Examples of applications include: plumbing, countertops, flooring, appliances, etc. ', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_areas', @level2type = N'COLUMN', @level2name = N'application';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_areas].[product].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'A product is a specific offering, within an application, that a builder offers to homebuyers. Examples of products are things like; blinds, carpet, tile, refrigerators, warranties. Estimated Areas represent product offerings that have variable prices that are determined by decisions made by the homebuyer during selection. Estimated Areas have a Bill of Materials associated within them, that figures into the cost and selection options.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_areas', @level2type = N'COLUMN', @level2name = N'product';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_areas].[area].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'This is the build description to distinquish estimated area items with the same area id. For example, assume that we have an area id that represents Kitchen (KIT). Within a single area id, e.g. Kitchen, there are multiple build configurations available, e.g. Standard Kitchen versus Kitchen with Cooktop. The area field is the description of the configuration, within the area id, that this record represents.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_areas', @level2type = N'COLUMN', @level2name = N'area';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_areas].[selected].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'This field indicates the selection status of this build.

A value of 0 indicates no selections.

A value of 1 means an incomplete selection.

A value of 2 means a complete selection.

A value of 3 might mean an error status. This is unconfirmed and should be checked into.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_areas', @level2type = N'COLUMN', @level2name = N'selected';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_areas].[notes].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'User editable notes for this build.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_areas', @level2type = N'COLUMN', @level2name = N'notes';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_areas].[original_build_data].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'DEPRECATED.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_areas', @level2type = N'COLUMN', @level2name = N'original_build_data';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_areas].[selection_total].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The current price total for selections made in this build.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_areas', @level2type = N'COLUMN', @level2name = N'selection_total';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_areas].[selected_field_group].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Contains the selected catalog_selections row id (basically a price level). If no price level is selected for this area, then this field will be an empty GUID.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_areas', @level2type = N'COLUMN', @level2name = N'selected_field_group';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_areas].[pattern_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'As a convenience, this field will contain the pattern id for this area, if a pattern was selected. This pattern id will also be found on the detail lines for this area, that use the pattern. If no pattern was selected, this field will be 0.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_areas', @level2type = N'COLUMN', @level2name = N'pattern_id';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_areas].[area_selected].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates whether or not this build, also referred to as a structural option, can be selected in the UI.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_areas', @level2type = N'COLUMN', @level2name = N'area_selected';


GO
PRINT N'Creating Extended Property [dbo].[catalog_selections_areas].[build_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Indicates which build this record is associated with.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'catalog_selections_areas', @level2type = N'COLUMN', @level2name = N'build_id';


GO
PRINT N'Creating Extended Property [dbo].[invoices].[invoice_template].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Contains a string that identifies the template or generation routine used to make the invoice. ', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'invoices', @level2type = N'COLUMN', @level2name = N'invoice_template';


GO
PRINT N'Creating Extended Property [dbo].[invoices].[external_invoice_reference].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'A reference to the invoice document in the external system, it might be an invoice number or transaction id.', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'invoices', @level2type = N'COLUMN', @level2name = N'external_invoice_reference';


GO
PRINT N'Creating Extended Property [dbo].[plan_documents].[profile_plan_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'identifier of the profile plan', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'plan_documents', @level2type = N'COLUMN', @level2name = N'profile_plan_id';


GO
PRINT N'Creating Extended Property [dbo].[plan_documents].[doc_type].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'business document type (i.e. session_selections)', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'plan_documents', @level2type = N'COLUMN', @level2name = N'doc_type';


GO
PRINT N'Creating Extended Property [dbo].[plan_documents].[mime_type].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'A mime type that can be used to craft responses from API', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'plan_documents', @level2type = N'COLUMN', @level2name = N'mime_type';


GO
PRINT N'Creating Extended Property [dbo].[plan_documents].[session_id].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Optional link to a session if it applies. ', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'plan_documents', @level2type = N'COLUMN', @level2name = N'session_id';


GO
PRINT N'Creating Extended Property [dbo].[plan_documents].[doc_data].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Raw binary data of the document', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'TABLE', @level1name = N'plan_documents', @level2type = N'COLUMN', @level2name = N'doc_data';


GO
-- Refactoring step to update target server with deployed transaction logs

IF OBJECT_ID(N'dbo.__RefactorLog') IS NULL
BEGIN
    CREATE TABLE [dbo].[__RefactorLog] (OperationKey UNIQUEIDENTIFIER NOT NULL PRIMARY KEY)
    EXEC sp_addextendedproperty N'microsoft_database_tools_support', N'refactoring log', N'schema', N'dbo', N'table', N'__RefactorLog'
END
GO
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '2c5983d8-02c0-4bde-926d-0d1e81146d4f')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('2c5983d8-02c0-4bde-926d-0d1e81146d4f')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'bf2b0c4a-2070-4fb8-ba26-e6a318c1d3be')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('bf2b0c4a-2070-4fb8-ba26-e6a318c1d3be')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '6cc30861-d210-49d6-b564-5486a159bf2d')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('6cc30861-d210-49d6-b564-5486a159bf2d')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '9fb05bf9-0a70-428b-a411-bf25efb3c6dd')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('9fb05bf9-0a70-428b-a411-bf25efb3c6dd')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'ea9dc2c0-f149-4324-9f75-6c737a79a076')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('ea9dc2c0-f149-4324-9f75-6c737a79a076')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '20f72242-a957-4c5a-9c76-4371bcb6214a')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('20f72242-a957-4c5a-9c76-4371bcb6214a')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '2cab0f01-7d9b-488a-aace-1201c3f758e7')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('2cab0f01-7d9b-488a-aace-1201c3f758e7')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '2e53605e-facf-4177-ab86-67106a2e1f2d')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('2e53605e-facf-4177-ab86-67106a2e1f2d')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '87d603b4-0903-414f-9022-25aa4a68b1b4')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('87d603b4-0903-414f-9022-25aa4a68b1b4')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '46069fd2-b7df-4a68-9abd-0c07929d27e5')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('46069fd2-b7df-4a68-9abd-0c07929d27e5')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '680e15eb-8e76-4f74-992c-4c720f7e872b')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('680e15eb-8e76-4f74-992c-4c720f7e872b')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'dc984200-8eac-4998-ab1b-a957c3c483dc')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('dc984200-8eac-4998-ab1b-a957c3c483dc')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '45671cbf-43eb-4def-aec7-1b476f532137')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('45671cbf-43eb-4def-aec7-1b476f532137')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'd294f19f-6f51-4508-b55f-e2541b72f721')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('d294f19f-6f51-4508-b55f-e2541b72f721')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '82f20a10-4bf1-4b70-b77f-90d4f4437d61')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('82f20a10-4bf1-4b70-b77f-90d4f4437d61')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'd0a5b5aa-ef85-415d-90cf-da0762664bb3')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('d0a5b5aa-ef85-415d-90cf-da0762664bb3')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '40236b87-863c-46ba-8b76-ba382c426ff5')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('40236b87-863c-46ba-8b76-ba382c426ff5')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '24015eb3-e171-4403-bb4a-29fc24482995')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('24015eb3-e171-4403-bb4a-29fc24482995')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'ff0ee8fe-9f41-4e55-ad25-c848162e85ec')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('ff0ee8fe-9f41-4e55-ad25-c848162e85ec')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '31e451fc-a1dc-4be3-b93d-bc9b32e33407')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('31e451fc-a1dc-4be3-b93d-bc9b32e33407')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '2b4377c3-41af-4bc4-ad37-b151255f9bd7')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('2b4377c3-41af-4bc4-ad37-b151255f9bd7')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'aee7922d-9c42-469e-88aa-7e63cbe3609b')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('aee7922d-9c42-469e-88aa-7e63cbe3609b')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'f97062a2-e0ce-49dc-992a-3eb21c15fde5')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('f97062a2-e0ce-49dc-992a-3eb21c15fde5')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'eb9fb113-be96-40ff-b42b-713762eadbfc')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('eb9fb113-be96-40ff-b42b-713762eadbfc')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'f3ec5d64-5497-4895-ae04-852c91b8e22b')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('f3ec5d64-5497-4895-ae04-852c91b8e22b')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '8142e37b-d38c-495b-9b9b-a310596cafca')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('8142e37b-d38c-495b-9b9b-a310596cafca')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'c247906c-6560-47ea-8770-207259398327')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('c247906c-6560-47ea-8770-207259398327')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '70d1b6ac-99be-483a-a56e-14ae85304599')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('70d1b6ac-99be-483a-a56e-14ae85304599')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'ba62175f-0be0-4a87-b554-e1570991cccf')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('ba62175f-0be0-4a87-b554-e1570991cccf')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '1aff62f8-ad84-4e87-94ab-3da0372904a1')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('1aff62f8-ad84-4e87-94ab-3da0372904a1')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '717d4dd1-9b4e-431e-93dc-7ad3a94c06f9')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('717d4dd1-9b4e-431e-93dc-7ad3a94c06f9')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'a01197b5-b5db-4b4b-91d9-c91ab4e1e61e')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('a01197b5-b5db-4b4b-91d9-c91ab4e1e61e')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '55503228-95e7-4295-bb3e-f6e42ff911bf')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('55503228-95e7-4295-bb3e-f6e42ff911bf')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'e88f14d9-ec26-49d6-9a32-11866d00762d')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('e88f14d9-ec26-49d6-9a32-11866d00762d')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '4cc2a426-77bd-40cb-a47d-5663344c9340')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('4cc2a426-77bd-40cb-a47d-5663344c9340')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'c0c0c500-013f-407e-ba92-676faffd3a40')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('c0c0c500-013f-407e-ba92-676faffd3a40')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'cf1e0889-a1d8-4cd3-a462-3a89655a07ed')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('cf1e0889-a1d8-4cd3-a462-3a89655a07ed')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '83bc796a-3012-4ef0-8fe1-e475c43cf7cc')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('83bc796a-3012-4ef0-8fe1-e475c43cf7cc')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'c6412f87-e889-4ab8-ad95-756222b5fa41')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('c6412f87-e889-4ab8-ad95-756222b5fa41')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '835d6948-6216-4100-8efe-26c2a89d9c69')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('835d6948-6216-4100-8efe-26c2a89d9c69')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'bc37cd33-67d8-470c-99a4-de48a061ac39')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('bc37cd33-67d8-470c-99a4-de48a061ac39')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '8f1ca1d2-810f-4b82-b9ca-01c663f710e6')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('8f1ca1d2-810f-4b82-b9ca-01c663f710e6')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '239284c0-1072-43b7-a47b-d7134eb3683e')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('239284c0-1072-43b7-a47b-d7134eb3683e')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '9815096b-05fc-488f-a6d3-3573ec59413b')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('9815096b-05fc-488f-a6d3-3573ec59413b')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'f15c9f35-b651-48bf-8dc5-d135a306fd85')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('f15c9f35-b651-48bf-8dc5-d135a306fd85')

GO

GO
/*
Post-Deployment Script Template							
--------------------------------------------------------------------------------------
 This file contains SQL statements that will be appended to the build script.		
 Use SQLCMD syntax to include a file in the post-deployment script.			
 Example:      :r .\myfile.sql								
 Use SQLCMD syntax to reference a variable in the post-deployment script.		
 Example:      :setvar TableName MyTable							
               SELECT * FROM [$(TableName)]					
--------------------------------------------------------------------------------------
*/

PRINT 'VeoSolutions: Adding Static Data';
/***********************************************************************************
* Author: Shelby Mansker
* Date: 12/07/2016
* Descripton: This script will add static data to the VeoSolutions database.
************************************************************************************/

/***********************************************************************************
Audit and Organization Variables
************************************************************************************/
DECLARE @author VARCHAR(50) = 'SEED',
		@date DATETIME = GETDATE();

/***********************************************************************************
Lifestyle Questionnaire Variables
************************************************************************************/
DECLARE @lifestyle_questionnaire_id UNIQUEIDENTIFIER = '488B672D-A1A1-4AA4-883A-DB24C56B45A7';

/***********************************************************************************
dbo.address_types
************************************************************************************/
MERGE dbo.address_types AS TGT
USING
	(VALUES 
		('Corporate'), 
		('Design Center'), 
		('Model'), 
		('Residence')
	) AS SRC (address_type)
ON TGT.address_type = SRC.address_type
WHEN NOT MATCHED THEN INSERT (address_type)
	VALUES(SRC.address_type);

/***********************************************************************************
dbo.builder_bom_modification_types
************************************************************************************/
MERGE dbo.builder_bom_modification_types AS TGT
USING
	(VALUES
		(0, 'Generic Modification'),
		(1, 'Manual Swap'),
		(2, 'Local Option')
	) AS SRC (id, name)
ON TGT.id = SRC.id
WHEN MATCHED THEN UPDATE
	SET TGT.name = SRC.name
WHEN NOT MATCHED THEN INSERT (id, name)
	VALUES (SRC.id, SRC.name);

/***********************************************************************************
dbo.session_statuses
************************************************************************************/
MERGE dbo.session_statuses AS TGT
USING
	(VALUES
		(0, 'Inactive'),
		(1, 'Active'),
		(2, 'Complete'),
		(3, 'Invoiced'),
		(4, 'Pending')
	) AS SRC (status_id, [status])
ON TGT.status_id = SRC.status_id
WHEN MATCHED THEN UPDATE
	SET TGT.[status] = SRC.[status]
WHEN NOT MATCHED THEN INSERT (status_id, [status])
	VALUES (SRC.status_id, SRC.[status]);

/***********************************************************************************
dbo.default_support_emails
************************************************************************************/
MERGE dbo.default_support_emails AS TGT
USING
	(VALUES
		('ApiEmailFromAddress', 'support@veodesignstudio.com'),
		('ApiSupportEmailAddress', 'vds-devtest@mailinator.com'),
		('EmailFromAddress', 'support@veodesignstudio.com'),
		('SupportEmailAddress', 'vds-devtest@mailinator.com'),
		('VisualizationError', 'vds-devtest@mailinator.com')
	) AS SRC (email_key, email)
ON TGT.email_key = SRC.email_key
WHEN NOT MATCHED THEN INSERT (email_key, email)
	VALUES (SRC.email_key, SRC.email);

/***********************************************************************************
dbo.problem_types
************************************************************************************/
SET IDENTITY_INSERT dbo.problem_types ON;

MERGE dbo.problem_types AS TGT
USING
	(VALUES
		(1, 'Buyer Registration - Invalid Profile Plan'),
		(2, 'Cabinet Add-On Price Override'),
		(3, 'Cabinet Swap Price Override'),
		(4, 'Cannot Resolve Spec ID'),
		(5, 'Color Assigned to Wrong Group'),
		(6, 'Custom Estimate'),
		(7, 'Incorrect Price'),
		(8, 'Missing Area'),
		(9, 'Missing Color'),
		(10, 'Missing Pattern'),
		(11, 'Missing Price'),
		(12, 'Other'),
		(13, 'Photo Issue'),
		(14, 'Plan Issue'),
		(15, 'Price Override'),
		(16, 'Pricing Issue'),
		(17, 'Product Catalog Issue'),
		(18, 'Standard Group Override'),
		(19, 'Website Issue')
	) AS SRC ([type_id], name)
ON TGT.[type_id] = SRC.[type_id]
WHEN MATCHED THEN UPDATE
	SET TGT.name = SRC.name
WHEN NOT MATCHED THEN INSERT ([type_id], name)
	VALUES (SRC.[type_id], SRC.name);

SET IDENTITY_INSERT dbo.problem_types OFF;

/***********************************************************************************
dbo.support_problem_resolutions
************************************************************************************/
SET IDENTITY_INSERT dbo.support_problem_resolutions ON;

MERGE dbo.support_problem_resolutions AS TGT
USING
	(VALUES
		(1, 'Fixed Price'),
		(2, 'Added Price'),
		(3, 'Added Color'),
		(4, 'Fixed Price Group'),
		(5, 'Homebuyer Accommodation'),
		(6, 'Added Area'),
		(7, 'Fixed Quantity'),
		(8, 'Addressed Design Error')
	) AS SRC (resolution_id, name)
ON TGT.resolution_id = SRC.resolution_id
WHEN MATCHED THEN UPDATE
	SET TGT.name = SRC.name
WHEN NOT MATCHED THEN INSERT (resolution_id, name)
	VALUES (SRC.resolution_id, SRC.name);

SET IDENTITY_INSERT dbo.support_problem_resolutions OFF;

/***********************************************************************************
dbo.support_problem_sources
************************************************************************************/
SET IDENTITY_INSERT dbo.support_problem_sources ON;

MERGE dbo.support_problem_sources AS TGT
USING
	(VALUES
		(1, 'Builder'),
		(2, 'Estimating'),
		(3, 'Pricing'),
		(4, 'Homebuyer'),
		(5, 'Designer')
	) AS SRC (source_id, name)
ON TGT.source_id = SRC.source_id
WHEN MATCHED THEN UPDATE
	SET TGT.name = SRC.name
WHEN NOT MATCHED THEN INSERT (source_id, name)
	VALUES (SRC.source_id, SRC.name);

SET IDENTITY_INSERT dbo.support_problem_sources OFF;

/***********************************************************************************
dbo.scheduling_status
************************************************************************************/
MERGE dbo.scheduling_status AS TGT
USING
	(VALUES
        (0,	'Registered', @author, @date, @author, @date),
        (1,	'Setup', @author, @date, @author, @date),
        (2,	'Scheduled', @author, @date, @author, @date),
        (3,	'Selections', @author, @date, @author, @date),
        (4,	'Complete', @author, @date, @author, @date),
        (5,	'Bustout', @author, @date, @author, @date),
        (6,	'Canceled', @author, @date, @author, @date)
	) AS SRC (status_id, [status], author, create_date, modifier, modified_date)
ON TGT.status_id = SRC.status_id
WHEN MATCHED THEN UPDATE
	SET TGT.status = SRC.[status]
WHEN NOT MATCHED THEN INSERT (status_id, [status], author, create_date, modifier, modified_date)
	VALUES (SRC.status_id, SRC.[status], SRC.author, SRC.create_date, SRC.modifier, SRC.modified_date);

/***********************************************************************************
dbo.scheduling_appointment_types
************************************************************************************/
MERGE dbo.scheduling_appointment_types AS TGT
USING
	(VALUES
		(0, 'First and Final', 'FAF', 2, @author, @date, @author, @date),
		(1, 'First', '1st', 1, @author, @date, @author, @date),
		(2, 'Second', '2nd', 3, @author, @date, @author, @date),
		(3, 'Third', '3rd', 4, @author, @date, @author, @date),
		(4, 'Fourth', '4th', 5, @author, @date, @author, @date),
		(5, 'Fifth', '5th', 6, @author, @date, @author, @date),
		(6, 'Custom', 'C', 7, @author, @date, @author, @date),
		(7, 'PTO', 'PTO', 8, @author, @date, @author, @date),
		(8, 'Meeting', 'MEET', 9, @author, @date, @author, @date),
		(9, 'Browse', 'B', 10, @author, @date, @author, @date),
		(10, 'Note', 'NOTE', 11, @author, @date, @author, @date),
		(13, 'Reselect', 'RESELECT', 12, @author, @date, @author, @date)
	) AS SRC (appointment_type, name, abbrev, sort_order, author, create_date, modifier, modified_date)
ON TGT.appointment_type = SRC.appointment_type
WHEN MATCHED THEN UPDATE
	SET TGT.name = SRC.name,
		TGT.abbrev = SRC.abbrev,
		TGT.sort_order = SRC.sort_order,
		TGT.author = SRC.author,
		TGT.create_date = SRC.create_date,
		TGT.modifier = SRC.modifier,
		TGT.modified_date = SRC.modified_date
WHEN NOT MATCHED THEN INSERT (appointment_type, name, abbrev, sort_order, author, create_date, modifier, modified_date)
	VALUES (SRC.appointment_type, SRC.name, SRC.abbrev, SRC.sort_order, SRC.author, SRC.create_date, SRC.modifier, SRC.modified_date);

/***********************************************************************************
dbo.scheduling_message_types
************************************************************************************/
MERGE dbo.scheduling_message_types AS TGT
USING
	(VALUES
		(0, 'System', @author, @date, @author, @date),
		(1, 'Info', @author, @date, @author, @date),
		(2, 'Notify', @author, @date, @author, @date),
		(3, 'Conflict', @author, @date, @author, @date),
		(4, 'Scheduled', @author, @date, @author, @date),
		(5, 'Rescheduled', @author, @date, @author, @date),
		(6, 'Reassigned', @author, @date, @author, @date),
		(7, 'Canceled', @author, @date, @author, @date),
		(8, 'Completed', @author, @date, @author, @date),
		(9, 'Request', @author, @date, @author, @date),
		(10, 'IM', @author, @date, @author, @date),
		(11, 'CheckIn', @author, @date, @author, @date),
		(12, 'NoShow', @author, @date, @author, @date),
		(13, 'Communication', @author, @date, @author, @date),
		(14, 'TalkedToBuyer', @author, @date, @author, @date),
		(15, 'LeftVoicemail', @author, @date, @author, @date),
		(16, 'LeftHumanMessage', @author, @date, @author, @date),
		(17, 'NoAnswer', @author, @date, @author, @date),
		(18, 'DeclinedAppointment', @author, @date, @author, @date),
		(19, 'ApprovedProvisionalAppointment', @author, @date, @author, @date),
		(20, 'RejectedProvisionalAppointment', @author, @date, @author, @date)
	) AS SRC (message_type, message_type_name, author, create_date, modifier, modified_date)
ON TGT.message_type = SRC.message_type
WHEN MATCHED THEN UPDATE
	SET TGT.message_type_name = SRC.message_type_name,
		TGT.author = SRC.author,
		TGT.create_date = SRC.create_date,
		TGT.modifier = SRC.modifier,
		TGT.modified_date = SRC.modified_date
WHEN NOT MATCHED THEN INSERT (message_type, message_type_name, author, create_date, modifier, modified_date)
	VALUES (SRC.message_type, SRC.message_type_name, SRC.author, SRC.create_date, SRC.modifier, SRC.modified_date);

/***********************************************************************************
dbo.scheduling_roles
************************************************************************************/
MERGE dbo.scheduling_roles AS TGT
USING
	(VALUES
		('BC18D1BC-C930-41D2-83B6-13B276DCAD6B', @author, @date, @author, @date),
		('EBE7EAE2-488B-4158-BB25-24804B9AA1E6', @author, @date, @author, @date),
		('4D9E9F34-2F62-4B17-8E24-4665DA40E326', @author, @date, @author, @date),
		('A675A67B-4648-43F4-814A-591884A64EC4', @author, @date, @author, @date),
		('A0A9C6C5-A686-48EB-B125-6901F74AA435', @author, @date, @author, @date),
		('EFC34C28-6A74-40D0-A7A6-F9D3E6040609', @author, @date, @author, @date),
		('76FC6A8E-D27E-4EEC-93A9-2ED4B1C10156', @author, @date, @author, @date)
	) AS SRC (role_id, author, create_date, modifier, modified_date)
ON TGT.role_id = SRC.role_id
WHEN NOT MATCHED BY TARGET THEN INSERT (role_id, author, create_date, modifier, modified_date)
	VALUES (SRC.role_id, SRC.author, SRC.create_date, SRC.modifier, SRC.modified_date)
WHEN NOT MATCHED BY SOURCE THEN DELETE;

/***********************************************************************************
dbo.scheduling_settings
************************************************************************************/
MERGE dbo.scheduling_settings AS TGT
USING
	(VALUES
		('766C56AC-8060-4A6C-ABA6-83553D17D47F', 'cannot_create_buyer_appointments', 'Cannot Create Buyer Appointments', 'When on, no buyer appointments can be created of any kind. Does not affect a user''s ability to create appointment "slots" on the buyer card.', 'boolean'),
		('EE6D1E0E-D7E4-44AB-BCFE-7C6215FCD813', 'create_provisional_buyer_appointments', 'Create Provisional Buyer Appointments', 'When on, if a user can create a buyer appointment then the type created is "provisional".', 'boolean'),
		('0570448C-1E73-46E9-987E-D30D4139F611', 'hide_designer_names', 'Hide Designer Names', 'Hide Designer Names', 'boolean'),
		('0FC8BAC4-7875-4118-A96E-D7AE0AE8BCB4', 'hide_appointment_info', 'Hide Appointment Info', 'Hide Appointment Info', 'boolean'),
		('C29C8867-7834-478D-8F3F-03069EACAD28', 'cannot_edit_appointments', 'Cannot Edit Appointments', 'If on, the user cannot edit an existing appointment start time, end time, duration or dates. They also cannot change the format or location. They also cannot delete the appointments. Currently this applies to both normal and provisional buyer appointments.', 'boolean'),
		('4794ED03-6255-49C1-9AF5-616889967F89', 'hide_buyer_info', 'Hide Buyer Info', 'Hide Buyer Info', 'boolean'),
		('0F5566BB-05D5-47EA-9006-D0B37B1B5990', 'view_reports', 'View Reports', 'View Reports', 'boolean'),
		('657CC16A-85A6-4417-90AD-D91D8021246B', 'cannot_create_designer_appointments', 'Cannot Create Designer Appointments', 'If on, the user cannot create designer appointments using the + button or using the multi-appointment interface.', 'boolean'),
		('7F9CDBEB-5BA7-4F4F-8D2F-13B4D49B1DB8', 'can_edit_user_settings', 'Can Edit User Settings', 'When on, a user can edit other user''s settings.', 'boolean'),
		('1241BDB6-B4A3-4691-AEB4-1BC2B5E4CF6A', 'cannot_view_edit_buyer_notes', 'Cannot View/Edit Buyer Notes', 'If on, the user cannot view or edit the buyer notes on the buyer card or in the buyer info dialog.', 'boolean'),
		('3B1F4494-A553-4175-876B-D7D823F428C8', 'can_approve_reject_provisional_appointments', 'Can Approve/Reject Provisional Appointments', 'If on, the user can approve or reject provisional appointments.', 'boolean'),
		('B5A3CC62-749D-4643-9DD4-680CE521E03B', 'show_other_builder_appointments_as_busy', 'Show Other Builder Appointments as Busy', 'If on, the user will see ''busy'' for builder appointments when the builder is not one of the user''s builders.', 'boolean'),
		('2929B54A-6416-4B2C-8BA5-327417FC343D', 'show_designer_events_as_busy', 'Show Designer Events as Busy', 'If on, the user will see ''busy'' for designer events (PTO, meetings, etc.)', 'boolean')
	) AS SRC (id, setting_key, setting_name, setting_description, data_type)
ON TGT.id = SRC.id
WHEN MATCHED AND TGT.setting_name <> SRC.setting_name THEN 
	UPDATE SET TGT.setting_name = SRC.setting_name
WHEN NOT MATCHED BY TARGET THEN 
	INSERT (id, setting_key, setting_name, setting_description, data_type)
	VALUES (SRC.id, SRC.setting_key, SRC.setting_name, SRC.setting_description, SRC.data_type)
WHEN NOT MATCHED BY SOURCE THEN 
	DELETE;

/***********************************************************************************
dbo.scheduling_appointment_templates_detail
************************************************************************************/
MERGE dbo.scheduling_appointment_templates_detail AS TGT
USING
	(VALUES
		('75BD4269-7030-42A0-91D6-23AD23A87E1D', '0144D84E-E15D-443F-9A67-38A8039E2AD8', 1, 120, @author, @date, @author, @date),
		('75BD4269-7030-42A0-91D6-23AD23A87E1D', '2A44EBCD-245D-4DCD-A6C0-514CB3E6917D', 3, 120, @author, @date, @author, @date),
		('75BD4269-7030-42A0-91D6-23AD23A87E1D', '9573C519-0D2B-4BD9-AD91-9C390031AF18', 2, 120, @author, @date, @author, @date),
		('B74BEB6C-ED6C-4752-8906-B5ADC93BF410', '30DB38F6-7715-4864-993B-4806E928C084', 0, 240, @author, @date, @author, @date)
	) AS SRC (template_id, template_appointment_id, appointment_type, duration, author, create_date, modifier, modified_date)
ON TGT.template_appointment_id = SRC.template_appointment_id
WHEN NOT MATCHED THEN INSERT (template_id, template_appointment_id, appointment_type, duration, author, create_date, modifier, modified_date)
	VALUES (SRC.template_id, SRC.template_appointment_id, SRC.appointment_type, SRC.duration, SRC.author, SRC.create_date, SRC.modifier, SRC.modified_date);

/***********************************************************************************
dbo.features
************************************************************************************/
MERGE dbo.features AS TGT
USING
	(VALUES
		(1, 'notify_sc_session_complete', 'Notify Sales Counselors when Session is Complete', 'When ON the system emails the Sales Counselor that registered the user when the Session is marked Complete. When OFF no notification is sent. Multiple emails are sent as status changes.'),
		(2, 'notify_sc_welcome_email', 'Notify Sales Counselors when Welcome E-mail is Sent', 'When ON the system emails the Sales Counselor that registered the user when the Welcome E-mail is sent.'),
		(3, 'selections_report_legal_paper_size', 'Use Legal Paper Size for Selections Report', 'When ON the Selections Report will default to Legal page size. When OFF the report will default to Letter page size.'),
		(7, 'selections_report_html_form', 'Show HTML Selection Report for Non-Finalized Sessions', 'When ON the system will generate an HTML version of the Selections Report when the Session status is Active or Pending. This version of the report is faster to generate but has no page breaks.'),
		(8, 'show_homebuyer_report_widget', 'Show completed session reports on the Homebuyer Dashboard', 'When "Visible to Homebuyer" is checked on the session and the session is Complete, a widget is displayed on the buyer''s dashboard to view the completed Selections Report.'),
		(10, 'obnoxious_pricing_disclaimer', 'Show extra Option Pricing disclaimer', 'When ON an additional disclaimer will be shown. This disclaimer is also shown every 15 minutes.'),
		(12, 'visual_catalog_cards', 'Visual Catalog Cards', 'When ON the newer non-estimated card layouts will be used in Option Pricing. When OFF the legacy style of cards (wide) will be displayed.'),
		(13, 'color_visualizer', 'Design Selections Product Color Visualizer', 'If the designer has Area Grouping toggled ON for a design session then the Color Coordinator module will be displayed in the top toolbar.'),
		(14, 'monthly_payment_calculator', 'Interactive Monthly Payment Calculator', 'When ON the new version of the Monthly Payment calculator is shown on the buyer''s dashboard. When OFF the legacy version of the calculator is shown.'),
		(15, 'selection_report_estimated_option_breakout_pricing', 'Selection Report: Breakout Pricing for Estimated Options', 'When ON the Selections Report breaks out pricing for each individual step of the selections wizard.'), 
		(16, 'home_detail_documents' , 'Documents: Home Details', 'When ON Echelon documents are available from Homebuyer Summary.'),
		(17, 'disallow_hb_access' , 'Disallow HB Access', 'No buyers are allowed to login for this builder.'),
		(18, 'design_my_home', 'Design My Home', 'When ON and a buyer''s plan is Contracted, Design My Home is shown instead of Option Pricing on their dashboard. When OFF Option Pricing only is shown.'),
		(19, 'invert_builder_logo', 'Invert Builder Logo', 'When ON the colors in the builder logo are inverted so that a light colored logo appears dark on white paper for the report.'),
		(20, 'use_prospective_profile_plan_status', 'Use Prospective Profile Plan Status', 'Should be ON. When OFF, instead of Prospective the statuses Inactive and Active are displayed. All logic that uses Prospective instead uses Inactive.'),
		(21, 'manually_create_primary_session_on_contract', 'Manually Create Primary Session on Contract', 'When ON sessions must be manually created for buyers. When OFF, a session is automatically created when the buyer is Contracted and it is marked Primary (for DMH).'),
		(22, 'room_visualization', 'Room Visualization', 'When ON, buyers in Design My Home can visualize the room scene associated with the Room. A valid scene must be configured in VEO Admin.'),
		(23, 'builder_cost_selections_report', 'Builder Cost Selections Report', 'Should be OFF for now. Still in development.'),
		(24, 'welcome_to_veo', 'Welcome To VEO', 'If the module is enabled in Dashboard Modules, it shows the Welcome To VEO module.'),
		(25, 'enable_page_tours', 'Enable Page Tours', 'When ON the buyer Page Tours are displayed. Once viewed (or skipped) on a machine they no longer show. Can be launched from Help Menu.'),
		(26, 'auto_screen_capture', 'Enable Auto Screen Capture', 'When ON the current screen is captured in the Support Request dialog and attached to the support email.'),
		(28, 'buyer_survey', 'Buyer Survey', 'When ON a buyer survey button appears in Homebuyer Summary, which launches a survey in a dialog.'),
		(29, 'require_lot_block', 'Address AND Lot/Block required for contracting', 'When ON, the Address AND Lot/Block are required to Contract a buyer.'),
		(30, 'apply_retail_sales_tax', 'Apply Retail Sales Tax', 'If ON, will add a sales tax line to the Selections Reports which is the builder sales tax rate x selections subtotal. If the builder tax rate is 0% (or undefined) then the tax will not appear on the report.'),
		(31, 'sms_notifications', 'SMS Notifications', 'When ON the Buyer Survey (SMS) button appears and a link can be sent to the buyer''s phone. Additionally, SMS notifications will be sent to buyers from the VEO Scheduler for various scheduling events.'),
		(32, 'buyer_experience', 'Buyer Experience', 'When ON and impersonating a Buyer, the user will see the home buyer''s dashboard modules and be able to interact with them just as if they were the home buyer. They will also see a Buyer Experience toggle that will turn off this experience. When OFF the logged in user sees the older version of the impersonated buyer dashboard and their own navigational menu.'),
		(33, 'wishlist_by_item_number', 'Wishlist by Item Number', 'When ON only Catalog (non-estimated) options with Item Number populated can be wishlisted. When OFF wishlisted items are stored by using the GPC Id. Note: for the GPC mode it means options with the same GPC will get wishlisted as a group'),
		(34, 'designer_documents', 'Designer Documents', 'When ON, users with permission will see a Manage Designer Documents screen in VDS that allows them to upload, edit and remove designer documents. When OFF this screen is not available in the nav menu for that builder.'),
		(35, 'import_budget_items_to_dmh', 'Import Budget Item to DMH', 'When ON a buyer in Design My Home sees a dialog to import catalog and price levels into their session.'),
		(36, 'remove_sinks', 'No Sinks In Wizard', 'If ON: The Countertop Bill of Materials with sink related bom lines in VDS will have no options available to be selectable for, this keeps the price as 0 for that sink as part of the countertop bom. If OFF: If a sink is inside of a bill of material in Echelon, the designer will be offered the option to select that sink as part of the countertops wizard. Any sink selections (upgrades, etc.) made as part of this selection will be part of that countertop builds bom.'),
		(37, 'real_time_feedback', 'Real Time Feedback', 'When ON a user in VDS may get a quick survey dialog to give us feedback about their experience in the app.'),
		(38, 'set_pattern_qty_to_one', 'Set Pattern Qty to One', 'Adjust the pattern labor quantity from number of square feet to a single charge for the area.'),
		(39, 'no_charge_pattern', 'No Charge Pattern', 'When this flag is ON, the designer can remove the pattern charge.'),
		(40, 'session_option_pricing', 'Display Session Pricing in Option Pricing', 'When ON, option pricing will display data from the first Active session found for the buyer. When OFF, option pricing will always use live pricing pulled directly from Echelon.'),
		(41, 'indicate_lay_direction', 'Indicate Lay Direction', 'If ON the designer can rotate a selection on the design selections area card to indicate the lay direction.'),
		(42, 'send_email_notifications', 'Send E-Mail Notifications', 'When ON the system will allow you to send Welcome e-mails and account change notifications. When OFF Welcome e-mails can still be manually re-sent to a user.'),
		(43, 'allow_dd_buyer_packet', 'Allow Designer Document in Buyer''s Packet', 'When ON, a user with permissions to edit Designer Documents can mark documents to make them available on the Buyer''s selections report.'),
		(44, 'builder_markup_hb_pricing', 'Builder Markup HB Pricing', 'If ON uses staggered margins to calculate repricing. Must be configured in Echelon the same way for it to work. If OFF we only reprice when patterns are selected.'),
		(45, 'selections_report_hide_missing_images', 'Hide Missing Images on Selections Report', 'When ON, any missing image placeholders will be hidden on the buyer''s selections report.'),
		(46, 'edit_catalog_item_quantities', 'Buyers Can Edit Catalog Item Quantities', 'When ON, the user (including homebuyers) can modify the quantity for non-estimated options in Option Pricing and Design My Home.'),
		(47, 'selections_report_hide_pricing', 'Hide Pricing on Buyer Selections Report', 'When ON the button does not appear and the report does not show pricing. When OFF the Prices button appears on the Selections Report dialog.'),
		(48, 'visualize_catalog_items', 'Visualize Catalog Items', 'When ON any non-estimated items that have an area_id / sub_area_id entered for Area / SubArea that roll up into a room in Design My Home will be displayed with the estimated item selections and potentially visualized.'),
		(49, 'embedded_visualizer', 'Embedded Visualizer', 'When ON displays the room scene directly in product selection rather than a dialog in Design My Home.'),
		(50, 'sub_areas_in_dmh', 'Buyers can select options for Sub-Areas', 'When ON, buyers in Design My Home will see sub-areas for the Room and be able to make selections specific to those sub-areas.'),
		(51, 'visualization_program', 'Visualization Program Enabled', 'When ON, only options that are part of the organization''s visualization program will be visualized in Design My Home.'),
		(52, 'visualize_all_selections_in_home', 'Visualize All Selections in Home', 'When On, for each call to render the current room scene, all selections are sent to the visualization vendor so that selections that may be visible in other rooms are displayed.'),
		(53, 'builder_overrides', 'Support Builder Overrides', 'When ON, estimated item overrides per builder for Part ID, Part Name and Image are displayed in VDS in place of the Echelon data. Additionally, users can search or filter by overridden Part IDs or Part Names.'),
		(54, 'hide_pricing_for_prospective_buyers', 'Hide Pricing for Prospective Buyers', 'When On, prospective homebuyers will not see pricing in Option Pricing.'),
		(55, 'use_new_option_pricing_layout', 'DEV ONLY: Use New Option Pricing Layout', 'When ON, the new Option Pricing layout will be used.'),
		(56, 'hide_pricing_for_contracted_buyers', 'Hide Pricing for Contracted Buyers', 'When On, contracted buyers will not see pricing in Option Pricing. Design My Home customers will still see pricing. NOTE: if you turn this flag on, you should also turn on the flag for ''Hide Pricing for Prospective Buyers'''),
		(57, 'generate_separate_pattern_detail_reports', 'Generate Separate Pattern Detail Reports', 'When ON, separate pattern detail reports are generated as part of Session completion.'),
		(58, 'auto_include_catalog_docs_on_selections_report', 'Automatically Include Catalog Documents on Selections Report', 'When on, any documents associated with selected catalog items will by default be marked for inclusion on the selections packet.'),
		(59, 'catalog_documents_support', 'Catalog Documents Support', 'When on, designers can view and choose catalog documents related to their session selections for inclusion in the selections report packet.'),
		(60, 'use_header_footer_additional_product_docs', 'Include headers/footers for catalog & designer docs', 'When on, one section header and a signatory footer is present on each page of the appended catalog and/or designer documents in the selections report.'),
		(61, 'builder_option_codes', 'Support Builder Option Codes', 'When on, the system will attempt to fetch builder options codes for estimated items from Echelon during integration processes, and potentially in selections report generation.'),
		(62, 'display_training_links', 'Display User Training Links', 'When on, if a training link is defined for a builder and role, a link is displayed in VDS that opens a URL with training material in a new browser tab.'),
		(63, 'require_deposit_for_upgrades', 'Require Deposit for Upgrades', 'When on, the buyer will be informed about and see a projected deposit amount for their design upgrades based on their budget. They will also see a final value for the deposit on the selections report.'),
		(64, 'selections_report_condensed_view', 'Selections Report - Condensed View', 'When on, a condensed view of the selections report will be generated by default, minimizing white space.'),
		(66, 'use_enhanced_categories', 'Use Enhanced Product Categories', 'When on, VDS will support enhanced category features such as: custom names, nested categories and custom sort orders.'),
		(67, 'time_on_site_tracking', 'Time On-Site Tracking', 'When ON, an event is recorded at a certain frequency for all users associated for this builder.'),
		(68, 'full_catalog_view_dmh', 'Full Catalog View in DMH', 'When ON, DMH will show a different view than the traditional rooms/products tabs. This view will have a nav menu covering the entire catalog of estimated and non-estimated items. For now, only non-estimated items are supported.'),
		(69, 'assigned_communities', 'Restrict Users to Assigned Communities', 'When this flag is ON, and a user is assigned to at least one community, they cannot see or generate data for any communities outside those assigned. This includes: user registration, impersonation, plan creation and viewing options data.'),
	    (70, 'remove_duplicate_items_op', 'Remove duplicate items in Option Pricing', 'When ON, Option Pricing will show the highest price option from those that share a Category, Description and Item Number (ignoring case) - and discards the others.')
	) AS SRC (id, lookup_key, [name], [description])
ON TGT.id = SRC.id
WHEN MATCHED AND TGT.lookup_key <> SRC.lookup_key OR TGT.[description] <> SRC.[description] OR TGT.[name] <> SRC.[name] THEN UPDATE
	SET TGT.lookup_key = SRC.lookup_key,
		TGT.[description] = SRC.[description],
		TGT.[name] = SRC.[name]
WHEN NOT MATCHED BY TARGET THEN INSERT (id, lookup_key, [name], [description])
	VALUES (SRC.id, SRC.lookup_key, SRC.[name], SRC.[description])
WHEN NOT MATCHED BY SOURCE THEN DELETE;


/***********************************************************************************
dbo.plan_document_types
************************************************************************************/
MERGE dbo.plan_document_types AS PDT
USING
	(VALUES
		('SESSION_SELECTIONS', 'The session selections report')
	) AS SRC (doc_type, [description])
ON PDT.doc_type = PDT.doc_type
WHEN MATCHED THEN UPDATE
	SET PDT.doc_type = SRC.doc_type,
		PDT.[description] = SRC.[description]
WHEN NOT MATCHED BY TARGET THEN INSERT (doc_type, [description])
	VALUES (SRC.doc_type, SRC.[description]);

/***********************************************************************************
dbo.plan_budget_values_names
************************************************************************************/
MERGE dbo.plan_budget_values_names AS PBVN
USING
	(VALUES
		(1, 'Home Price', 'currency', 1, 1, 0),
		(2, 'Interest Rate', 'percentage', 1, 1, 0),
		(3, 'Loan Term', 'integer', 1, 1, 0),
		(4, 'Home Down Payment', 'currency', 0, 1, 0),
		(5, 'Home Allowance', 'currency', 0, 0, 1),
		(6, 'Upgrades Incentive', 'currency', 0, 1, 1),
		(7, 'Additional Design Deposit', 'currency', 0, 0, 0),
		(8, 'Special Assessments', 'currency', 0, 0, 1),
		(9, 'Property Tax Rate', 'percentage', 0, 0, 1),
		(10, 'Homeowners Association Dues', 'currency', 0, 0, 1),
		(11, 'Homeowners Insurance Rate', 'percentage', 0, 0, 1)
	) AS SRC ([id], [name], [data_type], [required], [enabled_by_default], [community_default])
ON PBVN.id = SRC.id
WHEN MATCHED AND PBVN.[name] <> SRC.[name] OR PBVN.[data_type] <> SRC.[data_type] OR PBVN.[required] <> SRC.[required] OR PBVN.[enabled_by_default] <> SRC.[enabled_by_default] OR PBVN.[community_default] <> SRC.[community_default] THEN UPDATE
	SET PBVN.[name] = SRC.[name],
	PBVN.[data_type] = SRC.[data_type],
	PBVN.[required] = SRC.[required],
	PBVN.[enabled_by_default] = SRC.[enabled_by_default],
	PBVN.[community_default] = SRC.[community_default]
WHEN NOT MATCHED BY TARGET THEN INSERT (id, [name], [data_type], [required], [enabled_by_default], [community_default])
	VALUES (SRC.id, SRC.[name], SRC.[data_type], SRC.[required], SRC.[enabled_by_default], [community_default]);

/***********************************************************************************
dbo.restrict_application_product
************************************************************************************/
MERGE dbo.restricted_application_product AS TGT
USING
	(VALUES
		('63AFC65A-FD78-49A9-8174-98E88D22893E', '49687F1F-DEC8-484D-B7C3-C193DA7C873D', '1', '1')
	) AS SRC (id, organization_id, application_id, product_id)
ON TGT.id = SRC.id
WHEN MATCHED THEN UPDATE
	SET TGT.organization_id = SRC.organization_id,
	TGT.application_id = SRC.application_id,
	TGT.product_id = SRC.product_id
WHEN NOT MATCHED THEN INSERT (id, organization_id, application_id, product_id)
	VALUES (SRC.id, SRC.organization_id, SRC.application_id, SRC.product_id);

/***********************************************************************************
dbo.ThemeVariable
This section is technical debt. Delete when able.
************************************************************************************/
MERGE INTO ThemeVariable AS tgt
USING (
    VALUES
        ('6F9619FF-8B86-D011-B42D-00CF4FC964FF', 'btn-primary', NULL, @author, @date, @author, @date),
        ('9B2E04B0-5A69-4B28-BDF2-21AB72F33C7D', 'btn-primary-hover', NULL, @author, @date, @author, @date),
        ('7A25E98F-99B7-4FCF-95A4-D3A839F6CFFB', 'btn-primary-active', NULL, @author, @date, @author, @date),
        ('E72AC8C7-7657-4C92-B659-09D6F7AB0A58', 'btn-secondary', NULL, @author, @date, @author, @date),
		('2c3d5a3a-7cf8-4b30-b8b1-22cf72939c2a', 'btn-secondary-hover', NULL, @author, @date, @author, @date),
		('2bd1fae1-3eb4-473c-ad01-665a680329d2', 'btn-secondary-active', NULL, @author, @date, @author, @date),
		('970153e1-77d3-49e4-8aec-688decd491e5', 'btn-grouped-current', NULL, @author, @date, @author, @date),
		('9f6d2ba2-f04a-461d-8930-10b7204e9685', 'btn-grouped-hover', NULL, @author, @date, @author, @date),
		('a0123f08-d9fe-4561-a45f-35a72008a0a9', 'btn-grouped-border', NULL, @author, @date, @author, @date),
		('c555bf38-5513-4a48-8f76-bae211d88280', 'btn-grouped-bg', NULL, @author, @date, @author, @date),
		('182f7c73-5498-4931-a10c-987da5aa0328', 'btn-completeOrientationStep', NULL, @author, @date, @author, @date),
		('166c17a3-d7f1-4dbf-b722-b317ef5e25c3', 'btn-completeOrientationStep-hover', NULL, @author, @date, @author, @date),
		('e8c7ba73-2b19-45e2-a19b-a58a18eae22b', 'select-top', NULL, @author, @date, @author, @date),
		('e6e768b2-8bbc-445c-ab18-27b97d936316', 'select-btm', NULL, @author, @date, @author, @date),
		('3bc2ab20-1ed6-4e05-8f1f-0bfc85cde1fa', 'textarea-bg', NULL, @author, @date, @author, @date),
		('1633c469-6595-48b5-abf0-ede5070fad48', 'switch-bg', NULL, @author, @date, @author, @date),
		('ad3e75d6-b6cb-4693-83b1-2c42bbd41055', 'table-header-color', NULL, @author, @date, @author, @date),
		('42466c32-3b3d-49f3-b84a-c5653d4937ba', 'bg-light-top', NULL, @author, @date, @author, @date),
		('49701b99-7d3c-488e-92cd-ba7850e1e4d2', 'bg-light-btm', NULL, @author, @date, @author, @date),
		('f9a43def-4295-4027-82cf-55fb21f42f9a', 'bg-white', NULL, @author, @date, @author, @date),
		('cd145038-c22a-4f95-943a-82b0df974ea3', 'bg-light', NULL, @author, @date, @author, @date),
		('f1466748-399a-42f9-9216-ca2deed095cf', 'bg-emphasis', NULL, @author, @date, @author, @date),
		('51e1bbc9-c563-48a4-9194-b9afeb33059e', 'bg-dark', NULL, @author, @date, @author, @date),
		('4f07e03d-5deb-4bd5-b5ac-6f8fcf8e3c9c', 'bg-dark-noImage', NULL, @author, @date, @author, @date),
		('1b8bd1b5-b8db-43b7-921c-b96391eb130f', 'text-darkest', NULL, @author, @date, @author, @date),
		('ba71c37b-afb3-4fb7-8e24-b9cb514ebb5f', 'text-dark', NULL, @author, @date, @author, @date),
		('6ee51a8c-9116-4590-8a98-3d30aa9bd3d8', 'text-light', NULL, @author, @date, @author, @date),
		('3fc5747e-01f9-4dfe-8940-bc865515dbf3', 'text-menu', NULL, @author, @date, @author, @date),
		('ca639bdc-3bbf-4d71-a463-1742b4a71b44', 'text-copyright', NULL, @author, @date, @author, @date),
		('485d2910-0fb7-427d-9efc-b78dbea466c4', 'text-primary', NULL, @author, @date, @author, @date),
		('2d74f567-8a3e-4e3b-8fe1-1dc848d5ff75', 'text-primary-lighter', NULL, @author, @date, @author, @date),
		('385782be-edb7-494a-a3a3-75ec51d5817f', 'text-primary-alt1', NULL, @author, @date, @author, @date),
		('88244c34-7aea-4707-b1db-afc5fab86c96', 'text-disclaimerWelcomeMsg', NULL, @author, @date, @author, @date),
		('36523bb3-def2-40d2-8564-46bc65686f03', 'color-primary', NULL, @author, @date, @author, @date),
		('82573c3d-6013-4936-87e9-4f6fdd31e387', 'color-primary-alt1', NULL, @author, @date, @author, @date),
		('2105492a-aab7-4128-a348-e3790216b9bb', 'color-icon-light', NULL, @author, @date, @author, @date),
		('7ebbc181-8c6b-40b3-9ccf-7c5258f674af', 'color-icon-primary', NULL, @author, @date, @author, @date),
		('2715370b-f01d-4ab8-82ff-cde5da1b8093', 'font-main', NULL, @author, @date, @author, @date),
		('9eae21d0-1a2c-40f9-8de2-1184875b1365', 'filter-main-site-header', NULL, @author, @date, @author, @date),
		('56ff485d-2339-494a-9e60-f04394b8fe7c', 'bg-main-site-header', NULL, @author, @date, @author, @date),
		('baf69a32-0b84-4f7f-a378-3a866d46ef4d', 'color-main-site-header-text-muted', NULL, @author, @date, @author, @date),
		('4262daf4-7d9c-4e18-8d43-145b86a17f0b', 'color-main-site-header-text', NULL, @author, @date, @author, @date),
		('b251b8a4-ad56-4c6f-b3af-b55eeb0160f7', 'color-main-site-header-vds-logo-color', NULL, @author, @date, @author, @date),
		('17a1645a-3fa9-4632-978d-45908cf3096a', 'color-icon-signOut', NULL, @author, @date, @author, @date),
		('b1e9cc51-1b9c-45ce-9367-2a1aa3f34134', 'color-icon-training', NULL, @author, @date, @author, @date),
		('cb1a5719-5e36-49b5-bf8c-60fa7feeaa44', 'color-training-text', NULL, @author, @date, @author, @date),
		('7316de13-e173-4a11-8b65-afc16ae93a04', 'bg-title-bar', NULL, @author, @date, @author, @date),
		('df73b4cd-322d-49b8-863d-a52530f9caf9', 'color-title-bar-text', NULL, @author, @date, @author, @date),
		('eda0a5a9-6b35-4648-99ce-8d73bfe0e205', 'bg-menu-inactive', NULL, @author, @date, @author, @date),
		('c19b0c0c-e353-4f62-983f-9a1d0e58b268', 'bg-menu-active', NULL, @author, @date, @author, @date),
		('d7efc542-433b-4c11-be4f-ae639c1fa984', 'bg-cancelImpersonation', NULL, @author, @date, @author, @date),
		('0c3eaef6-396a-4d8e-9fb8-91aad44c94cb', 'bg-userImpersonation-userItem', NULL, @author, @date, @author, @date),
		('ad7da750-379c-4aa8-b55b-7a6af8b0439a', 'border-left-menu-option-hover', NULL, @author, @date, @author, @date),
		('3dc9aa89-defe-4961-b454-275f1f3c8239', 'color-cancelImpersonation', NULL, @author, @date, @author, @date),
		('75b82c6c-4dc0-4d65-b6a1-50a888344f76', 'icon-titleBar-mobileMenu-dots', NULL, @author, @date, @author, @date),
		('3c0a1ef6-0e99-40dc-82ee-660a5fa07a55', 'bg-footer', NULL, @author, @date, @author, @date),
		('11003248-ca5d-49da-bf11-02f83ed59df8', 'bg-footer-contentSupportEmailArea', NULL, @author, @date, @author, @date),
		('1aabbf94-f7f3-4a87-8301-7eabb4df5cde', 'bg-footer-contentSupportEmailArea-hover', NULL, @author, @date, @author, @date),
		('a8ceee01-56b1-4838-b7cb-2edf67de7f32', 'bg-footer-update', NULL, @author, @date, @author, @date),
		('e9ce1c6c-6830-4c87-89b6-11ff44c66e87', 'bg-footer-supportEmailQuestionMark', NULL, @author, @date, @author, @date),
		('4400d156-6ac2-49d3-b360-525dbed13352', 'color-footer-update', NULL, @author, @date, @author, @date),
		('5f2cc53b-7ccc-49bf-aad2-2e08894e4721', 'color-footer-helpMenu-item', NULL, @author, @date, @author, @date),
		('561d228a-f990-4728-96e0-bce6213dfd6a', 'text-footer-systemMessage', NULL, @author, @date, @author, @date),
		('621857b5-bf6b-4eec-bac2-2583ca507fad', 'bg-sessionCard', NULL, @author, @date, @author, @date),
		('ae73d644-a1b0-4739-b890-e8944a4f042e', 'bg-sessionCard-confirm', NULL, @author, @date, @author, @date),
		('8823b8e7-8c49-47b9-bacf-db6a6cd253e3', 'text-sessionCard-primary-1', NULL, @author, @date, @author, @date),
		('8abb7863-a956-4ba5-849b-28ffbd8683f7', 'text-sessionCard-primary-2', NULL, @author, @date, @author, @date),
		('35219fd7-2178-41c4-ae3d-a99024292596', 'font-size-sessionCard-currentStatus', NULL, @author, @date, @author, @date),
		('74581df5-29b4-4e91-ac77-60d8fdf0b433', 'color-sessionCard-actionBlock-border', NULL, @author, @date, @author, @date),
		('51e04db9-1962-40cf-81ef-462aa14c9ccb', 'color-sessionCard-actionBlock-title', NULL, @author, @date, @author, @date),
		('ca10d0b6-f330-4d73-b6e5-b8f0febd3633', 'bg-sessionCard-actionBlock', NULL, @author, @date, @author, @date),
		('5c888bd5-4884-446d-8912-a44dd9abc2f5', 'color-profileStatus-other', NULL, @author, @date, @author, @date),
		('061d05dc-eb25-442c-84e6-293f535eaee6', 'color-profileStatus-contracted', NULL, @author, @date, @author, @date),
		('d91ad9e1-7c2e-45ec-bda6-04bedccf41a1', 'color-profileStatus-complete', NULL, @author, @date, @author, @date),
		('53ec7ab0-15d1-4bfb-a628-0d14071f88ac', 'color-profileStatus-bustout', NULL, @author, @date, @author, @date),
		('1f577ddf-d0ad-4d48-85e1-59f2bd03e111', 'bg-hbDashboard-header', NULL, @author, @date, @author, @date),
		('2dbb8dd2-f848-47ef-8580-bfe20f337e9e', 'bg-hbDashboard', NULL, @author, @date, @author, @date),
		('681c250a-e611-4bb5-897a-ff214ae9a06e', 'bg-hbDashboard-orientationStep-active', NULL, @author, @date, @author, @date),
		('19f280b7-b9ec-42c6-acf9-0c3da0172b35', 'bg-hbDashboard-orientationStep-active-light', NULL, @author, @date, @author, @date),
		('74de0bfd-2d74-4e54-ba97-95bcbb82b5bd', 'bg-hbDashboard-orientationStep-inactive', NULL, @author, @date, @author, @date),
		('d693745b-f13c-4036-b3fa-c251959afb44', 'bg-hbDashboard-orientationStep-inactive-light', NULL, @author, @date, @author, @date),
		('5138cb95-cbb2-4e70-9d10-a57dae40620d', 'bg-hbDashboard-moduleComplete', NULL, @author, @date, @author, @date),
		('98cfd818-5607-4400-94bd-0ed1f6cba047', 'bg-hbDashboard-progressBar', NULL, @author, @date, @author, @date),
		('d2f6e311-3cf8-451a-b0d9-f5eaa9316ee6', 'bg-optionPricing-areaHeader', NULL, @author, @date, @author, @date),
		('d2cc8328-892f-4020-a33a-4408044ca8c5', 'bg-optionPricing-areaHeader-hover', NULL, @author, @date, @author, @date),
		('8f22bd90-90aa-4390-81df-cae871fc1886', 'bg-optionPricing-priceLevel-selected', NULL, @author, @date, @author, @date),
		('05c01f25-2708-48d3-a605-7b49be96be29', 'bg-optionPricing-leftPane', NULL, @author, @date, @author, @date),
		('33b971a1-1a95-4a2b-b438-b076b23a1f5b', 'bg-optionPricing-rightPane', NULL, @author, @date, @author, @date),
		('2f9460f2-2aa1-4114-867b-57a0f53bc870', 'bg-optionPricing-priceLevelHeader', NULL, @author, @date, @author, @date),
		('3EA211D7-515C-4319-8966-3543CFB2A745', 'bg-optionPricing-priceLevelHeader-hover', NULL, @author, @date, @author, @date),
		('1e2ed870-8d3e-4907-9581-7ce73c3f9d6c', 'bg-optionPricing-selectedCell', NULL, @author, @date, @author, @date),
		('2b56f15c-c6d3-4e63-bee3-ab10b5d67e51', 'bg-optionPricing-productSamplesTab-priceLevel-header', NULL, @author, @date, @author, @date),
		('4726de51-ff47-4497-9fe6-dbacfc57e350', 'bg-optionPricing-rightPane-disabledTab', NULL, @author, @date, @author, @date),
		('c1211683-ef2f-4cab-b391-0ad25c7a0d49', 'bg-optionPricing-screenToggle', NULL, @author, @date, @author, @date),
		('dd6c5c7b-dbd8-40e1-ade6-2bbe604bbce1', 'bg-optionPricing-screenToggle-active', NULL, @author, @date, @author, @date),
		('62c3ead9-483f-4fa0-85b4-2e3ec4075e3f', 'bg-optionPricing-panelTitle', NULL, @author, @date, @author, @date),
		('77e30c9a-fec0-499a-a4ab-2a52e3b2497e', 'color-optionPricing-rightPane-collapseButton-icon', NULL, @author, @date, @author, @date),
		('950f64bf-7e59-4994-9f2c-3682252f2c09', 'color-optionPricing-selectionSummary-card-icon', NULL, @author, @date, @author, @date),
		('5488e47b-b8c1-45dc-91da-bc58d75febbf', 'color-optionPricing-areaCard-areaName-text', NULL, @author, @date, @author, @date),
		('8ad460c3-5e4a-4fac-8317-2037dc087576', 'color-optionPricing-screenToggle', NULL, @author, @date, @author, @date),
		('81cf38c4-f871-46c5-aa53-a15fc4ce5018', 'color-optionPricing-screenToggle-active', NULL, @author, @date, @author, @date),
		('89f972d6-dd4e-4295-b6e2-e24e5faa9b69', 'color-optionPricing-monthlyPayment', NULL, @author, @date, @author, @date),
		('3cbaf01e-326f-4ac4-905e-bc01e4da107c', 'color-optionPricing-currentPlanEditButton', NULL, @author, @date, @author, @date),
		('01e044d8-7e3a-426f-9e40-287f7bc6528a', 'color-optionPricing-currentPlanEditButton-icon', NULL, @author, @date, @author, @date),
		('fa62f17e-a597-49aa-b5b8-f8763f2b5415', 'color-optionPricing-rightPane-disabledTab-text', NULL, @author, @date, @author, @date),
		('a44642eb-ee7e-4397-8611-ef14c2d5b9d8', 'color-optionPricing-leftPane-applicationProductList-navIcon', NULL, @author, @date, @author, @date),
		('9b4bee66-d021-4e5f-916f-1abc25f77b16', 'border-optionPricing-selectionSummary-card', NULL, @author, @date, @author, @date),
		('ebc5b1c4-dbdc-41e7-9081-035c321ddae4', 'border-optionPricing-screenToggle', NULL, @author, @date, @author, @date),
		('d63362a1-f022-47d4-8acb-487ec9f80015', 'color-dmh-icons-primary', NULL, @author, @date, @author, @date),
		('2e87f00c-19ec-44c2-83eb-894bcdc5da73', 'color-dmh-icons-light-on-darkBg', NULL, @author, @date, @author, @date),
		('944f9046-eb6d-4447-832c-edf7143b2ce7', 'color-dmh-icon-included-product-on-darkBg', NULL, @author, @date, @author, @date),
		('3eaef264-0c48-494a-a98e-4e7495e6eeee', 'color-dmh-icon-included-product-on-lightBg', NULL, @author, @date, @author, @date),
		('2e7c98b8-3ae7-42aa-a607-250aae671f7c', 'color-dmh-text-primary', NULL, @author, @date, @author, @date),
		('beb5662e-3b0a-4cb8-88c7-7f67454f6542', 'color-dmh-light-boundary', NULL, @author, @date, @author, @date),
		('a8329264-a00d-42c4-a37f-eebc020077ed', 'color-dmh-dark-accent', NULL, @author, @date, @author, @date),
		('8f1634ac-208a-4f18-994e-b672b2b2cd39', 'color-dmh-dark-accent-alt-lighter', NULL, @author, @date, @author, @date),
		('483b73b5-5a61-4d47-97d7-21039a14dc5a', 'color-dmh-optionMenu-radio-button', NULL, @author, @date, @author, @date),
		('b22cc588-938e-4100-b860-710541a08bb1', 'color-dmh-optionMenu-tab-title', NULL, @author, @date, @author, @date),
		('3471d1cc-e1e4-40bc-ab0e-0d3e56369e67', 'color-dmh-optionMenu-tab-selected-title', NULL, @author, @date, @author, @date),
		('952a0cfb-0bbd-43ad-b292-666e0bae647f', 'color-dmh-optionMenu-tab-desc', NULL, @author, @date, @author, @date),
		('db7b2441-a16a-4c8a-a882-4e99fd5fa20a', 'color-dmh-optionMenu-tab-selected-desc', NULL, @author, @date, @author, @date),
		('bcc21682-616e-4eb7-8fb1-8165ac7019a2', 'color-dmh-optionMenu-optionDetailSelections-fullySelectedCheck', NULL, @author, @date, @author, @date),
		('2be49d62-a37f-4a2f-b4b5-c736a5299f8e', 'color-dmh-optionMenu-optionDetailSelections-countLabel', NULL, @author, @date, @author, @date),
		('644a3730-5aa2-46a2-bfdc-db5c8eb604c3', 'color-dmh-optionMenu-optionDetailTotal', NULL, @author, @date, @author, @date),
		('01568b8d-0fe2-41c2-befc-39ca735b727e', 'color-dmh-visualizableIndicator-icon', NULL, @author, @date, @author, @date),
		('b91cd81e-41ad-4129-b4d0-fe09428635eb', 'color-dmh-prefMenu-budgetExclamation', NULL, @author, @date, @author, @date),
		('ef4636ee-626c-488f-9860-9af046e03a42', 'color-dmh-prefMenu-prefToggle-top-border', NULL, @author, @date, @author, @date),
		('9d8d4bd9-8b1d-4881-afda-e3e27f9b5b18', 'color-dmh-roomProduct-section-text', NULL, @author, @date, @author, @date),
		('e5dfc52a-3605-435e-b1f2-b12b8d058ae0', 'color-dmh-roomProductIcon', NULL, @author, @date, @author, @date),
		('ee782d6a-b9b2-44c5-a7e0-b49527c5efce', 'color-dmh-disclaimer-dialog-community-name', NULL, @author, @date, @author, @date),
		('84f6548e-615a-44ab-9cc2-a1ade6e21a5c', 'color-dmh-disclaimer-dialog-community-series-plan-text', NULL, @author, @date, @author, @date),
		('f682a9fe-4766-4c0c-8dea-36a006fdadc7', 'color-dmh-visualizer-somethingWentWrong-error-icon', NULL, @author, @date, @author, @date),
		('eeda493f-c05a-4ded-9af3-2f907bb915f4', 'color-dmh-leftNav-title', NULL, @author, @date, @author, @date),
		('91c445f2-6882-4521-adfb-7d04e7893b67', 'color-dmh-leftNav-listItemText', NULL, @author, @date, @author, @date),
		('768f82d2-0eba-4723-af90-f6a3a1983728', 'color-dmh-leftNav-listItem-active', NULL, @author, @date, @author, @date),
		('45ee5814-0ef9-45a4-b085-eed86332478f', 'color-dmh-materialsTab-text', NULL, @author, @date, @author, @date),
		('6e8367a5-34f3-489e-8361-18003e590816', 'color-dmh-materialsTab-text-selected', NULL, @author, @date, @author, @date),
		('94600e7b-b5b2-4fa0-bf3a-0aeb726c40af', 'bg-dmh-header', NULL, @author, @date, @author, @date),
		('641c7b2b-759f-4b72-88a6-aac33ed6200a', 'bg-dmh-optionMenu-tab-selected', NULL, @author, @date, @author, @date),
		('12e0f5fe-0701-41e3-8410-5abe55f62e82', 'bg-dmh-optionMenu-tab-hover', NULL, @author, @date, @author, @date),
		('cff4f2bc-cfea-4f05-87c1-55c777ce9233', 'bg-dmh-optionMenu-optionDetailSelections', NULL, @author, @date, @author, @date),
		('25711046-7f8a-437c-8173-73d9c6c91427', 'bg-dmh-optionMenu-optionDetailSelections-fullySelectedCheck', NULL, @author, @date, @author, @date),
		('d7bfe006-6e21-4213-9b84-29bb287e5920', 'bg-dmh-visualizableIndicator-light-side', NULL, @author, @date, @author, @date),
		('679999cd-6ed0-4403-b4a2-11125ffbff38', 'bg-dmh-visualizableIndicator-dark-side', NULL, @author, @date, @author, @date),
		('a56e54b8-23ed-45b7-a58a-6a2e29c62d43', 'bg-dmh-prefMenu-budgetExclamation', NULL, @author, @date, @author, @date),
		('534680f9-c170-4e6f-b9a9-0c68bcedfdc2', 'bg-dmh-visualizer-exclamation-banner', NULL, @author, @date, @author, @date),
		('56c3cbbf-a6e8-4663-8d73-1558322ad6ed', 'bg-dmh-product-list-product-selected', NULL, @author, @date, @author, @date),
		('d8f87fb6-0e3e-4948-aa64-da2e6793d578', 'bg-dmh-product-filter-dropdown-top', NULL, @author, @date, @author, @date),
		('2f05a97d-4691-4450-8060-31b2b63eb787', 'bg-dmh', NULL, @author, @date, @author, @date),
		('e08202c2-8cce-4d0e-9673-830be5b5fa06', 'bg-dmh-left', NULL, @author, @date, @author, @date),
		('c7430e01-58f7-4719-9f63-4c30f803acec', 'bg-dmh-right', NULL, @author, @date, @author, @date),
		('666afa02-8e51-485e-bb4a-27a1215c9744', 'bg-dmh-topBar', NULL, @author, @date, @author, @date),
		('fea1b350-e5ee-4e49-93ea-62394a0be81e', 'bg-dmh-navMenu-selected', NULL, @author, @date, @author, @date),
		('adde71e7-f1d4-4b16-a230-2a87524c90c6', 'bg-dmh-navMenu-close-hover', NULL, @author, @date, @author, @date),
		('c00eb48f-5377-4f0b-a9e0-7aa8a008b73d', 'bg-dmh-leftPanel-nav', NULL, @author, @date, @author, @date),
		('a16628c5-9dd4-4fbb-ab50-9b78668a38a2', 'filter-dmh-roomProductIcon', NULL, @author, @date, @author, @date),
		('58428484-22ab-4c40-855d-38e49e02a2a6', 'color-ds-text-primary', NULL, @author, @date, @author, @date),
		('0a23f389-0a14-49d7-9ade-dd1206f887b7', 'color-ds-catalogCard-status-complete', NULL, @author, @date, @author, @date),
		('c84ca5c3-7283-4a63-9d0d-602788c52b1d', 'color-ds-catalogCard-status-incomplete', NULL, @author, @date, @author, @date),
		('105f7ae8-eb53-49a5-9638-fba7dab15589', 'color-ds-catalogCard-status-error', NULL, @author, @date, @author, @date),
		('b9a0dfce-a085-4923-8380-5a2e5664caba', 'color-ds-catalogCard-status-complete-icon', NULL, @author, @date, @author, @date),
		('295fdb32-dc9c-4441-83a0-84cd0ce097ae', 'color-ds-catalogCard-status-incomplete-icon', NULL, @author, @date, @author, @date),
		('7fdc10d1-e5dc-4a3d-a7ed-0fd9bad30462', 'color-ds-catalogCard-status-error-icon', NULL, @author, @date, @author, @date),
		('f4dba244-679b-4c02-bc3f-0bfa95a9ed15', 'color-ds-mobileMenu-item-icon', NULL, @author, @date, @author, @date),
		('8cb1c691-922e-4e9c-bc59-8acce2d96871', 'color-ds-mobileMenu-item-text', NULL, @author, @date, @author, @date),
		('ed1bc96b-c1ce-47f9-83e0-a897f9d9abfd', 'color-ds-wizard-priceLevelSelector-flag-icon', NULL, @author, @date, @author, @date),
		('d31831ed-9835-4c1c-98fb-45e696807906', 'color-ds-cabinetWizard-priceLevelSelector-flag-icon', NULL, @author, @date, @author, @date),
		('1ea7ecfa-49c4-4a19-a053-fb6ffe105128', 'bg-ds-copyAreaSelections-credit', NULL, @author, @date, @author, @date),
		('1d9ba271-9cae-4cd1-9774-fb6af325fce7', 'bg-ds-catalogCard-body-status-complete', NULL, @author, @date, @author, @date),
		('096c7bc6-6122-4f0f-8a05-0b4dba58b840', 'bg-ds-catalogCard-body-status-incomplete', NULL, @author, @date, @author, @date),
		('1b40d3e4-252b-4efc-af06-4eea88cd25b6', 'bg-ds-catalogCard-body-status-error', NULL, @author, @date, @author, @date),
		('430f5b4c-aaae-496b-8214-e3c927463e4d', 'bg-ds-catalogCard-header-status-complete', NULL, @author, @date, @author, @date),
		('0479da0a-9848-4e75-8dd0-08709d37d439', 'bg-ds-catalogCard-header-status-incomplete', NULL, @author, @date, @author, @date),
		('1489ecfe-efcb-474f-a1f3-7d15d7853ea1', 'bg-ds-catalogCard-header-status-error', NULL, @author, @date, @author, @date),
		('e59a9a88-ec67-4d21-a7a8-996e55c72da9', 'bg-ds-catalog-item-document-pagination-inactive-page', NULL, @author, @date, @author, @date),
		('dbb78859-4dd8-4584-a95d-740c5bf5de04', 'bg-ds-catalog-item-field-section-divider', NULL, @author, @date, @author, @date),
		('691f3d50-8fa7-4665-81b3-ef4dbf1b4d25', 'bg-ds-sessionSupportEmail-attachFile', NULL, @author, @date, @author, @date),
		('9e58a49e-27f6-44f3-ad08-08a73eff147b', 'bg-ds-leftPane', NULL, @author, @date, @author, @date),
		('8d275799-ea6d-4a1a-b76d-1797f35c0f1e', 'bg-ds-catalogSearchBar', NULL, @author, @date, @author, @date),
		('d79e06dd-6d5b-43d0-92c0-c8460ac97048', 'bg-ds-catalogDocumentSelectedIndicator', NULL, @author, @date, @author, @date),
		('0a2bb709-7544-48ec-9c3d-b202d4bd8b6a', 'bg-ds-mobileMenuLauncher-button', NULL, @author, @date, @author, @date),
		('d7b95df0-7b15-4186-8f98-5cd011eb6554', 'bg-ds-mobileMenu-hover', NULL, @author, @date, @author, @date),
		('ece37576-7df4-4b13-ac8c-66c0d95ee7cb', 'bg-ds-mobileMenu', NULL, @author, @date, @author, @date),
		('69d573a8-3f13-4622-9a23-a62d29e595e5', 'border-ds-mobileMenu-item', NULL, @author, @date, @author, @date),
		('8824A628-9D65-4616-B548-097588869850', 'textShadow-ds-navList', NULL, @author, @date, @author, @date),
		('8d34a546-5914-4ed2-b4de-d8cda60dabdc', 'color-planSelector-selectedPlan', NULL, @author, @date, @author, @date),
		('58a8186e-d0cb-4e1a-a49c-108759ed9591', 'bg-planSelector-selectedPlan', NULL, @author, @date, @author, @date),
		('f6cec425-ddbd-425d-9779-77154608ca3d', 'bg-nonEstimatedItemCard-compareIcon', NULL, @author, @date, @author, @date),
		('8279741a-485d-4d30-afc5-52b094c3f85a', 'bg-nonEstimatedItemCard-compareIcon-close', NULL, @author, @date, @author, @date),
		('e04e4b24-90fb-4b82-8e6b-fbe38d3726c0', 'boxShadowColor-nonEstimatedItemCard-compareIcon', NULL, @author, @date, @author, @date),
		('188b75a6-1cf0-4013-bae2-c45807ff86f4', 'border-nonEstimatedItemCard-compareIcon-close', NULL, @author, @date, @author, @date),
		('9c303321-6fcd-453b-86ee-d2593e2ce35d', 'icon-nonEstimatedItemCard-compareIcon-close', NULL, @author, @date, @author, @date),
		('f212b74a-c74a-436c-89e5-4fc20826463a', 'btn-nonEstimatedItem-compare', NULL, @author, @date, @author, @date),
		('637d9d2e-e2b5-478f-9c33-6760076e98cf', 'color-actionBar', NULL, @author, @date, @author, @date),
		('65789cb3-5017-4bdf-8c6d-691b6ba92cd3', 'boxShadowColor-actionBar-selected', NULL, @author, @date, @author, @date),
		('1afa636f-2160-44fc-af68-a313ee66a558', 'color-lifestyle-primary', NULL, @author, @date, @author, @date),
		('7f9ca129-8c8d-4e6d-8bb6-630e029b962d', 'bg-lifestyle', NULL, @author, @date, @author, @date),
		('c1caed1f-d176-4ef4-bbb6-330e7b8ce45c', 'bg-lifestyle-button', NULL, @author, @date, @author, @date),
		('d0f1de23-00fb-4e07-9227-8f24124d2645', 'bg-lifestyle-progressBar', NULL, @author, @date, @author, @date),
		('67ea30aa-e889-4b08-b2f1-59370da148b3', 'bg-image-lifestyle-select', NULL, @author, @date, @author, @date),
		('db5b6a97-eac8-4926-8ae1-198b50b56c53', 'color-lifestyle-saturated-light-4', NULL, @author, @date, @author, @date),
		('21a975b6-f9e1-450f-b422-0875c3b2f12f', 'color-lifestyle-saturated-light-3', NULL, @author, @date, @author, @date),
		('849da00f-9c9f-4fe1-9611-426633baed7c', 'color-lifestyle-saturated-light-2', NULL, @author, @date, @author, @date),
		('2ffcbcb7-9ccf-4dc4-bb98-04df55706962', 'color-lifestyle-saturated-light-1', NULL, @author, @date, @author, @date),
		('97c3eece-e956-4f1d-9c5a-d429ae871289', 'color-lifestyle-saturated', NULL, @author, @date, @author, @date),
		('759d4184-1330-4786-b8e3-92e204f3e71c', 'color-lifestyle-saturated-dark-1', NULL, @author, @date, @author, @date),
		('8724558a-a19d-4d7a-8d8b-0dfed6a2eb40', 'color-lifestyle-saturated-dark-2', NULL, @author, @date, @author, @date),
		('d7191b19-e8b2-44fc-a117-a262f2f73634', 'color-lifestyle-saturated-dark-3', NULL, @author, @date, @author, @date),
		('37a3f9ed-7adf-48cf-a0d1-e4351171ca41', 'color-lifestyle-saturated-dark-4', NULL, @author, @date, @author, @date),
		('9f3ab40b-b2e7-4a57-9f0c-cffb540365ca', 'color-colorGame-selector', NULL, @author, @date, @author, @date),
		('e1e4f919-9689-490c-ae2d-c81dd5a0202c', 'bg-busyIndicator', NULL, @author, @date, @author, @date),
		('d6855de2-288d-40df-b5cf-3df55c090999', 'bg-disclaimerCheckbox', NULL, @author, @date, @author, @date),
		('ea8f8fbc-fbb7-4111-b302-09c2c9631fa6', 'bg-supportEmail-attachFile-button', NULL, @author, @date, @author, @date),
		('a7a2a509-f6b4-4050-8169-fc84df6ae8a6', 'bg-userRegistration-testUserMessage', NULL, @author, @date, @author, @date),
		('cfc49b9b-cee0-4c14-8e94-e7cf85e2d65d', 'bg-buyerWelcome-letsGetStarted-button', NULL, @author, @date, @author, @date),
		('7403b79f-d345-4573-a448-5447ae90f08e', 'bg-buyerWelcome-letsGetStarted-button-hover', NULL, @author, @date, @author, @date),
		('cfe7dcc8-55e8-4095-af4d-a0803ed972ec', 'border-budgetItem', NULL, @author, @date, @author, @date),
		('a23f641a-e5fc-4839-8355-7183eb5a80a1', 'color-userRegistration-testUserMessage-text', NULL, @author, @date, @author, @date),
		('4c9ab062-7499-4ae8-a8ce-4e9d6ef99987', 'color-busyIndicator', NULL, @author, @date, @author, @date),
		('9e552c28-7941-48bd-9c47-e1206e5b2a8f', 'color-wishlist', NULL, @author, @date, @author, @date),
		('3F425C84-B744-469A-B2F6-AB8DECEC98B4', 'color-unwishlisted', NULL, @author, @date, @author, @date),
		('4662f529-369f-442b-abfc-3ce1b9529e31', 'color-notification', NULL, @author, @date, @author, @date),
		('77f0c15b-5c17-462a-846d-bf629ee71cc9', 'color-buyerWelcome-letsGetStarted-button', NULL, @author, @date, @author, @date),
		('8c2d1be2-c15d-4e50-988a-22eb3fe2a934', 'color-buyerWelcome-maybeLater-button', NULL, @author, @date, @author, @date),
		('e942c16c-e783-44a7-bb6f-e47572f1789d', 'color-selectionsReportOptions-selectedOption', NULL, @author, @date, @author, @date),
		('ef068506-cd03-4d09-a1df-72946d1a161e', 'color-selectionsReportOptions-highlightedCategory', NULL, @author, @date, @author, @date),
		('d1d670e5-1830-42f5-b554-7cb3444de123', 'boxShadow-selectionsReportOptions-option', NULL, @author, @date, @author, @date),
		('3f2504e0-4f89-11d3-9a0c-0305e82c3301', 'color-banner-text', NULL, @author, @date, @author, @date),
		('9a0c0305-e82c-3301-3f25-04e04f8911d3', 'bg-banner', NULL, @author, @date, @author, @date),
		('4f8911d3-3f25-04e0-9a0c-0305e82c3301', 'color-beta-sup', NULL, @author, @date, @author, @date),

		-- Taylor Morrison specific variables
		('9C15CEFB-371A-493D-954C-D092C632352B', 'TM-red-light', 'taylor_morrison', @author, @date, @author, @date),
		('7941AF5E-FA49-4C6B-BA17-5AC4F4E2E2D8', 'TM-red', 'taylor_morrison', @author, @date, @author, @date),
		('204717A9-58A2-4D58-BB58-5B64BC3A6151', 'TM-taupe-light', 'taylor_morrison', @author, @date, @author, @date),
		('31F5E62B-CB8D-4430-B493-3E4473761721', 'TM-taupe', 'taylor_morrison', @author, @date, @author, @date),
		('31C73D1B-8161-4346-88F1-362CA8A88B5E', 'TM-taupe-dark', 'taylor_morrison', @author, @date, @author, @date),
		('F86AD322-70CE-4F7A-BAEF-023CE4374054', 'TM-taupe-extra-dark', 'taylor_morrison', @author, @date, @author, @date),
		('0370E177-1A93-4E91-9A48-F1B1D259BCC7', 'TM-light', 'taylor_morrison', @author, @date, @author, @date),
		('78CF0A4A-96AD-4134-BE95-AC15420C99D9', 'TM-extra-light', 'taylor_morrison', @author, @date, @author, @date),
		('9B656D19-DE63-4FFA-B42F-AB02EFB564BE', 'TM-dark-gradient', 'taylor_morrison', @author, @date, @author, @date),
		('9ED9CF1B-4A6C-45DB-8A8F-CAE583811CA3', 'TM-light-gradient', 'taylor_morrison', @author, @date, @author, @date),

		-- Newmark specific variables
		('71ACEC83-F9CC-4159-BC4E-6AA87A0BD258', 'NH-red-translucent', 'newmark', @author, @date, @author, @date),
		('7DB1272E-FA26-4FD5-A160-19F7E8A0157C', 'NH-red-light', 'newmark', @author, @date, @author, @date),
		('F5AAA5C2-ECBD-494F-809C-7FB580D2B3BD', 'NH-red', 'newmark', @author, @date, @author, @date),
		('C0A1F57E-5695-4D86-94FC-A7922D85AA79', 'NH-red-dark', 'newmark', @author, @date, @author, @date),
		('30FBC77F-B249-4BF2-8B64-AAC347064851', 'NH-black', 'newmark', @author, @date, @author, @date),
		('EAE80BBB-8F7A-4146-84F0-CA1F9221FDF5', 'NH-red-variant', 'newmark', @author, @date, @author, @date),
		('1FFEA3E9-05EB-40C2-ACB2-690D839578AF', 'NH-gray-dark', 'newmark', @author, @date, @author, @date),
		('E59B490D-98F5-4BB2-B2F9-D3F86DF5BF1D', 'NH-gray-primary', 'newmark', @author, @date, @author, @date),
		('9ACA009B-7B6F-4541-9974-6CE9EF9199CA', 'NH-gray-secondary', 'newmark', @author, @date, @author, @date),
		('9912803A-30B9-41BC-8F57-18FF77349A05', 'NH-light', 'newmark', @author, @date, @author, @date),
		('78269ED4-1409-4FA2-B92F-F09440CF7587', 'NH-extra-light', 'newmark', @author, @date, @author, @date),
		('2A4ECD24-90CA-4545-A4A7-1C41E72B6B7C', 'NH-white', 'newmark', @author, @date, @author, @date),
		('9E363AC6-70F0-4B17-9EBA-613AAE7B713C', 'NH-light-gradient', 'newmark', @author, @date, @author, @date)

) AS src (Id, CssName, TargetThemeLookupKey, Author, CreateDate, Modifier, ModifiedDate)
ON tgt.Id = src.Id
WHEN MATCHED AND tgt.CssName <> src.CssName OR tgt.TargetThemeLookupKey <> src.TargetThemeLookupKey OR (tgt.TargetThemeLookupKey IS NULL AND src.TargetThemeLookupKey IS NOT NULL) THEN
    UPDATE SET
        tgt.CssName = src.CssName,
		tgt.TargetThemeLookupKey = src.TargetThemeLookupKey
WHEN NOT MATCHED BY TARGET THEN
    INSERT (Id, CssName, TargetThemeLookupKey, Author, CreateDate, Modifier, ModifiedDate)
    VALUES (src.Id, src.CssName, src.TargetThemeLookupKey, src.Author, src.CreateDate, src.Modifier, src.ModifiedDate);

GO

IF '$(Environment)' = 'Dev'
	BEGIN
		PRINT 'VeoSolutions (Dev): Adding Staggered Builder';
/***********************************************************************************
* Author: Roger Wang
* Date: 3/5/2024
* Descripton: This script adds the specified scheduling organizations/users related
			  information to the database
* Usage: This script was not designed to be called directly, though you can. Just
*        be sure that you're running it against the appropriate database. Instead,
*        This script is designed to be run from another script.
************************************************************************************/

/***********************************************************************************
Audit and Organization Variables
************************************************************************************/
DECLARE @author VARCHAR(50) = 'SEED',
		@date DATETIME = GETDATE();

/***********************************************************************************
dbo.scheduling_organizations
************************************************************************************/
MERGE dbo.scheduling_organizations AS TGT
USING
	(VALUES
		('573E9081-BC15-4F1C-805B-1688ABF317C7', 'STAGGERED-QA',	'1900-01-01T07:00:00.000', '1900-01-01T19:00:00.000', NULL, @author, @date, @author, @date),
		('67222232-B61D-48B4-9581-C9D25763F841', 'NON-STAGGERED - QA',	'1900-01-01T07:00:00.000', '1900-01-01T19:00:00.000', NULL, @author, @date, @author, @date),
		('C7DCACF5-EDFE-4EA9-9B2A-E8C93A0E0558', 'Brookfield Residential - Austin',	'1900-01-01T07:00:00.000', '1900-01-01T19:00:00.000', NULL, @author, @date, @author, @date)
	)AS SRC (account_org_id, display_name, display_hours_start, display_hours_end, excluded_designers, author, create_date, modifier, modified_date)
ON TGT.account_org_id = SRC.account_org_id
WHEN NOT MATCHED THEN INSERT (account_org_id, display_name, display_hours_start, display_hours_end, excluded_designers, author, create_date, modifier, modified_date)
	VALUES (SRC.account_org_id, SRC.display_name, SRC.display_hours_start, SRC.display_hours_end, SRC.excluded_designers, SRC.author, SRC.create_date, SRC.modifier, SRC.modified_date);

/***********************************************************************************
dbo.scheduling_appointment_templates
************************************************************************************/
MERGE dbo.scheduling_appointment_templates AS TGT
USING
	(VALUES
		('573E9081-BC15-4F1C-805B-1688ABF317C7', '75BD4269-7030-42A0-91D6-23AD23A87E1D', '3 - 2Hr',	@author, @date, @author, @date),
		('C7DCACF5-EDFE-4EA9-9B2A-E8C93A0E0558', 'B74BEB6C-ED6C-4752-8906-B5ADC93BF410', 'Default', @author, @date, @author, @date)
	) AS SRC (account_org_id, template_id, template_name, author, create_date, modifier, modified_date)
ON TGT.template_id = SRC.template_id
WHEN NOT MATCHED THEN INSERT (account_org_id, template_id, template_name, author, create_date, modifier, modified_date)
	VALUES (SRC.account_org_id, SRC.template_id, SRC.template_name, SRC.author, SRC.create_date, SRC.modifier, SRC.modified_date);

/***********************************************************************************
dbo.scheduling_users
************************************************************************************/
MERGE dbo.scheduling_users AS TGT
USING
	(VALUES	
		('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 1, 'Phil', 'SysAdmin-McAleer', 'philm@eplanpartners.com',	'555-555-5555', @author, @date, @author, @date),
		('902A371C-5B1E-4A11-BBE9-5174D591C6D1', 1, 'Dev', 'Designer1', 'devdesigner3@mailinator.com', '111-111-1111', @author, @date, @author, @date)
	)AS SRC ([user_id], scheduling_enabled, first_name, last_name, email, phone, author, create_date, modifier, modified_date)
ON TGT.[user_id] = SRC.[user_id]
WHEN NOT MATCHED THEN INSERT ([user_id], scheduling_enabled, first_name, last_name, email, phone, author, create_date, modifier, modified_date)
	VALUES (SRC.[user_id], SRC.scheduling_enabled, SRC.first_name, SRC.last_name, SRC.email, SRC.phone, SRC.author, SRC.create_date, SRC.modifier, SRC.modified_date);

/***********************************************************************************
dbo.scheduling_user_roles
************************************************************************************/
MERGE dbo.scheduling_user_roles AS TGT
USING
	(VALUES
		('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 'A0A9C6C5-A686-48EB-B125-6901F74AA435', @author, @date, @author, @date),
		('902A371C-5B1E-4A11-BBE9-5174D591C6D1', 'EFC34C28-6A74-40D0-A7A6-F9D3E6040609', @author, @date, @author, @date),
		('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 'BC18D1BC-C930-41D2-83B6-13B276DCAD6B', @author, @date, @author, @date)
	) AS SRC ([user_id], role_id, author, create_date, modifier, modified_date)
ON TGT.[user_id] = SRC.[user_id]
WHEN NOT MATCHED THEN INSERT ([user_id], role_id, author, create_date, modifier, modified_date)
	VALUES (SRC.[user_id], SRC.role_id, SRC.author, SRC.create_date, SRC.modifier, SRC.modified_date);

/***********************************************************************************
dbo.scheduling_user_locations
************************************************************************************/
MERGE scheduling_user_locations AS TGT
USING
	(VALUES
		('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23', @author, @date, @author, @date),
		('902A371C-5B1E-4A11-BBE9-5174D591C6D1', 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23', @author, @date, @author, @date)
	) AS SRC ([user_id], location_id, author, create_date, modifier, modified_date)
ON TGT.[user_id] = SRC.[user_id]
WHEN NOT MATCHED THEN INSERT ([user_id], location_id, author, create_date, modifier, modified_date)
	VALUES (SRC.[user_id], SRC.location_id, SRC.author, SRC.create_date, SRC.modifier, SRC.modified_date);

/***********************************************************************************
dbo.scheduling_user_preferences
************************************************************************************/
MERGE scheduling_user_preferences AS TGT
USING
	(VALUES
		('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 'days_to_display', '14', @author, @date, @author, @date),
		('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 'days_to_load', '14', @author, @date, @author, @date),
		('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 'display_weekends', 'true', @author, @date, @author, @date),
		('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 'hide_filtered', 'false', @author, @date, @author, @date),
		('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 'selected_account_org', '573e9081-bc15-4f1c-805b-1688abf317c7', @author, @date, @author, @date)
	) AS SRC ([user_id], pref_key, pref_value, author, create_date, modifier, modified_date)
ON convert(char(36), TGT.[user_id]) + TGT.pref_key = convert(char(36), SRC.[user_id]) + SRC.pref_key
WHEN NOT MATCHED THEN INSERT ([user_id], pref_key, pref_value, author, create_date, modifier, modified_date)
	VALUES (SRC.[user_id], SRC.pref_key, SRC.pref_value, SRC.author, SRC.create_date, SRC.modifier, SRC.modified_date);

/***********************************************************************************
dbo.scheduling_user_work_schedules
************************************************************************************/
MERGE scheduling_user_work_schedules AS TGT
USING
	(VALUES		
		('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 2, 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23',	0, '10:00:00.0000000',	'18:00:00.0000000', @author, @date, @author, @date),
		('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 3, 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23',	0, '08:00:00.0000000',	'17:00:00.0000000', @author, @date, @author, @date),
		('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 1, 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23',	0, '10:00:00.0000000',	'18:00:00.0000000', @author, @date, @author, @date),
		('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 4, 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23',	0, '10:00:00.0000000',	'18:00:00.0000000', @author, @date, @author, @date),
		('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 5, 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23',	0, '10:00:00.0000000',	'18:00:00.0000000', @author, @date, @author, @date),
		('902A371C-5B1E-4A11-BBE9-5174D591C6D1', 2, 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23',	0, '10:00:00.0000000',	'18:00:00.0000000', @author, @date, @author, @date),
		('902A371C-5B1E-4A11-BBE9-5174D591C6D1', 3, 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23',	0, '08:00:00.0000000',	'17:00:00.0000000', @author, @date, @author, @date),
		('902A371C-5B1E-4A11-BBE9-5174D591C6D1', 1, 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23',	0, '10:00:00.0000000',	'18:00:00.0000000', @author, @date, @author, @date),
		('902A371C-5B1E-4A11-BBE9-5174D591C6D1', 4, 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23',	0, '10:00:00.0000000',	'18:00:00.0000000', @author, @date, @author, @date),
		('902A371C-5B1E-4A11-BBE9-5174D591C6D1', 5, 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23',	0, '10:00:00.0000000',	'18:00:00.0000000', @author, @date, @author, @date)
	) AS SRC ([user_id], [day], location_id, work_type, start_time, end_time, author, create_date, modifier, modified_date)
ON convert(char(36), TGT.[user_id]) + convert(char(1),TGT.[day]) = convert(char(36), SRC.[user_id]) + convert(char(1), SRC.[day])
WHEN NOT MATCHED THEN INSERT ([user_id], [day], location_id, work_type, start_time, end_time, author, create_date, modifier, modified_date)
	VALUES (SRC.[user_id], SRC.[day], SRC.location_id, SRC.work_type, SRC.start_time, SRC.end_time, SRC.author, SRC.create_date, SRC.modifier, SRC.modified_date);

	END
GO

IF '$(Environment)' = 'Dev'
	BEGIN
		PRINT 'VeoSolutions (Dev): Adding Staggered Builder';
/***********************************************************************************
* Author: Shelby Mansker
* Date: 4/22/2016
* Descripton: This script will add/update test data for the non-staggered qa organization
              To the VeoSolutions database tables.
* Usage: This script was not designed to be called directly, though you can. Just
*        be sure that you're running it against the appropriate database. Instead,
*        This script is designed to be run from another script.
************************************************************************************/

/***********************************************************************************
Audit and Organization Variables
************************************************************************************/
DECLARE @author VARCHAR(50) = 'SEED',
		@date DATETIME = GETDATE(),
		@account_id UNIQUEIDENTIFIER = 'BAB32B7E-3ADA-497C-862E-E5083971CC59',
		@organization_id UNIQUEIDENTIFIER = '8AAECC3A-2D9E-4500-B0CF-D79D947D33A7',
		@organization_name VARCHAR(50) = 'STAGGERED-QA',
		@account_organization_id UNIQUEIDENTIFIER = '573E9081-BC15-4F1C-805B-1688ABF317C7',
		@dc_location_id UNIQUEIDENTIFIER = 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23',
		@admin_role_id UNIQUEIDENTIFIER = 'A0A9C6C5-A686-48EB-B125-6901F74AA435',
		@dc_admin_role_id UNIQUEIDENTIFIER = '4D9E9F34-2F62-4B17-8E24-4665DA40E326',
		@dc_manager_role_id UNIQUEIDENTIFIER = 'EBE7EAE2-488B-4158-BB25-24804B9AA1E6',
		@vendor_designer_role_id UNIQUEIDENTIFIER = 'F9EC07EB-A100-4CBB-8A79-E9C1D5D43092';
		
/***********************************************************************************
Users
************************************************************************************/
DECLARE @users TABLE
(
	[user_id] UNIQUEIDENTIFIER,
	first_name VARCHAR(25),
	last_name VARCHAR(25),
	email VARCHAR(100),
	role_id UNIQUEIDENTIFIER,
	phone VARCHAR(20),
	profile_id UNIQUEIDENTIFIER,
	interest_rate DECIMAL(18,6),
	loan_term DECIMAL(18,6),
	completed_steps INT,
	enable_homebuyer_access BIT
)

INSERT INTO @users VALUES
	-- VDS members
	('FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', 'Rob', 'SysAdmin-Hobbs', 'roberth@eplanpartners.com', @admin_role_id, '222-222-2222', '437B9475-40D8-4452-80D2-DD3CEECCC5AD', 4, 30, 0, 1),
	('A3F08518-B67E-4ADC-BE8C-F2CF264ACD4F', 'Roger', 'SysAdmin-Wang', 'rogerw@eplanpartners.com', @admin_role_id, '000-000-0000', 'F03F57BD-8094-4F5D-95F0-7EE3D6B05EAB', 4, 30, 0, 1),

	-- Other members in the organizations
	('424059BC-E4C9-4F21-BDC2-52E5A24BF9AE', 'Adrian', 'SysAdmin-Garza', 'adriang@eplanpartners.com', @admin_role_id, '888-888-8888', 'E974CD31-5E3D-4BC3-932C-5C7660A54B14', 4, 30, 0, 1),
	('F5352E11-1A3A-4E69-A11F-1EE17F2BD4BB', 'Michelle', 'SysAdmin-Mansker', 'michellem@eplanpartners.com', @admin_role_id, '111-111-1111', '81A5EDD4-18D4-4F0C-9E30-9998E361143B', 4, 30, 0, 1),
	('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 'Phil', 'SysAdmin-McAleer', 'philm@eplanpartners.com', @admin_role_id, '555-555-5555', '0E023259-C1BE-41A9-A5EF-00E45E7276A3', 4, 30, 0, 1),
	('1028F0FD-3E7D-4E82-8F39-A25FF6228938', 'Richard', 'SysAdmin-McPherson', 'richardg@eplanpartners.com', @admin_role_id, '777-777-7777', '906E8A66-B613-4A34-B39C-2DFA8D4F8E04', 4, 30, 0, 1),
	('F15AC710-CDF1-4933-966C-4F28A7C2EDC8', 'Shelby', 'SysAdmin-Mansker', 'shelbym@eplanpartners.com', @admin_role_id, '444-444-4444', '7EFA4105-194C-4910-BF90-4A53624A017B', 4, 30, 0, 1),

	-- Test users
	('CD7488F8-D980-4F59-9B4D-7BC3607A16E0', 'DC', 'Admin', 'dc-administrator@mailinator.com', @dc_admin_role_id, '999-999-9999', '11F1AC21-43DE-4ACA-BB90-2C04B6BCAB31', 4, 30, 0, 1),
	('CEE7F0F8-B557-4E91-A329-612FFF39B159', 'DC', 'Manager', 'dc-manager@mailinator.com', @dc_manager_role_id, '111-111-1112', 'F100A88E-104C-4EB8-8D28-F9E624CFA948', 4, 30, 0, 1), 
	('73AFB14E-BD17-4A92-BF99-FA358F7CAC23', 'Vendor', 'Designer1', 'vendordesigner1@mailinator.com', @vendor_designer_role_id, '111-111-1113', 'CEA6CD11-6237-4648-A232-25243C09C3BD', 4, 30, 0, 1),
	('D2C5BE9D-D4AF-4927-AA84-C0C8C23CD069', 'Vendor', 'Designer2', 'vendordesigner2@mailinator.com', @vendor_designer_role_id, '111-111-1114', 'DF3C0774-EA73-43B1-AA39-92F2DC2E1FAA', 4, 30, 0, 1),
	('8E6BEE2E-0607-41D4-9841-CFEED1E59BEF', 'Vendor', 'Designer3', 'vendordesigner3@mailinator.com', @vendor_designer_role_id, '111-111-1115', '278E6126-0854-41B1-A620-C7C8BF47F47F', 4, 30, 0, 1);
	

/***********************************************************************************
Design Center Addresses
************************************************************************************/
DECLARE @addresses TABLE
(
	address_id UNIQUEIDENTIFIER,
	address_type NVARCHAR(50),
	[address] NVARCHAR(50),
	address_name NVARCHAR(100),
	city NVARCHAR(50),
	[state] NVARCHAR(50),
	postal_code NVARCHAR(10),
	country_code NVARCHAR(5),
	phone1 NVARCHAR(20)
)

INSERT INTO @addresses VALUES
	('C04B5E52-8D06-4BAB-B878-1EECA0BC8D23', 'Design Center', '10110 W. Sam Houston Parkway N, Suite 250', 'The Main Design Center', 'Houston', 'TX', '77064', '1', '(281) 664-7255');

/***********************************************************************************
Step 1: Add Design Center addresses
************************************************************************************/
MERGE dbo.addresses TGT
USING @addresses SRC
ON
	TGT.address_id = SRC.address_id
WHEN NOT MATCHED THEN INSERT(address_id, address_type, [address], city, [state], postal_code, country_code, phone1, author, create_date, modifier, modified_date)
	VALUES(SRC.address_id, SRC.address_type, SRC.[address], SRC.city, SRC.[state], SRC.postal_code, SRC.country_code, SRC.phone1, @author, @date, @author, @date)
WHEN MATCHED THEN UPDATE
	SET
		TGT.address_type = SRC.address_type,
		TGT.[address] = SRC.[address],
		TGT.city = SRC.city,
		TGT.[state] = SRC.[state],
		TGT.postal_code = SRC.postal_code,
		TGT.country_code = SRC.country_code,
		TGT.phone1 = SRC.phone1,
		TGT.modifier = @author,
		TGT.modified_date = @date;

/***********************************************************************************
Step 2: Add Addresses to organization
************************************************************************************/
MERGE dbo.account_organization_addresses TGT
USING @addresses SRC
ON
	TGT.account_org_id = @account_organization_id AND TGT.address_id = SRC.address_id
WHEN NOT MATCHED THEN INSERT(account_org_id, address_id, address_name, author, create_date, modifier, modified_date)
	VALUES(@account_organization_id, SRC.address_id, SRC.address_name, @author, @date, @author, @date)
WHEN MATCHED THEN UPDATE
	SET
		TGT.address_name = SRC.address_name,
		TGT.modifier = @author,
		TGT.modified_date = @date;

/***********************************************************************************
Step 3: Create Profiles for each user in this organization
************************************************************************************/
MERGE dbo.account_organization_user_profile TGT
USING @users SRC
ON
	TGT.account_id = @account_id AND TGT.organization_id = @organization_id AND TGT.[user_id] = SRC.[user_id]
WHEN NOT MATCHED THEN INSERT(account_id, organization_id, [user_id], profile_id, interest_rate, loan_term, completed_steps, enable_homebuyer_access, author, create_date, modifier, modified_date)
	VALUES(@account_id, @organization_id, SRC.[user_id], SRC.profile_id, SRC.interest_rate, SRC.loan_term, SRC.completed_steps, SRC.enable_homebuyer_access, @author, @date, @author, @date)
WHEN MATCHED THEN UPDATE
	SET
		TGT.interest_rate = SRC.interest_rate,
		TGT.loan_term = SRC.loan_term,
		TGT.completed_steps = SRC.completed_steps,
		TGT.enable_homebuyer_access = SRC.enable_homebuyer_access,
		TGT.modifier = @author,
		TGT.modified_date = @date;

/***********************************************************************************
Step 4: Add this organization to scheduling
************************************************************************************/
MERGE dbo.scheduling_organizations TGT
USING
	(VALUES 
		(@account_organization_id, @organization_name, '1900-01-01 07:00:00.000', '1900-01-01 19:00:00.000', NULL)
	) AS SRC (account_org_id, display_name, display_hours_start, display_hours_end, excluded_designers)
ON
	TGT.account_org_id = SRC.account_org_id
WHEN NOT MATCHED THEN INSERT (account_org_id, display_name, display_hours_start, display_hours_end, excluded_designers, author, create_date, modifier, modified_date)
	VALUES(SRC.account_org_id, SRC.display_name, SRC.display_hours_start, SRC.display_hours_end, SRC.excluded_designers, @author, @date, @author, @date)
WHEN MATCHED THEN UPDATE
	SET
		TGT.display_name = SRC.display_name,
		TGT.display_hours_start = SRC.display_hours_start, 
		TGT.display_hours_end = SRC.display_hours_end, 
		TGT.excluded_designers = SRC.excluded_designers,
		TGT.modifier = @author,
		TGT.modified_date = @date;

/***********************************************************************************
Step 5: Add the users to the Scheduling system
************************************************************************************/
MERGE dbo.scheduling_users TGT
USING (SELECT * FROM @users WHERE role_id = @admin_role_id) SRC
ON
	TGT.[user_id] = SRC.[user_id]
WHEN NOT MATCHED THEN INSERT ([user_id], scheduling_enabled, first_name, last_name, email, phone, author, create_date, modifier, modified_date)
	VALUES(SRC.[user_id], 1, SRC.first_name, SRC.last_name, SRC.email, SRC.phone, @author, @date, @author, @date)
WHEN MATCHED THEN UPDATE
	SET
		TGT.first_name = SRC.first_name,
		TGT.last_name = SRC.last_name,
		TGT.email = SRC.email,
		TGT.phone = SRC.phone,
		TGT.modifier = @author,
		TGT.modified_date = @date;

/***********************************************************************************
Step 6: Wire up the admin users to their organizations in scheduling
************************************************************************************/
MERGE dbo.scheduling_user_organizations TGT
USING (SELECT * FROM @users WHERE role_id = @admin_role_id) SRC
ON
	TGT.[user_id] = SRC.[user_id] AND TGT.account_org_id = @account_organization_id 
WHEN NOT MATCHED THEN INSERT ([user_id], account_org_id, author, create_date, modifier, modified_date)
	VALUES(SRC.[user_id], @account_organization_id, @author, @date, @author, @date);

/***********************************************************************************
Step 7: Making all of the users admins in the scheduling system
************************************************************************************/
MERGE dbo.scheduling_user_roles TGT
USING (SELECT * FROM @users WHERE role_id = @admin_role_id) SRC
ON
	TGT.[user_id] = SRC.[user_id] AND TGT.role_id = @admin_role_id
WHEN NOT MATCHED THEN INSERT ([user_id], role_id, author, create_date, modifier, modified_date)
	VALUES(SRC.[user_id], @admin_role_id, @author, @date, @author, @date);

/***********************************************************************************
Step 8: Setting up locations for each of the admin users
************************************************************************************/
MERGE dbo.scheduling_user_locations TGT
USING (SELECT * FROM @users WHERE role_id = @admin_role_id) SRC
ON
	TGT.[user_id] = SRC.[user_id] AND TGT.location_id = @dc_location_id
WHEN NOT MATCHED THEN INSERT ([user_id], location_id, author, create_date, modifier, modified_date)
	VALUES(SRC.[user_id], @dc_location_id, @author, @date, @author, @date);
	END
GO

IF '$(Environment)' = 'Dev'	
	BEGIN
		PRINT 'VeoSolutions (Dev): Adding Non-Staggered Builder';
/***********************************************************************************
* Author: Shelby Mansker
* Date: 4/22/2016
* Descripton: This script will add/update test data for the non-staggered qa organization
              To the VeoSolutions database tables.
* Usage: This script was not designed to be called directly, though you can. Just
*        be sure that you're running it against the appropriate database. Instead,
*        This script is designed to be run from another script.
************************************************************************************/

/***********************************************************************************
Audit and Organization Variables
************************************************************************************/
DECLARE @author VARCHAR(50) = 'SEED',
		@date DATETIME = GETDATE(),
		@account_id UNIQUEIDENTIFIER = 'BAB32B7E-3ADA-497C-862E-E5083971CC59',
		@organization_id UNIQUEIDENTIFIER = '49687F1F-DEC8-484D-B7C3-C193DA7C873D',
		@organization_name VARCHAR(50) = 'NON-STAGGERED - QA',
		@account_organization_id UNIQUEIDENTIFIER = '67222232-B61D-48B4-9581-C9D25763F841',
		@dc_location_id UNIQUEIDENTIFIER = 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23',
		@admin_role_id UNIQUEIDENTIFIER = 'A0A9C6C5-A686-48EB-B125-6901F74AA435',
		@dc_admin_role_id UNIQUEIDENTIFIER = '4D9E9F34-2F62-4B17-8E24-4665DA40E326',
		@dc_manager_role_id UNIQUEIDENTIFIER = 'EBE7EAE2-488B-4158-BB25-24804B9AA1E6',
		@vendor_designer_role_id UNIQUEIDENTIFIER = 'F9EC07EB-A100-4CBB-8A79-E9C1D5D43092';

/***********************************************************************************
Users
************************************************************************************/
DECLARE @users TABLE
(
	[user_id] UNIQUEIDENTIFIER,
	first_name VARCHAR(25),
	last_name VARCHAR(25),
	email VARCHAR(100),
	role_id UNIQUEIDENTIFIER,
	phone VARCHAR(20),
	profile_id UNIQUEIDENTIFIER,
	interest_rate DECIMAL(18,6),
	loan_term DECIMAL(18,6),
	completed_steps INT,
	enable_homebuyer_access BIT
)

INSERT INTO @users VALUES
	-- VDS members
	('FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', 'Rob', 'SysAdmin-Hobbs', 'roberth@eplanpartners.com', @admin_role_id, '222-222-2222', '673CE7D1-3FCB-4664-8DAF-442BDE1C0990', 4, 30, 0, 1),
	('A3F08518-B67E-4ADC-BE8C-F2CF264ACD4F', 'Roger', 'SysAdmin-Wang', 'rogerw@eplanpartners.com', @admin_role_id, '000-000-0000', 'E871EC6C-60CA-42B6-AD25-6AC673E71A74', 4, 30, 0, 1),

	-- Other members in the organizations
	('424059BC-E4C9-4F21-BDC2-52E5A24BF9AE', 'Adrian', 'SysAdmin-Garza', 'adriang@eplanpartners.com', @admin_role_id, '888-888-8888', '5C60233E-3258-4539-828F-C4677C0B1CCC', 4, 30, 0, 1),
	('F5352E11-1A3A-4E69-A11F-1EE17F2BD4BB', 'Michelle', 'SysAdmin-Mansker', 'michellem@eplanpartners.com', @admin_role_id, '111-111-1111', '60B66F9C-11A4-4ACC-A7A8-DE705D1D14B2', 4, 30, 0, 1),
	('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 'Phil', 'SysAdmin-McAleer', 'philm@eplanpartners.com', @admin_role_id, '555-555-5555', '919D38E6-AF17-4D7E-BF42-D39BA30A295B', 4, 30, 0, 1),
	('1028F0FD-3E7D-4E82-8F39-A25FF6228938', 'Richard', 'SysAdmin-McPherson', 'richardg@eplanpartners.com', @admin_role_id, '777-777-7777', '786D288D-32F6-4311-8E43-D565D6FFAA83', 4, 30, 0, 1),
	('F15AC710-CDF1-4933-966C-4F28A7C2EDC8', 'Shelby', 'SysAdmin-Mansker', 'shelbym@eplanpartners.com', @admin_role_id, '444-444-4444', 'DDCAF250-7E86-4DA6-AEEE-BECEB422B36D', 4, 30, 0, 1),

	-- Test users
	('CD7488F8-D980-4F59-9B4D-7BC3607A16E0', 'DC', 'Admin', 'dc-administrator@mailinator.com', @dc_admin_role_id, '999-999-9999', '850C8191-3A9F-4BA2-A9CA-B4FC6CCBF296', 4, 30, 0, 1),
	('CEE7F0F8-B557-4E91-A329-612FFF39B159', 'DC', 'Manager', 'dc-manager@mailinator.com', @dc_manager_role_id, '111-111-1112', 'BE5D1967-DFFF-4BC7-8D3F-EF27E305DB35', 4, 30, 0, 1), 
	('73AFB14E-BD17-4A92-BF99-FA358F7CAC23', 'Vendor', 'Designer1', 'vendordesigner1@mailinator.com', @vendor_designer_role_id, '111-111-1113', '41A80954-4F26-4B7C-9FE3-0A49DB758E16', 4, 30, 0, 1),
	('D2C5BE9D-D4AF-4927-AA84-C0C8C23CD069', 'Vendor', 'Designer2', 'vendordesigner2@mailinator.com', @vendor_designer_role_id, '111-111-1114', 'F41FD01C-9569-4296-B04E-7C1FA30FDA2D', 4, 30, 0, 1);

/***********************************************************************************
Design Center Addresses
************************************************************************************/
DECLARE @addresses TABLE
(
	address_id UNIQUEIDENTIFIER,
	address_type NVARCHAR(50),
	[address] NVARCHAR(50),
	address_name NVARCHAR(100),
	city NVARCHAR(50),
	[state] NVARCHAR(50),
	postal_code NVARCHAR(10),
	country_code NVARCHAR(5),
	phone1 NVARCHAR(20)
)

INSERT INTO @addresses VALUES
	('C04B5E52-8D06-4BAB-B878-1EECA0BC8D23', 'Design Center', '10110 W. Sam Houston Parkway N, Suite 250', 'The Main Design Center', 'Houston', 'TX', '77064', '1', '(281) 664-7255');

/***********************************************************************************
Step 1: Add Design Center addresses
************************************************************************************/
MERGE dbo.addresses TGT
USING @addresses SRC
ON
	TGT.address_id = SRC.address_id
WHEN NOT MATCHED THEN INSERT(address_id, address_type, [address], city, [state], postal_code, country_code, phone1, author, create_date, modifier, modified_date)
	VALUES(SRC.address_id, SRC.address_type, SRC.[address], SRC.city, SRC.[state], SRC.postal_code, SRC.country_code, SRC.phone1, @author, @date, @author, @date)
WHEN MATCHED THEN UPDATE
	SET
		TGT.address_type = SRC.address_type,
		TGT.[address] = SRC.[address],
		TGT.city = SRC.city,
		TGT.[state] = SRC.[state],
		TGT.postal_code = SRC.postal_code,
		TGT.country_code = SRC.country_code,
		TGT.phone1 = SRC.phone1,
		TGT.modifier = @author,
		TGT.modified_date = @date;

/***********************************************************************************
Step 2: Add Addresses to organization
************************************************************************************/
MERGE dbo.account_organization_addresses TGT
USING @addresses SRC
ON
	TGT.account_org_id = @account_organization_id AND TGT.address_id = SRC.address_id
WHEN NOT MATCHED THEN INSERT(account_org_id, address_id, address_name, author, create_date, modifier, modified_date)
	VALUES(@account_organization_id, SRC.address_id, SRC.address_name, @author, @date, @author, @date)
WHEN MATCHED THEN UPDATE
	SET
		TGT.address_name = SRC.address_name,
		TGT.modifier = @author,
		TGT.modified_date = @date;

/***********************************************************************************
Step 3: Create Profiles for each user in this organization
************************************************************************************/
MERGE dbo.account_organization_user_profile TGT
USING @users SRC
ON
	TGT.account_id = @account_id AND TGT.organization_id = @organization_id AND TGT.[user_id] = SRC.[user_id] AND TGT.profile_id = SRC.profile_id
WHEN NOT MATCHED THEN INSERT(account_id, organization_id, [user_id], profile_id, interest_rate, loan_term, completed_steps, enable_homebuyer_access, author, create_date, modifier, modified_date)
	VALUES(@account_id, @organization_id, SRC.[user_id], SRC.profile_id, SRC.interest_rate, SRC.loan_term, SRC.completed_steps, SRC.enable_homebuyer_access, @author, @date, @author, @date)
WHEN MATCHED THEN UPDATE
	SET
		TGT.interest_rate = SRC.interest_rate,
		TGT.loan_term = SRC.loan_term,
		TGT.completed_steps = SRC.completed_steps,
		TGT.enable_homebuyer_access = SRC.enable_homebuyer_access,
		TGT.modifier = @author,
		TGT.modified_date = @date;

/***********************************************************************************
Step 4: Add this organization to scheduling
************************************************************************************/
MERGE dbo.scheduling_organizations TGT
USING
	(VALUES 
		(@account_organization_id, @organization_name, '1900-01-01 07:00:00.000', '1900-01-01 19:00:00.000', NULL)
	) AS SRC (account_org_id, display_name, display_hours_start, display_hours_end, excluded_designers)
ON
	TGT.account_org_id = SRC.account_org_id
WHEN NOT MATCHED THEN INSERT (account_org_id, display_name, display_hours_start, display_hours_end, excluded_designers, author, create_date, modifier, modified_date)
	VALUES(SRC.account_org_id, SRC.display_name, SRC.display_hours_start, SRC.display_hours_end, SRC.excluded_designers, @author, @date, @author, @date)
WHEN MATCHED THEN UPDATE
	SET
		TGT.display_name = SRC.display_name,
		TGT.display_hours_start = SRC.display_hours_start, 
		TGT.display_hours_end = SRC.display_hours_end, 
		TGT.excluded_designers = SRC.excluded_designers,
		TGT.modifier = @author,
		TGT.modified_date = @date;

/***********************************************************************************
Step 5: Add the users to the Scheduling system
************************************************************************************/
MERGE dbo.scheduling_users TGT
USING (SELECT * FROM @users WHERE role_id = @admin_role_id) SRC
ON
	TGT.[user_id] = SRC.[user_id]
WHEN NOT MATCHED THEN INSERT ([user_id], scheduling_enabled, first_name, last_name, email, phone, author, create_date, modifier, modified_date)
	VALUES(SRC.[user_id], 1, SRC.first_name, SRC.last_name, SRC.email, SRC.phone, @author, @date, @author, @date)
WHEN MATCHED THEN UPDATE
	SET
		TGT.first_name = SRC.first_name,
		TGT.last_name = SRC.last_name,
		TGT.email = SRC.email,
		TGT.phone = SRC.phone,
		TGT.modifier = @author,
		TGT.modified_date = @date;

/***********************************************************************************
Step 6: Wire up the admin users to their organizations in scheduling
************************************************************************************/
MERGE dbo.scheduling_user_organizations TGT
USING (SELECT * FROM @users WHERE role_id = @admin_role_id) SRC
ON
	TGT.[user_id] = SRC.[user_id] AND TGT.account_org_id = @account_organization_id 
WHEN NOT MATCHED THEN INSERT ([user_id], account_org_id, author, create_date, modifier, modified_date)
	VALUES(SRC.[user_id], @account_organization_id, @author, @date, @author, @date);

/***********************************************************************************
Step 7: Making all of the users admins in the scheduling system
************************************************************************************/
MERGE dbo.scheduling_user_roles TGT
USING (SELECT * FROM @users WHERE role_id = @admin_role_id) SRC
ON
	TGT.[user_id] = SRC.[user_id] AND TGT.role_id = @admin_role_id
WHEN NOT MATCHED THEN INSERT ([user_id], role_id, author, create_date, modifier, modified_date)
	VALUES(SRC.[user_id], @admin_role_id, @author, @date, @author, @date);

/***********************************************************************************
Step 8: Setting up locations for each of the admin users
************************************************************************************/
MERGE dbo.scheduling_user_locations TGT
USING (SELECT * FROM @users WHERE role_id = @admin_role_id) SRC
ON
	TGT.[user_id] = SRC.[user_id] AND TGT.location_id = @dc_location_id
WHEN NOT MATCHED THEN INSERT ([user_id], location_id, author, create_date, modifier, modified_date)
	VALUES(SRC.[user_id], @dc_location_id, @author, @date, @author, @date);
	END
GO

IF '$(Environment)' = 'Dev'
	BEGIN
		PRINT 'VeoSolutions (Dev): Adding Brookfield Builder';
/***********************************************************************************
* Author: Shelby Mansker
* Date: 4/22/2016
* Descripton: This script will add/update test data for the non-staggered qa organization
              To the VeoSolutions database tables.
* Usage: This script was not designed to be called directly, though you can. Just
*        be sure that you're running it against the appropriate database. Instead,
*        This script is designed to be run from another script.
************************************************************************************/

/***********************************************************************************
Audit and Organization Variables
************************************************************************************/
DECLARE @author VARCHAR(50) = 'SEED',
		@date DATETIME = GETDATE(),
		@account_id UNIQUEIDENTIFIER = 'BAB32B7E-3ADA-497C-862E-E5083971CC59',
		@organization_id UNIQUEIDENTIFIER = 'DD2D25BE-DFA6-4ECE-B91D-5A8DE929AC29',
		@organization_name VARCHAR(50) = 'Brookfield Residential - Austin',
		@account_organization_id UNIQUEIDENTIFIER = 'C7DCACF5-EDFE-4EA9-9B2A-E8C93A0E0558',
		@dc_location_id UNIQUEIDENTIFIER = 'C04B5E52-8D06-4BAB-B878-1EECA0BC8D23',
		@admin_role_id UNIQUEIDENTIFIER = 'A0A9C6C5-A686-48EB-B125-6901F74AA435',
		@dc_admin_role_id UNIQUEIDENTIFIER = '4D9E9F34-2F62-4B17-8E24-4665DA40E326',
		@dc_manager_role_id UNIQUEIDENTIFIER = 'EBE7EAE2-488B-4158-BB25-24804B9AA1E6',
		@vendor_designer_role_id UNIQUEIDENTIFIER = 'F9EC07EB-A100-4CBB-8A79-E9C1D5D43092';

/***********************************************************************************
Users
************************************************************************************/
DECLARE @users TABLE
(
	[user_id] UNIQUEIDENTIFIER,
	first_name VARCHAR(25),
	last_name VARCHAR(25),
	email VARCHAR(100),
	role_id UNIQUEIDENTIFIER,
	phone VARCHAR(20),
	profile_id UNIQUEIDENTIFIER,
	interest_rate DECIMAL(18,6),
	loan_term DECIMAL(18,6),
	completed_steps INT,
	enable_homebuyer_access BIT
)

INSERT INTO @users VALUES
	-- VDS members
	('FBDBAC7D-C410-4C73-9C27-85EDD19F87B0', 'Rob', 'SysAdmin-Hobbs', 'roberth@eplanpartners.com', @admin_role_id, '222-222-2222', '1DDACF7F-9E97-42C0-9B1E-E699C61623B0', 4, 30, 0, 1),
	('A3F08518-B67E-4ADC-BE8C-F2CF264ACD4F', 'Roger', 'SysAdmin-Wang', 'rogerw@eplanpartners.com', @admin_role_id, '000-000-0000', '4D85BDAE-2149-471F-97AB-528B3E5B717C', 4, 30, 0, 1),

	-- Other members in the organizations
	('424059BC-E4C9-4F21-BDC2-52E5A24BF9AE', 'Adrian', 'SysAdmin-Garza', 'adriang@eplanpartners.com', @admin_role_id, '888-888-8888', 'FBF454CC-17A3-4B4F-B3E0-6156A4FF925A', 4, 30, 0, 1),
	('F5352E11-1A3A-4E69-A11F-1EE17F2BD4BB', 'Michelle', 'SysAdmin-Mansker', 'michellem@eplanpartners.com', @admin_role_id, '111-111-1111', '9C855086-38D7-4FCC-91CD-EDFB4E92BDAE', 4, 30, 0, 1),
	('0E4C3D85-5ACF-4D8C-AF40-A5E33715ED8B', 'Phil', 'SysAdmin-McAleer', 'philm@eplanpartners.com', @admin_role_id, '555-555-5555', 'BCFCB90F-A9B9-45B5-88F9-A302EE4A519D', 4, 30, 0, 1),
	('1028F0FD-3E7D-4E82-8F39-A25FF6228938', 'Richard', 'SysAdmin-McPherson', 'richardg@eplanpartners.com', @admin_role_id, '777-777-7777', 'BF15861C-AB8C-4E52-905B-2FF99845289C', 4, 30, 0, 1),
	('F15AC710-CDF1-4933-966C-4F28A7C2EDC8', 'Shelby', 'SysAdmin-Mansker', 'shelbym@eplanpartners.com', @admin_role_id, '444-444-4444', 'DCF05184-5AED-4BA6-B2D6-87D9D16FAE9A', 4, 30, 0, 1),

	-- Test users
	('CD7488F8-D980-4F59-9B4D-7BC3607A16E0', 'DC', 'Admin', 'dc-administrator@mailinator.com', @dc_admin_role_id, '999-999-9999', '9474A834-A613-4117-B232-26A8ABF2B9ED', 4, 30, 0, 1),
	('CEE7F0F8-B557-4E91-A329-612FFF39B159', 'DC', 'Manager', 'dc-manager@mailinator.com', @dc_manager_role_id, '111-111-1112', 'FA7A5D5E-DE49-4BE1-955F-50CEDDC2C704', 4, 30, 0, 1), 
	('73AFB14E-BD17-4A92-BF99-FA358F7CAC23', 'Vendor', 'Designer1', 'vendordesigner1@mailinator.com', @vendor_designer_role_id, '111-111-1113', 'F174CCA8-9280-4DF3-A802-FE0E3A09E409', 4, 30, 0, 1);

/***********************************************************************************
Design Center Addresses
************************************************************************************/
DECLARE @addresses TABLE
(
	address_id UNIQUEIDENTIFIER,
	address_type NVARCHAR(50),
	[address] NVARCHAR(50),
	address_name NVARCHAR(100),
	city NVARCHAR(50),
	[state] NVARCHAR(50),
	postal_code NVARCHAR(10),
	country_code NVARCHAR(5),
	phone1 NVARCHAR(20)
)

INSERT INTO @addresses VALUES
	('C04B5E52-8D06-4BAB-B878-1EECA0BC8D23', 'Design Center', '10110 W. Sam Houston Parkway N, Suite 250', 'The Main Design Center', 'Houston', 'TX', '77064', '1', '(281) 664-7255');

/***********************************************************************************
Step 1: Add Design Center addresses
************************************************************************************/
MERGE dbo.addresses TGT
USING @addresses SRC
ON
	TGT.address_id = SRC.address_id
WHEN NOT MATCHED THEN INSERT(address_id, address_type, [address], city, [state], postal_code, country_code, phone1, author, create_date, modifier, modified_date)
	VALUES(SRC.address_id, SRC.address_type, SRC.[address], SRC.city, SRC.[state], SRC.postal_code, SRC.country_code, SRC.phone1, @author, @date, @author, @date)
WHEN MATCHED THEN UPDATE
	SET
		TGT.address_type = SRC.address_type,
		TGT.[address] = SRC.[address],
		TGT.city = SRC.city,
		TGT.[state] = SRC.[state],
		TGT.postal_code = SRC.postal_code,
		TGT.country_code = SRC.country_code,
		TGT.phone1 = SRC.phone1,
		TGT.modifier = @author,
		TGT.modified_date = @date;

/***********************************************************************************
Step 2: Add Addresses to organization
************************************************************************************/
MERGE dbo.account_organization_addresses TGT
USING @addresses SRC
ON
	TGT.account_org_id = @account_organization_id AND TGT.address_id = SRC.address_id
WHEN NOT MATCHED THEN INSERT(account_org_id, address_id, address_name, author, create_date, modifier, modified_date)
	VALUES(@account_organization_id, SRC.address_id, SRC.address_name, @author, @date, @author, @date)
WHEN MATCHED THEN UPDATE
	SET
		TGT.address_name = SRC.address_name,
		TGT.modifier = @author,
		TGT.modified_date = @date;

/***********************************************************************************
Step 3: Create Profiles for each user in this organization
************************************************************************************/
MERGE dbo.account_organization_user_profile TGT
USING @users SRC
ON
	TGT.account_id = @account_id AND TGT.organization_id = @organization_id AND TGT.[user_id] = SRC.[user_id] AND TGT.profile_id = SRC.profile_id
WHEN NOT MATCHED THEN INSERT(account_id, organization_id, [user_id], profile_id, interest_rate, loan_term, completed_steps, enable_homebuyer_access, author, create_date, modifier, modified_date)
	VALUES(@account_id, @organization_id, SRC.[user_id], SRC.profile_id, SRC.interest_rate, SRC.loan_term, SRC.completed_steps, SRC.enable_homebuyer_access, @author, @date, @author, @date)
WHEN MATCHED THEN UPDATE
	SET
		TGT.interest_rate = SRC.interest_rate,
		TGT.loan_term = SRC.loan_term,
		TGT.completed_steps = SRC.completed_steps,
		TGT.enable_homebuyer_access = SRC.enable_homebuyer_access,
		TGT.modifier = @author,
		TGT.modified_date = @date;

/***********************************************************************************
Step 4: Add this organization to scheduling
************************************************************************************/
MERGE dbo.scheduling_organizations TGT
USING
	(VALUES 
		(@account_organization_id, @organization_name, '1900-01-01 07:00:00.000', '1900-01-01 19:00:00.000', NULL)
	) AS SRC (account_org_id, display_name, display_hours_start, display_hours_end, excluded_designers)
ON
	TGT.account_org_id = SRC.account_org_id
WHEN NOT MATCHED THEN INSERT (account_org_id, display_name, display_hours_start, display_hours_end, excluded_designers, author, create_date, modifier, modified_date)
	VALUES(SRC.account_org_id, SRC.display_name, SRC.display_hours_start, SRC.display_hours_end, SRC.excluded_designers, @author, @date, @author, @date)
WHEN MATCHED THEN UPDATE
	SET
		TGT.display_name = SRC.display_name,
		TGT.display_hours_start = SRC.display_hours_start, 
		TGT.display_hours_end = SRC.display_hours_end, 
		TGT.excluded_designers = SRC.excluded_designers,
		TGT.modifier = @author,
		TGT.modified_date = @date;

/***********************************************************************************
Step 5: Add the users to the Scheduling system
************************************************************************************/
MERGE dbo.scheduling_users TGT
USING (SELECT * FROM @users WHERE role_id = @admin_role_id) SRC
ON
	TGT.[user_id] = SRC.[user_id]
WHEN NOT MATCHED THEN INSERT ([user_id], scheduling_enabled, first_name, last_name, email, phone, author, create_date, modifier, modified_date)
	VALUES(SRC.[user_id], 1, SRC.first_name, SRC.last_name, SRC.email, SRC.phone, @author, @date, @author, @date)
WHEN MATCHED THEN UPDATE
	SET
		TGT.first_name = SRC.first_name,
		TGT.last_name = SRC.last_name,
		TGT.email = SRC.email,
		TGT.phone = SRC.phone,
		TGT.modifier = @author,
		TGT.modified_date = @date;

/***********************************************************************************
Step 6: Wire up the admin users to their organizations in scheduling
************************************************************************************/
MERGE dbo.scheduling_user_organizations TGT
USING (SELECT * FROM @users WHERE role_id = @admin_role_id) SRC
ON
	TGT.[user_id] = SRC.[user_id] AND TGT.account_org_id = @account_organization_id 
WHEN NOT MATCHED THEN INSERT ([user_id], account_org_id, author, create_date, modifier, modified_date)
	VALUES(SRC.[user_id], @account_organization_id, @author, @date, @author, @date);

/***********************************************************************************
Step 7: Making all of the users admins in the scheduling system
************************************************************************************/
MERGE dbo.scheduling_user_roles TGT
USING (SELECT * FROM @users WHERE role_id = @admin_role_id) SRC
ON
	TGT.[user_id] = SRC.[user_id] AND TGT.role_id = @admin_role_id
WHEN NOT MATCHED THEN INSERT ([user_id], role_id, author, create_date, modifier, modified_date)
	VALUES(SRC.[user_id], @admin_role_id, @author, @date, @author, @date);

/***********************************************************************************
Step 8: Setting up locations for each of the admin users
************************************************************************************/
MERGE dbo.scheduling_user_locations TGT
USING (SELECT * FROM @users WHERE role_id = @admin_role_id) SRC
ON
	TGT.[user_id] = SRC.[user_id] AND TGT.location_id = @dc_location_id
WHEN NOT MATCHED THEN INSERT ([user_id], location_id, author, create_date, modifier, modified_date)
	VALUES(SRC.[user_id], @dc_location_id, @author, @date, @author, @date);
	END
GO

GO
DECLARE @VarDecimalSupported AS BIT;

SELECT @VarDecimalSupported = 0;

IF ((ServerProperty(N'EngineEdition') = 3)
    AND (((@@microsoftversion / power(2, 24) = 9)
          AND (@@microsoftversion & 0xffff >= 3024))
         OR ((@@microsoftversion / power(2, 24) = 10)
             AND (@@microsoftversion & 0xffff >= 1600))))
    SELECT @VarDecimalSupported = 1;

IF (@VarDecimalSupported > 0)
    BEGIN
        EXECUTE sp_db_vardecimal_storage_format N'$(DatabaseName)', 'ON';
    END


GO
PRINT N'Update complete.';


GO
